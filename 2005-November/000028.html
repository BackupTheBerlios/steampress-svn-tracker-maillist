<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [steampress-svn-tracker] r72 - / trunk trunk/wp-admin trunk/wp-content trunk/wp-content/plugins trunk/wp-content/themes trunk/wp-content/themes/Steam trunk/wp-content/themes/Tagra trunk/wp-content/themes/default trunk/wp-content/themes/default/images trunk/wp-images trunk/wp-images/smilies trunk/wp-includes
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/steampress-svn-tracker/2005-November/index.html" >
   <LINK REL="made" HREF="mailto:steampress-svn-tracker%40lists.berlios.de?Subject=Re%3A%20%5Bsteampress-svn-tracker%5D%20r72%20-%20/%20trunk%20trunk/wp-admin%20trunk/wp-content%20trunk/wp-content/plugins%20trunk/wp-content/themes%20trunk/wp-content/themes/Steam%20trunk/wp-content/themes/Tagra%20trunk/wp-content/themes/default%20trunk/wp-content/themes/default/images%20trunk/wp-images%20trunk/wp-images/smilies%20trunk/wp-includes&In-Reply-To=%3C200511081433.jA8EXHSR030309%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000027.html">
   <LINK REL="Next"  HREF="000029.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[steampress-svn-tracker] r72 - / trunk trunk/wp-admin trunk/wp-content trunk/wp-content/plugins trunk/wp-content/themes trunk/wp-content/themes/Steam trunk/wp-content/themes/Tagra trunk/wp-content/themes/default trunk/wp-content/themes/default/images trunk/wp-images trunk/wp-images/smilies trunk/wp-includes</H1>
    <B>steampress-svn-tracker-admin at lists.berlios.de</B> 
    <A HREF="mailto:steampress-svn-tracker%40lists.berlios.de?Subject=Re%3A%20%5Bsteampress-svn-tracker%5D%20r72%20-%20/%20trunk%20trunk/wp-admin%20trunk/wp-content%20trunk/wp-content/plugins%20trunk/wp-content/themes%20trunk/wp-content/themes/Steam%20trunk/wp-content/themes/Tagra%20trunk/wp-content/themes/default%20trunk/wp-content/themes/default/images%20trunk/wp-images%20trunk/wp-images/smilies%20trunk/wp-includes&In-Reply-To=%3C200511081433.jA8EXHSR030309%40sheep.berlios.de%3E"
       TITLE="[steampress-svn-tracker] r72 - / trunk trunk/wp-admin trunk/wp-content trunk/wp-content/plugins trunk/wp-content/themes trunk/wp-content/themes/Steam trunk/wp-content/themes/Tagra trunk/wp-content/themes/default trunk/wp-content/themes/default/images trunk/wp-images trunk/wp-images/smilies trunk/wp-includes">steampress-svn-tracker-admin at lists.berlios.de
       </A><BR>
    <I>Tue Nov  8 15:33:17 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000027.html">[steampress-svn-tracker] r71 - /
</A></li>
        <LI>Next message: <A HREF="000029.html">[steampress-svn-tracker] r73 - trunk/wp-admin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28">[ date ]</a>
              <a href="thread.html#28">[ thread ]</a>
              <a href="subject.html#28">[ subject ]</a>
              <a href="author.html#28">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: steamedpenguin
Date: 2005-11-08 15:33:01 +0100 (Tue, 08 Nov 2005)
New Revision: 72

Added:
   trunk/
   trunk/index.php
   trunk/license.txt
   trunk/readme.html
   trunk/wp-admin/
   trunk/wp-admin/admin-footer.php
   trunk/wp-admin/admin-functions.php
   trunk/wp-admin/admin-header.php
   trunk/wp-admin/admin.php
   trunk/wp-admin/categories.php
   trunk/wp-admin/edit-comments.php
   trunk/wp-admin/edit-form-advanced.php
   trunk/wp-admin/edit-form-comment.php
   trunk/wp-admin/edit-form.php
   trunk/wp-admin/edit-page-form.php
   trunk/wp-admin/edit-pages.php
   trunk/wp-admin/edit.php
   trunk/wp-admin/import-b2.php
   trunk/wp-admin/import-blogger.php
   trunk/wp-admin/import-greymatter.php
   trunk/wp-admin/import-livejournal.php
   trunk/wp-admin/import-mt.php
   trunk/wp-admin/import-rss.php
   trunk/wp-admin/import-textpattern.php
   trunk/wp-admin/index.php
   trunk/wp-admin/install-helper.php
   trunk/wp-admin/install.php
   trunk/wp-admin/link-add.php
   trunk/wp-admin/link-categories.php
   trunk/wp-admin/link-import.php
   trunk/wp-admin/link-manager.php
   trunk/wp-admin/link-parse-opml.php
   trunk/wp-admin/menu-header.php
   trunk/wp-admin/menu.php
   trunk/wp-admin/moderation.php
   trunk/wp-admin/options-discussion.php
   trunk/wp-admin/options-general.php
   trunk/wp-admin/options-head.php
   trunk/wp-admin/options-permalink.php
   trunk/wp-admin/options-reading.php
   trunk/wp-admin/options-writing.php
   trunk/wp-admin/options.php
   trunk/wp-admin/page-new.php
   trunk/wp-admin/plugins.php
   trunk/wp-admin/post.php
   trunk/wp-admin/profile.php
   trunk/wp-admin/setup-config.php
   trunk/wp-admin/sidebar.php
   trunk/wp-admin/themes.php
   trunk/wp-admin/update-links.php
   trunk/wp-admin/upgrade-functions.php
   trunk/wp-admin/upgrade-schema.php
   trunk/wp-admin/upgrade.php
   trunk/wp-admin/upload.php
   trunk/wp-admin/user-edit.php
   trunk/wp-admin/users.php
   trunk/wp-admin/wp-admin.css
   trunk/wp-atom.php
   trunk/wp-blog-header.php
   trunk/wp-comments-post.php
   trunk/wp-commentsrss2.php
   trunk/wp-config.sample.php
   trunk/wp-content/
   trunk/wp-content/plugins/
   trunk/wp-content/plugins/hello.php
   trunk/wp-content/plugins/markdown.php
   trunk/wp-content/plugins/textile1.php
   trunk/wp-content/themes/
   trunk/wp-content/themes/Steam/
   trunk/wp-content/themes/Steam/404.php
   trunk/wp-content/themes/Steam/archive.php
   trunk/wp-content/themes/Steam/archives.php
   trunk/wp-content/themes/Steam/comments-popup.php
   trunk/wp-content/themes/Steam/comments.php
   trunk/wp-content/themes/Steam/footer.php
   trunk/wp-content/themes/Steam/header.php
   trunk/wp-content/themes/Steam/index.php
   trunk/wp-content/themes/Steam/links.php
   trunk/wp-content/themes/Steam/page.php
   trunk/wp-content/themes/Steam/search.php
   trunk/wp-content/themes/Steam/searchform.php
   trunk/wp-content/themes/Steam/sidebar.php
   trunk/wp-content/themes/Steam/single.php
   trunk/wp-content/themes/Steam/style.css
   trunk/wp-content/themes/Tagra/
   trunk/wp-content/themes/Tagra/404.php
   trunk/wp-content/themes/Tagra/archive.php
   trunk/wp-content/themes/Tagra/archives.php
   trunk/wp-content/themes/Tagra/comments-popup.php
   trunk/wp-content/themes/Tagra/comments.php
   trunk/wp-content/themes/Tagra/footer.php
   trunk/wp-content/themes/Tagra/header.php
   trunk/wp-content/themes/Tagra/index.php
   trunk/wp-content/themes/Tagra/links.php
   trunk/wp-content/themes/Tagra/page.php
   trunk/wp-content/themes/Tagra/search.php
   trunk/wp-content/themes/Tagra/searchform.php
   trunk/wp-content/themes/Tagra/sidebar.php
   trunk/wp-content/themes/Tagra/single.php
   trunk/wp-content/themes/Tagra/style.css
   trunk/wp-content/themes/default/
   trunk/wp-content/themes/default/404.php
   trunk/wp-content/themes/default/archive.php
   trunk/wp-content/themes/default/archives.php
   trunk/wp-content/themes/default/comments-popup.php
   trunk/wp-content/themes/default/comments.php
   trunk/wp-content/themes/default/footer.php
   trunk/wp-content/themes/default/header.php
   trunk/wp-content/themes/default/images/
   trunk/wp-content/themes/default/images/kubrickbg.jpg
   trunk/wp-content/themes/default/images/kubrickbgcolor.jpg
   trunk/wp-content/themes/default/images/kubrickbgwide.jpg
   trunk/wp-content/themes/default/images/kubrickfooter.jpg
   trunk/wp-content/themes/default/images/kubrickheader.jpg
   trunk/wp-content/themes/default/index.php
   trunk/wp-content/themes/default/links.php
   trunk/wp-content/themes/default/page.php
   trunk/wp-content/themes/default/search.php
   trunk/wp-content/themes/default/searchform.php
   trunk/wp-content/themes/default/sidebar.php
   trunk/wp-content/themes/default/single.php
   trunk/wp-content/themes/default/style.css
   trunk/wp-feed.php
   trunk/wp-images/
   trunk/wp-images/smilies/
   trunk/wp-images/smilies/icon_arrow.gif
   trunk/wp-images/smilies/icon_biggrin.gif
   trunk/wp-images/smilies/icon_confused.gif
   trunk/wp-images/smilies/icon_cool.gif
   trunk/wp-images/smilies/icon_cry.gif
   trunk/wp-images/smilies/icon_eek.gif
   trunk/wp-images/smilies/icon_evil.gif
   trunk/wp-images/smilies/icon_exclaim.gif
   trunk/wp-images/smilies/icon_idea.gif
   trunk/wp-images/smilies/icon_lol.gif
   trunk/wp-images/smilies/icon_mad.gif
   trunk/wp-images/smilies/icon_mrgreen.gif
   trunk/wp-images/smilies/icon_neutral.gif
   trunk/wp-images/smilies/icon_question.gif
   trunk/wp-images/smilies/icon_razz.gif
   trunk/wp-images/smilies/icon_redface.gif
   trunk/wp-images/smilies/icon_rolleyes.gif
   trunk/wp-images/smilies/icon_sad.gif
   trunk/wp-images/smilies/icon_smile.gif
   trunk/wp-images/smilies/icon_surprised.gif
   trunk/wp-images/smilies/icon_twisted.gif
   trunk/wp-images/smilies/icon_wink.gif
   trunk/wp-images/wp-small.png
   trunk/wp-images/wpminilogo.png
   trunk/wp-includes/
   trunk/wp-includes/class-IXR.php
   trunk/wp-includes/class-pop3.php
   trunk/wp-includes/class-snoopy.php
   trunk/wp-includes/classes.php
   trunk/wp-includes/comment-functions.php
   trunk/wp-includes/default-filters.php
   trunk/wp-includes/feed-functions.php
   trunk/wp-includes/functions-compat.php
   trunk/wp-includes/functions-formatting.php
   trunk/wp-includes/functions-post.php
   trunk/wp-includes/functions.php
   trunk/wp-includes/gettext.php
   trunk/wp-includes/kses.php
   trunk/wp-includes/links.php
   trunk/wp-includes/locale.php
   trunk/wp-includes/pluggable-functions.php
   trunk/wp-includes/rss-functions.php
   trunk/wp-includes/streams.php
   trunk/wp-includes/template-functions-author.php
   trunk/wp-includes/template-functions-category.php
   trunk/wp-includes/template-functions-general.php
   trunk/wp-includes/template-functions-links.php
   trunk/wp-includes/template-functions-post.php
   trunk/wp-includes/vars.php
   trunk/wp-includes/version.php
   trunk/wp-includes/wp-db.php
   trunk/wp-includes/wp-l10n.php
   trunk/wp-links-opml.php
   trunk/wp-login.php
   trunk/wp-pass.php
   trunk/wp-rdf.php
   trunk/wp-register.php
   trunk/wp-rss.php
   trunk/wp-rss2.php
   trunk/wp-settings.php
   trunk/wp-trackback.php
   trunk/wp.php
   trunk/xmlrpc.php
Log:
Admin section changes

Stylesheet: Basic, gray, and not very polished. Will add polish as needed;

Structure: Simplified some adminmenu choices as they make no sense within the SteamPress philosophy;

Markup and code: Cleaned up some PHP ( &lt;? if ():?&gt; &lt;?php endif; ?&gt; ) is fucking stupid; cleaned up markup where needed; removed several options relating to how 
many rows you have in the editing section, and other trivialities; Made a big change to the table markup in the link editing section. Separated link config 
from link presentation; Note to self, when outputting HTML via PHP make sure that the markup comes out to match the indentation of markup already present; 
throwing in an extra tab or newline never killed anyone, especially considering how bloated some of the code already is.



Added: trunk/index.php
===================================================================
--- trunk/index.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/index.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,5 @@
+&lt;?php 
+/* Short and sweet */
+define('WP_USE_THEMES', true);
+require('./wp-blog-header.php');
+?&gt;
\ No newline at end of file

Added: trunk/license.txt
===================================================================
--- trunk/license.txt	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/license.txt	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,280 @@
+		    GNU GENERAL PUBLIC LICENSE
+		       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.
+                          675 Mass Ave, Cambridge, MA 02139, USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+			    Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Library General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+		    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The &quot;Program&quot;, below,
+refers to any such program or work, and a &quot;work based on the Program&quot;
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term &quot;modification&quot;.)  Each licensee is addressed as &quot;you&quot;.
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and &quot;any
+later version&quot;, you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+			    NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM &quot;AS IS&quot; WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+		     END OF TERMS AND CONDITIONS
+

Added: trunk/readme.html
===================================================================
--- trunk/readme.html	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/readme.html	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,126 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;title&gt;WordPress &rsaquo; ReadMe&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+	&lt;!--
+	html {
+		background: #eee;
+	}
+	body {
+		background: #fff;
+		color: #000;
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 25%;
+		margin-right: 25%;
+		padding: .2em 2em;
+	}
+	
+	h1 {
+		color: #006;
+		font-size: 18px;
+		font-weight: lighter;
+	}
+	
+	h2 {
+		font-size: 16px;
+	}
+	
+	p, li, dt {
+		line-height: 140%;
+		padding-bottom: 2px;
+	}
+
+	ul, ol {
+		padding: 5px 5px 5px 20px;
+	}
+	--&gt;
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;h1 style=&quot;text-align: center&quot;&gt;&lt;img alt=&quot;WordPress&quot; src=&quot;<A HREF="http://wordpress.org/images/wordpress.gif">http://wordpress.org/images/wordpress.gif</A>&quot; /&gt; &lt;br /&gt;
+	Version 1.5&lt;/h1&gt;
+&lt;p style=&quot;text-align: center&quot;&gt; Semantic Personal Publishing Platform &lt;/p&gt;
+&lt;h1&gt;First Things First&lt;/h1&gt;
+&lt;p&gt;Welcome. WordPress is a very special project to me. Every developer and contributor adds something unique to the mix, and together we create something beautiful that I'm proud to be a part of. Thousands of hours have gone into WordPress, and we're dedicated to making it better every day. Thank you for making it part of your world.&lt;/p&gt;
+&lt;p style=&quot;text-align: right;&quot;&gt;&#8212; Matt Mullenweg &lt;/p&gt;
+
+&lt;h1 id=&quot;installation&quot;&gt;Installation: Famous 5-minute install&lt;/h1&gt;
+&lt;ol&gt;
+	&lt;li&gt;Unzip the package in an empty directory&lt;/li&gt;
+	&lt;li&gt;Open up &lt;code&gt;wp-config-sample.php&lt;/code&gt; with a text editor like WordPad or similar and fill in your database connection details&lt;/li&gt;
+	&lt;li&gt;Save the file as &lt;code&gt;wp-config.php&lt;/code&gt; &lt;/li&gt;
+	&lt;li&gt;Upload everything.&lt;/li&gt;
+	&lt;li&gt;Launch &lt;span class=&quot;file&quot;&gt;&lt;a href=&quot;wp-admin/install.php&quot;&gt;/wp-admin/install.php&lt;/a&gt;&lt;/span&gt; in your browser. This should setup the tables needed for your blog. If there is an error, double check your &lt;span class=&quot;file&quot;&gt;wp-config.php&lt;/span&gt; file, and try again. If it fails again, please go to the &lt;a href=&quot;<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>&quot;&gt;support forums&lt;/a&gt; with as much data as you can gather. &lt;/li&gt;
+	&lt;li&gt;&lt;strong&gt;Note the password given to you.&lt;/strong&gt;&lt;/li&gt;
+	&lt;li&gt; The install script should then send you to the &lt;a href=&quot;wp-login.php&quot;&gt;login page&lt;/a&gt;. Sign in with the username &lt;code&gt;admin&lt;/code&gt; and the password generated during the installation. You can then click on 'Profile' to change the password.&lt;/li&gt;
+&lt;/ol&gt;
+
+&lt;h1&gt;Upgrading&lt;/h1&gt;
+&lt;p&gt;Before you upgrade anything, make sure you have backup copies of any files you may have modified such as &lt;code&gt;index.php&lt;/code&gt;.&lt;/p&gt;
+&lt;h2&gt;Upgrading from any previous WordPress to 1.5:&lt;/h2&gt;
+&lt;ol&gt;
+	&lt;li&gt;Delete your old WP files, saving ones you've modified &lt;/li&gt;
+	&lt;li&gt;Upload the new files&lt;/li&gt;
+	&lt;li&gt;Point your browser to &lt;span class=&quot;file&quot;&gt;&lt;a href=&quot;wp-admin/upgrade.php&quot;&gt;/wp-admin/upgrade.php&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
+	&lt;li&gt;You wanted more, perhaps? That's it!&lt;/li&gt;
+&lt;/ol&gt;
+&lt;h2&gt;Template Changes&lt;/h2&gt;
+&lt;p&gt;If you have customized your templates you will probably have to make some changes to them. If you're converting your 1.2 or earlier templates, &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Upgrade_1.2_to_1.5">http://codex.wordpress.org/Upgrade_1.2_to_1.5</A>&quot;&gt;we've created a special guide for you&lt;/a&gt;. &lt;/p&gt;
+&lt;h1&gt;Online Resources&lt;/h1&gt;
+&lt;p&gt;If you have any questions that aren't addressed in this document, please take advantage of WordPress' numerous online resources:&lt;/p&gt;
+&lt;dl&gt;
+	&lt;dt&gt;&lt;a href=&quot;<A HREF="http://codex.wordpress.org/">http://codex.wordpress.org/</A>&quot;&gt;The WordPress Codex &lt;/a&gt;&lt;/dt&gt;
+	&lt;dd&gt;The Codex is the encyclopedia of all things WordPress. It is the most comprehensive source of information for WordPress available. &lt;/dd&gt;
+	&lt;dt&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/development/">http://wordpress.org/development/</A>&quot;&gt;The Development Blog&lt;/a&gt;&lt;/dt&gt;
+	&lt;dd&gt;This is where you'll find the latest updates and news related to WordPress. Bookmark and check often. &lt;/dd&gt;
+	&lt;dt&gt;&lt;a href=&quot;<A HREF="http://planet.wordpress.org/">http://planet.wordpress.org/</A>&quot;&gt;WordPress Planet &lt;/a&gt;&lt;/dt&gt;
+	&lt;dd&gt;The WordPress Planet is a news aggregator that brings together posts from WordPress blogs around the web. &lt;/dd&gt;
+	&lt;dt&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>&quot;&gt;WordPress Support Forums&lt;/a&gt;&lt;/dt&gt;
+	&lt;dd&gt;If you've looked everywhere and still can't find an answer, the support forums are very active and have a large community ready to help. To help them help you be sure to use a descriptive thread title and describe your question in as much detail as possible. &lt;/dd&gt;
+	&lt;dt&gt;&lt;a href=&quot;<A HREF="http://codex.wordpress.org/IRC">http://codex.wordpress.org/IRC</A>&quot;&gt;WordPress IRC Channel&lt;/a&gt;&lt;/dt&gt;
+	&lt;dd&gt;Finally, there is an online chat channel that is used for discussion amoung people who use WordPress and occasionally support topics. The above wiki page should point you in the right direction. (irc.freenode.net #wordpresss) &lt;/dd&gt;
+&lt;/dl&gt;
+
+&lt;h1 id=&quot;requirements&quot;&gt;System Recommendations&lt;/h1&gt;
+&lt;ul&gt;
+	&lt;li&gt;PHP version &lt;strong&gt;4.1&lt;/strong&gt; or higher&lt;/li&gt;
+	&lt;li&gt;MySQL version &lt;strong&gt;3.23.23&lt;/strong&gt; or higher&lt;/li&gt;
+	&lt;li&gt;... and a link to &lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;<A HREF="http://wordpress.org&lt;/a">http://wordpress.org&lt;/a</A>&gt; on your site.&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;WordPress is the official continuation of &lt;a href=&quot;<A HREF="http://cafelog.com/">http://cafelog.com/</A>&quot;&gt;b2/caf&eacute;log&lt;/a&gt;, which came from Michel V. The work has been continued by the &lt;a href=&quot;<A HREF="http://wordpress.org/about/">http://wordpress.org/about/</A>&quot;&gt;WordPress developers&lt;/a&gt;. If you would like to support WordPress, please consider &lt;a href=&quot;<A HREF="http://wordpress.org/donate/">http://wordpress.org/donate/</A>&quot;&gt;donating&lt;/a&gt;. &lt;/p&gt;
+
+&lt;h1&gt;Upgrading from another system&lt;/h1&gt;
+&lt;p&gt;WordPress can &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Importing_from_other_blogging_software">http://codex.wordpress.org/Importing_from_other_blogging_software</A>&quot;&gt;import from a number of systems&lt;/a&gt;. First you need to get WordPress installed and working as described above.&lt;/p&gt;
+
+&lt;h1 id=&quot;templates&quot;&gt;XML-RPC Interface&lt;/h1&gt;
+&lt;p&gt;You can now post to your WordPress blog with tools like &lt;a href=&quot;<A HREF="http://ecto.kung-foo.tv/">http://ecto.kung-foo.tv/</A>&quot;&gt;Ecto&lt;/a&gt;, &lt;a href=&quot;<A HREF="http://blogbuddy.sourceforge.net">http://blogbuddy.sourceforge.net</A>&quot;&gt;BlogBuddy&lt;/a&gt;, &lt;a href=&quot;<A HREF="http://bloggar.com/">http://bloggar.com/</A>&quot;&gt;Bloggar&lt;/a&gt;, &lt;a href=&quot;<A HREF="http://www.ubique.ch/wapblogger/">http://www.ubique.ch/wapblogger/</A>&quot;&gt;WapBlogger&lt;/a&gt; (post from your Wap cellphone!), &lt;a href=&quot;<A HREF="http://radio.userland.com">http://radio.userland.com</A>&quot;&gt;Radio Userland&lt;/a&gt; (which means you can use Radio's email-to-blog feature), &lt;a href=&quot;<A HREF="http://www.zempt.com/">http://www.zempt.com/</A>&quot;&gt;Zempt&lt;/a&gt;, &lt;a href=&quot;<A HREF="http://www.newzcrawler.com/">http://www.newzcrawler.com/</A>&quot;&gt;NewzCrawler&lt;/a&gt;, and other tools that support the Blogging APIs! :) You can read more about &lt;a href=&quot;<A HREF="http://codex.wordpress.org/XML-RPC_Support">http://codex.wordpress.org/XML-RPC_Support</A>&quot;&gt;XML-RPC support on the Codex&lt;/a&gt;.&lt;/p&gt;
+
+&lt;h1&gt;Post via Email&lt;/h1&gt;
+&lt;p&gt;You can post from an email client! To set this up go to your &quot;Writing&quot; options screen and fill in the connection details for your secret POP3 account. Then you need to set up &lt;code&gt;wp-mail.php&lt;/code&gt; to execute periodically to check the mailbox for new posts. You can do it with Cron-jobs, or if your host doesn't support it you can look into the various website-monitoring services, and make them check your &lt;code&gt;wp-mail.php&lt;/code&gt; URL. &lt;/p&gt;
+&lt;p&gt; Posting is easy: Any email sent to the address you specify will be posted, with the subject as the title. It is best to keep the address dicrete. The script will &lt;i&gt;delete&lt;/i&gt; emails that are successfully posted. &lt;/p&gt;
+&lt;h1 id=&quot;notes&quot;&gt;User Levels &lt;/h1&gt;
+&lt;p&gt;You may allow or disallow user registration in your &lt;a href=&quot;wp-admin/options-general.php&quot;&gt;General options&lt;/a&gt;. If &quot;new users can blog&quot; is disabled you must first raise the level of a newly registered user to allow them to post. Click the plus sign next to their name on the &lt;a href=&quot;wp-admin/users.php&quot;&gt;Users&lt;/a&gt; page. &lt;/p&gt;
+&lt;h2&gt;User Levels&lt;/h2&gt;
+&lt;ul&gt;
+	&lt;li&gt;0 - New User &lt;/li&gt;
+	&lt;li&gt;1 - User can post, edit, and delete their own posts.&lt;/li&gt;
+	&lt;li&gt;5+ - Admin; can post, edit, delete other people's posts, and change the options.&lt;/li&gt;
+	&lt;li&gt;Any user whose level is higher than 1, can edit and delete the posts and change the level of lower users. Example: a level 2 user is not an admin, but can edit the posts of level 1 users, and up the level of a new user from 0 to 1.&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;Usually you want to have a team of level 1 users except for you.&lt;/p&gt;
+&lt;h1&gt; Final notes&lt;/h1&gt;
+&lt;ul&gt;
+	&lt;li&gt;If you have any suggestions, ideas, comments, or if you (gasp!) found a bug, join us in the &lt;a href=&quot;<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>&quot;&gt;Support Forums&lt;/a&gt;&lt;/li&gt;
+	&lt;li&gt;WordPress now has a robust plugin API that makes extending the code easy. If you are a developer interested in utilizing this see the &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Plugin_API">http://codex.wordpress.org/Plugin_API</A>&quot;&gt;plugin documentation in the Codex&lt;/a&gt;. In most all cases you shouldn't modify any of the core code.&lt;/li&gt;
+&lt;/ul&gt;
+
+&lt;h1&gt;Share the Love&lt;/h1&gt;
+&lt;p&gt;WordPress has no multi-million dollar marketing campaign or celebrity sponsors, but we do have something even better&#8212;you. If you enjoy WordPress please consider telling a friend, setting it up for someone less knowledgable than yourself, or writing the author of a media article that overlooks us.&lt;/p&gt;
+
+&lt;h1&gt;Copyright&lt;/h1&gt;
+&lt;p&gt;WordPress is released under the &lt;abbr title=&quot;GNU Public License&quot;&gt;GPL&lt;/abbr&gt; (see &lt;a href=&quot;license.txt&quot;&gt;license.txt&lt;/a&gt;).&lt;/p&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-admin/admin-footer.php
===================================================================
--- trunk/wp-admin/admin-footer.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/admin-footer.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,16 @@
+&lt;div id=&quot;footer&quot;&gt;
+	&lt;p&gt;
+		&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;
+		&lt;?php bloginfo('version'); ?&gt; &#8212;
+		&lt;a href=&quot;<A HREF="http://codex.wordpress.org/">http://codex.wordpress.org/</A>&quot;&gt;
+			&lt;?php _e('Documentation'); ?&gt;
+		&lt;/a&gt; &#8212;
+		&lt;a href=&quot;<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>&quot;&gt;&lt;?php _e('Support Forums'); ?&gt;&lt;/a&gt;
+&lt;/p&gt;
+
+&lt;/div&gt;
+
+&lt;?php do_action('admin_footer', ''); ?&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-admin/admin-functions.php
===================================================================
--- trunk/wp-admin/admin-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/admin-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,1062 @@
+&lt;?php
+
+function url_shorten ($url) {
+	$short_url = str_replace('<A HREF="http://">http://</A>', '', stripslashes($url));
+	$short_url = str_replace('www.', '', $short_url);
+	if ('/' == substr($short_url, -1))
+		$short_url = substr($short_url, 0, -1);
+	if (strlen($short_url) &gt; 35)
+		$short_url =  substr($short_url, 0, 32).'...';
+	return $short_url;
+}
+
+function selected($selected, $current) {
+	if ($selected == $current) echo ' selected=&quot;selected&quot;';
+}
+
+function checked($checked, $current) {
+	if ($checked == $current) echo ' checked=&quot;checked&quot;';
+}
+
+function return_categories_list( $parent = 0, $sortbyname = FALSE )
+{
+        /*
+         * This function returns an list of all categories
+         * that have $parent as their parent
+         * if no parent is specified we will assume top level caegories
+         * are required.
+         */
+        global $wpdb;
+
+        // select sort order
+        $sort = &quot;cat_id&quot;;
+        if( TRUE == $sortbyname )
+        {
+                $sort = &quot;cat_name&quot;;
+        }
+
+        // First query the database
+        $cats_tmp = $wpdb-&gt;get_results(&quot;SELECT cat_ID FROM $wpdb-&gt;categories WHERE category_parent = $parent ORDER BY $sort&quot;);
+
+        // Now strip this down to a simple array of IDs
+        $cats = array();
+        if( count($cats_tmp) &gt; 0 )
+        {
+                foreach( $cats_tmp as $cat )
+                {
+                        $cats[] = $cat-&gt;cat_ID;
+                }
+        }
+
+        // Return the list of categories
+        return $cats;
+}
+
+function get_nested_categories($default = 0, $parent = 0) {
+ global $post_ID, $mode, $wpdb;
+
+ if ($post_ID) {
+   $checked_categories = $wpdb-&gt;get_col(&quot;
+     SELECT category_id
+     FROM $wpdb-&gt;categories, $wpdb-&gt;post2cat
+     WHERE $wpdb-&gt;post2cat.category_id = cat_ID AND $wpdb-&gt;post2cat.post_id = '$post_ID'
+     &quot;);
+
+   if(count($checked_categories) == 0)
+   {
+     // No selected categories, strange
+     $checked_categories[] = $default;
+   }
+
+ } else {
+   $checked_categories[] = $default;
+ }
+
+ $cats = return_categories_list($parent, TRUE);
+ $result = array();
+
+ foreach($cats as $cat)
+ {
+   $result[$cat]['children'] = get_nested_categories($default, $cat);
+   $result[$cat]['cat_ID'] = $cat;
+   $result[$cat]['checked'] = in_array($cat, $checked_categories);
+   $result[$cat]['cat_name'] = get_the_category_by_ID($cat);
+ }
+
+ return $result;
+}
+
+function write_nested_categories($categories) {
+ foreach($categories as $category) {
+   echo '&lt;label for=&quot;category-', $category['cat_ID'], '&quot; class=&quot;selectit&quot;&gt;&lt;input value=&quot;', $category['cat_ID'],
+     '&quot; type=&quot;checkbox&quot; name=&quot;post_category[]&quot; id=&quot;category-', $category['cat_ID'], '&quot;',
+     ($category['checked'] ? ' checked=&quot;checked&quot;' : &quot;&quot;), '/&gt; ', wp_specialchars($category['cat_name']), &quot;&lt;/label&gt;\n&quot;;
+
+   if(isset($category['children'])) {
+     echo &quot;\n&lt;span class='cat-nest'&gt;\n&quot;;
+     write_nested_categories($category['children']);
+     echo &quot;&lt;/span&gt;\n&quot;;
+   }
+ }
+}
+
+function dropdown_categories($default = 0) {
+ write_nested_categories(get_nested_categories($default));
+}
+
+// Dandy new recursive multiple category stuff.
+function cat_rows($parent = 0, $level = 0, $categories = 0) {
+	global $wpdb, $class, $user_level;
+	if (!$categories)
+		$categories = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;categories ORDER BY cat_name&quot;);
+
+	if ($categories) {
+		foreach ($categories as $category) {
+			if ($category-&gt;category_parent == $parent) {
+				$category-&gt;cat_name = wp_specialchars($category-&gt;cat_name);
+				$count = $wpdb-&gt;get_var(&quot;SELECT COUNT(post_id) FROM $wpdb-&gt;post2cat WHERE category_id = $category-&gt;cat_ID&quot;);
+				$pad = str_repeat('&#8212; ', $level);
+				if ( $user_level &gt; 3 )
+					$edit = &quot;&lt;a href='categories.php?action=edit&amp;cat_ID=$category-&gt;cat_ID' class='edit'&gt;&quot; . __('Edit') . &quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href='categories.php?action=delete&amp;cat_ID=$category-&gt;cat_ID' onclick=\&quot;return confirm('&quot;.  sprintf(__(&quot;You are about to delete the category \'%s\'.  All of its posts will go to the default category.\\n  \'OK\' to delete, \'Cancel\' to stop.&quot;), addslashes($category-&gt;cat_name)) . &quot;')\&quot; class='delete'&gt;&quot; .  __('Delete') . &quot;&lt;/a&gt;&quot;;
+				else
+					$edit = '';
+
+				$class = ('alternate' == $class) ? '' : 'alternate';
+				echo &quot;&lt;tr class='$class'&gt;&lt;th scope='row'&gt;$category-&gt;cat_ID&lt;/th&gt;&lt;td&gt;$pad $category-&gt;cat_name&lt;/td&gt;
+				&lt;td&gt;$category-&gt;category_description&lt;/td&gt;
+				&lt;td&gt;$count&lt;/td&gt;
+				&lt;td&gt;$edit&lt;/td&gt;
+				&lt;/tr&gt;&quot;;
+				cat_rows($category-&gt;cat_ID, $level + 1, $categories);
+			}
+		}
+	} else {
+		return false;
+	}
+}
+
+function page_rows( $parent = 0, $level = 0, $pages = 0 ) {
+	global $wpdb, $class, $user_level, $post;
+	if (!$pages)
+		$pages = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;posts WHERE post_status = 'static' ORDER BY menu_order&quot;);
+
+	if ($pages) {
+		foreach ($pages as $post) { start_wp();
+			if ($post-&gt;post_parent == $parent) {
+				$post-&gt;post_title = wp_specialchars($post-&gt;post_title);
+				$pad = str_repeat('&#8212; ', $level);
+				$id = $post-&gt;ID;
+				$class = ('alternate' == $class) ? '' : 'alternate';
+?&gt;
+  &lt;tr class='&lt;?php echo $class; ?&gt;'&gt;
+    &lt;th scope=&quot;row&quot;&gt;&lt;?php echo $post-&gt;ID; ?&gt;&lt;/th&gt;
+    &lt;td&gt;
+      &lt;?php echo $pad; ?&gt;&lt;?php the_title() ?&gt;
+    &lt;/td&gt;
+    &lt;td&gt;&lt;?php the_author() ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php echo mysql2date('Y-m-d g:i a', $post-&gt;post_modified); ?&gt;&lt;/td&gt;
+	&lt;td&gt;&lt;a href=&quot;&lt;?php the_permalink(); ?&gt;&quot; rel=&quot;permalink&quot; class=&quot;edit&quot;&gt;&lt;?php _e('View'); ?&gt;&lt;/a&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php if (($user_level &gt; $authordata-&gt;user_level) or ($user_login == $authordata-&gt;user_login)) { echo &quot;&lt;a href='post.php?action=edit&amp;post=$id' class='edit'&gt;&quot; . __('Edit') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php if (($user_level &gt; $authordata-&gt;user_level) or ($user_login == $authordata-&gt;user_login)) { echo &quot;&lt;a href='post.php?action=delete&amp;post=$id' class='delete' onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this post \'%s\'\\n  \'OK\' to delete, \'Cancel\' to stop.&quot;), the_title('','',0)) . &quot;')\&quot;&gt;&quot; . __('Delete') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+  &lt;/tr&gt;
+
+&lt;?php
+				page_rows($id, $level + 1, $pages);
+			}
+		}
+	} else {
+		return false;
+	}
+}
+
+function wp_dropdown_cats($currentcat = 0, $currentparent = 0, $parent = 0, $level = 0, $categories = 0) {
+	global $wpdb, $bgcolor;
+	if (!$categories) {
+		$categories = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;categories ORDER BY cat_name&quot;);
+	}
+	if ($categories) {
+		foreach ($categories as $category) { if ($currentcat != $category-&gt;cat_ID &amp;&amp; $parent == $category-&gt;category_parent) {
+			$count = $wpdb-&gt;get_var(&quot;SELECT COUNT(post_id) FROM $wpdb-&gt;post2cat WHERE category_id = $category-&gt;cat_ID&quot;);
+			$pad = str_repeat('&#8211; ', $level);
+			$category-&gt;cat_name = wp_specialchars($category-&gt;cat_name);
+			echo &quot;\n\t&lt;option value='$category-&gt;cat_ID'&quot;;
+			if ($currentparent == $category-&gt;cat_ID)
+				echo &quot; selected='selected'&quot;;
+			echo &quot;&gt;$pad$category-&gt;cat_name&lt;/option&gt;&quot;;
+			wp_dropdown_cats($currentcat, $currentparent, $category-&gt;cat_ID, $level + 1, $categories);
+		} }
+	} else {
+		return false;
+	}
+}
+
+function wp_create_thumbnail($file, $max_side, $effect = '') {
+
+    // 1 = GIF, 2 = JPEG, 3 = PNG
+
+    if(file_exists($file)) {
+        $type = getimagesize($file);
+
+        // if the associated function doesn't exist - then it's not
+        // handle. duh. i hope.
+
+        if(!function_exists('imagegif') &amp;&amp; $type[2] == 1) {
+            $error = __('Filetype not supported. Thumbnail not created.');
+        }elseif(!function_exists('imagejpeg') &amp;&amp; $type[2] == 2) {
+            $error = __('Filetype not supported. Thumbnail not created.');
+        }elseif(!function_exists('imagepng') &amp;&amp; $type[2] == 3) {
+            $error = __('Filetype not supported. Thumbnail not created.');
+        } else {
+
+            // create the initial copy from the original file
+            if($type[2] == 1) {
+                $image = imagecreatefromgif($file);
+            } elseif($type[2] == 2) {
+                $image = imagecreatefromjpeg($file);
+            } elseif($type[2] == 3) {
+                $image = imagecreatefrompng($file);
+            }
+
+			if (function_exists('imageantialias'))
+	            imageantialias($image, TRUE);
+
+            $image_attr = getimagesize($file);
+
+            // figure out the longest side
+
+            if($image_attr[0] &gt; $image_attr[1]) {
+                $image_width = $image_attr[0];
+                $image_height = $image_attr[1];
+                $image_new_width = $max_side;
+
+                $image_ratio = $image_width/$image_new_width;
+                $image_new_height = $image_height/$image_ratio;
+                //width is &gt; height
+            } else {
+                $image_width = $image_attr[0];
+                $image_height = $image_attr[1];
+                $image_new_height = $max_side;
+
+                $image_ratio = $image_height/$image_new_height;
+                $image_new_width = $image_width/$image_ratio;
+                //height &gt; width
+            }
+
+            $thumbnail = imagecreatetruecolor($image_new_width, $image_new_height);
+            @imagecopyresampled($thumbnail, $image, 0, 0, 0, 0, $image_new_width, $image_new_height, $image_attr[0], $image_attr[1]);
+
+            // move the thumbnail to it's final destination
+
+            $path = explode('/', $file);
+            $thumbpath = substr($file, 0, strrpos($file, '/')) . '/thumb-' . $path[count($path)-1];
+
+            if($type[2] == 1) {
+                if(!imagegif($thumbnail, $thumbpath)) {
+                    $error = __(&quot;Thumbnail path invalid&quot;);
+                }
+            } elseif($type[2] == 2) {
+                if(!imagejpeg($thumbnail, $thumbpath)) {
+                    $error = __(&quot;Thumbnail path invalid&quot;);
+                }
+            } elseif($type[2] == 3) {
+                if(!imagepng($thumbnail, $thumbpath)) {
+                    $error = __(&quot;Thumbnail path invalid&quot;);
+                }
+            }
+
+        }
+    }
+
+    if(!empty($error))
+    {
+        return $error;
+    }
+    else
+    {
+        return 1;
+    }
+}
+
+// Some postmeta stuff
+function has_meta($postid) {
+	global $wpdb;
+
+	return $wpdb-&gt;get_results(&quot;
+		SELECT meta_key, meta_value, meta_id, post_id
+		FROM $wpdb-&gt;postmeta
+		WHERE post_id = '$postid'
+		ORDER BY meta_key,meta_id&quot;,ARRAY_A);
+
+}
+
+function list_meta($meta) {
+	global $post_ID;
+	// Exit if no meta
+	if (!$meta) return;
+	$count = 0;
+?&gt;
+&lt;table id='meta-list' cellpadding=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th&gt;&lt;?php _e('Key') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Value') ?&gt;&lt;/th&gt;
+		&lt;th colspan='2'&gt;&lt;?php _e('Action') ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+	foreach ($meta as $entry) {
+		++$count;
+		if ( $count % 2 ) $style = 'alternate';
+		else $style = '';
+		if ( '_' == $entry['meta_key']{0} ) $style .= ' hidden';
+		echo &quot;
+	&lt;tr class='$style'&gt;
+		&lt;td valign='top'&gt;&lt;input name='meta[{$entry['meta_id']}][key]' tabindex='6' type='text' size='20' value='{$entry['meta_key']}' /&gt;&lt;/td&gt;
+		&lt;td&gt;&lt;textarea name='meta[{$entry['meta_id']}][value]' tabindex='6' rows='2' cols='30'&gt;{$entry['meta_value']}&lt;/textarea&gt;&lt;/td&gt;
+		&lt;td align='center' width='10%'&gt;&lt;input name='updatemeta' type='submit' class='updatemeta' tabindex='6' value='&quot; . __('Update') .&quot;' /&gt;&lt;/td&gt;
+		&lt;td align='center' width='10%'&gt;&lt;input name='deletemeta[{$entry['meta_id']}]' type='submit' class='deletemeta' tabindex='6' value='&quot; . __('Delete') .&quot;' /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&quot;;
+	}
+	echo &quot;
+	&lt;/table&gt;
+&quot;;
+}
+
+// Get a list of previously defined keys
+function get_meta_keys() {
+	global $wpdb;
+
+	$keys = $wpdb-&gt;get_col(&quot;
+		SELECT meta_key
+		FROM $wpdb-&gt;postmeta
+		GROUP BY meta_key
+		ORDER BY meta_key&quot;);
+
+	return $keys;
+}
+
+function meta_form() {
+	global $wpdb;
+	$keys = $wpdb-&gt;get_col(&quot;
+		SELECT meta_key
+		FROM $wpdb-&gt;postmeta
+		GROUP BY meta_key
+		ORDER BY meta_id DESC
+		LIMIT 10&quot;);
+?&gt;
+&lt;h3&gt;&lt;?php _e('Add a new custom field to this post:') ?&gt;&lt;/h3&gt;
+&lt;table cellspacing=&quot;3&quot; cellpadding=&quot;3&quot;&gt;
+	&lt;tr&gt;
+&lt;th colspan=&quot;2&quot;&gt;&lt;?php _e('Key') ?&gt;&lt;/th&gt;
+&lt;th&gt;&lt;?php _e('Value') ?&gt;&lt;/th&gt;
+&lt;/tr&gt;
+	&lt;tr valign=&quot;top&quot;&gt;
+		&lt;td align=&quot;right&quot; width=&quot;18%&quot;&gt;
+&lt;?php if ($keys) : ?&gt;
+&lt;select id=&quot;metakeyselect&quot; name=&quot;metakeyselect&quot; tabindex=&quot;7&quot;&gt;
+&lt;option value=&quot;#NONE#&quot;&gt;&lt;?php _e('- Select -'); ?&gt;&lt;/option&gt;
+&lt;?php
+	foreach($keys as $key) {
+		echo &quot;\n\t&lt;option value='$key'&gt;$key&lt;/option&gt;&quot;;
+	}
+?&gt;
+&lt;/select&gt; &lt;?php _e('or'); ?&gt;
+&lt;?php endif; ?&gt;
+&lt;/td&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; id=&quot;metakeyinput&quot; name=&quot;metakeyinput&quot; tabindex=&quot;7&quot; /&gt;&lt;/td&gt;
+		&lt;td&gt;&lt;textarea id=&quot;metavalue&quot; name=&quot;metavalue&quot; rows=&quot;3&quot; cols=&quot;25&quot; tabindex=&quot;8&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+
+&lt;/table&gt;
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;updatemeta&quot; tabindex=&quot;9&quot; value=&quot;&lt;?php _e('Add Custom Field &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+&lt;?php
+}
+
+function add_meta($post_ID) {
+	global $wpdb;
+
+	$metakeyselect = $wpdb-&gt;escape( stripslashes( trim($_POST['metakeyselect']) ) );
+	$metakeyinput  = $wpdb-&gt;escape( stripslashes( trim($_POST['metakeyinput']) ) );
+	$metavalue     = $wpdb-&gt;escape( stripslashes( trim($_POST['metavalue']) ) );
+
+	if (!empty($metavalue) &amp;&amp; ((('#NONE#' != $metakeyselect) &amp;&amp; !empty($metakeyselect)) || !empty($metakeyinput))) {
+		// We have a key/value pair. If both the select and the
+		// input for the key have data, the input takes precedence:
+
+		if ('#NONE#' != $metakeyselect)
+			$metakey = $metakeyselect;
+
+		if ($metakeyinput)
+			$metakey = $metakeyinput; // default
+
+		$result = $wpdb-&gt;query(&quot;
+				INSERT INTO $wpdb-&gt;postmeta
+				(post_id,meta_key,meta_value)
+				VALUES ('$post_ID','$metakey','$metavalue')
+			&quot;);
+	}
+} // add_meta
+
+function delete_meta($mid) {
+	global $wpdb;
+
+	$result = $wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;postmeta WHERE meta_id = '$mid'&quot;);
+}
+
+function update_meta($mid, $mkey, $mvalue) {
+	global $wpdb;
+
+	return $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;postmeta SET meta_key = '$mkey', meta_value = '$mvalue' WHERE meta_id = '$mid'&quot;);
+}
+
+function touch_time($edit = 1, $for_post = 1) {
+	global $month, $postdata, $commentdata;
+	if ( $for_post &amp;&amp; ('draft' == $postdata-&gt;post_status) ) {
+		$checked = 'checked=&quot;checked&quot; ';
+		$edit = false;
+	} else {
+		$checked = ' ';
+	}
+
+	echo '&lt;fieldset&gt;&lt;legend&gt;&lt;input type=&quot;checkbox&quot; class=&quot;checkbox&quot; name=&quot;edit_date&quot; value=&quot;1&quot; id=&quot;timestamp&quot; '.$checked.'/&gt; &lt;label for=&quot;timestamp&quot;&gt;' . __('Edit timestamp') . '&lt;/label&gt;&lt;/legend&gt;';
+
+	$time_adj = time() + (get_settings('gmt_offset') * 3600);
+	$post_date = ($for_post) ? $postdata-&gt;post_date : $commentdata['comment_date'];
+	$jj = ($edit) ? mysql2date('d', $post_date) : gmdate('d', $time_adj);
+	$mm = ($edit) ? mysql2date('m', $post_date) : gmdate('m', $time_adj);
+	$aa = ($edit) ? mysql2date('Y', $post_date) : gmdate('Y', $time_adj);
+	$hh = ($edit) ? mysql2date('H', $post_date) : gmdate('H', $time_adj);
+	$mn = ($edit) ? mysql2date('i', $post_date) : gmdate('i', $time_adj);
+	$ss = ($edit) ? mysql2date('s', $post_date) : gmdate('s', $time_adj);
+
+	echo &quot;&lt;select name=\&quot;mm\&quot;&gt;\n&quot;;
+	for ($i=1; $i &lt; 13; $i=$i+1) {
+		echo &quot;\t\t\t&lt;option value=\&quot;$i\&quot;&quot;;
+		if ($i == $mm)
+		echo &quot; selected='selected'&quot;;
+		if ($i &lt; 10) {
+			$ii = &quot;0&quot;.$i;
+		} else {
+			$ii = &quot;$i&quot;;
+		}
+		echo &quot;&gt;&quot;.$month[&quot;$ii&quot;].&quot;&lt;/option&gt;\n&quot;;
+	}
+
+?&gt;
+&lt;/select&gt;
+&lt;input type=&quot;text&quot; name=&quot;jj&quot; value=&quot;&lt;?php echo $jj; ?&gt;&quot; size=&quot;2&quot; maxlength=&quot;2&quot; /&gt;
+&lt;input type=&quot;text&quot; name=&quot;aa&quot; value=&quot;&lt;?php echo $aa ?&gt;&quot; size=&quot;4&quot; maxlength=&quot;5&quot; /&gt; @
+&lt;input type=&quot;text&quot; name=&quot;hh&quot; value=&quot;&lt;?php echo $hh ?&gt;&quot; size=&quot;2&quot; maxlength=&quot;2&quot; /&gt; :
+&lt;input type=&quot;text&quot; name=&quot;mn&quot; value=&quot;&lt;?php echo $mn ?&gt;&quot; size=&quot;2&quot; maxlength=&quot;2&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;ss&quot; value=&quot;&lt;?php echo $ss ?&gt;&quot; size=&quot;2&quot; maxlength=&quot;2&quot; /&gt;
+&lt;?php _e('Existing timestamp'); ?&gt;:
+	&lt;?php
+		// We might need to readjust to display proper existing timestamp
+		if ( $for_post &amp;&amp; ('draft' == $postdata-&gt;post_status) ) {
+			$jj = mysql2date('d', $post_date);
+			$mm = mysql2date('m', $post_date);
+			$aa = mysql2date('Y', $post_date);
+			$hh = mysql2date('H', $post_date);
+			$mn = mysql2date('i', $post_date);
+			$ss = mysql2date('s', $post_date);
+		}
+		echo &quot;{$month[$mm]} $jj, $aa @ $hh:$mn&quot;; ?&gt;
+&lt;/fieldset&gt;
+	&lt;?php
+}
+
+function check_admin_referer() {
+	$adminurl = strtolower( get_settings('siteurl') ) . '/wp-admin';
+	$referer = strtolower( $_SERVER['HTTP_REFERER'] );
+	if ( !strstr($referer, $adminurl) )
+		die(__('Sorry, you need to &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Enable_Sending_Referrers">http://codex.wordpress.org/Enable_Sending_Referrers</A>&quot;&gt;enable sending referrers&lt;/a&gt; for this feature to work.'));
+	do_action('check_admin_referer');
+}
+
+// insert_with_markers: Owen Winkler
+// Inserts an array of strings into a file (.htaccess), placing it between
+// BEGIN and END markers.  Replaces existing marked info.  Retains surrounding
+// data.  Creates file if none exists.
+// Returns true on write success, false on failure.
+function insert_with_markers($filename, $marker, $insertion) {
+	if (!file_exists($filename) || is_writeable($filename)) {
+		if (!file_exists($filename)) {
+			$markerdata = '';
+		} else {
+			$markerdata = explode(&quot;\n&quot;, implode('', file($filename)));
+		}
+
+		$f = fopen($filename, 'w');
+		$foundit = false;
+		if ($markerdata) {
+			$state = true;
+			$newline = '';
+			foreach($markerdata as $markerline) {
+				if (strstr($markerline, &quot;# BEGIN {$marker}&quot;)) $state = false;
+				if ($state) fwrite($f, &quot;{$newline}{$markerline}&quot;);
+				if (strstr($markerline, &quot;# END {$marker}&quot;)) {
+					fwrite($f, &quot;{$newline}# BEGIN {$marker}&quot;);
+					if(is_array($insertion)) foreach($insertion as $insertline) fwrite($f, &quot;{$newline}{$insertline}&quot;);
+					fwrite($f, &quot;{$newline}# END {$marker}&quot;);
+					$state = true;
+					$foundit = true;
+				}
+				$newline = &quot;\n&quot;;
+			}
+		}
+		if (!$foundit) {
+			fwrite($f, &quot;# BEGIN {$marker}\n&quot;);
+			foreach($insertion as $insertline) fwrite($f, &quot;{$insertline}\n&quot;);
+			fwrite($f, &quot;# END {$marker}&quot;);
+		}
+		fclose($f);
+		return true;
+	} else {
+		return false;
+	}
+}
+
+// insert_with_markers: Owen Winkler
+// Returns an array of strings from a file (.htaccess) from between BEGIN
+// and END markers.
+function extract_from_markers($filename, $marker) {
+	$result = array();
+
+	if (!file_exists($filename)) {
+		return $result;
+	}
+
+	if($markerdata = explode(&quot;\n&quot;, implode('', file($filename))));
+	{
+		$state = false;
+		foreach($markerdata as $markerline) {
+			if(strstr($markerline, &quot;# END {$marker}&quot;))	$state = false;
+			if($state) $result[] = $markerline;
+			if(strstr($markerline, &quot;# BEGIN {$marker}&quot;)) $state = true;
+		}
+	}
+
+	return $result;
+}
+
+function save_mod_rewrite_rules() {
+	global $is_apache, $wp_rewrite;
+	$home_path = get_home_path();
+
+	if (! $wp_rewrite-&gt;using_mod_rewrite_permalinks())
+		return;
+
+	if ( ! ((!file_exists($home_path.'.htaccess') &amp;&amp; is_writable($home_path)) || is_writable($home_path.'.htaccess')) )
+		return;
+
+	if (! $is_apache)
+		return;
+
+	$rules = explode(&quot;\n&quot;, $wp_rewrite-&gt;mod_rewrite_rules());
+	insert_with_markers($home_path.'.htaccess', 'WordPress', $rules);
+}
+
+function generate_page_rewrite_rules() {
+	global $wpdb;
+	$posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_name FROM $wpdb-&gt;posts WHERE post_status = 'static' ORDER BY post_parent DESC&quot;);
+
+	$page_rewrite_rules = array();
+
+	if ($posts) {
+		foreach ($posts as $post) {
+			// URI =&gt; page name
+			$uri = get_page_uri($post-&gt;ID);
+
+			$page_rewrite_rules[$uri] = $post-&gt;post_name;
+		}
+
+		update_option('page_uris', $page_rewrite_rules);
+
+		save_mod_rewrite_rules();
+	}
+}
+
+function validate_current_theme() {
+	$theme_loc = 'wp-content/themes';
+	$theme_root = ABSPATH . $theme_loc;
+
+	$template = get_settings('template');
+	$stylesheet = get_settings('stylesheet');
+
+	if (($template != 'default') &amp;&amp; (! file_exists(&quot;$theme_root/$template/index.php&quot;))) {
+		update_option('template', 'default');
+		update_option('stylesheet', 'default');
+		do_action('switch_theme', 'Default');
+		return false;
+	}
+
+	if (($stylesheet != 'default') &amp;&amp; (! file_exists(&quot;$theme_root/$stylesheet/style.css&quot;))) {
+		update_option('template', 'default');
+		update_option('stylesheet', 'default');
+		do_action('switch_theme', 'Default');
+		return false;
+	}
+
+	return true;
+}
+
+function get_broken_themes() {
+	global $wp_broken_themes;
+
+	get_themes();
+	return $wp_broken_themes;
+}
+
+function get_page_templates() {
+	$themes = get_themes();
+	$theme = get_current_theme();
+	$templates = $themes[$theme]['Template Files'];
+	$page_templates = array();
+
+	if( is_array( $templates ) ) {
+		foreach ($templates as $template) {
+			$template_data = implode('', file(ABSPATH . $template));
+			preg_match(&quot;|Template Name:(.*)|i&quot;, $template_data, $name);
+			preg_match(&quot;|Description:(.*)|i&quot;, $template_data, $description);
+
+			$name = $name[1];
+			$description = $description[1];
+
+			if (! empty($name)) {
+				$page_templates[trim($name)] = basename($template);
+			}
+		}
+	}
+
+	return $page_templates;
+}
+
+function page_template_dropdown($default = '') {
+	$templates = get_page_templates();
+	foreach (array_keys($templates) as $template) :
+		if ($default == $templates[$template]) $selected = &quot; selected='selected'&quot;;
+		else $selected = '';
+		echo &quot;\n\t&lt;option value='&quot; . $templates[$template] . &quot;' $selected&gt;$template&lt;/option&gt;&quot;;
+		endforeach;
+}
+
+function parent_dropdown($default = 0, $parent = 0, $level = 0) {
+	global $wpdb, $post_ID;
+	$items = $wpdb-&gt;get_results(&quot;SELECT ID, post_parent, post_title FROM $wpdb-&gt;posts WHERE post_parent = $parent AND post_status = 'static' ORDER BY menu_order&quot;);
+
+	if ($items) {
+		foreach ($items as $item) {
+			// A page cannot be it's own parent.
+			if (!empty($post_ID)) {
+				if ($item-&gt;ID == $post_ID) {
+					continue;
+				}
+			}
+			$pad = str_repeat('&nbsp;', $level * 3);
+			if ($item-&gt;ID == $default)
+				$current = ' selected=&quot;selected&quot;';
+			else
+				$current = '';
+
+			echo &quot;\n\t&lt;option value='$item-&gt;ID'$current&gt;$pad $item-&gt;post_title&lt;/option&gt;&quot;;
+			parent_dropdown($default, $item-&gt;ID, $level + 1);
+		}
+	} else {
+		return false;
+	}
+}
+
+function user_can_access_admin_page() {
+	global $pagenow;
+	global $menu;
+	global $submenu;
+	global $user_level;
+
+	$parent = get_admin_page_parent();
+
+	foreach ($menu as $menu_array) {
+		//echo &quot;parent array: &quot; . $menu_array[2];
+		if ($menu_array[2] == $parent) {
+			if ($user_level &lt; $menu_array[1]) {
+				return false;
+			} else {
+				break;
+			}
+		}
+	}
+
+	if (isset($submenu[$parent])) {
+		foreach ($submenu[$parent] as $submenu_array) {
+			if ($submenu_array[2] == $pagenow) {
+				if ($user_level &lt; $submenu_array[1]) {
+					return false;
+				} else {
+					return true;
+				}
+			}
+		}
+	}
+
+	return true;
+}
+
+function get_admin_page_title() {
+	global $title;
+	global $menu;
+	global $submenu;
+	global $pagenow;
+	global $plugin_page;
+
+	if (isset($title) &amp;&amp; ! empty($title)) {
+		return $title;
+	}
+
+	$parent = get_admin_page_parent();
+	if (empty($parent)) {
+		foreach ($menu as $menu_array) {
+			if (isset($menu_array[3])) {
+				if ($menu_array[2] == $pagenow) {
+					$title = $menu_array[3];
+					return $menu_array[3];
+				} else if (isset($plugin_page) &amp;&amp; ($plugin_page == $menu_array[2])) {
+					$title = $menu_array[3];
+					return $menu_array[3];
+				}
+			}
+		}
+	} else {
+		foreach (array_keys($submenu) as $parent) {
+			foreach ($submenu[$parent] as $submenu_array) {
+				if (isset($submenu_array[3])) {
+					if ($submenu_array[2] == $pagenow) {
+						$title = $submenu_array[3];
+						return $submenu_array[3];
+					} else if (isset($plugin_page) &amp;&amp; ($plugin_page == $submenu_array[2])) {
+						$title = $submenu_array[3];
+						return $submenu_array[3];
+					}
+				}
+			}
+		}
+	}
+
+	return '';
+}
+
+function get_admin_page_parent() {
+	global $parent_file;
+	global $menu;
+	global $submenu;
+	global $pagenow;
+	global $plugin_page;
+
+	if (isset($parent_file) &amp;&amp; ! empty($parent_file)) {
+		return $parent_file;
+	}
+
+	if ($pagenow == 'admin.php' &amp;&amp; isset($plugin_page)) {
+		foreach ($menu as $parent_menu) {
+			if ($parent_menu[2] == $plugin_page) {
+				$parent_file = $plugin_page;
+				return $plugin_page;
+			}
+		}
+	}
+
+	foreach (array_keys($submenu) as $parent) {
+		foreach ($submenu[$parent] as $submenu_array) {
+			if ($submenu_array[2] == $pagenow) {
+				$parent_file = $parent;
+				return $parent;
+			} else if (isset($plugin_page) &amp;&amp; ($plugin_page == $submenu_array[2])) {
+				$parent_file = $parent;
+				return $parent;
+			}
+		}
+	}
+
+	$parent_file = '';
+	return '';
+}
+
+function plugin_basename($file) {
+	return preg_replace('/^.*wp-content[\\\\\/]plugins[\\\\\/]/', '', $file);
+}
+
+function add_menu_page($page_title, $menu_title, $access_level, $file, $function = '') {
+	global $menu, $admin_page_hooks;
+
+	$file = plugin_basename($file);
+
+	$menu[] = array($menu_title, $access_level, $file, $page_title);
+
+	$admin_page_hooks[$file] = sanitize_title($menu_title);
+
+	$hookname = get_plugin_page_hookname($file, '');
+	if ( !empty($function) &amp;&amp; !empty($hookname) )
+		add_action($hookname, $function);
+
+	return $hookname;
+}
+
+function add_submenu_page($parent, $page_title, $menu_title, $access_level, $file, $function = '') {
+	global $submenu;
+	global $menu;
+
+	$parent = plugin_basename($parent);
+	$file = plugin_basename($file);
+
+	// If the parent doesn't already have a submenu, add a link to the parent
+	// as the first item in the submenu.  If the submenu file is the same as the
+	// parent file someone is trying to link back to the parent manually.  In
+	// this case, don't automatically add a link back to avoid duplication.
+	if (! isset($submenu[$parent]) &amp;&amp; $file != $parent) {
+		foreach ($menu as $parent_menu) {
+			if ($parent_menu[2] == $parent) {
+				$submenu[$parent][] = $parent_menu;
+			}
+		}
+	}
+
+	$submenu[$parent][] = array($menu_title, $access_level, $file, $page_title);
+
+	$hookname = get_plugin_page_hookname($file, $parent);
+	if ( !empty($function) &amp;&amp; !empty($hookname) )
+		add_action($hookname, $function);
+
+	return $hookname;
+}
+
+function add_options_page($page_title, $menu_title, $access_level, $file, $function = '') {
+	return add_submenu_page('options-general.php', $page_title, $menu_title, $access_level, $file, $function);
+}
+
+function add_management_page($page_title, $menu_title, $access_level, $file, $function = '') {
+	return add_submenu_page('edit.php', $page_title, $menu_title, $access_level, $file, $function);
+}
+
+function validate_file($file, $allowed_files = '') {
+	if ( false !== strpos($file, './'))
+		return 1;
+
+	if (':' == substr($file,1,1))
+		return 2;
+
+	if ( !empty($allowed_files) &amp;&amp; (! in_array($file, $allowed_files)) )
+		return 3;
+
+	return 0;
+}
+
+function validate_file_to_edit($file, $allowed_files = '') {
+	$file = stripslashes($file);
+
+	$code = validate_file($file, $allowed_files);
+
+	if (! $code)
+		return $file;
+
+	switch ($code) {
+	case 1:
+		die (__('Sorry, can&#8217;t edit files with &quot;..&quot; in the name. If you are trying to edit a file in your WordPress home directory, you can just type the name of the file in.'));
+
+	case 2:
+		die (__('Sorry, can&#8217;t call files with their real path.'));
+
+	case 3:
+		die (__('Sorry, that file cannot be edited.'));
+	}
+}
+
+function get_home_path() {
+	$home = get_settings('home');
+	if ( $home != '' &amp;&amp; $home != get_settings('siteurl') ) {
+		$home_path = parse_url($home);
+		$home_path = $home_path['path'];
+		$root = str_replace($_SERVER[&quot;PHP_SELF&quot;], '', $_SERVER[&quot;SCRIPT_FILENAME&quot;]);
+		$home_path = trailingslashit($root . $home_path);
+	} else {
+		$home_path = ABSPATH;
+	}
+
+	return $home_path;
+}
+
+function get_real_file_to_edit($file) {
+	if ('index.php' == $file ||
+			 '.htaccess' == $file) {
+		$real_file = get_home_path() . $file;
+	} else {
+		$real_file = ABSPATH . $file;
+	}
+
+	return $real_file;
+}
+
+$wp_file_descriptions =
+	array(
+	'index.php' =&gt; __('Main Template'),
+	'style.css' =&gt; __('Stylesheet'),
+	'comments.php' =&gt; __('Comments Template'),
+	'comments-popup.php' =&gt; __('Popup Comments Template'),
+	'footer.php' =&gt; __('Footer Template'),
+	'header.php' =&gt; __('Header Template'),
+	'sidebar.php' =&gt; __('Sidebar Template'),
+	'archive.php' =&gt; __('Archive Template'),
+	'category.php' =&gt; __('Category Template'),
+	'page.php' =&gt; __('Page Template'),
+	'search.php' =&gt; __('Search Template'),
+	'single.php' =&gt; __('Post Template'),
+	'404.php' =&gt; __('404 Template'),
+	'my-hacks.php' =&gt; __('my-hacks.php (legacy hacks support)'),
+	'.htaccess' =&gt; __('.htaccess (for rewrite rules)'),
+	// Deprecated files
+	'wp-layout.css' =&gt; __('Stylesheet'),
+	'wp-comments.php' =&gt; __('Comments Template'),
+	'wp-comments-popup.php' =&gt; __('Popup Comments Template')
+	);
+
+function get_file_description($file) {
+	global $wp_file_descriptions;
+
+	if ( isset($wp_file_descriptions[basename($file)] ) ) {
+		return $wp_file_descriptions[basename($file)];
+	} elseif ( file_exists( ABSPATH . $file ) ) {
+		$template_data = implode('', file(ABSPATH . $file));
+		if ( preg_match(&quot;|Template Name:(.*)|i&quot;, $template_data, $name) )
+			return $name[1];
+	}
+
+	return basename( $file );
+}
+
+function update_recently_edited($file) {
+	$oldfiles = (array) get_option('recently_edited');
+	if ($oldfiles) {
+		$oldfiles = array_reverse($oldfiles);
+		$oldfiles[] = $file;
+		$oldfiles = array_reverse($oldfiles);
+		$oldfiles = array_unique($oldfiles);
+		if ( 5 &lt; count($oldfiles) )
+			array_pop($oldfiles);
+	} else {
+		$oldfiles[] = $file;
+	}
+	update_option('recently_edited', $oldfiles);
+}
+
+function get_plugin_data($plugin_file) {
+	$plugin_data = implode('', file($plugin_file));
+	preg_match(&quot;|Plugin Name:(.*)|i&quot;, $plugin_data, $plugin_name);
+	preg_match(&quot;|Plugin URI:(.*)|i&quot;, $plugin_data, $plugin_uri);
+	preg_match(&quot;|Description:(.*)|i&quot;, $plugin_data, $description);
+	preg_match(&quot;|Author:(.*)|i&quot;, $plugin_data, $author_name);
+	preg_match(&quot;|Author URI:(.*)|i&quot;, $plugin_data, $author_uri);
+	if ( preg_match(&quot;|Version:(.*)|i&quot;, $plugin_data, $version) )
+		$version = $version[1];
+	else
+		$version ='';
+
+	$description = wptexturize($description[1]);
+
+	$name = $plugin_name[1];
+	$name = trim($name);
+	$plugin = $name;
+	if ('' != $plugin_uri[1] &amp;&amp; '' != $name) {
+		$plugin = '&lt;a href=&quot;' . $plugin_uri[1] . '&quot; title=&quot;' . __('Visit plugin homepage') . '&quot;&gt;' . $plugin . '&lt;/a&gt;';
+	}
+
+	if ('' == $author_uri[1]) {
+		$author = $author_name[1];
+	} else {
+		$author = '&lt;a href=&quot;' . $author_uri[1] . '&quot; title=&quot;' . __('Visit author homepage') . '&quot;&gt;' . $author_name[1] . '&lt;/a&gt;';
+	}
+
+	return array('Name' =&gt; $name, 'Title' =&gt; $plugin, 'Description' =&gt; $description, 'Author' =&gt; $author, 'Version' =&gt; $version, 'Template' =&gt; $template[1]);
+}
+
+function get_plugins() {
+	global $wp_plugins;
+
+	if (isset($wp_plugins)) {
+		return $wp_plugins;
+	}
+
+	$wp_plugins = array();
+	$plugin_loc = 'wp-content/plugins';
+	$plugin_root = ABSPATH . $plugin_loc;
+
+	// Files in wp-content/plugins directory
+	$plugins_dir = @ dir($plugin_root);
+	if ($plugins_dir) {
+		while(($file = $plugins_dir-&gt;read()) !== false) {
+			if ( preg_match('|^\.+$|', $file) )
+				continue;
+			if (is_dir($plugin_root . '/' . $file)) {
+				$plugins_subdir = @ dir($plugin_root . '/' . $file);
+				if ($plugins_subdir) {
+					while(($subfile = $plugins_subdir-&gt;read()) !== false) {
+						if ( preg_match('|^\.+$|', $subfile) )
+							continue;
+						if ( preg_match('|\.php$|', $subfile) )
+							$plugin_files[] = &quot;$file/$subfile&quot;;
+					}
+				}
+			} else {
+				if ( preg_match('|\.php$|', $file) )
+					$plugin_files[] = $file;
+			}
+		}
+	}
+
+	if (!$plugins_dir || !$plugin_files) {
+		return $wp_plugins;
+	}
+
+	sort($plugin_files);
+
+	foreach($plugin_files as $plugin_file) {
+		$plugin_data = get_plugin_data(&quot;$plugin_root/$plugin_file&quot;);
+
+		if (empty($plugin_data['Name'])) {
+			continue;
+		}
+
+		$wp_plugins[plugin_basename($plugin_file)] = $plugin_data;
+	}
+
+	return $wp_plugins;
+}
+
+function get_plugin_page_hookname($plugin_page, $parent_page) {
+	global $admin_page_hooks;
+
+	$parent = get_admin_page_parent();
+
+	if ( empty($parent_page) || 'admin.php' == $parent_page ) {
+		if ( isset($admin_page_hooks[$plugin_page]) )
+			$page_type = 'toplevel';
+		else if ( isset($admin_page_hooks[$parent]) )
+			$page_type = $admin_page_hooks[$parent];
+	} else if ( isset($admin_page_hooks[$parent_page]) ) {
+		$page_type = $admin_page_hooks[$parent_page];
+	} else {
+		$page_type = 'admin';
+	}
+
+	$plugin_name = preg_replace('!\.php!', '', $plugin_page);
+
+	return $page_type . '_page_' . $plugin_name;
+}
+
+function get_plugin_page_hook($plugin_page, $parent_page) {
+	global $wp_filter;
+
+	$hook = get_plugin_page_hookname($plugin_page, $parent_page);
+	if ( isset($wp_filter[$hook]) )
+		return $hook;
+	else
+		return '';
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/admin-header.php
===================================================================
--- trunk/wp-admin/admin-header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/admin-header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,103 @@
+&lt;?php
<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">+ at header</A>('Content-type: ' . get_option('html_type') . '; charset=' . get_option('blog_charset'));
+if (!isset($_GET[&quot;page&quot;])) require_once('admin.php'); ?&gt;
+&lt;?php get_admin_page_title(); ?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;title&gt;&lt;?php bloginfo('name') ?&gt; &rsaquo; &lt;?php echo $title; ?&gt; &#8212; WordPress&lt;/title&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php echo get_settings('siteurl') ?&gt;/wp-admin/wp-admin.css?version=&lt;?php bloginfo('version'); ?&gt;&quot; type=&quot;text/css&quot; /&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+//&lt;![CDATA[
+&lt;?php
+echo &quot;\n&quot;;
+?&gt;
+function customToggleLink()
+{
+// TODO: Only show link if there's a hidden row
+	document.write('&lt;small&gt;(&lt;a href=&quot;javascript:;&quot; id=&quot;customtoggle&quot; onclick=&quot;toggleHidden()&quot;&gt;&lt;?php _e('Show hidden'); ?&gt;&lt;/a&gt;)&lt;/small&gt;');
+// TODO: Rotate link to say &quot;show&quot; or &quot;hide&quot;
+// TODO: Use DOM
+}
+
+function toggleHidden()
+{
+	var allElements = document.getElementsByTagName('tr');
+	for (i = 0; i &lt; allElements.length; i++)
+	{
+		if ( allElements[i].className.indexOf('hidden') != -1 )
+		{
+			 allElements[i].className = allElements[i].className.replace('hidden', '');
+		}
+	}
+}
+
+&lt;?php if ( isset($xfn) ) : ?&gt;
+
+function GetElementsWithClassName(elementName, className) {
+	var allElements = document.getElementsByTagName(elementName);
+	var elemColl = new Array();
+	for (i = 0; i &lt; allElements.length; i++) {
+		if (allElements[i].className == className) {
+			elemColl[elemColl.length] = allElements[i];
+		}
+	}
+	return elemColl;
+}
+
+function meChecked() {
+  var undefined;
+  var eMe = document.getElementById('me');
+  if (eMe == undefined) return false;
+  else return eMe.checked;
+}
+
+function upit() {
+	var isMe = meChecked(); //document.getElementById('me').checked;
+	var inputColl = GetElementsWithClassName('input', 'valinp');
+	var results = document.getElementById('rel');
+	var linkText, linkUrl, inputs = '';
+	for (i = 0; i &lt; inputColl.length; i++) {
+		 inputColl[i].disabled = isMe;
+		 inputColl[i].parentNode.className = isMe ? 'disabled' : '';
+		 if (!isMe &amp;&amp; inputColl[i].checked &amp;&amp; inputColl[i].value != '') {
+			inputs += inputColl[i].value + ' ';
+				}
+		 }
+	inputs = inputs.substr(0,inputs.length - 1);
+	if (isMe) inputs='me';
+	results.value = inputs;
+	}
+
+
+&lt;?php
+endif;
+echo &quot;\n&quot;;
+?&gt;
+
+//]]&gt;
+&lt;/script&gt;
+
+&lt;?php
+do_action('admin_head', '');
+echo &quot;\n&quot;;
+?&gt;
+&lt;/head&gt;
+&lt;body&gt;
+
+	&lt;div id=&quot;wphead&quot;&gt;&lt;span&gt;&lt;a href=&quot;&lt;?php echo get_settings('home') . '/'; ?&gt;&quot;&gt; &lt;?php _e('View site') ?&gt;&lt;/a&gt;&lt;/span&gt;
+		&lt;h1&gt;
+&lt;?php echo wptexturize(get_settings(('blogname'))); ?&gt;
+		&lt;/h1&gt;
+
+	&lt;/div&gt;
+
+&lt;?php
+require(ABSPATH . '/wp-admin/menu-header.php');
+
+if ( $parent_file == 'options-general.php' ) {
+	require(ABSPATH . '/wp-admin/options-head.php');
+}
+?&gt;

Added: trunk/wp-admin/admin.php
===================================================================
--- trunk/wp-admin/admin.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/admin.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,71 @@
+&lt;?php
+if ( defined('ABSPATH') )
+	require_once( ABSPATH . 'wp-config.php');
+else
+    require_once('../wp-config.php');
+    
+require_once(ABSPATH . 'wp-admin/admin-functions.php');
+auth_redirect();
+
+header('Expires: Wed, 11 Jan 1984 05:00:00 GMT');
+header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
+header('Cache-Control: no-cache, must-revalidate, max-age=0');
+header('Pragma: no-cache');
+
+update_category_cache();
+
+get_currentuserinfo();
+
+$posts_per_page = get_settings('posts_per_page');
+$what_to_show = get_settings('what_to_show');
+$date_format = get_settings('date_format');
+$time_format = get_settings('time_format');
+
+$wpvarstoreset = array('profile','redirect','redirect_url','a','popuptitle','popupurl','text', 'trackback', 'pingback');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+    $wpvar = $wpvarstoreset[$i];
+    if (!isset($$wpvar)) {
+        if (empty($_POST[&quot;$wpvar&quot;])) {
+            if (empty($_GET[&quot;$wpvar&quot;])) {
+                $$wpvar = '';
+            } else {
+                $$wpvar = $_GET[&quot;$wpvar&quot;];
+            }
+        } else {
+            $$wpvar = $_POST[&quot;$wpvar&quot;];
+        }
+    }
+}
+
+require(ABSPATH . '/wp-admin/menu.php');
+
+// Handle plugin admin pages.
+if (isset($_GET['page'])) {
+	$plugin_page = plugin_basename($_GET['page']);
+	$page_hook = get_plugin_page_hook($plugin_page, $pagenow);
+
+	if ( $page_hook ) {
+		if (! isset($_GET['noheader']))
+			require_once(ABSPATH . '/wp-admin/admin-header.php');
+		
+		do_action($page_hook);
+	} else {
+		if ( validate_file($plugin_page) ) {
+			die(__('Invalid plugin page'));
+		}
+		
+		if (! file_exists(ABSPATH . &quot;wp-content/plugins/$plugin_page&quot;))
+			die(sprintf(__('Cannot load %s.'), $plugin_page));
+
+		if (! isset($_GET['noheader']))
+			require_once(ABSPATH . '/wp-admin/admin-header.php');
+		
+		include(ABSPATH . &quot;wp-content/plugins/$plugin_page&quot;);
+	}
+	
+	include(ABSPATH . 'wp-admin/admin-footer.php');
+
+	exit();
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/categories.php
===================================================================
--- trunk/wp-admin/categories.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/categories.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,186 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Categories');
+$parent_file = 'edit.php';
+
+$wpvarstoreset = array('action','cat');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+    $wpvar = $wpvarstoreset[$i];
+    if (!isset($$wpvar)) {
+        if (empty($_POST[&quot;$wpvar&quot;])) {
+            if (empty($_GET[&quot;$wpvar&quot;])) {
+                $$wpvar = '';
+            } else {
+                $$wpvar = $_GET[&quot;$wpvar&quot;];
+            }
+        } else {
+            $$wpvar = $_POST[&quot;$wpvar&quot;];
+        }
+    }
+}
+
+switch($action) {
+
+case 'addcat':
+	if ($user_level &lt; 3)
+		die (__('Cheatin&#8217; uh?'));
+	
+	$cat_name= wp_specialchars($_POST['cat_name']);
+	$id_result = $wpdb-&gt;get_row(&quot;SHOW TABLE STATUS LIKE '$wpdb-&gt;categories'&quot;);
+	$cat_ID = $id_result-&gt;Auto_increment;
+	$category_nicename = sanitize_title($cat_name, $cat_ID);
+	$category_description = $_POST['category_description'];
+	$cat = intval($_POST['cat']);
+	
+	$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;categories (cat_ID, cat_name, category_nicename, category_description, category_parent) VALUES ('0', '$cat_name', '$category_nicename', '$category_description', '$cat')&quot;);
+	do_action('add_category', $wpdb-&gt;insert_id);
+	
+	header('Location: categories.php?message=1#addcat');
+break;
+
+case 'delete':
+
+	check_admin_referer();
+
+	$cat_ID = (int) $_GET['cat_ID'];
+	$cat_name = get_catname($cat_ID);
+	$category = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;categories WHERE cat_ID = '$cat_ID'&quot;);
+	$cat_parent = $category-&gt;category_parent;
+
+	if ( 1 == $cat_ID )
+		die(sprintf(__(&quot;Can't delete the &lt;strong&gt;%s&lt;/strong&gt; category: this is the default one&quot;), $cat_name));
+
+	if ( $user_level &lt; 3 )
+		die (__('Cheatin&#8217; uh?'));
+
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;categories WHERE cat_ID = '$cat_ID'&quot;);
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;categories SET category_parent = '$cat_parent' WHERE category_parent = '$cat_ID'&quot;);
+	// TODO: Only set categories to general if they're not in another category already
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;post2cat SET category_id='1' WHERE category_id='$cat_ID'&quot;);
+	do_action('delete_category', $cat_ID);
+
+	header('Location: categories.php?message=2');
+
+break;
+
+case 'edit':
+
+    require_once ('admin-header.php');
+    $cat_ID = (int) $_GET['cat_ID'];
+    $category = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;categories WHERE cat_ID = '$cat_ID'&quot;);
+    $cat_name = $category-&gt;cat_name;
+    ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+ &lt;h2&gt;&lt;?php _e('Edit Category') ?&gt;&lt;/h2&gt;
+ &lt;form name=&quot;editcat&quot; action=&quot;categories.php&quot; method=&quot;post&quot;&gt;
+	  &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+		&lt;tr&gt;
+		  &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Category name:') ?&gt;&lt;/th&gt;
+		  &lt;td width=&quot;67%&quot;&gt;&lt;input name=&quot;cat_name&quot; type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($cat_name); ?&gt;&quot; size=&quot;40&quot; /&gt; &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;editedcat&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;cat_ID&quot; value=&quot;&lt;?php echo $cat_ID ?&gt;&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Category slug:') ?&gt;&lt;/th&gt;
+			&lt;td&gt;&lt;input name=&quot;category_nicename&quot; type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($category-&gt;category_nicename); ?&gt;&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Category parent:') ?&gt;&lt;/th&gt;
+			&lt;td&gt;        
+			&lt;select name='cat'&gt;
+	  &lt;option value='0' &lt;?php if (!$category-&gt;category_parent) echo &quot; selected='selected'&quot;; ?&gt;&gt;&lt;?php _e('None') ?&gt;&lt;/option&gt;
+	  &lt;?php wp_dropdown_cats($category-&gt;cat_ID, $category-&gt;category_parent); ?&gt;
+	  &lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Description:') ?&gt;&lt;/th&gt;
+			&lt;td&gt;&lt;textarea name=&quot;category_description&quot; rows=&quot;5&quot; cols=&quot;50&quot; style=&quot;width: 97%;&quot;&gt;&lt;?php echo wp_specialchars($category-&gt;category_description, 1); ?&gt;&lt;/textarea&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;/table&gt;
+	  &lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Edit category') ?&gt; &raquo;&quot; /&gt;&lt;/p&gt;
+ &lt;/form&gt;
+ &lt;p&gt;&lt;a href=&quot;categories.php&quot;&gt;&lt;?php _e('&laquo; Return to category list'); ?&gt;&lt;/a&gt;&lt;/p&gt;
+&lt;/div&gt;
+    &lt;?php
+
+break;
+
+case 'editedcat':
+	if ($user_level &lt; 3)
+		die (__('Cheatin&#8217; uh?'));
+	
+	$cat_name = wp_specialchars($_POST['cat_name']);
+	$cat_ID = (int) $_POST['cat_ID'];
+	$category_nicename = sanitize_title($_POST['category_nicename'], $cat_ID);
+	$category_description = $_POST['category_description'];
+	
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;categories SET cat_name = '$cat_name', category_nicename = '$category_nicename', category_description = '$category_description', category_parent = '$cat' WHERE cat_ID = '$cat_ID'&quot;);
+
+	header('Location: categories.php?message=3');
+break;
+
+default:
+
+require_once ('admin-header.php');
+
+$messages[1] = __('Category added.');
+$messages[2] = __('Category deleted.');
+$messages[3] = __('Category updated.');
+?&gt;
+
+&lt;?php if (isset($_GET['message'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php echo $messages[$_GET['message']]; ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;?php if ( $user_level &gt; 3 ) : ?&gt;
+	&lt;h2&gt;&lt;?php printf(__('Categories (&lt;a href=&quot;%s&quot;&gt;add new&lt;/a&gt;)'), '#addcat') ?&gt; &lt;/h2&gt;
+&lt;?php else : ?&gt;
+	&lt;h2&gt;&lt;?php _e('Categories') ?&gt; &lt;/h2&gt;
+&lt;?php endif; ?&gt;
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;col&quot;&gt;&lt;?php _e('ID') ?&gt;&lt;/th&gt;
+        &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+        &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('Description') ?&gt;&lt;/th&gt;
+        &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('# Posts') ?&gt;&lt;/th&gt;
+        &lt;th colspan=&quot;2&quot;&gt;&lt;?php _e('Action') ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+cat_rows();
+?&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;?php if ( $user_level &gt; 3 ) : ?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+    &lt;p&gt;&lt;?php printf(__('&lt;strong&gt;Note:&lt;/strong&gt;&lt;br /&gt;Deleting a category does not delete posts from that category, it will just set them back to the default category &lt;strong&gt;%s&lt;/strong&gt;.'), get_catname(1)) ?&gt;
+  &lt;/p&gt;
+&lt;/div&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+    &lt;h2&gt;&lt;?php _e('Add New Category') ?&gt;&lt;/h2&gt;
+    &lt;form name=&quot;addcat&quot; id=&quot;addcat&quot; action=&quot;categories.php&quot; method=&quot;post&quot;&gt;
+        
+        &lt;p&gt;&lt;?php _e('Name:') ?&gt;&lt;br /&gt;
+        &lt;input type=&quot;text&quot; name=&quot;cat_name&quot; value=&quot;&quot; /&gt;&lt;/p&gt;
+        &lt;p&gt;&lt;?php _e('Category parent:') ?&gt;&lt;br /&gt;
+        &lt;select name='cat' class='postform'&gt;
+        &lt;option value='0'&gt;&lt;?php _e('None') ?&gt;&lt;/option&gt;
+        &lt;?php wp_dropdown_cats(0); ?&gt;
+        &lt;/select&gt;&lt;/p&gt;
+        &lt;p&gt;&lt;?php _e('Description: (optional)') ?&gt; &lt;br /&gt;
+        &lt;textarea name=&quot;category_description&quot; rows=&quot;5&quot; cols=&quot;50&quot; style=&quot;width: 97%;&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;
+        &lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;addcat&quot; /&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Add Category &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+    &lt;/form&gt;
+&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;?php
+break;
+}
+
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/edit-comments.php
===================================================================
--- trunk/wp-admin/edit-comments.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-comments.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,171 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Edit Comments');
+$parent_file = 'edit.php';
+
+require_once('admin-header.php');
+if (empty($_GET['mode'])) $mode = 'view';
+else $mode = wp_specialchars($_GET['mode'], 1);
+?&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+function checkAll(form)
+{
+	for (i = 0, n = form.elements.length; i &lt; n; i++) {
+		if(form.elements[i].type == &quot;checkbox&quot;) {
+			if(form.elements[i].checked == true)
+				form.elements[i].checked = false;
+			else
+				form.elements[i].checked = true;
+		}
+	}
+}
+//--&gt;
+&lt;/script&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Comments'); ?&gt;&lt;/h2&gt;
+&lt;form name=&quot;searchform&quot; action=&quot;&quot; method=&quot;get&quot;&gt; 
+  &lt;fieldset&gt; 
+  &lt;legend&gt;&lt;?php _e('Show Comments That Contain...') ?&gt;&lt;/legend&gt; 
+  &lt;input type=&quot;text&quot; name=&quot;s&quot; value=&quot;&lt;?php if (isset($_GET['s'])) echo wp_specialchars($_GET['s'], 1); ?&gt;&quot; size=&quot;17&quot; /&gt; 
+  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Search') ?&gt;&quot;  /&gt;  
+  &lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;&lt;?php echo $mode; ?&gt;&quot; /&gt;
+  &lt;?php _e('(Searches within comment text, e-mail, URI, and IP address.)') ?&gt;
+  &lt;/fieldset&gt; 
+&lt;/form&gt;
+&lt;p&gt;&lt;a href=&quot;?mode=view&quot;&gt;&lt;?php _e('View Mode') ?&gt;&lt;/a&gt; | &lt;a href=&quot;?mode=edit&quot;&gt;&lt;?php _e('Mass Edit Mode') ?&gt;&lt;/a&gt;&lt;/p&gt;
+&lt;?php
+if ( !empty( $_POST['delete_comments'] ) ) :
+	$i = 0;
+	foreach ($_POST['delete_comments'] as $comment) : // Check the permissions on each
+		$comment = (int) $comment;
+		$post_id = $wpdb-&gt;get_var(&quot;SELECT comment_post_ID FROM $wpdb-&gt;comments WHERE comment_ID = $comment&quot;);
+		$authordata = get_userdata( $wpdb-&gt;get_var(&quot;SELECT post_author FROM $wpdb-&gt;posts WHERE ID = $post_id&quot;) );
+		if ( user_can_delete_post_comments($user_ID, $post_id) ) :
+			$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;comments WHERE comment_ID = $comment&quot;);
+			++$i;
+		endif;
+	endforeach;
+	echo &quot;&lt;div class='wrap'&gt;&lt;p&gt;&quot; . sprintf(__('%s comments deleted.'), $i) . &quot;&lt;/p&gt;&lt;/div&gt;&quot;;
+endif;
+
+if (isset($_GET['s'])) {
+	$s = $wpdb-&gt;escape($_GET['s']);
+	$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments  WHERE
+		(comment_author LIKE '%$s%' OR
+		comment_author_email LIKE '%$s%' OR
+		comment_author_url LIKE ('%$s%') OR
+		comment_author_IP LIKE ('%$s%') OR
+		comment_content LIKE ('%$s%') ) AND
+		comment_approved != 'spam'
+		ORDER BY comment_date DESC&quot;);
+} else {
+	if ( isset($_GET['offset']) )
+		$offset = (int) $_GET['offset'] * 20;
+	else
+		$offset = 0;
+
+	$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_approved = '0' OR comment_approved = '1' ORDER BY comment_date DESC LIMIT $offset,20&quot;);
+}
+if ('view' == $mode) {
+	if ($comments) {
+		if ($offset)
+			$start = &quot; start='$offset'&quot;;
+		else
+			$start = '';
+
+		echo &quot;&lt;ol class='commentlist' $start&gt;&quot;;
+		$i = 0;
+		foreach ($comments as $comment) {
+		++$i; $class = '';
+		$authordata = get_userdata($wpdb-&gt;get_var(&quot;SELECT post_author FROM $wpdb-&gt;posts WHERE ID = $comment-&gt;comment_post_ID&quot;));
+			$comment_status = wp_get_comment_status($comment-&gt;comment_ID);
+			if ('unapproved' == $comment_status) 
+				$class .= ' unapproved';
+			if ($i % 2)
+				$class .= ' alternate';
+			echo &quot;&lt;li class='$class'&gt;&quot;;
+?&gt;		
+        &lt;p&gt;&lt;strong&gt;&lt;?php _e('Name:') ?&gt;&lt;/strong&gt; &lt;?php comment_author() ?&gt; &lt;?php if ($comment-&gt;comment_author_email) { ?&gt;| &lt;strong&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/strong&gt; &lt;?php comment_author_email_link() ?&gt; &lt;?php } if ($comment-&gt;comment_author_url) { ?&gt; | &lt;strong&gt;&lt;?php _e('URI:') ?&gt;&lt;/strong&gt; &lt;?php comment_author_url_link() ?&gt; &lt;?php } ?&gt;| &lt;strong&gt;&lt;?php _e('IP:') ?&gt;&lt;/strong&gt; &lt;a href=&quot;<A HREF="http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php">http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php</A> comment_author_IP() ?&gt;&quot;&gt;&lt;?php comment_author_IP() ?&gt;&lt;/a&gt;&lt;/p&gt;
+		
+		&lt;?php comment_text() ?&gt;
+
+        &lt;p&gt;&lt;?php _e('Posted'); echo ' '; comment_date('M j, g:i A');  
+			if ( user_can_edit_post_comments($user_ID, $comment-&gt;comment_post_ID) ) {
+				echo &quot; | &lt;a href=\&quot;post.php?action=editcomment&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot;&gt;&quot; . __('Edit Comment') . &quot;&lt;/a&gt;&quot;;
+			}
+			if ( user_can_delete_post_comments($user_ID, $comment-&gt;comment_post_ID) ) {
+				echo &quot; | &lt;a href=\&quot;post.php?action=deletecomment&amp;p=&quot;.$comment-&gt;comment_post_ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot; onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this comment by \'%s\'\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;), $comment-&gt;comment_author) . &quot;')\&quot;&gt;&quot; . __('Delete Comment') . &quot;&lt;/a&gt; &#8212; &quot;;
+			} // end if any comments to show
+			// Get post title
+			if ( user_can_edit_post($user_ID, $comment-&gt;comment_post_ID) ) {
+				$post_title = $wpdb-&gt;get_var(&quot;SELECT post_title FROM $wpdb-&gt;posts WHERE ID = $comment-&gt;comment_post_ID&quot;);
+				$post_title = ('' == $post_title) ? &quot;# $comment-&gt;comment_post_ID&quot; : $post_title;
+				?&gt; &lt;a href=&quot;post.php?action=edit&amp;post=&lt;?php echo $comment-&gt;comment_post_ID; ?&gt;&quot;&gt;&lt;?php printf(__('Edit Post &#8220;%s&#8221;'), stripslashes($post_title)); ?&gt;&lt;/a&gt;
+				&lt;?php } ?&gt;
+			 | &lt;a href=&quot;&lt;?php echo get_permalink($comment-&gt;comment_post_ID); ?&gt;&quot;&gt;&lt;?php _e('View Post') ?&gt;&lt;/a&gt;&lt;/p&gt;
+		&lt;/li&gt;
+
+&lt;?php } // end foreach ?&gt;
+&lt;/ol&gt;
+
+&lt;?php
+	} else {
+
+		?&gt;
+		&lt;p&gt;
+        &lt;strong&gt;&lt;?php _e('No comments found.') ?&gt;&lt;/strong&gt;&lt;/p&gt;
+		
+		&lt;?php
+	} // end if ($comments)
+} elseif ('edit' == $mode) {
+
+	if ($comments) {
+		echo '&lt;form name=&quot;deletecomments&quot; id=&quot;deletecomments&quot; action=&quot;&quot; method=&quot;post&quot;&gt; 
+		&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+  &lt;tr&gt;
+    &lt;th scope=&quot;col&quot;&gt;*&lt;/th&gt;
+    &lt;th scope=&quot;col&quot;&gt;' .  __('Name') . '&lt;/th&gt;
+    &lt;th scope=&quot;col&quot;&gt;' .  __('E-mail') . '&lt;/th&gt;
+    &lt;th scope=&quot;col&quot;&gt;' . __('IP') . '&lt;/th&gt;
+    &lt;th scope=&quot;col&quot;&gt;' . __('Comment Excerpt') . '&lt;/th&gt;
+	&lt;th scope=&quot;col&quot; colspan=&quot;3&quot;&gt;' .  __('Actions') . '&lt;/th&gt;
+  &lt;/tr&gt;';
+		foreach ($comments as $comment) {
+		$authordata = get_userdata($wpdb-&gt;get_var(&quot;SELECT post_author FROM $wpdb-&gt;posts WHERE ID = $comment-&gt;comment_post_ID&quot;));
+		$class = ('alternate' == $class) ? '' : 'alternate';
+?&gt;
+  &lt;tr class='&lt;?php echo $class; ?&gt;'&gt;
+    &lt;td&gt;&lt;?php if (user_can_delete_post_comments($user_ID, $comment-&gt;comment_post_ID) ) { ?&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete_comments[]&quot; value=&quot;&lt;?php echo $comment-&gt;comment_ID; ?&gt;&quot; /&gt;&lt;?php } ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php comment_author_link() ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php comment_author_email_link() ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;a href=&quot;<A HREF="http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php">http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php</A> comment_author_IP() ?&gt;&quot;&gt;&lt;?php comment_author_IP() ?&gt;&lt;/a&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php comment_excerpt(); ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;a href=&quot;&lt;?php echo get_permalink($comment-&gt;comment_post_ID); ?&gt;#comment-&lt;?php comment_ID() ?&gt;&quot; class=&quot;edit&quot;&gt;&lt;?php _e('View') ?&gt;&lt;/a&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php if ( user_can_edit_post_comments($user_ID, $comment-&gt;comment_post_ID) ) {
+	echo &quot;&lt;a href='post.php?action=editcomment&amp;comment=$comment-&gt;comment_ID' class='edit'&gt;&quot; .  __('Edit') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+    &lt;td&gt;&lt;?php if ( user_can_delete_post_comments($user_ID, $comment-&gt;comment_post_ID) ) {
+            echo &quot;&lt;a href=\&quot;post.php?action=deletecomment&amp;p=&quot;.$comment-&gt;comment_post_ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot; onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this comment by \'%s\'\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;), $comment-&gt;comment_author) . &quot;')\&quot;    class='delete'&gt;&quot; . __('Delete') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+  &lt;/tr&gt;
+		&lt;?php 
+		} // end foreach
+	?&gt;&lt;/table&gt;
+    &lt;p&gt;&lt;a href=&quot;javascript:;&quot; onclick=&quot;checkAll(document.getElementById('deletecomments')); return false; &quot;&gt;&lt;?php _e('Invert Checkbox Selection') ?&gt;&lt;/a&gt;&lt;/p&gt;
+            &lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Delete Checked Comments') ?&gt; &raquo;&quot; onclick=&quot;return confirm('&lt;?php _e(&quot;You are about to delete these comments permanently \\n  \'Cancel\' to stop, \'OK\' to delete.&quot;) ?&gt;')&quot; /&gt;	&lt;/p&gt;
+  &lt;/form&gt;
+&lt;?php
+	} else {
+?&gt;
+&lt;p&gt;
+&lt;strong&gt;&lt;?php _e('No results found.') ?&gt;&lt;/strong&gt;
+&lt;/p&gt;
+&lt;?php
+	} // end if ($comments)
+}
+	?&gt;
+
+&lt;/div&gt;
+
+&lt;?php include('admin-footer.php'); ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/edit-form-advanced.php
===================================================================
--- trunk/wp-admin/edit-form-advanced.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-form-advanced.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,206 @@
+&lt;?php
+$messages[1] = __('Post updated');
+$messages[2] = __('Custom field updated');
+$messages[3] = __('Custom field deleted.');
+?&gt;
+&lt;?php if (isset($_GET['message'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php echo $messages[$_GET['message']]; ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;form name=&quot;post&quot; action=&quot;post.php&quot; method=&quot;post&quot; id=&quot;post&quot;&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Write Post'); ?&gt;&lt;/h2&gt;
+&lt;?php
+
+if (0 == $post_ID) {
+	$form_action = 'post';
+} else {
+	$form_action = 'editpost';
+	$form_extra = &quot;&lt;input type='hidden' name='post_ID' value='$post_ID' /&gt;&quot;;
+}
+
+$form_pingback = '&lt;input type=&quot;hidden&quot; name=&quot;post_pingback&quot; value=&quot;' . get_option('default_pingback_flag') . '&quot; id=&quot;post_pingback&quot; /&gt;';
+
+$form_prevstatus = '&lt;input type=&quot;hidden&quot; name=&quot;prev_status&quot; value=&quot;'.$post_status.'&quot; /&gt;';
+
+$form_trackback = '&lt;input type=&quot;text&quot; name=&quot;trackback_url&quot; style=&quot;width: 415px&quot; id=&quot;trackback&quot; tabindex=&quot;7&quot; value=&quot;'. str_replace(&quot;\n&quot;, ' ', $to_ping) .'&quot; /&gt;';
+
+if ('' != $pinged) {
+	$pings .= '&lt;p&gt;'. __('Already pinged:') . '&lt;/p&gt;&lt;ul&gt;';
+	$already_pinged = explode(&quot;\n&quot;, trim($pinged));
+	foreach ($already_pinged as $pinged_url) {
+		$pings .= &quot;\n\t&lt;li&gt;$pinged_url&lt;/li&gt;&quot;;
+	}
+	$pings .= '&lt;/ul&gt;';
+}
+
+$saveasdraft = '&lt;input name=&quot;save&quot; type=&quot;submit&quot; id=&quot;save&quot; tabindex=&quot;6&quot; value=&quot;' . __('Save and Continue Editing') . '&quot; /&gt;';
+
+if (empty($post_status)) $post_status = 'draft';
+
+?&gt;
+
+&lt;input type=&quot;hidden&quot; name=&quot;user_ID&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;&lt;?php echo $form_action ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;post_author&quot; value=&quot;&lt;?php echo $post_author ?&gt;&quot; /&gt;
+
+&lt;?php echo $form_extra ?&gt;
+&lt;?php if (isset($_GET['message']) &amp;&amp; 2 &gt; $_GET['message']) : ?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+function focusit() {
+	// focus on first input field
+	document.post.title.focus();
+}
+window.onload = focusit;
+//--&gt;
+&lt;/script&gt;
+&lt;?php endif; ?&gt;
+&lt;div id=&quot;poststuff&quot;&gt;
+    &lt;fieldset id=&quot;titlediv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#title">http://wordpress.org/docs/reference/post/#title</A>&quot; title=&quot;&lt;?php _e('Help on titles') ?&gt;&quot;&gt;&lt;?php _e('Title') ?&gt;&lt;/a&gt;&lt;/legend&gt; 
+	  &lt;div&gt;&lt;input type=&quot;text&quot; name=&quot;post_title&quot; size=&quot;30&quot; tabindex=&quot;1&quot; value=&quot;&lt;?php echo $edited_post_title; ?&gt;&quot; id=&quot;title&quot; /&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+
+    &lt;fieldset id=&quot;categorydiv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#category">http://wordpress.org/docs/reference/post/#category</A>&quot; title=&quot;&lt;?php _e('Help on categories') ?&gt;&quot;&gt;&lt;?php _e('Categories') ?&gt;&lt;/a&gt;&lt;/legend&gt; 
+	  &lt;div&gt;&lt;?php dropdown_categories(get_settings('default_category')); ?&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+
+    &lt;fieldset id=&quot;commentstatusdiv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#comments">http://wordpress.org/docs/reference/post/#comments</A>&quot; title=&quot;&lt;?php _e('Help on comment status') ?&gt;&quot;&gt;&lt;?php _e('Discussion') ?&gt;&lt;/a&gt;&lt;/legend&gt; 
+	  &lt;div&gt;
+	  &lt;input name=&quot;advanced_view&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;
+	  &lt;label for=&quot;comment_status&quot; class=&quot;selectit&quot;&gt;
+	      &lt;input name=&quot;comment_status&quot; type=&quot;checkbox&quot; id=&quot;comment_status&quot; value=&quot;open&quot; &lt;?php checked($comment_status, 'open'); ?&gt; /&gt;
+         &lt;?php _e('Allow Comments') ?&gt;&lt;/label&gt; 
+		 &lt;label for=&quot;ping_status&quot; class=&quot;selectit&quot;&gt;&lt;input name=&quot;ping_status&quot; type=&quot;checkbox&quot; id=&quot;ping_status&quot; value=&quot;open&quot; &lt;?php checked($ping_status, 'open'); ?&gt; /&gt; &lt;?php _e('Allow Pings') ?&gt;&lt;/label&gt;
+&lt;/div&gt;
+&lt;/fieldset&gt;
+    &lt;fieldset id=&quot;postpassworddiv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#post_password">http://wordpress.org/docs/reference/post/#post_password</A>&quot; title=&quot;&lt;?php _e('Help on post password') ?&gt;&quot;&gt;&lt;?php _e('Post Password') ?&gt;&lt;/a&gt;&lt;/legend&gt; 
+	  &lt;div&gt;&lt;input name=&quot;post_password&quot; type=&quot;text&quot; size=&quot;13&quot; id=&quot;post_password&quot; value=&quot;&lt;?php echo $post_password ?&gt;&quot; /&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+
+&lt;br /&gt;
+&lt;fieldset id=&quot;postexcerpt&quot;&gt;
+&lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#excerpt">http://wordpress.org/docs/reference/post/#excerpt</A>&quot; title=&quot;&lt;?php _e('Help with excerpts') ?&gt;&quot;&gt;&lt;?php _e('Excerpt') ?&gt;&lt;/a&gt;&lt;/legend&gt;
+&lt;div&gt;&lt;textarea rows=&quot;1&quot; cols=&quot;40&quot; name=&quot;excerpt&quot; tabindex=&quot;4&quot; id=&quot;excerpt&quot;&gt;&lt;?php echo $excerpt ?&gt;&lt;/textarea&gt;&lt;/div&gt;
+&lt;/fieldset&gt;
+&lt;fieldset id=&quot;postdiv&quot;&gt;
+       &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#post">http://wordpress.org/docs/reference/post/#post</A>&quot; title=&quot;&lt;?php _e('Help with post field') ?&gt;&quot;&gt;&lt;?php _e('Post') ?&gt;&lt;/a&gt;&lt;/legend&gt;
+ 
+&lt;?php
+ $rows = get_settings('default_post_edit_rows');
+ if (($rows &lt; 3) || ($rows &gt; 100)) {
+     $rows = 10;
+ }
+?&gt;
+&lt;div&gt;&lt;textarea cols=&quot;40&quot; name=&quot;content&quot; tabindex=&quot;5&quot; id=&quot;content&quot;&gt;&lt;?php echo $content ?&gt;&lt;/textarea&gt;&lt;/div&gt;
+&lt;/fieldset&gt;
+&lt;?php
+?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+edCanvas = document.getElementById('content');
+//--&gt;
+&lt;/script&gt;
+
+&lt;?php echo $form_pingback ?&gt;
+&lt;?php echo $form_prevstatus ?&gt;
+
+
+&lt;p class=&quot;submit&quot;&gt;&lt;?php echo $saveasdraft; ?&gt; &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Save') ?&gt;&quot; style=&quot;font-weight: bold;&quot; tabindex=&quot;6&quot; /&gt; 
+&lt;?php 
+if ('publish' != $post_status || 0 == $post_ID) {
+?&gt;
+&lt;?php if ( user_can_create_post($user_ID) ) : ?&gt;
+	&lt;input name=&quot;publish&quot; type=&quot;submit&quot; id=&quot;publish&quot; tabindex=&quot;10&quot; value=&quot;&lt;?php _e('Publish') ?&gt;&quot; /&gt; 
+&lt;?php endif; ?&gt;
+&lt;?php
+}
+?&gt;
+	&lt;input name=&quot;referredby&quot; type=&quot;hidden&quot; id=&quot;referredby&quot; value=&quot;&lt;?php echo wp_specialchars($_SERVER['HTTP_REFERER']); ?&gt;&quot; /&gt;
+&lt;/p&gt;
+
+&lt;?php do_action('edit_form_advanced', ''); ?&gt;
+&lt;/div&gt;
+
+&lt;/div&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Advanced'); ?&gt;&lt;/h2&gt;
+
+&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot; valign=&quot;top&quot;&gt;&lt;?php _e('Post Status') ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;?php if ( user_can_create_post($user_ID) ) : ?&gt;
+&lt;label for=&quot;post_status_publish&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;post_status_publish&quot; name=&quot;post_status&quot; type=&quot;radio&quot; value=&quot;publish&quot; &lt;?php checked($post_status, 'publish'); ?&gt; /&gt; &lt;?php _e('Published') ?&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;?php endif; ?&gt;
+	  &lt;label for=&quot;post_status_draft&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;post_status_draft&quot; name=&quot;post_status&quot; type=&quot;radio&quot; value=&quot;draft&quot; &lt;?php checked($post_status, 'draft'); ?&gt; /&gt; &lt;?php _e('Draft') ?&gt;&lt;/label&gt;&lt;br /&gt;
+	  &lt;label for=&quot;post_status_private&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;post_status_private&quot; name=&quot;post_status&quot; type=&quot;radio&quot; value=&quot;private&quot; &lt;?php checked($post_status, 'private'); ?&gt; /&gt; &lt;?php _e('Private') ?&gt;&lt;/label&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot; valign=&quot;top&quot;&gt;&lt;?php _e('Send trackbacks to'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;?php echo $form_trackback; ?&gt; &lt;br /&gt;
+		&lt;?php _e('Separate multiple URIs with spaces'); ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr valign=&quot;top&quot;&gt;
+		&lt;th scope=&quot;row&quot; width=&quot;25%&quot;&gt;&lt;?php _e('Post slug') ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;input name=&quot;post_name&quot; type=&quot;text&quot; size=&quot;25&quot; id=&quot;post_name&quot; value=&quot;&lt;?php echo $post_name ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php if ($user_level &gt; 7 &amp;&amp; $users = $wpdb-&gt;get_results(&quot;SELECT ID, user_login, user_firstname, user_lastname FROM $wpdb-&gt;users WHERE user_level &lt;= $user_level AND user_level &gt; 0&quot;) ) : ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Post author'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;
+		&lt;select name=&quot;post_author_override&quot; id=&quot;post_author_override&quot;&gt;
+		&lt;?php 
+		foreach ($users as $o) :
+			if ( $post_author == $o-&gt;ID || ( empty($post_ID) &amp;&amp; $user_ID == $o-&gt;ID ) ) $selected = 'selected=&quot;selected&quot;';
+			else $selected = '';
+			echo &quot;&lt;option value='$o-&gt;ID' $selected&gt;$o-&gt;user_login ($o-&gt;user_firstname $o-&gt;user_lastname)&lt;/option&gt;&quot;;
+		endforeach;
+		?&gt;
+		&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php endif; ?&gt;
+&lt;?php if ($user_level &gt; 4) : ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Edit time'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;?php touch_time(($action == 'edit')); ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php endif; ?&gt;
+&lt;?php if ('edit' == $action) : ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Delete'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;
+		&lt;input name=&quot;deletepost&quot; class=&quot;button&quot; type=&quot;submit&quot; id=&quot;deletepost&quot; tabindex=&quot;10&quot; value=&quot;&lt;?php _e('Delete this post') ?&gt;&quot; &lt;?php echo &quot;onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this post \'%s\'\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;), addslashes($edited_post_title) ) . &quot;')\&quot;&quot;; ?&gt; /&gt;
+&lt;/td&gt;
+&lt;?php endif; ?&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;fieldset id=&quot;postcustom&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Custom Fields') ?&gt;&lt;/legend&gt;
+&lt;div id=&quot;postcustomstuff&quot;&gt;
+&lt;?php 
+if($metadata = has_meta($post_ID)) {
+?&gt;
+&lt;?php
+	list_meta($metadata); 
+?&gt;
+&lt;?php
+}
+	meta_form();
+?&gt;
+&lt;/div&gt;
+&lt;/fieldset&gt;
+&lt;?php 
+if ('' != $pinged)
+	echo $pings;
+?&gt;
+&lt;/div&gt;
+
+&lt;/form&gt;
\ No newline at end of file

Added: trunk/wp-admin/edit-form-comment.php
===================================================================
--- trunk/wp-admin/edit-form-comment.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-form-comment.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,89 @@
+&lt;?php
+$submitbutton_text = __('Edit Comment &raquo;');
+$toprow_title = sprintf(__('Editing Comment # %s'), $commentdata['comment_ID']);
+$form_action = 'editedcomment';
+$form_extra = &quot;' /&gt;\n&lt;input type='hidden' name='comment_ID' value='$comment' /&gt;\n&lt;input type='hidden' name='comment_post_ID' value='&quot;.$commentdata[&quot;comment_post_ID&quot;];
+?&gt;
+
+&lt;form name=&quot;post&quot; action=&quot;post.php&quot; method=&quot;post&quot; id=&quot;post&quot;&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;user_ID&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value='&lt;?php echo $form_action . $form_extra ?&gt;' /&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+function focusit() {
+	// focus on first input field
+	document.post.name.focus();
+}
+window.onload = focusit;
+&lt;/script&gt;
+&lt;fieldset id=&quot;namediv&quot;&gt;
+    &lt;legend&gt;&lt;?php _e('Name:') ?&gt;&lt;/legend&gt;
+	&lt;div&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;newcomment_author&quot; size=&quot;22&quot; value=&quot;&lt;?php echo format_to_edit($commentdata['comment_author']) ?&gt;&quot; tabindex=&quot;1&quot; id=&quot;name&quot; /&gt;
+    &lt;/div&gt;
+&lt;/fieldset&gt;
+&lt;fieldset id=&quot;emaildiv&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/legend&gt;
+		&lt;div&gt;
+		  &lt;input type=&quot;text&quot; name=&quot;newcomment_author_email&quot; size=&quot;30&quot; value=&quot;&lt;?php echo format_to_edit($commentdata['comment_author_email']) ?&gt;&quot; tabindex=&quot;2&quot; id=&quot;email&quot; /&gt;
+    &lt;/div&gt;
+&lt;/fieldset&gt;
+&lt;fieldset id=&quot;uridiv&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('URI:') ?&gt;&lt;/legend&gt;
+		&lt;div&gt;
+		  &lt;input type=&quot;text&quot; name=&quot;newcomment_author_url&quot; size=&quot;35&quot; value=&quot;&lt;?php echo format_to_edit($commentdata['comment_author_url']) ?&gt;&quot; tabindex=&quot;3&quot; id=&quot;URL&quot; /&gt;
+    &lt;/div&gt;
+&lt;/fieldset&gt;
+
+&lt;fieldset style=&quot;clear: both;&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('Comment') ?&gt;&lt;/legend&gt;
+
+&lt;?php
+ $rows = get_settings('default_post_edit_rows');
+ if (($rows &lt; 3) || ($rows &gt; 100)) {
+     $rows = 10;
+ }
+?&gt;
+&lt;div&gt;&lt;textarea name=&quot;content&quot; tabindex=&quot;4&quot; id=&quot;content&quot; style=&quot;width: 99%&quot;&gt;&lt;?php echo $content ?&gt;&lt;/textarea&gt;&lt;/div&gt;
+&lt;/fieldset&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+edCanvas = document.getElementById('content');
+//--&gt;
+&lt;/script&gt;
+
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;editcomment&quot; id=&quot;editcomment&quot; value=&quot;&lt;?php echo $submitbutton_text ?&gt;&quot; style=&quot;font-weight: bold;&quot; tabindex=&quot;6&quot; /&gt;
+  &lt;input name=&quot;referredby&quot; type=&quot;hidden&quot; id=&quot;referredby&quot; value=&quot;&lt;?php echo $_SERVER['HTTP_REFERER']; ?&gt;&quot; /&gt;
+&lt;/p&gt;
+
+&lt;/div&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Advanced'); ?&gt;&lt;/h2&gt;
+
+&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot; valign=&quot;top&quot;&gt;&lt;?php _e('Comment Status') ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;label for=&quot;comment_status_approved&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;comment_status_approved&quot; name=&quot;comment_status&quot; type=&quot;radio&quot; value=&quot;1&quot; &lt;?php checked($comment_status, '1'); ?&gt; /&gt; &lt;?php _e('Approved') ?&gt;&lt;/label&gt;&lt;br /&gt;
+	  &lt;label for=&quot;comment_status_moderated&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;comment_status_moderated&quot; name=&quot;comment_status&quot; type=&quot;radio&quot; value=&quot;0&quot; &lt;?php checked($comment_status, '0'); ?&gt; /&gt; &lt;?php _e('Moderated') ?&gt;&lt;/label&gt;&lt;br /&gt;
+	  &lt;label for=&quot;comment_status_spam&quot; class=&quot;selectit&quot;&gt;&lt;input id=&quot;comment_status_spam&quot; name=&quot;comment_status&quot; type=&quot;radio&quot; value=&quot;spam&quot; &lt;?php checked($comment_status, 'spam'); ?&gt; /&gt; &lt;?php _e('Spam') ?&gt;&lt;/label&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+
+&lt;?php if ($user_level &gt; 4) : ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Edit time'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;?php touch_time(('editcomment' == $action), 0); ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php endif; ?&gt;
+
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Delete'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;p&gt;&lt;a class=&quot;delete&quot; href=&quot;post.php?action=confirmdeletecomment&amp;noredir=true&amp;comment=&lt;?php echo $commentdata['comment_ID']; ?&gt;&amp;p=&lt;?php echo $commentdata['comment_post_ID']; ?&gt;&quot;&gt;&lt;?php _e('Delete comment') ?&gt;&lt;/a&gt;&lt;/p&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;/form&gt;

Added: trunk/wp-admin/edit-form.php
===================================================================
--- trunk/wp-admin/edit-form.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-form.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,73 @@
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Write Post'); ?&gt;&lt;/h2&gt;
+&lt;form name=&quot;post&quot; action=&quot;post.php&quot; method=&quot;post&quot; id=&quot;simple&quot;&gt;
+
+&lt;input type=&quot;hidden&quot; name=&quot;user_ID&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value='post' /&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+function focusit() {
+	// focus on first input field
+	document.getElementById('title').focus();
+}
+window.onload = focusit;
+//--&gt;
+&lt;/script&gt;
+
+&lt;div id=&quot;poststuff&quot;&gt;
+    &lt;fieldset id=&quot;titlediv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#title">http://wordpress.org/docs/reference/post/#title</A>&quot; title=&quot;&lt;?php _e('Help on titles') ?&gt;&quot;&gt;&lt;?php _e('Title') ?&gt;&lt;/a&gt;&lt;/legend&gt;
+	  &lt;div&gt;&lt;input type=&quot;text&quot; name=&quot;post_title&quot; size=&quot;30&quot; tabindex=&quot;1&quot; value=&quot;&lt;?php echo $edited_post_title; ?&gt;&quot; id=&quot;title&quot; /&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+
+    &lt;fieldset id=&quot;categorydiv&quot;&gt;
+      &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#category">http://wordpress.org/docs/reference/post/#category</A>&quot; title=&quot;&lt;?php _e('Help on categories') ?&gt;&quot;&gt;&lt;?php _e('Categories') ?&gt;&lt;/a&gt;&lt;/legend&gt;
+	  &lt;div&gt;&lt;?php dropdown_categories($default_post_cat); ?&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+
+&lt;br /&gt;
+&lt;fieldset id=&quot;postdiv&quot;&gt;
+    &lt;legend&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/docs/reference/post/#post">http://wordpress.org/docs/reference/post/#post</A>&quot; title=&quot;&lt;?php _e('Help with post field') ?&gt;&quot;&gt;&lt;?php _e('Post') ?&gt;&lt;/a&gt;&lt;/legend&gt;
+
+&lt;?php
+ $rows = get_settings('default_post_edit_rows');
+ if (($rows &lt; 3) || ($rows &gt; 100)) {
+     $rows = 10;
+ }
+?&gt;
+&lt;div&gt;&lt;textarea name=&quot;content&quot; tabindex=&quot;4&quot; id=&quot;content&quot;&gt;&lt;?php echo $content ?&gt;&lt;/textarea&gt;&lt;/div&gt;
+&lt;/fieldset&gt;
+
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+edCanvas = document.getElementById('content');
+//--&gt;
+&lt;/script&gt;
+
+&lt;input type=&quot;hidden&quot; name=&quot;post_pingback&quot; value=&quot;&lt;?php echo get_option('default_pingback_flag') ?&gt;&quot; id=&quot;post_pingback&quot; /&gt;
+
+&lt;p&gt;&lt;label for=&quot;trackback&quot;&gt; &lt;?php printf(__('&lt;a href=&quot;%s&quot; title=&quot;Help on trackbacks&quot;&gt;&lt;strong&gt;TrackBack&lt;/strong&gt; a &lt;abbr title=&quot;Universal Resource Identifier&quot;&gt;URI&lt;/abbr&gt;&lt;/a&gt;:&lt;/label&gt; (Separate multiple &lt;abbr title=&quot;Universal Resource Identifier&quot;&gt;URI&lt;/abbr&gt;s with spaces.)&lt;br /&gt;'), '<A HREF="http://wordpress.org/docs/reference/post/#trackback">http://wordpress.org/docs/reference/post/#trackback</A>') ?&gt;
+	&lt;input type=&quot;text&quot; name=&quot;trackback_url&quot; style=&quot;width: 360px&quot; id=&quot;trackback&quot; tabindex=&quot;7&quot; /&gt;&lt;/p&gt;
+
+&lt;p class=&quot;submit&quot;&gt;&lt;input name=&quot;saveasdraft&quot; type=&quot;submit&quot; id=&quot;saveasdraft&quot; tabindex=&quot;9&quot; value=&quot;&lt;?php _e('Save as Draft') ?&gt;&quot; /&gt;
+  &lt;input name=&quot;saveasprivate&quot; type=&quot;submit&quot; id=&quot;saveasprivate&quot; tabindex=&quot;10&quot; value=&quot;&lt;?php _e('Save as Private') ?&gt;&quot; /&gt;
+
+	 &lt;?php if ( user_can_create_post($user_ID) ) : ?&gt;
+  &lt;input name=&quot;publish&quot; type=&quot;submit&quot; id=&quot;publish&quot; tabindex=&quot;6&quot; style=&quot;font-weight: bold;&quot; value=&quot;&lt;?php _e('Publish') ?&gt;&quot; /&gt;
+&lt;?php endif; ?&gt;
+
+&lt;?php if ('bookmarklet' != $mode) {
+      echo '&lt;input name=&quot;advanced&quot; type=&quot;submit&quot; id=&quot;advancededit&quot; tabindex=&quot;7&quot; value=&quot;' .  __('Advanced Editing &raquo;') . '&quot; /&gt;';
+  } ?&gt;
+  &lt;input name=&quot;referredby&quot; type=&quot;hidden&quot; id=&quot;referredby&quot; value=&quot;&lt;?php if (isset($_SERVER['HTTP_REFERER'])) echo urlencode($_SERVER['HTTP_REFERER']); ?&gt;&quot; /&gt;
+&lt;/p&gt;
+
+&lt;?php do_action('simple_edit_form', ''); ?&gt;
+
+&lt;/div&gt;
+&lt;/form&gt;
+
+&lt;/div&gt;

Added: trunk/wp-admin/edit-page-form.php
===================================================================
--- trunk/wp-admin/edit-page-form.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-page-form.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,159 @@
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Write Page'); ?&gt;&lt;/h2&gt;
+&lt;?php
+if (0 == $post_ID) {
+	$form_action = 'post';
+	$form_extra = '';
+} else {
+	$form_action = 'editpost';
+	$form_extra = &quot;&lt;input type='hidden' name='post_ID' value='$post_ID' /&gt;&quot;;
+}
+
+$sendto = $_SERVER['HTTP_REFERER'];
+
+if ( 0 != $post_ID &amp;&amp; $sendto == get_permalink($post_ID) )
+ 	$sendto = 'redo';
+$sendto = wp_specialchars( $sendto );
+
+?&gt;
+
+&lt;form name=&quot;post&quot; action=&quot;post.php&quot; method=&quot;post&quot; id=&quot;post&quot;&gt;
+
+&lt;input type=&quot;hidden&quot; name=&quot;user_ID&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value='&lt;?php echo $form_action ?&gt;' /&gt;
+&lt;?php echo $form_extra ?&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;post_status&quot; value=&quot;static&quot; /&gt;
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+function focusit() {
+	// focus on first input field
+	document.post.title.focus();
+}
+window.onload = focusit;
+//--&gt;
+&lt;/script&gt;
+    &lt;fieldset id=&quot;titlediv&quot;&gt;
+      &lt;legend&gt;&lt;?php _e('Page Title') ?&gt;&lt;/legend&gt;
+ 	  &lt;div&gt;&lt;input type=&quot;text&quot; name=&quot;post_title&quot; size=&quot;30&quot; tabindex=&quot;1&quot; value=&quot;&lt;?php echo $edited_post_title; ?&gt;&quot; id=&quot;title&quot; /&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+&lt;fieldset id=&quot;commentstatusdiv&quot;&gt;
+      &lt;legend&gt;&lt;?php _e('Discussion') ?&gt;&lt;/legend&gt;
+	  &lt;div&gt;
+	  &lt;input name=&quot;advanced_view&quot; type=&quot;hidden&quot; value=&quot;1&quot; /&gt;
+	  &lt;label for=&quot;comment_status&quot; class=&quot;selectit&quot;&gt;
+	      &lt;input name=&quot;comment_status&quot; type=&quot;checkbox&quot; id=&quot;comment_status&quot; value=&quot;open&quot; &lt;?php checked($comment_status, 'open'); ?&gt; /&gt;
+         &lt;?php _e('Allow Comments') ?&gt;&lt;/label&gt;
+		 &lt;label for=&quot;ping_status&quot; class=&quot;selectit&quot;&gt;&lt;input name=&quot;ping_status&quot; type=&quot;checkbox&quot; id=&quot;ping_status&quot; value=&quot;open&quot; &lt;?php checked($ping_status, 'open'); ?&gt; /&gt; &lt;?php _e('Allow Pings') ?&gt;&lt;/label&gt;
+	&lt;/div&gt;
+&lt;/fieldset&gt;
+    &lt;fieldset id=&quot;postpassworddiv&quot;&gt;
+      &lt;legend&gt;&lt;?php _e('Page Password') ?&gt;&lt;/legend&gt;
+	  &lt;div&gt;&lt;input name=&quot;post_password&quot; type=&quot;text&quot; size=&quot;13&quot; id=&quot;post_password&quot; value=&quot;&lt;?php echo $post_password ?&gt;&quot; /&gt;&lt;/div&gt;
+    &lt;/fieldset&gt;
+    &lt;fieldset id=&quot;pageparent&quot;&gt;
+      &lt;legend&gt;&lt;?php _e('Page Parent') ?&gt;&lt;/legend&gt;
+	  &lt;div&gt;&lt;select name=&quot;parent_id&quot;&gt;
+	  &lt;option value='0'&gt;&lt;?php _e('Main Page (no parent)'); ?&gt;&lt;/option&gt;
+			&lt;?php parent_dropdown($post_parent); ?&gt;
+        &lt;/select&gt;
+	  &lt;/div&gt;
+    &lt;/fieldset&gt;
+&lt;fieldset id=&quot;postdiv&quot;&gt;
+    &lt;legend&gt;&lt;?php _e('Page Content') ?&gt;&lt;/legend&gt;
+
+&lt;?php
+ $rows = get_settings('default_post_edit_rows');
+ if (($rows &lt; 3) || ($rows &gt; 100)) {
+     $rows = 10;
+ }
+?&gt;
+&lt;div&gt;&lt;textarea name=&quot;content&quot; tabindex=&quot;4&quot; id=&quot;content&quot;&gt;&lt;?php echo $content ?&gt;&lt;/textarea&gt;&lt;/div&gt;
+&lt;/fieldset&gt;
+
+
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+edCanvas = document.getElementById('content');
+//--&gt;
+&lt;/script&gt;
+
+&lt;p class=&quot;submit&quot;&gt;
+&lt;?php if ( $post_ID ) : ?&gt;
+&lt;input name=&quot;save&quot; type=&quot;submit&quot; id=&quot;save&quot; tabindex=&quot;5&quot; value=&quot; &lt;?php _e('Save and Continue Editing'); ?&gt; &quot;/&gt;
+&lt;input name=&quot;savepage&quot; type=&quot;submit&quot; id=&quot;savepage&quot; tabindex=&quot;6&quot; value=&quot;&lt;?php $post_ID ? _e('Edit Page') : _e('Create New Page') ?&gt; &raquo;&quot; /&gt;
+&lt;?php else : ?&gt;
+&lt;input name=&quot;savepage&quot; type=&quot;submit&quot; id=&quot;savepage&quot; tabindex=&quot;6&quot; value=&quot;&lt;?php _e('Create New Page') ?&gt; &raquo;&quot; /&gt;
+&lt;?php endif; ?&gt;
+&lt;input name=&quot;referredby&quot; type=&quot;hidden&quot; id=&quot;referredby&quot; value=&quot;&lt;?php echo $sendto; ?&gt;&quot; /&gt;
+&lt;/p&gt;
+
+&lt;fieldset id=&quot;pageoptions&quot;&gt;
+	 &lt;legend&gt;&lt;?php _e('Page Options') ?&gt;&lt;/legend&gt;
+&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt;
+&lt;?php if ( 0 != count( get_page_templates() ) ) { ?&gt;
+	&lt;tr valign=&quot;top&quot;&gt;
+		&lt;th scope=&quot;row&quot; width=&quot;30%&quot;&gt;&lt;?php _e('Page Template:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;div&gt;&lt;select name=&quot;page_template&quot;&gt;
+		&lt;option value='default'&gt;&lt;?php _e('Default Template'); ?&gt;&lt;/option&gt;
+		&lt;?php page_template_dropdown($page_template); ?&gt;
+		&lt;/select&gt;
+
+		&lt;/div&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php } ?&gt;
+	&lt;tr valign=&quot;top&quot;&gt;
+		&lt;th scope=&quot;row&quot; width=&quot;30%&quot;&gt;&lt;?php _e('Page slug') ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;input name=&quot;post_name&quot; type=&quot;text&quot; size=&quot;25&quot; id=&quot;post_name&quot; value=&quot;&lt;?php echo $post_name ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php if ($user_level &gt; 7 &amp;&amp; $users = $wpdb-&gt;get_results(&quot;SELECT ID, user_login, user_firstname, user_lastname FROM $wpdb-&gt;users WHERE user_level &lt;= $user_level AND user_level &gt; 0&quot;) ) : ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot; width=&quot;30%&quot;&gt;&lt;?php _e('Page owner'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;
+		&lt;select name=&quot;post_author&quot; id=&quot;post_author&quot;&gt;
+		&lt;?php
+		foreach ($users as $o) :
+			if ( $post_author == $o-&gt;ID ) $selected = 'selected=&quot;selected&quot;';
+			else $selected = '';
+			echo &quot;&lt;option value='$o-&gt;ID' $selected&gt;$o-&gt;user_login ($o-&gt;user_firstname $o-&gt;user_lastname)&lt;/option&gt;&quot;;
+		endforeach;
+		?&gt;
+		&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php endif; ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot; width=&quot;25%&quot;&gt;&lt;?php _e('Page Order') ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;input name=&quot;menu_order&quot; type=&quot;text&quot; size=&quot;4&quot; id=&quot;menu_order&quot; value=&quot;&lt;?php echo $menu_order ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Delete'); ?&gt;:&lt;/th&gt;
+		&lt;td&gt;&lt;?php if ('edit' == $action) : ?&gt;
+		&lt;input name=&quot;deletepost&quot; class=&quot;delete&quot; type=&quot;submit&quot; id=&quot;deletepost&quot; tabindex=&quot;10&quot; value=&quot;&lt;?php _e('Delete this page') ?&gt;&quot; &lt;?php echo &quot;onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this page \'%s\'\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;), addslashes($edited_post_title) ) . &quot;')\&quot;&quot;; ?&gt; /&gt;
+&lt;?php endif; ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+
+&lt;fieldset id=&quot;postcustom&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Custom Fields') ?&gt; &lt;script type=&quot;text/javascript&quot;&gt;customToggleLink();&lt;/script&gt;&lt;/legend&gt;
+&lt;div id=&quot;postcustomstuff&quot;&gt;
+&lt;?php
+if($metadata = has_meta($post_ID)) {
+?&gt;
+&lt;?php
+	list_meta($metadata);
+?&gt;
+&lt;?php
+}
+	meta_form();
+?&gt;
+&lt;/div&gt;
+&lt;/fieldset&gt;
+
+&lt;?php do_action('edit_page_form', ''); ?&gt;
+&lt;/form&gt;
+
+&lt;/div&gt;

Added: trunk/wp-admin/edit-pages.php
===================================================================
--- trunk/wp-admin/edit-pages.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit-pages.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,51 @@
+&lt;?php
+require_once('admin.php');
+$title = __('Pages');
+$parent_file = 'edit.php';
+require_once('admin-header.php');
+
+get_currentuserinfo();
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Page Management'); ?&gt;&lt;/h2&gt;
+
+&lt;?php
+if (isset($user_ID) &amp;&amp; ('' != intval($user_ID))) {
+	$posts = $wpdb-&gt;get_results(&quot;
+	SELECT $wpdb-&gt;posts.*, $wpdb-&gt;users.user_level FROM $wpdb-&gt;posts
+	INNER JOIN $wpdb-&gt;users ON ($wpdb-&gt;posts.post_author = $wpdb-&gt;users.ID)
+	WHERE $wpdb-&gt;posts.post_status = 'static'
+	AND ($wpdb-&gt;users.user_level &lt; $user_level OR $wpdb-&gt;posts.post_author = $user_ID)
+	&quot;);
+} else {
+    $posts = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;posts WHERE post_status = 'static'&quot;);
+}
+
+if ($posts) {
+?&gt;
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt; 
+  &lt;tr&gt; 
+    &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('ID') ?&gt;&lt;/th&gt; 
+    &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('Title') ?&gt;&lt;/th&gt; 
+    &lt;th scope=&quot;col&quot;&gt;&lt;?php _e('Owner') ?&gt;&lt;/th&gt;
+	&lt;th scope=&quot;col&quot;&gt;&lt;?php _e('Updated') ?&gt;&lt;/th&gt;
+	&lt;th scope=&quot;col&quot;&gt;&lt;/th&gt; 
+    &lt;th scope=&quot;col&quot;&gt;&lt;/th&gt; 
+    &lt;th scope=&quot;col&quot;&gt;&lt;/th&gt; 
+  &lt;/tr&gt; 
+&lt;?php page_rows(); ?&gt;
+&lt;/table&gt; 
+&lt;?php
+} else {
+?&gt;
+&lt;p&gt;&lt;?php _e('No pages yet.') ?&gt;&lt;/p&gt;
+&lt;?php
+} // end if ($posts)
+?&gt; 
+&lt;p&gt;&lt;?php _e('Pages are like posts except they live outside of the normal blog chronology. You can use pages to organize and manage any amount of content.'); ?&gt;&lt;/p&gt;
+&lt;h3&gt;&lt;a href=&quot;page-new.php&quot;&gt;&lt;?php _e('Create New Page'); ?&gt; &raquo;&lt;/a&gt;&lt;/h3&gt;
+&lt;/div&gt; 
+
+
+&lt;?php include('admin-footer.php'); ?&gt; 

Added: trunk/wp-admin/edit.php
===================================================================
--- trunk/wp-admin/edit.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/edit.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,301 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Posts');
+$parent_file = 'edit.php';
+require_once('admin-header.php');
+
+$_GET['m'] = (int) $_GET['m'];
+
+get_currentuserinfo();
+
+$drafts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts WHERE post_status = 'draft' AND post_author = $user_ID&quot;);
+if (1 &lt; $user_level) {
+	$editable = $wpdb-&gt;get_col(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_level &lt;= '$user_level' AND ID != $user_ID&quot;);
+	if( is_array( $editable ) == false )
+			$other_drafts = '';
+	else {
+		$editable = join(',', $editable);
+		$other_drafts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts WHERE post_status = 'draft' AND post_author IN ($editable) &quot;);
+	}
+} else {
+	$other_drafts = false;
+}
+
+if ($drafts || $other_drafts) {
+?&gt; 
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;?php if ($drafts) { ?&gt;
+    &lt;p&gt;&lt;strong&gt;&lt;?php _e('Your Drafts:') ?&gt;&lt;/strong&gt; 
+    &lt;?php
+	$i = 0;
+	foreach ($drafts as $draft) {
+		if (0 != $i)
+			echo ', ';
+		$draft-&gt;post_title = stripslashes($draft-&gt;post_title);
+		if ($draft-&gt;post_title == '')
+			$draft-&gt;post_title = sprintf(__('Post #%s'), $draft-&gt;ID);
+		echo &quot;&lt;a href='post.php?action=edit&amp;post=$draft-&gt;ID' title='&quot; . __('Edit this draft') . &quot;'&gt;$draft-&gt;post_title&lt;/a&gt;&quot;;
+		++$i;
+		}
+	?&gt; 
+    .&lt;/p&gt; 
+&lt;?php } ?&gt;
+
+&lt;?php if ($other_drafts) { ?&gt; 
+    &lt;p&gt;&lt;strong&gt;&lt;?php _e('Other&#8217;s Drafts:') ?&gt;&lt;/strong&gt; 
+    &lt;?php
+	$i = 0;
+	foreach ($other_drafts as $draft) {
+		if (0 != $i)
+			echo ', ';
+		$draft-&gt;post_title = stripslashes($draft-&gt;post_title);
+		if ($draft-&gt;post_title == '')
+			$draft-&gt;post_title = sprintf(__('Post #%s'), $draft-&gt;ID);
+		echo &quot;&lt;a href='post.php?action=edit&amp;post=$draft-&gt;ID' title='&quot; . __('Edit this draft') . &quot;'&gt;$draft-&gt;post_title&lt;/a&gt;&quot;;
+		++$i;
+		}
+	?&gt; 
+    .&lt;/p&gt; 
+
+&lt;?php } ?&gt;
+
+&lt;/div&gt;
+&lt;?php } ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;
+&lt;?php
+$what_to_show = 'posts';
+$posts_per_page = 15;
+$posts_per_archive_page = -1;
+
+include(ABSPATH.'wp-blog-header.php');
+
+if ( is_month() ) {
+	single_month_title(' ');
+} elseif ( is_search() ) {
+	printf(__('Search for &#8220;%s&#8221;'), wp_specialchars($_GET['s']) );
+} else {
+	if ( ! is_paged() || get_query_var('paged') == 1 )
+		_e('Last 15 Posts');
+	else
+		_e('Previous Posts');
+}
+?&gt;
+&lt;/h2&gt;
+
+&lt;form name=&quot;searchform&quot; action=&quot;&quot; method=&quot;get&quot; style=&quot;float: left; width: 16em; margin-right: 3em;&quot;&gt; 
+  &lt;fieldset&gt; 
+  &lt;legend&gt;&lt;?php _e('Search Posts&hellip;') ?&gt;&lt;/legend&gt; 
+  &lt;input type=&quot;text&quot; name=&quot;s&quot; value=&quot;&lt;?php if (isset($s)) echo wp_specialchars($s, 1); ?&gt;&quot; size=&quot;17&quot; /&gt; 
+  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Search') ?&gt;&quot;  /&gt; 
+  &lt;/fieldset&gt;
+&lt;/form&gt;
+
+&lt;form name=&quot;viewarc&quot; action=&quot;&quot; method=&quot;get&quot; style=&quot;float: left; width: 20em; margin-bottom: 1em;&quot;&gt;
+	&lt;fieldset&gt;
+	&lt;legend&gt;&lt;?php _e('Browse Month&hellip;') ?&gt;&lt;/legend&gt;
+    &lt;select name='m'&gt;
+	&lt;?php
+		$arc_result=$wpdb-&gt;get_results(&quot;SELECT DISTINCT YEAR(post_date) AS yyear, MONTH(post_date) AS mmonth FROM $wpdb-&gt;posts ORDER BY post_date DESC&quot;);
+		foreach ($arc_result as $arc_row) {			
+			$arc_year  = $arc_row-&gt;yyear;
+			$arc_month = $arc_row-&gt;mmonth;
+			
+			if( isset($_GET['m']) &amp;&amp; $arc_year . zeroise($arc_month, 2) == (int) $_GET['m'] )
+				$default = 'selected=&quot;selected&quot;';
+			else
+				$default = null;
+			
+			echo &quot;&lt;option $default value=\&quot;&quot; . $arc_year.zeroise($arc_month, 2) . '&quot;&gt;';
+			echo $month[zeroise($arc_month, 2)] . &quot; $arc_year&quot;;
+			echo &quot;&lt;/option&gt;\n&quot;;
+		}
+	?&gt;
+	&lt;/select&gt;
+		&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Show Month') ?&gt;&quot;  /&gt; 
+	&lt;/fieldset&gt;
+&lt;/form&gt;
+
+&lt;br style=&quot;clear:both;&quot; /&gt;
+
+&lt;?php
+
+// define the columns to display, the syntax is 'internal name' =&gt; 'display name'
+$posts_columns = array(
+  'id'         =&gt; __('ID'),
+  'date'       =&gt; __('When'),
+  'title'      =&gt; __('Title'),
+  'categories' =&gt; __('Categories'),
+  'comments'   =&gt; __('Comments'),
+  'author'     =&gt; __('Author')
+);
+$posts_columns = apply_filters('manage_posts_columns', $posts_columns);
+
+// you can not edit these at the moment
+$posts_columns['control_view']   = '';
+$posts_columns['control_edit']   = '';
+$posts_columns['control_delete'] = '';
+
+?&gt;
+
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt; 
+	&lt;tr&gt;
+
+&lt;?php foreach($posts_columns as $column_display_name) { ?&gt;
+	&lt;th scope=&quot;col&quot;&gt;&lt;?php echo $column_display_name; ?&gt;&lt;/th&gt;
+&lt;?php } ?&gt;
+
+	&lt;/tr&gt;
+&lt;?php
+if ($posts) {
+$bgcolor = '';
+foreach ($posts as $post) { start_wp();
+$class = ('alternate' == $class) ? '' : 'alternate';
+?&gt; 
+	&lt;tr class='&lt;?php echo $class; ?&gt;'&gt;
+
+&lt;?php
+
+foreach($posts_columns as $column_name=&gt;$column_display_name) {
+
+	switch($column_name) {
+	
+	case 'id':
+		?&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php echo $id ?&gt;&lt;/th&gt;
+		&lt;?php
+		break;
+
+	case 'date':
+		?&gt;
+		&lt;td&gt;&lt;?php the_time('Y-m-d \&lt;\b\r \/\&gt; g:i:s a'); ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+	case 'title':
+		?&gt;
+		&lt;td&gt;&lt;?php the_title() ?&gt;
+		&lt;?php if ('private' == $post-&gt;post_status) _e(' - &lt;strong&gt;Private&lt;/strong&gt;'); ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'categories':
+		?&gt;
+		&lt;td&gt;&lt;?php the_category(','); ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'comments':
+		?&gt;
+		&lt;td&gt;&lt;a href=&quot;edit.php?p=&lt;?php echo $id ?&gt;&amp;c=1&quot;&gt; 
+      &lt;?php comments_number(__('0'), __('1'), __('%')) ?&gt; 
+      &lt;/a&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'author':
+		?&gt;
+		&lt;td&gt;&lt;?php the_author() ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'control_view':
+		?&gt;
+		&lt;td&gt;&lt;a href=&quot;&lt;?php the_permalink(); ?&gt;&quot; rel=&quot;permalink&quot; class=&quot;edit&quot;&gt;&lt;?php _e('View'); ?&gt;&lt;/a&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'control_edit':
+		?&gt;
+		&lt;td&gt;&lt;?php if ( user_can_edit_post($user_ID,$post-&gt;ID) ) { echo &quot;&lt;a href='post.php?action=edit&amp;post=$id' class='edit'&gt;&quot; . __('Edit') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	case 'control_delete':
+		?&gt;
+		&lt;td&gt;&lt;?php if ( user_can_edit_post($user_ID,$post-&gt;ID) ) { echo &quot;&lt;a href='post.php?action=delete&amp;post=$id' class='delete' onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this post \'%s\'\\n  \'OK\' to delete, \'Cancel\' to stop.&quot;), wp_specialchars(get_the_title('', ''), 1) ) . &quot;')\&quot;&gt;&quot; . __('Delete') . &quot;&lt;/a&gt;&quot;; } ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+
+	default:
+		?&gt;
+		&lt;td&gt;&lt;?php do_action('manage_posts_custom_column', $column_name, $id); ?&gt;&lt;/td&gt;
+		&lt;?php
+		break;
+	}
+}
+?&gt;
+	&lt;/tr&gt; 
+&lt;?php
+}
+} else {
+?&gt;
+  &lt;tr style='background-color: &lt;?php echo $bgcolor; ?&gt;'&gt; 
+    &lt;td colspan=&quot;8&quot;&gt;&lt;?php _e('No posts found.') ?&gt;&lt;/td&gt; 
+  &lt;/tr&gt; 
+&lt;?php
+} // end if ($posts)
+?&gt; 
+&lt;/table&gt; 
+
+&lt;div class=&quot;navigation&quot;&gt;
+&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link(__('&laquo; Previous Entries')) ?&gt;&lt;/div&gt;
+&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link(__('Next Entries &raquo;')) ?&gt;&lt;/div&gt;
+&lt;/div&gt;
+
+&lt;?php
+if ( 1 == count($posts) ) {
+
+	$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = $id AND comment_approved != 'spam' ORDER BY comment_date&quot;);
+	if ($comments) {
+	?&gt; 
+&lt;h3&gt;&lt;?php _e('Comments') ?&gt;&lt;/h3&gt; 
+&lt;ol id=&quot;comments&quot;&gt; 
+&lt;?php
+foreach ($comments as $comment) {
+$comment_status = wp_get_comment_status($comment-&gt;comment_ID);
+?&gt; 
+
+&lt;li &lt;?php if (&quot;unapproved&quot; == $comment_status) echo &quot;class='unapproved'&quot;; ?&gt; &gt;
+  &lt;?php comment_date('Y-n-j') ?&gt; 
+  @
+  &lt;?php comment_time('g:m:s a') ?&gt; 
+  &lt;?php 
+			if (($user_level &gt; $authordata-&gt;user_level) or ($user_login == $authordata-&gt;user_login)) {
+				echo &quot;[ &lt;a href=\&quot;post.php?action=editcomment&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot;&gt;&quot; .  __('Edit') . &quot;&lt;/a&gt;&quot;;
+				echo &quot; - &lt;a href=\&quot;post.php?action=deletecomment&amp;p=&quot;.$post-&gt;ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot; onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this comment by \'%s\'\\n  \'OK\' to delete, \'Cancel\' to stop.&quot;), $comment-&gt;comment_author) . &quot;')\&quot;&gt;&quot; . __('Delete') . &quot;&lt;/a&gt; &quot;;
+				if ( ('none' != $comment_status) &amp;&amp; ($user_level &gt;= 3) ) {
+					if ('approved' == wp_get_comment_status($comment-&gt;comment_ID)) {
+						echo &quot; - &lt;a href=\&quot;post.php?action=unapprovecomment&amp;p=&quot;.$post-&gt;ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot;&gt;&quot; . __('Unapprove') . &quot;&lt;/a&gt; &quot;;
+					} else {
+						echo &quot; - &lt;a href=\&quot;post.php?action=approvecomment&amp;p=&quot;.$post-&gt;ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot;&gt;&quot; . __('Approve') . &quot;&lt;/a&gt; &quot;;
+					}
+				}
+				echo &quot;]&quot;;
+			} // end if any comments to show
+			?&gt; 
+  &lt;br /&gt; 
+  &lt;strong&gt; 
+  &lt;?php comment_author() ?&gt; 
+  (
+  &lt;?php comment_author_email_link() ?&gt; 
+  /
+  &lt;?php comment_author_url_link() ?&gt; 
+  )&lt;/strong&gt; (IP:
+  &lt;?php comment_author_IP() ?&gt; 
+  )
+  &lt;?php comment_text() ?&gt; 
+
+&lt;/li&gt; 
+&lt;!-- /comment --&gt; 
+&lt;?php //end of the loop, don't delete
+		} // end foreach
+	echo '&lt;/ol&gt;';
+	}//end if comments
+	?&gt;
+&lt;?php } ?&gt; 
+&lt;/div&gt; 
+&lt;?php 
+ include('admin-footer.php');
+?&gt; 

Added: trunk/wp-admin/import-b2.php
===================================================================
--- trunk/wp-admin/import-b2.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-b2.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,247 @@
+&lt;?php
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. Double check that you updated wp-config-sample.php with the proper database connection information and renamed it to wp-config.php.&quot;);
+require_once('../wp-config.php');
+require('upgrade-functions.php');
+$step = $_GET['step'];
+if (!$step) $step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+	&lt;title&gt;WordPress &#8212; b2 Conversion&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+	&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 15%;
+		margin-right: 15%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/wordpress.gif">http://wordpress.org/images/wordpress.gif</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		height: 60px;
+	}
+	#logo a span {
+		display: none;
+	}
+	p, li {
+		line-height: 140%;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;&lt;span&gt;WordPress&lt;/span&gt;&lt;/a&gt;&lt;/h1&gt;
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt;
+&lt;p&gt;Welcome to WordPress. Since you&#8217;re upgrading from b2 everything should be relatively 
+  familiar to you. Here are some notes on upgrading:&lt;/p&gt;
+&lt;ul&gt;
+  &lt;li&gt;If you&#8217;re using an older version of b2, it's probably a good idea to upgrade 
+    to at least .61 before making the leap to WordPress.&lt;/li&gt;
+  &lt;li&gt;The templates are so much better, and there is so much more going on than 
+    before it&#8217;s probably worth it to start from scratch and work back to your 
+    design.&lt;/li&gt;
+  &lt;li&gt;You need to transfer some of your settings from your old &lt;code&gt;b2config.php&lt;/code&gt;
+    to &lt;code&gt;wp-config.php&lt;/code&gt; file.&lt;/li&gt;
+  &lt;li&gt;WordPress issues should be discussed in our &lt;a href=&quot;<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>&quot;&gt;support 
+    forums&lt;/a&gt;.&lt;/li&gt;
+  &lt;li&gt;&lt;strong&gt;Back up&lt;/strong&gt; your database before you do anything. Yes, you.&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;Have you looked at the &lt;a href=&quot;../readme.html&quot;&gt;readme&lt;/a&gt;? If 
+  you&#8217;re all ready, &lt;a href=&quot;import-b2.php?step=1&quot;&gt;let&#8217;s go&lt;/a&gt;!&lt;/p&gt;
+&lt;?php
+	break;
+	
+	case 1:
+?&gt;
+&lt;h1&gt;Step 1&lt;/h1&gt;
+&lt;p&gt;Okay first we&#8217;re going to set up the links database. This will allow you to host your own blogroll, complete with Weblogs.com updates.&lt;/p&gt;
+&lt;?php
+
+$got_links = false;
+$got_cats = false;
+$got_row = false;
+?&gt;
+&lt;p&gt;Installing WP-Links.&lt;/p&gt;
+&lt;p&gt;Checking for tables...&lt;/p&gt;
+&lt;?php
+$result = mysql_list_tables(DB_NAME);
+if (!$result) {
+    print &quot;DB Error, could not list tables\n&quot;;
+    print 'MySQL Error: ' . mysql_error();
+    exit;
+}
+
+while ($row = mysql_fetch_row($result)) {
+    if ($row[0] == $wpdb-&gt;links)
+        $got_links = true;
+    if ($row[0] == $wpdb-&gt;linkcategories)
+        $got_cats = true;
+    //print &quot;Table: $row[0]&lt;br /&gt;\n&quot;;
+}
+if (!$got_cats) {
+    echo &quot;&lt;p&gt;Can't find table '$wpdb-&gt;linkcategories', gonna create it...&lt;/p&gt;\n&quot;;
+    $sql = &quot;CREATE TABLE $wpdb-&gt;linkcategories ( &quot; .
+           &quot; cat_id int(11) NOT NULL auto_increment, &quot; .
+           &quot; cat_name tinytext NOT NULL, &quot;.
+           &quot; auto_toggle enum ('Y','N') NOT NULL default 'N', &quot;.
+           &quot; PRIMARY KEY (cat_id) &quot;.
+           &quot;) &quot;;
+    $result = mysql_query($sql) or print (&quot;Can't create the table '$wpdb-&gt;linkcategories' in the database.&lt;br /&gt;&quot; . $sql . &quot;&lt;br /&gt;&quot; . mysql_error());
+    if ($result != false) {
+        echo &quot;&lt;p&gt;Table '$wpdb-&gt;linkcategories' created OK&lt;/p&gt;\n&quot;;
+        $got_cats = true;
+    }
+} else {
+    echo &quot;&lt;p&gt;Found table '$wpdb-&gt;linkcategories', don't need to create it...&lt;/p&gt;\n&quot;;
+        $got_cats = true;
+}
+if (!$got_links) {
+    echo &quot;&lt;p&gt;Can't find '$wpdb-&gt;links', gonna create it...&lt;/p&gt;\n&quot;;
+    $sql = &quot;CREATE TABLE $wpdb-&gt;links ( &quot; .
+           &quot; link_id int(11) NOT NULL auto_increment,           &quot; .
+           &quot; link_url varchar(255) NOT NULL default '',         &quot; .
+           &quot; link_name varchar(255) NOT NULL default '',        &quot; .
+           &quot; link_image varchar(255) NOT NULL default '',       &quot; .
+           &quot; link_target varchar(25) NOT NULL default '',       &quot; .
+           &quot; link_category int(11) NOT NULL default 0,          &quot; .
+           &quot; link_description varchar(255) NOT NULL default '', &quot; .
+           &quot; link_visible enum ('Y','N') NOT NULL default 'Y',  &quot; .
+           &quot; link_owner int NOT NULL DEFAULT '1',               &quot; .
+           &quot; link_rating int NOT NULL DEFAULT '0',              &quot; .
+           &quot; link_updated DATETIME NOT NULL DEFAULT '0000-00-00 00:00:00', &quot; .
+           &quot; link_rel varchar(255) NOT NULL default '',         &quot; .
+           &quot; link_notes MEDIUMTEXT NOT NULL default '',         &quot; .
+           &quot; PRIMARY KEY (link_id)                              &quot; .
+           &quot;) &quot;;
+    $result = mysql_query($sql) or print (&quot;Can't create the table '$wpdb-&gt;links' in the database.&lt;br /&gt;&quot; . $sql . &quot;&lt;br /&gt;&quot; . mysql_error());
+	$links = mysql_query(&quot;INSERT INTO $wpdb-&gt;links VALUES ('', '<A HREF="http://wordpress.org/">http://wordpress.org/</A>', 'WordPress', '', '', 1, '', 'Y', 1, 0, '0000-00-00 00:00:00', '');&quot;);
+	$links = mysql_query(&quot;INSERT INTO $wpdb-&gt;links VALUES ('', '<A HREF="http://photomatt.net/">http://photomatt.net/</A>', 'Matt', '', '', 1, '', 'Y', 1, 0, '0000-00-00 00:00:00', '');&quot;);
+	$links = mysql_query(&quot;INSERT INTO $wpdb-&gt;links VALUES ('', '<A HREF="http://zed1.com/b2/">http://zed1.com/b2/</A>', 'Mike', '', '', 1, '', 'Y', 1, 0, '0000-00-00 00:00:00', '');&quot;);
+
+    if ($result != false) {
+        echo &quot;&lt;p&gt;Table '$wpdb-&gt;links' created OK&lt;/p&gt;\n&quot;;
+        $got_links = true;
+    }
+} else {
+    echo &quot;&lt;p&gt;Found table '$wpdb-&gt;links', don't need to create it...&lt;/p&gt;\n&quot;;
+    echo &quot;&lt;p&gt;... may need to update it though. Looking for column link_updated...&lt;/p&gt;\n&quot;;
+    $query = &quot;SELECT link_updated FROM $wpdb-&gt;links LIMIT 1&quot;;
+    $q = @mysql_query($query);
+    if ($q != false) {
+        if ($row = mysql_fetch_object($q)) {
+            echo &quot;&lt;p&gt;You have  column link_updated. Good!&lt;/p&gt;\n&quot;;
+        }
+    } else {
+        $query = &quot;ALTER TABLE $wpdb-&gt;links ADD COLUMN link_updated DATETIME NOT NULL DEFAULT '0000-00-00 00:00:00'&quot;;
+        $q = mysql_query($query) or mysql_doh(&quot;Doh, couldn't add column.&quot;, $query, mysql_error());
+        echo &quot;&lt;p&gt;Added column link_updated...&lt;/p&gt;\n&quot;;
+    }
+    echo &quot;&lt;p&gt;Looking for column link_rel...&lt;/p&gt;\n&quot;;
+    $query = &quot;SELECT link_rel FROM $wpdb-&gt;links LIMIT 1&quot;;
+    $q = @mysql_query($query);
+    if ($q != false) {
+        if ($row = mysql_fetch_object($q)) {
+            echo &quot;&lt;p&gt;You have column link_rel. Good!&lt;/p&gt;\n&quot;;
+        }
+    } else {
+        $query = &quot;ALTER TABLE $wpdb-&gt;links ADD COLUMN link_rel varchar(255) NOT NULL DEFAULT '' &quot;;
+        $q = mysql_query($query) or mysql_doh(&quot;Doh, couldn't add column.&quot;, $query, mysql_error());
+        echo &quot;&lt;p&gt;Added column link_rel...&lt;/p&gt;\n&quot;;
+    }
+    $got_links = true;
+}
+
+if ($got_links &amp;&amp; $got_cats) {
+    echo &quot;&lt;p&gt;Looking for category 1...&lt;/p&gt;\n&quot;;
+    $sql = &quot;SELECT * FROM $wpdb-&gt;linkcategories WHERE cat_id=1 &quot;;
+    $result = mysql_query($sql) or print (&quot;Can't query '$wpdb-&gt;linkcategories'.&lt;br /&gt;&quot; . $sql . &quot;&lt;br /&gt;&quot; . mysql_error());
+    if ($result != false) {
+        if ($row = mysql_fetch_object($result)) {
+            echo &quot;&lt;p&gt;You have at least 1 category. Good!&lt;/p&gt;\n&quot;;
+            $got_row = true;
+        } else {
+            echo &quot;&lt;p&gt;Gonna insert category 1...&lt;/p&gt;\n&quot;;
+            $sql = &quot;INSERT INTO $wpdb-&gt;linkcategories (cat_id, cat_name) VALUES (1, 'General')&quot;;
+            $result = mysql_query($sql) or print (&quot;Can't query insert category.&lt;br /&gt;&quot; . $sql . &quot;&lt;br /&gt;&quot; . mysql_error());
+            if ($result != false) {
+                echo &quot;&lt;p&gt;Inserted category Ok&lt;/p&gt;\n&quot;;
+                $got_row = true;
+            }
+        }
+    }
+}
+
+if ($got_row) {
+    echo &quot;&lt;p&gt;All done!&lt;/p&gt;\n&quot;;
+}
+?&gt;
+&lt;p&gt;Did you defeat the boss monster at the end? Good, then you&#8217;re ready for 
+  &lt;a href=&quot;import-b2.php?step=2&quot;&gt;Step 2&lt;/a&gt;.&lt;/p&gt;
+&lt;?php
+	break;
+	case 2:
+?&gt;
+&lt;h1&gt;Step 2&lt;/h1&gt;
+&lt;p&gt;First we&#8217;re going to add excerpt, post, and password functionality...&lt;/p&gt;
+
+&lt;?php
+
+$query = &quot;ALTER TABLE $wpdb-&gt;posts ADD COLUMN post_excerpt text NOT NULL;&quot;;
+$q = $wpdb-&gt;query($query);
+// 0.71 mods
+$query = &quot;ALTER TABLE $wpdb-&gt;posts ADD post_status ENUM('publish','draft','private') NOT NULL,
+ADD comment_status ENUM('open','closed') NOT NULL,
+ADD ping_status ENUM('open','closed') NOT NULL,
+ADD post_password varchar(20) NOT NULL;&quot;;
+$q = $wpdb-&gt;query($query);
+?&gt;
+
+&lt;p&gt;That went well! Now let's clean up the b2 database structure a bit...&lt;/p&gt;
+
+&lt;?php
+$query = &quot;ALTER TABLE $wpdb-&gt;posts DROP INDEX ID&quot;;
+
+$q = $wpdb-&gt;query($query);
+
+?&gt;
+
+&lt;p&gt;One down, two to go...&lt;/p&gt;
+
+
+&lt;p&gt;So far so good.&lt;/p&gt;
+&lt;?php
+
+$query=&quot;ALTER TABLE $wpdb-&gt;posts DROP post_karma&quot;;
+$q = $wpdb-&gt;query($query);
+flush();
+?&gt;
+
+&lt;p&gt;Almost there...&lt;/p&gt;
+
+&lt;?php
+
+$query = &quot;ALTER TABLE $wpdb-&gt;users DROP INDEX ID&quot;;
+
+$q = $wpdb-&gt;query($query);
+upgrade_all();
+?&gt;
+
+&lt;p&gt;Welcome to the family. &lt;a href=&quot;../&quot;&gt;Have fun&lt;/a&gt;!&lt;/p&gt;
+  &lt;?php
+	break;
+}
+?&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-admin/import-blogger.php
===================================================================
--- trunk/wp-admin/import-blogger.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-blogger.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,221 @@
+&lt;?php
+
+$wpvarstoreset = array('action');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+require_once('../wp-config.php');
+require('upgrade-functions.php');
+header( 'Content-Type: text/html; charset=utf-8' );
+switch ($action) {
+
+case &quot;step1&quot;:
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;en&quot;&gt;
+	&lt;title&gt;Blogger to WordPress - Converting...&lt;/title&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin.css&quot; type=&quot;text/css&quot;&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h1&gt;Blogger to &lt;img src=&quot;../wp-images/wpminilogo.png&quot; width=&quot;50&quot; height=&quot;50&quot; border=&quot;0&quot; alt=&quot;WordPress&quot; align=&quot;top&quot; /&gt;&lt;/h1&gt;
+&lt;p&gt;The importer is running...&lt;/p&gt;
+&lt;ul&gt;
+	&lt;li&gt;Importing posts and users
+		&lt;ul&gt;&lt;?php
+
+	for($bgy=1999; $bgy&lt;=(date('Y')); $bgy++) {
+		for($bgm=1; $bgm&lt;13; $bgm++) {
+
+		$bgmm = zeroise($bgm,2);
+	
+		$archivefile = &quot;../$bgy&quot;.&quot;_&quot;.&quot;$bgmm&quot;.&quot;_01_wordpress.php&quot;;
+		
+		if (file_exists($archivefile)) {
+
+			$f = fopen($archivefile,&quot;r&quot;);
+			$archive = fread($f, filesize($archivefile));
+			fclose($f);
+			echo &quot;&lt;li&gt;$bgy/$bgmm &quot;;
+
+			$posts = explode('&lt;wordpresspost&gt;', $archive);
+
+			for ($i = 1; $i &lt; count($posts); $i = $i + 1) {
+
+			$postinfo = explode('|||', $posts[$i]);
+			$post_date = $postinfo[0];
+			$post_content = $postinfo[2];
+			// Don't try to re-use the original numbers
+			// because the new, longer numbers are too
+			// big to handle as ints.
+			//$post_number = $postinfo[3];
+			$post_title = $postinfo[4];
+
+			$post_author = trim(addslashes($postinfo[1]));
+			// we'll check the author is registered already
+			$user = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users WHERE user_login = '$post_author'&quot;);
+			if (!$user) { // seems s/he's not, so let's register
+				$user_ip = '127.0.0.1';
+				$user_domain = 'localhost';
+				$user_browser = 'server';
+				$user_joindate = '1979-06-06 00:41:00'; // that's my birthdate (gmt+1) - I could choose any other date. You could change the date too. Just remember the year must be &gt;=1970 or the world would just randomly fall on your head (everything might look fine, and then blam! major headache!)
+				$user_login = addslashes($post_author);
+				$pass1 = addslashes('password');
+				$user_nickname = addslashes($post_author);
+				$user_email = addslashes('<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">user at wordpress.org</A>');
+				$user_url = addslashes('');
+				$user_joindate = addslashes($user_joindate);
+				$result = $wpdb-&gt;query(&quot;
+				INSERT INTO $wpdb-&gt;users (
+					user_login,
+					user_pass,
+					user_nickname,
+					user_email,
+					user_url,
+					user_ip,
+					user_domain,
+					user_browser,
+					user_registered,
+					user_level,
+					user_idmode
+				) VALUES (
+					'$user_login',
+					'$pass1',
+					'$user_nickname',
+					'$user_email',
+					'$user_url',
+					'$user_ip',
+					'$user_domain',
+					'$user_browser',
+					'$user_joindate',
+					'1',
+					'nickname'
+				)&quot;);
+
+				echo &quot;: Registered user &lt;strong&gt;$user_login&lt;/strong&gt;&quot;;
+			}
+
+			$post_author_ID = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$post_author'&quot;);
+
+			$post_date = explode(' ', $post_date);
+			$post_date_Ymd = explode('/', $post_date[0]);
+			$postyear = $post_date_Ymd[2];
+			$postmonth = zeroise($post_date_Ymd[0], 2);
+			$postday = zeroise($post_date_Ymd[1], 2);
+			$post_date_His = explode(':', $post_date[1]);
+			$posthour = zeroise($post_date_His[0], 2);
+			$postminute = zeroise($post_date_His[1], 2);
+			$postsecond = zeroise($post_date_His[2], 2);
+
+			if (($post_date[2] == 'PM') &amp;&amp; ($posthour != '12'))
+				$posthour = $posthour + 12;
+			else if (($post_date[2] == 'AM') &amp;&amp; ($posthour == '12'))
+				$posthour = '00';
+
+			$post_date = &quot;$postyear-$postmonth-$postday $posthour:$postminute:$postsecond&quot;;
+
+			$post_content = addslashes($post_content);
+			$post_content = str_replace('&lt;br&gt;', '&lt;br /&gt;', $post_content); // the XHTML touch... ;)
+			
+			$post_title = addslashes($post_title);
+			
+			// Quick-n-dirty check for dups:
+			$dupcheck = $wpdb-&gt;get_results(&quot;SELECT ID,post_date,post_title FROM $wpdb-&gt;posts WHERE post_date='$post_date' AND post_title='$post_title' LIMIT 1&quot;,ARRAY_A);
+			if ($dupcheck[0]['ID']) {
+				print &quot;&lt;br /&gt;\nSkipping duplicate post, ID = '&quot; . $dupcheck[0]['ID'] . &quot;'&lt;br /&gt;\n&quot;;
+				print &quot;Timestamp: &quot; . $post_date . &quot;&lt;br /&gt;\n&quot;;
+				print &quot;Post Title: '&quot; . stripslashes($post_title) . &quot;'&lt;br /&gt;\n&quot;;
+				continue;
+			}
+
+			$result = $wpdb-&gt;query(&quot;
+			INSERT INTO $wpdb-&gt;posts 
+				(post_author,post_date,post_content,post_title,post_category)
+			VALUES 
+				('$post_author_ID','$post_date','$post_content','$post_title','1')
+			&quot;);
+
+
+			} echo '... &lt;strong&gt;Done&lt;/strong&gt;&lt;/li&gt;';
+			
+		}}
+	}
+
+	upgrade_all();
+	?&gt;
+&lt;/ul&gt;
+&lt;strong&gt;Done&lt;/strong&gt;
+&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;&nbsp;&lt;/p&gt;
+&lt;p&gt;Completed Blogger to WordPress import!&lt;/p&gt;
+&lt;p&gt;Now you can go and &lt;a href=&quot;../wp-login.php&quot;&gt;log in&lt;/a&gt;, have fun!&lt;/p&gt;
+&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+	&lt;?php
+	break;
+
+default:
+
+	?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;en&quot;&gt;
+	&lt;title&gt;Blogger to WordPress Import Utility&lt;/title&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin.css&quot; type=&quot;text/css&quot;&gt;
+&lt;/head&gt;
+
+&lt;body&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h1&gt;Blogger to &lt;img src=&quot;../wp-images/wpminilogo.png&quot; width=&quot;50&quot; height=&quot;50&quot; border=&quot;0&quot; alt=&quot;WordPress&quot; align=&quot;top&quot; /&gt;&lt;/h1&gt;
+&lt;p&gt;This is a basic Blogger to WordPress import script.&lt;/p&gt;
+&lt;p&gt;What it does:&lt;/p&gt;
+&lt;ul&gt;
+	&lt;li&gt;Parses your archives to retrieve your blogger posts.&lt;/li&gt;
+	&lt;li&gt;Adds an author whenever it sees a new nickname, all authors are imported at level 1, with a default profile and the password 'password'&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;What it does not:&lt;/p&gt;
+&lt;ul&gt;
+	&lt;li&gt;It sucks at making coffee.&lt;/li&gt;
+	&lt;li&gt;It always forgets to call back.&lt;/li&gt;
+&lt;/ul&gt;
+
+&lt;h2&gt;First step: Install WordPress&lt;/h2&gt;
+&lt;p&gt;Install the WordPress blog as explained in the &lt;a href=&quot;../readme.html&quot;&gt;read me&lt;/a&gt;, then immediately come back here.&lt;/p&gt;
+
+&lt;h3&gt;Second step: let's play with Blogger&lt;/h3&gt;
+&lt;p&gt;Log into your Blogger account.&lt;br /&gt;
+Go to the Settings, and make Blogger publish your files in the directory where your WordPress resides. Change the Date/Time format to be mm/dd/yyyy hh:mm:ss AM/PM (the first choice in the dropdown menu). In Archives: set the frequency to 'monthly' and the archive filename to 'wordpress.php' (without the quotes), set the ftp archive path to make Blogger publish the archives in your WordPress directory. Click 'save changes'.&lt;br /&gt;
+Go to the Templates. Replace your existing template with this line (copy and paste):
+&lt;blockquote&gt;&lt;Blogger&gt;&lt;wordpresspost&gt;&lt;$BlogItemDateTime$&gt;|||&lt;$BlogItemAuthorNickname$&gt;|||&lt;$BlogItemBody$&gt;|||&lt;$BlogItemNumber$&gt;|||&lt;$BlogItemSubject$&gt;&lt;/Blogger&gt;&lt;/blockquote&gt;
+Go to the Archives, and click 'republish all'.&lt;br /&gt;
+Check in your FTP that you've got the archive files published. They should look like this example: &lt;code&gt;2001_10_01_wordpress.php&lt;/code&gt;. If they aren't there, redo the republish process.&lt;/p&gt;
+&lt;p&gt;You're done with the hard part. :)&lt;/p&gt;
+
+&lt;form name=&quot;stepOne&quot; method=&quot;get&quot;&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;step1&quot; /&gt;
+&lt;h3&gt;Third step: w00t, let's click OK:&lt;/h3&gt;
+&lt;p&gt;When you're ready, click OK to start importing: &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;OK&quot; /&gt;&lt;br /&gt;&lt;br /&gt;
+&lt;i&gt;Note: the script might take some time, like 1 second for 100 entries
+imported. DO NOT STOP IT or else you won't have a complete import.&lt;/i&gt;&lt;/p&gt;
+&lt;/form&gt;
+&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+	&lt;?php
+	break;
+
+}
+
+?&gt;

Added: trunk/wp-admin/import-greymatter.php
===================================================================
--- trunk/wp-admin/import-greymatter.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-greymatter.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,322 @@
+&lt;?php
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. You must install WordPress before you import any entries.&quot;);
+
+require_once('../wp-config.php');
+require('upgrade-functions.php');
+
+$wpvarstoreset = array('action', 'gmpath', 'archivespath', 'lastentry');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;title&gt;WordPress &rsaquo; Import from GreyMatter&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/logo.png">http://wordpress.org/images/logo.png</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		text-decoration: none;
+		text-indent: -100em;
+		height: 60px;
+	}
+	p {
+		line-height: 140%;
+	}
+	#authors li 	{
+		padding:3px;
+		border: 1px solid #ccc;
+		width: 40%;
+		margin-bottom:2px;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt; 
+
+&lt;?php
+switch ($action) {
+
+case &quot;step1&quot;:
+
+	function gm2autobr($string) { // transforms GM's |*| into wp's &lt;br /&gt;\n
+		$string = str_replace(&quot;|*|&quot;,&quot;&lt;br /&gt;\n&quot;,$string);
+		return($string);
+	}
+
+	if (!@chdir($archivespath))
+		die(&quot;Wrong path, $archivespath\ndoesn't exist\non the server&quot;);
+
+	if (!@chdir($gmpath))
+		die(&quot;Wrong path, $gmpath\ndoesn't exist\non the server&quot;);
+?&gt;
+
+&lt;p&gt;The importer is running...&lt;/p&gt;
+&lt;ul&gt;
+&lt;li&gt;importing users... &lt;ul&gt;&lt;?php
+
+	chdir($gmpath);
+	$userbase = file(&quot;gm-authors.cgi&quot;);
+
+	foreach($userbase as $user) {
+		$userdata=explode(&quot;|&quot;, $user);
+
+		$user_ip=&quot;127.0.0.1&quot;;
+		$user_domain=&quot;localhost&quot;;
+		$user_browser=&quot;server&quot;;
+
+		$s=$userdata[4];
+		$user_joindate=substr($s,6,4).&quot;-&quot;.substr($s,0,2).&quot;-&quot;.substr($s,3,2).&quot; 00:00:00&quot;;
+
+		$user_login=addslashes($userdata[0]);
+		$pass1=addslashes($userdata[1]);
+		$user_nickname=addslashes($userdata[0]);
+		$user_email=addslashes($userdata[2]);
+		$user_url=addslashes($userdata[3]);
+		$user_joindate=addslashes($user_joindate);
+
+		$loginthere = $wpdb-&gt;get_var(&quot;SELECT user_login FROM $wpdb-&gt;users WHERE user_login = '$user_login'&quot;);
+		if ($loginthere) {
+			echo &quot;&lt;li&gt;user &lt;i&gt;$user_login&lt;/i&gt;... &lt;b&gt;Already exists&lt;/b&gt;&lt;/li&gt;&quot;;
+			continue;
+		}
+
+		$query = &quot;INSERT INTO $wpdb-&gt;users (user_login,user_pass,user_nickname,user_email,user_url,user_ip,user_domain,user_browser,user_registered,user_level,user_idmode) VALUES ('$user_login','$pass1','$user_nickname','$user_email','$user_url','$user_ip','$user_domain','$user_browser','$user_joindate','1','nickname')&quot;;
+		$result = $wpdb-&gt;query($query);
+		if ($result==false) {
+			die (&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: couldn't register an user!&quot;);
+		}
+		echo &quot;&lt;li&gt;user &lt;i&gt;$user_login&lt;/i&gt;... &lt;b&gt;Done&lt;/b&gt;&lt;/li&gt;&quot;;
+
+	}
+
+?&gt;&lt;/ul&gt;&lt;b&gt;Done&lt;/b&gt;&lt;/li&gt;
+&lt;li&gt;importing posts, comments, and karma...&lt;br /&gt;&lt;ul&gt;&lt;?php
+
+	chdir($archivespath);
+	
+	for($i = 0; $i &lt;= $lastentry; $i = $i + 1) {
+		
+		$entryfile = &quot;&quot;;
+		
+		if ($i&lt;10000000) {
+			$entryfile .= &quot;0&quot;;
+			if ($i&lt;1000000) {
+				$entryfile .= &quot;0&quot;;
+				if ($i&lt;100000) {
+					$entryfile .= &quot;0&quot;;
+					if ($i&lt;10000) {
+						$entryfile .= &quot;0&quot;;
+						if ($i&lt;1000) {
+							$entryfile .= &quot;0&quot;;
+							if ($i&lt;100) {
+								$entryfile .= &quot;0&quot;;
+								if ($i&lt;10) {
+									$entryfile .= &quot;0&quot;;
+		}}}}}}}
+
+		$entryfile .= &quot;$i&quot;;
+
+		if (is_file($entryfile.&quot;.cgi&quot;)) {
+
+			$entry=file($entryfile.&quot;.cgi&quot;);
+			echo &quot;&lt;li&gt;entry # $entryfile &quot;;
+			$postinfo=explode(&quot;|&quot;,$entry[0]);
+			$postmaincontent=gm2autobr($entry[2]);
+			$postmorecontent=gm2autobr($entry[3]);
+
+			$post_author=trim(addslashes($postinfo[1]));
+			// we'll check the author is registered, or if it's a deleted author
+			$sql = &quot;SELECT * FROM $wpdb-&gt;users WHERE user_login = '$post_author'&quot;;
+			$result = $wpdb-&gt;query($sql);
+			if (! $result) { // if deleted from GM, we register the author as a level 0 user in wp
+				$user_ip=&quot;127.0.0.1&quot;;
+				$user_domain=&quot;localhost&quot;;
+				$user_browser=&quot;server&quot;;
+				$user_joindate=&quot;1979-06-06 00:41:00&quot;;
+				$user_login=addslashes($post_author);
+				$pass1=addslashes(&quot;password&quot;);
+				$user_nickname=addslashes($post_author);
+				$user_email=addslashes(&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">user at deleted.com</A>&quot;);
+				$user_url=addslashes(&quot;&quot;);
+				$user_joindate=addslashes($user_joindate);
+				$query = &quot;INSERT INTO $wpdb-&gt;users (user_login,user_pass,user_nickname,user_email,user_url,user_ip,user_domain,user_browser,user_registered,user_level,user_idmode) VALUES ('$user_login','$pass1','$user_nickname','$user_email','$user_url','$user_ip','$user_domain','$user_browser','$user_joindate','0','nickname')&quot;;
+				$result = $wpdb-&gt;query($query);
+				if ($result==false) {
+					die (&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: couldn't register an user!&quot;);
+				}
+				echo &quot;: registered deleted user &lt;i&gt;$user_login&lt;/i&gt; at level 0 &quot;;
+			}
+
+			$sql = &quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$post_author'&quot;;
+			$post_author_ID = $wpdb-&gt;get_var($sql);
+
+			$post_title=gm2autobr($postinfo[2]);
+			$post_title=addslashes($post_title);
+
+			$postyear=$postinfo[6];
+			$postmonth=zeroise($postinfo[4],2);
+			$postday=zeroise($postinfo[5],2);
+			$posthour=zeroise($postinfo[7],2);
+			$postminute=zeroise($postinfo[8],2);
+			$postsecond=zeroise($postinfo[9],2);
+
+			if (($postinfo[10]==&quot;PM&quot;) &amp;&amp; ($posthour!=&quot;12&quot;))
+				$posthour=$posthour+12;
+
+			$post_date=&quot;$postyear-$postmonth-$postday $posthour:$postminute:$postsecond&quot;;
+
+			$post_content=$postmaincontent;
+			if (strlen($postmorecontent)&gt;3)
+				$post_content .= &quot;&lt;!--more--&gt;&lt;br /&gt;&lt;br /&gt;&quot;.$postmorecontent;
+			$post_content=addslashes($post_content);
+
+			$post_karma=$postinfo[12];
+
+			$query = &quot;INSERT INTO $wpdb-&gt;posts (post_author,post_date,post_content,post_title) VALUES ('$post_author_ID','$post_date','$post_content','$post_title')&quot;;
+			$result = $wpdb-&gt;query($query);
+
+			if (!$result)
+				die (&quot;Error in posting...&quot;);
+			
+			$query = &quot;SELECT ID FROM $wpdb-&gt;posts ORDER BY ID DESC LIMIT 1&quot;;
+			$post_ID = $wpdb-&gt;get_var($query);
+
+			// Grab a default category.
+			$post_category = $wpdb-&gt;get_var(&quot;SELECT cat_ID FROM $wpdb-&gt;categories LIMIT 1&quot;);
+
+			// Update the post2cat table.
+			$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_ID AND category_id = $post_category&quot;);
+			  
+			if (!$exists) {
+			  $wpdb-&gt;query(&quot;
+					INSERT INTO $wpdb-&gt;post2cat
+					(post_id, category_id)
+					VALUES
+					($post_ID, $post_category)
+					&quot;);
+			}
+
+			$c=count($entry);
+			if ($c&gt;4) {
+				for ($j=4;$j&lt;$c;$j++) {
+					$entry[$j]=gm2autobr($entry[$j]);
+					$commentinfo=explode(&quot;|&quot;,$entry[$j]);
+					$comment_post_ID=$post_ID;
+					$comment_author=addslashes($commentinfo[0]);
+					$comment_author_email=addslashes($commentinfo[2]);
+					$comment_author_url=addslashes($commentinfo[3]);
+					$comment_author_IP=addslashes($commentinfo[1]);
+
+					$commentyear=$commentinfo[7];
+					$commentmonth=zeroise($commentinfo[5],2);
+					$commentday=zeroise($commentinfo[6],2);
+					$commenthour=zeroise($commentinfo[8],2);
+					$commentminute=zeroise($commentinfo[9],2);
+					$commentsecond=zeroise($commentinfo[10],2);
+					if (($commentinfo[11]==&quot;PM&quot;) &amp;&amp; ($commenthour!=&quot;12&quot;))
+						$commenthour=$commenthour+12;
+					$comment_date=&quot;$commentyear-$commentmonth-$commentday $commenthour:$commentminute:$commentsecond&quot;;
+
+					$comment_content=addslashes($commentinfo[12]);
+
+					$sql3 = &quot;INSERT INTO $wpdb-&gt;comments (comment_post_ID,comment_author,comment_author_email,comment_author_url,comment_author_IP,comment_date,comment_content) VALUES ('$comment_post_ID','$comment_author','$comment_author_email','$comment_author_url','$comment_author_IP','$comment_date','$comment_content')&quot;;
+					$result3 = $wpdb-&gt;query($sql3);
+					if (!$result3)
+						die (&quot;There is an error with the database, it can't store your comment..&quot;);
+				}
+				$comments=$c-4;
+				echo &quot;: imported $comments comment&quot;;
+				if ($comments&gt;1)
+					echo &quot;s&quot;;
+			}
+			echo &quot;... &lt;b&gt;Done&lt;/b&gt;&lt;/li&gt;&quot;;
+		}
+	} 
+	upgrade_all();
+	?&gt;
+&lt;/ul&gt;&lt;b&gt;Done&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;
+&lt;p&gt;&nbsp;&lt;/p&gt;
+&lt;p&gt;Completed GM 2 WordPress import !&lt;/p&gt;
+&lt;p&gt;Now you can go and &lt;a href=&quot;wp-login.php&quot;&gt;log in&lt;/a&gt;, have fun !&lt;/p&gt;
+	&lt;?php
+	break;
+
+default:
+?&gt;
+
+&lt;p&gt;This is a basic GreyMatter to WordPress import script.&lt;/p&gt;
+&lt;p&gt;What it does:&lt;/p&gt;
+&lt;ul&gt;
+&lt;li&gt;parses gm-authors.cgi to import authors: everyone is imported at level 1&lt;/li&gt;
+&lt;li&gt;parses the entries cgi files to import posts, comments, and karma on posts (although karma is not used on WordPress); if authors are found not to be in gm-authors.cgi, imports them at level 0&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;What it does not:&lt;/p&gt;
+&lt;ul&gt;
+&lt;li&gt;parse gm-counter.cgi (what's the use of that file ?), gm-banlist.cgi, gm-cplog.cgi (you can make a CP log hack if you really feel like it, but I question the need of a CP log)&lt;/li&gt;
+&lt;li&gt;import gm-templates. you'll start with the basic template wp.php&lt;/li&gt;
+&lt;li&gt;doesn't keep entries on top&lt;/li&gt;
+&lt;/ul&gt;
+
+&lt;h3&gt;First step: Install WordPress&lt;/h3&gt;
+&lt;p&gt;Install the WordPress blog as explained in the &lt;a href=&quot;../readme.html&quot; target=&quot;_blank&quot;&gt;ReadMe&lt;/a&gt;, then immediately come back here.&lt;/p&gt;
+
+&lt;form name=&quot;stepOne&quot; method=&quot;get&quot;&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;step1&quot; /&gt;
+&lt;h3&gt;Second step: Provide GreyMatter details&lt;/h3&gt;
+&lt;table cellpadding=&quot;0&quot;&gt;
+&lt;tr&gt;
+&lt;td&gt;Path to GM files:&lt;/td&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; style=&quot;width:300px&quot; name=&quot;gmpath&quot; value=&quot;/home/my/site/cgi-bin/greymatter/&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;td&gt;Path to GM entries:&lt;/td&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; style=&quot;width:300px&quot; name=&quot;archivespath&quot; value=&quot;/home/my/site/cgi-bin/greymatter/archives/&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;p&gt;This importer will search for files 00000001.cgi to 000-whatever.cgi, so you need to enter the number of the last GM post here. (If you don't know that number, just log into your FTP and look it up in the entries' folder)&lt;/p&gt;
+
+&lt;table&gt;
+&lt;tr&gt;
+&lt;td&gt;Last entry's number:&lt;/td&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;lastentry&quot; value=&quot;00000001&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;p&gt;When you're ready, click OK to start importing: &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;OK&quot; class=&quot;search&quot; /&gt;&lt;/p&gt;
+&lt;/form&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
+	&lt;?php
+	break;
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/import-livejournal.php
===================================================================
--- trunk/wp-admin/import-livejournal.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-livejournal.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,124 @@
+&lt;?php
+define('XMLFILE', '');
+// Example:
+// define('XMLFILE', '/home/example/public_html/rss.xml');
+// or if it's in the same directory as import-rss.php
+// define('XMLFILE', 'rss.xml');
+
+$post_author = 1; // Author to import posts as author ID
+$timezone_offset = 0; // GMT offset of posts your importing
+
+
+$add_hours = intval($timezone_offset);
+$add_minutes = intval(60 * ($timezone_offset - $add_hours));
+
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. You must install WordPress before you import any entries.&quot;);
+require('../wp-config.php');
+
+$step = $_GET['step'];
+if (!$step) $step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;title&gt;WordPress &rsaquo; Import from RSS&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/logo.png">http://wordpress.org/images/logo.png</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		text-decoration: none;
+		text-indent: -100em;
+		height: 60px;
+	}
+	p {
+		line-height: 140%;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt; 
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt; 
+&lt;p&gt;Howdy! This importer allows you to extract posts from a LiveJournal XML export file. To get started you must edit the following line in this file (&lt;code&gt;import-livejournal.php&lt;/code&gt;) &lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('XMLFILE', '');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;You want to define where the XML file we'll be working with is, for example: &lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('XMLFILE', '2002-04.xml');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;You have to do this manually for security reasons.&lt;/p&gt;
+&lt;p&gt;If you've done that and you&#8217;re all ready, &lt;a href=&quot;import-livejournal.php?step=1&quot;&gt;let's go&lt;/a&gt;!&lt;/p&gt;
+&lt;?php
+	break;
+	
+	case 1:
+if ('' != XMLFILE &amp;&amp; !file_exists(XMLFILE)) die(&quot;The file you specified does not seem to exist. Please check the path you've given.&quot;);
+if ('' == XMLFILE) die(&quot;You must edit the XMLFILE line as described on the &lt;a href='import-rss.php'&gt;previous page&lt;/a&gt; to continue.&quot;);
+
+// Bring in the data
+set_magic_quotes_runtime(0);
+$datalines = file(XMLFILE); // Read the file into an array
+$importdata = implode('', $datalines); // squish it
+$importdata = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $importdata);
+
+preg_match_all('|&lt;entry&gt;(.*?)&lt;/entry&gt;|is', $importdata, $posts);
+$posts = $posts[1];
+
+echo '&lt;ol&gt;';
+foreach ($posts as $post) :
+$title = $date = $categories = $content = $post_id =  '';
+echo &quot;&lt;li&gt;Importing post... &quot;;
+
+preg_match('|&lt;subject&gt;(.*?)&lt;/subject&gt;|is', $post, $title);
+$title = addslashes( trim($title[1]) );
+$post_name = sanitize_title($title);
+
+preg_match('|&lt;eventtime&gt;(.*?)&lt;/eventtime&gt;|is', $post, $date);
+$date = strtotime($date[1]);
+
+$post_date = date('Y-m-d H:i:s', $date);
+
+
+preg_match('|&lt;event&gt;(.*?)&lt;/event&gt;|is', $post, $content);
+$content = str_replace( array('&lt;![CDATA[', ']]&gt;'), '', addslashes( trim($content[1]) ) );
+
+// Now lets put it in the DB
+if ($wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$title' AND post_date = '$post_date'&quot;)) :
+	echo 'Post already imported';
+else : 
+	
+	$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;posts 
+		(post_author, post_date, post_date_gmt, post_content, post_title,post_status, comment_status, ping_status, post_name)
+		VALUES 
+		('$post_author', '$post_date', DATE_ADD('$post_date', INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE), '$content', '$title', 'publish', '$comment_status', '$ping_status', '$post_name')&quot;);
+	$post_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$title' AND post_date = '$post_date'&quot;);
+	if (!$post_id) die(&quot;couldn't get post ID&quot;);
+	$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_id AND category_id = 1&quot;);
+	if (!$exists) $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;post2cat (post_id, category_id) VALUES ($post_id, 1) &quot;);
+	echo 'Done!&lt;/li&gt;';
+endif;
+
+
+endforeach;
+?&gt;
+&lt;/ol&gt;
+
+&lt;h3&gt;All done. &lt;a href=&quot;../&quot;&gt;Have fun!&lt;/a&gt;&lt;/h3&gt;
+&lt;?php
+	break;
+}
+?&gt; 
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-admin/import-mt.php
===================================================================
--- trunk/wp-admin/import-mt.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-mt.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,418 @@
+&lt;?php
+define('MTEXPORT', '');
+// enter the relative path of the import.txt file containing the mt entries. If the file is called import.txt and it is /wp-admin, then this line
+//should be define('MTEXPORT', 'import.txt');
+
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. You must install WordPress before you import any entries.&quot;);
+require('../wp-config.php');
+require ('upgrade-functions.php');
+$step = $_GET['step'];
+if (!$step) $step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;title&gt;WordPress &rsaquo; Import from Movable Type&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/logo.png">http://wordpress.org/images/logo.png</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		text-decoration: none;
+		text-indent: -100em;
+		height: 60px;
+	}
+	p {
+		line-height: 140%;
+	}
+	#authors li 	{
+		padding:3px;
+		border: 1px solid #ccc;
+		width: 40%;
+		margin-bottom:2px;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt; 
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt; 
+&lt;p&gt;Howdy! We&#8217;re about to begin the process to import all of your Movable Type entries into WordPress. Before we get started, you need to edit this file (&lt;code&gt;import-mt.php&lt;/code&gt;) and change one line so we know where to find your MT export file. To make this easy put the import file into the &lt;code&gt;wp-admin&lt;/code&gt; directory. Look for the line that says:&lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('MTEXPORT', '');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;and change it to&lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('MTEXPORT', 'import.txt');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;You have to do this manually for security reasons.&lt;/p&gt;
+&lt;p&gt;If you've done that and you&#8217;re all ready, &lt;a href=&quot;import-mt.php?step=1&quot;&gt;let's go&lt;/a&gt;! Remember that the import process may take a minute or so if you have a large number of entries and comments. Think of all the rebuilding time you'll be saving once it's done. :)&lt;/p&gt;
+&lt;p&gt;The importer is smart enough not to import duplicates, so you can run this multiple times without worry if&#8212;for whatever reason&#8212;it doesn't finish. If you get an &lt;strong&gt;out of memory&lt;/strong&gt; error try splitting up the import file into pieces. &lt;/p&gt;
+&lt;?php
+	break;
+	
+	case 1:
+if ('' != MTEXPORT &amp;&amp; !file_exists(MTEXPORT)) die(&quot;The file you specified does not seem to exist. Please check the path you've given.&quot;);
+if ('' == MTEXPORT) die(&quot;You must edit the MTEXPORT line as described on the &lt;a href='import-mt.php'&gt;previous page&lt;/a&gt; to continue.&quot;);
+// Bring in the data
+set_magic_quotes_runtime(0);
+$importdata = file(MTEXPORT); // Read the file into an array
+$importdata = implode('', $importdata); // squish it
+$importdata = preg_replace(&quot;/(\r\n|\n|\r)/&quot;, &quot;\n&quot;, $importdata);
+$importdata = preg_replace(&quot;/\n--------\n/&quot;, &quot;--MT-ENTRY--\n&quot;, $importdata);
+$authors = array();
+$temp = array();
+$posts = explode(&quot;--MT-ENTRY--&quot;, $importdata);
+unset( $importdata ); // Free up memory
+
+function users_form($n) {
+	global $wpdb, $testing;
+	$users = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;users ORDER BY ID&quot;);
+	?&gt;&lt;select name=&quot;userselect[&lt;?php echo $n; ?&gt;]&quot;&gt;
+	&lt;option value=&quot;#NONE#&quot;&gt;- Select -&lt;/option&gt;
+	&lt;?php foreach($users as $user) {
+		echo '&lt;option value=&quot;'.$user-&gt;user_login.'&quot;&gt;'.$user-&gt;user_login.'&lt;/option&gt;';
+		} ?&gt;
+	&lt;/select&gt;
+&lt;?php }
+
+$i = -1;
+foreach ($posts as $post) { 
+	if ('' != trim($post)) {
+		++$i;
+		unset($post_categories);
+		preg_match(&quot;|AUTHOR:(.*)|&quot;, $post, $thematch);
+		$thematch = trim($thematch[1]);
+		array_push($temp,&quot;$thematch&quot;); //store the extracted author names in a temporary array
+		}
+	}//end of foreach
+//we need to find unique values of author names, while preserving the order, so this function emulates the unique_value(); php function, without the sorting.
+$authors[0] = array_shift($temp); 
+$y = count($temp) + 1;
+for ($x = 1; $x &lt; $y; $x++) {
+	$next = array_shift($temp);
+	if (!(in_array($next,$authors))) array_push($authors, &quot;$next&quot;);
+	}
+//by this point, we have all unique authors in the array $authors
+?&gt;&lt;p&gt;&lt;?php _e('To make it easier for you to edit and save the imported posts and drafts, you may want to change the name of the author of the posts. For example, you may want to import all the entries as &lt;code&gt;admin&lt;/code&gt;s entries.'); ?&gt;&lt;/p&gt;
+&lt;p&gt;&lt;?php _e('Below, you can see the names of the authors of the MovableType posts in &lt;i&gt;italics&lt;/i&gt;. For each of these names, you can either pick an author in your WordPress installation from the menu, or enter a name for the author in the textbox.'); ?&gt;&lt;/p&gt;
+&lt;p&gt;&lt;?php _e('If a new user is created by WordPress, the password will be set, by default, to &quot;changeme&quot;. Quite suggestive, eh? ;)'); ?&gt;&lt;/p&gt;
+	&lt;?php
+	echo '&lt;ol id=&quot;authors&quot;&gt;';
+	echo '&lt;form action=&quot;?step=2&quot; method=&quot;post&quot;&gt;';
+	$j = -1;
+	foreach ($authors as $author) {
+	++$j;
+	echo '&lt;li&gt;&lt;i&gt;'.$author.'&lt;/i&gt;&lt;br /&gt;'.'&lt;input type=&quot;text&quot; value=&quot;'.$author.'&quot; name=&quot;'.'user[]'.'&quot; maxlength=&quot;30&quot;&gt;';
+	users_form($j);
+	echo '&lt;/li&gt;';
+	}
+	echo '&lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;'.'&lt;br/&gt;';
+	echo '&lt;/form&gt;';
+	echo '&lt;/ol&gt;';
+	
+	flush();
+
+	break;
+	
+	case 2:
+	$newauthornames = array();
+	$formnames = array();
+	$selectnames = array();
+	$mtnames = array();
+	foreach($_POST['user'] as $key =&gt; $line) { 
+	$newname = trim(stripslashes($line)); 
+	if ($newname == '') $newname = 'left_blank';//passing author names from step 1 to step 2 is accomplished by using POST. left_blank denotes an empty entry in the form.
+	array_push($formnames,&quot;$newname&quot;);
+	}// $formnames is the array with the form entered names
+	foreach ($_POST['userselect'] as $user =&gt; $key) {
+	$selected = trim(stripslashes($key));
+	array_push($selectnames,&quot;$selected&quot;);
+	}
+	$count = count($formnames);
+	for ($i = 0; $i &lt; $count; $i++) {
+	if ( $selectnames[$i] != '#NONE#') {//if no name was selected from the select menu, use the name entered in the form
+	array_push($newauthornames,&quot;$selectnames[$i]&quot;);
+	} 
+	else {
+	array_push($newauthornames,&quot;$formnames[$i]&quot;);
+	}
+	}
+
+	$j = -1;
+	//function to check the authorname and do the mapping
+	function checkauthor($author) {
+	global $wpdb, $mtnames, $newauthornames, $j;//mtnames is an array with the names in the mt import file
+	$md5pass = md5(changeme);
+	if (!(in_array($author, $mtnames))) { //a new mt author name is found
+		++$j;
+		$mtnames[$j] = $author; //add that new mt author name to an array 
+		$user_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$newauthornames[$j]'&quot;); //check if the new author name defined by the user is a pre-existing wp user
+		if (!$user_id) { //banging my head against the desk now. 
+			if ($newauthornames[$j] == 'left_blank') { //check if the user does not want to change the authorname
+				$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;users (user_level, user_login, user_pass, user_nickname) VALUES ('1', '$author', '$md5pass', '$author')&quot;); // if user does not want to change, insert the authorname $author
+				$user_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$author'&quot;);
+				$newauthornames[$j] = $author; //now we have a name, in the place of left_blank.
+			} else {
+			$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;users (user_level, user_login, user_pass, user_nickname) VALUES ('1', '$newauthornames[$j]', '$md5pass', '$newauthornames[$j]')&quot;); //if not left_blank, insert the user specified name
+			$user_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$newauthornames[$j]'&quot;);
+			}
+		} else return $user_id; // return pre-existing wp username if it exists
+    } else {
+    $key = array_search($author, $mtnames); //find the array key for $author in the $mtnames array
+    $user_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_login = '$newauthornames[$key]'&quot;);//use that key to get the value of the author's name from $newauthornames
+	}
+	return $user_id;
+}//function checkauthor ends here
+
+	//bring in the posts now
+set_magic_quotes_runtime(0);
+$importdata = file(MTEXPORT); // Read the file into an array
+$importdata = implode('', $importdata); // squish it
+$importdata = preg_replace(&quot;/(\r\n|\n|\r)/&quot;, &quot;\n&quot;, $importdata);
+$importdata = preg_replace(&quot;/\n--------\n/&quot;, &quot;--MT-ENTRY--&quot;, $importdata);
+$authors = array();
+$temp = array();
+$posts = explode(&quot;--MT-ENTRY--&quot;, $importdata);
+unset( $importdata ); // Free up memory
+
+$i = -1;
+echo &quot;&lt;ol&gt;&quot;;
+foreach ($posts as $post) { if ('' != trim($post)) {
+	++$i;
+	unset($post_categories);
+	echo &quot;&lt;li&gt;Processing post... &quot;;
+
+	// Take the pings out first
+	preg_match(&quot;|(-----\n\nPING:.*)|s&quot;, $post, $pings);
+	$post = preg_replace(&quot;|(-----\n\nPING:.*)|s&quot;, '', $post);
+
+	// Then take the comments out
+	preg_match(&quot;|(-----\nCOMMENT:.*)|s&quot;, $post, $comments);
+	$post = preg_replace(&quot;|(-----\nCOMMENT:.*)|s&quot;, '', $post);
+	
+	// We ignore the keywords
+	$post = preg_replace(&quot;|(-----\nKEYWORDS:.*)|s&quot;, '', $post);
+	
+	// We want the excerpt
+	preg_match(&quot;|-----\nEXCERPT:(.*)|s&quot;, $post, $excerpt);
+	$excerpt = addslashes(trim($excerpt[1]));
+	$post = preg_replace(&quot;|(-----\nEXCERPT:.*)|s&quot;, '', $post);
+	
+	// We're going to put extended body into main body with a more tag
+	preg_match(&quot;|-----\nEXTENDED BODY:(.*)|s&quot;, $post, $extended);
+	$extended = trim($extended[1]);
+	if ('' != $extended) $extended = &quot;\n&lt;!--more--&gt;\n$extended&quot;;
+	$post = preg_replace(&quot;|(-----\nEXTENDED BODY:.*)|s&quot;, '', $post);
+	
+	// Now for the main body
+	preg_match(&quot;|-----\nBODY:(.*)|s&quot;, $post, $body);
+	$body = trim($body[1]);
+	$post_content = addslashes($body . $extended);
+	$post = preg_replace(&quot;|(-----\nBODY:.*)|s&quot;, '', $post);
+	
+	// Grab the metadata from what's left
+	$metadata = explode(&quot;\n&quot;, $post);
+	foreach ($metadata as $line) {
+		preg_match(&quot;/^(.*?):(.*)/&quot;, $line, $token);
+		$key = trim($token[1]);
+		$value = trim($token[2]);
+		// Now we decide what it is and what to do with it
+        switch($key) {
+			case '':
+				break;
+            case 'AUTHOR':
+                $post_author = $value;
+                break;
+            case 'TITLE':
+                $post_title = addslashes($value);
+				echo '&lt;i&gt;'.stripslashes($post_title).'&lt;/i&gt;... ';
+				$post_name = sanitize_title($post_title);
+                break;
+            case 'STATUS':
+                // &quot;publish&quot; and &quot;draft&quot; enumeration items match up; no change required
+                $post_status = $value;
+				if (empty($post_status)) $post_status = 'publish';
+                break;
+            case 'ALLOW COMMENTS':
+                $post_allow_comments = $value;
+                if ($post_allow_comments == 1) {
+                    $comment_status = 'open';
+                } else {
+                    $comment_status = 'closed';
+                }
+                break;
+            case 'CONVERT BREAKS':
+                $post_convert_breaks = $value;
+                break;
+            case 'ALLOW PINGS':
+                $post_allow_pings = trim($meta[2][0]);
+                if ($post_allow_pings == 1) {
+                    $post_allow_pings = 'open';
+                } else {
+                    $post_allow_pings = 'closed';
+                }
+                break;
+            case 'PRIMARY CATEGORY':
+				$post_categories[] = addslashes($value);
+                break;
+            case 'CATEGORY':    
+				$post_categories[] = addslashes($value);
+                break;
+			case 'DATE':
+				$post_date = strtotime($value);
+				$post_date = date('Y-m-d H:i:s', $post_date);
+				$post_date_gmt = get_gmt_from_date(&quot;$post_date&quot;);
+				break;
+			default:
+//				echo &quot;\n$key: $value&quot;;
+				break;
+        } // end switch
+	} // End foreach
+
+	// Let's check to see if it's in already
+	if ($wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$post_title' AND post_date = '$post_date'&quot;)) {
+		echo &quot;Post already imported.&quot;;
+	} else {
+		$post_author = checkauthor($post_author);//just so that if a post already exists, new users are not created by checkauthor
+	    $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;posts (
+			post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt,  post_status, comment_status, ping_status, post_name, post_modified, post_modified_gmt)
+			VALUES 
+			('$post_author', '$post_date', '$post_date_gmt', '$post_content', '$post_title', '$excerpt', '$post_status', '$comment_status', '$ping_status', '$post_name','$post_date', '$post_date_gmt')&quot;);
+		$post_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$post_title' AND post_date = '$post_date'&quot;);
+		if (0 != count($post_categories)) {
+			foreach ($post_categories as $post_category) {
+			// See if the category exists yet
+			$cat_id = $wpdb-&gt;get_var(&quot;SELECT cat_ID from $wpdb-&gt;categories WHERE cat_name = '$post_category'&quot;);
+			if (!$cat_id &amp;&amp; '' != trim($post_category)) {
+				$cat_nicename = sanitize_title($post_category);
+				$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;categories (cat_name, category_nicename) VALUES ('$post_category', '$cat_nicename')&quot;);
+				$cat_id = $wpdb-&gt;get_var(&quot;SELECT cat_ID from $wpdb-&gt;categories WHERE cat_name = '$post_category'&quot;);
+			}
+			if ('' == trim($post_category)) $cat_id = 1;
+			// Double check it's not there already
+			$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_id AND category_id = $cat_id&quot;);
+
+			 if (!$exists) { 
+				$wpdb-&gt;query(&quot;
+				INSERT INTO $wpdb-&gt;post2cat
+				(post_id, category_id)
+				VALUES
+				($post_id, $cat_id)
+				&quot;);
+			}
+		} // end category loop
+		} else {
+			$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_id AND category_id = 1&quot;);
+			if (!$exists) $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;post2cat (post_id, category_id) VALUES ($post_id, 1) &quot;);
+		}
+		echo &quot; Post imported successfully...&quot;;
+		// Now for comments
+		$comments = explode(&quot;-----\nCOMMENT:&quot;, $comments[0]);
+		foreach ($comments as $comment) {
+		if ('' != trim($comment)) {
+			// Author
+			preg_match(&quot;|AUTHOR:(.*)|&quot;, $comment, $comment_author);
+			$comment_author = addslashes(trim($comment_author[1]));
+			$comment = preg_replace('|(\n?AUTHOR:.*)|', '', $comment);
+
+			preg_match(&quot;|EMAIL:(.*)|&quot;, $comment, $comment_email);
+			$comment_email = addslashes(trim($comment_email[1]));
+			$comment = preg_replace('|(\n?EMAIL:.*)|', '', $comment);
+
+			preg_match(&quot;|IP:(.*)|&quot;, $comment, $comment_ip);
+			$comment_ip = trim($comment_ip[1]);
+			$comment = preg_replace('|(\n?IP:.*)|', '', $comment);
+
+			preg_match(&quot;|URL:(.*)|&quot;, $comment, $comment_url);
+			$comment_url = addslashes(trim($comment_url[1]));
+			$comment = preg_replace('|(\n?URL:.*)|', '', $comment);
+
+			preg_match(&quot;|DATE:(.*)|&quot;, $comment, $comment_date);
+			$comment_date = trim($comment_date[1]);
+			$comment_date = date('Y-m-d H:i:s', strtotime($comment_date));
+			$comment = preg_replace('|(\n?DATE:.*)|', '', $comment);
+
+			$comment_content = addslashes(trim($comment));
+			$comment_content = str_replace('-----', '', $comment_content);
+
+			// Check if it's already there
+			if (!$wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_date = '$comment_date' AND comment_content = '$comment_content'&quot;)) {
+				$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;comments (comment_post_ID, comment_author, comment_author_email, comment_author_url, comment_author_IP, comment_date, comment_content, comment_approved)
+				VALUES
+				($post_id, '$comment_author', '$comment_email', '$comment_url', '$comment_ip', '$comment_date', '$comment_content', '1')&quot;);
+				echo &quot; Comment added.&quot;;
+			}
+		}
+		}
+
+		// Finally the pings
+		// fix the double newline on the first one
+		$pings[0] = str_replace(&quot;-----\n\n&quot;, &quot;-----\n&quot;, $pings[0]);
+		$pings = explode(&quot;-----\nPING:&quot;, $pings[0]);
+		foreach ($pings as $ping) {
+		if ('' != trim($ping)) {
+			// 'Author'
+			preg_match(&quot;|BLOG NAME:(.*)|&quot;, $ping, $comment_author);
+			$comment_author = addslashes(trim($comment_author[1]));
+			$ping = preg_replace('|(\n?BLOG NAME:.*)|', '', $ping);
+
+			$comment_email = '';
+
+			preg_match(&quot;|IP:(.*)|&quot;, $ping, $comment_ip);
+			$comment_ip = trim($comment_ip[1]);
+			$ping = preg_replace('|(\n?IP:.*)|', '', $ping);
+
+			preg_match(&quot;|URL:(.*)|&quot;, $ping, $comment_url);
+			$comment_url = addslashes(trim($comment_url[1]));
+			$ping = preg_replace('|(\n?URL:.*)|', '', $ping);
+
+			preg_match(&quot;|DATE:(.*)|&quot;, $ping, $comment_date);
+			$comment_date = trim($comment_date[1]);
+			$comment_date = date('Y-m-d H:i:s', strtotime($comment_date));
+			$ping = preg_replace('|(\n?DATE:.*)|', '', $ping);
+      
+ 			preg_match(&quot;|TITLE:(.*)|&quot;, $ping, $ping_title);
+			$ping_title = addslashes(trim($ping_title[1]));
+			$ping = preg_replace('|(\n?TITLE:.*)|', '', $ping);
+
+			$comment_content = addslashes(trim($ping));
+			$comment_content = str_replace('-----', '', $comment_content);
+			
+			$comment_content = &quot;&lt;strong&gt;$ping_title&lt;/strong&gt;\n\n$comment_content&quot;;
+      
+			// Check if it's already there
+			if (!$wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_date = '$comment_date' AND comment_content = '$comment_content'&quot;)) {
+				$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;comments (comment_post_ID, comment_author, comment_author_email, comment_author_url, comment_author_IP, comment_date, comment_content, comment_approved, comment_type)
+				VALUES
+				($post_id, '$comment_author', '$comment_email', '$comment_url', '$comment_ip', '$comment_date', '$comment_content', '1', 'trackback')&quot;);
+				echo &quot; Comment added.&quot;;
+			}
+
+		}
+		}
+	}
+	echo &quot;&lt;/li&gt;&quot;;
+	flush();
+
+} }
+upgrade_all();
+?&gt;
+&lt;/ol&gt;
+&lt;h3&gt;All done. &lt;a href=&quot;../&quot;&gt;Have fun!&lt;/a&gt;&lt;/h3&gt;
+&lt;?php
+	break;
+}
+?&gt; 
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/import-rss.php
===================================================================
--- trunk/wp-admin/import-rss.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-rss.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,191 @@
+&lt;?php
+define('RSSFILE', '');
+// Example:
+// define('RSSFILE', '/home/example/public_html/rss.xml');
+// or if it's in the same directory as import-rss.php
+// define('RSSFILE', 'rss.xml');
+
+$post_author = 1; // Author to import posts as author ID
+$timezone_offset = 0; // GMT offset of posts your importing
+
+function unhtmlentities($string) { // From php.net for &lt; 4.3 compat
+   $trans_tbl = get_html_translation_table(HTML_ENTITIES);
+   $trans_tbl = array_flip($trans_tbl);
+   return strtr($string, $trans_tbl);
+}
+
+$add_hours = intval($timezone_offset);
+$add_minutes = intval(60 * ($timezone_offset - $add_hours));
+
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. You must install WordPress before you import any entries.&quot;);
+require('../wp-config.php');
+
+$step = $_GET['step'];
+if (!$step) $step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;title&gt;WordPress &rsaquo; Import from RSS&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/logo.png">http://wordpress.org/images/logo.png</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		text-decoration: none;
+		text-indent: -100em;
+		height: 60px;
+	}
+	p {
+		line-height: 140%;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt; 
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt; 
+&lt;p&gt;Howdy! This importer allows you to extract posts from any RSS 2.0 file into your blog. This is useful if you want to import your posts from a system that is not handled by a custom import tool. To get started you must edit the following line in this file (&lt;code&gt;import-rss.php&lt;/code&gt;) &lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('RSSFILE', '');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;You want to define where the RSS file we'll be working with is, for example: &lt;/p&gt;
+&lt;p&gt;&lt;code&gt;define('RSSFILE', 'rss.xml');&lt;/code&gt;&lt;/p&gt;
+&lt;p&gt;You have to do this manually for security reasons. When you're done reload this page and we'll take you to the next step.&lt;/p&gt;
+&lt;?php if ('' != RSSFILE) : ?&gt;
+&lt;h2 style=&quot;text-align: right;&quot;&gt;&lt;a href=&quot;import-rss.php?step=1&quot;&gt;Begin RSS Import &raquo;&lt;/a&gt;&lt;/h2&gt;
+&lt;?php endif; ?&gt;
+&lt;?php
+	break;
+
+	case 1:
+
+// Bring in the data
+set_magic_quotes_runtime(0);
+$datalines = file(RSSFILE); // Read the file into an array
+$importdata = implode('', $datalines); // squish it
+$importdata = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $importdata);
+
+preg_match_all('|&lt;item&gt;(.*?)&lt;/item&gt;|is', $importdata, $posts);
+$posts = $posts[1];
+
+echo '&lt;ol&gt;';
+foreach ($posts as $post) :
+$title = $date = $categories = $content = $post_id =  '';
+echo &quot;&lt;li&gt;Importing post... &quot;;
+
+preg_match('|&lt;title&gt;(.*?)&lt;/title&gt;|is', $post, $title);
+$title = addslashes( trim($title[1]) );
+$post_name = sanitize_title($title);
+
+preg_match('|&lt;pubdate&gt;(.*?)&lt;/pubdate&gt;|is', $post, $date);
+
+if ($date) :
+	$date = strtotime($date[1]);
+else : // if we don't already have something from pubDate
+	preg_match('|&lt;dc:date&gt;(.*?)&lt;/dc:date&gt;|is', $post, $date);
+	$date = preg_replace('|([-+])([0-9]+):([0-9]+)$|', '\1\2\3', $date[1]);
+	$date = str_replace('T', ' ', $date);
+	$date = strtotime($date);
+endif;
+
+$post_date = gmdate('Y-m-d H:i:s', $date);
+
+preg_match_all('|&lt;category&gt;(.*?)&lt;/category&gt;|is', $post, $categories);
+$categories = $categories[1];
+
+if (!$categories) :
+	preg_match_all('|&lt;dc:subject&gt;(.*?)&lt;/dc:subject&gt;|is', $post, $categories);
+	$categories = $categories[1];
+endif;
+
+preg_match('|&lt;guid.+?&gt;(.*?)&lt;/guid&gt;|is', $post, $guid);
+if ($guid) $guid = addslashes( trim($guid[1]) );
+else $guid = '';
+
+preg_match('|&lt;content:encoded&gt;(.*?)&lt;/content:encoded&gt;|is', $post, $content);
+$content = str_replace( array('&lt;![CDATA[', ']]&gt;'), '', addslashes( trim($content[1]) ) );
+
+if (!$content) : // This is for feeds that put content in description
+	preg_match('|&lt;description&gt;(.*?)&lt;/description&gt;|is', $post, $content);
+	$content = $wpdb-&gt;escape( unhtmlentities( trim($content[1]) ) );
+endif;
+
+// Clean up content
+$content = preg_replace('|&lt;(/?[A-Z]+)|e', &quot;'&lt;' . strtolower('$1')&quot;, $content);
+$content = str_replace('&lt;br&gt;', '&lt;br /&gt;', $content);
+$content = str_replace('&lt;hr&gt;', '&lt;hr /&gt;', $content);
+
+// This can mess up on posts with no titles, but checking content is much slower
+// So we do it as a last resort
+if ('' == $title) : 
+	$dupe = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_content = '$content' AND post_date = '$post_date'&quot;);
+else :
+	$dupe = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$title' AND post_date = '$post_date'&quot;);
+endif;
+
+// Now lets put it in the DB
+if ($dupe) :
+	echo 'Post already imported';
+else : 
+	
+	$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;posts 
+		(post_author, post_date, post_date_gmt, post_content, post_title,post_status, comment_status, ping_status, post_name, guid)
+		VALUES 
+		('$post_author', '$post_date', DATE_ADD('$post_date', INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE), '$content', '$title', 'publish', '$comment_status', '$ping_status', '$post_name', '$guid')&quot;);
+	$post_id = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title = '$title' AND post_date = '$post_date'&quot;);
+	if (!$post_id) die(&quot;couldn't get post ID&quot;);
+	if (0 != count($categories)) :
+		foreach ($categories as $post_category) :
+		$post_category = unhtmlentities($post_category);
+		// See if the category exists yet
+		$cat_id = $wpdb-&gt;get_var(&quot;SELECT cat_ID from $wpdb-&gt;categories WHERE cat_name = '$post_category'&quot;);
+		if (!$cat_id &amp;&amp; '' != trim($post_category)) {
+			$cat_nicename = sanitize_title($post_category);
+			$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;categories (cat_name, category_nicename) VALUES ('$post_category', '$cat_nicename')&quot;);
+			$cat_id = $wpdb-&gt;get_var(&quot;SELECT cat_ID from $wpdb-&gt;categories WHERE cat_name = '$post_category'&quot;);
+		}
+		if ('' == trim($post_category)) $cat_id = 1;
+		// Double check it's not there already
+		$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_id AND category_id = $cat_id&quot;);
+	
+		 if (!$exists) { 
+			$wpdb-&gt;query(&quot;
+			INSERT INTO $wpdb-&gt;post2cat
+			(post_id, category_id)
+			VALUES
+			($post_id, $cat_id)
+			&quot;);
+			}
+	endforeach;
+	else:
+		$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_id AND category_id = 1&quot;);
+		if (!$exists) $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;post2cat (post_id, category_id) VALUES ($post_id, 1) &quot;);
+	endif;
+	echo 'Done!&lt;/li&gt;';
+endif;
+
+
+endforeach;
+?&gt;
+&lt;/ol&gt;
+
+&lt;h3&gt;All done. &lt;a href=&quot;../&quot;&gt;Have fun!&lt;/a&gt;&lt;/h3&gt;
+&lt;?php
+	break;
+}
+?&gt; 
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-admin/import-textpattern.php
===================================================================
--- trunk/wp-admin/import-textpattern.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/import-textpattern.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,138 @@
+&lt;?php
+
+// For security reasons, fill in the connection details to your Textpattern database below:
+
+$tp_database_name = 'textpattern';
+$tp_database_username = 'username';
+$tp_database_password = 'password';
+$tp_database_host = 'localhost';
+
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. Double check that you updated wp-config-sample.php with the proper database connection information and renamed it to wp-config.php.&quot;);
+require('../wp-config.php');
+require('upgrade-functions.php');
+
+$step = $_GET['step'];
+if (!$step) $step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;title&gt;WordPress &rsaquo; Textpattern Import&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 15%;
+		margin-right: 15%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/wordpress.gif">http://wordpress.org/images/wordpress.gif</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		text-decoration: none;
+		text-indent: -100em;
+		height: 60px;
+	}
+	p {
+		line-height: 140%;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt; 
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt; 
+&lt;p&gt;This script imports your entries from Textpattern into WordPress. It should be relatively painless, and we hope you're happy with the result.&lt;/p&gt;
+&lt;p&gt;To run this, you first need to edit this file (&lt;code&gt;import-textpattern.php&lt;/code&gt;) and enter your Textpattern database connection details. Let's check if the database connection information works...&lt;/p&gt;
+&lt;?php
+$connection = @mysql_connect($tp_database_host, $tp_database_username, $tp_database_password);
+$database = @mysql_select_db($tp_database_name);
+if ($connection &amp;&amp; $database) {
+?&gt;
+&lt;p&gt;Everything seems dandy so far, &lt;a href=&quot;?step=1&quot;&gt;let's get started&lt;/a&gt;!&lt;/p&gt;
+&lt;?php
+} else {
+?&gt;
+&lt;p&gt;&lt;em&gt;It looks like your database information is incorrect. Please re-edit this file and double-check all the settings.&lt;/em&gt;&lt;/p&gt;
+&lt;?php
+}
+	break;
+	
+	case 1:
+?&gt; 
+&lt;h1&gt;Step 1&lt;/h1&gt; 
+&lt;p&gt;First let's get posts and comments.&lt;/p&gt; 
+&lt;?php
+// For people running this on .72
+$query = &quot;ALTER TABLE `$wpdb-&gt;posts` ADD `post_name` VARCHAR(200) NOT NULL&quot;;
+maybe_add_column($wpdb-&gt;posts, 'post_name', $query);
+
+// Create post_name field
+$connection = @mysql_connect($tp_database_host, $tp_database_username, $tp_database_password);
+$database = @mysql_select_db($tp_database_name);
+
+// For now we're going to give everything the same author and same category
+$author = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_level = 10 LIMIT 1&quot;);
+$category = $wpdb-&gt;get_var(&quot;SELECT cat_ID FROM $wpdb-&gt;categories LIMIT 1&quot;);
+
+$posts = mysql_query('SELECT * FROM textpattern', $connection);
+
+while ($post = mysql_fetch_array($posts)) {
+	//  ID, AuthorID, LastMod, LastModID, Posted, Title, Body, Body_html, Abstract, Category1, Category2, Annotate, AnnotateInvite, Status, Listing1, Listing2, Section
+	$posted = $post['Posted'];
+	// 20030216162119
+	$year = substr($posted,0,4);
+	$month = substr($posted,4,2);
+	$day = substr($posted,6,2);
+	$hour = substr($posted,8,2);
+	$minute = substr($posted,10,2);
+	$second = substr($posted,12,2);
+	$timestamp = mktime($hour, $minute, $second, $month, $day, $year);
+	$posted = date('Y-m-d H:i:s', $timestamp);
+	
+	$content = addslashes($post['Body_html']);
+	$title = addslashes($post['Title']);
+	$post_name = sanitize_title($title);
+
+	$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;posts
+		(post_author, post_date, post_content, post_title, post_category, post_name, post_status)
+		VALUES
+		('$author', '$posted', '$content', '$title', '$category', '$post_name', 'publish')&quot;);
+
+	// Get wordpress post id
+	$wp_post_ID = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts ORDER BY ID DESC LIMIT 1&quot;);
+	
+	// Now let's insert comments if there are any for the TP post
+	$tp_id = $post['ID'];
+	$comments = mysql_query(&quot;SELECT * FROM txp_Discuss WHERE parentid = $tp_id&quot;);
+	if ($comments) {
+		while($comment = mysql_fetch_object($comments)) {
+			//  discussid, parentid, name, email, web, ip, posted, message
+			// For some reason here &quot;posted&quot; is a real MySQL date, so we don't have to do anything about it
+			//  comment_post_ID  	 comment_author  	 comment_author_email  	 comment_author_url  	 comment_author_IP  	 comment_date  	 comment_content  	 comment_karma
+			$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;comments
+				(comment_post_ID, comment_author, comment_author_email, comment_author_url, comment_author_IP, comment_date, comment_content)
+				VALUES
+				($wp_post_ID, '$comment-&gt;name', '$comment-&gt;email', '$comment-&gt;web', '$comment-&gt;ip', '$comment-&gt;posted', '$comment-&gt;message')&quot;);
+		}
+	}
+}
+
+upgrade_all();
+?&gt;
+&lt;p&gt;&lt;strong&gt;All done.&lt;/strong&gt; Wasn&#8217;t that fun? &lt;a href=&quot;../&quot;&gt;Have fun&lt;/a&gt;.&lt;/p&gt; 
+&lt;?php
+break;
+}
+?&gt; 
+
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/index.php
===================================================================
--- trunk/wp-admin/index.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/index.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,158 @@
+&lt;?php
+require_once('admin.php');
+$title = __('Dashboard');
+require_once('admin-header.php');
+require_once (ABSPATH . WPINC . '/rss-functions.php');
+
+$today = current_time('mysql', 1);
+?&gt;
+
+	&lt;div id=&quot;dashboard&quot;&gt;
+		&lt;h2&gt;&lt;?php _e('Latest Activity'); ?&gt;&lt;/h2&gt;
+&lt;?php
+if ( $recentposts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts WHERE post_status = 'publish' AND post_date_gmt &lt; '$today' ORDER BY post_date DESC LIMIT 5&quot;) )
+{
+?&gt;
+		&lt;h3&gt;&lt;?php _e('Posts'); ?&gt; &lt;a href=&quot;edit.php&quot; title=&quot;&lt;?php _e('More posts...'); ?&gt;&quot;&gt;Edit&lt;/a&gt;&lt;/h3&gt;
+		&lt;ul&gt;
+&lt;?php
+	foreach ($recentposts as $post)
+	{
+		if ($post-&gt;post_title == '')
+		{
+		$post-&gt;post_title = sprintf(__('Post #%s'), $post-&gt;ID);
+		}
+		echo &quot;&lt;li&gt;&lt;a href='post.php?action=edit&amp;post=$post-&gt;ID'&gt;&quot;;
+		the_title();
+		echo '&lt;/a&gt;&lt;/li&gt;';
+	}
+?&gt;
+		&lt;/ul&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;?php
+if ( $scheduled = $wpdb-&gt;get_results(&quot;SELECT ID, post_title, post_date_gmt FROM $wpdb-&gt;posts WHERE post_status = 'publish' AND post_date_gmt &gt; '$today'&quot;) )
+{
+?&gt;
+		&lt;h3&gt;&lt;?php _e('Scheduled Entries:') ?&gt;&lt;/h3&gt;
+		&lt;ul&gt;
+&lt;?php
+	foreach ($scheduled as $post)
+	{
+		if ($post-&gt;post_title == '')
+		{
+			$post-&gt;post_title = sprintf(__('Post #%s'), $post-&gt;ID);
+		}
+		echo &quot;&lt;li&gt;&quot; . sprintf(__('%1$s in %2$s'), &quot;&lt;a href='post.php?action=edit&amp;post=$post-&gt;ID' title='&quot; . __('Edit this post') . &quot;'&gt;$post-&gt;post_title&lt;/a&gt;&quot;, human_time_diff( current_time('timestamp', 1), strtotime($post-&gt;post_date_gmt. ' GMT') ))  . &quot;&lt;/li&gt;&quot;;
+	}
+?&gt;
+		&lt;/ul&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;?php
+if ( $comments = $wpdb-&gt;get_results(&quot;SELECT comment_author, comment_author_url, comment_ID, comment_post_ID FROM $wpdb-&gt;comments WHERE comment_approved = '1' ORDER BY comment_date_gmt DESC LIMIT 5&quot;) )
+{
+?&gt;
+		&lt;h3&gt;&lt;?php _e('Comments'); ?&gt; &lt;a href=&quot;edit-comments.php&quot; title=&quot;&lt;?php _e('More comments...'); ?&gt;&quot;&gt;&raquo;&lt;/a&gt;&lt;/h3&gt;
+		&lt;ul&gt;
+&lt;?php
+	foreach ($comments as $comment)
+	{
+		echo '&lt;li&gt;' . sprintf(__('%1$s on %2$s'), get_comment_author_link(), '&lt;a href=&quot;'. get_permalink($comment-&gt;comment_post_ID) . '#comment-' . $comment-&gt;comment_ID . '&quot;&gt;' . get_the_title($comment-&gt;comment_post_ID) . '&lt;/a&gt;');
+		edit_comment_link(__(&quot;Edit&quot;), ' &lt;small&gt;(', ')&lt;/small&gt;');
+		echo '&lt;/li&gt;';
+	}
+?&gt;
+		&lt;/ul&gt;
+&lt;?php
+	if ( $numcomments = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $tablecomments WHERE comment_approved = '0'&quot;) )
+	{
+?&gt;
+		&lt;p&gt;&lt;strong&gt;&lt;a href=&quot;moderation.php&quot;&gt;&lt;?php echo sprintf(__('There are comments in moderation (%s)'), number_format($numcomments) ); ?&gt; &raquo;&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
+&lt;?php
+	}
+?&gt;
+
+&lt;?php
+}
+?&gt;
+
+		&lt;h3&gt;&lt;?php _e('Blog Stats'); ?&gt;&lt;/h3&gt;
+&lt;?php
+$numposts = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;posts WHERE post_status = 'publish'&quot;);
+if (0 &lt; $numposts)
+{
+	$numposts = number_format($numposts);
+}
+
+$numcomms = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;comments WHERE comment_approved = '1'&quot;);
+if (0 &lt; $numcomms)
+{
+	$numcomms = number_format($numcomms);
+}
+
+$numcats = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;categories&quot;);
+if (0 &lt; $numcats)
+{
+	$numcats = number_format($numcats);
+}
+?&gt;
+		&lt;p&gt;&lt;?php printf(__('There are currently %1$s &lt;a href=&quot;%2$s&quot; title=&quot;Posts&quot;&gt;posts&lt;/a&gt; and %3$s &lt;a href=&quot;%4$s&quot; title=&quot;Comments&quot;&gt;comments&lt;/a&gt;, contained within %5$s &lt;a href=&quot;%6$s&quot; title=&quot;categories&quot;&gt;categories&lt;/a&gt;.'), $numposts, 'edit.php',  $numcomms, 'edit-comments.php', $numcats, 'categories.php'); ?&gt;&lt;/p&gt;
+
+&lt;?php
+$rss = @fetch_rss('<A HREF="http://feeds.technorati.com/cosmos/rss/?url=">http://feeds.technorati.com/cosmos/rss/?url=</A>'. trailingslashit(get_option('home')) .'&amp;partner=wordpress');
+if ( isset($rss-&gt;items) &amp;&amp; 0 != count($rss-&gt;items) )
+{
+?&gt;
+		&lt;div id=&quot;incominglinks&quot;&gt;
+			&lt;h3&gt;&lt;?php _e('Incoming Links'); ?&gt; &lt;cite&gt;&lt;a href=&quot;<A HREF="http://www.technorati.com/cosmos/search.html?url=&lt;?php">http://www.technorati.com/cosmos/search.html?url=&lt;?php</A> echo trailingslashit(get_option('home')); ?&gt;&amp;partner=wordpress&quot;&gt;&lt;?php _e('More'); ?&gt; &raquo;&lt;/a&gt;&lt;/cite&gt;&lt;/h3&gt;
+			&lt;ul&gt;
+&lt;?php
+	$rss-&gt;items = array_slice($rss-&gt;items, 0, 10);
+	foreach ($rss-&gt;items as $item )
+	{
+?&gt;
+				&lt;li&gt;&lt;a href=&quot;&lt;?php echo wp_filter_kses($item['link']); ?&gt;&quot;&gt;&lt;?php echo wp_specialchars($item['title']); ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;?php
+	}
+?&gt;
+			&lt;/ul&gt;
+		&lt;/div&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;/div&gt;
+&lt;?php
+$drafts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts WHERE post_status = 'draft' AND post_author = $user_ID&quot;);
+if ($drafts)
+{
+?&gt;
+	&lt;div class=&quot;wrap&quot;&gt;
+
+		&lt;p&gt;&lt;strong&gt;&lt;?php _e('Your Drafts:') ?&gt;&lt;/strong&gt;
+&lt;?php
+	$i = 0;
+	foreach ($drafts as $draft)
+	{
+		if (0 != $i)
+			echo ', ';
+		$draft-&gt;post_title = stripslashes($draft-&gt;post_title);
+		if ($draft-&gt;post_title == '')
+			$draft-&gt;post_title = sprintf(__('Post #%s'), $draft-&gt;ID);
+		echo &quot;&lt;a href='post.php?action=edit&amp;post=$draft-&gt;ID' title='&quot; . __('Edit this draft') . &quot;'&gt;$draft-&gt;post_title&lt;/a&gt;&quot;;
+		++$i;
+	}
+?&gt;
+    	&lt;/p&gt;
+	&lt;/div&gt;
+&lt;?php
+}
+?&gt;
+&lt;?php
+require('./admin-footer.php');
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/install-helper.php
===================================================================
--- trunk/wp-admin/install-helper.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/install-helper.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,152 @@
+&lt;?php
+require_once('../wp-config.php');
+$debug = 0;
+
+/**
+ ** maybe_create_table()
+ ** Create db table if it doesn't exist.
+ ** Returns:  true if already exists or on successful completion
+ **           false on error
+ */
+function maybe_create_table($table_name, $create_ddl) {
+    global $wpdb;
+    foreach ($wpdb-&gt;get_col(&quot;SHOW TABLES&quot;,0) as $table ) {
+        if ($table == $table_name) {
+            return true;
+        }
+    }
+    //didn't find it try to create it.
+    $q = $wpdb-&gt;query($create_ddl);
+    // we cannot directly tell that whether this succeeded!
+    foreach ($wpdb-&gt;get_col(&quot;SHOW TABLES&quot;,0) as $table ) {
+        if ($table == $table_name) {
+            return true;
+        }
+    }
+    return false;
+}
+
+/**
+ ** maybe_add_column()
+ ** Add column to db table if it doesn't exist.
+ ** Returns:  true if already exists or on successful completion
+ **           false on error
+ */
+function maybe_add_column($table_name, $column_name, $create_ddl) {
+    global $wpdb, $debug;
+    foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;,0) as $column ) {
+        if ($debug) echo(&quot;checking $column == $column_name&lt;br /&gt;&quot;);
+        if ($column == $column_name) {
+            return true;
+        }
+    }
+    //didn't find it try to create it.
+    $q = $wpdb-&gt;query($create_ddl);
+    // we cannot directly tell that whether this succeeded!
+    foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;,0) as $column ) {
+        if ($column == $column_name) {
+            return true;
+        }
+    }
+    return false;
+}
+
+
+/**
+ ** maybe_drop_column()
+ ** Drop column from db table if it exists.
+ ** Returns:  true if it doesn't already exist or on successful drop
+ **           false on error
+ */
+function maybe_drop_column($table_name, $column_name, $drop_ddl) {
+    global $wpdb;
+    foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;,0) as $column ) {
+        if ($column == $column_name) {
+            //found it try to drop it.
+            $q = $wpdb-&gt;query($drop_ddl);
+            // we cannot directly tell that whether this succeeded!
+            foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;,0) as $column ) {
+                if ($column == $column_name) {
+                    return false;
+                }
+            }
+        }
+    }
+    // else didn't find it
+    return true;
+}
+
+
+/**
+ ** check_column()
+ ** Check column matches passed in criteria.
+ ** Pass in null to skip checking that criteria
+ ** Returns:  true if it matches
+ **           false otherwise
+ ** (case sensitive) Column names returned from DESC table are:
+ **      Field
+ **      Type
+ **      Null
+ **      Key
+ **      Default
+ **      Extra
+ */
+function check_column($table_name, $col_name, $col_type, $is_null = null, $key = null, $default = null, $extra = null) {
+    global $wpdb, $debug;
+    $diffs = 0;
+    $results = $wpdb-&gt;get_results(&quot;DESC $table_name&quot;);
+    
+    foreach ($results as $row ) {
+        if ($debug &gt; 1) print_r($row);
+        if ($row-&gt;Field == $col_name) {
+            // got our column, check the params
+            if ($debug) echo (&quot;checking $row-&gt;Type against $col_type\n&quot;);
+            if (($col_type != null) &amp;&amp; ($row-&gt;Type != $col_type)) {
+                ++$diffs;
+            }
+            if (($is_null != null) &amp;&amp; ($row-&gt;Null != $is_null)) {
+                ++$diffs;
+            }
+            if (($key != null) &amp;&amp; ($row-&gt;Key  != $key)) {
+                ++$diffs;
+            }
+            if (($default != null) &amp;&amp; ($row-&gt;Default != $default)) {
+                ++$diffs;
+            }
+            if (($extra != null) &amp;&amp; ($row-&gt;Extra != $extra)) {
+                ++$diffs;
+            }
+            if ($diffs &gt; 0) {
+                if ($debug) echo (&quot;diffs = $diffs returning false\n&quot;);
+                return false;
+            }
+            return true;
+        } // end if found our column
+    }
+    return false;
+}
+    
+/*
+echo &quot;&lt;p&gt;testing&lt;/p&gt;&quot;;
+echo &quot;&lt;pre&gt;&quot;;
+
+//check_column('wp_links', 'link_description', 'mediumtext'); 
+//if (check_column($wpdb-&gt;comments, 'comment_author', 'tinytext'))
+//    echo &quot;ok\n&quot;;
+$error_count = 0;
+$tablename = $wpdb-&gt;links;
+// check the column
+if (!check_column($wpdb-&gt;links, 'link_description', 'varchar(255)'))
+{
+    $ddl = &quot;ALTER TABLE $wpdb-&gt;links MODIFY COLUMN link_description varchar(255) NOT NULL DEFAULT '' &quot;;
+    $q = $wpdb-&gt;query($ddl);
+}
+if (check_column($wpdb-&gt;links, 'link_description', 'varchar(255)')) {
+    $res .= $tablename . ' - ok &lt;br /&gt;';
+} else {
+    $res .= 'There was a problem with ' . $tablename . '&lt;br /&gt;';
+    ++$error_count;
+}
+echo &quot;&lt;/pre&gt;&quot;;
+*/
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/install.php
===================================================================
--- trunk/wp-admin/install.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/install.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,207 @@
+&lt;?php
+define('WP_INSTALLING', true);
+if (!file_exists('../wp-config.php'))
+    die(&quot;There doesn't seem to be a &lt;code&gt;wp-config.php&lt;/code&gt; file. I need this before we can get started. Need more help? &lt;a href='<A HREF="http://wordpress.org/docs/faq/#wp-config">http://wordpress.org/docs/faq/#wp-config</A>'&gt;We got it&lt;/a&gt;. You can &lt;a href='setup-config.php'&gt;create a &lt;code&gt;wp-config.php&lt;/code&gt; file through a web interface&lt;/a&gt;, but this doesn't work for all server setups. The safest way is to manually create the file.&quot;);
+
+require_once('../wp-config.php');
+require_once('./upgrade-functions.php');
+
+$guessurl = str_replace('/wp-admin/install.php?step=2', '', '<A HREF="http://">http://</A>' . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']) );
+
+if (isset($_GET['step']))
+	$step = $_GET['step'];
+else
+	$step = 0;
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;&lt;?php _e('SteamPress &rsaquo; Installation'); ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+	&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	&lt;!--
+	html {
+		background: #eee;
+	}
+	body {
+		background: #fff;
+		color: #000;
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+		padding: .2em 2em;
+	}
+
+	h1 {
+		color: #006;
+		font-size: 18px;
+		font-weight: lighter;
+	}
+
+	h2 {
+		font-size: 16px;
+	}
+
+	p, li, dt {
+		line-height: 140%;
+		padding-bottom: 2px;
+	}
+
+	ul, ol {
+		padding: 5px 5px 5px 20px;
+	}
+	#logo {
+		margin-bottom: 2em;
+	}
+	.step a, .step input {
+		font-size: 2em;
+	}
+	td input {
+		font-size: 1.5em;
+	}
+	.step, th {
+		text-align: right;
+	}
+	#footer {
+		text-align: center;
+		border-top: 1px solid #ccc;
+		padding-top: 1em;
+		font-style: italic;
+	}
+	--&gt;
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;h1 id=&quot;logo&quot;&gt;SteamPress&lt;/h1&gt;
+&lt;?php
+// Let's check to make sure WP isn't already installed.
+$wpdb-&gt;hide_errors();
+$installed = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;users&quot;);
+if ($installed) die(__('&lt;h1&gt;Already Installed&lt;/h1&gt;&lt;p&gt;You appear to have already installed SteamPress. To reinstall please clear your old database tables first.&lt;/p&gt;') . '&lt;/body&gt;&lt;/html&gt;');
+$wpdb-&gt;show_errors();
+
+switch($step) {
+
+	case 0:
+?&gt;
+&lt;p&gt;&lt;?php printf(__('Welcome to SteamPress installation. We&#8217;re now going to go through a few steps to get you up and running with the latest in personal publishing platforms. You may want to peruse the &lt;a href=&quot;%s&quot;&gt;ReadMe documentation&lt;/a&gt; at your leisure.'), '../readme.html'); ?&gt;&lt;/p&gt;
+	&lt;h2 class=&quot;step&quot;&gt;&lt;a href=&quot;install.php?step=1&quot;&gt;&lt;?php _e('First Step &raquo;'); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+&lt;?php
+	break;
+
+	case 1:
+
+?&gt;
+&lt;h1&gt;&lt;?php _e('First Step'); ?&gt;&lt;/h1&gt;
+&lt;p&gt;&lt;?php _e(&quot;Before we begin we need a little bit of information. Don't worry, you can always change these later.&quot;); ?&gt;&lt;/p&gt;
+
+&lt;form id=&quot;setup&quot; method=&quot;post&quot; action=&quot;install.php?step=2&quot;&gt;
+&lt;table width=&quot;100%&quot;&gt;
+&lt;tr&gt;
+&lt;th width=&quot;33%&quot;&gt;&lt;?php _e('Weblog title:'); ?&gt;&lt;/th&gt;
+&lt;td&gt;&lt;input name=&quot;weblog_title&quot; type=&quot;text&quot; id=&quot;weblog_title&quot; size=&quot;25&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;th&gt;&lt;?php _e('Your e-mail:'); ?&gt;&lt;/th&gt;
+	&lt;td&gt;&lt;input name=&quot;admin_email&quot; type=&quot;text&quot; id=&quot;admin_email&quot; size=&quot;25&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
+&lt;p&gt;&lt;em&gt;&lt;?php _e('Double-check that email address before continuing.'); ?&gt;&lt;/em&gt;&lt;/p&gt;
+&lt;h2 class=&quot;step&quot;&gt;
+&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Continue to Second Step &raquo;'); ?&gt;&quot; /&gt;
+&lt;/h2&gt;
+&lt;/form&gt;
+
+&lt;?php
+	break;
+	case 2:
+
+// Fill in the data we gathered
+$weblog_title = $_POST['weblog_title'];
+$admin_email = $_POST['admin_email'];
+// check e-mail address
+if (empty($admin_email)) {
+	die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: please type your e-mail address&quot;));
+} else if (!is_email($admin_email)) {
+	die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: the e-mail address isn't correct&quot;));
+}
+
+?&gt;
+&lt;h1&gt;&lt;?php _e('Second Step'); ?&gt;&lt;/h1&gt;
+&lt;p&gt;&lt;?php _e('Now we&#8217;re going to create the database tables and fill them with some default data.'); ?&gt;&lt;/p&gt;
+
+
+&lt;?php
+flush();
+
+// Set everything up
+make_db_current_silent();
+populate_options();
+
+$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = '$weblog_title' WHERE option_name = 'blogname'&quot;);
+$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = '$admin_email' WHERE option_name = 'admin_email'&quot;);
+
+// Now drop in some default links
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;linkcategories (cat_id, cat_name) VALUES (1, '&quot;.addslashes(__('Blogroll')).&quot;')&quot;);
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;links (link_url, link_name, link_category, link_rss) VALUES ('<A HREF="http://steamedpenguin.com/journal/">http://steamedpenguin.com/journal/</A>', 'Samir', 1, '<A HREF="http://steamedpenguin.com/journal/feed/">http://steamedpenguin.com/journal/feed/</A>');&quot;);
+
+// Default category
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;categories (cat_ID, cat_name, category_nicename) VALUES ('0', '&quot;.addslashes(__('Uncategorized')).&quot;', '&quot;.sanitize_title(__('Uncategorized')).&quot;')&quot;);
+
+// First post
+$now = date('Y-m-d H:i:s');
+$now_gmt = gmdate('Y-m-d H:i:s');
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;posts (post_author, post_date, post_date_gmt, post_content, post_title, post_category, post_name, post_modified, post_modified_gmt) VALUES ('1', '$now', '$now_gmt', '&quot;.addslashes(__('Welcome to SteamPress. This is your first post. Edit or delete it, then start blogging!')).&quot;', '&quot;.addslashes(__('Hello world!')).&quot;', '0', '&quot;.addslashes(__('hello-world')).&quot;', '$now', '$now_gmt')&quot;);
+
+$wpdb-&gt;query( &quot;INSERT INTO $wpdb-&gt;post2cat (`rel_id`, `post_id`, `category_id`) VALUES (1, 1, 1)&quot; );
+
+// Default comment
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;comments (comment_post_ID, comment_author, comment_author_email, comment_author_url, comment_author_IP, comment_date, comment_date_gmt, comment_content) VALUES ('1', '&quot;.addslashes(__('Mr SteamPress')).&quot;', '', '<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>', '127.0.0.1', '$now', '$now_gmt', '&quot;.addslashes(__('Hi, this is a comment.&lt;br /&gt;To delete a comment, just log in, and view the posts\' comments, there you will have the option to edit or delete them.')).&quot;')&quot;);
+
+// Set up admin user
+$random_password = substr(md5(uniqid(microtime())), 0, 6);
+$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;users (ID, user_login, user_pass, user_nickname, user_email, user_level, user_idmode, user_registered) VALUES ( '1', 'admin', MD5('$random_password'), '&quot;.addslashes(__('Administrator')).&quot;', '$admin_email', '10', 'nickname', NOW() )&quot;);
+
+$message_headers = 'From: ' . stripslashes($_POST['weblog_title']) . ' &lt;wordpress@' . $_SERVER['SERVER_NAME'] . '&gt;';
+$message = sprintf(__(&quot;Your new SteamPress blog has been successfully set up at:
+
+%1\$s
+
+You can log in to the administrator account with the following information:
+
+Username: admin
+Password: %2\$s
+
+We hope you enjoy your new weblog. Thanks!
+
+--The SteamPress Team
+<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>
+&quot;), $guessurl, $random_password);
+
<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">+ at mail</A>($admin_email, __('New SteamPress Blog'), $message, $message_headers);
+
+upgrade_all();
+?&gt;
+
+&lt;p&gt;&lt;em&gt;&lt;?php _e('Finished!'); ?&gt;&lt;/em&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;?php printf(__('Now you can &lt;a href=&quot;%1$s&quot;&gt;log in&lt;/a&gt; with the &lt;strong&gt;username&lt;/strong&gt; &quot;&lt;code&gt;admin&lt;/code&gt;&quot; and &lt;strong&gt;password&lt;/strong&gt; &quot;&lt;code&gt;%2$s&lt;/code&gt;&quot;.'), '../wp-login.php', $random_password); ?&gt;&lt;/p&gt;
+&lt;p&gt;&lt;?php _e('&lt;strong&gt;&lt;em&gt;Note that password&lt;/em&gt;&lt;/strong&gt; carefully! It is a &lt;em&gt;random&lt;/em&gt; password that was generated just for you. If you lose it, you will have to delete the tables from the database yourself, and re-install SteamPress. So to review:'); ?&gt;
+&lt;/p&gt;
+&lt;dl&gt;
+&lt;dt&gt;&lt;?php _e('Username'); ?&gt;&lt;/dt&gt;
+&lt;dd&gt;&lt;code&gt;admin&lt;/code&gt;&lt;/dd&gt;
+&lt;dt&gt;&lt;?php _e('Password'); ?&gt;&lt;/dt&gt;
+&lt;dd&gt;&lt;code&gt;&lt;?php echo $random_password; ?&gt;&lt;/code&gt;&lt;/dd&gt;
+	&lt;dt&gt;&lt;?php _e('Login address'); ?&gt;&lt;/dt&gt;
+&lt;dd&gt;&lt;a href=&quot;../wp-login.php&quot;&gt;wp-login.php&lt;/a&gt;&lt;/dd&gt;
+&lt;/dl&gt;
+&lt;p&gt;&lt;?php _e('Were you expecting more steps? Sorry to disappoint. All done! :)'); ?&gt;&lt;/p&gt;
+&lt;?php
+	break;
+}
+?&gt;
+&lt;p id=&quot;footer&quot;&gt;&lt;?php _e('&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;, lightweight publishing platform.'); ?&gt;&lt;/p&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/link-add.php
===================================================================
--- trunk/wp-admin/link-add.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/link-add.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,256 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Add Link');
+$this_file = 'link-manager.php';
+$parent_file = 'link-manager.php';
+
+function category_dropdown($fieldname, $selected = 0) {
+	global $wpdb;
+
+	$results = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+	echo &quot;\n&lt;select name='$fieldname' size='1'&gt;\n&quot;;
+	foreach ($results as $row) {
+		echo &quot;\n\t&lt;option value='$row-&gt;cat_id'&quot;;
+		if ($row-&gt;cat_id == $selected)
+			echo &quot; selected='selected'&quot;;
+		echo &quot;&gt;$row-&gt;cat_id : &quot; . wp_specialchars($row-&gt;cat_name);
+		if ($row-&gt;auto_toggle == 'Y')
+			echo ' (auto toggle)';
+		echo &quot;&lt;/option&gt;&quot;;
+	}
+	echo &quot;\n&lt;/select&gt;\n&quot;;
+}
+
+function xfn_check($class, $value = '', $type = 'check') {
+	global $link_rel;
+	$rels = preg_split('/\s+/', $link_rel);
+
+	if ('' != $value &amp;&amp; in_array($value, $rels) ) {
+		echo ' checked=&quot;checked&quot;';
+	}
+
+	if ('' == $value) {
+		if ('family' == $class &amp;&amp; !strstr($link_rel, 'child') &amp;&amp; !strstr($link_rel, 'parent') &amp;&amp; !strstr($link_rel, 'sibling') &amp;&amp; !strstr($link_rel, 'spouse') &amp;&amp; !strstr($link_rel, 'kin')) echo ' checked=&quot;checked&quot;';
+		if ('friendship' == $class &amp;&amp; !strstr($link_rel, 'friend') &amp;&amp; !strstr($link_rel, 'acquaintance') &amp;&amp; !strstr($link_rel, 'contact') ) echo ' checked=&quot;checked&quot;';
+		if ('geographical' == $class &amp;&amp; !strstr($link_rel, 'co-resident') &amp;&amp; !strstr($link_rel, 'neighbor') ) echo ' checked=&quot;checked&quot;';
+		if ('identity' == $class &amp;&amp; in_array('me', $rels) ) echo ' checked=&quot;checked&quot;';
+	}
+}
+
+$wpvarstoreset = array('action', 'cat_id', 'linkurl', 'name', 'image',
+                       'description', 'visible', 'target', 'category', 'link_id',
+                       'submit', 'order_by', 'links_show_cat_id', 'rating', 'rel',
+                       'notes', 'linkcheck[]');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+    $wpvar = $wpvarstoreset[$i];
+    if (!isset($$wpvar)) {
+        if (empty($_POST[&quot;$wpvar&quot;])) {
+            if (empty($_GET[&quot;$wpvar&quot;])) {
+                $$wpvar = '';
+            } else {
+                $$wpvar = $_GET[&quot;$wpvar&quot;];
+            }
+        } else {
+            $$wpvar = $_POST[&quot;$wpvar&quot;];
+        }
+    }
+}
+$link_url = stripslashes($_GET['linkurl']);
+$link_name = htmlentities(stripslashes(urldecode($_GET['name'])));
+
+
+$xfn = true;
+require('admin-header.php');
+?&gt;
+
+&lt;?php if ($_GET['added']) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('Link added.'); ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('&lt;strong&gt;Add&lt;/strong&gt; a link:') ?&gt;&lt;/h2&gt;
+     &lt;form name=&quot;addlink&quot; method=&quot;post&quot; action=&quot;link-manager.php&quot;&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+	&lt;legend&gt;&lt;?php _e('Basics') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+         &lt;tr&gt;
+           &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('URI:') ?&gt;&lt;/th&gt;
+           &lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;linkurl&quot; value=&quot;&lt;?php echo wp_specialchars($_GET['linkurl'], 1); ?&gt;&quot; style=&quot;width: 95%;&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Link Name:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&lt;?php echo wp_specialchars( urldecode($_GET['name']), 1 ); ?&gt;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+         	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Short description:') ?&gt;&lt;/th&gt;
+         	&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;description&quot; value=&quot;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         	&lt;/tr&gt;
+        &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Category:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;?php category_dropdown('category'); ?&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+       &lt;p class=&quot;submit&quot;&gt;
+         &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Add Link &raquo;') ?&gt;&quot; /&gt;
+       &lt;/p&gt;
+	&lt;fieldset class=&quot;options&quot;&gt;
+	&lt;legend&gt;&lt;?php _e('Link Relationship (XFN)') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+            &lt;tr&gt;
+                &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('rel:') ?&gt;&lt;/th&gt;
+            	&lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;rel&quot; id=&quot;rel&quot; size=&quot;50&quot; value=&quot;&lt;?php echo $link_rel; ?&gt;&quot; /&gt;&lt;/td&gt;
+           	&lt;/tr&gt;
+            &lt;tr&gt;
+                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('&lt;a href=&quot;<A HREF="http://gmpg.org/xfn/">http://gmpg.org/xfn/</A>&quot;&gt;XFN&lt;/a&gt; Creator:') ?&gt;&lt;/th&gt;
+            	&lt;td&gt;
+					&lt;table cellpadding=&quot;3&quot; cellspacing=&quot;5&quot;&gt;
+	          &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('identity') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;me&quot;&gt;
+                &lt;input type=&quot;checkbox&quot; name=&quot;identity&quot; value=&quot;me&quot; id=&quot;me&quot; &lt;?php xfn_check('identity', 'me'); ?&gt; /&gt;
+          &lt;?php _e('another web address of mine') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('friendship') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+			    &lt;label for=&quot;contact&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;contact&quot; id=&quot;contact&quot; &lt;?php xfn_check('friendship', 'contact', 'radio'); ?&gt; /&gt; &lt;?php _e('contact') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;acquaintance&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;acquaintance&quot; id=&quot;acquaintance&quot; &lt;?php xfn_check('friendship', 'acquaintance', 'radio'); ?&gt; /&gt;  &lt;?php _e('acquaintance') ?&gt;&lt;/label&gt;
+                &lt;label id=&quot;friend&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;friend&quot; id=&quot;friend&quot; &lt;?php xfn_check('friendship', 'friend', 'radio'); ?&gt; /&gt; &lt;?php _e('friend') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;friendship&quot;&gt;
+                &lt;input name=&quot;friendship&quot; type=&quot;radio&quot; class=&quot;valinp&quot; value=&quot;&quot; id=&quot;friendship&quot; &lt;?php xfn_check('friendship', '', 'radio'); ?&gt; /&gt; &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('physical') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;met&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;physical&quot; value=&quot;met&quot; id=&quot;met&quot; &lt;?php xfn_check('physical', 'met'); ?&gt; /&gt;
+          &lt;?php _e('met') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('professional') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;co-worker&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;professional&quot; value=&quot;co-worker&quot; id=&quot;co-worker&quot; &lt;?php xfn_check('professional', 'co-worker'); ?&gt; /&gt;
+          &lt;?php _e('co-worker') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;colleague&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;professional&quot; value=&quot;colleague&quot; id=&quot;colleague&quot; &lt;?php xfn_check('professional', 'colleague'); ?&gt; /&gt;
+          &lt;?php _e('colleague') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('geographical') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;co-resident&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;co-resident&quot; id=&quot;co-resident&quot; &lt;?php xfn_check('geographical', 'co-resident', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('co-resident') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;neighbor&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;neighbor&quot; id=&quot;neighbor&quot; &lt;?php xfn_check('geographical', 'neighbor', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('neighbor') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;geographical&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;&quot; id=&quot;geographical&quot; &lt;?php xfn_check('geographical', '', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('family'); ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;child&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;child&quot; id=&quot;child&quot; &lt;?php xfn_check('family', 'child', 'radio'); ?&gt;  /&gt;
+          &lt;?php _e('child') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;kin&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;kin&quot; id=&quot;kin&quot; &lt;?php xfn_check('family', 'kin', 'radio'); ?&gt;  /&gt;
+          &lt;?php _e('kin') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;parent&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;parent&quot; id=&quot;parent&quot; &lt;?php xfn_check('family', 'parent', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('parent') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;sibling&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;sibling&quot; id=&quot;sibling&quot; &lt;?php xfn_check('family', 'sibling', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('sibling') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;spouse&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;spouse&quot; id=&quot;spouse&quot; &lt;?php xfn_check('family', 'spouse', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('spouse') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;family&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;&quot; id=&quot;family&quot; &lt;?php xfn_check('family', '', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('romantic') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;muse&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;muse&quot; id=&quot;muse&quot; &lt;?php xfn_check('romantic', 'muse'); ?&gt; /&gt;
+         &lt;?php _e('muse') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;crush&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;crush&quot; id=&quot;crush&quot; &lt;?php xfn_check('romantic', 'crush'); ?&gt; /&gt;
+         &lt;?php _e('crush') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;date&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;date&quot; id=&quot;date&quot; &lt;?php xfn_check('romantic', 'date'); ?&gt; /&gt;
+         &lt;?php _e('date') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;romantic&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;sweetheart&quot; id=&quot;romantic&quot; &lt;?php xfn_check('romantic', 'sweetheart'); ?&gt; /&gt;
+         &lt;?php _e('sweetheart') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+        &lt;/table&gt;
+		  &lt;/td&gt;
+           	&lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+       &lt;p class=&quot;submit&quot;&gt;
+         &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Add Link &raquo;') ?&gt;&quot; /&gt;
+       &lt;/p&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;target&quot; value=&quot;&quot; checked=&quot;checked&quot; /&gt;
+	&lt;legend&gt;&lt;?php _e('Advanced') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+         &lt;tr&gt;
+           &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Image URI:') ?&gt;&lt;/th&gt;
+           &lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;image&quot; size=&quot;50&quot; value=&quot;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('RSS URI:') ?&gt; &lt;/th&gt;
+           &lt;td&gt;&lt;input name=&quot;rss_uri&quot; type=&quot;text&quot; id=&quot;rss_uri&quot; value=&quot;&quot; size=&quot;50&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Notes:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;textarea name=&quot;notes&quot; cols=&quot;50&quot; rows=&quot;10&quot; style=&quot;width: 95%&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Rating:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;select name=&quot;rating&quot; size=&quot;1&quot;&gt;
+             &lt;?php
+    for ($r = 0; $r &lt; 10; $r++) {
+      echo('            &lt;option value=&quot;'.$r.'&quot;&gt;'.$r.'&lt;/option&gt;');
+    }
+?&gt;
+           &lt;/select&gt;
+           &nbsp;&lt;?php _e('(Leave at 0 for no rating.)') ?&gt; &lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Visible:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;label&gt;
+             &lt;input type=&quot;radio&quot; name=&quot;visible&quot; checked=&quot;checked&quot; value=&quot;Y&quot; /&gt;
+&lt;?php _e('Yes') ?&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;visible&quot; value=&quot;N&quot; /&gt; &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;Add&quot; /&gt;
+&lt;?php _e('No') ?&gt;&lt;/label&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+
+       &lt;p class=&quot;submit&quot;&gt;
+         &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Add Link &raquo;') ?&gt;&quot; /&gt;
+       &lt;/p&gt;
+  &lt;/form&gt;
+&lt;/div&gt;
+
+&lt;?php
+require('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/link-categories.php
===================================================================
--- trunk/wp-admin/link-categories.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/link-categories.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,507 @@
+&lt;?php
+// Links
+// Copyright (C) 2002, 2003 Mike Little -- <A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">mike at zed1.com</A>
+require_once('admin.php');
+$title = __('Link Categories');
+$this_file='link-categories.php';
+$parent_file = 'link-manager.php';
+
+$wpvarstoreset = array('action', 'cat', 'auto_toggle');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+    $wpvar = $wpvarstoreset[$i];
+    if (!isset($$wpvar)) {
+        if (empty($_POST[&quot;$wpvar&quot;])) {
+            if (empty($_GET[&quot;$wpvar&quot;])) {
+                $$wpvar = '';
+            } else {
+                $$wpvar = $_GET[&quot;$wpvar&quot;];
+            }
+        } else {
+            $$wpvar = $_POST[&quot;$wpvar&quot;];
+        }
+    }
+}
+
+switch ($action) {
+  case 'addcat':
+  {
+      if ($user_level &lt; 5)
+          die (__(&quot;Cheatin' uh ?&quot;));
+
+      $cat_name = wp_specialchars($_POST['cat_name']);
+      $auto_toggle = $_POST['auto_toggle'];
+      if ($auto_toggle != 'Y') {
+          $auto_toggle = 'N';
+      }
+
+      $show_images = $_POST['show_images'];
+      if ($show_images != 'Y') {
+          $show_images = 'N';
+      }
+
+      $show_description = $_POST['show_description'];
+      if ($show_description != 'Y') {
+          $show_description = 'N';
+      }
+
+      $show_rating = $_POST['show_rating'];
+      if ($show_rating != 'Y') {
+          $show_rating = 'N';
+      }
+
+      $show_updated = $_POST['show_updated'];
+      if ($show_updated != 'Y') {
+          $show_updated = 'N';
+      }
+
+      $sort_order = $_POST['sort_order'];
+
+      $sort_desc = $_POST['sort_desc'];
+      if ($sort_desc != 'Y') {
+          $sort_desc = 'N';
+      }
+      $text_before_link = addslashes($_POST['text_before_link']);
+      $text_after_link = addslashes($_POST['text_after_link']);
+      $text_after_all = addslashes($_POST['text_after_all']);
+
+      $list_limit = $_POST['list_limit'];
+      if ($list_limit == '')
+          $list_limit = -1;
+
+      $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;linkcategories (cat_id, cat_name, auto_toggle, show_images, show_description, \n&quot; .
+             &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, text_after_all, list_limit) \n&quot; .
+             &quot; VALUES ('0', '$cat_name', '$auto_toggle', '$show_images', '$show_description', \n&quot; .
+             &quot; '$show_rating', '$show_updated', '$sort_order', '$sort_desc', '$text_before_link', '$text_after_link', \n&quot; .
+             &quot; '$text_after_all', $list_limit)&quot;);
+
+      header('Location: link-categories.php');
+    break;
+  } // end addcat
+  case 'Delete':
+  {
+    $cat_id = (int) $_GET['cat_id'];
+    $cat_name=get_linkcatname($cat_id);
+
+    if ($cat_id==&quot;1&quot;)
+        die(sprintf(__(&quot;Can't delete the &lt;strong&gt;%s&lt;/strong&gt; link category: this is the default one&quot;), $cat_name));
+
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    $wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;linkcategories WHERE cat_id='$cat_id'&quot;);
+    $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links SET link_category=1 WHERE link_category='$cat_id'&quot;);
+
+    header('Location: link-categories.php');
+    break;
+  } // end delete
+  case 'Edit':
+  {
+    include_once ('admin-header.php');
+    $cat_id = (int) $_GET['cat_id'];
+    $row = $wpdb-&gt;get_row(&quot;SELECT cat_id, cat_name, auto_toggle, show_images, show_description, &quot;
+         . &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, &quot;
+         . &quot; text_after_all, list_limit FROM $wpdb-&gt;linkcategories WHERE cat_id=$cat_id&quot;);
+    if ($row) {
+        if ($row-&gt;list_limit == -1) {
+            $row-&gt;list_limit = '';
+        }
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+  &lt;h2&gt;&lt;?php printf(__('Edit &amp;#8220%s&#8221; Category'), wp_specialchars($row-&gt;cat_name)); ?&gt;&lt;/h2&gt;
+
+  &lt;form name=&quot;editcat&quot; method=&quot;post&quot;&gt;
+      &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;editedcat&quot; /&gt;
+      &lt;input type=&quot;hidden&quot; name=&quot;cat_id&quot; value=&quot;&lt;?php echo $row-&gt;cat_id ?&gt;&quot; /&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Category Options') ?&gt;&lt;/legend&gt;
+&lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+&lt;tr&gt;
+	&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Name:') ?&gt;&lt;/th&gt;
+	&lt;td width=&quot;67%&quot;&gt;&lt;input name=&quot;cat_name&quot; type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($row-&gt;cat_name)?&gt;&quot; size=&quot;30&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Show:') ?&gt;&lt;/th&gt;
+        &lt;td&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_images&quot;  value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;show_images); ?&gt; /&gt;
+            &lt;?php _e('Image') ?&gt;&lt;/label&gt; &lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_description&quot; value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;show_description); ?&gt; /&gt;
+            &lt;?php _e('Description') ?&gt;&lt;/label&gt;
+            &lt;?php _e('(shown in &lt;code&gt;title&lt;/code&gt; regardless)') ?&gt;&lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_rating&quot;  value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;show_rating); ?&gt; /&gt;
+            &lt;?php _e('Rating') ?&gt;&lt;/label&gt; &lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_updated&quot; value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;show_updated); ?&gt; /&gt;
+            &lt;?php _e('Updated') ?&gt;&lt;/label&gt;
+&lt;?php _e('(shown in &lt;code&gt;title&lt;/code&gt; regardless)') ?&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Sort order:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;
+	&lt;select name=&quot;sort_order&quot; size=&quot;1&quot;&gt;
+            &lt;option value=&quot;name&quot; &lt;?php echo ($row-&gt;sort_order == 'name') ? 'selected=&quot;selected&quot;' : ''?&gt;&gt;&lt;?php _e('Name') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;id&quot;      &lt;?php echo ($row-&gt;sort_order == 'id') ? 'selected' : ''?&gt;&gt;&lt;?php _e('Id') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;url&quot;     &lt;?php echo ($row-&gt;sort_order == 'url') ? 'selected' : ''?&gt;&gt;&lt;?php _e('URL') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;rating&quot;  &lt;?php echo ($row-&gt;sort_order == 'rating') ? 'selected' : ''?&gt;&gt;&lt;?php _e('Rating') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;updated&quot; &lt;?php echo ($row-&gt;sort_order == 'updated') ? 'selected' : ''?&gt;&gt;&lt;?php _e('Updated') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;rand&quot;  &lt;?php echo ($row-&gt;sort_order == 'rand') ? 'selected' : ''?&gt;&gt;&lt;?php _e('Random') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;length&quot;  &lt;?php echo ($row-&gt;sort_order == 'length') ? 'selected' : ''?&gt;&gt;&lt;?php _e('Name Length') ?&gt;&lt;/option&gt;
+	&lt;/select&gt;
+	&lt;label&gt;
+	&lt;input type=&quot;checkbox&quot; name=&quot;sort_desc&quot; value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;sort_desc); ?&gt; /&gt;
+	&lt;?php _e('Descending') ?&gt;&lt;/label&gt;
+	&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Limit:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;
+	&lt;input type=&quot;text&quot; name=&quot;list_limit&quot; size=&quot;5&quot; value=&quot;&lt;?php echo $row-&gt;list_limit ?&gt;&quot; /&gt;
+	&lt;?php _e('(Leave empty for no limit to number of links shown)') ?&gt;
+	&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Toggle:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;&lt;label&gt;
+		&lt;input type=&quot;checkbox&quot; name=&quot;auto_toggle&quot;  value=&quot;Y&quot; &lt;?php checked('Y', $row-&gt;auto_toggle); ?&gt; /&gt;
+		&lt;?php _e('When new link is added toggle all others to be invisible') ?&gt;&lt;/label&gt;&lt;/td&gt;
+&lt;/tr&gt;
+
+&lt;/table&gt;
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Formatting') ?&gt;&lt;/legend&gt;
+&lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+&lt;tr&gt;
+	&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Before Link:') ?&gt;&lt;/th&gt;
+	&lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;text_before_link&quot; size=&quot;45&quot; value=&quot;&lt;?php echo wp_specialchars($row-&gt;text_before_link)?&gt;&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Between Link and Description:') ?&gt;&lt;/th&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;text_after_link&quot; size=&quot;45&quot; value=&quot;&lt;?php echo wp_specialchars($row-&gt;text_after_link)?&gt;&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('After Link:') ?&gt;&lt;/th&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;text_after_all&quot; size=&quot;45&quot; value=&quot;&lt;?php echo wp_specialchars($row-&gt;text_after_all)?&gt;&quot;/&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Save Category Settings &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+&lt;/form&gt;
+
+&lt;/div&gt;
+&lt;?php
+    } // end if row
+    break;
+  } // end Edit
+  case &quot;editedcat&quot;:
+  {
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    $submit=$_POST[&quot;submit&quot;];
+    if (isset($submit)) {
+
+    $cat_id = (int)$_POST[&quot;cat_id&quot;];
+
+    $cat_name= wp_specialchars($_POST[&quot;cat_name&quot;]);
+    $auto_toggle = $_POST[&quot;auto_toggle&quot;];
+    if ($auto_toggle != 'Y') {
+        $auto_toggle = 'N';
+    }
+
+    $show_images = $_POST[&quot;show_images&quot;];
+    if ($show_images != 'Y') {
+        $show_images = 'N';
+    }
+
+    $show_description = $_POST[&quot;show_description&quot;];
+    if ($show_description != 'Y') {
+        $show_description = 'N';
+    }
+
+    $show_rating = $_POST[&quot;show_rating&quot;];
+    if ($show_rating != 'Y') {
+        $show_rating = 'N';
+    }
+
+    $show_updated = $_POST[&quot;show_updated&quot;];
+    if ($show_updated != 'Y') {
+        $show_updated = 'N';
+    }
+
+    $sort_order = $_POST[&quot;sort_order&quot;];
+
+    $sort_desc = $_POST[&quot;sort_desc&quot;];
+    if ($sort_desc != 'Y') {
+        $sort_desc = 'N';
+    }
+    $text_before_link = addslashes($_POST[&quot;text_before_link&quot;]);
+    $text_after_link = addslashes($_POST[&quot;text_after_link&quot;]);
+    $text_after_all = addslashes($_POST[&quot;text_after_all&quot;]);
+
+    $list_limit = $_POST[&quot;list_limit&quot;];
+    if ($list_limit == '')
+        $list_limit = -1;
+
+    $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;linkcategories set
+            cat_name='$cat_name',
+            auto_toggle='$auto_toggle',
+            show_images='$show_images',
+            show_description='$show_description',
+            show_rating='$show_rating',
+            show_updated='$show_updated',
+            sort_order='$sort_order',
+            sort_desc='$sort_desc',
+            text_before_link='$text_before_link',
+            text_after_link='$text_after_link',
+            text_after_all='$text_after_all',
+            list_limit=$list_limit
+            WHERE cat_id=$cat_id
+            &quot;);
+    } // end if save
+
+
+    header(&quot;Location: link-categories.php&quot;);
+    break;
+  } // end editcat
+  default:
+  {
+    include_once (&quot;admin-header.php&quot;);
+    if ($user_level &lt; 5) {
+      die(__(&quot;You have do not have sufficient permissions to edit the link categories for this blog. :)&quot;));
+    }
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+	&lt;h2&gt;&lt;?php _e('Link Categories:') ?&gt;&lt;/h2&gt;
+	&lt;h3&gt;&lt;?php _e('Settings:') ?&gt;&lt;/h3&gt;
+	&lt;table width=&quot;100%&quot; cellpadding=&quot;5&quot; cellspacing=&quot;0&quot; border=&quot;0&quot;&gt;
+		&lt;tr&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('ID') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('Toggle?') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('Sort Order') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('Desc?') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;bottom&quot;&gt;&lt;?php _e('Limit') ?&gt;&lt;/th&gt;
+			&lt;th colspan=&quot;2&quot;&gt;&nbsp;&lt;/th&gt;
+		&lt;/tr&gt;
+&lt;?php
+$results = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle, show_images, show_description, &quot;
+         . &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, &quot;
+         . &quot; text_after_all, list_limit FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+$i = 1;
+foreach ($results as $row) {
+    if ($row-&gt;list_limit == -1) {
+        $row-&gt;list_limit = __('none');
+    }
+    $style = ($i % 2) ? ' class=&quot;alternate&quot;' : '';
+    /*
+    	Manually internationalize every sort order option.
+    */
+    switch ($row-&gt;sort_order) {
+    	case 'name':
+    		$row-&gt;sort_order = __('name');
+    		break;
+    	case 'id':
+    		$row-&gt;sort_order = __('id');
+    		break;
+    	case 'url':
+    		$row-&gt;sort_order = __('url');
+    		break;
+    	case 'rating':
+    		$row-&gt;sort_order = __('rating');
+    		break;
+    	case 'updated':
+    		$row-&gt;sort_order = __('updated');
+    		break;
+    	case 'rand':
+    		$row-&gt;sort_order = __('rand');
+    		break;
+    	case 'length':
+    		$row-&gt;sort_order = __('length');
+    		break;
+    }
+?&gt;
+			&lt;tr valign=&quot;middle&quot; align=&quot;center&quot; &lt;?php echo $style ?&gt; style=&quot;border-bottom: 1px dotted #9C9A9C;&quot;&gt;
+				&lt;td&gt;&lt;?php echo wp_specialchars($row-&gt;cat_name)?&gt;&lt;/td&gt;
+				&lt;td &gt;&lt;?php echo $row-&gt;cat_id?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;auto_toggle == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;sort_order ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;sort_desc == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;list_limit ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;a href=&quot;link-categories.php?cat_id=&lt;?php echo $row-&gt;cat_id?&gt;&amp;action=Edit&quot; class=&quot;edit&quot;&gt;&lt;?php _e('Edit') ?&gt;&lt;/a&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;a href=&quot;link-categories.php?cat_id=&lt;?php echo $row-&gt;cat_id?&gt;&amp;action=Delete&quot; onclick=&quot;return confirm('&lt;?php _e(&quot;You are about to delete this category.\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;) ?&gt;');&quot; class=&quot;delete&quot;&gt;&lt;?php _e('Delete') ?&gt;&lt;/a&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+&lt;?php
+        ++$i;
+    }
+?&gt;
+            &lt;/table&gt;
+
+	&lt;h3&gt;&lt;?php _e('Formatting:') ?&gt;&lt;/h3&gt;
+	&lt;table width=&quot;100%&quot; cellpadding=&quot;5&quot; cellspacing=&quot;0&quot; border=&quot;0&quot;&gt;
+		&lt;tr&gt;
+			&lt;th rowspan=&quot;2&quot; valign=&quot;bottom&quot;&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+			&lt;th colspan=&quot;4&quot; valign=&quot;bottom&quot; class=&quot;alternate&quot;&gt;&lt;?php _e('Show') ?&gt;&lt;/th&gt;
+			&lt;th colspan=&quot;3&quot; valign=&quot;bottom&quot; class=&quot;alternate&quot;&gt;&lt;?php _e('Formatting') ?&gt;&lt;/th&gt;
+			&lt;th rowspan=&quot;2&quot;&gt;&nbsp;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Images') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Description') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Rating') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Updated') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Before') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('Between') ?&gt;&lt;/th&gt;
+			&lt;th valign=&quot;top&quot;&gt;&lt;?php _e('After') ?&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+&lt;?php
+$results = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle, show_images, show_description, &quot;
+         . &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, &quot;
+         . &quot; text_after_all, list_limit FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+$i = 1;
+foreach ($results as $row) {
+    if ($row-&gt;list_limit == -1) {
+        $row-&gt;list_limit = __('none');
+    }
+    $style = ($i % 2) ? ' class=&quot;alternate&quot;' : '';
+    /*
+    	Manually internationalize every sort order option.
+    */
+    switch ($row-&gt;sort_order) {
+    	case 'name':
+    		$row-&gt;sort_order = __('name');
+    		break;
+    	case 'id':
+    		$row-&gt;sort_order = __('id');
+    		break;
+    	case 'url':
+    		$row-&gt;sort_order = __('url');
+    		break;
+    	case 'rating':
+    		$row-&gt;sort_order = __('rating');
+    		break;
+    	case 'updated':
+    		$row-&gt;sort_order = __('updated');
+    		break;
+    	case 'rand':
+    		$row-&gt;sort_order = __('rand');
+    		break;
+    	case 'length':
+    		$row-&gt;sort_order = __('length');
+    		break;
+    }
+?&gt;
+			&lt;tr valign=&quot;middle&quot; align=&quot;center&quot; &lt;?php echo $style ?&gt; style=&quot;border-bottom: 1px dotted #9C9A9C;&quot;&gt;
+				&lt;td&gt;&lt;?php echo wp_specialchars($row-&gt;cat_name)?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;show_images == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;show_description == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;show_rating == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;?php echo $row-&gt;show_updated == 'Y' ? __('Yes') : __('No') ?&gt;&lt;/td&gt;
+				&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo htmlentities($row-&gt;text_before_link)?&gt;&nbsp;&lt;/td&gt;
+				&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo htmlentities($row-&gt;text_after_link)?&gt;&nbsp;&lt;/td&gt;
+				&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo htmlentities($row-&gt;text_after_all)?&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;a href=&quot;link-categories.php?cat_id=&lt;?php echo $row-&gt;cat_id?&gt;&amp;action=Edit&quot; class=&quot;edit&quot;&gt;&lt;?php _e('Edit') ?&gt;&lt;/a&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+&lt;?php
+        ++$i;
+    }
+?&gt;
+            &lt;/table&gt;
+&lt;p&gt;&lt;?php _e('These are the defaults for when you call a link category with no additional arguments. All of these settings may be overwritten.') ?&gt;&lt;/p&gt;
+
+&lt;/div&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+    &lt;form name=&quot;addcat&quot; method=&quot;post&quot;&gt;
+      &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;addcat&quot; /&gt;
+	  &lt;h2&gt;&lt;?php _e('Add a Link Category:') ?&gt;&lt;/h2&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Category Options') ?&gt;&lt;/legend&gt;
+&lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+&lt;tr&gt;
+	&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Name:') ?&gt;&lt;/th&gt;
+	&lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;cat_name&quot; size=&quot;30&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Show:') ?&gt;&lt;/th&gt;
+        &lt;td&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_images&quot;  value=&quot;Y&quot; /&gt;
+            &lt;?php _e('Image') ?&gt;&lt;/label&gt; &lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_description&quot; value=&quot;Y&quot; /&gt;
+            &lt;?php _e('Description') ?&gt;&lt;/label&gt;
+            &lt;?php _e('(shown in &lt;code&gt;title&lt;/code&gt; regardless)') ?&gt;&lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_rating&quot;  value=&quot;Y&quot; /&gt;
+            &lt;?php _e('Rating') ?&gt;&lt;/label&gt; &lt;br /&gt;
+            &lt;label&gt;
+            &lt;input type=&quot;checkbox&quot; name=&quot;show_updated&quot; value=&quot;Y&quot; /&gt;
+            &lt;?php _e('Updated') ?&gt;&lt;/label&gt;
+&lt;?php _e('(shown in &lt;code&gt;title&lt;/code&gt; regardless)') ?&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Sort order:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;
+	&lt;select name=&quot;sort_order&quot; size=&quot;1&quot;&gt;
+	&lt;option value=&quot;name&quot;&gt;&lt;?php _e('Name') ?&gt;&lt;/option&gt;
+	&lt;option value=&quot;id&quot;&gt;&lt;?php _e('Id') ?&gt;&lt;/option&gt;
+	&lt;option value=&quot;url&quot;&gt;&lt;?php _e('URL') ?&gt;&lt;/option&gt;
+	&lt;option value=&quot;rating&quot;&gt;&lt;?php _e('Rating') ?&gt;&lt;/option&gt;
+	&lt;option value=&quot;updated&quot;&gt;&lt;?php _e('Updated') ?&gt;&lt;/option&gt;
+	&lt;option value=&quot;rand&quot;&gt;&lt;?php _e('Random') ?&gt;&lt;/option&gt;
+	&lt;/select&gt;
+	&lt;label&gt;
+	&lt;input type=&quot;checkbox&quot; name=&quot;sort_desc&quot; value=&quot;Y&quot; /&gt;
+	&lt;?php _e('Descending') ?&gt;&lt;/label&gt;
+	&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Limit:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;
+	&lt;input type=&quot;text&quot; name=&quot;list_limit&quot; size=&quot;5&quot; value=&quot;&quot; /&gt; &lt;?php _e('(Leave empty for no limit to number of links shown)') ?&gt;
+	&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Toggle:') ?&gt;&lt;/th&gt;
+	&lt;td&gt;&lt;label&gt;
+		&lt;input type=&quot;checkbox&quot; name=&quot;auto_toggle&quot;  value=&quot;Y&quot; /&gt;
+		&lt;?php _e('When new link is added toggle all others to be invisible') ?&gt;&lt;/label&gt;&lt;/td&gt;
+&lt;/tr&gt;
+
+&lt;/table&gt;
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+&lt;legend&gt;&lt;?php _e('Formatting') ?&gt;&lt;/legend&gt;
+&lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+&lt;tr&gt;
+	&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Before Link:') ?&gt;&lt;/th&gt;
+	&lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;text_before_link&quot; size=&quot;45&quot; value=&quot;&lt;li&gt;&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Between Link and Description:') ?&gt;&lt;/th&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;text_after_link&quot; size=&quot;45&quot; value=&quot;&lt;br /&gt;&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('After Link:') ?&gt;&lt;/th&gt;
+&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;text_after_all&quot; size=&quot;45&quot; value=&quot;&lt;/li&gt;&quot;/&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Add Category &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+  &lt;/form&gt;
+&lt;/div&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+    &lt;h3&gt;&lt;?php _e('Note:') ?&gt;&lt;/h3&gt;
+    &lt;?php printf(__('&lt;p&gt;Deleting a link category does not delete links from that category.&lt;br /&gt;It will just set them back to the default category &lt;b&gt;%s&lt;/b&gt;.'), get_linkcatname(1)) ?&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;?php
+    break;
+  } // end default
+} // end case
+?&gt;
+&lt;?php include('admin-footer.php'); ?&gt;

Added: trunk/wp-admin/link-import.php
===================================================================
--- trunk/wp-admin/link-import.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/link-import.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,131 @@
+&lt;?php
+// Links
+// Copyright (C) 2002 Mike Little -- <A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">mike at zed1.com</A>
+
+require_once('admin.php');
+$parent_file = 'link-manager.php';
+$title = __('Import Blogroll');
+$this_file = 'link-import.php';
+
+$step = $_POST['step'];
+if (!$step) $step = 0;
+?&gt;
+&lt;?php
+switch ($step) {
+    case 0:
+    {
+        include_once('admin-header.php');
+        if ($user_level &lt; 5)
+            die (__(&quot;Cheatin&#8217; uh?&quot;));
+
+        $opmltype = 'blogrolling'; // default.
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+
+    &lt;h2&gt;&lt;?php _e('Import your blogroll from another system') ?&gt; &lt;/h2&gt;
+	&lt;!-- &lt;form name=&quot;blogroll&quot; action=&quot;link-import.php&quot; method=&quot;get&quot;&gt; --&gt;
+	&lt;form enctype=&quot;multipart/form-data&quot; action=&quot;link-import.php&quot; method=&quot;post&quot; name=&quot;blogroll&quot;&gt;
+
+	&lt;ol&gt;
+    &lt;li&gt;&lt;?php _e('Go to &lt;a href=&quot;<A HREF="http://www.blogrolling.com">http://www.blogrolling.com</A>&quot;&gt;Blogrolling.com&lt;/a&gt; and sign in. Once you&#8217;ve done that, click on &lt;strong&gt;Get Code&lt;/strong&gt;, and then look for the &lt;strong&gt;&lt;abbr title=&quot;Outline Processor Markup Language&quot;&gt;OPML&lt;/abbr&gt; code&lt;/strong&gt;') ?&gt;.&lt;/li&gt;
+    &lt;li&gt;&lt;?php _e('Or go to &lt;a href=&quot;<A HREF="http://blo.gs">http://blo.gs</A>&quot;&gt;Blo.gs&lt;/a&gt; and sign in. Once you&#8217;ve done that in the \'Welcome Back\' box on the right, click on &lt;strong&gt;share&lt;/strong&gt;, and then look for the &lt;strong&gt;&lt;abbr title=&quot;Outline Processor Markup Language&quot;&gt;OPML&lt;/abbr&gt; link&lt;/strong&gt; (favorites.opml).') ?&gt;&lt;/li&gt;
+    &lt;li&gt;&lt;?php _e('Select that text and copy it or copy the link/shortcut into the box below.') ?&gt;&lt;br /&gt;
+       &lt;input type=&quot;hidden&quot; name=&quot;step&quot; value=&quot;1&quot; /&gt;
+       &lt;?php _e('Your OPML URL:') ?&gt; &lt;input type=&quot;text&quot; name=&quot;opml_url&quot; size=&quot;65&quot; /&gt;
+	&lt;/li&gt;
+    &lt;li&gt;
+	   &lt;?php _e('&lt;strong&gt;or&lt;/strong&gt; you can upload an OPML file from your desktop aggregator:') ?&gt;&lt;br /&gt;
+       &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;30000&quot; /&gt;
+       &lt;label&gt;&lt;?php _e('Upload this file:') ?&gt; &lt;input name=&quot;userfile&quot; type=&quot;file&quot; /&gt;&lt;/label&gt;
+    &lt;/li&gt;
+
+    &lt;li&gt;&lt;?php _e('Now select a category you want to put these links in.') ?&gt;&lt;br /&gt;
+	&lt;?php _e('Category:') ?&gt; &lt;select name=&quot;cat_id&quot;&gt;
+&lt;?php
+	$categories = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+	foreach ($categories as $category) {
+?&gt;
+    &lt;option value=&quot;&lt;?php echo $category-&gt;cat_id; ?&gt;&quot;&gt;&lt;?php echo $category-&gt;cat_id.': '.$category-&gt;cat_name; ?&gt;&lt;/option&gt;
+&lt;?php
+        } // end foreach
+?&gt;
+    &lt;/select&gt;
+
+	&lt;/li&gt;
+
+    &lt;li&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Import!') ?&gt;&quot; /&gt;&lt;/li&gt;
+	&lt;/ol&gt;
+    &lt;/form&gt;
+
+&lt;/div&gt;
+&lt;?php
+                break;
+            } // end case 0
+
+    case 1: {
+                include_once('admin-header.php');
+                if ($user_level &lt; 5)
+                    die (__(&quot;Cheatin' uh ?&quot;));
+?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+
+     &lt;h2&gt;&lt;?php _e('Importing...') ?&gt;&lt;/h2&gt;
+&lt;?php
+                $cat_id = $_POST['cat_id'];
+                if (($cat_id == '') || ($cat_id == 0)) {
+                    $cat_id  = 1;
+                }
+
+                $opml_url = $_POST['opml_url'];
+                if (isset($opml_url) &amp;&amp; $opml_url != '') {
+					$blogrolling = true;
+                }
+                else // try to get the upload file.
+				{
+					$uploaddir = get_settings('fileupload_realpath');
+					$uploadfile = $uploaddir.'/'.$_FILES['userfile']['name'];
+
+					if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile))
+					{
+						//echo &quot;Upload successful.&quot;;
+						$blogrolling = false;
+						$opml_url = $uploadfile;
+					} else {
+						echo __(&quot;Upload error&quot;);
+					}
+				}
+
+                if (isset($opml_url) &amp;&amp; $opml_url != '') {
+                    $opml = implode('', file($opml_url));
+                    include_once('link-parse-opml.php');
+
+                    $link_count = count($names);
+                    for ($i = 0; $i &lt; $link_count; $i++) {
+                        if ('Last' == substr($titles[$i], 0, 4))
+                            $titles[$i] = '';
+                        if ('http' == substr($titles[$i], 0, 4))
+                            $titles[$i] = '';
+                        $query = &quot;INSERT INTO $wpdb-&gt;links (link_url, link_name, link_target, link_category, link_description, link_owner, link_rss)
+                                VALUES('{$urls[$i]}', '&quot;.addslashes($names[$i]).&quot;', '', $cat_id, '&quot;.addslashes($descriptions[$i]).&quot;', $user_ID, '{$feeds[$i]}')\n&quot;;
+                        $result = $wpdb-&gt;query($query);
+                        echo sprintf(__(&quot;&lt;p&gt;Inserted &lt;strong&gt;%s&lt;/strong&gt;&lt;/p&gt;&quot;), $names[$i]);
+                    }
+?&gt;
+     &lt;p&gt;&lt;?php printf(__('Inserted %1$d links into category %2$s. All done! Go &lt;a href=&quot;%3$s&quot;&gt;manage those links&lt;/a&gt;.'), $link_count, $cat_id, 'link-manager.php') ?&gt;&lt;/p&gt;
+&lt;?php
+                } // end if got url
+                else
+                {
+                    echo &quot;&lt;p&gt;&quot; . __(&quot;You need to supply your OPML url. Press back on your browser and try again&quot;) . &quot;&lt;/p&gt;\n&quot;;
+                } // end else
+
+?&gt;
+&lt;/div&gt;
+&lt;?php
+                break;
+            } // end case 1
+} // end switch
+?&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/link-manager.php
===================================================================
--- trunk/wp-admin/link-manager.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/link-manager.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,767 @@
+&lt;?php
+// Links
+// Copyright (C) 2002, 2003 Mike Little -- <A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">mike at zed1.com</A>
+
+require_once('admin.php');
+
+$title = __('Manage Links');
+$this_file = $parent_file = 'link-manager.php';
+
+function xfn_check($class, $value = '', $type = 'check') {
+	global $link_rel;
+	$rels = preg_split('/\s+/', $link_rel);
+
+	if ('' != $value &amp;&amp; in_array($value, $rels) ) {
+		echo ' checked=&quot;checked&quot;';
+	}
+
+	if ('' == $value) {
+		if ('family' == $class &amp;&amp; !strstr($link_rel, 'child') &amp;&amp; !strstr($link_rel, 'parent') &amp;&amp; !strstr($link_rel, 'sibling') &amp;&amp; !strstr($link_rel, 'spouse') &amp;&amp; !strstr($link_rel, 'kin')) echo ' checked=&quot;checked&quot;';
+		if ('friendship' == $class &amp;&amp; !strstr($link_rel, 'friend') &amp;&amp; !strstr($link_rel, 'acquaintance') &amp;&amp; !strstr($link_rel, 'contact') ) echo ' checked=&quot;checked&quot;';
+		if ('geographical' == $class &amp;&amp; !strstr($link_rel, 'co-resident') &amp;&amp; !strstr($link_rel, 'neighbor') ) echo ' checked=&quot;checked&quot;';
+		if ('identity' == $class &amp;&amp; in_array('me', $rels) ) echo ' checked=&quot;checked&quot;';
+	}
+}
+
+function category_dropdown($fieldname, $selected = 0)
+{
+	global $wpdb;
+
+	$results = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+	echo &quot;\t\t\t\t&lt;select name='$fieldname' size='1'&gt;\n&quot;;
+	foreach ($results as $row)
+	{
+		echo &quot;\t\t\t\t\t&lt;option value='$row-&gt;cat_id'&quot;;
+		if ($row-&gt;cat_id == $selected)
+		{
+			echo &quot; selected='selected'&quot;;
+		}
+		echo &quot;&gt;$row-&gt;cat_id: &quot;.wp_specialchars($row-&gt;cat_name);
+		if ('Y' == $row-&gt;auto_toggle)
+		{
+			echo ' (auto toggle)';
+		}
+		echo &quot;&lt;/option&gt;\n&quot;;
+	}
+	echo &quot;\t\t\t\t&lt;/select&gt;\n&quot;;
+}
+
+$wpvarstoreset = array('action','cat_id', 'linkurl', 'name', 'image',
+                       'description', 'visible', 'target', 'category', 'link_id',
+                       'submit', 'order_by', 'links_show_cat_id', 'rating', 'rel',
+                       'notes', 'linkcheck[]');
+
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+    $wpvar = $wpvarstoreset[$i];
+    if (!isset($$wpvar)) {
+        if (empty($_POST[&quot;$wpvar&quot;])) {
+            if (empty($_GET[&quot;$wpvar&quot;])) {
+                $$wpvar = '';
+            } else {
+                $$wpvar = $_GET[&quot;$wpvar&quot;];
+            }
+        } else {
+            $$wpvar = $_POST[&quot;$wpvar&quot;];
+        }
+    }
+}
+
+$links_show_cat_id = $_COOKIE['links_show_cat_id_' . COOKIEHASH];
+$links_show_order = $_COOKIE['links_show_order_' . COOKIEHASH];
+
+if ('' != $_POST['assign']) $action = 'assign';
+if ('' != $_POST['visibility']) $action = 'visibility';
+if ('' != $_POST['move']) $action = 'move';
+if ('' != $_POST['linkcheck']) $linkcheck = $_POST[linkcheck];
+
+switch ($action) {
+  case 'assign':
+  {
+    check_admin_referer();
+
+    // check the current user's level first.
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    //for each link id (in $linkcheck[]): if the current user level &gt;= the
+    //userlevel of the owner of the link then we can proceed.
+
+    if (count($linkcheck) == 0) {
+        header('Location: ' . $this_file);
+        exit;
+    }
+    $all_links = join(',', $linkcheck);
+    $results = $wpdb-&gt;get_results(&quot;SELECT link_id, link_owner, user_level FROM $wpdb-&gt;links LEFT JOIN $wpdb-&gt;users ON link_owner = ID WHERE link_id in ($all_links)&quot;);
+    foreach ($results as $row) {
+      if (($user_level &gt;= $row-&gt;user_level)) { // ok to proceed
+        $ids_to_change[] = $row-&gt;link_id;
+      }
+    }
+
+    // should now have an array of links we can change
+    $all_links = join(',', $ids_to_change);
+    $q = $wpdb-&gt;query(&quot;update $wpdb-&gt;links SET link_owner='$newowner' WHERE link_id IN ($all_links)&quot;);
+
+    header('Location: ' . $this_file);
+    break;
+  }
+  case 'visibility':
+  {
+    check_admin_referer();
+
+    // check the current user's level first.
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    //for each link id (in $linkcheck[]): toggle the visibility
+    if (count($linkcheck) == 0) {
+        header('Location: ' . $this_file);
+        exit;
+    }
+    $all_links = join(',', $linkcheck);
+    $results = $wpdb-&gt;get_results(&quot;SELECT link_id, link_visible FROM $wpdb-&gt;links WHERE link_id in ($all_links)&quot;);
+    foreach ($results as $row) {
+        if ($row-&gt;link_visible == 'Y') { // ok to proceed
+            $ids_to_turnoff[] = $row-&gt;link_id;
+        } else {
+            $ids_to_turnon[] = $row-&gt;link_id;
+        }
+    }
+
+    // should now have two arrays of links to change
+    if (count($ids_to_turnoff)) {
+        $all_linksoff = join(',', $ids_to_turnoff);
+        $q = $wpdb-&gt;query(&quot;update $wpdb-&gt;links SET link_visible='N' WHERE link_id IN ($all_linksoff)&quot;);
+    }
+
+    if (count($ids_to_turnon)) {
+        $all_linkson = join(',', $ids_to_turnon);
+        $q = $wpdb-&gt;query(&quot;update $wpdb-&gt;links SET link_visible='Y' WHERE link_id IN ($all_linkson)&quot;);
+    }
+
+    header('Location: ' . $this_file);
+    break;
+  }
+  case 'move':
+  {
+    check_admin_referer();
+
+    // check the current user's level first.
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    //for each link id (in $linkcheck[]) change category to selected value
+    if (count($linkcheck) == 0) {
+        header('Location: ' . $this_file);
+        exit;
+    }
+    $all_links = join(',', $linkcheck);
+    // should now have an array of links we can change
+    $q = $wpdb-&gt;query(&quot;update $wpdb-&gt;links SET link_category='$category' WHERE link_id IN ($all_links)&quot;);
+
+    header('Location: ' . $this_file);
+    break;
+  }
+
+  case 'Add':
+  {
+    check_admin_referer();
+
+    $link_url = wp_specialchars($_POST['linkurl']);
+    $link_url = preg_match('/^(https?|ftps?|mailto|news|gopher):/is', $link_url) ? $link_url : '<A HREF="http://">http://</A>' . $link_url;
+    $link_name = wp_specialchars($_POST['name']);
+    $link_image = wp_specialchars($_POST['image']);
+    $link_target = $_POST['target'];
+    $link_category = $_POST['category'];
+    $link_description = $_POST['description'];
+    $link_visible = $_POST['visible'];
+    $link_rating = $_POST['rating'];
+    $link_rel = $_POST['rel'];
+    $link_notes = $_POST['notes'];
+	$link_rss_uri =  wp_specialchars($_POST['rss_uri']);
+    $auto_toggle = get_autotoggle($link_category);
+
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    // if we are in an auto toggle category and this one is visible then we
+    // need to make the others invisible before we add this new one.
+    if (($auto_toggle == 'Y') &amp;&amp; ($link_visible == 'Y')) {
+      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links set link_visible = 'N' WHERE link_category = $link_category&quot;);
+    }
+    $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;links (link_url, link_name, link_image, link_target, link_category, link_description, link_visible, link_owner, link_rating, link_rel, link_notes, link_rss) &quot; .
+      &quot; VALUES('&quot; . $link_url . &quot;','&quot;
+           . $link_name . &quot;', '&quot;
+           . $link_image . &quot;', '$link_target', $link_category, '&quot;
+           . $link_description . &quot;', '$link_visible', $user_ID, $link_rating, '&quot; . $link_rel . &quot;', '&quot; . $link_notes . &quot;', '$link_rss_uri')&quot;);
+
+    header('Location: ' . $_SERVER['HTTP_REFERER'] . '?added=true');
+    break;
+  } // end Add
+
+  case 'editlink':
+  {
+    if (isset($submit)) {
+
+      if (isset($links_show_cat_id) &amp;&amp; ($links_show_cat_id != ''))
+        $cat_id = $links_show_cat_id;
+
+      if (!isset($cat_id) || ($cat_id == '')) {
+        if (!isset($links_show_cat_id) || ($links_show_cat_id == ''))
+          $cat_id = 'All';
+      }
+      $links_show_cat_id = $cat_id;
+
+      check_admin_referer();
+
+      $link_id = (int) $_POST['link_id'];
+      $link_url = wp_specialchars($_POST['linkurl']);
+      $link_url = preg_match('/^(https?|ftps?|mailto|news|gopher):/is', $link_url) ? $link_url : '<A HREF="http://">http://</A>' . $link_url;
+      $link_name = wp_specialchars($_POST['name']);
+      $link_image = wp_specialchars($_POST['image']);
+      $link_target = wp_specialchars($_POST['target']);
+      $link_category = $_POST['category'];
+      $link_description = $_POST['description'];
+      $link_visible = $_POST['visible'];
+      $link_rating = $_POST['rating'];
+      $link_rel = $_POST['rel'];
+      $link_notes = $_POST['notes'];
+	  $link_rss_uri =  $_POST['rss_uri'];
+      $auto_toggle = get_autotoggle($link_category);
+
+      if ($user_level &lt; 5)
+        die (__(&quot;Cheatin' uh ?&quot;));
+
+      // if we are in an auto toggle category and this one is visible then we
+      // need to make the others invisible before we update this one.
+      if (($auto_toggle == 'Y') &amp;&amp; ($link_visible == 'Y')) {
+        $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links set link_visible = 'N' WHERE link_category = $link_category&quot;);
+      }
+
+      $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links SET link_url='&quot; . $link_url . &quot;',
+	  link_name='&quot; . $link_name . &quot;',\n link_image='&quot; . $link_image . &quot;',
+	  link_target='$link_target',\n link_category=$link_category,
+	  link_visible='$link_visible',\n link_description='&quot; . $link_description . &quot;',
+	  link_rating=$link_rating,
+	  link_rel='&quot; . $link_rel . &quot;',
+	  link_notes='&quot; . $link_notes . &quot;',
+	  link_rss = '$link_rss_uri'
+	  WHERE link_id=$link_id&quot;);
+    } // end if save
+    setcookie('links_show_cat_id_' . COOKIEHASH, $links_show_cat_id, time()+600);
+    wp_redirect($this_file);
+    break;
+  } // end Save
+
+  case 'Delete':
+  {
+    check_admin_referer();
+
+    $link_id = (int) $_GET['link_id'];
+
+    if ($user_level &lt; 5)
+      die (__(&quot;Cheatin' uh ?&quot;));
+
+    $wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;links WHERE link_id = $link_id&quot;);
+
+    if (isset($links_show_cat_id) &amp;&amp; ($links_show_cat_id != ''))
+        $cat_id = $links_show_cat_id;
+
+    if (!isset($cat_id) || ($cat_id == '')) {
+        if (!isset($links_show_cat_id) || ($links_show_cat_id == ''))
+        $cat_id = 'All';
+    }
+    $links_show_cat_id = $cat_id;
+    setcookie('links_show_cat_id_' . COOKIEHASH, $links_show_cat_id, time()+600);
+    wp_redirect($this_file);
+    break;
+  } // end Delete
+
+  case 'linkedit': {
+	$xfn = true;
+    include_once ('admin-header.php');
+    if ($user_level &lt; 5)
+      die(__('You do not have sufficient permissions to edit the links for this blog.'));
+
+    $link_id = (int) $_GET['link_id'];
+    $row = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;links WHERE link_id = $link_id&quot;);
+
+    if ($row) {
+      $link_url = wp_specialchars($row-&gt;link_url, 1);
+      $link_name = wp_specialchars($row-&gt;link_name, 1);
+      $link_image = $row-&gt;link_image;
+      $link_target = $row-&gt;link_target;
+      $link_category = $row-&gt;link_category;
+      $link_description = wp_specialchars($row-&gt;link_description);
+      $link_visible = $row-&gt;link_visible;
+      $link_rating = $row-&gt;link_rating;
+      $link_rel = $row-&gt;link_rel;
+      $link_notes = wp_specialchars($row-&gt;link_notes);
+	  $link_rss_uri = wp_specialchars($row-&gt;link_rss);
+    } else {
+		die( __('Link not found.') );
+	}
+
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+  &lt;form action=&quot;&quot; method=&quot;post&quot; name=&quot;editlink&quot; id=&quot;editlink&quot;&gt;
+  &lt;h2&gt;&lt;?php _e('Edit a link:') ?&gt;&lt;/h2&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+    &lt;legend&gt;&lt;?php _e('Basics') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+         &lt;tr&gt;
+           &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('URI:') ?&gt;&lt;/th&gt;
+           &lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;linkurl&quot; value=&quot;&lt;?php echo $link_url; ?&gt;&quot; style=&quot;width: 95%;&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Link Name:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&lt;?php echo $link_name; ?&gt;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+            &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Short description:') ?&gt;&lt;/th&gt;
+         	&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;description&quot; value=&quot;&lt;?php echo $link_description; ?&gt;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         	&lt;/tr&gt;
+        &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Category:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;?php category_dropdown('category', $link_category); ?&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+       &lt;p class=&quot;submit&quot;&gt;
+       &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Save Changes &raquo;') ?&gt;&quot; /&gt;
+       &lt;/p&gt;
+	&lt;fieldset class=&quot;options&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('Link Relationship (XFN)') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+            &lt;tr&gt;
+                &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('rel:') ?&gt;&lt;/th&gt;
+            	&lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;rel&quot; id=&quot;rel&quot; size=&quot;50&quot; value=&quot;&lt;?php echo $link_rel; ?&gt;&quot; /&gt;&lt;/td&gt;
+           	&lt;/tr&gt;
+            &lt;tr&gt;
+                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('&lt;a href=&quot;<A HREF="http://gmpg.org/xfn/">http://gmpg.org/xfn/</A>&quot;&gt;XFN&lt;/a&gt; Creator:') ?&gt;&lt;/th&gt;
+            	&lt;td&gt;
+					&lt;table cellpadding=&quot;3&quot; cellspacing=&quot;5&quot;&gt;
+	          &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('identity') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;me&quot;&gt;
+                &lt;input type=&quot;checkbox&quot; name=&quot;identity&quot; value=&quot;me&quot; id=&quot;me&quot; &lt;?php xfn_check('identity', 'me'); ?&gt; /&gt;
+          &lt;?php _e('another web address of mine') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('friendship') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+			    &lt;label for=&quot;contact&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;contact&quot; id=&quot;contact&quot; &lt;?php xfn_check('friendship', 'contact', 'radio'); ?&gt; /&gt; &lt;?php _e('contact') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;acquaintance&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;acquaintance&quot; id=&quot;acquaintance&quot; &lt;?php xfn_check('friendship', 'acquaintance', 'radio'); ?&gt; /&gt;  &lt;?php _e('acquaintance') ?&gt;&lt;/label&gt;
+                &lt;label id=&quot;friend&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;friendship&quot; value=&quot;friend&quot; id=&quot;friend&quot; &lt;?php xfn_check('friendship', 'friend', 'radio'); ?&gt; /&gt; &lt;?php _e('friend') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;friendship&quot;&gt;
+                &lt;input name=&quot;friendship&quot; type=&quot;radio&quot; class=&quot;valinp&quot; value=&quot;&quot; id=&quot;friendship&quot; &lt;?php xfn_check('friendship', '', 'radio'); ?&gt; /&gt; &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('physical') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;met&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;physical&quot; value=&quot;met&quot; id=&quot;met&quot; &lt;?php xfn_check('physical', 'met'); ?&gt; /&gt;
+          &lt;?php _e('met') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('professional') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;co-worker&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;professional&quot; value=&quot;co-worker&quot; id=&quot;co-worker&quot; &lt;?php xfn_check('professional', 'co-worker'); ?&gt; /&gt;
+          &lt;?php _e('co-worker') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;colleague&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;professional&quot; value=&quot;colleague&quot; id=&quot;colleague&quot; &lt;?php xfn_check('professional', 'colleague'); ?&gt; /&gt;
+          &lt;?php _e('colleague') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('geographical') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;co-resident&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;co-resident&quot; id=&quot;co-resident&quot; &lt;?php xfn_check('geographical', 'co-resident', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('co-resident') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;neighbor&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;neighbor&quot; id=&quot;neighbor&quot; &lt;?php xfn_check('geographical', 'neighbor', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('neighbor') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;geographical&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;geographical&quot; value=&quot;&quot; id=&quot;geographical&quot; &lt;?php xfn_check('geographical', '', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('family') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;child&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;child&quot; id=&quot;child&quot; &lt;?php xfn_check('family', 'child', 'radio'); ?&gt;  /&gt;
+          &lt;?php _e('child') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;kin&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;kin&quot; id=&quot;kin&quot; &lt;?php xfn_check('family', 'kin', 'radio'); ?&gt;  /&gt;
+          &lt;?php _e('kin') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;parent&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;parent&quot; id=&quot;parent&quot; &lt;?php xfn_check('family', 'parent', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('parent') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;sibling&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;sibling&quot; id=&quot;sibling&quot; &lt;?php xfn_check('family', 'sibling', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('sibling') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;spouse&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;spouse&quot; id=&quot;spouse&quot; &lt;?php xfn_check('family', 'spouse', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('spouse') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;family&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;radio&quot; name=&quot;family&quot; value=&quot;&quot; id=&quot;family&quot; &lt;?php xfn_check('family', '', 'radio'); ?&gt; /&gt;
+          &lt;?php _e('none') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+            &lt;tr&gt;
+              &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('romantic') ?&gt; &lt;/th&gt;
+              &lt;td&gt;
+                &lt;label for=&quot;muse&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;muse&quot; id=&quot;muse&quot; &lt;?php xfn_check('romantic', 'muse'); ?&gt; /&gt;
+         &lt;?php _e('muse') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;crush&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;crush&quot; id=&quot;crush&quot; &lt;?php xfn_check('romantic', 'crush'); ?&gt; /&gt;
+         &lt;?php _e('crush') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;date&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;date&quot; id=&quot;date&quot; &lt;?php xfn_check('romantic', 'date'); ?&gt; /&gt;
+         &lt;?php _e('date') ?&gt;&lt;/label&gt;
+                &lt;label for=&quot;romantic&quot;&gt;
+                &lt;input class=&quot;valinp&quot; type=&quot;checkbox&quot; name=&quot;romantic&quot; value=&quot;sweetheart&quot; id=&quot;romantic&quot; &lt;?php xfn_check('romantic', 'sweetheart'); ?&gt; /&gt;
+         &lt;?php _e('sweetheart') ?&gt;&lt;/label&gt;
+              &lt;/td&gt;
+            &lt;/tr&gt;
+        &lt;/table&gt;
+		  &lt;/td&gt;
+           	&lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+       &lt;p class=&quot;submit&quot;&gt;
+       &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Save Changes &raquo;') ?&gt;&quot; /&gt;
+       &lt;/p&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('Advanced') ?&gt;&lt;/legend&gt;
+        &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+         &lt;tr&gt;
+           &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Image URI:') ?&gt;&lt;/th&gt;
+           &lt;td width=&quot;67%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;image&quot; size=&quot;50&quot; value=&quot;&lt;?php echo $link_image; ?&gt;&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('RSS URI:') ?&gt; &lt;/th&gt;
+           &lt;td&gt;&lt;input name=&quot;rss_uri&quot; type=&quot;text&quot; id=&quot;rss_uri&quot; value=&quot;&lt;?php echo $link_rss_uri; ?&gt;&quot; size=&quot;50&quot; style=&quot;width: 95%&quot; /&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Notes:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;textarea name=&quot;notes&quot; cols=&quot;50&quot; rows=&quot;10&quot; style=&quot;width: 95%&quot;&gt;&lt;?php echo $link_notes; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Rating:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;select name=&quot;rating&quot; size=&quot;1&quot;&gt;
+&lt;?php
+    for ($r = 0; $r &lt; 10; $r++) {
+      echo('            &lt;option value=&quot;'.$r.'&quot; ');
+      if ($link_rating == $r)
+        echo 'selected=&quot;selected&quot;';
+      echo('&gt;'.$r.'&lt;/option&gt;');
+    }
+?&gt;
+           &lt;/select&gt;
+         &nbsp;&lt;?php _e('(Leave at 0 for no rating.)') ?&gt; &lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Target') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;label&gt;
+          &lt;input type=&quot;radio&quot; name=&quot;target&quot; value=&quot;_blank&quot;   &lt;?php echo(($link_target == '_blank') ? 'checked=&quot;checked&quot;' : ''); ?&gt; /&gt;
+          &lt;code&gt;_blank&lt;/code&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;label&gt;
+&lt;input type=&quot;radio&quot; name=&quot;target&quot; value=&quot;_top&quot; &lt;?php echo(($link_target == '_top') ? 'checked=&quot;checked&quot;' : ''); ?&gt; /&gt;
+&lt;code&gt;_top&lt;/code&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;label&gt;
+&lt;input type=&quot;radio&quot; name=&quot;target&quot; value=&quot;&quot;     &lt;?php echo(($link_target == '') ? 'checked=&quot;checked&quot;' : ''); ?&gt; /&gt;
+&lt;?php _e('none') ?&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;?php _e('(Note that the &lt;code&gt;target&lt;/code&gt; attribute is illegal in XHTML 1.1 and 1.0 Strict.)') ?&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+         &lt;tr&gt;
+           &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Visible:') ?&gt;&lt;/th&gt;
+           &lt;td&gt;&lt;label&gt;
+             &lt;input type=&quot;radio&quot; name=&quot;visible&quot; &lt;?php if ($link_visible == 'Y') echo &quot;checked='checked'&quot;; ?&gt; value=&quot;Y&quot; /&gt;
+&lt;?php _e('Yes') ?&gt;&lt;/label&gt;&lt;br /&gt;&lt;label&gt;
+&lt;input type=&quot;radio&quot; name=&quot;visible&quot; &lt;?php if ($link_visible == 'N') echo &quot;checked='checked'&quot;; ?&gt; value=&quot;N&quot; /&gt;
+&lt;?php _e('No') ?&gt;&lt;/label&gt;&lt;/td&gt;
+         &lt;/tr&gt;
+&lt;/table&gt;
+&lt;/fieldset&gt;
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Save Changes &raquo;') ?&gt;&quot; /&gt;
+          &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;editlink&quot; /&gt;
+          &lt;input type=&quot;hidden&quot; name=&quot;link_id&quot; value=&quot;&lt;?php echo (int) $link_id; ?&gt;&quot; /&gt;
+          &lt;input type=&quot;hidden&quot; name=&quot;order_by&quot; value=&quot;&lt;?php echo wp_specialchars($order_by, 1); ?&gt;&quot; /&gt;
+          &lt;input type=&quot;hidden&quot; name=&quot;cat_id&quot; value=&quot;&lt;?php echo (int) $cat_id ?&gt;&quot; /&gt;&lt;/p&gt;
+  &lt;/form&gt;
+&lt;/div&gt;
+&lt;?php
+    break;
+  } // end linkedit
+  case __(&quot;Show&quot;):
+  {
+    if (!isset($cat_id) || ($cat_id == '')) {
+        if (!isset($links_show_cat_id) || ($links_show_cat_id == ''))
+        $cat_id = 'All';
+    }
+    $links_show_cat_id = $cat_id;
+    if (!isset($order_by) || ($order_by == '')) {
+        if (!isset($links_show_order) || ($links_show_order == ''))
+        $order_by = 'order_name';
+    }
+    $links_show_order = $order_by;
+    //break; fall through
+  } // end Show
+  case &quot;popup&quot;:
+  {
+    $link_url = stripslashes($_GET[&quot;linkurl&quot;]);
+    $link_name = stripslashes($_GET[&quot;name&quot;]);
+    //break; fall through
+  }
+  default:
+  {
+    if (isset($links_show_cat_id) &amp;&amp; ($links_show_cat_id != ''))
+        $cat_id = $links_show_cat_id;
+
+    if (!isset($cat_id) || ($cat_id == '')) {
+        if (!isset($links_show_cat_id) || ($links_show_cat_id == ''))
+        $cat_id = 'All';
+    }
+    $links_show_cat_id = $cat_id;
+    if (isset($links_show_order) &amp;&amp; ($links_show_order != ''))
+        $order_by = $links_show_order;
+
+    if (!isset($order_by) || ($order_by == ''))
+        $order_by = 'order_name';
+    $links_show_order = $order_by;
+
+    setcookie('links_show_cat_id_' . COOKIEHASH, $links_show_cat_id, time()+600);
+    setcookie('links_show_order_' . COOKIEHASH, $links_show_order, time()+600);
+    include_once (&quot;./admin-header.php&quot;);
+    if ($user_level &lt; 5) {
+      die(__(&quot;You do not have sufficient permissions to edit the links for this blog.&quot;));
+    }
+
+    switch ($order_by)
+    {
+        case 'order_id':     $sqlorderby = 'id';          break;
+        case 'order_url':    $sqlorderby = 'url';         break;
+        case 'order_desc':   $sqlorderby = 'description'; break;
+        case 'order_owner':  $sqlorderby = 'owner';       break;
+        case 'order_rating': $sqlorderby = 'rating';      break;
+        case 'order_name':
+        default:             $sqlorderby = 'name';        break;
+    }
+
+  if ($action != &quot;popup&quot;) {
+?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+function checkAll(form)
+{
+	for (i = 0, n = form.elements.length; i &lt; n; i++) {
+		if(form.elements[i].type == &quot;checkbox&quot;) {
+			if(form.elements[i].checked == true)
+				form.elements[i].checked = false;
+			else
+				form.elements[i].checked = true;
+		}
+	}
+}
+//--&gt;
+&lt;/script&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+    &lt;form name=&quot;cats&quot; method=&quot;post&quot; action=&quot;&quot;&gt;
+    &lt;table width=&quot;75%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+      &lt;tr&gt;
+        &lt;td&gt;
+        &lt;?php _e('&lt;strong&gt;Show&lt;/strong&gt; links in category:'); ?&gt;&lt;br /&gt;
+        &lt;/td&gt;
+        &lt;td&gt;
+          &lt;?php _e('&lt;strong&gt;Order&lt;/strong&gt; by:');?&gt;
+        &lt;/td&gt;
+		&lt;td&gt;&nbsp;&lt;/td&gt;
+      &lt;/tr&gt;
+      &lt;tr&gt;
+        &lt;td&gt;
+&lt;?php
+    $results = $wpdb-&gt;get_results(&quot;SELECT cat_id, cat_name, auto_toggle FROM $wpdb-&gt;linkcategories ORDER BY cat_id&quot;);
+    echo &quot;        &lt;select name=\&quot;cat_id\&quot;&gt;\n&quot;;
+    echo &quot;          &lt;option value=\&quot;All\&quot;&quot;;
+    if ($cat_id == 'All')
+      echo &quot; selected='selected'&quot;;
+    echo &quot;&gt; &quot; . __('All') . &quot;&lt;/option&gt;\n&quot;;
+    foreach ($results as $row) {
+      echo &quot;          &lt;option value=\&quot;&quot;.$row-&gt;cat_id.&quot;\&quot;&quot;;
+      if ($row-&gt;cat_id == $cat_id)
+        echo &quot; selected='selected'&quot;;
+        echo &quot;&gt;&quot;.$row-&gt;cat_id.&quot;: &quot;.wp_specialchars($row-&gt;cat_name);
+        if ($row-&gt;auto_toggle == 'Y')
+            echo ' (auto toggle)';
+        echo &quot;&lt;/option&gt;\n&quot;;
+    }
+    echo &quot;        &lt;/select&gt;\n&quot;;
+?&gt;
+        &lt;/td&gt;
+        &lt;td&gt;
+          &lt;select name=&quot;order_by&quot;&gt;
+            &lt;option value=&quot;order_id&quot;     &lt;?php if ($order_by == 'order_id')     echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('Link ID') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;order_name&quot;   &lt;?php if ($order_by == 'order_name')   echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('Name') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;order_url&quot;    &lt;?php if ($order_by == 'order_url')    echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('URI') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;order_desc&quot;   &lt;?php if ($order_by == 'order_desc')   echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('Description') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;order_owner&quot;  &lt;?php if ($order_by == 'order_owner')  echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('Owner') ?&gt;&lt;/option&gt;
+            &lt;option value=&quot;order_rating&quot; &lt;?php if ($order_by == 'order_rating') echo &quot; selected='selected'&quot;;?&gt;&gt;&lt;?php _e('Rating') ?&gt;&lt;/option&gt;
+          &lt;/select&gt;
+        &lt;/td&gt;
+        &lt;td&gt;
+          &lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;&lt;?php _e('Show') ?&gt;&quot; /&gt;
+        &lt;/td&gt;
+      &lt;/tr&gt;
+    &lt;/table&gt;
+    &lt;/form&gt;
+
+&lt;/div&gt;
+
+&lt;form name=&quot;links&quot; id=&quot;links&quot; method=&quot;post&quot; action=&quot;&quot;&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+
+    &lt;input type=&quot;hidden&quot; name=&quot;link_id&quot; value=&quot;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;order_by&quot; value=&quot;&lt;?php echo wp_specialchars($order_by, 1); ?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;cat_id&quot; value=&quot;&lt;?php echo (int) $cat_id ?&gt;&quot; /&gt;
+  &lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+    &lt;tr&gt;
+      &lt;th width=&quot;15%&quot;&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&lt;?php _e('URI') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&lt;?php _e('Category') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&lt;?php _e('rel') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&lt;?php _e('Image') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&lt;?php _e('Visible') ?&gt;&lt;/th&gt;
+      &lt;th colspan=&quot;2&quot;&gt;&lt;?php _e('Action') ?&gt;&lt;/th&gt;
+      &lt;th&gt;&nbsp;&lt;/th&gt;
+  &lt;/tr&gt;
+&lt;?php
+    $sql = &quot;SELECT link_url, link_name, link_image, link_description, link_visible,
+            link_category AS cat_id, cat_name AS category, $wpdb-&gt;users.user_login, link_id,
+            link_rating, link_rel, $wpdb-&gt;users.user_level
+            FROM $wpdb-&gt;links
+            LEFT JOIN $wpdb-&gt;linkcategories ON $wpdb-&gt;links.link_category = $wpdb-&gt;linkcategories.cat_id
+            LEFT JOIN $wpdb-&gt;users ON $wpdb-&gt;users.ID = $wpdb-&gt;links.link_owner &quot;;
+
+    if (isset($cat_id) &amp;&amp; ($cat_id != 'All')) {
+      $sql .= &quot; WHERE link_category = $cat_id &quot;;
+    }
+    $sql .= ' ORDER BY link_' . $sqlorderby;
+
+    // echo &quot;$sql&quot;;
+    $links = $wpdb-&gt;get_results($sql);
+    if ($links) {
+        foreach ($links as $link) {
+      	    $link-&gt;link_name = wp_specialchars($link-&gt;link_name);
+      	    $link-&gt;link_category = wp_specialchars($link-&gt;link_category);
+      	    $link-&gt;link_description = wp_specialchars($link-&gt;link_description);
+            $link-&gt;link_url = wp_specialchars($link-&gt;link_url);
+            $short_url = str_replace('<A HREF="http://">http://</A>', '', $link-&gt;link_url);
+            $short_url = str_replace('www.', '', $short_url);
+            if ('/' == substr($short_url, -1))
+                $short_url = substr($short_url, 0, -1);
+            if (strlen($short_url) &gt; 35)
+                $short_url =  substr($short_url, 0, 32).'...';
+
+            $image = ($link-&gt;link_image != null) ? __('Yes') : __('No');
+            $visible = ($link-&gt;link_visible == 'Y') ? __('Yes') : __('No');
+            ++$i;
+            $style = ($i % 2) ? ' class=&quot;alternate&quot;' : '';
+?&gt;
+    &lt;tr valign=&quot;middle&quot; &lt;?php echo $style; ?&gt;&gt;
+		&lt;td&gt;&lt;strong&gt;&lt;?php echo $link-&gt;link_name; ?&gt;&lt;/strong&gt;&lt;br /&gt;
+&lt;?php
+        echo sprintf(__('Description: %s'), $link-&gt;link_description) . &quot;&lt;/td&gt;&quot;;
+        echo &quot;&lt;td&gt;&lt;a href=\&quot;$link-&gt;link_url\&quot; title=\&quot;&quot; . sprintf(__('Visit %s'), $link-&gt;link_name) . &quot;\&quot;&gt;$short_url&lt;/a&gt;&lt;/td&gt;&quot;;
+        echo &lt;&lt;&lt;LINKS
+        &lt;td&gt;$link-&gt;category&lt;/td&gt;
+        &lt;td&gt;$link-&gt;link_rel&lt;/td&gt;
+        &lt;td align='center'&gt;$image&lt;/td&gt;
+        &lt;td align='center'&gt;$visible&lt;/td&gt;
+LINKS;
+            $show_buttons = 1; // default
+
+            if ($link-&gt;user_level &gt; $user_level) {
+              $show_buttons = 0;
+            }
+
+            if ($show_buttons) {
+        echo '&lt;td&gt;&lt;a href=&quot;link-manager.php?link_id=' . $link-&gt;link_id . '&amp;action=linkedit&quot; class=&quot;edit&quot;&gt;' . __('Edit') . '&lt;/a&gt;&lt;/td&gt;';
+        echo '&lt;td&gt;&lt;a href=&quot;link-manager.php?link_id=' . $link-&gt;link_id . '&amp;action=Delete&quot;' .  &quot; onclick=\&quot;return confirm('&quot; . __(&quot;You are about to delete this link.\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;) .  &quot;');&quot; . '&quot; class=&quot;delete&quot;&gt;' . __('Delete') . '&lt;/a&gt;&lt;/td&gt;';
+        echo '&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;linkcheck[]&quot; value=&quot;' . $link-&gt;link_id . '&quot; /&gt;&lt;/td&gt;';
+            } else {
+              echo &quot;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;&lt;td&gt;&nbsp;&lt;/td&gt;\n&quot;;
+            }
+		echo &quot;\n\t&lt;/tr&gt;&quot;;
+        }
+    }
+?&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+	&lt;p&gt;&lt;?php _e('Manage Multiple Links:') ?&gt;&lt;/p&gt;
+	&lt;p&gt;&lt;?php _e('Use the checkboxes on the right to select multiple links and choose an action below:') ?&gt;&lt;/p&gt;
+	&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;td&gt;
+			&lt;p&gt;&lt;?php _e('Assign ownership to:'); ?&gt;&lt;/p&gt;
+				&lt;select name=&quot;newowner&quot; size=&quot;1&quot;&gt;
+&lt;?php
+	$results = $wpdb-&gt;get_results(&quot;SELECT ID, user_login FROM $wpdb-&gt;users WHERE user_level &gt; 0 ORDER BY ID&quot;);
+	foreach ($results as $row)
+	{
+		echo &quot;\t\t\t\t\t&lt;option value=\&quot;&quot;.$row-&gt;ID.&quot;\&quot;&quot;;
+		echo &quot;&gt;&quot;.$row-&gt;user_login;
+		echo &quot;&lt;/option&gt;\n&quot;;
+	}
+?&gt;
+				&lt;/select&gt;
+			&lt;br /&gt;
+			&lt;input name=&quot;assign&quot; type=&quot;submit&quot; id=&quot;assign&quot; value=&quot;&lt;?php _e('Go') ?&gt;&quot; /&gt;
+			&lt;/td&gt;
+			&lt;td&gt;
+				&lt;br /&gt;
+				&lt;input name=&quot;visibility&quot; type=&quot;submit&quot; id=&quot;visibility&quot; value=&quot;&lt;?php _e('Toggle Visibility') ?&gt;&quot; /&gt;
+			&lt;/td&gt;
+			&lt;td&gt;
+				&lt;p&gt;&lt;?php _e('Move to category:'); ?&gt;&lt;/p&gt;
+&lt;?php category_dropdown('category'); ?&gt;
+			&lt;br /&gt;
+			&lt;input name=&quot;move&quot; type=&quot;submit&quot; id=&quot;move&quot; value=&quot;&lt;?php _e('Go') ?&gt;&quot; /&gt;
+			&lt;/td&gt;
+			&lt;td align=&quot;right&quot; class=&quot;togl&quot;&gt;
+				&lt;a href=&quot;#&quot; onclick=&quot;checkAll(document.getElementById('links')); return false; &quot;&gt;&lt;?php _e('Toggle Checkboxes') ?&gt;&lt;/a&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+
+&lt;?php
+  } // end if !popup
+?&gt;
+&lt;/div&gt;
+&lt;/form&gt;
+
+
+&lt;?php
+    break;
+  } // end default
+} // end case
+?&gt;
+
+&lt;?php include('admin-footer.php'); ?&gt;

Added: trunk/wp-admin/link-parse-opml.php
===================================================================
--- trunk/wp-admin/link-parse-opml.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/link-parse-opml.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,65 @@
+&lt;?php
+require_once('../wp-config.php');
+
+// columns we wish to find are:  link_url, link_name, link_target, link_description
+// we need to map XML attribute names to our columns
+$opml_map = array('URL'         =&gt; 'link_url',
+                  'HTMLURL'     =&gt; 'link_url',
+                  'TEXT'        =&gt; 'link_name',
+                  'TITLE'       =&gt; 'link_name',
+                  'TARGET'      =&gt; 'link_target',
+                  'DESCRIPTION' =&gt; 'link_description',
+                  'XMLURL'      =&gt; 'link_rss'
+);
+
+$map = $opml_map;
+
+/**
+ ** startElement()
+ ** Callback function. Called at the start of a new xml tag.
+ **/
+function startElement($parser, $tagName, $attrs) {
+	global $updated_timestamp, $all_links, $map;
+    global $names, $urls, $targets, $descriptions, $feeds;
+
+	if ($tagName == 'OUTLINE') {
+        foreach (array_keys($map) as $key) {
+            if (isset($attrs[$key])) {
+                $$map[$key] = $attrs[$key];
+            }
+        }
+
+        //echo(&quot;got data: link_url = [$link_url], link_name = [$link_name], link_target = [$link_target], link_description = [$link_description]&lt;br /&gt;\n&quot;);
+
+        // save the data away.
+        $names[] = $link_name;
+        $urls[] = $link_url;
+        $targets[] = $link_target;
+		$feeds[] = $link_rss;
+        $descriptions[] = $link_description;
+    } // end if outline
+}
+
+/**
+ ** endElement()
+ ** Callback function. Called at the end of an xml tag.
+ **/
+function endElement($parser, $tagName) {
+	// nothing to do.
+}
+
+// Create an XML parser
+$xml_parser = xml_parser_create();
+
+// Set the functions to handle opening and closing tags
+xml_set_element_handler($xml_parser, &quot;startElement&quot;, &quot;endElement&quot;);
+
+if (!xml_parse($xml_parser, $opml, true)) {
+    echo(sprintf(&quot;XML error: %s at line %d&quot;,
+                   xml_error_string(xml_get_error_code($xml_parser)),
+                   xml_get_current_line_number($xml_parser)));
+}
+
+// Free up memory used by the XML parser
+xml_parser_free($xml_parser);
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/menu-header.php
===================================================================
--- trunk/wp-admin/menu-header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/menu-header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,92 @@
+&lt;ul id=&quot;adminmenu&quot;&gt;
+&lt;?php
+$self = preg_replace('|^.*/wp-admin/|i', '', $_SERVER['PHP_SELF']);
+$self = preg_replace('|^.*/plugins/|i', '', $self);
+
+get_admin_page_parent();
+
+foreach ($menu as $item)
+{
+	$class = '';
+
+	// 0 = name, 1 = user_level, 2 = file
+	if (( strcmp($self, $item[2]) == 0 &amp;&amp; empty($parent_file)) || ($parent_file &amp;&amp; ($item[2] == $parent_file)))
+	{
+		$class = ' class=&quot;current&quot;';
+	}
+
+	if ($user_level &gt;= $item[1])
+	{
+		if ( file_exists(ABSPATH . &quot;wp-content/plugins/{$item[2]}&quot;) )
+		{
+			echo &quot;\n\t&lt;li&gt;&lt;a href='&quot; . get_settings('siteurl') . &quot;/wp-admin/admin.php?page={$item[2]}'$class&gt;{$item[0]}&lt;/a&gt;&lt;/li&gt;&quot;;
+		}
+		else
+		{
+			echo &quot;\n\t&lt;li&gt;&lt;a href='&quot; . get_settings('siteurl') . &quot;/wp-admin/{$item[2]}'$class&gt;{$item[0]}&lt;/a&gt;&lt;/li&gt;&quot;;
+		}
+	}
+}
+echo &quot;\n&quot;;
+?&gt;
+	&lt;li class=&quot;last&quot;&gt;&lt;a href=&quot;&lt;?php echo get_settings('siteurl') ?&gt;/wp-login.php?action=logout&quot; title=&quot;&lt;?php _e('Log out of this account') ?&gt;&quot;&gt;&lt;?php printf(__('Logout (%s)'), $user_nickname) ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;/ul&gt;
+
+&lt;?php
+// Sub-menu
+if ( isset($submenu[&quot;$parent_file&quot;]) )
+{
+?&gt;
+&lt;ul id=&quot;adminmenu2&quot;&gt;
+&lt;?php
+	foreach ($submenu[&quot;$parent_file&quot;] as $item)
+	{
+		if ($user_level &lt; $item[1])
+		{
+			continue;
+		}
+
+		if ( isset($submenu_file) )
+		{
+			if ( $submenu_file == $item[2] )
+			{
+				$class = ' class=&quot;current&quot;';
+			}
+			else
+			{
+			$class = '';
+			}
+		}
+		else if ( (isset($plugin_page) &amp;&amp; $plugin_page == $item[2]) || (!isset($plugin_page) &amp;&amp; $self == $item[2]) )
+		{
+			$class = ' class=&quot;current&quot;';
+		}
+		else
+		{
+		$class = '';
+		}
+
+		$menu_hook = get_plugin_page_hook($item[2], $parent_file);
+
+		if (file_exists(ABSPATH . &quot;wp-content/plugins/{$item[2]}&quot;) || ! empty($menu_hook))
+		{
+			if ( 'admin.php' == $pagenow )
+			{
+				echo &quot;\n\t&lt;li&gt;&lt;a href='&quot; . get_settings('siteurl') . &quot;/wp-admin/admin.php?page={$item[2]}'$class&gt;{$item[0]}&lt;/a&gt;&lt;/li&gt;&quot;;
+			}
+			else
+			{
+				echo &quot;\n\t&lt;li&gt;&lt;a href='&quot; . get_settings('siteurl') . &quot;/wp-admin/{$parent_file}?page={$item[2]}'$class&gt;{$item[0]}&lt;/a&gt;&lt;/li&gt;&quot;;
+			}
+		}
+		else
+		{
+			echo &quot;\n\t&lt;li&gt;&lt;a href='&quot; . get_settings('siteurl') . &quot;/wp-admin/{$item[2]}'$class&gt;{$item[0]}&lt;/a&gt;&lt;/li&gt;&quot;;
+		}
+	}
+echo &quot;\n&quot;;
+?&gt;
+&lt;/ul&gt;
+&lt;?php
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/menu.php
===================================================================
--- trunk/wp-admin/menu.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/menu.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,55 @@
+&lt;?php
+// This array constructs the admin menu bar.
+//
+// Menu item name
+// The minimum level the user needs to access the item: between 0 and 10
+// The URL of the item's file
+$menu[0] = array(__('Dashboard'), 0, 'index.php');
+$menu[5] = array(__('Write'), 1, 'post.php');
+$menu[10] = array(__('Manage'), 1, 'edit.php');
+$menu[20] = array(__('Links'), 5, 'link-manager.php');
+$menu[25] = array(__('Presentation'), 8, 'themes.php');
+$menu[30] = array(__('Plugins'), 8, 'plugins.php');
+$menu[35] = array(__('Users'), 0, 'profile.php');
+$menu[40] = array(__('Options'), 6, 'options-general.php');
+
+if ( get_option('use_fileupload') )
+	$menu[45] = array(__('Upload'), get_settings('fileupload_minlevel'), 'upload.php');
+
+$submenu['post.php'][5] = array(__('Write Post'), 1, 'post.php');
+$submenu['post.php'][10] = array(__('Write Page'), 5, 'page-new.php');
+
+$submenu['edit.php'][5] = array(__('Posts'), 1, 'edit.php');
+$submenu['edit.php'][10] = array(__('Pages'), 5, 'edit-pages.php');
+$submenu['edit.php'][15] = array(__('Categories'), 1, 'categories.php');
+$submenu['edit.php'][20] = array(__('Comments'), 1, 'edit-comments.php');
+$awaiting_mod = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;comments WHERE comment_approved = '0'&quot;);
+$submenu['edit.php'][25] = array(sprintf(__(&quot;Awaiting Moderation (%s)&quot;), $awaiting_mod), 1, 'moderation.php');
+
+$submenu['link-manager.php'][5] = array(__('Manage Links'), 5, 'link-manager.php');
+$submenu['link-manager.php'][10] = array(__('Add Link'), 5, 'link-add.php');
+$submenu['link-manager.php'][15] = array(__('Link Categories'), 5, 'link-categories.php');
+$submenu['link-manager.php'][20] = array(__('Import Links'), 5, 'link-import.php');
+
+$submenu['profile.php'][5] = array(__('Your Profile'), 0, 'profile.php');
+$submenu['profile.php'][10] = array(__('Authors &amp; Users'), 5, 'users.php');
+
+$submenu['options-general.php'][5] = array(__('General'), 6, 'options-general.php');
+$submenu['options-general.php'][10] = array(__('Writing'), 6, 'options-writing.php');
+$submenu['options-general.php'][15] = array(__('Reading'), 6, 'options-reading.php');
+$submenu['options-general.php'][20] = array(__('Discussion'), 6, 'options-discussion.php');
+$submenu['options-general.php'][25] = array(__('Permalinks'), 6, 'options-permalink.php');
+
+// Create list of page plugin hook names.
+foreach ($menu as $menu_page) {
+	$admin_page_hooks[$menu_page[2]] = sanitize_title($menu_page[0]);
+}
+
+do_action('admin_menu', '');
+ksort($menu); // make it all pretty
+
+if (! user_can_access_admin_page()) {
+	die( __('You do not have sufficient permissions to access this page.') );
+}
+
+?&gt;

Added: trunk/wp-admin/moderation.php
===================================================================
--- trunk/wp-admin/moderation.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/moderation.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,220 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Moderate comments');
+$parent_file = 'edit.php';
+
+$wpvarstoreset = array('action', 'item_ignored', 'item_deleted', 'item_approved', 'item_spam', 'feelinglucky');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+$comment = array();
+if (isset($_POST[&quot;comment&quot;])) {
+	foreach ($_POST[&quot;comment&quot;] as $k =&gt; $v) {
+		$comment[intval($k)] = $v;
+	}
+}
+
+switch($action) {
+
+case 'update':
+
+	if ($user_level &lt; 3) {
+		die(__('&lt;p&gt;Your level is not high enough to moderate comments.&lt;/p&gt;'));
+	}
+
+	$item_ignored = 0;
+	$item_deleted = 0;
+	$item_approved = 0;
+	$item_spam = 0;
+
+	foreach($comment as $key =&gt; $value) {
+	if ($feelinglucky &amp;&amp; 'later' == $value)
+		$value = 'delete';
+	    switch($value) {
+			case 'later':
+				// do nothing with that comment
+				// wp_set_comment_status($key, &quot;hold&quot;);
+				++$item_ignored;
+				break;
+			case 'delete':
+				wp_set_comment_status($key, 'delete');
+				++$item_deleted;
+				break;
+ 			case 'spam':
+ 				wp_set_comment_status($key, 'spam');
+ 				++$item_spam;
+ 				break;
+			case 'approve':
+				wp_set_comment_status($key, 'approve');
+				if ( get_settings('comments_notify') == true ) {
+					wp_notify_postauthor($key);
+				}
+				++$item_approved;
+				break;
+	    }
+	}
+
+	$file = basename(__FILE__);
+	header(&quot;Location: $file?ignored=$item_ignored&amp;deleted=$item_deleted&amp;approved=$item_approved&amp;spam=$item_spam&quot;);
+	exit();
+
+break;
+
+default:
+
+require_once('admin-header.php');
+
+if ( isset($_GET['deleted']) || isset($_GET['approved']) || isset($_GET['ignored']) ) {
+	echo &quot;&lt;div class='updated'&gt;\n&lt;p&gt;&quot;;
+	$approved = (int) $_GET['approved'];
+	$deleted  = (int) $_GET['deleted'];
+	$ignored  = (int) $_GET['ignored'];
+	$spam     = (int) $_GET['spam'];
+	if ($approved) {
+		if ('1' == $approved) {
+		 echo __(&quot;1 comment approved &lt;br /&gt;&quot;) . &quot;\n&quot;;
+		} else {
+		 echo sprintf(__(&quot;%s comments approved &lt;br /&gt;&quot;), $approved) . &quot;\n&quot;;
+		}
+	}
+	if ($deleted) {
+		if ('1' == $deleted) {
+		echo __(&quot;1 comment deleted &lt;br /&gt;&quot;) . &quot;\n&quot;;
+		} else {
+		echo sprintf(__(&quot;%s comments deleted &lt;br /&gt;&quot;), $deleted) . &quot;\n&quot;;
+		}
+	}
+ 	if ($spam) {
+ 		if ('1' == $spam) {
+ 		echo __(&quot;1 comment marked as spam &lt;br /&gt;&quot;) . &quot;\n&quot;;
+ 		} else {
+ 		echo sprintf(__(&quot;%s comments marked as spam &lt;br /&gt;&quot;), $spam) . &quot;\n&quot;;
+ 		}
+ 	}
+	if ($ignored) {
+		if ('1' == $ignored) {
+		echo __(&quot;1 comment unchanged &lt;br /&gt;&quot;) . &quot;\n&quot;;
+		} else {
+		echo sprintf(__(&quot;%s comments unchanged &lt;br /&gt;&quot;), $ignored) . &quot;\n&quot;;
+		}
+	}
+	echo &quot;&lt;/p&gt;&lt;/div&gt;\n&quot;;
+}
+
+?&gt;
+	
+&lt;div class=&quot;wrap&quot;&gt;
+
+&lt;?php
+if ($user_level &gt; 3)
+	$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_approved = '0'&quot;);
+else
+	$comments = '';
+
+if ($comments) {
+    // list all comments that are waiting for approval
+    $file = basename(__FILE__);
+?&gt;
+    &lt;h2&gt;&lt;?php _e('Moderation Queue') ?&gt;&lt;/h2&gt;
+    &lt;form name=&quot;approval&quot; action=&quot;moderation.php&quot; method=&quot;post&quot;&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt;
+    &lt;ol id=&quot;comments&quot; class=&quot;commentlist&quot;&gt;
+&lt;?php
+$i = 0;
+    foreach($comments as $comment) {
+	++$i;
+	$comment_date = mysql2date(get_settings(&quot;date_format&quot;) . &quot; @ &quot; . get_settings(&quot;time_format&quot;), $comment-&gt;comment_date);
+	$post_title = $wpdb-&gt;get_var(&quot;SELECT post_title FROM $wpdb-&gt;posts WHERE ID='$comment-&gt;comment_post_ID'&quot;);
+	if ($i % 2) $class = 'class=&quot;alternate&quot;';
+	else $class = '';
+	echo &quot;\n\t&lt;li id='comment-$comment-&gt;comment_ID' $class&gt;&quot;; 
+	?&gt;
+			&lt;p&gt;&lt;strong&gt;&lt;?php _e('Name:') ?&gt;&lt;/strong&gt; &lt;?php comment_author_link() ?&gt; &lt;?php if ($comment-&gt;comment_author_email) { ?&gt;| &lt;strong&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/strong&gt; &lt;?php comment_author_email_link() ?&gt; &lt;?php } if ($comment-&gt;comment_author_email) { ?&gt; | &lt;strong&gt;&lt;?php _e('URI:') ?&gt;&lt;/strong&gt; &lt;?php comment_author_url_link() ?&gt; &lt;?php } ?&gt;| &lt;strong&gt;&lt;?php _e('IP:') ?&gt;&lt;/strong&gt; &lt;a href=&quot;<A HREF="http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php">http://ws.arin.net/cgi-bin/whois.pl?queryinput=&lt;?php</A> comment_author_IP() ?&gt;&quot;&gt;&lt;?php comment_author_IP() ?&gt;&lt;/a&gt;&lt;/p&gt;
+&lt;?php comment_text() ?&gt;
+&lt;p&gt;&lt;?php
+echo '&lt;a href=&quot;post.php?action=editcomment&amp;comment='.$comment-&gt;comment_ID.'&quot;&gt;' . __('Edit') . '&lt;/a&gt; | ';?&gt;
+&lt;a href=&quot;&lt;?php echo get_permalink($comment-&gt;comment_post_ID); ?&gt;&quot;&gt;&lt;?php _e('View Post') ?&gt;&lt;/a&gt; | 
+&lt;?php 
+echo &quot; &lt;a href=\&quot;post.php?action=deletecomment&amp;p=&quot;.$comment-&gt;comment_post_ID.&quot;&amp;comment=&quot;.$comment-&gt;comment_ID.&quot;\&quot; onclick=\&quot;return confirm('&quot; . sprintf(__(&quot;You are about to delete this comment by \'%s\'\\n  \'Cancel\' to stop, \'OK\' to delete.&quot;), $comment-&gt;comment_author) . &quot;')\&quot;&gt;&quot; . __('Delete just this comment') . &quot;&lt;/a&gt; | &quot;; ?&gt;  &lt;?php _e('Bulk action:') ?&gt;
+	&lt;input type=&quot;radio&quot; name=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]&quot; id=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-approve&quot; value=&quot;approve&quot; /&gt; &lt;label for=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-approve&quot;&gt;&lt;?php _e('Approve') ?&gt;&lt;/label&gt;
+	&lt;input type=&quot;radio&quot; name=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]&quot; id=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-spam&quot; value=&quot;spam&quot; /&gt; &lt;label for=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-spam&quot;&gt;&lt;?php _e('Spam') ?&gt;&lt;/label&gt;
+	&lt;input type=&quot;radio&quot; name=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]&quot; id=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-delete&quot; value=&quot;delete&quot; /&gt; &lt;label for=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-delete&quot;&gt;&lt;?php _e('Delete') ?&gt;&lt;/label&gt;
+	&lt;input type=&quot;radio&quot; name=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]&quot; id=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-nothing&quot; value=&quot;later&quot; checked=&quot;checked&quot; /&gt; &lt;label for=&quot;comment[&lt;?php echo $comment-&gt;comment_ID; ?&gt;]-nothing&quot;&gt;&lt;?php _e('Defer until later') ?&gt;&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;/li&gt;
+&lt;?php
+    }
+?&gt;
+    &lt;/ol&gt;
+
+    &lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Moderate Comments &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+// &lt;![CDATA[
+function markAllForDelete() {
+	for (var i=0; i&lt; document.approval.length; i++) {
+		if (document.approval[i].value == &quot;delete&quot;) {
+			document.approval[i].checked = true;
+		}
+	}
+}
+function markAllForApprove() {
+	for (var i=0; i&lt; document.approval.length; i++) {
+		if (document.approval[i].value == &quot;approve&quot;) {
+			document.approval[i].checked = true;
+		}
+	}
+}
+function markAllForDefer() {
+	for (var i=0; i&lt; document.approval.length; i++) {
+		if (document.approval[i].value == &quot;later&quot;) {
+			document.approval[i].checked = true;
+		}
+	}
+}
+function markAllAsSpam() {
+	for (var i=0; i&lt; document.approval.length; i++) {
+		if (document.approval[i].value == &quot;spam&quot;) {
+			document.approval[i].checked = true;
+		}
+	}
+}
+document.write('&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;javascript:markAllForApprove()&quot;&gt;&lt;?php _e('Mark all for approval'); ?&gt;&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;javascript:markAllAsSpam()&quot;&gt;&lt;?php _e('Mark all as spam'); ?&gt;&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;javascript:markAllForDelete()&quot;&gt;&lt;?php _e('Mark all for deletion'); ?&gt;&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;javascript:markAllForDefer()&quot;&gt;&lt;?php _e('Mark all for later'); ?&gt;&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;');
+// ]]&gt;
+&lt;/script&gt;
+
+&lt;noscript&gt;
+	&lt;p&gt;
+		&lt;input name=&quot;feelinglucky&quot; type=&quot;checkbox&quot; id=&quot;feelinglucky&quot; value=&quot;true&quot; /&gt; &lt;label for=&quot;feelinglucky&quot;&gt;&lt;?php _e('Delete every comment marked &quot;defer.&quot; &lt;strong&gt;Warning: This can&#8217;t be undone.&lt;/strong&gt;'); ?&gt;&lt;/label&gt;
+	&lt;/p&gt;
+&lt;/noscript&gt;
+    &lt;/form&gt;
+&lt;?php
+} else {
+    // nothing to approve
+    echo __(&quot;&lt;p&gt;Currently there are no comments for you to moderate.&lt;/p&gt;&quot;) . &quot;\n&quot;;
+}
+?&gt;
+
+&lt;/div&gt;
+
+&lt;?php
+
+break;
+}
+
+
+include('admin-footer.php') ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options-discussion.php
===================================================================
--- trunk/wp-admin/options-discussion.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-discussion.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,100 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Discussion Options');
+$parent_file = 'options-general.php';
+
+include('admin-header.php');
+
+if ($action == 'retrospam') {
+	if ( $_GET['move'] == 'true' ) {
+		retrospam_mgr::move_spam( $_GET[ids] );
+	}
+	$retrospaminator = new retrospam_mgr();
+	$result = $retrospaminator-&gt;find_spam();
+	echo $retrospaminator-&gt;display_edit_form( $result );
+	include('./admin-footer.php');
+	exit;
+}
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt; 
+	&lt;h2&gt;&lt;?php _e('Discussion Options') ?&gt;&lt;/h2&gt; 
+	&lt;form name=&quot;form1&quot; method=&quot;post&quot; action=&quot;options.php&quot;&gt; 
+		&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt; 
+		&lt;input type=&quot;hidden&quot; name=&quot;page_options&quot; value=&quot;'default_pingback_flag','default_ping_status','default_comment_status','comments_notify','moderation_notify','comment_moderation','require_name_email','comment_whitelist','comment_max_links','moderation_keys','blacklist_keys','open_proxy_check'&quot; /&gt; 
+&lt;fieldset class=&quot;options&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('Usual settings for an article: &lt;em&gt;(These settings may be overridden for individual articles.)&lt;/em&gt;') ?&gt;&lt;/legend&gt; 
+		&lt;ul&gt; 
+			&lt;li&gt; 
+				&lt;label for=&quot;default_pingback_flag&quot;&gt; 
+				&lt;input name=&quot;default_pingback_flag&quot; type=&quot;checkbox&quot; id=&quot;default_pingback_flag&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('default_pingback_flag')); ?&gt; /&gt; 
+            &lt;?php _e('Attempt to notify any Weblogs linked to from the article (slows down posting.)') ?&gt;&lt;/label&gt; 
+			&lt;/li&gt; 
+			&lt;li&gt; 
+				&lt;label for=&quot;default_ping_status&quot;&gt; 
+				&lt;input name=&quot;default_ping_status&quot; type=&quot;checkbox&quot; id=&quot;default_ping_status&quot; value=&quot;open&quot; &lt;?php checked('open', get_settings('default_ping_status')); ?&gt; /&gt; 
+            &lt;?php _e('Allow link notifications from other Weblogs (pingbacks and trackbacks.)') ?&gt;&lt;/label&gt; 
+			&lt;/li&gt; 
+			&lt;li&gt; 
+				&lt;label for=&quot;default_comment_status&quot;&gt; 
+				&lt;input name=&quot;default_comment_status&quot; type=&quot;checkbox&quot; id=&quot;default_comment_status&quot; value=&quot;open&quot; &lt;?php checked('open', get_settings('default_comment_status')); ?&gt; /&gt; 
+            &lt;?php _e('Allow people to post comments on the article') ?&gt;&lt;/label&gt; 
+			&lt;/li&gt; 
+		&lt;/ul&gt; 
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('E-mail me whenever:') ?&gt;&lt;/legend&gt; 
+		&lt;ul&gt; 
+			&lt;li&gt; 
+				&lt;label for=&quot;comments_notify&quot;&gt; 
+				&lt;input name=&quot;comments_notify&quot; type=&quot;checkbox&quot; id=&quot;comments_notify&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('comments_notify')); ?&gt; /&gt; 
+                &lt;?php _e('Anyone posts a comment') ?&gt; &lt;/label&gt; 
+			&lt;/li&gt; 
+			&lt;li&gt; 
+				&lt;label for=&quot;moderation_notify&quot;&gt; 
+				&lt;input name=&quot;moderation_notify&quot; type=&quot;checkbox&quot; id=&quot;moderation_notify&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('moderation_notify')); ?&gt; /&gt; 
+				&lt;?php _e('A comment is held for moderation') ?&gt; &lt;/label&gt; 
+			&lt;/li&gt; 
+		&lt;/ul&gt; 
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+        &lt;legend&gt;&lt;?php _e('Before a comment appears:') ?&gt;&lt;/legend&gt; 
+		&lt;ul&gt;
+			&lt;li&gt;
+				&lt;label for=&quot;comment_moderation&quot;&gt; 
+				&lt;input name=&quot;comment_moderation&quot; type=&quot;checkbox&quot; id=&quot;comment_moderation&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('comment_moderation')); ?&gt; /&gt; 
+				&lt;?php _e('An administrator must approve the comment (regardless of any matches below)') ?&gt; &lt;/label&gt; 
+			&lt;/li&gt; 
+			&lt;li&gt;&lt;label for=&quot;require_name_email&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;require_name_email&quot; id=&quot;require_name_email&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('require_name_email')); ?&gt; /&gt; &lt;?php _e('Comment author must fill out name and e-mail') ?&gt;&lt;/label&gt;&lt;/li&gt; 
+			&lt;li&gt;&lt;label for=&quot;comment_whitelist&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;comment_whitelist&quot; id=&quot;comment_whitelist&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('comment_whitelist')); ?&gt; /&gt; &lt;?php _e('Comment author must have a previously approved comment') ?&gt;&lt;/label&gt;&lt;/li&gt; 
+		&lt;/ul&gt; 
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+    &lt;legend&gt;&lt;?php _e('Comment Moderation') ?&gt;&lt;/legend&gt;
+    &lt;p&gt;&lt;?php printf(__('Hold a comment in the queue if it contains more than %s links. (A common characteristic of comment spam is a large number of hyperlinks.)'), '&lt;input name=&quot;comment_max_links&quot; type=&quot;text&quot; id=&quot;comment_max_links&quot; size=&quot;3&quot; value=&quot;' . get_settings('comment_max_links'). '&quot; /&gt;' ) ?&gt;&lt;/p&gt;
+
+    &lt;p&gt;&lt;?php _e('When a comment contains any of these words in its content, name, URI, e-mail, or IP, hold it in the moderation queue: (Separate multiple words with new lines.) &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Spam_Words">http://codex.wordpress.org/Spam_Words</A>&quot;&gt;Common spam words&lt;/a&gt;.') ?&gt;&lt;/p&gt;
+		&lt;p&gt; 
+			&lt;textarea name=&quot;moderation_keys&quot; cols=&quot;60&quot; rows=&quot;4&quot; id=&quot;moderation_keys&quot; style=&quot;width: 98%; font-size: 12px;&quot; class=&quot;code&quot;&gt;&lt;?php form_option('moderation_keys'); ?&gt;&lt;/textarea&gt; 
+		&lt;/p&gt; 
+		&lt;p&gt;
+			&lt;a id=&quot;retrospambutton&quot; href=&quot;options-discussion.php?action=retrospam&quot;&gt;&lt;?php _e('Check past comments against moderation list'); ?&gt;&lt;/a&gt;
+ 		&lt;/p&gt; 
+&lt;/fieldset&gt;
+&lt;fieldset class=&quot;options&quot;&gt;
+    &lt;legend&gt;&lt;?php _e('Comment Blacklist') ?&gt;&lt;/legend&gt;
+    &lt;p&gt;&lt;?php _e('This is a list of words that you want completely blacklisted from your blog. Be very careful what you add here, because if a comment matches something here it will be completely nuked and there will be no notification. Remember that partial words can match, so if there is any chance something here might match it would be better to put it in the moderation box above.') ?&gt;&lt;/p&gt;
+		&lt;p&gt; 
+			&lt;textarea name=&quot;blacklist_keys&quot; cols=&quot;60&quot; rows=&quot;4&quot; id=&quot;blacklist_keys&quot; style=&quot;width: 98%; font-size: 12px;&quot; class=&quot;code&quot;&gt;&lt;?php form_option('blacklist_keys'); ?&gt;&lt;/textarea&gt; 
+		&lt;/p&gt;
+		&lt;p&gt;&lt;label for=&quot;open_proxy_check&quot;&gt; 
+				&lt;input name=&quot;open_proxy_check&quot; type=&quot;checkbox&quot; id=&quot;open_proxy_check&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('open_proxy_check')); ?&gt; /&gt; 
+            &lt;?php _e('Blacklist comments from open and insecure proxies.') ?&gt;&lt;/label&gt;&lt;/p&gt;
+&lt;/fieldset&gt;
+		&lt;p class=&quot;submit&quot;&gt; 
+    	&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Update Options') ?&gt;&quot; /&gt; 
+		&lt;/p&gt; 
+	&lt;/form&gt; 
+&lt;/div&gt;
+&lt;?php include('./admin-footer.php'); ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options-general.php
===================================================================
--- trunk/wp-admin/options-general.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-general.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,99 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('General Options');
+$parent_file = 'options-general.php';
+
+include('admin-header.php');
+?&gt;
+ 
+&lt;div class=&quot;wrap&quot;&gt; 
+  &lt;h2&gt;&lt;?php _e('General Options') ?&gt;&lt;/h2&gt; 
+  &lt;form name=&quot;form1&quot; method=&quot;post&quot; action=&quot;options.php&quot;&gt; 
+    &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt; 
+	&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt; &lt;input type=&quot;hidden&quot; name=&quot;page_options&quot; value=&quot;'blogname','blogdescription','siteurl','admin_email','users_can_register','gmt_offset','date_format','time_format','home','start_of_week','comment_registration'&quot; /&gt; 
+    &lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt; 
+      &lt;tr valign=&quot;top&quot;&gt; 
+        &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Weblog title:') ?&gt;&lt;/th&gt; 
+        &lt;td&gt;&lt;input name=&quot;blogname&quot; type=&quot;text&quot; id=&quot;blogname&quot; value=&quot;&lt;?php form_option('blogname'); ?&gt;&quot; size=&quot;40&quot; /&gt;&lt;/td&gt; 
+      &lt;/tr&gt; 
+      &lt;tr valign=&quot;top&quot;&gt; 
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Tagline:') ?&gt;&lt;/th&gt; 
+        &lt;td&gt;&lt;input name=&quot;blogdescription&quot; type=&quot;text&quot; id=&quot;blogdescription&quot; style=&quot;width: 95%&quot; value=&quot;&lt;?php form_option('blogdescription'); ?&gt;&quot; size=&quot;45&quot; /&gt;
+        &lt;br /&gt;
+&lt;?php _e('In a few words, explain what this weblog is about.') ?&gt;&lt;/td&gt; 
+      &lt;/tr&gt; 
+      &lt;tr valign=&quot;top&quot;&gt; 
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('WordPress address (URI):') ?&gt;&lt;/th&gt; 
+        &lt;td&gt;&lt;input name=&quot;siteurl&quot; type=&quot;text&quot; id=&quot;siteurl&quot; value=&quot;&lt;?php form_option('siteurl'); ?&gt;&quot; size=&quot;40&quot; class=&quot;code&quot; /&gt;&lt;/td&gt; 
+      &lt;/tr&gt; 
+      &lt;tr valign=&quot;top&quot;&gt;
+      	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Blog address (URI):') ?&gt;&lt;/th&gt;
+      	&lt;td&gt;&lt;input name=&quot;home&quot; type=&quot;text&quot; id=&quot;home&quot; value=&quot;&lt;?php form_option('home'); ?&gt;&quot; size=&quot;40&quot; class=&quot;code&quot; /&gt;&lt;br /&gt;&lt;?php _e('If you want your blog homepage to be different than the directory you installed WordPress in, enter that address here. '); ?&gt;&lt;/td&gt;
+      	&lt;/tr&gt;
+      &lt;tr valign=&quot;top&quot;&gt; 
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('E-mail address:') ?&gt; &lt;/th&gt; 
+        &lt;td&gt;&lt;input name=&quot;admin_email&quot; type=&quot;text&quot; id=&quot;admin_email&quot; value=&quot;&lt;?php form_option('admin_email'); ?&gt;&quot; size=&quot;40&quot; class=&quot;code&quot; /&gt;
+        &lt;br /&gt;
+&lt;?php _e('This address is used only for admin purposes.') ?&gt;&lt;/td&gt; 
+      &lt;/tr&gt;
+      &lt;tr valign=&quot;top&quot;&gt; 
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Membership:') ?&gt;&lt;/th&gt; 
+        &lt;td&gt; &lt;label for=&quot;users_can_register&quot;&gt; 
+          &lt;input name=&quot;users_can_register&quot; type=&quot;checkbox&quot; id=&quot;users_can_register&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('users_can_register')); ?&gt; /&gt; 
+          &lt;?php _e('Anyone can register') ?&gt;&lt;/label&gt;&lt;br /&gt;
+		  &lt;label for=&quot;comment_registration&quot;&gt;
+			&lt;input name=&quot;comment_registration&quot; type=&quot;checkbox&quot; id=&quot;comment_registration&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('comment_registration')); ?&gt; /&gt; 
+				&lt;?php _e('Users must be registered and logged in to comment') ?&gt;
+			&lt;/label&gt;
+&lt;/td&gt; 
+      &lt;/tr&gt; 
+    &lt;/table&gt; 
+    &lt;fieldset class=&quot;options&quot;&gt; 
+    &lt;legend&gt;&lt;?php _e('Date and Time') ?&gt;&lt;/legend&gt; 
+	    &lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt; 
+      &lt;tr&gt; 
+          &lt;th scope=&quot;row&quot; width=&quot;33%&quot;&gt;&lt;?php _e('&lt;abbr title=&quot;Coordinated Universal Time&quot;&gt;UTC&lt;/abbr&gt; time is:') ?&gt; &lt;/th&gt; 
+        &lt;td&gt;&lt;code&gt;&lt;?php echo gmdate('Y-m-d g:i:s a'); ?&gt;&lt;/code&gt;&lt;/td&gt; 
+      &lt;/tr&gt;
+      &lt;tr&gt;
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Times in the weblog should differ by:') ?&gt; &lt;/th&gt;
+        &lt;td&gt;&lt;input name=&quot;gmt_offset&quot; type=&quot;text&quot; id=&quot;gmt_offset&quot; size=&quot;2&quot; value=&quot;&lt;?php form_option('gmt_offset'); ?&gt;&quot; /&gt; 
+        &lt;?php _e('hours') ?&gt; &lt;/td&gt;
+      &lt;/tr&gt;
+      &lt;tr&gt;
+      	&lt;th scope=&quot;row&quot;&gt;&nbsp;&lt;/th&gt;
+      	&lt;td&gt;&lt;?php _e('The following use the same syntax as the &lt;a href=&quot;<A HREF="http://php.net/date">http://php.net/date</A>&quot;&gt;PHP &lt;code&gt;date()&lt;/code&gt; function&lt;/a&gt;. Save option to update sample output.') ?&gt; &lt;/td&gt;
+      	&lt;/tr&gt;
+      &lt;tr&gt;
+      	&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Default date format:') ?&gt;&lt;/th&gt;
+      	&lt;td&gt;&lt;input name=&quot;date_format&quot; type=&quot;text&quot; id=&quot;date_format&quot; size=&quot;30&quot; value=&quot;&lt;?php form_option('date_format'); ?&gt;&quot; /&gt;&lt;br /&gt;
+&lt;?php _e('Output:') ?&gt; &lt;strong&gt;&lt;?php echo mysql2date(get_settings('date_format'), current_time('mysql')); ?&gt;&lt;/strong&gt;&lt;/td&gt;
+      	&lt;/tr&gt;
+      &lt;tr&gt;
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Default time format:') ?&gt;&lt;/th&gt;
+      	&lt;td&gt;&lt;input name=&quot;time_format&quot; type=&quot;text&quot; id=&quot;time_format&quot; size=&quot;30&quot; value=&quot;&lt;?php form_option('time_format'); ?&gt;&quot; /&gt;&lt;br /&gt;
+&lt;?php _e('Output:') ?&gt; &lt;strong&gt;&lt;?php echo gmdate(get_settings('time_format'), current_time('timestamp')); ?&gt;&lt;/strong&gt;&lt;/td&gt;
+      	&lt;/tr&gt; 
+      &lt;tr&gt;
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Weeks in the calendar should start on:') ?&gt;&lt;/th&gt;
+        &lt;td&gt;&lt;select name=&quot;start_of_week&quot; id=&quot;start_of_week&quot;&gt;
+	&lt;?php
+for ($day_index = 0; $day_index &lt;= 6; $day_index++) :
+	if ($day_index == get_settings('start_of_week')) $selected = &quot; selected='selected'&quot;;
+	else $selected = '';
+echo &quot;\n\t&lt;option value='$day_index' $selected&gt;$weekday[$day_index]&lt;/option&gt;&quot;;
+endfor;
+?&gt;
+&lt;/select&gt;&lt;/td&gt;
+       		&lt;/tr&gt;
+
+&lt;/table&gt;
+
+    &lt;/fieldset&gt; 
+    &lt;p class=&quot;submit&quot;&gt;
+      &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Update Options') ?&gt; &raquo;&quot; /&gt;
+    &lt;/p&gt;
+  &lt;/form&gt; 
+&lt;/div&gt; 
+&lt;?php include(&quot;admin-footer.php&quot;) ?&gt;

Added: trunk/wp-admin/options-head.php
===================================================================
--- trunk/wp-admin/options-head.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-head.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,24 @@
+&lt;?php
+
+$wpvarstoreset = array('action','standalone', 'option_group_id');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+?&gt;
+
+&lt;br clear=&quot;all&quot; /&gt;
+
+&lt;?php if (isset($_GET['updated'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;strong&gt;&lt;?php _e('Options saved.') ?&gt;&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options-permalink.php
===================================================================
--- trunk/wp-admin/options-permalink.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-permalink.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,116 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Permalink Options');
+$parent_file = 'options-general.php';
+
+include('admin-header.php');
+
+$home_path = get_home_path();
+
+if ( isset($_POST) ) {
+	if ( isset($_POST['permalink_structure']) ) {
+		$permalink_structure = $_POST['permalink_structure'];
+		if (! empty($permalink_structure) )
+			$permalink_structure = preg_replace('#/+#', '/', '/' . $_POST['permalink_structure']);
+		$wp_rewrite-&gt;set_permalink_structure($permalink_structure);
+	}
+	
+	if ( isset($_POST['category_base']) ) {
+		$category_base = $_POST['category_base'];
+		if (! empty($category_base) )
+			$category_base = preg_replace('#/+#', '/', '/' . $_POST['category_base']);
+		$wp_rewrite-&gt;set_category_base($category_base);
+	}
+}
+	
+$permalink_structure = get_settings('permalink_structure');
+$category_base = get_settings('category_base');
+
+generate_page_rewrite_rules();
+
+if ( (!file_exists($home_path.'.htaccess') &amp;&amp; is_writable($home_path)) || is_writable($home_path.'.htaccess') )
+	$writable = true;
+else
+	$writable = false;
+
+if ($wp_rewrite-&gt;using_index_permalinks())
+	$usingpi = true;
+else
+	$usingpi = false;
+
+save_mod_rewrite_rules();
+?&gt;
+
+&lt;?php if (isset($_POST['submit'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php
+if ($writable)
+	_e('Permalink structure updated.');
+else
+	_e('You should update your .htaccess now.'); 
+?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt; 
+  &lt;h2&gt;&lt;?php _e('Edit Permalink Structure') ?&gt;&lt;/h2&gt; 
+  &lt;p&gt;&lt;?php _e('By default WordPress uses web URIs which have question marks and lots of numbers in them, however WordPress offers you the ability to create a custom URI structure for your permalinks and archives. This can improve the aesthetics, usability, and longevity of your links. A &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Using_Permalinks">http://codex.wordpress.org/Using_Permalinks</A>&quot;&gt;number of tags are available&lt;/a&gt;, and here are some examples to get you started.'); ?&gt;&lt;/p&gt;
+
+&lt;?php if ($is_apache) : ?&gt;
+&lt;dl&gt;
+&lt;dt&gt;&lt;?php _e('Structure'); ?&gt;: &lt;code&gt;/%year%/%monthnum%/%day%/%postname%/&lt;/code&gt;&lt;/dt&gt;
+	&lt;strong&gt;
+	&lt;dd&gt;&lt;?php _e('Result'); ?&gt;: &lt;code&gt;&lt;?php echo get_settings('home') . '/' . date('Y') . '/' . date('m') . '/' . date('d') . '/sample-post/'; ?&gt;&lt;/code&gt;&lt;/dd&gt;
+	&lt;/strong&gt;
+	&lt;dt&gt;&lt;?php _e('Structure'); ?&gt;: &lt;code&gt;/archives/%post_id%&lt;/code&gt;&lt;/dt&gt;
+	&lt;strong&gt;
+	&lt;dd&gt;&lt;?php _e('Result'); ?&gt;: &lt;code&gt;&lt;?php echo get_settings('home'); ?&gt;/archives/123&lt;/code&gt;&lt;/dd&gt;
+	&lt;/strong&gt;
+	&lt;dt&gt;&lt;/dt&gt;
+&lt;/dl&gt;
+
+&lt;p&gt;&lt;?php _e('For the above to work you must have something called &lt;code&gt;mod_rewrite&lt;/code&gt; installed on your server. (Ask your host.) If that isn&#8217;t available, you can prefix the structure with &lt;code&gt;/index.php/&lt;/code&gt; . This is the recommend method if you are on any web server but Apache.'); ?&gt;&lt;/p&gt;
+
+&lt;?php else : ?&gt;
+&lt;dl&gt;
+&lt;dt&gt;&lt;?php _e('Structure'); ?&gt;: &lt;code&gt;/index.php/%year%/%monthnum%/%day%/%postname%/&lt;/code&gt;&lt;/dt&gt;
+	&lt;strong&gt;
+	&lt;dd&gt;&lt;?php _e('Result'); ?&gt;: &lt;code&gt;&lt;?php echo get_settings('home') . '/index.php/' . date('Y') . '/' . date('m') . '/' . date('d') . '/sample-post/'; ?&gt;&lt;/code&gt;&lt;/dd&gt;
+	&lt;/strong&gt;
+	&lt;dt&gt;&lt;?php _e('Structure'); ?&gt;: &lt;code&gt;/index.php/archives/%post_id%&lt;/code&gt;&lt;/dt&gt;
+	&lt;strong&gt;
+	&lt;dd&gt;&lt;?php _e('Result'); ?&gt;: &lt;code&gt;&lt;?php echo get_settings('home'); ?&gt;/index.php/archives/123&lt;/code&gt;&lt;/dd&gt;
+	&lt;/strong&gt;
+	&lt;dt&gt;&lt;/dt&gt;
+&lt;/dl&gt;
+&lt;?php endif; ?&gt;
+
+  &lt;form name=&quot;form&quot; action=&quot;options-permalink.php&quot; method=&quot;post&quot;&gt; 
+    &lt;p&gt;&lt;?php _e('Use the template tags above to create a virtual site structure:') ?&gt;&lt;/p&gt;
+    &lt;p&gt; 
+      &lt;?php _e('Structure'); ?&gt;: &lt;input name=&quot;permalink_structure&quot; type=&quot;text&quot; class=&quot;code&quot; style=&quot;width: 60%;&quot; value=&quot;&lt;?php echo $permalink_structure; ?&gt;&quot; size=&quot;50&quot; /&gt; 
+    &lt;/p&gt; 
+&lt;?php if ($is_apache) : ?&gt;
+	&lt;p&gt;&lt;?php _e('If you like, you may enter a custom prefix for your category URIs here. For example, &lt;code&gt;/taxonomy/categorias&lt;/code&gt; would make your category links like &lt;code&gt;<A HREF="http://example.org/taxonomy/categorias/uncategorized/&lt;/code">http://example.org/taxonomy/categorias/uncategorized/&lt;/code</A>&gt;. If you leave this blank the default will be used.') ?&gt;&lt;/p&gt;
+&lt;?php else : ?&gt;
+	&lt;p&gt;&lt;?php _e('If you like, you may enter a custom prefix for your category URIs here. For example, &lt;code&gt;/index.php/taxonomy/categorias&lt;/code&gt; would make your category links like &lt;code&gt;<A HREF="http://example.org/index.php/taxonomy/categorias/uncategorized/&lt;/code">http://example.org/index.php/taxonomy/categorias/uncategorized/&lt;/code</A>&gt;. If you leave this blank the default will be used.') ?&gt;&lt;/p&gt;
+&lt;?php endif; ?&gt;
+	&lt;p&gt; 
+  &lt;?php _e('Category base'); ?&gt;: &lt;input name=&quot;category_base&quot; type=&quot;text&quot; class=&quot;code&quot;  value=&quot;&lt;?php echo $category_base; ?&gt;&quot; size=&quot;30&quot; /&gt; 
+     &lt;/p&gt; 
+    &lt;p class=&quot;submit&quot;&gt; 
+      &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Update Permalink Structure &raquo;') ?&gt;&quot; /&gt; 
+    &lt;/p&gt; 
+  &lt;/form&gt; 
+&lt;?php if ( $permalink_structure &amp;&amp; !$usingpi &amp;&amp; !$writable ) : ?&gt;
+  &lt;p&gt;&lt;?php _e('If your &lt;code&gt;.htaccess&lt;/code&gt; was &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Make_a_Directory_Writable">http://codex.wordpress.org/Make_a_Directory_Writable</A>&quot;&gt;writable&lt;/a&gt; we could do this automatically, but it isn&#8217;t so these are the mod_rewrite rules you should have in your &lt;code&gt;.htaccess&lt;/code&gt; file. Click in the field and press &lt;kbd&gt;CTRL + a&lt;/kbd&gt; to select all.') ?&gt;&lt;/p&gt;
+&lt;form action=&quot;options-permalink.php&quot; method=&quot;post&quot;&gt;
+   &lt;p&gt;
+&lt;textarea rows=&quot;5&quot; style=&quot;width: 98%;&quot; name=&quot;rules&quot;&gt;&lt;?php echo $wp_rewrite-&gt;mod_rewrite_rules(); ?&gt;
+&lt;/textarea&gt;
+    &lt;/p&gt;
+&lt;/form&gt;
+&lt;?php endif; ?&gt;
+
+&lt;/div&gt;
+
+&lt;?php require('./admin-footer.php'); ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options-reading.php
===================================================================
--- trunk/wp-admin/options-reading.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-reading.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,63 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Reading Options');
+$parent_file = 'options-general.php';
+
+include('admin-header.php');
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt; 
+&lt;h2&gt;&lt;?php _e('Reading Options') ?&gt;&lt;/h2&gt; 
+&lt;form name=&quot;form1&quot; method=&quot;post&quot; action=&quot;options.php&quot;&gt; 
+	&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt; 
+	&lt;input type=&quot;hidden&quot; name=&quot;page_options&quot; value=&quot;'posts_per_page','what_to_show','posts_per_rss','rss_use_excerpt','blog_charset','gzipcompression' &quot; /&gt; 
+	&lt;fieldset class=&quot;options&quot;&gt; 
+	&lt;legend&gt;&lt;?php _e('Blog Pages') ?&gt;&lt;/legend&gt; 
+	&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt; 
+		&lt;tr valign=&quot;top&quot;&gt; 
+		&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Show at most:') ?&gt;&lt;/th&gt; 
+		&lt;td&gt;
+		&lt;input name=&quot;posts_per_page&quot; type=&quot;text&quot; id=&quot;posts_per_page&quot; value=&quot;&lt;?php form_option('posts_per_page'); ?&gt;&quot; size=&quot;3&quot; /&gt; 
+		&lt;select name=&quot;what_to_show&quot; id=&quot;what_to_show&quot; &gt; 
+			&lt;option value=&quot;days&quot; &lt;?php selected('days', get_settings('what_to_show')); ?&gt;&gt;&lt;?php _e('days') ?&gt;&lt;/option&gt; 
+			&lt;option value=&quot;posts&quot; &lt;?php selected('posts', get_settings('what_to_show')); ?&gt;&gt;&lt;?php _e('posts') ?&gt;&lt;/option&gt; 
+		&lt;/select&gt;
+		&lt;/td&gt; 
+		&lt;/tr&gt; 
+	&lt;/table&gt; 
+	&lt;/fieldset&gt; 
+
+	&lt;fieldset class=&quot;options&quot;&gt; 
+	&lt;legend&gt;&lt;?php _e('Syndication Feeds') ?&gt;&lt;/legend&gt; 
+	&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt; 
+		&lt;tr valign=&quot;top&quot;&gt; 
+		&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Show the most recent:') ?&gt;&lt;/th&gt; 
+		&lt;td&gt;&lt;input name=&quot;posts_per_rss&quot; type=&quot;text&quot; id=&quot;posts_per_rss&quot; value=&quot;&lt;?php form_option('posts_per_rss'); ?&gt;&quot; size=&quot;3&quot; /&gt; &lt;?php _e('posts') ?&gt;&lt;/td&gt; 
+		&lt;/tr&gt;
+		&lt;tr valign=&quot;top&quot;&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('For each article, show:') ?&gt; &lt;/th&gt;
+		&lt;td&gt;
+		&lt;label&gt;&lt;input name=&quot;rss_use_excerpt&quot;  type=&quot;radio&quot; value=&quot;0&quot; &lt;?php checked(0, get_settings('rss_use_excerpt')); ?&gt;  /&gt; &lt;?php _e('Full text') ?&gt;&lt;/label&gt;&lt;br /&gt;
+		&lt;label&gt;&lt;input name=&quot;rss_use_excerpt&quot; type=&quot;radio&quot; value=&quot;1&quot; &lt;?php checked(1, get_settings('rss_use_excerpt')); ?&gt; /&gt; &lt;?php _e('Summary') ?&gt;&lt;/label&gt;
+		&lt;/td&gt;
+		&lt;/tr&gt; 
+	&lt;/table&gt; 
+	&lt;/fieldset&gt; 
+	&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt; 
+		&lt;tr valign=&quot;top&quot;&gt; 
+		&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Encoding for pages and feeds:') ?&gt;&lt;/th&gt; 
+		&lt;td&gt;&lt;input name=&quot;blog_charset&quot; type=&quot;text&quot; id=&quot;blog_charset&quot; value=&quot;&lt;?php form_option('blog_charset'); ?&gt;&quot; size=&quot;20&quot; class=&quot;code&quot; /&gt;&lt;br /&gt;
+		&lt;?php _e('The character encoding you write your blog in (UTF-8 is &lt;a href=&quot;<A HREF="http://developer.apple.com/documentation/macos8/TextIntlSvcs/TextEncodingConversionManager/TEC1.5/TEC.b0.html">http://developer.apple.com/documentation/macos8/TextIntlSvcs/TextEncodingConversionManager/TEC1.5/TEC.b0.html</A>&quot;&gt;recommended&lt;/a&gt;)') ?&gt;&lt;/td&gt; 
+		&lt;/tr&gt;
+	&lt;/table&gt; 
+	&lt;p&gt;
+		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;gzipcompression&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('gzipcompression')); ?&gt; /&gt; 
+		 &lt;?php _e('WordPress should compress articles (gzip) if browsers ask for them') ?&gt;&lt;/label&gt;
+	&lt;/p&gt;
+	&lt;p class=&quot;submit&quot;&gt; 
+		&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Update Options') ?&gt; &raquo;&quot; /&gt; 
+	&lt;/p&gt; 
+&lt;/form&gt; 
+&lt;/div&gt; 
+&lt;?php include('./admin-footer.php'); ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options-writing.php
===================================================================
--- trunk/wp-admin/options-writing.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options-writing.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,69 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Writing Options');
+$parent_file = 'options-general.php';
+
+include('admin-header.php');
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+  &lt;h2&gt;&lt;?php _e('Writing Options') ?&gt;&lt;/h2&gt;
+  &lt;form name=&quot;form1&quot; method=&quot;post&quot; action=&quot;options.php&quot;&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;page_options&quot; value=&quot;'default_post_edit_rows','use_smilies','use_balanceTags','advanced_edit','ping_sites','mailserver_url', 'mailserver_port','mailserver_login','mailserver_pass','default_category','default_email_category','new_users_can_blog'&quot; /&gt;
+    &lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot; class=&quot;editform&quot;&gt;
+      &lt;tr valign=&quot;top&quot;&gt;
+        &lt;th scope=&quot;row&quot;&gt; &lt;?php _e('When starting a post, show:') ?&gt; &lt;/th&gt;
+        &lt;td&gt;&lt;?php get_settings('advanced_edit') ?&gt;&lt;label&gt;
+          &lt;input name=&quot;advanced_edit&quot; type=&quot;radio&quot; value=&quot;0&quot; &lt;?php checked('0', get_settings('advanced_edit')); ?&gt; /&gt;
+&lt;?php _e('Simple controls') ?&gt;&lt;/label&gt;
+          &lt;br /&gt;
+          &lt;label for=&quot;advanced_edit&quot;&gt;
+          &lt;input name=&quot;advanced_edit&quot; id=&quot;advanced_edit&quot; type=&quot;radio&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('advanced_edit')); ?&gt; /&gt;
+&lt;?php _e('Advanced controls') ?&gt;&lt;/label&gt;
+		&lt;/td&gt;
+      &lt;/tr&gt;
+      &lt;tr valign=&quot;top&quot;&gt;
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Formatting:') ?&gt;&lt;/th&gt;
+        &lt;td&gt;          &lt;label for=&quot;label&quot;&gt;
+          &lt;input name=&quot;use_smilies&quot; type=&quot;checkbox&quot; id=&quot;label&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('use_smilies')); ?&gt; /&gt;
+          &lt;?php _e('Convert emoticons like &lt;code&gt;:-)&lt;/code&gt; and &lt;code&gt;:-P&lt;/code&gt; to graphics on display') ?&gt;&lt;/label&gt; &lt;br /&gt;          &lt;label for=&quot;label2&quot;&gt;
+  &lt;input name=&quot;use_balanceTags&quot; type=&quot;checkbox&quot; id=&quot;label2&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('use_balanceTags')); ?&gt; /&gt;
+          &lt;?php _e('WordPress should correct invalidly nested XHTML automatically') ?&gt;&lt;/label&gt;&lt;/td&gt;
+      &lt;/tr&gt;
+        	&lt;tr valign=&quot;top&quot;&gt;
+                &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Default post category:') ?&gt;&lt;/th&gt;
+        		&lt;td&gt;&lt;select name=&quot;default_category&quot; id=&quot;default_category&quot;&gt;
+&lt;?php
+$categories = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;categories ORDER BY cat_name&quot;);
+foreach ($categories as $category) :
+if ($category-&gt;cat_ID == get_settings('default_category')) $selected = &quot; selected='selected'&quot;;
+else $selected = '';
+	echo &quot;\n\t&lt;option value='$category-&gt;cat_ID' $selected&gt;$category-&gt;cat_name&lt;/option&gt;&quot;;
+endforeach;
+?&gt;
+       			&lt;/select&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+        &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Newly registered members:') ?&gt;&lt;/th&gt;
+        &lt;td&gt; &lt;label for=&quot;new_users_can_blog0&quot;&gt;&lt;input name=&quot;new_users_can_blog&quot; id=&quot;new_users_can_blog0&quot; type=&quot;radio&quot; value=&quot;0&quot; &lt;?php checked('0', get_settings('new_users_can_blog')); ?&gt; /&gt; &lt;?php _e('Cannot write articles') ?&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;label for=&quot;new_users_can_blog1&quot;&gt;&lt;input name=&quot;new_users_can_blog&quot; id=&quot;new_users_can_blog1&quot; type=&quot;radio&quot; value=&quot;1&quot; &lt;?php checked('1', get_settings('new_users_can_blog')); ?&gt; /&gt; &lt;?php _e('May submit drafts for review') ?&gt;&lt;/label&gt;&lt;br /&gt;
+&lt;label for=&quot;new_users_can_blog2&quot;&gt;&lt;input name=&quot;new_users_can_blog&quot; id=&quot;new_users_can_blog2&quot; type=&quot;radio&quot; value=&quot;2&quot; &lt;?php checked('2', get_settings('new_users_can_blog')); ?&gt; /&gt; &lt;?php _e('May publish articles') ?&gt;&lt;/label&gt;&lt;br /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;fieldset class=&quot;options&quot;&gt;
+	&lt;legend&gt;&lt;?php _e('Update Services') ?&gt;&lt;/legend&gt;
+          &lt;p&gt;&lt;?php _e('When you publish a new post, WordPress automatically notifies the following site update services. For more about this, see &lt;a href=&quot;<A HREF="http://codex.wordpress.org/Update_Services">http://codex.wordpress.org/Update_Services</A>&quot;&gt;Update Services&lt;/a&gt; on the Codex. Separate multiple service URIs with line breaks.') ?&gt;&lt;/p&gt;
+
+	&lt;textarea name=&quot;ping_sites&quot; id=&quot;ping_sites&quot; style=&quot;width: 98%;&quot; rows=&quot;3&quot; cols=&quot;50&quot;&gt;&lt;?php form_option('ping_sites'); ?&gt;&lt;/textarea&gt;
+&lt;/fieldset&gt;
+
+&lt;p class=&quot;submit&quot;&gt;
+	&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;&lt;?php _e('Update Options') ?&gt; &raquo;&quot; /&gt;
+&lt;/p&gt;
+&lt;/form&gt;
+&lt;/div&gt;
+
+&lt;?php include('./admin-footer.php') ?&gt;
\ No newline at end of file

Added: trunk/wp-admin/options.php
===================================================================
--- trunk/wp-admin/options.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/options.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,122 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Options');
+$this_file = 'options.php';
+$parent_file = 'options-general.php';
+
+$wpvarstoreset = array('action');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+if ($user_level &lt; 6)
+	die ( __('Cheatin&#8217; uh?') );
+
+switch($action) {
+
+case 'update':
+	$any_changed = 0;
+    
+	if (!$_POST['page_options']) {
+		foreach ($_POST as $key =&gt; $value) {
+			$option_names[] = &quot;'$key'&quot;;
+		}
+		$option_names = implode(',', $option_names);
+	} else {
+		$option_names = stripslashes($_POST['page_options']);
+	}
+
+    $options = $wpdb-&gt;get_results(&quot;SELECT $wpdb-&gt;options.option_id, option_name, option_type, option_value, option_admin_level FROM $wpdb-&gt;options WHERE option_name IN ($option_names)&quot;);
+
+	// Save for later.
+	$old_siteurl = get_settings('siteurl');
+	$old_home = get_settings('home');
+
+// HACK
+// Options that if not there have 0 value but need to be something like &quot;closed&quot;
+    $nonbools = array('default_ping_status', 'default_comment_status');
+    if ($options) {
+        foreach ($options as $option) {
+            // should we even bother checking?
+            if ($user_level &gt;= $option-&gt;option_admin_level) {
+                $old_val = $option-&gt;option_value;
+                $new_val = trim($_POST[$option-&gt;option_name]);
+                if( in_array($option-&gt;option_name, $nonbools) &amp;&amp; ( $new_val == '0' || $new_val == '') )
+					$new_val = 'closed';
+                if ($new_val !== $old_val) {
+                    $result = $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = '$new_val' WHERE option_name = '$option-&gt;option_name'&quot;);
+					$any_changed++;
+				}
+            }
+        }
+        unset($cache_settings); // so they will be re-read
+        get_settings('siteurl'); // make it happen now
+    } // end if options
+    
+    if ($any_changed) {
+			// If siteurl or home changed, reset cookies.
+			if ( get_settings('siteurl') != $old_siteurl || get_settings('home') != $old_home ) {
+				// If home changed, write rewrite rules to new location.
+				save_mod_rewrite_rules();
+				// Get currently logged in user and password.
+				get_currentuserinfo();
+				// Clear cookies for old paths.
+				wp_clearcookie();
+				// Set cookies for new paths.
+				wp_setcookie($user_login, $user_pass_md5, true, get_settings('home'), get_settings('siteurl'));
+			}
+
+			//$message = sprintf(__('%d setting(s) saved... '), $any_changed);
+    }
+    
+		$referred = remove_query_arg('updated' , $_SERVER['HTTP_REFERER']);
+		$goback = add_query_arg('updated', 'true', $_SERVER['HTTP_REFERER']);
+		$goback = preg_replace('|[^a-z0-9-~+_.?#=&amp;;,/:]|i', '', $goback);
+		wp_redirect($goback);
+    break;
+
+default:
+	include('admin-header.php'); ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+  &lt;h2&gt;&lt;?php _e('All options'); ?&gt;&lt;/h2&gt;
+  &lt;form name=&quot;form&quot; action=&quot;options.php&quot; method=&quot;post&quot;&gt;
+  &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt;
+  &lt;table width=&quot;98%&quot;&gt;
+&lt;?php
+$options = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;options ORDER BY option_name&quot;);
+
+foreach ($options as $option) :
+	$value = wp_specialchars($option-&gt;option_value);
+	echo &quot;
+&lt;tr&gt;
+	&lt;th scope='row'&gt;&lt;label for='$option-&gt;option_name'&gt;$option-&gt;option_name&lt;/label&gt;&lt;/th&gt;
+	&lt;td&gt;&lt;input type='text' name='$option-&gt;option_name' id='$option-&gt;option_name' size='30' value='&quot; . $value . &quot;' /&gt;&lt;/td&gt;
+	&lt;td&gt;$option-&gt;option_description&lt;/td&gt;
+&lt;/tr&gt;&quot;;
+endforeach;
+?&gt;
+  &lt;/table&gt;
+&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;Update&quot; value=&quot;&lt;?php _e('Update Settings &raquo;') ?&gt;&quot; /&gt;&lt;/p&gt;
+  &lt;/form&gt;
+&lt;/div&gt;
+
+
+&lt;?php
+break;
+} // end switch
+
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/page-new.php
===================================================================
--- trunk/wp-admin/page-new.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/page-new.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,30 @@
+&lt;?php
+require_once('admin.php');
+$title = __('New Page');
+$parent_file = 'post.php';
+require_once('admin-header.php');
+
+get_currentuserinfo();
+?&gt;
+
+&lt;?php if ( isset($_GET['saved']) ) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;strong&gt;&lt;?php _e('Page saved.') ?&gt; &lt;a href=&quot;edit-pages.php&quot;&gt;&lt;?php _e('Manage pages'); ?&gt; &raquo;&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;?php
+if ($user_level &gt; 0) {
+	$action = 'post';
+	get_currentuserinfo();
+	//set defaults
+	$post_status = 'static';
+	$comment_status = get_settings('default_comment_status');
+	$ping_status = get_settings('default_ping_status');
+	$post_pingback = get_settings('default_pingback_flag');
+	$post_parent = 0;
+	$page_template = 'default';
+
+	include('edit-page-form.php');
+}
+?&gt;
+
+&lt;?php include('admin-footer.php'); ?&gt; 
\ No newline at end of file

Added: trunk/wp-admin/plugins.php
===================================================================
--- trunk/wp-admin/plugins.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/plugins.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,119 @@
+&lt;?php
+require_once('admin.php');
+
+if ( isset($_GET['action']) ) {
+	check_admin_referer();
+
+	if ('activate' == $_GET['action']) {
+		$current = get_settings('active_plugins');
+		if (!in_array($_GET['plugin'], $current)) {
+			$current[] = trim( $_GET['plugin'] );
+		}
+		sort($current);
+		update_option('active_plugins', $current);
+		header('Location: plugins.php?activate=true');
+	}
+	
+	if ('deactivate' == $_GET['action']) {
+		$current = get_settings('active_plugins');
+		array_splice($current, array_search( $_GET['plugin'], $current), 1 ); // Array-fu!
+		update_option('active_plugins', $current);
+		header('Location: plugins.php?deactivate=true');
+	}
+}
+
+$title = __('Manage Plugins');
+require_once('admin-header.php');
+
+// Clean up options
+// If any plugins don't exist, axe 'em
+
+$check_plugins = get_settings('active_plugins');
+
+// Sanity check.  If the active plugin list is not an array, make it an
+// empty array.
+if ( !is_array($check_plugins) ) {
+	$check_plugins = array();
+	update_option('active_plugins', $check_plugins);	
+}
+
+// If a plugin file does not exist, remove it from the list of active
+// plugins.
+foreach ($check_plugins as $check_plugin) {
+	if (!file_exists(ABSPATH . 'wp-content/plugins/' . $check_plugin)) {
+			$current = get_settings('active_plugins');
+			unset($current[$_GET['plugin']]);
+			update_option('active_plugins', $current);
+	}
+}
+?&gt;
+
+&lt;?php if (isset($_GET['activate'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('Plugin &lt;strong&gt;activated&lt;/strong&gt;.') ?&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;?php endif; ?&gt;
+&lt;?php if (isset($_GET['deactivate'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('Plugin &lt;strong&gt;deactivated&lt;/strong&gt;.') ?&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Plugin Management'); ?&gt;&lt;/h2&gt;
+&lt;p&gt;&lt;?php _e('Plugins are files you usually download separately from WordPress that add functionality. To install a plugin you generally just need to put the plugin file into your &lt;code&gt;wp-content/plugins&lt;/code&gt; directory. Once a plugin is installed, you may activate it or deactivate it here. If something goes wrong with a plugin and you can&#8217;t use WordPress, delete that plugin from the &lt;code&gt;wp-content/plugins&lt;/code&gt; directory and it will be automatically deactivated.'); ?&gt;&lt;/p&gt;
+&lt;?php
+
+if ( get_settings('active_plugins') )
+	$current_plugins = get_settings('active_plugins');
+
+$plugins = get_plugins();
+
+if (empty($plugins)) {
+	_e(&quot;&lt;p&gt;Couldn't open plugins directory or there are no plugins available.&lt;/p&gt;&quot;); // TODO: make more helpful
+} else {
+?&gt;
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th&gt;&lt;?php _e('Plugin'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Version'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Author'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Description'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Action'); ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+	$style = '';
+	foreach($plugins as $plugin_file =&gt; $plugin_data) {
+		$style = ('class=&quot;alternate&quot;' == $style|| 'class=&quot;alternate active&quot;' == $style) ? '' : 'alternate';
+
+		if (!empty($current_plugins) &amp;&amp; in_array($plugin_file, $current_plugins)) {
+			$action = &quot;&lt;a href='plugins.php?action=deactivate&amp;plugin=$plugin_file' title='&quot;.__('Deactivate this plugin').&quot;' class='delete'&gt;&quot;.__('Deactivate').&quot;&lt;/a&gt;&quot;;
+			$plugin_data['Title'] = &quot;&lt;strong&gt;{$plugin_data['Title']}&lt;/strong&gt;&quot;;
+			$style .= $style == 'alternate' ? ' active' : 'active';
+		} else {
+			$action = &quot;&lt;a href='plugins.php?action=activate&amp;plugin=$plugin_file' title='&quot;.__('Activate this plugin').&quot;' class='edit'&gt;&quot;.__('Activate').&quot;&lt;/a&gt;&quot;;
+		}
+		$plugin_data['Description'] = wp_kses($plugin_data['Description'], array('a' =&gt; array('href' =&gt; array(),'title' =&gt; array()),'abbr' =&gt; array('title' =&gt; array()),'acronym' =&gt; array('title' =&gt; array()),'code' =&gt; array(),'em' =&gt; array(),'strong' =&gt; array()) ); ;
+		if ($style != '') $style = 'class=&quot;' . $style . '&quot;';
+		echo &quot;
+	&lt;tr $style&gt;
+		&lt;td class=\&quot;name\&quot;&gt;{$plugin_data['Title']}&lt;/td&gt;
+		&lt;td class=\&quot;vers\&quot;&gt;{$plugin_data['Version']}&lt;/td&gt;
+		&lt;td class=\&quot;auth\&quot;&gt;{$plugin_data['Author']}&lt;/td&gt;
+		&lt;td class=\&quot;desc\&quot;&gt;{$plugin_data['Description']}&lt;/td&gt;
+		&lt;td class=\&quot;togl\&quot;&gt;$action&lt;/td&gt;
+	&lt;/tr&gt;&quot;;
+	}
+?&gt;
+
+&lt;/table&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;h2&gt;&lt;?php _e('Get More Plugins'); ?&gt;&lt;/h2&gt;
+&lt;p&gt;&lt;?php _e('You can find additional plugins for your site in the &lt;a href=&quot;<A HREF="http://wordpress.org/extend/plugins/">http://wordpress.org/extend/plugins/</A>&quot;&gt;WordPress plugin directory&lt;/a&gt;. To install a plugin you generally just need to upload the plugin file into your &lt;code&gt;wp-content/plugins&lt;/code&gt; directory. Once a plugin is uploaded, you may activate it here.'); ?&gt;&lt;/p&gt;
+
+&lt;/div&gt;
+
+&lt;?php
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/post.php
===================================================================
--- trunk/wp-admin/post.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/post.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,759 @@
+&lt;?php
+require_once('admin.php');
+
+$wpvarstoreset = array('action', 'safe_mode', 'withcomments', 'posts', 'content', 'edited_post_title', 'comment_error', 'profile', 'trackback_url', 'excerpt', 'showcomments', 'commentstart', 'commentend', 'commentorder' );
+
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+			$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+if (isset($_POST['deletepost'])) {
+$action = &quot;delete&quot;;
+}
+
+	// Fix submenu highlighting for pages.
+if (false !== strpos($_SERVER['HTTP_REFERER'], 'edit-pages.php')) $submenu_file = 'page-new.php';
+
+$editing = true;
+
+switch($action) {
+case 'post':
+
+	if ( !user_can_create_draft($user_ID) )
+		die( __('You are not allowed to create posts or drafts on this blog.') );
+
+	$post_pingback = (int) $_POST['post_pingback'];
+	$content         = apply_filters('content_save_pre',  $_POST['content']);
+	$excerpt         = apply_filters('excerpt_save_pre',  $_POST['excerpt']);
+	$post_title      = apply_filters('title_save_pre',    $_POST['post_title']);
+	$post_categories = apply_filters('category_save_pre', $_POST['post_category']);
+	$post_status     = apply_filters('status_save_pre',   $_POST['post_status']);
+	$post_name       = apply_filters('name_save_pre',     $_POST['post_name']);
+	$post_parent = 0;
+	$menu_order  = 0;
+
+
+	if ( isset($_POST['parent_id']) )
+		$post_parent = (int) $_POST['parent_id'];
+
+	if ( isset($_POST['menu_order']) )
+		$menu_order = (int) $_POST['menu_order'];
+
+	if (! empty($_POST['post_author_override'])) {
+		$post_author = (int) $_POST['post_author_override'];
+	} else if (! empty($_POST['post_author'])) {
+		$post_author = (int) $_POST['post_author'];
+	} else {
+		$post_author = (int) $_POST['user_ID'];
+	}
+	if ( !user_can_edit_user($user_ID, $post_author) )
+		die( __('You cannot post as this user.') );
+
+	if ( empty($post_status) )
+		$post_status = 'draft';
+	// Double-check
+	if ( 'publish' == $post_status &amp;&amp; (!user_can_create_post($user_ID)) )
+		$post_status = 'draft';
+
+	$comment_status = $_POST['comment_status'];
+	if ( empty($comment_status) ) {
+		if ( !isset($_POST['advanced_view']) )
+			$comment_status = get_option('default_comment_status');
+		else
+			$comment_status = 'closed';
+		}
+
+	$ping_status = $_POST['ping_status'];
+	if ( empty($ping_status) ) {
+		if ( !isset($_POST['advanced_view']) )
+			$ping_status = get_option('default_ping_status');
+		else
+			$ping_status = 'closed';
+		}
+
+	$post_password = $_POST['post_password'];
+
+	$trackback = $_POST['trackback_url'];
+	$trackback = preg_replace('|\s+|', &quot;\n&quot;, $trackback);
+
+	if (user_can_set_post_date($user_ID) &amp;&amp; (!empty($_POST['edit_date']))) {
+		$aa = $_POST['aa'];
+		$mm = $_POST['mm'];
+		$jj = $_POST['jj'];
+		$hh = $_POST['hh'];
+		$mn = $_POST['mn'];
+		$ss = $_POST['ss'];
+		$jj = ($jj &gt; 31) ? 31 : $jj;
+		$hh = ($hh &gt; 23) ? $hh - 24 : $hh;
+		$mn = ($mn &gt; 59) ? $mn - 60 : $mn;
+		$ss = ($ss &gt; 59) ? $ss - 60 : $ss;
+		$now = &quot;$aa-$mm-$jj $hh:$mn:$ss&quot;;
+		$now_gmt = get_gmt_from_date(&quot;$aa-$mm-$jj $hh:$mn:$ss&quot;);
+	} else {
+		$now = current_time('mysql');
+		$now_gmt = current_time('mysql', 1);
+	}
+
+	// What to do based on which button they pressed
+	if ('' != $_POST['saveasdraft']) $post_status = 'draft';
+	if ('' != $_POST['saveasprivate']) $post_status = 'private';
+	if ('' != $_POST['publish']) $post_status = 'publish';
+	if ('' != $_POST['advanced']) $post_status = 'draft';
+	if ('' != $_POST['savepage']) $post_status = 'static';
+
+
+
+	$id_result = $wpdb-&gt;get_row(&quot;SHOW TABLE STATUS LIKE '$wpdb-&gt;posts'&quot;);
+	$post_ID = $id_result-&gt;Auto_increment;
+
+	if ( empty($post_name) ) {
+		if ( 'draft' != $post_status )
+			$post_name = sanitize_title($post_title, $post_ID);
+	} else {
+		$post_name = sanitize_title($post_name, $post_ID);
+	}
+
+	if ('publish' == $post_status) {
+		$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+		if ($post_name_check) {
+			$suffix = 2;
+			while ($post_name_check) {
+				$alt_post_name = $post_name . &quot;-$suffix&quot;;
+				$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$alt_post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+				$suffix++;
+			}
+			$post_name = $alt_post_name;
+		}
+	}
+
+	$postquery =&quot;INSERT INTO $wpdb-&gt;posts
+			(ID, post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt,  post_status, comment_status, ping_status, post_password, post_name, to_ping, post_modified, post_modified_gmt, post_parent, menu_order)
+			VALUES
+			('$post_ID', '$post_author', '$now', '$now_gmt', '$content', '$post_title', '$excerpt', '$post_status', '$comment_status', '$ping_status', '$post_password', '$post_name', '$trackback', '$now', '$now_gmt', '$post_parent', '$menu_order')
+			&quot;;
+
+	$result = $wpdb-&gt;query($postquery);
+
+	if (!empty($_POST['mode'])) {
+	switch($_POST['mode']) {
+		case 'sidebar':
+			$location = 'sidebar.php?a=b';
+			break;
+		default:
+			$location = 'post.php';
+			break;
+		}
+	} else {
+		$location = 'post.php?posted=true';
+	}
+
+	if ( 'static' == $_POST['post_status'] )
+		$location = &quot;page-new.php?saved=true&quot;;
+
+	if ( '' != $_POST['advanced'] || isset($_POST['save']) )
+		$location = &quot;post.php?action=edit&amp;post=$post_ID&quot;;
+
+	header(&quot;Location: $location&quot;); // Send user on their way while we keep working
+
+	// Insert categories
+	// Check to make sure there is a category, if not just set it to some default
+	if (!$post_categories) $post_categories[] = get_option('default_category');
+	foreach ($post_categories as $post_category) {
+		// Double check it's not there already
+		$exists = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post_ID AND category_id = $post_category&quot;);
+
+		 if (!$exists) {
+			$wpdb-&gt;query(&quot;
+			INSERT INTO $wpdb-&gt;post2cat
+			(post_id, category_id)
+			VALUES
+			($post_ID, $post_category)
+			&quot;);
+		}
+	}
+
+	add_meta($post_ID);
+
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET guid = '&quot; . get_permalink($post_ID) . &quot;' WHERE ID = '$post_ID'&quot;);
+
+	do_action('save_post', $post_ID);
+
+	if ('publish' == $post_status) {
+		do_action('publish_post', $post_ID);
+		if ($post_pingback)
+			register_shutdown_function('pingback', $content, $post_ID);
+		register_shutdown_function('do_enclose', $content, $post_ID );
+		register_shutdown_function('do_trackbacks', $post_ID);
+	}
+
+	if ($post_status == 'static') {
+		generate_page_rewrite_rules();
+		add_post_meta($post_ID, '_wp_page_template',  $_POST['page_template'], true);
+	}
+
+	require_once('admin-header.php');
+
+	exit();
+	break;
+
+case 'edit':
+	$title = __('Edit');
+
+	require_once('admin-header.php');
+
+	$post = $post_ID = $p = (int) $_GET['post'];
+
+	if ( !user_can_edit_post($user_ID, $post_ID) )
+		die ( __('You are not allowed to edit this post.') );
+
+	$postdata = &amp;get_post($post_ID);
+	$content = $postdata-&gt;post_content;
+	$content = format_to_edit($content);
+	$content = apply_filters('content_edit_pre', $content);
+	$excerpt = $postdata-&gt;post_excerpt;
+	$excerpt = format_to_edit($excerpt);
+	$excerpt = apply_filters('excerpt_edit_pre', $excerpt);
+	$edited_post_title = format_to_edit($postdata-&gt;post_title);
+	$edited_post_title = apply_filters('title_edit_pre', $edited_post_title);
+	$post_status = $postdata-&gt;post_status;
+	$comment_status = $postdata-&gt;comment_status;
+	$ping_status = $postdata-&gt;ping_status;
+	$post_password = $postdata-&gt;post_password;
+	$to_ping = $postdata-&gt;to_ping;
+	$pinged = $postdata-&gt;pinged;
+	$post_name = $postdata-&gt;post_name;
+	$post_parent = $postdata-&gt;post_parent;
+	$post_author = $postdata-&gt;post_author;
+	$menu_order = $postdata-&gt;menu_order;
+
+	if( 'private' == $postdata-&gt;post_status &amp;&amp; $postdata-&gt;post_author != $user_ID )
+		die ( __('You are not allowed to view other users\' private posts.') );
+
+	if ($post_status == 'static') {
+		$page_template = get_post_meta($post_ID, '_wp_page_template', true);
+		include('edit-page-form.php');
+	} else {
+		include('edit-form-advanced.php');
+	}
+
+	$post = &amp;$postdata;
+	?&gt;
+	&lt;div id='preview' class='wrap'&gt;
+	&lt;h2&gt;&lt;?php _e('Post Preview (updated when post is saved)'); ?&gt;&lt;/h2&gt;
+	&lt;h3 class=&quot;storytitle&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;&lt;?php printf(__(&quot;Permanent Link: %s&quot;), get_the_title()); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+	&lt;div class=&quot;meta&quot;&gt;&lt;?php _e(&quot;Filed under:&quot;); ?&gt; &lt;?php the_category(','); ?&gt; &#8212; &lt;?php the_author() ?&gt; @ &lt;?php the_time() ?&gt;&lt;/div&gt;
+
+	&lt;div class=&quot;storycontent&quot;&gt;
+	&lt;?php
+	$content = apply_filters('the_content', $post-&gt;post_content);
+	echo $content;
+	?&gt;
+	&lt;/div&gt;
+	&lt;/div&gt;
+	&lt;?php
+	break;
+
+case 'editpost':
+	// die(var_dump('&lt;pre&gt;', $_POST));
+	if (!isset($blog_ID)) {
+		$blog_ID = 1;
+	}
+	$post_ID = (int) $_POST['post_ID'];
+
+	if (!user_can_edit_post($user_ID, $post_ID, $blog_ID))
+		die( __('You are not allowed to edit this post.') );
+
+	$post_categories = $_POST['post_category'];
+	if (!$post_categories) $post_categories[] = 1;
+	$content = apply_filters('content_save_pre', $_POST['content']);
+	$excerpt = apply_filters('excerpt_save_pre', $_POST['excerpt']);
+	$post_title = $_POST['post_title'];
+	$prev_status = $_POST['prev_status'];
+	$post_status = $_POST['post_status'];
+	$menu_order = (int) $_POST['menu_order'];
+	if (! empty($_POST['post_author_override'])) {
+		$post_author = (int) $_POST['post_author_override'];
+	} else if (! empty($_POST['post_author'])) {
+		$post_author = (int) $_POST['post_author'];
+	} else {
+		$post_author = (int) $_POST['user_ID'];
+	}
+	if ( !user_can_edit_user($user_ID, $post_author) )
+		die( __('You cannot post as this user.') );
+
+	$comment_status = $_POST['comment_status'];
+	if (empty($comment_status)) $comment_status = 'closed';
+	//if (!$_POST['comment_status']) $comment_status = get_settings('default_comment_status');
+
+	$ping_status = $_POST['ping_status'];
+	if (empty($ping_status)) $ping_status = 'closed';
+	//if (!$_POST['ping_status']) $ping_status = get_settings('default_ping_status');
+	$post_password = $_POST['post_password'];
+	$post_name = $_POST['post_name'];
+
+	$post_parent = 0;
+	if (isset($_POST['parent_id'])) {
+		$post_parent = (int) $_POST['parent_id'];
+	}
+
+	$trackback = $_POST['trackback_url'];
+	// Format trackbacks
+	$trackback = preg_replace('|\s+|', '\n', $trackback);
+
+	if (isset($_POST['publish'])) $post_status = 'publish';
+	// Double-check
+	if ( 'publish' == $post_status &amp;&amp; (!user_can_create_post($user_ID)) )
+		$post_status = 'draft';
+
+	if ( empty($post_name) ) {
+		if ( 'draft' != $post_status )
+			$post_name = sanitize_title($post_title, $post_ID);
+	} else {
+		$post_name = sanitize_title($post_name, $post_ID);
+	}
+
+	if ('publish' == $post_status) {
+		$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+		if ($post_name_check) {
+			$suffix = 2;
+			while ($post_name_check) {
+				$alt_post_name = $post_name . &quot;-$suffix&quot;;
+				$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$alt_post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+				$suffix++;
+			}
+			$post_name = $alt_post_name;
+		}
+	}
+
+	if (user_can_edit_post_date($user_ID, $post_ID) &amp;&amp; (!empty($_POST['edit_date']))) {
+		$aa = $_POST['aa'];
+		$mm = $_POST['mm'];
+		$jj = $_POST['jj'];
+		$hh = $_POST['hh'];
+		$mn = $_POST['mn'];
+		$ss = $_POST['ss'];
+		$jj = ($jj &gt; 31) ? 31 : $jj;
+		$hh = ($hh &gt; 23) ? $hh - 24 : $hh;
+		$mn = ($mn &gt; 59) ? $mn - 60 : $mn;
+		$ss = ($ss &gt; 59) ? $ss - 60 : $ss;
+		$datemodif = &quot;, post_date = '$aa-$mm-$jj $hh:$mn:$ss'&quot;;
+	$datemodif_gmt = &quot;, post_date_gmt = '&quot;.get_gmt_from_date(&quot;$aa-$mm-$jj $hh:$mn:$ss&quot;).&quot;'&quot;;
+	} else {
+		$datemodif = '';
+		$datemodif_gmt = '';
+	}
+
+	$now = current_time('mysql');
+	$now_gmt = current_time('mysql', 1);
+
+	$result = $wpdb-&gt;query(&quot;
+		UPDATE $wpdb-&gt;posts SET
+			post_content = '$content',
+			post_excerpt = '$excerpt',
+			post_title = '$post_title'&quot;
+			.$datemodif_gmt
+			.$datemodif.&quot;,
+			post_status = '$post_status',
+			comment_status = '$comment_status',
+			ping_status = '$ping_status',
+			post_author = '$post_author',
+			post_password = '$post_password',
+			post_name = '$post_name',
+			to_ping = '$trackback',
+			post_modified = '$now',
+			post_modified_gmt = '$now_gmt',
+			menu_order = '$menu_order',
+			post_parent = '$post_parent'
+		WHERE ID = $post_ID &quot;);
+
+	if ($_POST['save']) {
+		$location = $_SERVER['HTTP_REFERER'];
+	} elseif ($_POST['updatemeta']) {
+		$location = $_SERVER['HTTP_REFERER'] . '&amp;message=2#postcustom';
+	} elseif ($_POST['deletemeta']) {
+		$location = $_SERVER['HTTP_REFERER'] . '&amp;message=3#postcustom';
+	} elseif (isset($_POST['referredby']) &amp;&amp; $_POST['referredby'] != $_SERVER['HTTP_REFERER']) {
+		$location = $_POST['referredby'];
+		if ( $_POST['referredby'] == 'redo' )
+			$location = get_permalink( $post_ID );
+	} else {
+		$location = 'post.php';
+	}
+	header ('Location: ' . $location); // Send user on their way while we keep working
+
+	// Meta Stuff
+	if ($_POST['meta']) :
+		foreach ($_POST['meta'] as $key =&gt; $value) :
+			update_meta($key, $value['key'], $value['value']);
+		endforeach;
+	endif;
+
+	if ($_POST['deletemeta']) :
+		foreach ($_POST['deletemeta'] as $key =&gt; $value) :
+			delete_meta($key);
+		endforeach;
+	endif;
+
+	add_meta($post_ID);
+
+	// Now it's category time!
+	// First the old categories
+	$old_categories = $wpdb-&gt;get_col(&quot;SELECT category_id FROM $wpdb-&gt;post2cat WHERE post_id = $post_ID&quot;);
+
+	// Delete any?
+	foreach ($old_categories as $old_cat) {
+		if (!in_array($old_cat, $post_categories)) // If a category was there before but isn't now
+			$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;post2cat WHERE category_id = $old_cat AND post_id = $post_ID LIMIT 1&quot;);
+	}
+
+	// Add any?
+	foreach ($post_categories as $new_cat) {
+		if (!in_array($new_cat, $old_categories))
+			$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;post2cat (post_id, category_id) VALUES ($post_ID, $new_cat)&quot;);
+	}
+
+	if ($prev_status != 'publish' &amp;&amp; $post_status == 'publish')
+		do_action('private_to_published', $post_ID);
+
+	do_action('edit_post', $post_ID);
+
+	if ($post_status == 'publish') {
+		do_action('publish_post', $post_ID);
+		register_shutdown_function('do_trackbacks', $post_ID);
+		register_shutdown_function('do_enclose', $content, $post_ID );
+		if ( get_option('default_pingback_flag') )
+			register_shutdown_function('pingback', $content, $post_ID);
+	}
+
+	if ($post_status == 'static') {
+		generate_page_rewrite_rules();
+
+		if ( ! update_post_meta($post_ID, '_wp_page_template',  $_POST['page_template'])) {
+			add_post_meta($post_ID, '_wp_page_template',  $_POST['page_template'], true);
+		}
+	}
+
+	exit();
+	break;
+
+case 'delete':
+	check_admin_referer();
+
+	$post_id = (isset($_GET['post']))  ? intval($_GET['post']) : intval($_POST['post_ID']);
+
+	if (!user_can_delete_post($user_ID, $post_id)) {
+		die( __('You are not allowed to delete this post.') );
+	}
+
+	if (! wp_delete_post($post_id))
+		die( __('Error in deleting...') );
+
+	$sendback = $_SERVER['HTTP_REFERER'];
+	if (strstr($sendback, 'post.php')) $sendback = get_settings('siteurl') .'/wp-admin/post.php';
+	$sendback = preg_replace('|[^a-z0-9-~+_.?#=&amp;;,/:]|i', '', $sendback);
+	header ('Location: ' . $sendback);
+	generate_page_rewrite_rules();
+	do_action('delete_post', $post_id);
+	break;
+
+case 'editcomment':
+	$title = __('Edit Comment');
+	$parent_file = 'edit.php';
+	require_once ('admin-header.php');
+
+	get_currentuserinfo();
+
+	$comment = (int) $_GET['comment'];
+	$commentdata = get_commentdata($comment, 1, true) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'javascript:history.go(-1)'));
+
+	if (!user_can_edit_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to edit comments on this post.') );
+	}
+
+	$content = $commentdata['comment_content'];
+	$content = format_to_edit($content);
+	$content = apply_filters('comment_edit_pre', $content);
+
+	$comment_status = $commentdata['comment_approved'];
+
+	include('edit-form-comment.php');
+
+	break;
+
+case 'confirmdeletecomment':
+
+	require_once('./admin-header.php');
+
+	$comment = (int) $_GET['comment'];
+	$p = (int) $_GET['p'];
+	$commentdata = get_commentdata($comment, 1, true) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'edit.php'));
+
+	if (!user_can_delete_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to delete comments on this post.') );
+	}
+
+	echo &quot;&lt;div class=\&quot;wrap\&quot;&gt;\n&quot;;
+	echo &quot;&lt;p&gt;&quot; . __('&lt;strong&gt;Caution:&lt;/strong&gt; You are about to delete the following comment:') . &quot;&lt;/p&gt;\n&quot;;
+	echo &quot;&lt;table border=\&quot;0\&quot;&gt;\n&quot;;
+	echo &quot;&lt;tr&gt;&lt;td&gt;&quot; . __('Author:') . &quot;&lt;/td&gt;&lt;td&gt;&quot; . $commentdata[&quot;comment_author&quot;] . &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+	echo &quot;&lt;tr&gt;&lt;td&gt;&quot; . __('E-mail:') . &quot;&lt;/td&gt;&lt;td&gt;&quot; . $commentdata[&quot;comment_author_email&quot;] . &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+	echo &quot;&lt;tr&gt;&lt;td&gt;&quot;. __('URL:') . &quot;&lt;/td&gt;&lt;td&gt;&quot; . $commentdata[&quot;comment_author_url&quot;] . &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+	echo &quot;&lt;tr&gt;&lt;td&gt;&quot;. __('Comment:') . &quot;&lt;/td&gt;&lt;td&gt;&quot; . stripslashes($commentdata[&quot;comment_content&quot;]) . &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+	echo &quot;&lt;/table&gt;\n&quot;;
+	echo &quot;&lt;p&gt;&quot; . __('Are you sure you want to do that?') . &quot;&lt;/p&gt;\n&quot;;
+
+	echo &quot;&lt;form action='&quot;.get_settings('siteurl').&quot;/wp-admin/post.php' method='get'&gt;\n&quot;;
+	echo &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;action\&quot; value=\&quot;deletecomment\&quot; /&gt;\n&quot;;
+	echo &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;p\&quot; value=\&quot;$p\&quot; /&gt;\n&quot;;
+	echo &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;comment\&quot; value=\&quot;$comment\&quot; /&gt;\n&quot;;
+	echo &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;noredir\&quot; value=\&quot;1\&quot; /&gt;\n&quot;;
+	echo &quot;&lt;input type=\&quot;submit\&quot; value=\&quot;&quot; . __('Yes') . &quot;\&quot; /&gt;&quot;;
+	echo &quot;&nbsp;&nbsp;&quot;;
+	echo &quot;&lt;input type=\&quot;button\&quot; value=\&quot;&quot; . __('No') . &quot;\&quot; onclick=\&quot;self.location='&quot;. get_settings('siteurl') .&quot;/wp-admin/edit.php?p=$p&amp;c=1#comments';\&quot; /&gt;\n&quot;;
+	echo &quot;&lt;/form&gt;\n&quot;;
+	echo &quot;&lt;/div&gt;\n&quot;;
+
+	break;
+
+case 'deletecomment':
+
+	check_admin_referer();
+
+	$comment = (int) $_GET['comment'];
+	$p = (int) $_GET['p'];
+	if (isset($_GET['noredir'])) {
+		$noredir = true;
+	} else {
+		$noredir = false;
+	}
+
+	$postdata = get_post($p) or die(sprintf(__('Oops, no post with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'edit.php'));
+	$commentdata = get_commentdata($comment, 1, true) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'post.php'));
+
+	if (!user_can_delete_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to edit comments on this post.') );
+	}
+
+	wp_set_comment_status($comment, &quot;delete&quot;);
+	do_action('delete_comment', $comment);
+
+	if (($_SERVER['HTTP_REFERER'] != &quot;&quot;) &amp;&amp; (false == $noredir)) {
+		header('Location: ' . $_SERVER['HTTP_REFERER']);
+	} else {
+		header('Location: '. get_settings('siteurl') .'/wp-admin/edit.php?p='.$p.'&amp;c=1#comments');
+	}
+
+	break;
+
+case 'unapprovecomment':
+
+	require_once('./admin-header.php');
+
+	check_admin_referer();
+
+	$comment = (int) $_GET['comment'];
+	$p = (int) $_GET['p'];
+	if (isset($_GET['noredir'])) {
+		$noredir = true;
+	} else {
+		$noredir = false;
+	}
+
+	$commentdata = get_commentdata($comment) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'edit.php'));
+
+	if (!user_can_edit_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to edit comments on this post, so you cannot disapprove this comment.') );
+	}
+
+	wp_set_comment_status($comment, &quot;hold&quot;);
+
+	if (($_SERVER['HTTP_REFERER'] != &quot;&quot;) &amp;&amp; (false == $noredir)) {
+		header('Location: ' . $_SERVER['HTTP_REFERER']);
+	} else {
+		header('Location: '. get_settings('siteurl') .'/wp-admin/edit.php?p='.$p.'&amp;c=1#comments');
+	}
+
+	break;
+
+case 'mailapprovecomment':
+
+	$comment = (int) $_GET['comment'];
+
+	$commentdata = get_commentdata($comment, 1, true) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'edit.php'));
+
+	if (!user_can_edit_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to edit comments on this post, so you cannot approve this comment.') );
+	}
+
+	if ('1' != $commentdata['comment_approved']) {
+		wp_set_comment_status($comment, 'approve');
+		if (true == get_option('comments_notify'))
+			wp_notify_postauthor($comment);
+	}
+
+	header('Location: ' . get_option('siteurl') . '/wp-admin/moderation.php?approved=1');
+
+	break;
+
+case 'approvecomment':
+
+	$comment = (int) $_GET['comment'];
+	$p = (int) $_GET['p'];
+	if (isset($_GET['noredir'])) {
+		$noredir = true;
+	} else {
+		$noredir = false;
+	}
+	$commentdata = get_commentdata($comment) or die(sprintf(__('Oops, no comment with this ID. &lt;a href=&quot;%s&quot;&gt;Go back&lt;/a&gt;!'), 'edit.php'));
+
+	if (!user_can_edit_post_comments($user_ID, $commentdata['comment_post_ID'])) {
+		die( __('You are not allowed to edit comments on this post, so you cannot approve this comment.') );
+	}
+
+	wp_set_comment_status($comment, &quot;approve&quot;);
+	if (get_settings(&quot;comments_notify&quot;) == true) {
+		wp_notify_postauthor($comment);
+	}
+
+
+	if (($_SERVER['HTTP_REFERER'] != &quot;&quot;) &amp;&amp; (false == $noredir)) {
+		header('Location: ' . $_SERVER['HTTP_REFERER']);
+	} else {
+		header('Location: '. get_settings('siteurl') .'/wp-admin/edit.php?p='.$p.'&amp;c=1#comments');
+	}
+
+	break;
+
+case 'editedcomment':
+
+	$comment_ID = (int) $_POST['comment_ID'];
+	$comment_post_ID = (int) $_POST['comment_post_ID'];
+	$newcomment_author = $_POST['newcomment_author'];
+	$newcomment_author_email = $_POST['newcomment_author_email'];
+	$newcomment_author_url = $_POST['newcomment_author_url'];
+	$comment_status = $_POST['comment_status'];
+
+	if (!user_can_edit_post_comments($user_ID, $comment_post_ID)) {
+		die( __('You are not allowed to edit comments on this post, so you cannot edit this comment.') );
+	}
+
+	if (user_can_edit_post_date($user_ID, $post_ID) &amp;&amp; (!empty($_POST['edit_date']))) {
+		$aa = $_POST['aa'];
+		$mm = $_POST['mm'];
+		$jj = $_POST['jj'];
+		$hh = $_POST['hh'];
+		$mn = $_POST['mn'];
+		$ss = $_POST['ss'];
+		$jj = ($jj &gt; 31) ? 31 : $jj;
+		$hh = ($hh &gt; 23) ? $hh - 24 : $hh;
+		$mn = ($mn &gt; 59) ? $mn - 60 : $mn;
+		$ss = ($ss &gt; 59) ? $ss - 60 : $ss;
+		$datemodif = &quot;, comment_date = '$aa-$mm-$jj $hh:$mn:$ss'&quot;;
+	} else {
+		$datemodif = '';
+	}
+	$content = apply_filters('comment_save_pre', $_POST['content']);
+
+	$result = $wpdb-&gt;query(&quot;
+		UPDATE $wpdb-&gt;comments SET
+			comment_content = '$content',
+			comment_author = '$newcomment_author',
+			comment_author_email = '$newcomment_author_email',
+			comment_approved = '$comment_status',
+			comment_author_url = '$newcomment_author_url'&quot;.$datemodif.&quot;
+		WHERE comment_ID = $comment_ID&quot;
+		);
+
+	$referredby = $_POST['referredby'];
+	if (!empty($referredby)) {
+		header('Location: ' . $referredby);
+	} else {
+		header (&quot;Location: edit.php?p=$comment_post_ID&amp;c=1#comments&quot;);
+	}
+	do_action('edit_comment', $comment_ID);
+	break;
+
+default:
+	$title = __('Create New Post');
+	require_once ('./admin-header.php');
+?&gt;
+&lt;?php if ( isset($_GET['posted']) )
+{
+?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php printf(__('Post saved. &lt;a href=&quot;%s&quot;&gt;View site &raquo;&lt;/a&gt;'), get_bloginfo('home')); ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php
+}
+?&gt;
+&lt;?php
+	if (user_can_create_draft($user_ID))
+	{
+		$action = 'post';
+		get_currentuserinfo();
+		$drafts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts WHERE post_status = 'draft' AND post_author = $user_ID&quot;);
+		if ($drafts)
+		{
+?&gt;
+	&lt;div class=&quot;wrap&quot;&gt;
+		&lt;p&gt;&lt;strong&gt;&lt;?php _e('Your Drafts:') ?&gt;&lt;/strong&gt;
+&lt;?php
+			$i = 0;
+			foreach ($drafts as $draft)
+			{
+				if (0 != $i)
+				{
+					echo ', ';
+				}
+				$draft-&gt;post_title = stripslashes($draft-&gt;post_title);
+				if ($draft-&gt;post_title == '')
+				{
+					$draft-&gt;post_title = sprintf(__('Post # %s'), $draft-&gt;ID);
+				}
+				echo &quot;&lt;a href='post.php?action=edit&amp;post=$draft-&gt;ID' title='&quot; . __('Edit this draft') . &quot;'&gt;$draft-&gt;post_title&lt;/a&gt;&quot;;
+				++$i;
+			}
+?&gt;.
+		&lt;/p&gt;
+	&lt;/div&gt;
+&lt;?php
+		}
+		//set defaults
+		$post_status = 'draft';
+		$comment_status = get_settings('default_comment_status');
+		$ping_status = get_settings('default_ping_status');
+		$post_pingback = get_settings('default_pingback_flag');
+		$default_post_cat = get_settings('default_category');
+
+		$content = wp_specialchars($content);
+		$content = apply_filters('default_content', $content);
+		$edited_post_title = apply_filters('default_title', $edited_post_title);
+		$excerpt = apply_filters('default_excerpt', $excerpt);
+
+		if (get_settings('advanced_edit'))
+		{
+			include('edit-form-advanced.php');
+		}
+		else
+		{
+			include('edit-form.php');
+		}
+?&gt;
+
+&lt;?php
+	}
+
+	break;
+} // end switch
+/* &lt;/Edit&gt; */
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/profile.php
===================================================================
--- trunk/wp-admin/profile.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/profile.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,224 @@
+&lt;?php
+require_once('admin.php');
+
+$title = 'Profile';
+$parent_file = 'profile.php';
+
+$wpvarstoreset = array('action', 'profile', 'user');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+require_once('../wp-config.php');
+auth_redirect();
+switch($action) {
+
+case 'update':
+
+	get_currentuserinfo();
+
+	/* checking the nickname has been typed */
+	if (empty($_POST[&quot;newuser_nickname&quot;])) {
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: please enter your nickname (can be the same as your username)&quot;));
+		return false;
+	}
+
+	/* if the ICQ UIN has been entered, check to see if it has only numbers */
+	if (!empty($_POST[&quot;newuser_icq&quot;])) {
+		if ((ereg(&quot;^[0-9]+$&quot;,$_POST[&quot;newuser_icq&quot;]))==false) {
+			die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: your ICQ UIN can only be a number, no letters allowed&quot;));
+			return false;
+		}
+	}
+
+	/* checking e-mail address */
+	if (empty($_POST[&quot;newuser_email&quot;])) {
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: please type your e-mail address&quot;));
+		return false;
+	} else if (!is_email($_POST[&quot;newuser_email&quot;])) {
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: the e-mail address isn't correct&quot;));
+		return false;
+	}
+
+	$pass1 = $_POST[&quot;pass1&quot;];
+	$pass2 = $_POST[&quot;pass2&quot;];
+	do_action('check_passwords', array($user_login, &amp;$pass1, &amp;$pass2));
+
+	if ( '' == $pass1 ) {
+		if ( '' != $pass2 )
+			die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed your new password only once. Go back to type it twice.&quot;));
+		$updatepassword = &quot;&quot;;
+	} else {
+		if ('' == $pass2)
+			die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed your new password only once. Go back to type it twice.&quot;));
+		if ( $pass1 != $pass2 )
+			die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed two different passwords. Go back to correct that.&quot;));
+		$newuser_pass = $pass1;
+		$updatepassword = &quot;user_pass=MD5('$newuser_pass'), &quot;;
+		wp_clearcookie();
+		wp_setcookie($user_login, $newuser_pass);
+	}
+
+	$newuser_firstname = wp_specialchars($_POST['newuser_firstname']);
+	$newuser_lastname = wp_specialchars($_POST['newuser_lastname']);
+	$newuser_nickname = $_POST['newuser_nickname'];
+	$newuser_nicename = sanitize_title($newuser_nickname);
+	$newuser_icq = wp_specialchars($_POST['newuser_icq']);
+	$newuser_aim = wp_specialchars($_POST['newuser_aim']);
+	$newuser_msn = wp_specialchars($_POST['newuser_msn']);
+	$newuser_yim = wp_specialchars($_POST['newuser_yim']);
+	$newuser_email = wp_specialchars($_POST['newuser_email']);
+	$newuser_url = wp_specialchars($_POST['newuser_url']);
+	$newuser_url = preg_match('/^(https?|ftps?|mailto|news|gopher):/is', $newuser_url) ? $newuser_url : '<A HREF="http://">http://</A>' . $newuser_url;
+	$newuser_idmode = wp_specialchars($_POST['newuser_idmode']);
+	$user_description = $_POST['user_description'];
+
+	$result = $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_firstname='$newuser_firstname', $updatepassword user_lastname='$newuser_lastname', user_nickname='$newuser_nickname', user_icq='$newuser_icq', user_email='$newuser_email', user_url='$newuser_url', user_aim='$newuser_aim', user_msn='$newuser_msn', user_yim='$newuser_yim', user_idmode='$newuser_idmode', user_description = '$user_description', user_nicename = '$newuser_nicename' WHERE ID = $user_ID&quot;);
+
+	wp_redirect('profile.php?updated=true');
+break;
+
+
+default:
+	$parent_file = 'profile.php';
+	include_once('admin-header.php');
+	$profiledata=get_userdata($user_ID);
+
+if (isset($updated)) { ?&gt;
+&lt;div class=&quot;updated&quot;&gt;
+&lt;p&gt;&lt;strong&gt;&lt;?php _e('Profile updated.') ?&gt;&lt;/strong&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;?php } ?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Profile'); ?&gt;&lt;/h2&gt;
+&lt;form name=&quot;profile&quot; id=&quot;profile&quot; action=&quot;profile.php&quot; method=&quot;post&quot;&gt;
+	&lt;p&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;checkuser_id&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+  &lt;/p&gt;
+
+  &lt;table width=&quot;99%&quot;  border=&quot;0&quot; cellspacing=&quot;2&quot; cellpadding=&quot;3&quot; class=&quot;editform&quot;&gt;
+    &lt;tr&gt;
+      &lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Username:') ?&gt;&lt;/th&gt;
+      &lt;td width=&quot;67%&quot;&gt;&lt;?php echo $profiledata-&gt;user_login; ?&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Level:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;?php echo $profiledata-&gt;user_level; ?&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Posts:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;    &lt;?php
+	$posts = get_usernumposts($user_ID);
+	echo $posts;
+	?&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('First name:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_firstname&quot; id=&quot;newuser_firstname&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_firstname ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Last name:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_lastname&quot; id=&quot;newuser_lastname2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_lastname ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Nickname:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_nickname&quot; id=&quot;newuser_nickname2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_nickname ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('How to display name:') ?&gt; &lt;/th&gt;
+      &lt;td&gt;&lt;select name=&quot;newuser_idmode&quot;&gt;
+        &lt;option value=&quot;nickname&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode == 'nickname')
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_nickname ?&gt;&lt;/option&gt;
+        &lt;option value=&quot;login&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode==&quot;login&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_login ?&gt;&lt;/option&gt;
+	&lt;?php if ( !empty( $profiledata-&gt;user_firstname ) ) : ?&gt;
+        &lt;option value=&quot;firstname&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode==&quot;firstname&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_firstname ?&gt;&lt;/option&gt;
+	&lt;?php endif; ?&gt;
+	&lt;?php if ( !empty( $profiledata-&gt;user_lastname ) ) : ?&gt;
+        &lt;option value=&quot;lastname&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode==&quot;lastname&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_lastname ?&gt;&lt;/option&gt;
+	&lt;?php endif; ?&gt;
+	&lt;?php if ( !empty( $profiledata-&gt;user_firstname ) &amp;&amp; !empty( $profiledata-&gt;user_lastname ) ) : ?&gt;
+        &lt;option value=&quot;namefl&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode==&quot;namefl&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_firstname.&quot; &quot;.$profiledata-&gt;user_lastname ?&gt;&lt;/option&gt;
+	&lt;?php endif; ?&gt;
+	&lt;?php if ( !empty( $profiledata-&gt;user_firstname ) &amp;&amp; !empty( $profiledata-&gt;user_lastname ) ) : ?&gt;
+        &lt;option value=&quot;namelf&quot;&lt;?php
+	if ($profiledata-&gt;user_idmode==&quot;namelf&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $profiledata-&gt;user_lastname.&quot; &quot;.$profiledata-&gt;user_firstname ?&gt;&lt;/option&gt;
+	&lt;?php endif; ?&gt;
+      &lt;/select&gt;        &lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_email&quot; id=&quot;newuser_email2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_email ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Website:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_url&quot; id=&quot;newuser_url2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_url ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('ICQ:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_icq&quot; id=&quot;newuser_icq2&quot; value=&quot;&lt;?php if ($profiledata-&gt;user_icq &gt; 0) { echo $profiledata-&gt;user_icq; } ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('AIM:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_aim&quot; id=&quot;newuser_aim2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_aim ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('MSN IM:') ?&gt; &lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;newuser_msn&quot; id=&quot;newuser_msn2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_msn ?&gt;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Yahoo IM:') ?&gt; &lt;/th&gt;
+      &lt;td&gt;        &lt;input type=&quot;text&quot; name=&quot;newuser_yim&quot; id=&quot;newuser_yim2&quot; value=&quot;&lt;?php echo $profiledata-&gt;user_yim ?&gt;&quot; /&gt;      &lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Profile:') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;textarea name=&quot;user_description&quot; rows=&quot;5&quot; id=&quot;textarea2&quot; style=&quot;width: 99%; &quot;&gt;&lt;?php echo $profiledata-&gt;user_description ?&gt;&lt;/textarea&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+&lt;?php
+$show_password_fields = apply_filters('show_password_fields', true);
+if ( $show_password_fields ) :
+?&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('New &lt;strong&gt;Password&lt;/strong&gt; (Leave blank to stay the same.)') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;pass1&quot; size=&quot;16&quot; value=&quot;&quot; /&gt;
+      	&lt;br /&gt;
+        &lt;input type=&quot;password&quot; name=&quot;pass2&quot; size=&quot;16&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+&lt;?php endif; ?&gt;
+  &lt;/table&gt;
+  &lt;p class=&quot;submit&quot;&gt;
+    &lt;input type=&quot;submit&quot; value=&quot;&lt;?php _e('Update Profile &raquo;') ?&gt;&quot; name=&quot;submit&quot; /&gt;
+  &lt;/p&gt;
+&lt;/form&gt;
+&lt;/div&gt;
+
+&lt;/div&gt;
+	&lt;?php
+
+break;
+}
+
+/* &lt;/Profile | My Profile&gt; */
+include('admin-footer.php');
+ ?&gt;

Added: trunk/wp-admin/setup-config.php
===================================================================
--- trunk/wp-admin/setup-config.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/setup-config.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,156 @@
+&lt;?php
+define('WP_INSTALLING', true);
+
+if (file_exists('../wp-config.php')) 
+	die(&quot;The file 'wp-config.php' already exists. If you need to reset any of the configuration items in this file, please delete it first. You may try &lt;a href='install.php'&gt;installing now&lt;/a&gt;.&quot;);
+
+if (!file_exists('../wp-config-sample.php'))
+    die('Sorry, I need a wp-config-sample.php file to work from. Please re-upload this file from your WordPress installation.');
+$configFile = file('../wp-config-sample.php');
+
+if (!is_writable('../')) die(&quot;Sorry, I can't write to the directory. You'll have to either change the permissions on your WordPress directory or create your wp-config.php manually.&quot;);
+
+$step = 0;
+if(isset($_GET['step'])) $step = $_GET['step'];
+header( 'Content-Type: text/html; charset=utf-8' );
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;title&gt;WordPress &rsaquo; Setup Configuration File&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+    &lt;!--
+	body {
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 15%;
+		margin-right: 15%;
+	}
+	#logo {
+		margin: 0;
+		padding: 0;
+		background-image: url(<A HREF="http://wordpress.org/images/logo.png">http://wordpress.org/images/logo.png</A>);
+		background-repeat: no-repeat;
+		height: 60px;
+		border-bottom: 4px solid #333;
+	}
+	#logo a {
+		display: block;
+		height: 60px;
+	}
+	#logo a span {
+		display: none;
+	}
+	p, li {
+		line-height: 140%;
+	}
+    --&gt;
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt; 
+&lt;h1 id=&quot;logo&quot;&gt;&lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;&lt;span&gt;WordPress&lt;/span&gt;&lt;/a&gt;&lt;/h1&gt; 
+&lt;?php
+
+switch($step) {
+	case 0:
+?&gt; 
+&lt;p&gt;Welcome to WordPress. Before getting started, we need some information on the database. You will need to know the following items before proceeding.&lt;/p&gt; 
+&lt;ol&gt; 
+  &lt;li&gt;Database name&lt;/li&gt; 
+  &lt;li&gt;Database username&lt;/li&gt; 
+  &lt;li&gt;Database password&lt;/li&gt; 
+  &lt;li&gt;Database host&lt;/li&gt; 
+  &lt;li&gt;Table prefix (if you want to run more than one WordPress in a single database) &lt;/li&gt;
+&lt;/ol&gt; 
+&lt;p&gt;&lt;strong&gt;If for any reason this automatic file creation doesn't work, don't worry. All this does is fill in the database information to a configuration file. You may also simply open &lt;code&gt;wp-config-sample.php&lt;/code&gt; in a text editor, fill in your information, and save it as &lt;code&gt;wp-config.php&lt;/code&gt;. &lt;/strong&gt;&lt;/p&gt;
+&lt;p&gt;In all likelihood, these items were supplied to you by your ISP. If you do not have this information, then you will need to contact them before you can continue. If you&#8217;re all ready, &lt;a href=&quot;setup-config.php?step=1&quot;&gt;let&#8217;s go&lt;/a&gt;! &lt;/p&gt;
+&lt;?php
+	break;
+
+	case 1:
+	?&gt; 
+&lt;/p&gt; 
+&lt;form method=&quot;post&quot; action=&quot;setup-config.php?step=2&quot;&gt; 
+  &lt;p&gt;Below you should enter your database connection details. If you're not sure about these, contact your host. &lt;/p&gt;
+  &lt;table&gt; 
+    &lt;tr&gt; 
+      &lt;th scope=&quot;row&quot;&gt;Database Name&lt;/th&gt; 
+      &lt;td&gt;&lt;input name=&quot;dbname&quot; type=&quot;text&quot; size=&quot;45&quot; value=&quot;wordpress&quot; /&gt;&lt;/td&gt; 
+      &lt;td&gt;The name of the database you want to run WP in. &lt;/td&gt; 
+    &lt;/tr&gt; 
+    &lt;tr&gt; 
+      &lt;th scope=&quot;row&quot;&gt;User Name&lt;/th&gt; 
+      &lt;td&gt;&lt;input name=&quot;uname&quot; type=&quot;text&quot; size=&quot;45&quot; value=&quot;username&quot; /&gt;&lt;/td&gt; 
+      &lt;td&gt;Your MySQL username&lt;/td&gt; 
+    &lt;/tr&gt; 
+    &lt;tr&gt; 
+      &lt;th scope=&quot;row&quot;&gt;Password&lt;/th&gt; 
+      &lt;td&gt;&lt;input name=&quot;pwd&quot; type=&quot;text&quot; size=&quot;45&quot; value=&quot;password&quot; /&gt;&lt;/td&gt; 
+      &lt;td&gt;...and MySQL password.&lt;/td&gt; 
+    &lt;/tr&gt; 
+    &lt;tr&gt; 
+      &lt;th scope=&quot;row&quot;&gt;Database Host&lt;/th&gt; 
+      &lt;td&gt;&lt;input name=&quot;dbhost&quot; type=&quot;text&quot; size=&quot;45&quot; value=&quot;localhost&quot; /&gt;&lt;/td&gt; 
+      &lt;td&gt;99% chance you won't need to change this value.&lt;/td&gt; 
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;Table Prefix&lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;prefix&quot; type=&quot;text&quot; id=&quot;prefix&quot; value=&quot;wp_&quot; size=&quot;45&quot; /&gt;&lt;/td&gt;
+      &lt;td&gt;If you want to run multiple WordPress installations in a single database, change this.&lt;/td&gt;
+    &lt;/tr&gt; 
+  &lt;/table&gt; 
+  &lt;input name=&quot;submit&quot; type=&quot;submit&quot; value=&quot;Submit&quot; /&gt; 
+&lt;/form&gt; 
+&lt;?php
+	break;
+	
+	case 2:
+	$dbname = $_POST['dbname'];
+    $uname = $_POST['uname'];
+    $passwrd = $_POST['pwd'];
+    $dbhost = $_POST['dbhost'];
+	$prefix = $_POST['prefix'];
+	if (empty($prefix)) $prefix = 'wp_';
+
+    // Test the db connection.
+    define('DB_NAME', $dbname);
+    define('DB_USER', $uname);
+    define('DB_PASSWORD', $passwrd);
+    define('DB_HOST', $dbhost);
+
+    // We'll fail here if the values are no good.
+    require_once('../wp-includes/wp-db.php');
+	$handle = fopen('../wp-config.php', 'w');
+
+    foreach ($configFile as $line_num =&gt; $line) {
+        switch (substr($line,0,16)) {
+            case &quot;define('DB_NAME'&quot;:
+                fwrite($handle, str_replace(&quot;wordpress&quot;, $dbname, $line));
+                break;
+            case &quot;define('DB_USER'&quot;:
+                fwrite($handle, str_replace(&quot;'username'&quot;, &quot;'$uname'&quot;, $line));
+                break;
+            case &quot;define('DB_PASSW&quot;:
+                fwrite($handle, str_replace(&quot;'password'&quot;, &quot;'$passwrd'&quot;, $line));
+                break;
+            case &quot;define('DB_HOST'&quot;:
+                fwrite($handle, str_replace(&quot;localhost&quot;, $dbhost, $line));
+                break;
+			case '$table_prefix  =':
+				fwrite($handle, str_replace('wp_', $prefix, $line));
+				break;
+            default:
+                fwrite($handle, $line);
+        }
+    }
+    fclose($handle);
+	chmod('../wp-config.php', 0666);
+?&gt; 
+&lt;p&gt;All right sparky! You've made it through this part of the installation. WordPress can now communicate with your database. If you are ready, time now to &lt;a href=&quot;install.php&quot;&gt;run the install!&lt;/a&gt;&lt;/p&gt; 
+&lt;?php
+	break;
+
+}
+?&gt; 
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/sidebar.php
===================================================================
--- trunk/wp-admin/sidebar.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/sidebar.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,81 @@
+&lt;?php
+$mode = 'sidebar';
+
+require_once('admin.php');
+
+get_currentuserinfo();
+
+if ($user_level == 0)
+	die (&quot;Cheatin' uh ?&quot;);
+
+if ('b' == $_GET['a']) {
+
+?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;title&gt;SteamPress &#8250; Posted&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=UTF-8&quot; /&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+&lt;/head&gt;
+&lt;body&gt;
+	&lt;p&gt;Posted !&lt;/p&gt;
+	&lt;p&gt;&lt;a href=&quot;sidebar.php&quot;&gt;Click here&lt;/a&gt; to post again.&lt;/p&gt;
+&lt;/body&gt;
+&lt;/html&gt;&lt;?php
+
+} else {
+
+?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;title&gt;SteamPress &#8250; Sidebar&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('blog_charset'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+form {
+	padding: 3px;
+}
+.sidebar-categories {
+    display: block;
+    height: 6.6em;
+    overflow: auto;
+    background-color: #f4f4f4;
+}
+.sidebar-categories label {
+	font-size: 10px;
+    display: block;
+    width: 90%;
+}
+&lt;/style&gt;
+&lt;/head&gt;
+&lt;body id=&quot;sidebar&quot;&gt;
+&lt;h1 id=&quot;wphead&quot;&gt;&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot; rel=&quot;external&quot;&gt;SteamPress&lt;/a&gt;&lt;/h1&gt;
+&lt;form name=&quot;post&quot; action=&quot;post.php&quot; method=&quot;POST&quot;&gt;
+&lt;div&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;post&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;user_ID&quot; value=&quot;&lt;?php echo $user_ID ?&gt;&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;sidebar&quot; /&gt;
+&lt;p&gt;Title:
+&lt;input type=&quot;text&quot; name=&quot;post_title&quot; size=&quot;20&quot; tabindex=&quot;1&quot; style=&quot;width: 100%;&quot; /&gt;
+&lt;/p&gt;
+&lt;p&gt;Categories:
+&lt;span class=&quot;sidebar-categories&quot;&gt;
+&lt;?php dropdown_categories(); ?&gt;
+&lt;/span&gt;
+&lt;/p&gt;
+&lt;p&gt;
+Post:
+&lt;textarea rows=&quot;8&quot; cols=&quot;12&quot; style=&quot;width: 100%&quot; name=&quot;content&quot; tabindex=&quot;2&quot;&gt;&lt;/textarea&gt;
+&lt;/p&gt;
+&lt;p&gt;
+    &lt;input name=&quot;saveasdraft&quot; type=&quot;submit&quot; id=&quot;saveasdraft&quot; tabindex=&quot;9&quot; value=&quot;Save as Draft&quot; /&gt;
+    &lt;input name=&quot;publish&quot; type=&quot;submit&quot; id=&quot;publish&quot; tabindex=&quot;6&quot; style=&quot;font-weight: bold;&quot; value=&quot;Publish&quot; /&gt;
+
+&lt;/p&gt;
+&lt;/div&gt;
+&lt;/form&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
+&lt;?php
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/themes.php
===================================================================
--- trunk/wp-admin/themes.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/themes.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,154 @@
+&lt;?php
+require_once('admin.php');
+
+if ( isset($_GET['action']) ) {
+	check_admin_referer();
+
+	if ('activate' == $_GET['action']) {
+	  if (isset($_GET['template'])) {
+	    update_option('template', $_GET['template']);
+	  }
+
+	  if (isset($_GET['stylesheet'])) {
+	    update_option('stylesheet', $_GET['stylesheet']);
+	  }
+
+		do_action('switch_theme', get_current_theme());
+
+	  header('Location: themes.php?activated=true');
+	}
+ }
+
+$title = __('Manage Themes');
+$parent_file = 'themes.php';
+require_once('admin-header.php');
+?&gt;
+&lt;?php if ( ! validate_current_theme() ) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('The active theme is broken.  Reverting to the default theme.'); ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php elseif ( isset($activated) ) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('New theme activated'); ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;?php
+$themes = get_themes();
+$current_theme = get_current_theme();
+$current_title = $themes[$current_theme]['Title'];
+$current_version = $themes[$current_theme]['Version'];
+$current_parent_theme = $themes[$current_theme]['Parent Theme'];
+$current_template_dir = $themes[$current_theme]['Template Dir'];
+$current_stylesheet_dir = $themes[$current_theme]['Stylesheet Dir'];
+$current_template = $themes[$current_theme]['Template'];
+$current_stylesheet = $themes[$current_theme]['Stylesheet'];
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Current Theme'); ?&gt;&lt;/h2&gt;
+&lt;div id=&quot;currenttheme&quot;&gt;
+&lt;h3&gt;&lt;?php printf(__('%1$s %2$s by %3$s'), $current_title, $current_version, $themes[$current_theme]['Author']) ; ?&gt;&lt;/h3&gt;
+&lt;p&gt;&lt;?php echo $themes[$current_theme]['Description']; ?&gt;&lt;/p&gt;
+&lt;?php if ($current_parent_theme) { ?&gt;
+	&lt;p&gt;&lt;?php printf(__('The active theme is &lt;strong&gt;%1$s&lt;/strong&gt;.  The template files are located in &lt;code&gt;%2$s&lt;/code&gt;.  The stylesheet files are located in &lt;code&gt;%3$s&lt;/code&gt;.  &lt;strong&gt;%4$s&lt;/strong&gt; uses templates from &lt;strong&gt;%5$s&lt;/strong&gt;.  Changes made to the templates will affect both themes.'), $current_theme, $current_template_dir, $current_stylesheet_dir, $current_theme, $current_parent_theme); ?&gt;&lt;/p&gt;
+&lt;?php } else { ?&gt;
+	&lt;p&gt;&lt;?php printf(__('The active theme is &lt;strong&gt;%1$s&lt;/strong&gt;.  The template files are located in &lt;code&gt;%2$s&lt;/code&gt;.  The stylesheet files are located in &lt;code&gt;%3$s&lt;/code&gt;.'), $current_theme, $current_template_dir, $current_stylesheet_dir); ?&gt;&lt;/p&gt;
+&lt;?php } ?&gt;
+&lt;/div&gt;
+
+&lt;h2&gt;&lt;?php _e('Themes Available'); ?&gt;&lt;/h2&gt;
+&lt;?php if ( 1 &lt; count($themes) ) { ?&gt;
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th&gt;&lt;?php _e('Name'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Author'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Description'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+	$style = '';
+
+	$theme_names = array_keys($themes);
+	natcasesort($theme_names);
+
+	foreach ($theme_names as $theme_name) {
+		$template = $themes[$theme_name]['Template'];
+		$stylesheet = $themes[$theme_name]['Stylesheet'];
+		$title = $themes[$theme_name]['Title'];
+		$version = $themes[$theme_name]['Version'];
+		$description = $themes[$theme_name]['Description'];
+		$author = $themes[$theme_name]['Author'];
+
+		if ($template == $current_template &amp;&amp; $stylesheet == $current_stylesheet) {
+			$action = '&lt;strong&gt;' . __('Active Theme') . '&lt;/strong&gt;';
+			$current = true;
+		} else {
+			$action = &quot;&lt;a href='themes.php?action=activate&amp;template=$template&amp;stylesheet=$stylesheet' title='&quot; . __('Select this theme') . &quot;' class='edit'&gt;&quot; . __('Select') . '&lt;/a&gt;';
+			$current = false;
+		}
+
+		$style = ('class=&quot;alternate&quot;' == $style|| 'class=&quot;alternate active&quot;' == $style) ? '' : 'alternate';
+		if ($current) $style .= $style == 'alternate' ? ' active' : 'active';
+		if ($style != '') $style = 'class=&quot;' . $style . '&quot;';
+
+		echo &quot;
+	  &lt;tr $style&gt;&quot;;
+if ( $current )
+	echo &quot;&lt;td&gt;&lt;strong&gt;$title $version&lt;/strong&gt;&lt;/td&gt;&quot;;
+else
+	echo &quot;&lt;td&gt;$title $version&lt;/td&gt;&quot;;
+echo &quot;
+	     &lt;td class=\&quot;auth\&quot;&gt;$author&lt;/td&gt;
+	     &lt;td class=\&quot;desc\&quot;&gt;$description&lt;/td&gt;
+	     &lt;td class=\&quot;togl\&quot;&gt;$action&lt;/td&gt;
+	  &lt;/tr&gt;&quot;;
+	}
+?&gt;
+
+&lt;/table&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;?php
+// List broken themes, if any.
+$broken_themes = get_broken_themes();
+if (count($broken_themes)) {
+?&gt;
+
+&lt;h2&gt;&lt;?php _e('Broken Themes'); ?&gt;&lt;/h2&gt;
+&lt;p&gt;&lt;?php _e('The following themes are installed but incomplete.  Themes must have a stylesheet and a template.'); ?&gt;&lt;/p&gt;
+
+&lt;table width=&quot;100%&quot; cellpadding=&quot;3&quot; cellspacing=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th&gt;&lt;?php _e('Name'); ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Description'); ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+	$theme = '';
+	
+	$theme_names = array_keys($broken_themes);
+	natcasesort($theme_names);
+
+	foreach ($theme_names as $theme_name) {
+		$title = $broken_themes[$theme_name]['Title'];
+		$description = $broken_themes[$theme_name]['Description'];
+
+		$theme = ('class=&quot;alternate&quot;' == $theme) ? '' : 'class=&quot;alternate&quot;';
+		echo &quot;
+	  &lt;tr $theme&gt;
+	     &lt;td&gt;$title&lt;/td&gt;
+	     &lt;td&gt;$description&lt;/td&gt;
+	  &lt;/tr&gt;&quot;;
+	}
+?&gt;
+&lt;/table&gt;
+&lt;?php
+}
+?&gt;
+
+&lt;h2&gt;&lt;?php _e('Get More Themes'); ?&gt;&lt;/h2&gt;
+&lt;p&gt;&lt;?php _e('You can find additional themes for your site in the &lt;a href=&quot;<A HREF="http://wordpress.org/extend/themes/">http://wordpress.org/extend/themes/</A>&quot;&gt;WordPress theme directory&lt;/a&gt;. To install a theme you generally just need to upload the theme folder into your &lt;code&gt;wp-content/themes&lt;/code&gt; directory. Once a theme is uploaded, you may activate it here.'); ?&gt;&lt;/p&gt;
+
+&lt;/div&gt;
+
+&lt;?php
+include('admin-footer.php');
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/update-links.php
===================================================================
--- trunk/wp-admin/update-links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/update-links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,44 @@
+&lt;?php
+require_once( dirname( dirname(__FILE__) ) . '/wp-config.php');
+require_once( ABSPATH . 'wp-includes/class-snoopy.php');
+
+if ( !get_option('use_linksupdate') )
+	die('Feature disabled.');
+
+$link_uris = $wpdb-&gt;get_col(&quot;SELECT link_url FROM $wpdb-&gt;links&quot;);
+
+if ( !$link_uris )
+	die('No links');
+
+$link_uris = urlencode( join( $link_uris, &quot;\n&quot; ) );
+
+$query_string = &quot;uris=$link_uris&quot;;
+
+$http_request  = &quot;POST /updated-batch/ HTTP/1.0\r\n&quot;;
+$http_request .= &quot;Host: api.pingomatic.com\r\n&quot;;
+$http_request .= 'Content-Type: application/x-www-form-urlencoded; charset='.get_settings('blog_charset').&quot;\r\n&quot;;
+$http_request .= 'Content-Length: ' . strlen($query_string) . &quot;\r\n&quot;;
+$http_request .= 'User-Agent: WordPress/' . $wp_version . &quot;\r\n&quot;;
+$http_request .= &quot;\r\n&quot;;
+$http_request .= $query_string;
+
+$response = '';
+if( false !== ( $fs = fsockopen('api.pingomatic.com', 80, $errno, $errstr, 5) ) ) {
+	fwrite($fs, $http_request);
+	while ( !feof($fs) )
+		$response .= fgets($fs, 1160); // One TCP-IP packet
+	fclose($fs);
+    
+	$response = explode(&quot;\r\n\r\n&quot;, $response, 2);
+	$body = trim( $response[1] );
+	$body = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $body);
+    
+	$returns = explode(&quot;\n&quot;, $body);
+    
+	foreach ($returns as $return) :
+		$time = addslashes( substr($return, 0, 19) );
+		$uri = addslashes( preg_replace('/(.*?) | (.*?)/', '$2', $return) );
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links SET link_updated = '$time' WHERE link_url = '$uri'&quot;);
+	endforeach;
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/upgrade-functions.php
===================================================================
--- trunk/wp-admin/upgrade-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/upgrade-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,706 @@
+&lt;?php
+
+require_once(ABSPATH . '/wp-admin/admin-functions.php');
+require_once(ABSPATH . '/wp-admin/upgrade-schema.php');
+// Functions to be called in install and upgrade scripts
+function upgrade_all() {
+	populate_options();
+	upgrade_100();
+	upgrade_101();
+	upgrade_110();
+	upgrade_130();
+	save_mod_rewrite_rules();
+}
+
+function upgrade_100() {
+	global $wpdb;
+
+	// Get the title and ID of every post, post_name to check if it already has a value
+	$posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title, post_name FROM $wpdb-&gt;posts WHERE post_name = ''&quot;);
+	if ($posts) {
+		foreach($posts as $post) {
+			if ('' == $post-&gt;post_name) { 
+				$newtitle = sanitize_title($post-&gt;post_title);
+				$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_name = '$newtitle' WHERE ID = '$post-&gt;ID'&quot;);
+			}
+		}
+	}
+	
+	$categories = $wpdb-&gt;get_results(&quot;SELECT cat_ID, cat_name, category_nicename FROM $wpdb-&gt;categories&quot;);
+	foreach ($categories as $category) {
+		if ('' == $category-&gt;category_nicename) { 
+			$newtitle = sanitize_title($category-&gt;cat_name);
+			$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;categories SET category_nicename = '$newtitle' WHERE cat_ID = '$category-&gt;cat_ID'&quot;);
+		}
+	}
+
+
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = REPLACE(option_value, 'wp-links/links-images/', 'wp-images/links/')
+	WHERE option_name LIKE 'links_rating_image%'
+	AND option_value LIKE 'wp-links/links-images/%'&quot;);
+
+	$done_ids = $wpdb-&gt;get_results(&quot;SELECT DISTINCT post_id FROM $wpdb-&gt;post2cat&quot;);
+	if ($done_ids) :
+		foreach ($done_ids as $done_id) :
+			$done_posts[] = $done_id-&gt;post_id;
+		endforeach;
+		$catwhere = ' AND ID NOT IN (' . implode(',', $done_posts) . ')';
+	else:
+		$catwhere = '';
+	endif;
+	
+	$allposts = $wpdb-&gt;get_results(&quot;SELECT ID, post_category FROM $wpdb-&gt;posts WHERE post_category != '0' $catwhere&quot;);
+	if ($allposts) :
+		foreach ($allposts as $post) {
+			// Check to see if it's already been imported
+			$cat = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;post2cat WHERE post_id = $post-&gt;ID AND category_id = $post-&gt;post_category&quot;);
+			if (!$cat &amp;&amp; 0 != $post-&gt;post_category) { // If there's no result
+				$wpdb-&gt;query(&quot;
+					INSERT INTO $wpdb-&gt;post2cat
+					(post_id, category_id)
+					VALUES
+					('$post-&gt;ID', '$post-&gt;post_category')
+					&quot;);
+			}
+		}
+	endif;
+}
+
+function upgrade_101() {
+	global $wpdb;
+
+	// Clean up indices, add a few
+	add_clean_index($wpdb-&gt;posts, 'post_name');
+	add_clean_index($wpdb-&gt;posts, 'post_status');
+	add_clean_index($wpdb-&gt;categories, 'category_nicename');
+	add_clean_index($wpdb-&gt;comments, 'comment_approved');
+	add_clean_index($wpdb-&gt;comments, 'comment_post_ID');
+	add_clean_index($wpdb-&gt;links , 'link_category');
+	add_clean_index($wpdb-&gt;links , 'link_visible');
+}
+
+
+function upgrade_110() {
+  global $wpdb;
+	
+    // Set user_nicename.
+	$users = $wpdb-&gt;get_results(&quot;SELECT ID, user_nickname, user_nicename FROM $wpdb-&gt;users&quot;);
+	foreach ($users as $user) {
+		if ('' == $user-&gt;user_nicename) { 
+			$newname = sanitize_title($user-&gt;user_nickname);
+			$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_nicename = '$newname' WHERE ID = '$user-&gt;ID'&quot;);
+		}
+	}
+
+	$users = $wpdb-&gt;get_results(&quot;SELECT ID, user_pass from $wpdb-&gt;users&quot;);
+	foreach ($users as $row) {
+		if (!preg_match('/^[A-Fa-f0-9]{32}$/', $row-&gt;user_pass)) {
+			   $wpdb-&gt;query('UPDATE '.$wpdb-&gt;users.' SET user_pass = MD5(\''.$row-&gt;user_pass.'\') WHERE ID = \''.$row-&gt;ID.'\'');
+		}
+	}
+
+
+	// Get the GMT offset, we'll use that later on
+	$all_options = get_alloptions_110();
+
+	$time_difference = $all_options-&gt;time_difference;
+
+	$server_time = time()+date('Z');
+	$weblogger_time = $server_time + $time_difference*3600;
+	$gmt_time = time();
+
+	$diff_gmt_server = ($gmt_time - $server_time) / 3600;
+	$diff_weblogger_server = ($weblogger_time - $server_time) / 3600;
+	$diff_gmt_weblogger = $diff_gmt_server - $diff_weblogger_server;
+	$gmt_offset = -$diff_gmt_weblogger;
+
+	// Add a gmt_offset option, with value $gmt_offset
+	add_option('gmt_offset', $gmt_offset);
+
+	// Check if we already set the GMT fields (if we did, then
+	// MAX(post_date_gmt) can't be '0000-00-00 00:00:00'
+	// &lt;michel_v&gt; I just slapped myself silly for not thinking about it earlier
+	$got_gmt_fields = ($wpdb-&gt;get_var(&quot;SELECT MAX(post_date_gmt) FROM $wpdb-&gt;posts&quot;) == '0000-00-00 00:00:00') ? false : true;
+
+	if (!$got_gmt_fields) {
+
+		// Add or substract time to all dates, to get GMT dates
+		$add_hours = intval($diff_gmt_weblogger);
+		$add_minutes = intval(60 * ($diff_gmt_weblogger - $add_hours));
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_date_gmt = DATE_ADD(post_date, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_modified = post_date&quot;);
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_modified_gmt = DATE_ADD(post_modified, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE) WHERE post_modified != '0000-00-00 00:00:00'&quot;);
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_date_gmt = DATE_ADD(comment_date, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_registered = DATE_ADD(user_registered, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;);
+	}
+
+}
+
+function upgrade_130() {
+    global $wpdb, $table_prefix;
+
+    // Remove extraneous backslashes.
+	$posts = $wpdb-&gt;get_results(&quot;SELECT ID, post_title, post_content, post_excerpt, guid, post_date, post_name, post_status, post_author FROM $wpdb-&gt;posts&quot;);
+	if ($posts) {
+		foreach($posts as $post) {
+            $post_content = addslashes(deslash($post-&gt;post_content));
+            $post_title = addslashes(deslash($post-&gt;post_title));
+            $post_excerpt = addslashes(deslash($post-&gt;post_excerpt));
+			if ( empty($post-&gt;guid) )
+				$guid = get_permalink($post-&gt;ID);
+			else
+				$guid = $post-&gt;guid;
+
+            $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_title = '$post_title', post_content = '$post_content', post_excerpt = '$post_excerpt', guid = '$guid' WHERE ID = '$post-&gt;ID'&quot;);
+		}
+	}
+
+    // Remove extraneous backslashes.
+	$comments = $wpdb-&gt;get_results(&quot;SELECT comment_ID, comment_author, comment_content FROM $wpdb-&gt;comments&quot;);
+	if ($comments) {
+		foreach($comments as $comment) {
+            $comment_content = addslashes(deslash($comment-&gt;comment_content));
+            $comment_author = addslashes(deslash($comment-&gt;comment_author));
+            $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_content = '$comment_content', comment_author = '$comment_author' WHERE comment_ID = '$comment-&gt;comment_ID'&quot;);
+		}
+	}
+
+    // Remove extraneous backslashes.
+	$links = $wpdb-&gt;get_results(&quot;SELECT link_id, link_name, link_description FROM $wpdb-&gt;links&quot;);
+	if ($links) {
+		foreach($links as $link) {
+            $link_name = addslashes(deslash($link-&gt;link_name));
+            $link_description = addslashes(deslash($link-&gt;link_description));
+            $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;links SET link_name = '$link_name', link_description = '$link_description' WHERE link_id = '$link-&gt;link_id'&quot;);
+		}
+	}
+
+    // The &quot;paged&quot; option for what_to_show is no more.
+    if ($wpdb-&gt;get_var(&quot;SELECT option_value FROM $wpdb-&gt;options WHERE option_name = 'what_to_show'&quot;) == 'paged') {
+        $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = 'posts' WHERE option_name = 'what_to_show'&quot;);
+    }
+
+		$active_plugins = __get_option('active_plugins');
+
+		// If plugins are not stored in an array, they're stored in the old
+		// newline separated format.  Convert to new format.
+		if ( !is_array( $active_plugins ) ) {
+			$active_plugins = explode(&quot;\n&quot;, trim($active_plugins));
+			update_option('active_plugins', $active_plugins);
+		}
+
+	// Obsolete tables
+	$wpdb-&gt;query('DROP TABLE IF EXISTS ' . $table_prefix . 'optionvalues');
+	$wpdb-&gt;query('DROP TABLE IF EXISTS ' . $table_prefix . 'optiontypes');
+	$wpdb-&gt;query('DROP TABLE IF EXISTS ' . $table_prefix . 'optiongroups');
+	$wpdb-&gt;query('DROP TABLE IF EXISTS ' . $table_prefix . 'optiongroup_options');
+
+	// Update comments table to use comment_type
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_type='trackback', comment_content = REPLACE(comment_content, '&lt;trackback /&gt;', '') WHERE comment_content LIKE '&lt;trackback /&gt;%'&quot;);
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;comments SET comment_type='pingback', comment_content = REPLACE(comment_content, '&lt;pingback /&gt;', '') WHERE comment_content LIKE '&lt;pingback /&gt;%'&quot;);
+
+	// Some versions have multiple duplicate option_name rows with the same values
+	$options = $wpdb-&gt;get_results(&quot;SELECT option_name, COUNT(option_name) AS dupes FROM `$wpdb-&gt;options` GROUP BY option_name&quot;);
+	foreach ( $options as $option ) {
+		if ( 1 != $option-&gt;dupes ) { // Could this be done in the query?
+			$limit = $option-&gt;dupes - 1;
+			$dupe_ids = $wpdb-&gt;get_col(&quot;SELECT option_id FROM $wpdb-&gt;options WHERE option_name = '$option-&gt;option_name' LIMIT $limit&quot;);
+			$dupe_ids = join($dupe_ids, ',');
+			$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;options WHERE option_id IN ($dupe_ids)&quot;);
+		}
+	}
+
+	make_site_theme();
+}
+
+// The functions we use to actually do stuff
+
+// General
+function maybe_create_table($table_name, $create_ddl) {
+    global $wpdb;
+    foreach ($wpdb-&gt;get_col(&quot;SHOW TABLES&quot;,0) as $table ) {
+        if ($table == $table_name) {
+            return true;
+        }
+    }
+    //didn't find it try to create it.
+    $q = $wpdb-&gt;query($create_ddl);
+    // we cannot directly tell that whether this succeeded!
+    foreach ($wpdb-&gt;get_col(&quot;SHOW TABLES&quot;,0) as $table ) {
+        if ($table == $table_name) {
+            return true;
+        }
+    }
+    return false;
+}
+
+function drop_index($table, $index) {
+	global $wpdb;
+	$wpdb-&gt;hide_errors();
+	$wpdb-&gt;query(&quot;ALTER TABLE `$table` DROP INDEX `$index`&quot;);
+	// Now we need to take out all the extra ones we may have created
+	for ($i = 0; $i &lt; 25; $i++) {
+		$wpdb-&gt;query(&quot;ALTER TABLE `$table` DROP INDEX `{$index}_$i`&quot;);
+	}
+	$wpdb-&gt;show_errors();
+	return true;
+}
+
+function add_clean_index($table, $index) {
+	global $wpdb;
+	drop_index($table, $index);
+	$wpdb-&gt;query(&quot;ALTER TABLE `$table` ADD INDEX ( `$index` )&quot;);
+	return true;
+}
+
+/**
+ ** maybe_add_column()
+ ** Add column to db table if it doesn't exist.
+ ** Returns:  true if already exists or on successful completion
+ **           false on error
+ */
+function maybe_add_column($table_name, $column_name, $create_ddl) {
+    global $wpdb, $debug;
+    foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;, 0) as $column ) {
+        if ($debug) echo(&quot;checking $column == $column_name&lt;br /&gt;&quot;);
+        if ($column == $column_name) {
+            return true;
+        }
+    }
+    //didn't find it try to create it.
+    $q = $wpdb-&gt;query($create_ddl);
+    // we cannot directly tell that whether this succeeded!
+    foreach ($wpdb-&gt;get_col(&quot;DESC $table_name&quot;, 0) as $column ) {
+        if ($column == $column_name) {
+            return true;
+        }
+    }
+    return false;
+}
+
+
+// get_alloptions as it was for 1.2.
+function get_alloptions_110() {
+	global $wpdb;
+	if ($options = $wpdb-&gt;get_results(&quot;SELECT option_name, option_value FROM $wpdb-&gt;options&quot;)) {
+		foreach ($options as $option) {
+			// &quot;When trying to design a foolproof system, 
+			//  never underestimate the ingenuity of the fools :)&quot; -- Dougal
+			if ('siteurl' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+			if ('home' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+			if ('category_base' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+			$all_options-&gt;{$option-&gt;option_name} = stripslashes($option-&gt;option_value);
+		}
+	}
+	return $all_options;
+}
+
+// Version of get_option that is private to install/upgrade.
+function __get_option($setting) {
+	global $wpdb;
+
+	$option = $wpdb-&gt;get_var(&quot;SELECT option_value FROM $wpdb-&gt;options WHERE option_name = '$setting'&quot;);
+
+	@ $kellogs = unserialize($option);
+	if ($kellogs !== FALSE)
+		return $kellogs;
+	else
+		return $option;
+}
+
+function deslash($content) {
+    // Note: \\\ inside a regex denotes a single backslash.
+
+    // Replace one or more backslashes followed by a single quote with
+    // a single quote.
+    $content = preg_replace(&quot;/\\\+'/&quot;, &quot;'&quot;, $content);
+
+    // Replace one or more backslashes followed by a double quote with
+    // a double quote.
+    $content = preg_replace('/\\\+&quot;/', '&quot;', $content);
+
+    // Replace one or more backslashes with one backslash.
+    $content = preg_replace(&quot;/\\\+/&quot;, &quot;\\&quot;, $content);
+
+    return $content;
+}
+
+function dbDelta($queries, $execute = true) {
+	global $wpdb;
+	
+	// Seperate individual queries into an array
+	if( !is_array($queries) ) {
+		$queries = explode( ';', $queries );
+		if('' == $queries[count($queries) - 1]) array_pop($queries);
+	}
+	
+	$cqueries = array(); // Creation Queries
+	$iqueries = array(); // Insertion Queries
+	$for_update = array();
+	
+	// Create a tablename index for an array ($cqueries) of queries
+	foreach($queries as $qry) {
+		if(preg_match(&quot;|CREATE TABLE ([^ ]*)|&quot;, $qry, $matches)) {
+			$cqueries[strtolower($matches[1])] = $qry;
+			$for_update[$matches[1]] = 'Created table '.$matches[1];
+		}
+		else if(preg_match(&quot;|CREATE DATABASE ([^ ]*)|&quot;, $qry, $matches)) {
+			array_unshift($cqueries, $qry);
+		}
+		else if(preg_match(&quot;|INSERT INTO ([^ ]*)|&quot;, $qry, $matches)) {
+			$iqueries[] = $qry;
+		}
+		else if(preg_match(&quot;|UPDATE ([^ ]*)|&quot;, $qry, $matches)) {
+			$iqueries[] = $qry;
+		}
+		else {
+			// Unrecognized query type
+		}
+	}	
+
+	// Check to see which tables and fields exist
+	if($tables = $wpdb-&gt;get_col('SHOW TABLES;')) {
+		// For every table in the database
+		foreach($tables as $table) {
+			// If a table query exists for the database table...
+			if( array_key_exists(strtolower($table), $cqueries) ) {
+				// Clear the field and index arrays
+				unset($cfields);
+				unset($indices);
+				// Get all of the field names in the query from between the parens
+				preg_match(&quot;|\((.*)\)|ms&quot;, $cqueries[strtolower($table)], $match2);
+				$qryline = trim($match2[1]);
+
+				// Separate field lines into an array
+				$flds = explode(&quot;\n&quot;, $qryline);
+
+				//echo &quot;&lt;hr/&gt;&lt;pre&gt;\n&quot;.print_r(strtolower($table), true).&quot;:\n&quot;.print_r($cqueries, true).&quot;&lt;/pre&gt;&lt;hr/&gt;&quot;;
+				
+				// For every field line specified in the query
+				foreach($flds as $fld) {
+					// Extract the field name
+					preg_match(&quot;|^([^ ]*)|&quot;, trim($fld), $fvals);
+					$fieldname = $fvals[1];
+					
+					// Verify the found field name
+					$validfield = true;
+					switch(strtolower($fieldname))
+					{
+					case '':
+					case 'primary':
+					case 'index':
+					case 'fulltext':
+					case 'unique':
+					case 'key':
+						$validfield = false;
+						$indices[] = trim(trim($fld), &quot;, \n&quot;);
+						break;
+					}
+					$fld = trim($fld);
+					
+					// If it's a valid field, add it to the field array
+					if($validfield) {
+						$cfields[strtolower($fieldname)] = trim($fld, &quot;, \n&quot;);
+					}
+				}
+				
+				// Fetch the table column structure from the database
+				$tablefields = $wpdb-&gt;get_results(&quot;DESCRIBE {$table};&quot;);
+								
+				// For every field in the table
+				foreach($tablefields as $tablefield) {				
+					// If the table field exists in the field array...
+					if(array_key_exists(strtolower($tablefield-&gt;Field), $cfields)) {
+						// Get the field type from the query
+						preg_match(&quot;|&quot;.$tablefield-&gt;Field.&quot; ([^ ]*( unsigned)?)|i&quot;, $cfields[strtolower($tablefield-&gt;Field)], $matches);
+						$fieldtype = $matches[1];
+
+						// Is actual field type different from the field type in query?
+						if($tablefield-&gt;Type != $fieldtype) {
+							// Add a query to change the column type
+							$cqueries[] = &quot;ALTER TABLE {$table} CHANGE COLUMN {$tablefield-&gt;Field} &quot; . $cfields[strtolower($tablefield-&gt;Field)];
+							$for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed type of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Type} to {$fieldtype}&quot;;
+						}
+						
+						// Get the default value from the array
+							//echo &quot;{$cfields[strtolower($tablefield-&gt;Field)]}&lt;br&gt;&quot;;
+						if(preg_match(&quot;| DEFAULT '(.*)'|i&quot;, $cfields[strtolower($tablefield-&gt;Field)], $matches)) {
+							$default_value = $matches[1];
+							if($tablefield-&gt;Default != $default_value)
+							{
+								// Add a query to change the column's default value
+								$cqueries[] = &quot;ALTER TABLE {$table} ALTER COLUMN {$tablefield-&gt;Field} SET DEFAULT '{$default_value}'&quot;;
+								$for_update[$table.'.'.$tablefield-&gt;Field] = &quot;Changed default value of {$table}.{$tablefield-&gt;Field} from {$tablefield-&gt;Default} to {$default_value}&quot;;
+							}
+						}
+
+						// Remove the field from the array (so it's not added)
+						unset($cfields[strtolower($tablefield-&gt;Field)]);
+					}
+					else {
+						// This field exists in the table, but not in the creation queries?
+					}
+				}
+
+				// For every remaining field specified for the table
+				foreach($cfields as $fieldname =&gt; $fielddef) {
+					// Push a query line into $cqueries that adds the field to that table
+					$cqueries[] = &quot;ALTER TABLE {$table} ADD COLUMN $fielddef&quot;;
+					$for_update[$table.'.'.$fieldname] = 'Added column '.$table.'.'.$fieldname;
+				}
+				
+				// Index stuff goes here
+				// Fetch the table index structure from the database
+				$tableindices = $wpdb-&gt;get_results(&quot;SHOW INDEX FROM {$table};&quot;);
+				
+				if($tableindices) {
+					// Clear the index array
+					unset($index_ary);
+
+					// For every index in the table
+					foreach($tableindices as $tableindex) {
+						// Add the index to the index data array
+						$keyname = $tableindex-&gt;Key_name;
+						$index_ary[$keyname]['columns'][] = array('fieldname' =&gt; $tableindex-&gt;Column_name, 'subpart' =&gt; $tableindex-&gt;Sub_part);
+						$index_ary[$keyname]['unique'] = ($tableindex-&gt;Non_unique == 0)?true:false;
+					}
+
+					// For each actual index in the index array
+					foreach($index_ary as $index_name =&gt; $index_data) {
+						// Build a create string to compare to the query
+						$index_string = '';
+						if($index_name == 'PRIMARY') {
+							$index_string .= 'PRIMARY ';
+						}
+						else if($index_data['unique']) {
+							$index_string .= 'UNIQUE ';
+						}
+						$index_string .= 'KEY ';
+						if($index_name != 'PRIMARY') {
+							$index_string .= $index_name;
+						}
+						$index_columns = '';
+						// For each column in the index
+						foreach($index_data['columns'] as $column_data) {					
+							if($index_columns != '') $index_columns .= ',';
+							// Add the field to the column list string
+							$index_columns .= $column_data['fieldname'];
+							if($column_data['subpart'] != '') {
+								$index_columns .= '('.$column_data['subpart'].')';
+							}
+						}
+						// Add the column list to the index create string 
+						$index_string .= ' ('.$index_columns.')';
+
+						if(!(($aindex = array_search($index_string, $indices)) === false)) {
+							unset($indices[$aindex]);
+							//echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;{$table}:&lt;br/&gt;Found index:&quot;.$index_string.&quot;&lt;/pre&gt;\n&quot;;
+						}
+						//else echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;{$table}:&lt;br/&gt;&lt;b&gt;Did not find index:&lt;/b&gt;&quot;.$index_string.&quot;&lt;br/&gt;&quot;.print_r($indices, true).&quot;&lt;/pre&gt;\n&quot;;
+					}
+				}
+
+				// For every remaining index specified for the table
+				foreach($indices as $index) {
+					// Push a query line into $cqueries that adds the index to that table
+					$cqueries[] = &quot;ALTER TABLE {$table} ADD $index&quot;;
+					$for_update[$table.'.'.$fieldname] = 'Added index '.$table.' '.$index;
+				}
+
+				// Remove the original table creation query from processing
+				unset($cqueries[strtolower($table)]);
+				unset($for_update[strtolower($table)]);
+			} else {
+				// This table exists in the database, but not in the creation queries?
+			}
+		}
+	}
+
+	$allqueries = array_merge($cqueries, $iqueries);
+	if($execute) {
+		foreach($allqueries as $query) {
+			//echo &quot;&lt;pre style=\&quot;border:1px solid #ccc;margin-top:5px;\&quot;&gt;&quot;.print_r($query, true).&quot;&lt;/pre&gt;\n&quot;;
+			$wpdb-&gt;query($query);
+		}
+	}
+
+	return $for_update;
+}
+
+function make_db_current() {
+	global $wp_queries;
+
+	$alterations = dbDelta($wp_queries);
+	echo &quot;&lt;ol&gt;\n&quot;;
+	foreach($alterations as $alteration) echo &quot;&lt;li&gt;$alteration&lt;/li&gt;\n&quot;;
+	echo &quot;&lt;/ol&gt;\n&quot;;
+}
+
+function make_db_current_silent() {
+	global $wp_queries;
+
+	$alterations = dbDelta($wp_queries);
+}
+
+function make_site_theme_from_oldschool($theme_name, $template) {
+	$home_path = get_home_path();
+	$site_dir = ABSPATH . &quot;wp-content/themes/$template&quot;;
+
+	if (! file_exists(&quot;$home_path/index.php&quot;))
+		return false;
+
+	// Copy files from the old locations to the site theme.
+	// TODO: This does not copy arbitarary include dependencies.  Only the
+	// standard WP files are copied.
+	$files = array('index.php' =&gt; 'index.php', 'wp-layout.css' =&gt; 'style.css', 'wp-comments.php' =&gt; 'comments.php', 'wp-comments-popup.php' =&gt; 'comments-popup.php');
+
+	foreach ($files as $oldfile =&gt; $newfile) {
+		if ($oldfile == 'index.php')
+			$oldpath = $home_path;
+		else
+			$oldpath = ABSPATH;
+
+		if ($oldfile == 'index.php') { // Check to make sure it's not a new index
+			$index = implode('', file(&quot;$oldpath/$oldfile&quot;));
+			if ( strstr( $index, 'WP_USE_THEMES' ) ) {
+				if (! @copy(ABSPATH . 'wp-content/themes/default/index.php', &quot;$site_dir/$newfile&quot;))
+					return false;
+				continue; // Don't copy anything
+				}
+		}
+
+		if (! @copy(&quot;$oldpath/$oldfile&quot;, &quot;$site_dir/$newfile&quot;))
+			return false;
+
+		chmod(&quot;$site_dir/$newfile&quot;, 0777);
+
+		// Update the blog header include in each file.
+		$lines = explode(&quot;\n&quot;, implode('', file(&quot;$site_dir/$newfile&quot;)));
+		if ($lines) {
+			$f = fopen(&quot;$site_dir/$newfile&quot;, 'w');
+
+			foreach ($lines as $line) {
+				if (preg_match('/require.*wp-blog-header/', $line))
+					$line = '//' . $line;
+
+				// Update stylesheet references.
+				$line = str_replace(&quot;&lt;?php echo __get_option('siteurl'); ?&gt;/wp-layout.css&quot;, &quot;&lt;?php bloginfo('stylesheet_url'); ?&gt;&quot;, $line);
+
+				// Update comments template inclusion.
+				$line = str_replace(&quot;&lt;?php include(ABSPATH . 'wp-comments.php'); ?&gt;&quot;, &quot;&lt;?php comments_template(); ?&gt;&quot;, $line);
+
+				fwrite($f, &quot;{$line}\n&quot;);
+			}
+			fclose($f);
+		}
+	}
+
+	// Add a theme header.
+	$header = &quot;/*\nTheme Name: $theme_name\nTheme URI: &quot; . __get_option('siteurl') . &quot;\nDescription: A theme automatically created by the upgrade.\nVersion: 1.0\nAuthor: Moi\n*/\n&quot;;
+
+	$stylelines = file_get_contents(&quot;$site_dir/style.css&quot;);
+	if ($stylelines) {
+		$f = fopen(&quot;$site_dir/style.css&quot;, 'w');
+
+		fwrite($f, $header);
+		fwrite($f, $stylelines);
+		fclose($f);
+	}
+
+	return true;
+}
+
+function make_site_theme_from_default($theme_name, $template) {
+	$site_dir = ABSPATH . &quot;wp-content/themes/$template&quot;;
+	$default_dir = ABSPATH . 'wp-content/themes/default';
+
+	// Copy files from the default theme to the site theme.
+	//$files = array('index.php', 'comments.php', 'comments-popup.php', 'footer.php', 'header.php', 'sidebar.php', 'style.css');
+
+	$theme_dir = @ dir(&quot;$default_dir&quot;);
+	if ($theme_dir) {
+		while(($theme_file = $theme_dir-&gt;read()) !== false) {
+			if (is_dir(&quot;$default_dir/$theme_file&quot;))
+				continue;
+			if (! @copy(&quot;$default_dir/$theme_file&quot;, &quot;$site_dir/$theme_file&quot;))
+				return;
+			chmod(&quot;$site_dir/$theme_file&quot;, 0777);
+		}
+	}
+
+	// Rewrite the theme header.
+	$stylelines = explode(&quot;\n&quot;, implode('', file(&quot;$site_dir/style.css&quot;)));
+	if ($stylelines) {
+		$f = fopen(&quot;$site_dir/style.css&quot;, 'w');
+
+		foreach ($stylelines as $line) {
+			if (strstr($line, &quot;Theme Name:&quot;)) $line = &quot;Theme Name: $theme_name&quot;;
+			elseif (strstr($line, &quot;Theme URI:&quot;)) $line = &quot;Theme URI: &quot; . __get_option('siteurl');
+			elseif (strstr($line, &quot;Description:&quot;)) $line = &quot;Description: Your theme&quot;;
+			elseif (strstr($line, &quot;Version:&quot;)) $line = &quot;Version: 1&quot;;
+			elseif (strstr($line, &quot;Author:&quot;)) $line = &quot;Author: You&quot;;
+			fwrite($f, &quot;{$line}\n&quot;);
+		}
+		fclose($f);
+	}
+
+	// Copy the images.
+	umask(0);
+	if (! mkdir(&quot;$site_dir/images&quot;, 0777)) {
+		return false;
+	}
+
+	$images_dir = @ dir(&quot;$default_dir/images&quot;);
+	if ($images_dir) {
+		while(($image = $images_dir-&gt;read()) !== false) {
+			if (is_dir(&quot;$default_dir/images/$image&quot;))
+				continue;
+			if (! @copy(&quot;$default_dir/images/$image&quot;, &quot;$site_dir/images/$image&quot;))
+				return;
+			chmod(&quot;$site_dir/images/$image&quot;, 0777);
+		}
+	}
+}
+
+// Create a site theme from the default theme.
+function make_site_theme() {
+	// Name the theme after the blog.
+	$theme_name = __get_option('blogname');
+	$template = sanitize_title($theme_name);
+	$site_dir = ABSPATH . &quot;wp-content/themes/$template&quot;;
+
+	// If the theme already exists, nothing to do.
+	if ( is_dir($site_dir)) {
+		return false;
+	}
+
+	// We must be able to write to the themes dir.
+	if (! is_writable(ABSPATH . &quot;wp-content/themes&quot;)) {
+		return false;
+	}
+
+	umask(0);
+	if (! mkdir($site_dir, 0777)) {
+		return false;
+	}
+
+	if (file_exists(ABSPATH . 'wp-layout.css')) {
+		if (! make_site_theme_from_oldschool($theme_name, $template)) {
+			// TODO:  rm -rf the site theme directory.
+			return false;
+		}
+	} else {
+		if (! make_site_theme_from_default($theme_name, $template))
+			// TODO:  rm -rf the site theme directory.
+			return false;
+	}
+
+	// Make the new site theme active.
+	$current_template = __get_option('template');
+	if ($current_template == 'default') {
+		update_option('template', $template);
+		update_option('stylesheet', $template);
+	}
+	return $template;
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/upgrade-schema.php
===================================================================
--- trunk/wp-admin/upgrade-schema.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/upgrade-schema.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,234 @@
+&lt;?php
+// Here we keep the DB structure and option values
+
+$wp_queries=&quot;CREATE TABLE $wpdb-&gt;categories (
+  cat_ID bigint(20) NOT NULL auto_increment,
+  cat_name varchar(55) NOT NULL default '',
+  category_nicename varchar(200) NOT NULL default '',
+  category_description longtext NOT NULL,
+  category_parent int(4) NOT NULL default '0',
+  PRIMARY KEY  (cat_ID),
+  KEY category_nicename (category_nicename)
+);
+CREATE TABLE $wpdb-&gt;comments (
+  comment_ID bigint(20) unsigned NOT NULL auto_increment,
+  comment_post_ID int(11) NOT NULL default '0',
+  comment_author tinytext NOT NULL,
+  comment_author_email varchar(100) NOT NULL default '',
+  comment_author_url varchar(200) NOT NULL default '',
+  comment_author_IP varchar(100) NOT NULL default '',
+  comment_date datetime NOT NULL default '0000-00-00 00:00:00',
+  comment_date_gmt datetime NOT NULL default '0000-00-00 00:00:00',
+  comment_content text NOT NULL,
+  comment_karma int(11) NOT NULL default '0',
+  comment_approved enum('0','1','spam') NOT NULL default '1',
+  comment_agent varchar(255) NOT NULL default '',
+  comment_type varchar(20) NOT NULL default '',
+  comment_parent int(11) NOT NULL default '0',
+  user_id int(11) NOT NULL default '0',
+  PRIMARY KEY  (comment_ID),
+  KEY comment_approved (comment_approved),
+  KEY comment_post_ID (comment_post_ID)
+);
+CREATE TABLE $wpdb-&gt;linkcategories (
+  cat_id bigint(20) NOT NULL auto_increment,
+  cat_name tinytext NOT NULL,
+  auto_toggle enum('Y','N') NOT NULL default 'N',
+  show_images enum('Y','N') NOT NULL default 'Y',
+  show_description enum('Y','N') NOT NULL default 'N',
+  show_rating enum('Y','N') NOT NULL default 'Y',
+  show_updated enum('Y','N') NOT NULL default 'Y',
+  sort_order varchar(64) NOT NULL default 'rand',
+  sort_desc enum('Y','N') NOT NULL default 'N',
+  text_before_link varchar(128) NOT NULL default '&lt;li&gt;',
+  text_after_link varchar(128) NOT NULL default '&lt;br /&gt;',
+  text_after_all varchar(128) NOT NULL default '&lt;/li&gt;',
+  list_limit int(11) NOT NULL default '-1',
+  PRIMARY KEY  (cat_id)
+);
+CREATE TABLE $wpdb-&gt;links (
+  link_id bigint(20) NOT NULL auto_increment,
+  link_url varchar(255) NOT NULL default '',
+  link_name varchar(255) NOT NULL default '',
+  link_image varchar(255) NOT NULL default '',
+  link_target varchar(25) NOT NULL default '',
+  link_category int(11) NOT NULL default '0',
+  link_description varchar(255) NOT NULL default '',
+  link_visible enum('Y','N') NOT NULL default 'Y',
+  link_owner int(11) NOT NULL default '1',
+  link_rating int(11) NOT NULL default '0',
+  link_updated datetime NOT NULL default '0000-00-00 00:00:00',
+  link_rel varchar(255) NOT NULL default '',
+  link_notes mediumtext NOT NULL,
+  link_rss varchar(255) NOT NULL default '',
+  PRIMARY KEY  (link_id),
+  KEY link_category (link_category),
+  KEY link_visible (link_visible)
+);
+CREATE TABLE $wpdb-&gt;options (
+  option_id bigint(20) NOT NULL auto_increment,
+  blog_id int(11) NOT NULL default '0',
+  option_name varchar(64) NOT NULL default '',
+  option_can_override enum('Y','N') NOT NULL default 'Y',
+  option_type int(11) NOT NULL default '1',
+  option_value longtext NOT NULL,
+  option_width int(11) NOT NULL default '20',
+  option_height int(11) NOT NULL default '8',
+  option_description tinytext NOT NULL,
+  option_admin_level int(11) NOT NULL default '1',
+  autoload enum('yes','no') NOT NULL default 'yes',
+  PRIMARY KEY  (option_id,blog_id,option_name),
+  KEY option_name (option_name)
+);
+CREATE TABLE $wpdb-&gt;post2cat (
+  rel_id bigint(20) NOT NULL auto_increment,
+  post_id bigint(20) NOT NULL default '0',
+  category_id bigint(20) NOT NULL default '0',
+  PRIMARY KEY  (rel_id),
+  KEY post_id (post_id,category_id)
+);
+CREATE TABLE $wpdb-&gt;postmeta (
+  meta_id bigint(20) NOT NULL auto_increment,
+  post_id bigint(20) NOT NULL default '0',
+  meta_key varchar(255) default NULL,
+  meta_value text,
+  PRIMARY KEY  (meta_id),
+  KEY post_id (post_id),
+  KEY meta_key (meta_key)
+);
+CREATE TABLE $wpdb-&gt;posts (
+  ID bigint(20) unsigned NOT NULL auto_increment,
+  post_author int(4) NOT NULL default '0',
+  post_date datetime NOT NULL default '0000-00-00 00:00:00',
+  post_date_gmt datetime NOT NULL default '0000-00-00 00:00:00',
+  post_content longtext NOT NULL,
+  post_title text NOT NULL,
+  post_category int(4) NOT NULL default '0',
+  post_excerpt text NOT NULL,
+  post_status enum('publish','draft','private','static','object') NOT NULL default 'publish',
+  comment_status enum('open','closed','registered_only') NOT NULL default 'open',
+  ping_status enum('open','closed') NOT NULL default 'open',
+  post_password varchar(20) NOT NULL default '',
+  post_name varchar(200) NOT NULL default '',
+  to_ping text NOT NULL,
+  pinged text NOT NULL,
+  post_modified datetime NOT NULL default '0000-00-00 00:00:00',
+  post_modified_gmt datetime NOT NULL default '0000-00-00 00:00:00',
+  post_content_filtered text NOT NULL,
+  post_parent int(11) NOT NULL default '0',
+  guid varchar(255) NOT NULL default '',
+  menu_order int(11) NOT NULL default '0',
+  PRIMARY KEY  (ID),
+  KEY post_name (post_name)
+);
+CREATE TABLE $wpdb-&gt;users (
+  ID bigint(20) unsigned NOT NULL auto_increment,
+  user_login varchar(60) NOT NULL default '',
+  user_pass varchar(64) NOT NULL default '',
+  user_firstname varchar(50) NOT NULL default '',
+  user_lastname varchar(50) NOT NULL default '',
+  user_nickname varchar(50) NOT NULL default '',
+  user_nicename varchar(50) NOT NULL default '',
+  user_icq int(10) unsigned NOT NULL default '0',
+  user_email varchar(100) NOT NULL default '',
+  user_url varchar(100) NOT NULL default '',
+  user_ip varchar(15) NOT NULL default '',
+  user_domain varchar(200) NOT NULL default '',
+  user_browser varchar(200) NOT NULL default '',
+  user_registered datetime NOT NULL default '0000-00-00 00:00:00',
+  user_level int(2) unsigned NOT NULL default '0',
+  user_aim varchar(50) NOT NULL default '',
+  user_msn varchar(100) NOT NULL default '',
+  user_yim varchar(50) NOT NULL default '',
+  user_idmode varchar(20) NOT NULL default '',
+  user_activation_key varchar(60) NOT NULL default '',
+  user_status int(11) NOT NULL default '0',
+  user_description longtext NOT NULL default '',
+  PRIMARY KEY  (ID),
+  UNIQUE KEY user_login (user_login)
+);&quot;;
+
+function populate_options() {
+	global $wpdb;
+
+	$guessurl = preg_replace('|/wp-admin/.*|i', '', '<A HREF="http://">http://</A>' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']);
+	add_option('siteurl', $guessurl, __('WordPress web address'));
+	add_option('blogname', __('My Weblog'), __('Blog title'));
+	add_option('blogdescription', __('Just another WordPress weblog'), __('Short tagline'));
+	add_option('new_users_can_blog', 0);
+	add_option('users_can_register', 0);
+	add_option('admin_email', '<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">you at example.com</A>');
+	add_option('start_of_week', 1);
+	add_option('use_balanceTags', 1);
+	add_option('use_smilies', 1);
+	add_option('require_name_email', 1);
+	add_option('comments_notify', 1);
+	add_option('posts_per_rss', 10);
+	add_option('rss_excerpt_length', 50);
+	add_option('rss_use_excerpt', 0);
+	add_option('use_fileupload', 0);
+	add_option('fileupload_realpath', ABSPATH . 'wp-content');
+	add_option('fileupload_url', get_option('siteurl') . '/wp-content');
+	add_option('fileupload_allowedtypes', 'jpg jpeg gif png');
+	add_option('fileupload_maxk', 300);
+	add_option('fileupload_minlevel', 6);
+	add_option('mailserver_url', 'mail.example.com');
+	add_option('mailserver_login', '<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">login at example.com</A>');
+	add_option('mailserver_pass', 'password');
+	add_option('mailserver_port', 110);
+	add_option('default_category', 1);
+	add_option('default_comment_status', 'open');
+	add_option('default_ping_status', 'open');
+	add_option('default_pingback_flag', 1);
+	add_option('default_post_edit_rows', 9);
+	add_option('posts_per_page', 10);
+	add_option('what_to_show', 'posts');
+	add_option('date_format', __('F j, Y'));
+	add_option('time_format', __('g:i a'));
+	add_option('links_updated_date_format', __('F j, Y g:i a'));
+	add_option('links_recently_updated_prepend', '&lt;em&gt;');
+	add_option('links_recently_updated_append', '&lt;/em&gt;');
+	add_option('links_recently_updated_time', 120);
+	add_option('comment_moderation', 0);
+	add_option('moderation_notify', 1);
+	add_option('permalink_structure');
+	add_option('gzipcompression', 0);
+	add_option('hack_file', 0);
+	add_option('blog_charset', 'UTF-8');
+	add_option('moderation_keys');
+	add_option('active_plugins');
+	add_option('home');
+	add_option('category_base');
+	add_option('ping_sites', '<A HREF="http://rpc.pingomatic.com/">http://rpc.pingomatic.com/</A>');
+	add_option('advanced_edit', 0);
+	add_option('comment_max_links', 2);
+	// 1.5
+	add_option('default_email_category', 1, __('Posts by email go to this category'));
+	add_option('recently_edited');
+	add_option('use_linksupdate', 0);
+	add_option('template', 'default');
+	add_option('stylesheet', 'default');
+	add_option('comment_whitelist', 1);
+	add_option('page_uris');
+	add_option('blacklist_keys');
+	add_option('comment_registration', 0);
+	add_option('open_proxy_check', 1);
+	add_option('rss_language', 'en');
+	add_option('html_type', 'text/html');
+	// 1.5.1
+	add_option('use_trackback', 0);
+
+	// Delete unused options
+	$unusedoptions = array ('blodotgsping_url', 'bodyterminator', 'emailtestonly', 'phoneemail_separator', 'smilies_directory', 'subjectprefix', 'use_bbcode', 'use_blodotgsping', 'use_phoneemail', 'use_quicktags', 'use_weblogsping', 'weblogs_cache_file', 'use_preview', 'use_htmltrans', 'smilies_directory', 'fileupload_allowedusers', 'use_phoneemail', 'default_post_status', 'default_post_category', 'archive_mode', 'time_difference', 'links_minadminlevel', 'links_use_adminlevels', 'links_rating_type', 'links_rating_char', 'links_rating_ignore_zero', 'links_rating_single_image', 'links_rating_image0', 'links_rating_image1', 'links_rating_image2', 'links_rating_image3', 'links_rating_image4', 'links_rating_image5', 'links_rating_image6', 'links_rating_image7', 'links_rating_image8', 'links_rating_image9', 'weblogs_cacheminutes', 'comment_allowed_tags', 'search_engine_friendly_urls', 'default_geourl_lat', 'default_geourl_lon', 'use_default_geourl', 'weblogs_xml_url');
+	foreach ($unusedoptions as $option) :
+		delete_option($option);
+	endforeach;
+
+	// Set up a few options not to load by default
+	$fatoptions = array( 'moderation_keys', 'recently_edited', 'blacklist_keys' );
+	foreach ($fatoptions as $fatoption) :
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET `autoload` = 'no' WHERE option_name = '$fatoption'&quot;);
+	endforeach;
+}
+
+?&gt;

Added: trunk/wp-admin/upgrade.php
===================================================================
--- trunk/wp-admin/upgrade.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/upgrade.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,95 @@
+&lt;?php
+define('WP_INSTALLING', true);
+if (!file_exists('../wp-config.php')) die(&quot;There doesn't seem to be a wp-config.php file. Double check that you updated wp-config-sample.php with the proper database connection information and renamed it to wp-config.php.&quot;);
+require('../wp-config.php');
+timer_start();
+require_once(ABSPATH . '/wp-admin/upgrade-functions.php');
+
+$step = $_GET['step'];
+if (!$step) $step = 0;
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;WordPress &rsaquo; Upgrade&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+	&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+	&lt;!--
+	html {
+		background: #eee;
+	}
+	body {
+		background: #fff;
+		color: #000;
+		font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+		margin-left: 20%;
+		margin-right: 20%;
+		padding: .2em 2em;
+	}
+	
+	h1 {
+		color: #006;
+		font-size: 18px;
+		font-weight: lighter;
+	}
+	
+	h2 {
+		font-size: 16px;
+	}
+	
+	p, li, dt {
+		line-height: 140%;
+		padding-bottom: 2px;
+	}
+
+	ul, ol {
+		padding: 5px 5px 5px 20px;
+	}
+	#logo {
+		margin-bottom: 2em;
+	}
+.step a, .step input {
+	font-size: 2em;
+}
+.step, th {
+	text-align: right;
+}
+#footer {
+text-align: center; border-top: 1px solid #ccc; padding-top: 1em; font-style: italic;
+}
+	--&gt;
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;h1 id=&quot;logo&quot;&gt;&lt;img alt=&quot;WordPress&quot; src=&quot;<A HREF="http://static.wordpress.org/logo.png">http://static.wordpress.org/logo.png</A>&quot; /&gt;&lt;/h1&gt;
+&lt;?php
+switch($step) {
+
+	case 0:
+?&gt; 
+&lt;p&gt;&lt;?php _e('This file upgrades you from any previous version of WordPress to the latest. It may take a while though, so be patient.'); ?&gt;&lt;/p&gt; 
+	&lt;h2 class=&quot;step&quot;&gt;&lt;a href=&quot;upgrade.php?step=1&quot;&gt;&lt;?php _e('Upgrade WordPress &raquo;'); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+&lt;?php
+	break;
+	
+	case 1:
+	make_db_current_silent();
+	upgrade_all();
+?&gt; 
+&lt;h2&gt;&lt;?php _e('Step 1'); ?&gt;&lt;/h2&gt; 
+	&lt;p&gt;&lt;?php printf(__(&quot;There's actually only one step. So if you see this, you're done. &lt;a href='%s'&gt;Have fun&lt;/a&gt;!&quot;), '../'); ?&gt;&lt;/p&gt;
+
+&lt;!--
+&lt;pre&gt;
+&lt;?php printf(__('%s queries'), $wpdb-&gt;num_queries); ?&gt;
+
+&lt;?php printf(__('%s seconds'), timer_stop(0)); ?&gt;
+&lt;/pre&gt;
+--&gt;
+
+&lt;?php
+	break;
+}
+?&gt; 
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-admin/upload.php
===================================================================
--- trunk/wp-admin/upload.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/upload.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,230 @@
+&lt;?php
+require_once('admin.php');
+
+$title = 'Upload Image or File';
+
+require_once('admin-header.php');
+
+if ($user_level == 0) //Checks to see if user has logged in
+	die (__(&quot;Cheatin' uh ?&quot;));
+
+if (!get_settings('use_fileupload')) //Checks if file upload is enabled in the config
+	die (__(&quot;The admin disabled this function&quot;));
+
+if ( !get_settings('fileupload_minlevel') )
+	die (__(&quot;You are not allowed to upload files&quot;));
+
+$allowed_types = explode(' ', trim(strtolower(get_settings('fileupload_allowedtypes'))));
+
+if ($_POST['submit']) {
+	$action = 'upload';
+} else {
+	$action = '';
+}
+
+if (!is_writable(get_settings('fileupload_realpath')))
+	$action = 'not-writable';
+?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+
+&lt;?php
+switch ($action) {
+case 'not-writable':
+?&gt;
+&lt;p&gt;&lt;?php printf(__(&quot;It doesn't look like you can use the file upload feature at this time because the directory you have specified (&lt;code&gt;%s&lt;/code&gt;) doesn't appear to be writable by WordPress. Check the permissions on the directory and for typos.&quot;), get_settings('fileupload_realpath')) ?&gt;&lt;/p&gt;
+
+&lt;?php
+break;
+case '':
+	foreach ($allowed_types as $type) {
+		$type_tags[] = &quot;&lt;code&gt;$type&lt;/code&gt;&quot;;
+	}
+	$i = implode(', ', $type_tags);
+?&gt;
+&lt;p&gt;&lt;?php printf(__('You can upload files with the extension %1$s as long as they are no larger than %2$s &lt;abbr title=&quot;Kilobytes&quot;&gt;KB&lt;/abbr&gt;. If you&#8217;re an admin you can configure these values under &lt;a href=&quot;%3$s&quot;&gt;options&lt;/a&gt;.'), $i, get_settings('fileupload_maxk'), 'options-misc.php') ?&gt;&lt;/p&gt;
+    &lt;form action=&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
+    &lt;p&gt;
+      &lt;label for=&quot;img1&quot;&gt;&lt;?php _e('File:') ?&gt;&lt;/label&gt;
+      &lt;br /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;&lt;?php echo get_settings('fileupload_maxk') * 1024 ?&gt;&quot; /&gt;
+    &lt;input type=&quot;file&quot; name=&quot;img1&quot; id=&quot;img1&quot; size=&quot;35&quot; class=&quot;uploadform&quot; /&gt;&lt;/p&gt;
+    &lt;p&gt;
+    &lt;label for=&quot;imgdesc&quot;&gt;&lt;?php _e('Description:') ?&gt;&lt;/label&gt;&lt;br /&gt;
+    &lt;input type=&quot;text&quot; name=&quot;imgdesc&quot; id=&quot;imgdesc&quot; size=&quot;30&quot; class=&quot;uploadform&quot; /&gt;
+    &lt;/p&gt;
+	
+    &lt;p&gt;&lt;?php _e('Create a thumbnail?') ?&gt;&lt;/p&gt;
+    &lt;p&gt;
+    &lt;label for=&quot;thumbsize_no&quot;&gt;
+    &lt;input type=&quot;radio&quot; name=&quot;thumbsize&quot; value=&quot;none&quot; checked=&quot;checked&quot; id=&quot;thumbsize_no&quot; /&gt;
+    &lt;?php _e('No thanks') ?&gt;&lt;/label&gt;
+    &lt;br /&gt;
+        &lt;label for=&quot;thumbsize_small&quot;&gt;
+&lt;input type=&quot;radio&quot; name=&quot;thumbsize&quot; value=&quot;small&quot; id=&quot;thumbsize_small&quot; /&gt;
+&lt;?php _e('Small (200px largest side)') ?&gt;&lt;/label&gt;
+        &lt;br /&gt;
+        &lt;label for=&quot;thumbsize_large&quot;&gt;
+&lt;input type=&quot;radio&quot; name=&quot;thumbsize&quot; value=&quot;large&quot; id=&quot;thumbsize_large&quot; /&gt;
+&lt;?php _e('Large (400px largest side)') ?&gt;&lt;/label&gt;
+        &lt;br /&gt;
+        &lt;label for=&quot;thumbsize_custom&quot;&gt;
+        &lt;input type=&quot;radio&quot; name=&quot;thumbsize&quot; value=&quot;custom&quot; id=&quot;thumbsize_custom&quot; /&gt;
+&lt;?php _e('Custom size') ?&gt;&lt;/label&gt;
+      : 
+      &lt;input type=&quot;text&quot; name=&quot;imgthumbsizecustom&quot; size=&quot;4&quot; /&gt;
+    &lt;?php _e('px (largest side)') ?&gt;    &lt;/p&gt;
+	&lt;p&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Upload File') ?&gt;&quot; /&gt;&lt;/p&gt;
+    &lt;/form&gt;
+&lt;/div&gt;&lt;?php 
+break;
+case 'upload':
+
+	$imgalt = basename( (isset($_POST['imgalt'])) ? $_POST['imgalt'] : '' );
+
+	$img1_name = (strlen($imgalt)) ? $imgalt : basename( $_FILES['img1']['name'] );
+	$img1_name = preg_replace('/[^a-z0-9_.]/i', '', $img1_name); 
+	$img1_size = $_POST['img1_size'] ? intval($_POST['img1_size']) : intval($_FILES['img1']['size']);
+
+	$img1_type = (strlen($imgalt)) ? $_POST['img1_type'] : $_FILES['img1']['type'];
+	$imgdesc = htmlentities2($_POST['imgdesc']);
+
+	$pi = pathinfo($img1_name);
+	$imgtype = strtolower($pi['extension']);
+
+	if (in_array($imgtype, $allowed_types) == false)
+		die(sprintf(__('File %1$s of type %2$s is not allowed.') , $img1_name, $imgtype));
+
+    if (strlen($imgalt)) {
+        $pathtofile = get_settings('fileupload_realpath').&quot;/&quot;.$imgalt;
+        $img1 = $_POST['img1'];
+    } else {
+        $pathtofile = get_settings('fileupload_realpath').&quot;/&quot;.$img1_name;
+        $img1 = $_FILES['img1']['tmp_name'];
+    }
+
+    // makes sure not to upload duplicates, rename duplicates
+    $i = 1;
+    $pathtofile2 = $pathtofile;
+    $tmppathtofile = $pathtofile2;
+    $img2_name = $img1_name;
+
+    while ( file_exists($pathtofile2) ) {
+        $pos = strpos( strtolower($tmppathtofile), '.' . trim($imgtype) );
+        $pathtofile_start = substr($tmppathtofile, 0, $pos);
+        $pathtofile2 = $pathtofile_start.'_'.zeroise($i++, 2).'.'.trim($imgtype);
+        $img2_name = explode('/', $pathtofile2);
+        $img2_name = $img2_name[count($img2_name)-1];
+    }
+
+    if (file_exists($pathtofile) &amp;&amp; !strlen($imgalt)) {
+        $i = explode(' ', get_settings('fileupload_allowedtypes'));
+        $i = implode(', ',array_slice($i, 1, count($i)-2));
+        $moved = move_uploaded_file($img1, $pathtofile2);
+        // if move_uploaded_file() fails, try copy()
+        if (!$moved) {
+            $moved = copy($img1, $pathtofile2);
+        }
+        if (!$moved) {
+            die(sprintf(__(&quot;Couldn't upload your file to %s.&quot;), $pathtofile2));
+        } else {
+			chmod($pathtofile2, 0666);
+            @unlink($img1);
+        }
+
+	// 
+    
+    // duplicate-renaming function contributed by Gary Lawrence Murphy
+    ?&gt;
+    &lt;p&gt;&lt;strong&gt;&lt;?php __('Duplicate File?') ?&gt;&lt;/strong&gt;&lt;/p&gt;
+    &lt;p&gt;&lt;b&gt;&lt;em&gt;&lt;?php printf(__(&quot;The filename '%s' already exists!&quot;), $img1_name); ?&gt;&lt;/em&gt;&lt;/b&gt;&lt;/p&gt;
+    &lt;p&gt; &lt;?php printf(__(&quot;Filename '%1\$s' moved to '%2\$s'&quot;), $img1, &quot;$pathtofile2 - $img2_name&quot;) ?&gt;&lt;/p&gt;
+    &lt;p&gt;&lt;?php _e('Confirm or rename:') ?&gt;&lt;/p&gt;
+    &lt;form action=&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;&lt;?php echo  get_settings('fileupload_maxk') *1024 ?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;img1_type&quot; value=&quot;&lt;?php echo $img1_type;?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;img1_name&quot; value=&quot;&lt;?php echo $img2_name;?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;img1_size&quot; value=&quot;&lt;?php echo $img1_size;?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;img1&quot; value=&quot;&lt;?php echo $pathtofile2;?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;thumbsize&quot; value=&quot;&lt;?php echo $_REQUEST['thumbsize'];?&gt;&quot; /&gt;
+    &lt;input type=&quot;hidden&quot; name=&quot;imgthumbsizecustom&quot; value=&quot;&lt;?php echo $_REQUEST['imgthumbsizecustom'];?&gt;&quot; /&gt;
+    &lt;?php _e('Alternate name:') ?&gt;&lt;br /&gt;&lt;input type=&quot;text&quot; name=&quot;imgalt&quot; size=&quot;30&quot; class=&quot;uploadform&quot; value=&quot;&lt;?php echo $img2_name;?&gt;&quot; /&gt;&lt;br /&gt;
+    &lt;br /&gt;
+    &lt;?php _e('Description:') ?&gt;&lt;br /&gt;&lt;input type=&quot;text&quot; name=&quot;imgdesc&quot; size=&quot;30&quot; class=&quot;uploadform&quot; value=&quot;&lt;?php echo $imgdesc;?&gt;&quot; /&gt;
+    &lt;br /&gt;
+    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php _e('Rename') ?&gt;&quot; class=&quot;search&quot; /&gt;
+    &lt;/form&gt;
+&lt;/div&gt;
+&lt;?php 
+
+require('admin-footer.php');
+die();
+
+    }
+
+    if (!strlen($imgalt)) {
+        @$moved = move_uploaded_file($img1, $pathtofile); //Path to your images directory, chmod the dir to 777
+        // move_uploaded_file() can fail if open_basedir in PHP.INI doesn't
+        // include your tmp directory. Try copy instead?
+        if(!$moved) {
+            $moved = copy($img1, $pathtofile);
+        }
+        // Still couldn't get it. Give up.
+        if (!$moved) {
+            die(sprintf(__(&quot;Couldn't upload your file to %s.&quot;), $pathtofile));
+        } else {
+			chmod($pathtofile, 0666);
+            @unlink($img1);
+        }
+        
+    } else {
+        rename($img1, $pathtofile)
+        or die(sprintf(__(&quot;Couldn't upload your file to %s.&quot;), $pathtofile));
+    }
+    
+    if($_POST['thumbsize'] != 'none' ) {
+        if($_POST['thumbsize'] == 'small') {
+            $max_side = 200;
+        }
+        elseif($_POST['thumbsize'] == 'large') {
+            $max_side = 400;
+        }
+        elseif($_POST['thumbsize'] == 'custom') {
+            $max_side = intval($_POST['imgthumbsizecustom']);
+        }
+        
+        $result = wp_create_thumbnail($pathtofile, $max_side, NULL);
+        if($result != 1) {
+            print $result;
+        }
+    }
+
+if ( ereg('image/',$img1_type) )
+	$piece_of_code = &quot;&lt;img src='&quot; . get_settings('fileupload_url') .&quot;/$img1_name' alt='$imgdesc' /&gt;&quot;;
+else
+	$piece_of_code = &quot;&lt;a href='&quot;. get_settings('fileupload_url') . &quot;/$img1_name' title='$imgdesc'&gt;$imgdesc&lt;/a&gt;&quot;;
+
+$piece_of_code = htmlspecialchars( $piece_of_code );
+?&gt;
+
+&lt;h3&gt;&lt;?php _e('File uploaded!') ?&gt;&lt;/h3&gt;
+&lt;p&gt;&lt;?php printf(__(&quot;Your file &lt;code&gt;%s&lt;/code&gt; was uploaded successfully!&quot;), $img1_name); ?&gt;&lt;/p&gt;
+&lt;p&gt;&lt;?php _e('Here&#8217;s the code to display it:') ?&gt;&lt;/p&gt;
+&lt;p&gt;&lt;code&gt;&lt;?php echo $piece_of_code; ?&gt;&lt;/code&gt;
+&lt;/p&gt;
+&lt;p&gt;&lt;strong&gt;&lt;?php _e('Image Details') ?&gt;&lt;/strong&gt;: &lt;br /&gt;
+&lt;?php _e('Name:'); ?&gt;
+&lt;?php echo $img1_name; ?&gt;
+&lt;br /&gt;
+&lt;?php _e('Size:') ?&gt;
+&lt;?php echo round($img1_size / 1024, 2); ?&gt; &lt;?php _e('&lt;abbr title=&quot;Kilobyte&quot;&gt;KB&lt;/abbr&gt;') ?&gt;&lt;br /&gt;
+&lt;?php _e('Type:') ?&gt;
+&lt;?php echo $img1_type; ?&gt;
+&lt;/p&gt;
+&lt;/div&gt;
+&lt;p&gt;&lt;a href=&quot;upload.php&quot;&gt;&lt;?php _e('Upload another') ?&gt;&lt;/a&gt;&lt;/p&gt;
+&lt;?php
+break;
+}
+include('admin-footer.php');
+?&gt;
\ No newline at end of file

Added: trunk/wp-admin/user-edit.php
===================================================================
--- trunk/wp-admin/user-edit.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/user-edit.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,212 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Edit User');
+$parent_file = 'profile.php';	
+$submenu_file = 'users.php';
+
+$wpvarstoreset = array('action', 'redirect', 'profile', 'user_id');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+switch ($action) {
+case 'update':
+
+get_currentuserinfo();
+$edituser = get_userdata($user_id);
+if ($edituser-&gt;user_level &gt;= $user_level) die( __('You do not have permission to edit this user.') );
+
+/* checking the nickname has been typed */
+if (empty($_POST[&quot;new_nickname&quot;])) {
+	die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: please enter your nickname (can be the same as your username)&quot;));
+	return false;
+}
+
+$new_user_login  = wp_specialchars($_POST['new_user_login']);
+$pass1 = $_POST['pass1'];
+$pass2 = $_POST['pass2'];
+do_action('check_passwords', array($new_user_login, &amp;$pass1, &amp;$pass2));
+
+if ( '' == $pass1 ) {
+	if ( '' != $pass2 )
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed your new password only once. Go back to type it twice.&quot;));
+	$updatepassword = '';
+} else {
+	if ( '' == $pass2)
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed your new password only once. Go back to type it twice.&quot;));
+	if ( $pass1 != $pass2 )
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: you typed two different passwords. Go back to correct that.&quot;));
+	$new_pass = $pass1;
+	$updatepassword = &quot;user_pass=MD5('$new_pass'), &quot;;
+}
+
+$new_firstname   = wp_specialchars($_POST['new_firstname']);
+$new_lastname    = wp_specialchars($_POST['new_lastname']);
+$new_nickname    = $_POST['new_nickname'];
+$new_nicename    = sanitize_title($new_nickname, $user_id);
+$new_icq         = wp_specialchars($_POST['new_icq']);
+$new_aim         = wp_specialchars($_POST['new_aim']);
+$new_msn         = wp_specialchars($_POST['new_msn']);
+$new_yim         = wp_specialchars($_POST['new_yim']);
+$new_email       = wp_specialchars($_POST['new_email']);
+$new_url         = wp_specialchars($_POST['new_url']);
+$new_url         = preg_match('/^(https?|ftps?|mailto|news|gopher):/is', $new_url) ? $new_url : '<A HREF="http://">http://</A>' . $new_url; 
+$new_idmode      = wp_specialchars($_POST['new_idmode']);
+$new_description = $_POST['new_description'];
+
+$result = $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_login = '$new_user_login', user_firstname = '$new_firstname', $updatepassword user_lastname='$new_lastname', user_nickname='$new_nickname', user_icq='$new_icq', user_email='$new_email', user_url='$new_url', user_aim='$new_aim', user_msn='$new_msn', user_yim='$new_yim', user_idmode='$new_idmode', user_description = '$new_description', user_nicename = '$new_nicename' WHERE ID = $user_id&quot;);
+
+header(&quot;Location: user-edit.php?user_id=$user_id&amp;updated=true&quot;);
+
+break;
+
+case 'switchposts':
+
+check_admin_referer();
+
+/* TODO: Switch all posts from one user to another user */
+
+break;
+
+default:
+include ('admin-header.php');
+
+$edituser = get_userdata($user_id);
+
+if ($edituser-&gt;user_level &gt;= $user_level) die( __('You do not have permission to edit this user.') );
+?&gt;
+
+&lt;?php if ( isset($_GET['updated']) ) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;
+	&lt;p&gt;&lt;strong&gt;&lt;?php _e('User updated.') ?&gt;&lt;/strong&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;?php endif; ?&gt;
+
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Edit User'); ?&gt;&lt;/h2&gt;
+&lt;form name=&quot;edituser&quot; id=&quot;edituser&quot; action=&quot;user-edit.php&quot; method=&quot;post&quot;&gt;
+&lt;table width=&quot;99%&quot;  border=&quot;0&quot; cellspacing=&quot;2&quot; cellpadding=&quot;3&quot;&gt;
+	&lt;tr&gt;
+		&lt;th width=&quot;33%&quot; scope=&quot;row&quot;&gt;&lt;?php _e('Username:') ?&gt;&lt;/th&gt;
+		&lt;td width=&quot;73%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;new_user_login&quot; id=&quot;new_user_login&quot; value=&quot;&lt;?php echo $edituser-&gt;user_login; ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Level:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;?php echo $edituser-&gt;user_level; ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Posts:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;?php echo get_usernumposts($edituser-&gt;ID); ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php if ( '0000-00-00 00:00:00' != $edituser-&gt;user_registered ) { ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Registered on:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;?php echo substr($edituser-&gt;user_registered, 0, 11); ?&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php } ?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('First name:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_firstname&quot; id=&quot;new_firstname&quot; value=&quot;&lt;?php echo $edituser-&gt;user_firstname ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Last name:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_lastname&quot; id=&quot;new_lastname2&quot; value=&quot;&lt;?php echo $edituser-&gt;user_lastname ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Profile:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;textarea name=&quot;new_description&quot; rows=&quot;5&quot; id=&quot;new_description&quot; style=&quot;width: 99%; &quot;&gt;&lt;?php echo $edituser-&gt;user_description ?&gt;&lt;/textarea&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Nickname:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_nickname&quot; id=&quot;new_nickname&quot; value=&quot;&lt;?php echo $edituser-&gt;user_nickname ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_email&quot; id=&quot;new_email&quot; value=&quot;&lt;?php echo $edituser-&gt;user_email ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Website:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_url&quot; id=&quot;new_url&quot; value=&quot;&lt;?php echo $edituser-&gt;user_url ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('ICQ:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_icq&quot; id=&quot;new_icq&quot; value=&quot;&lt;?php if ($edituser-&gt;user_icq &gt; 0) { echo $edituser-&gt;user_icq; } ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('AIM:') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_aim&quot; id=&quot;new_aim&quot; value=&quot;&lt;?php echo $edituser-&gt;user_aim ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('MSN IM:') ?&gt;
+		&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_msn&quot; id=&quot;new_msn&quot; value=&quot;&lt;?php echo $edituser-&gt;user_msn ?&gt;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Yahoo IM:') ?&gt;
+		&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;new_yim&quot; id=&quot;new_yim&quot; value=&quot;&lt;?php echo $edituser-&gt;user_yim ?&gt;&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Identity on blog:') ?&gt;
+		&lt;/th&gt;
+		&lt;td&gt;&lt;select name=&quot;new_idmode&quot;&gt;
+				&lt;option value=&quot;nickname&quot;&lt;?php
+	if ($edituser-&gt;user_idmode == 'nickname')
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_nickname ?&gt;&lt;/option&gt;
+				&lt;option value=&quot;login&quot;&lt;?php
+	if ($edituser-&gt;user_idmode==&quot;login&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_login ?&gt;&lt;/option&gt;
+				&lt;option value=&quot;firstname&quot;&lt;?php
+	if ($edituser-&gt;user_idmode==&quot;firstname&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_firstname ?&gt;&lt;/option&gt;
+				&lt;option value=&quot;lastname&quot;&lt;?php
+	if ($edituser-&gt;user_idmode==&quot;lastname&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_lastname ?&gt;&lt;/option&gt;
+				&lt;option value=&quot;namefl&quot;&lt;?php
+	if ($edituser-&gt;user_idmode==&quot;namefl&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_firstname.&quot; &quot;.$edituser-&gt;user_lastname ?&gt;&lt;/option&gt;
+				&lt;option value=&quot;namelf&quot;&lt;?php
+	if ($edituser-&gt;user_idmode==&quot;namelf&quot;)
+	echo ' selected=&quot;selected&quot;'; ?&gt;&gt;&lt;?php echo $edituser-&gt;user_lastname.&quot; &quot;.$edituser-&gt;user_firstname ?&gt;&lt;/option&gt;
+			&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+$show_password_fields = apply_filters('show_password_fields', true);
+if ( $show_password_fields ) :
+?&gt;
+	&lt;tr&gt;
+		&lt;th scope=&quot;row&quot;&gt;&lt;?php _e('New &lt;strong&gt;Password&lt;/strong&gt; (Leave blank to stay the same.)') ?&gt;&lt;/th&gt;
+		&lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;pass1&quot; size=&quot;16&quot; value=&quot;&quot; /&gt;
+			&lt;br /&gt;
+			&lt;input type=&quot;password&quot; name=&quot;pass2&quot; size=&quot;16&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php endif; ?&gt;
+&lt;/table&gt;
+  &lt;p class=&quot;submit&quot;&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;update&quot; /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;user_id&quot; id=&quot;user_id&quot; value=&quot;&lt;?php echo $user_id; ?&gt;&quot; /&gt;
+    &lt;input type=&quot;submit&quot; value=&quot;&lt;?php _e('Update User &raquo;') ?&gt;&quot; name=&quot;submit&quot; /&gt;
+  &lt;/p&gt;
+&lt;/form&gt;
+&lt;/div&gt;
+
+&lt;?php
+break;
+}
+
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/users.php
===================================================================
--- trunk/wp-admin/users.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/users.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,332 @@
+&lt;?php
+require_once('admin.php');
+
+$title = __('Users');
+$parent_file = 'profile.php';
+	
+$wpvarstoreset = array('action');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+switch ($action) {
+case 'adduser':
+	check_admin_referer();
+
+	$user_login     = wp_specialchars(trim($_POST['user_login']));
+	$pass1          = $_POST['pass1'];
+	$pass2          = $_POST['pass2'];
+	$user_email     = wp_specialchars(trim($_POST['email']));
+	$user_firstname = wp_specialchars(trim($_POST['firstname']));
+	$user_lastname  = wp_specialchars(trim($_POST['lastname']));
+	$user_uri       = wp_specialchars(trim($_POST['uri']));
+		
+	/* checking that username has been typed */
+	if ($user_login == '')
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Please enter a username.'));
+
+	/* checking the password has been typed twice */
+	do_action('check_passwords', array($user_login, &amp;$pass1, &amp;$pass2));
+	if ($pass1 == '' || $pass2 == '')
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Please enter your password twice.'));
+
+	/* checking the password has been typed twice the same */
+	if ($pass1 != $pass2)
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Please type the same password in the two password fields.'));
+
+	$user_nickname = $user_login;
+
+	/* checking that the username isn't already used by another user */
+	$loginthere = $wpdb-&gt;get_var(&quot;SELECT user_login FROM $wpdb-&gt;users WHERE user_login = '$user_login'&quot;);
+    if ($loginthere)
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: This username is already registered, please choose another one.'));
+
+	/* checking e-mail address */
+	if (empty($_POST[&quot;email&quot;])) {
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: please type an e-mail address&quot;));
+		return false;
+	} else if (!is_email($_POST[&quot;email&quot;])) {
+		die (__(&quot;&lt;strong&gt;ERROR&lt;/strong&gt;: the email address isn't correct&quot;));
+		return false;
+	}
+
+	$user_ID = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users ORDER BY ID DESC LIMIT 1&quot;) + 1;
+
+	$user_nicename = sanitize_title($user_nickname, $user_ID);
+	$user_uri = preg_match('/^(https?|ftps?|mailto|news|gopher):/is', $user_uri) ? $user_uri : '<A HREF="http://">http://</A>' . $user_uri;
+	$now = gmdate('Y-m-d H:i:s');
+	$new_users_can_blog = get_settings('new_users_can_blog');
+
+	$result = $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;users 
+		(user_login, user_pass, user_nickname, user_email, user_ip, user_domain, user_browser, user_registered, user_level, user_idmode, user_firstname, user_lastname, user_nicename, user_url)
+	VALUES 
+		('$user_login', MD5('$pass1'), '$user_nickname', '$user_email', '$user_ip', '$user_domain', '$user_browser', '$now', '$new_users_can_blog', 'nickname', '$user_firstname', '$user_lastname', '$user_nicename', '$user_uri')&quot;);
+
+	do_action('user_register', $wpdb-&gt;insert_id);
+
+	if ($result == false)
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Couldn&#8217;t register you!'));
+
+	$stars = '';
+	for ($i = 0; $i &lt; strlen($pass1); $i = $i + 1)
+		$stars .= '*';
+
+	$user_login = stripslashes($user_login);
+	$message  = sprintf(__('New user registration on your blog %s:'), get_settings('blogname')) . &quot;\r\n\r\n&quot;;
+	$message .= sprintf(__('Username: %s'), $user_login) . &quot;\r\n\r\n&quot;;
+	$message .= sprintf(__('E-mail: %s'), $user_email) . &quot;\r\n&quot;;
+
+	@wp_mail(get_settings('admin_email'), sprintf(__('[%s] New User Registration'), get_settings('blogname')), $message);
+	header('Location: users.php');
+break;
+
+case 'promote':
+	check_admin_referer();
+
+	if (empty($_GET['prom'])) {
+		header('Location: users.php');
+	}
+
+	$id = (int) $_GET['id'];
+	$prom = $_GET['prom'];
+
+	$user_data = get_userdata($id);
+	$usertopromote_level = $user_data-&gt;user_level;
+
+	if ($user_level &lt;= $usertopromote_level) {
+		die(__('Can&#8217;t change the level of a user whose level is higher than yours.'));
+	}
+
+	if ('up' == $prom) {
+		$new_level = $usertopromote_level + 1;
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_level=$new_level WHERE ID = $id AND $new_level &lt; $user_level&quot;);
+	} elseif ('down' == $prom) {
+		$new_level = $usertopromote_level - 1;
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_level=$new_level WHERE ID = $id AND $new_level &lt; $user_level&quot;);
+	}
+
+	header('Location: users.php');
+
+break;
+
+case 'delete':
+
+	check_admin_referer();
+
+	$id = (int) $_GET['id'];
+
+	if (!$id) {
+		header('Location: users.php');
+	}
+
+	$user_data = get_userdata($id);
+	$usertodelete_level = $user_data-&gt;user_level;
+
+	if ($user_level &lt;= $usertodelete_level)
+		die(__('Can&#8217;t delete a user whose level is higher than yours.'));
+
+	$post_ids = $wpdb-&gt;get_col(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_author = $id&quot;);
+	if ($post_ids) {
+		$post_ids = implode(',', $post_ids);
+		
+		// Delete comments, *backs
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;comments WHERE comment_post_ID IN ($post_ids)&quot;);
+		// Clean cats
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;post2cat WHERE post_id IN ($post_ids)&quot;);
+		// Clean post_meta
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;postmeta WHERE post_id IN ($post_ids)&quot;);
+		// Clean links
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;links WHERE link_owner = $id&quot;);
+		// Delete posts
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;posts WHERE post_author = $id&quot;);
+	}
+
+	// FINALLY, delete user
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;users WHERE ID = $id&quot;);
+	header('Location: users.php?deleted=true');
+
+break;
+
+default:
+	
+	include ('admin-header.php');
+	?&gt;
+
+&lt;?php if (isset($_GET['deleted'])) : ?&gt;
+&lt;div class=&quot;updated&quot;&gt;&lt;p&gt;&lt;?php _e('User deleted.') ?&gt;&lt;/p&gt;&lt;/div&gt;
+&lt;?php endif; ?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+  &lt;h2&gt;&lt;?php _e('Authors') ?&gt;&lt;/h2&gt;
+  &lt;table cellpadding=&quot;3&quot; cellspacing=&quot;3&quot; width=&quot;100%&quot;&gt;
+	&lt;tr&gt;
+	&lt;th&gt;&lt;?php _e('ID') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('Nickname') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('E-mail') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('Website') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('Level') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&lt;?php _e('Posts') ?&gt;&lt;/th&gt;
+	&lt;th&gt;&nbsp;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;?php
+	$users = $wpdb-&gt;get_results(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_level &gt; 0 ORDER BY ID&quot;);
+	$style = '';
+	foreach ($users as $user) {
+		$user_data = get_userdata($user-&gt;ID);
+		$email = $user_data-&gt;user_email;
+		$url = $user_data-&gt;user_url;
+		$short_url = str_replace('<A HREF="http://">http://</A>', '', $url);
+		$short_url = str_replace('www.', '', $short_url);
+		if ('/' == substr($short_url, -1))
+			$short_url = substr($short_url, 0, -1);
+		if (strlen($short_url) &gt; 35)
+		$short_url =  substr($short_url, 0, 32).'...';
+		$style = ('class=&quot;alternate&quot;' == $style) ? '' : 'class=&quot;alternate&quot;';
+		$numposts = $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;posts WHERE post_author = $user-&gt;ID and post_status = 'publish'&quot;);
+		if (0 &lt; $numposts) $numposts = &quot;&lt;a href='edit.php?author=$user_data-&gt;ID' title='&quot; . __('View posts') . &quot;'&gt;$numposts&lt;/a&gt;&quot;;
+		echo &quot;
+&lt;tr $style&gt;
+	&lt;td align='center'&gt;$user_data-&gt;ID&lt;/td&gt;
+	&lt;td&gt;&lt;strong&gt;$user_data-&gt;user_nickname&lt;/strong&gt;&lt;/td&gt;
+	&lt;td&gt;$user_data-&gt;user_firstname $user_data-&gt;user_lastname&lt;/td&gt;
+	&lt;td&gt;&lt;a href='mailto:$email' title='&quot; . sprintf(__('e-mail: %s'), $email) . &quot;'&gt;$email&lt;/a&gt;&lt;/td&gt;
+	&lt;td&gt;&lt;a href='$url' title='website: $url'&gt;$short_url&lt;/a&gt;&lt;/td&gt;
+	&lt;td align='center'&gt;&quot;;
+	if (($user_level &gt;= 2) and ($user_level &gt; $user_data-&gt;user_level) and ($user_data-&gt;user_level &gt; 0))
+		echo &quot; &lt;a href=\&quot;users.php?action=promote&amp;id=&quot;.$user_data-&gt;ID.&quot;&amp;prom=down\&quot;&gt;-&lt;/a&gt; &quot;;
+	echo $user_data-&gt;user_level;
+	if (($user_level &gt;= 2) and ($user_level &gt; ($user_data-&gt;user_level + 1)))
+		echo &quot; &lt;a href=\&quot;users.php?action=promote&amp;id=&quot;.$user_data-&gt;ID.&quot;&amp;prom=up\&quot;&gt;+&lt;/a&gt; &quot;;
+	echo &quot;&lt;/td&gt;&lt;td align='right'&gt;$numposts&lt;/td&gt;&quot;;
+	echo '&lt;td&gt;';
+	if (($user_level &gt;= 2) and ($user_level &gt; $user_data-&gt;user_level))
+		echo &quot;&lt;a href='user-edit.php?user_id=$user_data-&gt;ID' class='edit'&gt;&quot;.__('Edit').&quot;&lt;/a&gt;&quot;;
+	echo '&lt;/td&gt;';
+	echo '&lt;/tr&gt;';
+	}
+	
+	?&gt;
+	
+  &lt;/table&gt;
+&lt;/div&gt;
+
+&lt;?php
+$users = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;users WHERE user_level = 0 ORDER BY ID&quot;);
+if ($users) {
+?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+	&lt;h2&gt;&lt;?php _e('Registered Users') ?&gt;&lt;/h2&gt;
+	&lt;table cellpadding=&quot;3&quot; cellspacing=&quot;3&quot; width=&quot;100%&quot;&gt;
+	&lt;tr&gt;
+		&lt;th&gt;&lt;?php _e('ID') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Nickname') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Name') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('E-mail') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;?php _e('Website') ?&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;/th&gt;
+		&lt;th&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+&lt;?php
+$style = '';
+foreach ($users as $user) {
+	$user_data = get_userdata($user-&gt;ID);
+	$email = $user_data-&gt;user_email;
+	$url = $user_data-&gt;user_url;
+	$short_url = str_replace('<A HREF="http://">http://</A>', '', $url);
+	$short_url = str_replace('www.', '', $short_url);
+	if ('/' == substr($short_url, -1))
+		$short_url = substr($short_url, 0, -1);
+	if (strlen($short_url) &gt; 35)
+	$short_url =  substr($short_url, 0, 32).'...';
+	$style = ('class=&quot;alternate&quot;' == $style) ? '' : 'class=&quot;alternate&quot;';
+echo &quot;\n&lt;tr $style&gt;
+&lt;td align='center'&gt;$user_data-&gt;ID&lt;/td&gt;
+&lt;td&gt;&lt;strong&gt;$user_data-&gt;user_nickname&lt;/strong&gt;&lt;/td&gt;
+&lt;td&gt;$user_data-&gt;user_firstname $user_data-&gt;user_lastname&lt;/td&gt;
+&lt;td&gt;&lt;a href='mailto:$email' title='&quot; . sprintf(__('e-mail: %s'), $email) . &quot;'&gt;$email&lt;/a&gt;&lt;/td&gt;
+&lt;td&gt;&lt;a href='$url' title='website: $url'&gt;$short_url&lt;/a&gt;&lt;/td&gt;
+&lt;td align='center'&gt;&quot;;
+
+	if ($user_level &gt;= 6)
+		echo &quot;&lt;a href='users.php?action=promote&amp;id=$user_data-&gt;ID&amp;prom=up' class='edit'&gt;&quot;. __('Promote') . '&lt;/a&gt;';	
+	echo &quot;&lt;/td&gt;\n&quot;;
+	echo '&lt;td&gt;';
+	if (($user_level &gt;= 6) and ($user_level &gt; $user_data-&gt;user_level))
+		echo &quot;&lt;a href='user-edit.php?user_id=$user_data-&gt;ID' class='edit'&gt;&quot;.__('Edit').&quot;&lt;/a&gt;&quot;;
+	echo '&lt;/td&gt;&lt;td&gt;';
+	if ($user_level &gt;= 6)
+		echo &quot;&lt;a href='users.php?action=delete&amp;id=$user_data-&gt;ID' class='delete' onclick='return confirm(\&quot;&quot; . __('You are about to delete this user \n  OK to delete, Cancel to stop.') . &quot;\&quot;)'&gt;&quot; . __('Delete'). '&lt;/a&gt;';
+	echo '&lt;/td&gt;&lt;/tr&gt;';
+
+}
+
+?&gt;
+	
+	&lt;/table&gt;
+	  &lt;p&gt;&lt;?php _e('Deleting a user also deletes all posts made by that user.') ?&gt;&lt;/p&gt;
+&lt;/div&gt;
+
+	&lt;?php 
+	} ?&gt;
+&lt;div class=&quot;wrap&quot;&gt;
+&lt;h2&gt;&lt;?php _e('Add New User') ?&gt;&lt;/h2&gt;
+&lt;?php printf(__('&lt;p&gt;Users can &lt;a href=&quot;%s/wp-register.php&quot;&gt;register themselves&lt;/a&gt; or you can manually create users here.&lt;/p&gt;'), get_settings('siteurl')); ?&gt;
+&lt;form action=&quot;&quot; method=&quot;post&quot; name=&quot;adduser&quot; id=&quot;adduser&quot;&gt;
+  &lt;table class=&quot;editform&quot; width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;5&quot;&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot; width=&quot;33%&quot;&gt;&lt;?php _e('Nickname') ?&gt;
+      &lt;input name=&quot;action&quot; type=&quot;hidden&quot; id=&quot;action&quot; value=&quot;adduser&quot; /&gt;&lt;/th&gt;
+      &lt;td width=&quot;66%&quot;&gt;&lt;input name=&quot;user_login&quot; type=&quot;text&quot; id=&quot;user_login&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('First Name') ?&gt; &lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;firstname&quot; type=&quot;text&quot; id=&quot;firstname&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Last Name') ?&gt; &lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;lastname&quot; type=&quot;text&quot; id=&quot;lastname&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('E-mail') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;email&quot; type=&quot;text&quot; id=&quot;email&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Website') ?&gt;&lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;uri&quot; type=&quot;text&quot; id=&quot;uri&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+&lt;?php
+$show_password_fields = apply_filters('show_password_fields', true);
+if ( $show_password_fields ) :
+?&gt;
+    &lt;tr&gt;
+      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e('Password (twice)') ?&gt; &lt;/th&gt;
+      &lt;td&gt;&lt;input name=&quot;pass1&quot; type=&quot;password&quot; id=&quot;pass1&quot; /&gt;
+      &lt;br /&gt;
+      &lt;input name=&quot;pass2&quot; type=&quot;password&quot; id=&quot;pass2&quot; /&gt;&lt;/td&gt;
+    &lt;/tr&gt;
+&lt;?php endif; ?&gt;
+  &lt;/table&gt;
+  &lt;p class=&quot;submit&quot;&gt;
+    &lt;input name=&quot;adduser&quot; type=&quot;submit&quot; id=&quot;adduser&quot; value=&quot;&lt;?php _e('Add User') ?&gt; &raquo;&quot; /&gt;
+  &lt;/p&gt;
+  &lt;/form&gt;
+&lt;/div&gt;
+	&lt;?php
+
+break;
+}
+
+include('admin-footer.php');
+?&gt;

Added: trunk/wp-admin/wp-admin.css
===================================================================
--- trunk/wp-admin/wp-admin.css	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-admin/wp-admin.css	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,281 @@
+* html #poststuff
+{
+	height: 100%; /* kill peekaboo bug in IE */
+}
+
+body
+{
+	background: #f8f8f8;
+	color: #000;
+	margin: 0;
+	padding: 0;
+	font: 0.9em sans-serif;
+}
+
+#wphead
+{
+	margin: 0;
+	padding: 5px;
+}
+
+#wphead h1
+{
+	font: 2em serif;
+	font-weight: bold;
+	width: 50%;
+	margin: 0 auto;
+	text-align: center;
+}
+
+#wphead span
+{
+	float: left;
+	margin: 5px 5px 0 5px;
+}
+
+#adminmenu, #adminmenu2
+{
+	border-bottom: 2px solid #444;
+	margin: 0;
+	font-size: 0.9em;
+}
+
+#adminmenu
+{
+	background-color: #555;
+	padding: 2px 0 2px 5px;
+}
+
+#adminmenu2
+{
+	background-color: #ccc;
+	padding: 2px 0 2px 20px;
+}
+
+#adminmenu li, #adminmenu2 li
+{
+	display: inline;
+	line-height: 200%;
+	list-style: none;
+	text-align: center;
+	margin: 4px;
+}
+
+#adminmenu li a, #adminmenu2 li a
+{
+	text-decoration: none;
+	padding: 2px 3px;
+	white-space: nowrap;
+}
+
+#adminmenu li a
+{
+	color: #fff;
+	border: 1px solid #fff;
+}
+
+#adminmenu2 li a
+{
+	color: #000;
+	border: 1px solid #000;
+}
+
+.updated
+{
+	border: 1px solid #fc1;
+	background-color: #ff0;
+	padding-left: 30px;
+	width: 75%;
+	margin: 10px auto;
+}
+
+.wrap, #dashboard
+{
+	border: 2px solid #000;
+	margin: 10px auto;
+	width: 85%;
+	background-color: #f0f0f0;
+	padding: 5px 20px;
+}
+
+h2, h3, h4, h5, h6
+{
+	border-bottom: 1px solid #555;
+}
+
+h2
+{
+	font-size: 1.8em;
+}
+
+h3
+{
+	font-size: 1.6em;
+}
+
+h4
+{
+	font-size: 1.4em;
+}
+
+h4
+{
+	font-size: 1.2em;
+}
+
+h5
+{
+	font-size: 1.1em;
+}
+
+fieldset
+{
+	border: 1px solid #555;
+	background-color: #f0f0f0;
+}
+
+fieldset legend
+{
+	border: 0;
+	padding: 4px;
+	text-align: center;
+	background-color: #f0f0f0;
+}
+
+fieldset legend a
+{
+	text-decoration: none;
+	border: 0;
+	margin: 1px 1px -2px 1px;
+	text-align: center;
+	font-weight: bold;
+	color: #000;
+}
+
+fieldset div input
+{}
+
+dt
+{
+	margin-top: 4px;
+	margin-bottom: 1px;
+}
+
+dd
+{
+	margin-bottom: 6px;
+}
+
+code
+{
+	font: 0.9em monospace;
+}
+
+#titlediv
+{
+	width: 25%;
+	min-width: 15em;
+	float: left;
+	border: 0;
+}
+
+#categorydiv
+{
+	float: right;
+	display: inline;
+	width: 20%;
+	border: 0;
+}
+
+#commentstatusdiv
+{
+	float: left;
+	margin-left: 10px;
+	width: 20%;
+}
+
+#postpassworddiv
+{
+	float: left;
+	margin-left: 10px;
+	width: 15%;
+}
+
+#postexcerpt
+{
+	float: left;
+	width: 65%;
+}
+
+#metainfo, #postdiv, #postexcerpt
+{
+clear: both;
+}
+
+#footer
+{
+	margin: 10px auto;
+	width: 75%;
+	padding: 5px 20px;
+	font-size: 0.75em;
+	text-align: center;
+}
+
+#login
+{
+	width: 60%;
+	margin: 50px auto;
+	border: 2px solid #000;
+	padding: 25px;
+	font-size: 1em;
+	background-color: #f0f0f0;
+}
+
+#login h1 a
+{
+	color: #000;
+}
+
+.options ul li
+{
+	list-style-type : none;
+}
+
+.wrap table
+{
+	border: 0;
+	font-size: 0.9em;
+}
+
+.wrap table tr
+{
+	background-color: #eee;
+	border-bottom: 1px solid #ccc;
+}
+
+.wrap table tr.alternate
+{
+	background-color: #fff;
+	border-bottom: 1px solid #ccc;
+}
+
+.wrap table tr td
+{
+	padding: 2px;
+}
+
+.togl, .vers, .auth
+{
+	text-align: center;
+}
+
+.togl
+{
+	background: #faa;
+}
+
+textarea
+{
+	width: 80%;
+	height: 13em;
+}
\ No newline at end of file

Added: trunk/wp-atom.php
===================================================================
--- trunk/wp-atom.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-atom.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,45 @@
+&lt;?php
+
+if (empty($feed)) {
+    $blog = 1;
+		$feed = 'atom';
+    $doing_rss = 1;
+    require('wp-blog-header.php');
+}
+
+header('Content-type: application/atom+xml; charset=' . get_settings('blog_charset'), true);
+$more = 1;
+
+?&gt;
+&lt;?php echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;'.get_settings('blog_charset').'&quot;?'.'&gt;'; ?&gt;
+&lt;feed version=&quot;0.3&quot;
+  xmlns=&quot;<A HREF="http://purl.org/atom/ns#">http://purl.org/atom/ns#</A>&quot;
+  xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+  xml:lang=&quot;&lt;?php echo get_option('rss_language'); ?&gt;&quot;
+  &gt;
+	&lt;title&gt;&lt;?php bloginfo_rss('name') ?&gt;&lt;/title&gt;
+	&lt;link rel=&quot;alternate&quot; type=&quot;text/html&quot; href=&quot;&lt;?php bloginfo_rss('home') ?&gt;&quot; /&gt;
+	&lt;tagline&gt;&lt;?php bloginfo_rss(&quot;description&quot;) ?&gt;&lt;/tagline&gt;
+	&lt;modified&gt;&lt;?php echo mysql2date('Y-m-d\TH:i:s\Z', get_lastpostmodified('GMT'), false); ?&gt;&lt;/modified&gt;
+	&lt;copyright&gt;Copyright &lt;?php echo mysql2date('Y', get_lastpostdate('blog'), 0); ?&gt;&lt;/copyright&gt;
+	&lt;generator url=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot; version=&quot;&lt;?php bloginfo_rss('version'); ?&gt;&quot;&gt;WordPress&lt;/generator&gt;
+	
+	&lt;?php $items_count = 0; if ($posts) { foreach ($posts as $post) { start_wp(); ?&gt;
+	&lt;entry&gt;
+	  	&lt;author&gt;
+			&lt;name&gt;&lt;?php the_author() ?&gt;&lt;/name&gt;
+		&lt;/author&gt;
+		&lt;title type=&quot;text/html&quot; mode=&quot;escaped&quot;&gt;&lt;![CDATA[&lt;?php the_title_rss() ?&gt;]]&gt;&lt;/title&gt;
+		&lt;link rel=&quot;alternate&quot; type=&quot;text/html&quot; href=&quot;&lt;?php permalink_single_rss() ?&gt;&quot; /&gt;
+		&lt;id&gt;&lt;?php the_guid(); ?&gt;&lt;/id&gt;
+		&lt;modified&gt;&lt;?php echo get_post_time('Y-m-d\TH:i:s\Z', true); ?&gt;&lt;/modified&gt;
+		&lt;issued&gt;&lt;?php echo get_post_time('Y-m-d\TH:i:s\Z', true); ?&gt;&lt;/issued&gt;
+		&lt;?php the_category_rss('rdf') ?&gt; 
+		&lt;summary type=&quot;text/plain&quot; mode=&quot;escaped&quot;&gt;&lt;![CDATA[&lt;?php the_excerpt_rss(); ?&gt;]]&gt;&lt;/summary&gt;
+&lt;?php if ( !get_settings('rss_use_excerpt') ) : ?&gt;
+		&lt;content type=&quot;&lt;?php bloginfo('html_type'); ?&gt;&quot; mode=&quot;escaped&quot; xml:base=&quot;&lt;?php permalink_single_rss() ?&gt;&quot;&gt;&lt;![CDATA[&lt;?php the_content('', 0, '') ?&gt;]]&gt;&lt;/content&gt;
+&lt;?php endif; ?&gt;
+&lt;?php rss_enclosure(); ?&gt;
+	&lt;/entry&gt;
+	&lt;?php $items_count++; if (($items_count == get_settings('posts_per_rss')) &amp;&amp; empty($m)) { break; } } } ?&gt;
+&lt;/feed&gt;

Added: trunk/wp-blog-header.php
===================================================================
--- trunk/wp-blog-header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-blog-header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,263 @@
+&lt;?php
+
+if (! isset($wp_did_header)):
+if ( !file_exists( dirname(__FILE__) . '/wp-config.php') ) {
+	if ( strstr( $_SERVER['PHP_SELF'], 'wp-admin') ) $path = '';
+	else $path = 'wp-admin/';
+    die(&quot;There doesn't seem to be a &lt;code&gt;wp-config.php&lt;/code&gt; file. I need this before we can get started. Need more help? &lt;a href='<A HREF="http://wordpress.org/docs/faq/#wp-config">http://wordpress.org/docs/faq/#wp-config</A>'&gt;We got it&lt;/a&gt;. You can &lt;a href='{$path}setup-config.php'&gt;create a &lt;code&gt;wp-config.php&lt;/code&gt; file through a web interface&lt;/a&gt;, but this doesn't work for all server setups. The safest way is to manually create the file.&quot;);
+}
+
+$wp_did_header = true;
+
+require_once( dirname(__FILE__) . '/wp-config.php');
+
+$query_vars = array();
+
+// Process PATH_INFO and 404.
+if ((isset($_GET['error']) &amp;&amp; $_GET['error'] == '404') ||
+		((! empty($_SERVER['PATH_INFO'])) &amp;&amp;
+		('/' != $_SERVER['PATH_INFO']) &amp;&amp;
+		 (false === strpos($_SERVER['PATH_INFO'], '.php'))
+		)) {
+
+	// If we match a rewrite rule, this will be cleared.
+	$error = '404';
+
+	// Fetch the rewrite rules.
+	$rewrite = $wp_rewrite-&gt;wp_rewrite_rules();
+
+	if (! empty($rewrite)) {
+		$pathinfo = $_SERVER['PATH_INFO'];
+		$req_uri = $_SERVER['REQUEST_URI'];      
+		$home_path = parse_url(get_settings('home'));
+		$home_path = $home_path['path'];
+
+		// Trim path info from the end and the leading home path from the
+		// front.  For path info requests, this leaves us with the requesting
+		// filename, if any.  For 404 requests, this leaves us with the
+		// requested permalink.	
+		$req_uri = str_replace($pathinfo, '', $req_uri);
+		$req_uri = str_replace($home_path, '', $req_uri);
+		$req_uri = trim($req_uri, '/');
+		$pathinfo = trim($pathinfo, '/');
+
+		// The requested permalink is in $pathinfo for path info requests and
+		//  $req_uri for other requests.
+		if (! empty($pathinfo)) {
+			$request = $pathinfo;
+		} else {
+			$request = $req_uri;
+		}
+
+		// Look for matches.
+		$request_match = $request;
+		foreach ($rewrite as $match =&gt; $query) {
+			// If the requesting file is the anchor of the match, prepend it
+			// to the path info.
+	    if ((! empty($req_uri)) &amp;&amp; (strpos($match, $req_uri) === 0)) {
+	      $request_match = $req_uri . '/' . $request;
+	    }
+
+			if (preg_match(&quot;!^$match!&quot;, $request_match, $matches)) {
+				// Got a match.
+				// Trim the query of everything up to the '?'.
+				$query = preg_replace(&quot;!^.+\?!&quot;, '', $query);
+
+				// Substitute the substring matches into the query.
+				eval(&quot;\$query = \&quot;$query\&quot;;&quot;);
+
+				// Parse the query.
+				parse_str($query, $query_vars);
+
+				// If we're processing a 404 request, clear the error var
+				// since we found something.
+				if (isset($_GET['error'])) {
+					unset($_GET['error']);
+				}
+
+				if (isset($error)) {
+					unset($error);
+				}
+
+				break;
+			}
+		}
+	}
+ }
+
+$wpvarstoreset = array('m','p','posts','w', 'cat','withcomments','s','search','exact', 'sentence', 'debug', 'calendar','page','paged','more','tb', 'pb','author','order','orderby', 'year', 'monthnum', 'day', 'hour', 'minute', 'second', 'name', 'category_name', 'feed', 'author_name', 'static', 'pagename', 'page_id', 'error', 'comments_popup');
+
+$wpvarstoreset = apply_filters('query_vars', $wpvarstoreset);
+
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[$wpvar])) {
+			if (empty($_GET[$wpvar]) &amp;&amp; empty($query_vars[$wpvar])) {
+				$$wpvar = '';
+			} elseif (!empty($_GET[$wpvar])) {
+				$$wpvar = $_GET[$wpvar];
+			} else {
+				$$wpvar = $query_vars[$wpvar];
+			}
+		} else {
+			$$wpvar = $_POST[$wpvar];
+		}
+	}
+}
+
+// Sending HTTP headers
+
+if ( !empty($error) &amp;&amp; '404' == $error ) {
+	if ( preg_match('/cgi/', php_sapi_name()) )
+		@header('Status: 404 Not Found');
+	else
+		@header('HTTP/1.x 404 Not Found');
+ } else if ( empty($feed) ) {
+	@header('X-Pingback: '. get_bloginfo('pingback_url'));
+	@header('Content-type: ' . get_option('html_type') . '; charset=' . get_option('blog_charset'));
+} else {
+	// We're showing a feed, so WP is indeed the only thing that last changed
+	if ( $withcomments )
+		$wp_last_modified = mysql2date('D, d M Y H:i:s', get_lastcommentmodified('GMT'), 0).' GMT';
+	else 
+		$wp_last_modified = mysql2date('D, d M Y H:i:s', get_lastpostmodified('GMT'), 0).' GMT';
+	$wp_etag = '&quot;' . md5($wp_last_modified) . '&quot;';
+	@header(&quot;Last-Modified: $wp_last_modified&quot;);
+	@header(&quot;ETag: $wp_etag&quot;);
+	@header('X-Pingback: ' . get_bloginfo('pingback_url'));
+
+	// Support for Conditional GET
+	if (isset($_SERVER['HTTP_IF_NONE_MATCH'])) $client_etag = stripslashes($_SERVER['HTTP_IF_NONE_MATCH']);
+	else $client_etag = false;
+
+	$client_last_modified = trim( $_SERVER['HTTP_IF_MODIFIED_SINCE']);
+	// If string is empty, return 0. If not, attempt to parse into a timestamp
+	$client_modified_timestamp = $client_last_modified ? strtotime($client_last_modified) : 0;
+
+	// Make a timestamp for our most recent modification...	
+	$wp_modified_timestamp = strtotime($wp_last_modified);
+
+	if ( ($client_last_modified &amp;&amp; $client_etag) ?
+		(($client_modified_timestamp &gt;= $wp_modified_timestamp) &amp;&amp; ($client_etag == $wp_etag)) :
+		(($client_modified_timestamp &gt;= $wp_modified_timestamp) || ($client_etag == $wp_etag)) ) {
+		if ( preg_match('/cgi/',php_sapi_name()) ) {
+			header('Status: 304 Not Modified');
+			echo &quot;\r\n\r\n&quot;;
+			exit;
+		} else {
+			if ( version_compare(phpversion(), '4.3.0', '&gt;=') )
+				header('Not Modified', TRUE, 304);
+			else
+				header('HTTP/1.x 304 Not Modified');
+			exit;
+		}
+	}
+}
+
+$use_gzipcompression = get_settings('gzipcompression');
+
+$more_wpvars = array('posts_per_page', 'posts_per_archive_page', 'what_to_show', 'showposts', 'nopaging');
+
+// Construct the query string.
+$query_string = '';
+foreach (array_merge($wpvarstoreset, $more_wpvars) as $wpvar) {
+	if ($$wpvar != '') {
+		$query_string .= (strlen($query_string) &lt; 1) ? '' : '&amp;';
+		$query_string .= $wpvar . '=' . rawurlencode($$wpvar);
+	}
+}
+
+$query_string = apply_filters('query_string', $query_string);
+
+update_category_cache();
+get_currentuserinfo();
+
+// Call query posts to do the work.
+$posts = &amp; query_posts($query_string);
+
+// Extract updated query vars back into global namespace.
+extract($wp_query-&gt;query_vars);
+
+if ( is_single() || is_page() ) {
+	$more = 1;
+	$single = 1;
+}
+
+// Issue a 404 if a permalink request doesn't match any posts.  Don't issue a
+// 404 if one was already issued, if the request was a search, or if the
+// request was a regular query string request rather than a permalink request.
+if ( (0 == count($posts)) &amp;&amp; !is_404() &amp;&amp; !is_search()
+		&amp;&amp; ( isset($rewrite) || (!empty($_SERVER['QUERY_STRING']) &amp;&amp;
+		(false === strpos($_SERVER['REQUEST_URI'], '?'))) ) ) {
+	$wp_query-&gt;is_404 = true;
+	if ( preg_match('/cgi/', php_sapi_name()) )
+		@header('Status: 404 Not Found');
+	else
+		@header('HTTP/1.x 404 Not Found');
+}
+
+if ($pagenow != 'post.php' &amp;&amp; $pagenow != 'edit.php') {
+	if ( get_settings('gzipcompression') ) 
+		gzip_compression();
+}
+
+// Template redirection
+if ( defined('WP_USE_THEMES') &amp;&amp; constant('WP_USE_THEMES') ) {
+	do_action('template_redirect');
+	if ( is_feed() &amp;&amp; empty($doing_rss) ) {
+		include(ABSPATH . '/wp-feed.php');
+		exit;
+	} else if ( is_trackback() &amp;&amp; empty($doing_trackback) ) {
+		include(ABSPATH . '/wp-trackback.php');
+		exit;
+	} else if ( is_404() &amp;&amp; get_404_template() ) {
+		include(get_404_template());
+		exit;
+	} else if ( is_search() &amp;&amp; get_search_template() ) {
+		include(get_search_template());
+		exit;
+	} else if ( is_home() &amp;&amp; get_home_template() ) {
+		include(get_home_template());
+		exit;
+	} else if ( is_single() &amp;&amp; get_single_template() ) {
+		include(get_single_template());
+		exit;
+	} else if ( is_page() &amp;&amp; get_page_template() ) {
+		include(get_page_template());
+		exit;
+	} else if ( is_category() &amp;&amp; get_category_template()) {
+		include(get_category_template());
+		exit;		
+	} else if ( is_author() &amp;&amp; get_author_template() ) {
+		include(get_author_template());
+		exit;
+	} else if ( is_date() &amp;&amp; get_date_template() ) {
+		include(get_date_template());
+		exit;
+	} else if ( is_archive() &amp;&amp; get_archive_template() ) {
+		include(get_archive_template());
+		exit;
+	} else if ( is_comments_popup() &amp;&amp; get_comments_popup_template() ) {
+		include(get_comments_popup_template());
+		exit;
+	} else if ( is_paged() &amp;&amp; get_paged_template() ) {
+		include(get_paged_template());
+		exit;
+	} else if ( file_exists(TEMPLATEPATH . &quot;/index.php&quot;) ) {
+		include(TEMPLATEPATH . &quot;/index.php&quot;);
+		exit;
+	}
+} else {
+	// Process feeds and trackbacks even if not using themes.
+	if ( is_feed() &amp;&amp; empty($doing_rss) ) {
+		include(ABSPATH . '/wp-feed.php');
+		exit;
+	} else if ( is_trackback() &amp;&amp; empty($doing_trackback) ) {
+		include(ABSPATH . '/wp-trackback.php');
+		exit;
+	}
+}
+
+endif;
+?&gt;

Added: trunk/wp-comments-post.php
===================================================================
--- trunk/wp-comments-post.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-comments-post.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,63 @@
+&lt;?php
+require( dirname(__FILE__) . '/wp-config.php' );
+
+$comment_post_ID = (int) $_POST['comment_post_ID'];
+
+$status = $wpdb-&gt;get_row(&quot;SELECT post_status, comment_status FROM $wpdb-&gt;posts WHERE ID = '$comment_post_ID'&quot;);
+
+if ( empty($status-&gt;comment_status) ) {
+	do_action('comment_id_not_found', $comment_post_ID);
+	exit;
+} elseif ( 'closed' ==  $status-&gt;comment_status ) {
+	do_action('comment_closed', $comment_post_ID);
+	die( __('Sorry, comments are closed for this item.') );
+} elseif ( 'draft' == $status-&gt;post_status ) {
+	do_action('comment_on_draft', $comment_post_ID);
+	exit;
+}
+
+$comment_author       = trim($_POST['author']);
+$comment_author_email = trim($_POST['email']);
+$comment_author_url   = trim($_POST['url']);
+$comment_content      = trim($_POST['comment']);
+
+// If the user is logged in
+get_currentuserinfo();
+if ( $user_ID ) :
+	$comment_author       = addslashes($user_identity);
+	$comment_author_email = addslashes($user_email);
+	$comment_author_url   = addslashes($user_url);
+else :
+	if ( get_option('comment_registration') )
+		die( __('Sorry, you must be logged in to post a comment.') );
+endif;
+
+$comment_type = '';
+
+if ( get_settings('require_name_email') &amp;&amp; !$user_ID ) {
+	if ( 6 &gt; strlen($comment_author_email) || '' == $comment_author )
+		die( __('Error: please fill the required fields (name, email).') );
+	elseif ( !is_email($comment_author_email))
+		die( __('Error: please enter a valid email address.') );
+}
+
+if ( '' == $comment_content )
+	die( __('Error: please type a comment.') );
+
+$commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type', 'user_ID');
+
+wp_new_comment($commentdata);
+
+setcookie('comment_author_' . COOKIEHASH, stripslashes($comment_author), time() + 30000000, COOKIEPATH);
+setcookie('comment_author_email_' . COOKIEHASH, stripslashes($comment_author_email), time() + 30000000, COOKIEPATH);
+setcookie('comment_author_url_' . COOKIEHASH, stripslashes($comment_author_url), time() + 30000000, COOKIEPATH);
+
+header('Expires: Wed, 11 Jan 1984 05:00:00 GMT');
+header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
+header('Cache-Control: no-cache, must-revalidate, max-age=0');
+header('Pragma: no-cache');
+
+$location = (empty($_POST['redirect_to'])) ? $_SERVER[&quot;HTTP_REFERER&quot;] : $_POST['redirect_to']; 
+
+wp_redirect($location);
+?&gt;
\ No newline at end of file

Added: trunk/wp-commentsrss2.php
===================================================================
--- trunk/wp-commentsrss2.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-commentsrss2.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,82 @@
+&lt;?php 
+if ( empty($feed) ) {
+	$feed = 'rss2';
+	$withcomments = 1;
+	$doing_rss = 1;
+	require('wp-blog-header.php');
+}
+
+header('Content-type: text/xml;charset=' . get_settings('blog_charset'), true);
+
+echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;'.get_settings('blog_charset').'&quot;?'.'&gt;'; 
+?&gt;
+&lt;!-- generator=&quot;wordpress/&lt;?php echo $wp_version ?&gt;&quot; --&gt;
+&lt;rss version=&quot;2.0&quot; 
+	xmlns:content=&quot;<A HREF="http://purl.org/rss/1.0/modules/content/">http://purl.org/rss/1.0/modules/content/</A>&quot;&gt;
+&lt;channel&gt;
+&lt;?php
+$i = 0;
+if (have_posts()) :
+  while (have_posts()) : the_post();
+	if ($i &lt; 1) {
+		$i++;
+?&gt;
+	&lt;title&gt;&lt;?php if (is_single() || is_page()) { echo &quot;Comments on: &quot;; the_title_rss(); } else { bloginfo_rss(&quot;name&quot;); echo &quot; Comments&quot;; } ?&gt;&lt;/title&gt;
+	&lt;link&gt;&lt;?php (is_single()) ? permalink_single_rss() : bloginfo_rss(&quot;url&quot;) ?&gt;&lt;/link&gt;
+	&lt;description&gt;&lt;?php bloginfo_rss(&quot;description&quot;) ?&gt;&lt;/description&gt;
+	&lt;pubDate&gt;&lt;?php echo gmdate('r'); ?&gt;&lt;/pubDate&gt;
+	&lt;generator&gt;<A HREF="http://wordpress.org/?v=&lt;?php">http://wordpress.org/?v=&lt;?php</A> echo $wp_version ?&gt;&lt;/generator&gt;
+
+&lt;?php 
+		if (is_single() || is_page()) {
+			$comments = $wpdb-&gt;get_results(&quot;SELECT comment_ID, comment_author, comment_author_email, 
+			comment_author_url, comment_date, comment_date_gmt, comment_content, comment_post_ID, 
+			$wpdb-&gt;posts.ID, $wpdb-&gt;posts.post_password FROM $wpdb-&gt;comments 
+			LEFT JOIN $wpdb-&gt;posts ON comment_post_id = id WHERE comment_post_ID = '$id' 
+			AND $wpdb-&gt;comments.comment_approved = '1' AND ($wpdb-&gt;posts.post_status = 'publish' OR $wpdb-&gt;posts.post_status = 'static') 
+			AND post_date &lt; '&quot;.date(&quot;Y-m-d H:i:59&quot;).&quot;' 
+			ORDER BY comment_date DESC LIMIT &quot; . get_settings('posts_per_rss') );
+		} else { // if no post id passed in, we'll just ue the last 10 comments.
+			$comments = $wpdb-&gt;get_results(&quot;SELECT comment_ID, comment_author, comment_author_email, 
+			comment_author_url, comment_date, comment_date_gmt, comment_content, comment_post_ID, 
+			$wpdb-&gt;posts.ID, $wpdb-&gt;posts.post_password FROM $wpdb-&gt;comments 
+			LEFT JOIN $wpdb-&gt;posts ON comment_post_id = id WHERE ($wpdb-&gt;posts.post_status = 'publish' OR $wpdb-&gt;posts.post_status = 'static') 
+			AND $wpdb-&gt;comments.comment_approved = '1' AND post_date &lt; '&quot;.date(&quot;Y-m-d H:i:s&quot;).&quot;'  
+			ORDER BY comment_date DESC LIMIT &quot; . get_settings('posts_per_rss') );
+		}
+	// this line is WordPress' motor, do not delete it.
+		if ($comments) {
+			foreach ($comments as $comment) {
+?&gt;
+	&lt;item&gt;
+ 		&lt;title&gt;&lt;?php if ( (! is_single()) || (! is_page()) ) {
+ 			$title = get_the_title($comment-&gt;comment_post_ID);
+ 			$title = apply_filters('the_title', $title);
+ 			$title = apply_filters('the_title_rss', $title);
+ 			echo &quot;Comment on $title&quot;;
+ 		} ?&gt; by: &lt;?php comment_author_rss() ?&gt;&lt;/title&gt;
+		&lt;link&gt;&lt;?php comment_link() ?&gt;&lt;/link&gt;
+		&lt;pubDate&gt;&lt;?php echo mysql2date('D, d M Y H:i:s +0000', get_comment_time('Y-m-d H:i:s', true), false); ?&gt;&lt;/pubDate&gt;
+		&lt;guid&gt;&lt;?php comment_link() ?&gt;&lt;/guid&gt;
+			&lt;?php 
+			if (!empty($comment-&gt;post_password) &amp;&amp; $_COOKIE['wp-postpass'] != $comment-&gt;post_password) {
+			?&gt;
+		&lt;description&gt;Protected Comments: Please enter your password to view comments.&lt;/description&gt;
+		&lt;content:encoded&gt;&lt;![CDATA[&lt;?php echo get_the_password_form() ?&gt;]]&gt;&lt;/content:encoded&gt;
+			&lt;?php
+			} else {
+			?&gt;
+		&lt;description&gt;&lt;?php comment_text_rss() ?&gt;&lt;/description&gt;
+		&lt;content:encoded&gt;&lt;![CDATA[&lt;?php comment_text() ?&gt;]]&gt;&lt;/content:encoded&gt;
+			&lt;?php 
+			} // close check for password 
+			?&gt;
+	&lt;/item&gt;
+&lt;?php 
+			}
+		}
+	}
+endwhile; endif;
+?&gt;
+&lt;/channel&gt;
+&lt;/rss&gt;

Added: trunk/wp-config.sample.php
===================================================================
--- trunk/wp-config.sample.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-config.sample.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,21 @@
+&lt;?php
+// ** MySQL settings ** //
+define('DB_NAME', 'yourdb');     // The name of the database
+define('DB_USER', 'yourdbusername');     // Your MySQL username
+define('DB_PASSWORD', 'yourdbpasswd'); // ...and password
+define('DB_HOST', 'localhost');     // 99% chance you won't need to change this value
+
+// Change the prefix if you want to have multiple blogs in a single database.
+$table_prefix  = 'SP_';   // example: 'wp_' or 'b2' or 'mylogin_'
+
+// Change this to localize WordPress.  A corresponding MO file for the
+// chosen language must be installed to wp-includes/languages.
+// For example, install de.mo to wp-includes/languages and set WPLANG to 'de'
+// to enable German language support.
+define ('WPLANG', '');
+
+/* Stop editing */
+
+define('ABSPATH', dirname(__FILE__).'/');
+require_once(ABSPATH.'wp-settings.php');
+?&gt;
\ No newline at end of file

Added: trunk/wp-content/plugins/hello.php
===================================================================
--- trunk/wp-content/plugins/hello.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/plugins/hello.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,73 @@
+&lt;?php
+/*
+Plugin Name: Hello Dolly
+Plugin URI: <A HREF="http://wordpress.org/#">http://wordpress.org/#</A>
+Description: This is not just a plugin, it symbolizes the hope and enthusiasm of an entire generation summed up in two words sung most famously by Louis Armstrong. Hello, Dolly. This is, by the way, the world's first official WordPress plugin. When enabled you will randomly see a lyric from &lt;cite&gt;Hello, Dolly&lt;/cite&gt; in the upper right of your admin screen on every page.
+Author: Matt Mullenweg
+Version: 1.0
+Author URI: <A HREF="http://photomatt.net/">http://photomatt.net/</A>
+*/ 
+
+// These are the lyrics to Hello Dolly
+$lyrics = &quot;Hello, Dolly
+Well, hello, Dolly
+It's so nice to have you back where you belong
+You're lookin' swell, Dolly
+I can tell, Dolly
+You're still glowin', you're still crowin'
+You're still goin' strong
+We feel the room swayin'
+While the band's playin'
+One of your old favourite songs from way back when
+So, take her wrap, fellas
+Find her an empty lap, fellas
+Dolly'll never go away again
+Hello, Dolly
+Well, hello, Dolly
+It's so nice to have you back where you belong
+You're lookin' swell, Dolly
+I can tell, Dolly
+You're still glowin', you're still crowin'
+You're still goin' strong
+We feel the room swayin'
+While the band's playin'
+One of your old favourite songs from way back when
+Golly, gee, fellas
+Find her a vacant knee, fellas
+Dolly'll never go away
+Dolly'll never go away
+Dolly'll never go away again&quot;;
+
+// Here we split it into lines
+$lyrics = explode(&quot;\n&quot;, $lyrics);
+// And then randomly choose a line
+$chosen = wptexturize( $lyrics[ mt_rand(0, count($lyrics) ) ] );
+
+// This just echoes the chosen line, we'll position it later
+function hello_dolly() {
+	global $chosen;
+	echo &quot;&lt;p id='dolly'&gt;$chosen&lt;/p&gt;&quot;;
+}
+
+// Now we set that function up to execute when the admin_footer action is called
+add_action('admin_footer', 'hello_dolly');
+
+// We need some CSS to position the paragraph
+function dolly_css() {
+	echo &quot;
+	&lt;style type='text/css'&gt;
+	#dolly {
+		position: absolute;
+		top: 5px;
+margin: 0; padding: 0;
+		right: 3em;
+		font-size: 20px;
+		color: #666;
+	}
+	&lt;/style&gt;
+	&quot;;
+}
+
+add_action('admin_head', 'dolly_css');
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-content/plugins/markdown.php
===================================================================
--- trunk/wp-content/plugins/markdown.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/plugins/markdown.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,1283 @@
+&lt;?php
+
+#
+# Markdown  -  A text-to-HTML conversion tool for web writers
+#
+# Copyright (c) 2004 John Gruber  
+# &lt;<A HREF="http://daringfireball.net/projects/markdown/">http://daringfireball.net/projects/markdown/</A>&gt;
+#
+# Copyright (c) 2004 Michel Fortin - PHP Port  
+# &lt;<A HREF="http://www.michelf.com/projects/php-markdown/">http://www.michelf.com/projects/php-markdown/</A>&gt;
+#
+
+
+global	$MarkdownPHPVersion, $MarkdownSyntaxVersion,
+		$md_empty_element_suffix, $md_tab_width,
+		$md_nested_brackets_depth, $md_nested_brackets, 
+		$md_escape_table, $md_backslash_escape_table, 
+		$md_list_level;
+
+$MarkdownPHPVersion    = '1.0.1'; # Fri 17 Dec 2004
+$MarkdownSyntaxVersion = '1.0.1'; # Sun 12 Dec 2004
+
+
+#
+# Global default settings:
+#
+$md_empty_element_suffix = &quot; /&gt;&quot;;     # Change to &quot;&gt;&quot; for HTML output
+$md_tab_width = 4;
+
+
+# -- WordPress Plugin Interface -----------------------------------------------
+/*
+Plugin Name: Markdown
+Plugin URI: <A HREF="http://www.michelf.com/projects/php-markdown/">http://www.michelf.com/projects/php-markdown/</A>
+Description: &lt;a href=&quot;<A HREF="http://daringfireball.net/projects/markdown/syntax">http://daringfireball.net/projects/markdown/syntax</A>&quot;&gt;Markdown syntax&lt;/a&gt; allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by &lt;a href=&quot;<A HREF="http://daringfireball.net/">http://daringfireball.net/</A>&quot;&gt;John Gruber&lt;/a&gt;. &lt;a href=&quot;<A HREF="http://www.michelf.com/projects/php-markdown/">http://www.michelf.com/projects/php-markdown/</A>&quot;&gt;More...&lt;/a&gt;
+Version: 1.0.1
+Author: Michel Fortin
+Author URI: <A HREF="http://www.michelf.com/">http://www.michelf.com/</A>
+*/
+if (isset($wp_version)) {
+	# Remove default WordPress auto-paragraph filter.
+	remove_filter('the_content', 'wpautop');
+	remove_filter('the_excerpt', 'wpautop');
+	remove_filter('comment_text', 'wpautop');
+	# Add Markdown filter with priority 6 (same as Textile).
+	add_filter('the_content', 'Markdown', 6);
+	add_filter('the_excerpt', 'Markdown', 6);
+	add_filter('the_excerpt_rss', 'Markdown', 6);
+	add_filter('comment_text', 'Markdown', 6);
+}
+
+
+# -- bBlog Plugin Info --------------------------------------------------------
+function identify_modifier_markdown() {
+	global $MarkdownPHPVersion;
+	return array(
+		'name'			=&gt; 'markdown',
+		'type'			=&gt; 'modifier',
+		'nicename'		=&gt; 'Markdown',
+		'description'	=&gt; 'A text-to-HTML conversion tool for web writers',
+		'authors'		=&gt; 'Michel Fortin and John Gruber',
+		'licence'		=&gt; 'GPL',
+		'version'		=&gt; $MarkdownPHPVersion,
+		'help'			=&gt; '&lt;a href=&quot;<A HREF="http://daringfireball.net/projects/markdown/syntax">http://daringfireball.net/projects/markdown/syntax</A>&quot;&gt;Markdown syntax&lt;/a&gt; allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by &lt;a href=&quot;<A HREF="http://daringfireball.net/">http://daringfireball.net/</A>&quot;&gt;John Gruber&lt;/a&gt;. &lt;a href=&quot;<A HREF="http://www.michelf.com/projects/php-markdown/">http://www.michelf.com/projects/php-markdown/</A>&quot;&gt;More...&lt;/a&gt;'
+	);
+}
+
+# -- Smarty Modifier Interface ------------------------------------------------
+function smarty_modifier_markdown($text) {
+	return Markdown($text);
+}
+
+# -- Textile Compatibility Mode -----------------------------------------------
+# Rename this file to &quot;classTextile.php&quot; and it can replace Textile anywhere.
+if (strcasecmp(substr(__FILE__, -16), &quot;classTextile.php&quot;) == 0) {
+	# Try to include PHP SmartyPants. Should be in the same directory.
+	@include_once 'smartypants.php';
+	# Fake Textile class. It calls Markdown instead.
+	class Textile {
+		function TextileThis($text, $lite='', $encode='', $noimage='', $strict='') {
+			if ($lite == '' &amp;&amp; $encode == '')   $text = Markdown($text);
+			if (function_exists('SmartyPants')) $text = SmartyPants($text);
+			return $text;
+		}
+	}
+}
+
+
+
+#
+# Globals:
+#
+
+# Regex to match balanced [brackets].
+# Needed to insert a maximum bracked depth while converting to PHP.
+$md_nested_brackets_depth = 6;
+$md_nested_brackets = 
+	str_repeat('(?&gt;[^\[\]]+|\[', $md_nested_brackets_depth).
+	str_repeat('\])*', $md_nested_brackets_depth);
+
+# Table of hash values for escaped characters:
+$md_escape_table = array(
+	&quot;\\&quot; =&gt; md5(&quot;\\&quot;),
+	&quot;`&quot; =&gt; md5(&quot;`&quot;),
+	&quot;*&quot; =&gt; md5(&quot;*&quot;),
+	&quot;_&quot; =&gt; md5(&quot;_&quot;),
+	&quot;{&quot; =&gt; md5(&quot;{&quot;),
+	&quot;}&quot; =&gt; md5(&quot;}&quot;),
+	&quot;[&quot; =&gt; md5(&quot;[&quot;),
+	&quot;]&quot; =&gt; md5(&quot;]&quot;),
+	&quot;(&quot; =&gt; md5(&quot;(&quot;),
+	&quot;)&quot; =&gt; md5(&quot;)&quot;),
+	&quot;&gt;&quot; =&gt; md5(&quot;&gt;&quot;),
+	&quot;#&quot; =&gt; md5(&quot;#&quot;),
+	&quot;+&quot; =&gt; md5(&quot;+&quot;),
+	&quot;-&quot; =&gt; md5(&quot;-&quot;),
+	&quot;.&quot; =&gt; md5(&quot;.&quot;),
+	&quot;!&quot; =&gt; md5(&quot;!&quot;)
+);
+# Create an identical table but for escaped characters.
+$md_backslash_escape_table;
+foreach ($md_escape_table as $key =&gt; $char)
+	$md_backslash_escape_table[&quot;\\$key&quot;] = $char;
+
+
+function Markdown($text) {
+#
+# Main function. The order in which other subs are called here is
+# essential. Link and image substitutions need to happen before
+# _EscapeSpecialChars(), so that any *'s or _'s in the &lt;a&gt;
+# and &lt;img&gt; tags get encoded.
+#
+	# Clear the global hashes. If we don't clear these, you get conflicts
+	# from other articles when generating a page which contains more than
+	# one article (e.g. an index page that shows the N most recent
+	# articles):
+	global $md_urls, $md_titles, $md_html_blocks;
+	$md_urls = array();
+	$md_titles = array();
+	$md_html_blocks = array();
+
+	# Standardize line endings:
+	#   DOS to Unix and Mac to Unix
+	$text = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $text);
+
+	# Make sure $text ends with a couple of newlines:
+	$text .= &quot;\n\n&quot;;
+
+	# Convert all tabs to spaces.
+	$text = _Detab($text);
+
+	# Strip any lines consisting only of spaces and tabs.
+	# This makes subsequent regexen easier to write, because we can
+	# match consecutive blank lines with /\n+/ instead of something
+	# contorted like /[ \t]*\n+/ .
+	$text = preg_replace('/^[ \t]+$/m', '', $text);
+
+	# Turn block-level HTML blocks into hash entries
+	$text = _HashHTMLBlocks($text);
+
+	# Strip link definitions, store in hashes.
+	$text = _StripLinkDefinitions($text);
+
+	$text = _RunBlockGamut($text);
+
+	$text = _UnescapeSpecialChars($text);
+
+	return $text . &quot;\n&quot;;
+}
+
+
+function _StripLinkDefinitions($text) {
+#
+# Strips link definitions from text, stores the URLs and titles in
+# hash references.
+#
+	global $md_tab_width;
+	$less_than_tab = $md_tab_width - 1;
+
+	# Link defs are in the form: ^[id]: url &quot;optional title&quot;
+	$text = preg_replace_callback('{
+						^[ ]{0,'.$less_than_tab.'}\[(.+)\]:	# id = $1
+						  [ \t]*
+						  \n?				# maybe *one* newline
+						  [ \t]*
+						&lt;?(\S+?)&gt;?			# url = $2
+						  [ \t]*
+						  \n?				# maybe one newline
+						  [ \t]*
+						(?:
+							(?&lt;=\s)			# lookbehind for whitespace
+							[&quot;(]
+							(.+?)			# title = $3
+							[&quot;)]
+							[ \t]*
+						)?	# title is optional
+						(?:\n+|\Z)
+		}xm',
+		'_StripLinkDefinitions_callback',
+		$text);
+	return $text;
+}
+function _StripLinkDefinitions_callback($matches) {
+	global $md_urls, $md_titles;
+	$link_id = strtolower($matches[1]);
+	$md_urls[$link_id] = _EncodeAmpsAndAngles($matches[2]);
+	if (isset($matches[3]))
+		$md_titles[$link_id] = str_replace('&quot;', '&quot;', $matches[3]);
+	return ''; # String that will replace the block
+}
+
+
+function _HashHTMLBlocks($text) {
+	global $md_tab_width;
+	$less_than_tab = $md_tab_width - 1;
+
+	# Hashify HTML blocks:
+	# We only want to do this for block-level HTML tags, such as headers,
+	# lists, and tables. That's because we still want to wrap &lt;p&gt;s around
+	# &quot;paragraphs&quot; that are wrapped in non-block-level tags, such as anchors,
+	# phrase emphasis, and spans. The list of tags we're looking for is
+	# hard-coded:
+	$block_tags_a = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
+					'script|noscript|form|fieldset|iframe|math|ins|del';
+	$block_tags_b = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
+					'script|noscript|form|fieldset|iframe|math';
+
+	# First, look for nested blocks, e.g.:
+	# 	&lt;div&gt;
+	# 		&lt;div&gt;
+	# 		tags for inner block must be indented.
+	# 		&lt;/div&gt;
+	# 	&lt;/div&gt;
+	#
+	# The outermost tags must start at the left margin for this to match, and
+	# the inner nested divs must be indented.
+	# We need to do this before the next, more liberal match, because the next
+	# match will start at the first `&lt;div&gt;` and stop at the first `&lt;/div&gt;`.
+	$text = preg_replace_callback(&quot;{
+				(						# save in $1
+					^					# start of line  (with /m)
+					&lt;($block_tags_a)	# start tag = $2
+					\\b					# word break
+					(.*\\n)*?			# any number of lines, minimally matching
+					&lt;/\\2&gt;				# the matching end tag
+					[ \\t]*				# trailing spaces/tabs
+					(?=\\n+|\\Z)	# followed by a newline or end of document
+				)
+		}xm&quot;,
+		'_HashHTMLBlocks_callback',
+		$text);
+
+	#
+	# Now match more liberally, simply from `\n&lt;tag&gt;` to `&lt;/tag&gt;\n`
+	#
+	$text = preg_replace_callback(&quot;{
+				(						# save in $1
+					^					# start of line  (with /m)
+					&lt;($block_tags_b)	# start tag = $2
+					\\b					# word break
+					(.*\\n)*?			# any number of lines, minimally matching
+					.*&lt;/\\2&gt;				# the matching end tag
+					[ \\t]*				# trailing spaces/tabs
+					(?=\\n+|\\Z)	# followed by a newline or end of document
+				)
+		}xm&quot;,
+		'_HashHTMLBlocks_callback',
+		$text);
+
+	# Special case just for &lt;hr /&gt;. It was easier to make a special case than
+	# to make the other regex more complicated.
+	$text = preg_replace_callback('{
+				(?:
+					(?&lt;=\n\n)		# Starting after a blank line
+					|				# or
+					\A\n?			# the beginning of the doc
+				)
+				(						# save in $1
+					[ ]{0,'.$less_than_tab.'}
+					&lt;(hr)				# start tag = $2
+					\b					# word break
+					([^&lt;&gt;])*?			# 
+					/?&gt;					# the matching end tag
+					[ \t]*
+					(?=\n{2,}|\Z)		# followed by a blank line or end of document
+				)
+		}x',
+		'_HashHTMLBlocks_callback',
+		$text);
+
+	# Special case for standalone HTML comments:
+	$text = preg_replace_callback('{
+				(?:
+					(?&lt;=\n\n)		# Starting after a blank line
+					|				# or
+					\A\n?			# the beginning of the doc
+				)
+				(						# save in $1
+					[ ]{0,'.$less_than_tab.'}
+					(?s:
+						&lt;!
+						(--.*?--\s*)+
+						&gt;
+					)
+					[ \t]*
+					(?=\n{2,}|\Z)		# followed by a blank line or end of document
+				)
+			}x',
+			'_HashHTMLBlocks_callback',
+			$text);
+
+	return $text;
+}
+function _HashHTMLBlocks_callback($matches) {
+	global $md_html_blocks;
+	$text = $matches[1];
+	$key = md5($text);
+	$md_html_blocks[$key] = $text;
+	return &quot;\n\n$key\n\n&quot;; # String that will replace the block
+}
+
+
+function _RunBlockGamut($text) {
+#
+# These are all the transformations that form block-level
+# tags like paragraphs, headers, and list items.
+#
+	global $md_empty_element_suffix;
+
+	$text = _DoHeaders($text);
+
+	# Do Horizontal Rules:
+	$text = preg_replace(
+		array('{^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$}mx',
+			  '{^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$}mx',
+			  '{^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$}mx'),
+		&quot;\n&lt;hr$md_empty_element_suffix\n&quot;, 
+		$text);
+
+	$text = _DoLists($text);
+
+	$text = _DoCodeBlocks($text);
+
+	$text = _DoBlockQuotes($text);
+
+	# We already ran _HashHTMLBlocks() before, in Markdown(), but that
+	# was to escape raw HTML in the original Markdown source. This time,
+	# we're escaping the markup we've just created, so that we don't wrap
+	# &lt;p&gt; tags around block-level tags.
+	$text = _HashHTMLBlocks($text);
+
+	$text = _FormParagraphs($text);
+
+	return $text;
+}
+
+
+function _RunSpanGamut($text) {
+#
+# These are all the transformations that occur *within* block-level
+# tags like paragraphs, headers, and list items.
+#
+	global $md_empty_element_suffix;
+
+	$text = _DoCodeSpans($text);
+
+	$text = _EscapeSpecialChars($text);
+
+	# Process anchor and image tags. Images must come first,
+	# because ![foo][f] looks like an anchor.
+	$text = _DoImages($text);
+	$text = _DoAnchors($text);
+
+	# Make links out of things like `&lt;<A HREF="http://example.com/">http://example.com/</A>&gt;`
+	# Must come after _DoAnchors(), because you can use &lt; and &gt;
+	# delimiters in inline links like [this](&lt;url&gt;).
+	$text = _DoAutoLinks($text);
+
+	# Fix unencoded ampersands and &lt;'s:
+	$text = _EncodeAmpsAndAngles($text);
+
+	$text = _DoItalicsAndBold($text);
+
+	# Do hard breaks:
+	$text = preg_replace('/ {2,}\n/', &quot;&lt;br$md_empty_element_suffix\n&quot;, $text);
+
+	return $text;
+}
+
+
+function _EscapeSpecialChars($text) {
+	global $md_escape_table;
+	$tokens = _TokenizeHTML($text);
+
+	$text = '';   # rebuild $text from the tokens
+#	$in_pre = 0;  # Keep track of when we're inside &lt;pre&gt; or &lt;code&gt; tags.
+#	$tags_to_skip = &quot;!&lt;(/?)(?:pre|code|kbd|script|math)[\s&gt;]!&quot;;
+
+	foreach ($tokens as $cur_token) {
+		if ($cur_token[0] == 'tag') {
+			# Within tags, encode * and _ so they don't conflict
+			# with their use in Markdown for italics and strong.
+			# We're replacing each such character with its
+			# corresponding MD5 checksum value; this is likely
+			# overkill, but it should prevent us from colliding
+			# with the escape values by accident.
+			$cur_token[1] = str_replace(array('*', '_'),
+				array($md_escape_table['*'], $md_escape_table['_']),
+				$cur_token[1]);
+			$text .= $cur_token[1];
+		} else {
+			$t = $cur_token[1];
+			$t = _EncodeBackslashEscapes($t);
+			$text .= $t;
+		}
+	}
+	return $text;
+}
+
+
+function _DoAnchors($text) {
+#
+# Turn Markdown link shortcuts into XHTML &lt;a&gt; tags.
+#
+	global $md_nested_brackets;
+	#
+	# First, handle reference-style links: [link text] [id]
+	#
+	$text = preg_replace_callback(&quot;{
+		(					# wrap whole match in $1
+		  \\[
+			($md_nested_brackets)	# link text = $2
+		  \\]
+
+		  [ ]?				# one optional space
+		  (?:\\n[ ]*)?		# one optional newline followed by spaces
+
+		  \\[
+			(.*?)		# id = $3
+		  \\]
+		)
+		}xs&quot;,
+		'_DoAnchors_reference_callback', $text);
+
+	#
+	# Next, inline-style links: [link text](url &quot;optional title&quot;)
+	#
+	$text = preg_replace_callback(&quot;{
+		(				# wrap whole match in $1
+		  \\[
+			($md_nested_brackets)	# link text = $2
+		  \\]
+		  \\(			# literal paren
+			[ \\t]*
+			&lt;?(.*?)&gt;?	# href = $3
+			[ \\t]*
+			(			# $4
+			  (['\&quot;])	# quote char = $5
+			  (.*?)		# Title = $6
+			  \\5		# matching quote
+			)?			# title is optional
+		  \\)
+		)
+		}xs&quot;,
+		'_DoAnchors_inline_callback', $text);
+
+	return $text;
+}
+function _DoAnchors_reference_callback($matches) {
+	global $md_urls, $md_titles, $md_escape_table;
+	$whole_match = $matches[1];
+	$link_text   = $matches[2];
+	$link_id     = strtolower($matches[3]);
+
+	if ($link_id == &quot;&quot;) {
+		$link_id = strtolower($link_text); # for shortcut links like [this][].
+	}
+
+	if (isset($md_urls[$link_id])) {
+		$url = $md_urls[$link_id];
+		# We've got to encode these to avoid conflicting with italics/bold.
+		$url = str_replace(array('*', '_'),
+						   array($md_escape_table['*'], $md_escape_table['_']),
+						   $url);
+		$result = &quot;&lt;a href=\&quot;$url\&quot;&quot;;
+		if ( isset( $md_titles[$link_id] ) ) {
+			$title = $md_titles[$link_id];
+			$title = str_replace(array('*',     '_'),
+								 array($md_escape_table['*'], 
+									   $md_escape_table['_']), $title);
+			$result .=  &quot; title=\&quot;$title\&quot;&quot;;
+		}
+		$result .= &quot;&gt;$link_text&lt;/a&gt;&quot;;
+	}
+	else {
+		$result = $whole_match;
+	}
+	return $result;
+}
+function _DoAnchors_inline_callback($matches) {
+	global $md_escape_table;
+	$whole_match	= $matches[1];
+	$link_text		= $matches[2];
+	$url			= $matches[3];
+	$title			=&amp; $matches[6];
+
+	# We've got to encode these to avoid conflicting with italics/bold.
+	$url = str_replace(array('*', '_'),
+					   array($md_escape_table['*'], $md_escape_table['_']), 
+					   $url);
+	$result = &quot;&lt;a href=\&quot;$url\&quot;&quot;;
+	if (isset($title)) {
+		$title = str_replace('&quot;', '&quot;', $title);
+		$title = str_replace(array('*', '_'),
+							 array($md_escape_table['*'], $md_escape_table['_']),
+							 $title);
+		$result .=  &quot; title=\&quot;$title\&quot;&quot;;
+	}
+	
+	$result .= &quot;&gt;$link_text&lt;/a&gt;&quot;;
+
+	return $result;
+}
+
+
+function _DoImages($text) {
+#
+# Turn Markdown image shortcuts into &lt;img&gt; tags.
+#
+	#
+	# First, handle reference-style labeled images: ![alt text][id]
+	#
+	$text = preg_replace_callback('{
+		(				# wrap whole match in $1
+		  !\[
+			(.*?)		# alt text = $2
+		  \]
+
+		  [ ]?				# one optional space
+		  (?:\n[ ]*)?		# one optional newline followed by spaces
+
+		  \[
+			(.*?)		# id = $3
+		  \]
+
+		)
+		}xs', 
+		'_DoImages_reference_callback', $text);
+
+	#
+	# Next, handle inline images:  ![alt text](url &quot;optional title&quot;)
+	# Don't forget: encode * and _
+
+	$text = preg_replace_callback(&quot;{
+		(				# wrap whole match in $1
+		  !\\[
+			(.*?)		# alt text = $2
+		  \\]
+		  \\(			# literal paren
+			[ \\t]*
+			&lt;?(\S+?)&gt;?	# src url = $3
+			[ \\t]*
+			(			# $4
+			  (['\&quot;])	# quote char = $5
+			  (.*?)		# title = $6
+			  \\5		# matching quote
+			  [ \\t]*
+			)?			# title is optional
+		  \\)
+		)
+		}xs&quot;,
+		'_DoImages_inline_callback', $text);
+
+	return $text;
+}
+function _DoImages_reference_callback($matches) {
+	global $md_urls, $md_titles, $md_empty_element_suffix, $md_escape_table;
+	$whole_match = $matches[1];
+	$alt_text    = $matches[2];
+	$link_id     = strtolower($matches[3]);
+
+	if ($link_id == &quot;&quot;) {
+		$link_id = strtolower($alt_text); # for shortcut links like ![this][].
+	}
+
+	$alt_text = str_replace('&quot;', '&quot;', $alt_text);
+	if (isset($md_urls[$link_id])) {
+		$url = $md_urls[$link_id];
+		# We've got to encode these to avoid conflicting with italics/bold.
+		$url = str_replace(array('*', '_'),
+						   array($md_escape_table['*'], $md_escape_table['_']),
+						   $url);
+		$result = &quot;&lt;img src=\&quot;$url\&quot; alt=\&quot;$alt_text\&quot;&quot;;
+		if (isset($md_titles[$link_id])) {
+			$title = $md_titles[$link_id];
+			$title = str_replace(array('*', '_'),
+								 array($md_escape_table['*'], 
+									   $md_escape_table['_']), $title);
+			$result .=  &quot; title=\&quot;$title\&quot;&quot;;
+		}
+		$result .= $md_empty_element_suffix;
+	}
+	else {
+		# If there's no such link ID, leave intact:
+		$result = $whole_match;
+	}
+
+	return $result;
+}
+function _DoImages_inline_callback($matches) {
+	global $md_empty_element_suffix, $md_escape_table;
+	$whole_match	= $matches[1];
+	$alt_text		= $matches[2];
+	$url			= $matches[3];
+	$title			= '';
+	if (isset($matches[6])) {
+		$title		= $matches[6];
+	}
+
+	$alt_text = str_replace('&quot;', '&quot;', $alt_text);
+	$title    = str_replace('&quot;', '&quot;', $title);
+	# We've got to encode these to avoid conflicting with italics/bold.
+	$url = str_replace(array('*', '_'),
+					   array($md_escape_table['*'], $md_escape_table['_']),
+					   $url);
+	$result = &quot;&lt;img src=\&quot;$url\&quot; alt=\&quot;$alt_text\&quot;&quot;;
+	if (isset($title)) {
+		$title = str_replace(array('*', '_'),
+							 array($md_escape_table['*'], $md_escape_table['_']),
+							 $title);
+		$result .=  &quot; title=\&quot;$title\&quot;&quot;; # $title already quoted
+	}
+	$result .= $md_empty_element_suffix;
+
+	return $result;
+}
+
+
+function _DoHeaders($text) {
+	# Setext-style headers:
+	#	  Header 1
+	#	  ========
+	#  
+	#	  Header 2
+	#	  --------
+	#
+	$text = preg_replace(
+		array('{ ^(.+)[ \t]*\n=+[ \t]*\n+ }emx',
+			  '{ ^(.+)[ \t]*\n-+[ \t]*\n+ }emx'),
+		array(&quot;'&lt;h1&gt;'._RunSpanGamut(_UnslashQuotes('\\1')).'&lt;/h1&gt;\n\n'&quot;,
+			  &quot;'&lt;h2&gt;'._RunSpanGamut(_UnslashQuotes('\\1')).'&lt;/h2&gt;\n\n'&quot;),
+		$text);
+
+	# atx-style headers:
+	#	# Header 1
+	#	## Header 2
+	#	## Header 2 with closing hashes ##
+	#	...
+	#	###### Header 6
+	#
+	$text = preg_replace(&quot;{
+			^(\\#{1,6})	# $1 = string of #'s
+			[ \\t]*
+			(.+?)		# $2 = Header text
+			[ \\t]*
+			\\#*			# optional closing #'s (not counted)
+			\\n+
+		}xme&quot;,
+		&quot;'&lt;h'.strlen('\\1').'&gt;'._RunSpanGamut(_UnslashQuotes('\\2')).'&lt;/h'.strlen('\\1').'&gt;\n\n'&quot;,
+		$text);
+
+	return $text;
+}
+
+
+function _DoLists($text) {
+#
+# Form HTML ordered (numbered) and unordered (bulleted) lists.
+#
+	global $md_tab_width, $md_list_level;
+	$less_than_tab = $md_tab_width - 1;
+
+	# Re-usable patterns to match list item bullets and number markers:
+	$marker_ul  = '[*+-]';
+	$marker_ol  = '\d+[.]';
+	$marker_any = &quot;(?:$marker_ul|$marker_ol)&quot;;
+
+	# Re-usable pattern to match any entirel ul or ol list:
+	$whole_list = '
+		(								# $1 = whole list
+		  (								# $2
+			[ ]{0,'.$less_than_tab.'}
+			('.$marker_any.')				# $3 = first list item marker
+			[ \t]+
+		  )
+		  (?s:.+?)
+		  (								# $4
+			  \z
+			|
+			  \n{2,}
+			  (?=\S)
+			  (?!						# Negative lookahead for another list item marker
+				[ \t]*
+				'.$marker_any.'[ \t]+
+			  )
+		  )
+		)
+	'; // mx
+	
+	# We use a different prefix before nested lists than top-level lists.
+	# See extended comment in _ProcessListItems().
+
+	if ($md_list_level) {
+		$text = preg_replace_callback('{
+				^
+				'.$whole_list.'
+			}mx',
+			'_DoLists_callback', $text);
+	}
+	else {
+		$text = preg_replace_callback('{
+				(?:(?&lt;=\n\n)|\A\n?)
+				'.$whole_list.'
+			}mx',
+			'_DoLists_callback', $text);
+	}
+
+	return $text;
+}
+function _DoLists_callback($matches) {
+	# Re-usable patterns to match list item bullets and number markers:
+	$marker_ul  = '[*+-]';
+	$marker_ol  = '\d+[.]';
+	$marker_any = &quot;(?:$marker_ul|$marker_ol)&quot;;
+	
+	$list = $matches[1];
+	$list_type = preg_match(&quot;/$marker_ul/&quot;, $matches[3]) ? &quot;ul&quot; : &quot;ol&quot;;
+	# Turn double returns into triple returns, so that we can make a
+	# paragraph for the last item in a list, if necessary:
+	$list = preg_replace(&quot;/\n{2,}/&quot;, &quot;\n\n\n&quot;, $list);
+	$result = _ProcessListItems($list, $marker_any);
+	$result = &quot;&lt;$list_type&gt;\n&quot; . $result . &quot;&lt;/$list_type&gt;\n&quot;;
+	return $result;
+}
+
+
+function _ProcessListItems($list_str, $marker_any) {
+#
+#	Process the contents of a single ordered or unordered list, splitting it
+#	into individual list items.
+#
+	global $md_list_level;
+	
+	# The $md_list_level global keeps track of when we're inside a list.
+	# Each time we enter a list, we increment it; when we leave a list,
+	# we decrement. If it's zero, we're not in a list anymore.
+	#
+	# We do this because when we're not inside a list, we want to treat
+	# something like this:
+	#
+	#		I recommend upgrading to version
+	#		8. Oops, now this line is treated
+	#		as a sub-list.
+	#
+	# As a single paragraph, despite the fact that the second line starts
+	# with a digit-period-space sequence.
+	#
+	# Whereas when we're inside a list (or sub-list), that line will be
+	# treated as the start of a sub-list. What a kludge, huh? This is
+	# an aspect of Markdown's syntax that's hard to parse perfectly
+	# without resorting to mind-reading. Perhaps the solution is to
+	# change the syntax rules such that sub-lists must start with a
+	# starting cardinal number; e.g. &quot;1.&quot; or &quot;a.&quot;.
+	
+	$md_list_level++;
+
+	# trim trailing blank lines:
+	$list_str = preg_replace(&quot;/\n{2,}\\z/&quot;, &quot;\n&quot;, $list_str);
+
+	$list_str = preg_replace_callback('{
+		(\n)?							# leading line = $1
+		(^[ \t]*)						# leading whitespace = $2
+		('.$marker_any.') [ \t]+		# list marker = $3
+		((?s:.+?)						# list item text   = $4
+		(\n{1,2}))
+		(?= \n* (\z | \2 ('.$marker_any.') [ \t]+))
+		}xm',
+		'_ProcessListItems_callback', $list_str);
+
+	$md_list_level--;
+	return $list_str;
+}
+function _ProcessListItems_callback($matches) {
+	$item = $matches[4];
+	$leading_line =&amp; $matches[1];
+	$leading_space =&amp; $matches[2];
+
+	if ($leading_line || preg_match('/\n{2,}/', $item)) {
+		$item = _RunBlockGamut(_Outdent($item));
+	}
+	else {
+		# Recursion for sub-lists:
+		$item = _DoLists(_Outdent($item));
+		$item = rtrim($item, &quot;\n&quot;);
+		$item = _RunSpanGamut($item);
+	}
+
+	return &quot;&lt;li&gt;&quot; . $item . &quot;&lt;/li&gt;\n&quot;;
+}
+
+
+function _DoCodeBlocks($text) {
+#
+#	Process Markdown `&lt;pre&gt;&lt;code&gt;` blocks.
+#
+	global $md_tab_width;
+	$text = preg_replace_callback(&quot;{
+			(?:\\n\\n|\\A)
+			(	            # $1 = the code block -- one or more lines, starting with a space/tab
+			  (?:
+				(?:[ ]\{$md_tab_width} | \\t)  # Lines must start with a tab or a tab-width of spaces
+				.*\\n+
+			  )+
+			)
+			((?=^[ ]{0,$md_tab_width}\\S)|\\Z)	# Lookahead for non-space at line-start, or end of doc
+		}xm&quot;,
+		'_DoCodeBlocks_callback', $text);
+
+	return $text;
+}
+function _DoCodeBlocks_callback($matches) {
+	$codeblock = $matches[1];
+
+	$codeblock = _EncodeCode(_Outdent($codeblock));
+//	$codeblock = _Detab($codeblock);
+	# trim leading newlines and trailing whitespace
+	$codeblock = preg_replace(array('/\A\n+/', '/\s+\z/'), '', $codeblock);
+
+	$result = &quot;\n\n&lt;pre&gt;&lt;code&gt;&quot; . $codeblock . &quot;\n&lt;/code&gt;&lt;/pre&gt;\n\n&quot;;
+
+	return $result;
+}
+
+
+function _DoCodeSpans($text) {
+#
+# 	*	Backtick quotes are used for &lt;code&gt;&lt;/code&gt; spans.
+#
+# 	*	You can use multiple backticks as the delimiters if you want to
+# 		include literal backticks in the code span. So, this input:
+#
+#		  Just type ``foo `bar` baz`` at the prompt.
+#
+#	  	Will translate to:
+#
+#		  &lt;p&gt;Just type &lt;code&gt;foo `bar` baz&lt;/code&gt; at the prompt.&lt;/p&gt;
+#
+#		There's no arbitrary limit to the number of backticks you
+#		can use as delimters. If you need three consecutive backticks
+#		in your code, use four for delimiters, etc.
+#
+#	*	You can use spaces to get literal backticks at the edges:
+#
+#		  ... type `` `bar` `` ...
+#
+#	  	Turns to:
+#
+#		  ... type &lt;code&gt;`bar`&lt;/code&gt; ...
+#
+	$text = preg_replace_callback(&quot;@
+			(`+)		# $1 = Opening run of `
+			(.+?)		# $2 = The code block
+			(?&lt;!`)
+			\\1
+			(?!`)
+		@xs&quot;,
+		'_DoCodeSpans_callback', $text);
+
+	return $text;
+}
+function _DoCodeSpans_callback($matches) {
+	$c = $matches[2];
+	$c = preg_replace('/^[ \t]*/', '', $c); # leading whitespace
+	$c = preg_replace('/[ \t]*$/', '', $c); # trailing whitespace
+	$c = _EncodeCode($c);
+	return &quot;&lt;code&gt;$c&lt;/code&gt;&quot;;
+}
+
+
+function _EncodeCode($_) {
+#
+# Encode/escape certain characters inside Markdown code runs.
+# The point is that in code, these characters are literals,
+# and lose their special Markdown meanings.
+#
+	global $md_escape_table;
+
+	# Encode all ampersands; HTML entities are not
+	# entities within a Markdown code span.
+	$_ = str_replace('&amp;', '&amp;', $_);
+
+	# Do the angle bracket song and dance:
+	$_ = str_replace(array('&lt;',    '&gt;'), 
+					 array('&lt;', '&gt;'), $_);
+
+	# Now, escape characters that are magic in Markdown:
+	$_ = str_replace(array_keys($md_escape_table), 
+					 array_values($md_escape_table), $_);
+
+	return $_;
+}
+
+
+function _DoItalicsAndBold($text) {
+	# &lt;strong&gt; must go first:
+	$text = preg_replace('{ (\*\*|__) (?=\S) (.+?[*_]*) (?&lt;=\S) \1 }sx',
+		'&lt;strong&gt;\2&lt;/strong&gt;', $text);
+	# Then &lt;em&gt;:
+	$text = preg_replace('{ (\*|_) (?=\S) (.+?) (?&lt;=\S) \1 }sx',
+		'&lt;em&gt;\2&lt;/em&gt;', $text);
+
+	return $text;
+}
+
+
+function _DoBlockQuotes($text) {
+	$text = preg_replace_callback('/
+		  (								# Wrap whole match in $1
+			(
+			  ^[ \t]*&gt;[ \t]?			# &quot;&gt;&quot; at the start of a line
+				.+\n					# rest of the first line
+			  (.+\n)*					# subsequent consecutive lines
+			  \n*						# blanks
+			)+
+		  )
+		/xm',
+		'_DoBlockQuotes_callback', $text);
+
+	return $text;
+}
+function _DoBlockQuotes_callback($matches) {
+	$bq = $matches[1];
+	# trim one level of quoting - trim whitespace-only lines
+	$bq = preg_replace(array('/^[ \t]*&gt;[ \t]?/m', '/^[ \t]+$/m'), '', $bq);
+	$bq = _RunBlockGamut($bq);		# recurse
+
+	$bq = preg_replace('/^/m', &quot;  &quot;, $bq);
+	# These leading spaces screw with &lt;pre&gt; content, so we need to fix that:
+	$bq = preg_replace_callback('{(\s*&lt;pre&gt;.+?&lt;/pre&gt;)}sx', 
+								'_DoBlockQuotes_callback2', $bq);
+
+	return &quot;&lt;blockquote&gt;\n$bq\n&lt;/blockquote&gt;\n\n&quot;;
+}
+function _DoBlockQuotes_callback2($matches) {
+	$pre = $matches[1];
+	$pre = preg_replace('/^  /m', '', $pre);
+	return $pre;
+}
+
+
+function _FormParagraphs($text) {
+#
+#	Params:
+#		$text - string to process with html &lt;p&gt; tags
+#
+	global $md_html_blocks;
+
+	# Strip leading and trailing lines:
+	$text = preg_replace(array('/\A\n+/', '/\n+\z/'), '', $text);
+
+	$grafs = preg_split('/\n{2,}/', $text, -1, PREG_SPLIT_NO_EMPTY);
+
+	#
+	# Wrap &lt;p&gt; tags.
+	#
+	foreach ($grafs as $key =&gt; $value) {
+		if (!isset( $md_html_blocks[$value] )) {
+			$value = _RunSpanGamut($value);
+			$value = preg_replace('/^([ \t]*)/', '&lt;p&gt;', $value);
+			$value .= &quot;&lt;/p&gt;&quot;;
+			$grafs[$key] = $value;
+		}
+	}
+
+	#
+	# Unhashify HTML blocks
+	#
+	foreach ($grafs as $key =&gt; $value) {
+		if (isset( $md_html_blocks[$value] )) {
+			$grafs[$key] = $md_html_blocks[$value];
+		}
+	}
+
+	return implode(&quot;\n\n&quot;, $grafs);
+}
+
+
+function _EncodeAmpsAndAngles($text) {
+# Smart processing for ampersands and angle brackets that need to be encoded.
+
+	# Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
+	#   <A HREF="http://bumppo.net/projects/amputator/">http://bumppo.net/projects/amputator/</A>
+	$text = preg_replace('/&amp;(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/', 
+						 '&amp;', $text);;
+
+	# Encode naked &lt;'s
+	$text = preg_replace('{&lt;(?![a-z/?\$!])}i', '&lt;', $text);
+
+	return $text;
+}
+
+
+function _EncodeBackslashEscapes($text) {
+#
+#	Parameter:  String.
+#	Returns:    The string, with after processing the following backslash
+#				escape sequences.
+#
+	global $md_escape_table, $md_backslash_escape_table;
+	# Must process escaped backslashes first.
+	return str_replace(array_keys($md_backslash_escape_table),
+					   array_values($md_backslash_escape_table), $text);
+}
+
+
+function _DoAutoLinks($text) {
+	$text = preg_replace(&quot;!&lt;((https?|ftp):[^'\&quot;&gt;\\s]+)&gt;!&quot;, 
+						 '&lt;a href=&quot;\1&quot;&gt;\1&lt;/a&gt;', $text);
+
+	# Email addresses: &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">address at domain.foo</A>&gt;
+	$text = preg_replace('{
+		&lt;
+        (?:mailto:)?
+		(
+			[-.\w]+
+			\@
+			[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
+		)
+		&gt;
+		}exi',
+		&quot;_EncodeEmailAddress(_UnescapeSpecialChars(_UnslashQuotes('\\1')))&quot;,
+		$text);
+
+	return $text;
+}
+
+
+function _EncodeEmailAddress($addr) {
+#
+#	Input: an email address, e.g. &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">foo at example.com</A>&quot;
+#
+#	Output: the email address as a mailto link, with each character
+#		of the address encoded as either a decimal or hex entity, in
+#		the hopes of foiling most address harvesting spam bots. E.g.:
+#
+#	  &lt;a href=&quot;&amp;#x6D;&#97;&#105;&#108;&amp;#x74;&#111;:&#102;&#111;&#111;&#64;&#101;
+#		x&amp;#x61;&#109;&amp;#x70;&#108;&amp;#x65;&amp;#x2E;&#99;&#111;&#109;&quot;&gt;&#102;&#111;&#111;
+#		&#64;&#101;x&amp;#x61;&#109;&amp;#x70;&#108;&amp;#x65;&amp;#x2E;&#99;&#111;&#109;&lt;/a&gt;
+#
+#	Based by a filter by Matthew Wickline, posted to the BBEdit-Talk
+#	mailing list: &lt;<A HREF="http://tinyurl.com/yu7ue">http://tinyurl.com/yu7ue</A>&gt;
+#
+	$addr = &quot;mailto:&quot; . $addr;
+	$length = strlen($addr);
+
+	# leave ':' alone (to spot mailto: later)
+	$addr = preg_replace_callback('/([^\:])/', 
+								  '_EncodeEmailAddress_callback', $addr);
+
+	$addr = &quot;&lt;a href=\&quot;$addr\&quot;&gt;$addr&lt;/a&gt;&quot;;
+	# strip the mailto: from the visible part
+	$addr = preg_replace('/&quot;&gt;.+?:/', '&quot;&gt;', $addr);
+
+	return $addr;
+}
+function _EncodeEmailAddress_callback($matches) {
+	$char = $matches[1];
+	$r = rand(0, 100);
+	# roughly 10% raw, 45% hex, 45% dec
+	# '@' *must* be encoded. I insist.
+	if ($r &gt; 90 &amp;&amp; $char != '@') return $char;
+	if ($r &lt; 45) return '&amp;#x'.dechex(ord($char)).';';
+	return '&amp;#'.ord($char).';';
+}
+
+
+function _UnescapeSpecialChars($text) {
+#
+# Swap back in all the special characters we've hidden.
+#
+	global $md_escape_table;
+	return str_replace(array_values($md_escape_table), 
+					   array_keys($md_escape_table), $text);
+}
+
+
+# _TokenizeHTML is shared between PHP Markdown and PHP SmartyPants.
+# We only define it if it is not already defined.
+if (!function_exists('_TokenizeHTML')) :
+function _TokenizeHTML($str) {
+#
+#   Parameter:  String containing HTML markup.
+#   Returns:    An array of the tokens comprising the input
+#               string. Each token is either a tag (possibly with nested,
+#               tags contained therein, such as &lt;a href=&quot;&lt;MTFoo&gt;&quot;&gt;, or a
+#               run of text between tags. Each element of the array is a
+#               two-element array; the first is either 'tag' or 'text';
+#               the second is the actual value.
+#
+#
+#   Regular expression derived from the _tokenize() subroutine in 
+#   Brad Choate's MTRegex plugin.
+#   &lt;<A HREF="http://www.bradchoate.com/past/mtregex.php">http://www.bradchoate.com/past/mtregex.php</A>&gt;
+#
+	$index = 0;
+	$tokens = array();
+
+	$match = '(?s:&lt;!(?:--.*?--\s*)+&gt;)|'.	# comment
+			 '(?s:&lt;\?.*?\?&gt;)|'.				# processing instruction
+			 '(?:&lt;/?[\w:$]+\b(?&gt;[^&quot;\'&gt;]+|&quot;[^&quot;]*&quot;|\'[^\']*\')*&gt;)'; # regular tags
+
+	$parts = preg_split(&quot;{($match)}&quot;, $str, -1, PREG_SPLIT_DELIM_CAPTURE);
+
+	foreach ($parts as $part) {
+		if (++$index % 2 &amp;&amp; $part != '') 
+			array_push($tokens, array('text', $part));
+		else
+			array_push($tokens, array('tag', $part));
+	}
+
+	return $tokens;
+}
+endif;
+
+
+function _Outdent($text) {
+#
+# Remove one level of line-leading tabs or spaces
+#
+	global $md_tab_width;
+	return preg_replace(&quot;/^(\\t|[ ]{1,$md_tab_width})/m&quot;, &quot;&quot;, $text);
+}
+
+
+function _Detab($text) {
+#
+# Replace tabs with the appropriate amount of space.
+#
+	global $md_tab_width;
+
+	# For each line we separate the line in blocks delemited by
+	# tab characters. Then we reconstruct the line adding the appropriate
+	# number of space charcters.
+	
+	$lines = explode(&quot;\n&quot;, $text);
+	$text = &quot;&quot;;
+	
+	foreach ($lines as $line) {
+		# Split in blocks.
+		$blocks = explode(&quot;\t&quot;, $line);
+		# Add each blocks to the line.
+		$line = $blocks[0];
+		unset($blocks[0]); # Do not add first block twice.
+		foreach ($blocks as $block) {
+			# Calculate amount of space, insert spaces, insert block.
+			$amount = $md_tab_width - strlen($line) % $md_tab_width;
+			$line .= str_repeat(&quot; &quot;, $amount) . $block;
+		}
+		$text .= &quot;$line\n&quot;;
+	}
+	return $text;
+}
+
+
+function _UnslashQuotes($text) {
+#
+#	This function is useful to remove automaticaly slashed double quotes
+#	when using preg_replace and evaluating an expression.
+#	Parameter:  String.
+#	Returns:    The string with any slash-double-quote (\&quot;) sequence replaced
+#				by a single double quote.
+#
+	return str_replace('\&quot;', '&quot;', $text);
+}
+
+
+/*
+
+PHP Markdown
+============
+
+Description
+-----------
+
+This is a PHP translation of the original Markdown formatter written in
+Perl by John Gruber.
+
+Markdown is a text-to-HTML filter; it translates an easy-to-read /
+easy-to-write structured text format into HTML. Markdown's text format
+is most similar to that of plain text email, and supports features such
+as headers, *emphasis*, code blocks, blockquotes, and links.
+
+Markdown's syntax is designed not as a generic markup language, but
+specifically to serve as a front-end to (X)HTML. You can use span-level
+HTML tags anywhere in a Markdown document, and you can use block level
+HTML tags (like &lt;div&gt; and &lt;table&gt; as well).
+
+For more information about Markdown's syntax, see:
+
+&lt;<A HREF="http://daringfireball.net/projects/markdown/">http://daringfireball.net/projects/markdown/</A>&gt;
+
+
+Bugs
+----
+
+To file bug reports please send email to:
+
+&lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">michel.fortin at michelf.com</A>&gt;
+
+Please include with your report: (1) the example input; (2) the output you
+expected; (3) the output Markdown actually produced.
+
+
+Version History
+--------------- 
+
+See the readme file for detailed release notes for this version.
+
+1.0.1 - 17 Dec 2004
+
+1.0 - 21 Aug 2004
+
+
+Author &amp; Contributors
+---------------------
+
+Original Perl version by John Gruber  
+&lt;<A HREF="http://daringfireball.net/">http://daringfireball.net/</A>&gt;
+
+PHP port and other contributions by Michel Fortin  
+&lt;<A HREF="http://www.michelf.com/">http://www.michelf.com/</A>&gt;
+
+
+Copyright and License
+---------------------
+
+Copyright (c) 2004 Michel Fortin  
+&lt;<A HREF="http://www.michelf.com/">http://www.michelf.com/</A>&gt;  
+All rights reserved.
+
+Copyright (c) 2003-2004 John Gruber   
+&lt;<A HREF="http://daringfireball.net/">http://daringfireball.net/</A>&gt;   
+All rights reserved.
+
+Redistribution and use in source and binary forms, with or without
+modification, are permitted provided that the following conditions are
+met:
+
+*	Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+*	Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+*	Neither the name &quot;Markdown&quot; nor the names of its contributors may
+	be used to endorse or promote products derived from this software
+	without specific prior written permission.
+
+This software is provided by the copyright holders and contributors &quot;as
+is&quot; and any express or implied warranties, including, but not limited
+to, the implied warranties of merchantability and fitness for a
+particular purpose are disclaimed. In no event shall the copyright owner
+or contributors be liable for any direct, indirect, incidental, special,
+exemplary, or consequential damages (including, but not limited to,
+procurement of substitute goods or services; loss of use, data, or
+profits; or business interruption) however caused and on any theory of
+liability, whether in contract, strict liability, or tort (including
+negligence or otherwise) arising in any way out of the use of this
+software, even if advised of the possibility of such damage.
+
+*/
+?&gt;
\ No newline at end of file

Added: trunk/wp-content/plugins/textile1.php
===================================================================
--- trunk/wp-content/plugins/textile1.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/plugins/textile1.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,390 @@
+&lt;?php
+/*
+Plugin Name: Textile 1
+Version: 1.0
+Plugin URI: <A HREF="http://www.huddledmasses.org/">http://www.huddledmasses.org/</A>
+Description: This is a simple wrapper for &lt;a href=&quot;<A HREF="http://textism.com/?wp">http://textism.com/?wp</A>&quot;&gt;Dean Allen's&lt;/a&gt; Humane Web Text Generator, also known as &lt;a href=&quot;<A HREF="http://www.textism.com/tools/textile/">http://www.textism.com/tools/textile/</A>&quot;&gt;Textile&lt;/a&gt;. If you use this plugin you should disable Textile 2 and Markdown, as they don't play well together.
+Author: Dean Allen
+Author URI: <A HREF="http://www.textism.com/?wp">http://www.textism.com/?wp</A>
+*/
+
+/*
+
+This is Textile
+A Humane Web Text Generator
+
+Version 1.0
+21 Feb, 2003
+
+Copyright (c) 2003, Dean Allen, www.textism.com
+All rights reserved.
+
+_______
+LICENSE
+
+Redistribution and use in source and binary forms, with or without
+modification, are permitted provided that the following conditions are met:
+
+* Redistributions of source code must retain the above copyright notice,
+  this list of conditions and the following disclaimer.
+
+* Redistributions in binary form must reproduce the above copyright notice,
+  this list of conditions and the following disclaimer in the documentation
+  and/or other materials provided with the distribution.
+
+* Neither the name Textile nor the names of its contributors may be used to
+  endorse or promote products derived from this software without specific
+  prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
+AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
+LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGE.
+
+*/
+
+
+	function textile($text) {
+	$text = stripslashes($text);
+
+	$text = preg_replace(&quot;/&amp;(?![#a-zA-Z0-9]+;)/&quot;,&quot;x%x%&quot;,$text);
+
+	if (function_exists('mb_encode_numericentity')) {
+		$text = encode_high($text);
+	} else {
+		$text = htmlentities($text,ENT_NOQUOTES,&quot;utf-8&quot;);
+	}
+
+	$text = str_replace(array(&quot;&gt;&quot;, &quot;&lt;&quot;, &quot;&amp;&quot;), array(&quot;&gt;&quot;, &quot;&lt;&quot;, &quot;&amp;&quot;), $text);
+
+	$text = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, $text);
+
+	$text = str_replace(&quot;\t&quot;, &quot;&quot;, $text);
+
+	$text = preg_split(&quot;/\n/&quot;,$text);
+	foreach($text as $line){
+		$line = rtrim($line);
+		$lineout[] = $line;
+	}
+
+	$text = implode(&quot;\n&quot;,$lineout);
+
+	$text = preg_replace('/(^|\s)==(.*)==(\s|$)?/msU','$1&lt;notextile&gt;$2&lt;/notextile&gt;$3',$text);
+
+	$text = preg_replace('/!([^\s\(=]+)\s?(?:\(([^\)]+)\))?!(\s)?/mU','&lt;img src=&quot;$1&quot; alt=&quot;$2&quot; border=&quot;0&quot; /&gt;$3',$text);
+
+	$text = preg_replace('/(&lt;img.+ \/&gt;):(\S+)(\s)/U','&lt;a href=&quot;$2&quot;&gt;$1&lt;/a&gt;$3',$text);
+
+	$text = preg_replace(
+		'/
+		([\s[{(]|[[:punct:]])?		# 1 optional space or brackets before
+		&quot;							#   starting &quot;
+		([^&quot;\(]+)					# 2 text of link
+		\s?							#   opt space
+		(?:\(([^\(]*)\))?			# 3 opt title attribute in parenths
+		&quot;:							#   dividing &quot;:
+		(\S+\b)						# 4 suppose this is the url
+		(\/)?						# 5 opt trailing slash
+		([^[:alnum:]\/;]*)			# 6 opt punctuation after the url
+		(\s|$)						# 7 either white space or end of string
+		/x',
+		'$1&lt;a href=&quot;$4$5&quot; title=&quot;$3&quot;&gt;$2&lt;/a&gt;$6$7',$text);
+
+	$qtags = array(
+		'\*\*'=&gt;'b',
+		'\*'=&gt;'strong',
+		'\?\?'=&gt;'cite',
+		'-'=&gt;'del',
+		'\+'=&gt;'ins',
+		'~'=&gt;'sub',
+		'@'=&gt;'code');
+
+	foreach($qtags as $f=&gt;$r){
+		$text = preg_replace(
+			'/(^|\s|&gt;)'.$f.'\b(.+)\b([[:punct:]]*)'.$f.'([[:punct:]]{0,2})(\s|$)?/mU',
+			'$1&lt;'.$r.'&gt;$2$3&lt;/'.$r.'&gt;$4$5',
+			$text);
+	}
+
+	$text = preg_replace('/(^|\s)__(.*)__([[:punct:]]{0,2})(\s|$)?/mU','$1&lt;i&gt;$2&lt;/i&gt;$3$4',$text);
+	$text = preg_replace('/(^|\s)_(.*)_([[:punct:]]{0,2})(\s|$)?/mU','$1&lt;em&gt;$2&lt;/em&gt;$3$4',$text);
+
+	$text = preg_replace('/\^(.*)\^/mU','&lt;sup&gt;$1&lt;/sup&gt;',$text);
+
+	$text = preg_replace('/&quot;$/',&quot;\&quot; &quot;, $text);
+	$glyph_search = array(
+		'/([^\s[{(&gt;])?\'(?(1)|(?=\s|s\b))/',					# single closing
+		'/\'/',													# single opening
+		'/([^\s[{(])?&quot;(?(1)|(?=\s))/',							# double closing
+		'/&quot;/',													# double opening
+		'/\b( )?\.{3}/',										# ellipsis
+		'/\b([A-Z][A-Z0-9]{2,})\b(?:[(]([^)]*)[)])/',			# 3+ uppercase acronym
+		'/(^|[^&quot;][&gt;\s])([A-Z][A-Z0-9 ]{2,})([^&lt;a-z0-9]|$)/',	# 3+ uppercase caps
+		'/\s?--\s?/',											# em dash
+		'/\s-\s/',												# en dash
+		'/(\d+) ?x ?(\d+)/',									# dimension sign
+		'/\b ?[([]TM[])]/i',									# trademark
+		'/\b ?[([]R[])]/i',										# registered
+		'/\b ?[([]C[])]/i');									# copyright
+
+	$glyph_replace = array(
+		'$1&#8217;$2',							# single closing
+		'&#8216;',								# single opening
+		'$1&#8221;',							# double closing
+		'&#8220;',								# double opening
+		'$1&#8230;',							# ellipsis
+		'&lt;acronym title=&quot;$2&quot;&gt;$1&lt;/acronym&gt;',		# 3+ uppercase acronym
+		'$1&lt;span class=&quot;caps&quot;&gt;$2&lt;/span&gt;$3',		# 3+ uppercase caps
+		'&#8212;',								# em dash
+		' &#8211; ',							# en dash
+		'$1&#215;$2',							# dimension sign
+		'&#8482;',								# trademark
+		'&#174;',								# registered
+		'&#169;');								# copyright
+
+	$codepre = false;
+
+	if(!preg_match(&quot;/&lt;.*&gt;/&quot;,$text)){
+		$text = preg_replace($glyph_search,$glyph_replace,$text);
+	} else {
+
+		$text = preg_split(&quot;/(&lt;.*&gt;)/U&quot;,$text,-1,PREG_SPLIT_DELIM_CAPTURE);
+			foreach($text as $line){
+
+					# matches are off if we're between &lt;code&gt;, &lt;pre&gt; etc.
+				if(preg_match('/&lt;(code|pre|kbd|notextile)&gt;/i',$line)){$codepre = true; }
+				if(preg_match('/&lt;\/(code|pre|kbd|notextile)&gt;/i',$line)){$codepre = false; }
+
+				if(!preg_match(&quot;/&lt;.*&gt;/&quot;,$line) &amp;&amp; $codepre == false){
+					$line = preg_replace($glyph_search,$glyph_replace,$line);
+				}
+
+				# convert htmlspecial if between &lt;code&gt;
+				if ($codepre == true){
+					$line = htmlspecialchars($line,ENT_NOQUOTES,&quot;UTF-8&quot;);
+					$line = str_replace(&quot;&lt;pre&gt;&quot;,&quot;&lt;pre&gt;&quot;,$line);
+					$line = str_replace(&quot;&lt;code&gt;&quot;,&quot;&lt;code&gt;&quot;,$line);
+					$line = str_replace(&quot;&lt;notextile&gt;&quot;,&quot;&lt;notextile&gt;&quot;,$line);
+					$line = str_replace(&quot;&lt;kbd&gt;&quot;,&quot;&lt;kbd&gt;&quot;,$line);
+				}
+
+				# each line gets pushed to a new array
+			$glyph_out[] = $line;
+		}
+			# $text is now the new array, cast to a string
+		$text = implode('',$glyph_out);
+	}
+
+	$text = preg_replace(&quot;/(\S)(_*)([[:punct:]]*) *\n([^#*\s])/&quot;, &quot;$1$2$3&lt;br /&gt;$4&quot;, $text);
+
+	$text = str_replace(&quot;l&gt;&lt;br /&gt;&quot;, &quot;l&gt;\n&quot;, $text);
+
+	$text = preg_split(&quot;/\n/&quot;,$text);
+
+	array_push($text,&quot; &quot;);
+
+			$list = '';
+			$pre = false;
+
+			$block_find = array(
+				'/^\s?\*\s(.*)/',						# bulleted list *
+				'/^\s?#\s(.*)/',						# numeric list #
+				'/^bq\. (.*)/',							# blockquote bq.
+				'/^h(\d)\(([[:alnum:]]+)\)\.\s(.*)/',	# header hn(class).  w/ css class
+				'/^h(\d)\. (.*)/',						# plain header hn.
+				'/^p\(([[:alnum:]]+)\)\.\s(.*)/',		# para p(class).  w/ css class
+				'/^p\. (.*)/i',	 						# plain paragraph
+				'/^([^\t ]+.*)/i'						# remaining plain paragraph
+				);
+
+			$block_replace = array(
+				&quot;\t\t&lt;li&gt;$1&lt;/li&gt;&quot;,
+				&quot;\t\t\t&lt;li&gt;$1&lt;/li&gt;&quot;,
+				&quot;\t&lt;blockquote&gt;$1&lt;/blockquote&gt;&quot;,
+				&quot;\t&lt;h$1 class=\&quot;$2\&quot;&gt;$3&lt;/h$1&gt;$4&quot;,
+				&quot;\t&lt;h$1&gt;$2&lt;/h$1&gt;$3&quot;,
+				&quot;\t&lt;p class=\&quot;$1\&quot;&gt;$2&lt;/p&gt;$3&quot;,
+				&quot;\t&lt;p&gt;$1&lt;/p&gt;&quot;,
+				&quot;\t&lt;p&gt;$1&lt;/p&gt;$2&quot;
+				);
+
+	foreach($text as $line){
+
+			if(preg_match('/&lt;pre&gt;/i',$line)){$pre = true; }
+
+			if ($pre == false){
+				$line = preg_replace($block_find,$block_replace,$line);
+			}
+
+			if ($pre == true){
+				$line = str_replace(&quot;&lt;br /&gt;&quot;,&quot;\n&quot;,$line);
+			}
+				if(preg_match('/&lt;\/pre&gt;/i',$line)){$pre = false; }
+
+			if ($list == '' &amp;&amp; preg_match('/^\t\t&lt;li&gt;/',$line)){
+					$list = &quot;ul&quot;;
+				$line = preg_replace('/^(\t\t&lt;li&gt;.*)/',&quot;\t&lt;ul&gt;\n$1&quot;,$line);
+
+			} else if ($list == '' &amp;&amp; preg_match('/^\t\t\t&lt;li&gt;/',$line)){
+					$list = &quot;ol&quot;;
+				$line = preg_replace('/^\t(\t\t&lt;li&gt;.*)/',&quot;\t&lt;ol&gt;\n$1&quot;,$line);
+
+			# at the end of a ul
+			} else if ($list == 'ul' &amp;&amp; !preg_match('/^\t\t&lt;li&gt;/',$line)){
+					$list = '';
+				$line = preg_replace('/^(.*)$/',&quot;\t&lt;/ul&gt;\n$1&quot;,$line);
+
+			# at the end of a ol
+			} else if ($list == 'ol' &amp;&amp; !preg_match('/^\t\t\t&lt;li&gt;/',$line)){
+					$list = '';
+				$line = preg_replace('/^(.*)$/',&quot;\t&lt;/ol&gt;\n$1&quot;,$line);
+			}
+
+			$block_out[] = $line;
+	}
+	$text = implode(&quot;\n&quot;,$block_out);
+	$text = preg_replace('/&lt;\/?notextile&gt;/', &quot;&quot;,$text);
+	$text = str_replace(&quot;x%x%&quot;,&quot;&#38;&quot;,$text);
+	$text = str_replace(&quot;&lt;br /&gt;&quot;,&quot;&lt;br /&gt;\n&quot;,$text);
+	return $text;
+}
+
+function callback_url($text,$title='',$url) {
+		$out = 'a href=&quot;'.$url.'&quot;';
+		$out.=($title!='')?' title=&quot;'.$title.'&quot;':'';
+		$out.='&gt;$text&lt;/a&gt;';
+		return $out;
+	}
+
+
+
+function textile_popup_help($name,$helpvar,$windowW,$windowH) {
+	$out = $name;
+	$out .= ' &lt;a target=&quot;_blank&quot; href=&quot;<A HREF="http://www.textpattern.com/help/?item=">http://www.textpattern.com/help/?item=</A>'.$helpvar.'&quot;';
+	$out .= ' onclick=&quot;window.open(this.href, \'popupwindow\', \'width='.$windowW.',height='.$windowH.',scrollbars,resizable\'); return false;&quot; style=&quot;color:blue;background-color:#ddd&quot;&gt;?&lt;/a&gt;&lt;br /&gt;';
+	print $out;
+}
+
+
+function encode_high($text) {
+	$cmap = cmap();
+	return mb_encode_numericentity($text, $cmap, &quot;UTF-8&quot;);
+}
+
+
+function decode_high($text) {
+	$cmap = cmap();
+	return mb_decode_numericentity($text, $cmap, &quot;UTF-8&quot;);
+}
+
+
+function cmap() {
+
+	$f = 0xffff;
+
+	$cmap = array(
+	 160,  255,  0, $f,
+	 402,  402,  0, $f,
+	 913,  929,  0, $f,
+	 931,  937,  0, $f,
+	 945,  969,  0, $f,
+	 977,  978,  0, $f,
+	 982,  982,  0, $f,
+	 8226, 8226, 0, $f,
+	 8230, 8230, 0, $f,
+	 8242, 8243, 0, $f,
+	 8254, 8254, 0, $f,
+	 8260, 8260, 0, $f,
+	 8465, 8465, 0, $f,
+	 8472, 8472, 0, $f,
+	 8476, 8476, 0, $f,
+	 8482, 8482, 0, $f,
+	 8501, 8501, 0, $f,
+	 8592, 8596, 0, $f,
+	 8629, 8629, 0, $f,
+	 8656, 8660, 0, $f,
+	 8704, 8704, 0, $f,
+	 8706, 8707, 0, $f,
+	 8709, 8709, 0, $f,
+	 8711, 8713, 0, $f,
+	 8715, 8715, 0, $f,
+	 8719, 8719, 0, $f,
+	 8721, 8722, 0, $f,
+	 8727, 8727, 0, $f,
+	 8730, 8730, 0, $f,
+	 8733, 8734, 0, $f,
+	 8736, 8736, 0, $f,
+	 8743, 8747, 0, $f,
+	 8756, 8756, 0, $f,
+	 8764, 8764, 0, $f,
+	 8773, 8773, 0, $f,
+	 8776, 8776, 0, $f,
+	 8800, 8801, 0, $f,
+	 8804, 8805, 0, $f,
+	 8834, 8836, 0, $f,
+	 8838, 8839, 0, $f,
+	 8853, 8853, 0, $f,
+	 8855, 8855, 0, $f,
+	 8869, 8869, 0, $f,
+	 8901, 8901, 0, $f,
+	 8968, 8971, 0, $f,
+	 9001, 9002, 0, $f,
+	 9674, 9674, 0, $f,
+	 9824, 9824, 0, $f,
+	 9827, 9827, 0, $f,
+	 9829, 9830, 0, $f,
+	 338,  339,  0, $f,
+	 352,  353,  0, $f,
+	 376,  376,  0, $f,
+	 710,  710,  0, $f,
+	 732,  732,  0, $f,
+	 8194, 8195, 0, $f,
+	 8201, 8201, 0, $f,
+	 8204, 8207, 0, $f,
+	 8211, 8212, 0, $f,
+	 8216, 8218, 0, $f,
+	 8218, 8218, 0, $f,
+	 8220, 8222, 0, $f,
+	 8224, 8225, 0, $f,
+	 8240, 8240, 0, $f,
+	 8249, 8250, 0, $f,
+	 8364, 8364, 0, $f
+	 );
+
+	return $cmap;
+}
+
+
+function linkit($text,$title,$url){
+    $url = preg_replace(&quot;/&amp;(?!amp;)/&quot;,&quot;&amp;&quot;,$url);
+    $out = '&lt;a href=&quot;'.$url;
+    if ($title!='') {
+		$title = trim($title);
+        $out .= ' title=&quot;'.$title;
+    }
+    $out .= '&gt;'.$text.'&lt;/a&gt;';
+
+    return $out;
+}
+
+// And now for the filters
+remove_filter('the_content', 'wpautop');
+remove_filter('the_excerpt', 'wpautop');
+remove_filter('comment_text', 'wpautop');
+
+remove_filter('the_content', 'wptexturize');
+remove_filter('the_excerpt', 'wptexturize');
+remove_filter('comment_text', 'wptexturize');
+
+add_filter('the_content', 'textile', 6);
+add_filter('the_excerpt', 'textile', 6);
+add_filter('comment_text', 'textile', 6);
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/404.php
===================================================================
--- trunk/wp-content/themes/Steam/404.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/404.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,11 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Error 404 - Not Found&lt;/h2&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/archive.php
===================================================================
--- trunk/wp-content/themes/Steam/archive.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/archive.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,68 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;?php if (have_posts()) : ?&gt;
+
+		 &lt;?php $post = $posts[0]; // Hack. Set $post so that the_date() works. ?&gt;
+&lt;?php /* If this is a category archive */ if (is_category()) { ?&gt;				
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for the '&lt;?php echo single_cat_title(); ?&gt;' Category&lt;/h2&gt;
+		
+ 	  &lt;?php /* If this is a daily archive */ } elseif (is_day()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F jS, Y'); ?&gt;&lt;/h2&gt;
+		
+	 &lt;?php /* If this is a monthly archive */ } elseif (is_month()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F, Y'); ?&gt;&lt;/h2&gt;
+
+		&lt;?php /* If this is a yearly archive */ } elseif (is_year()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('Y'); ?&gt;&lt;/h2&gt;
+		
+	  &lt;?php /* If this is a search */ } elseif (is_search()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+	  &lt;?php /* If this is an author archive */ } elseif (is_author()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Author Archive&lt;/h2&gt;
+
+		&lt;?php /* If this is a paged archive */ } elseif (isset($_GET['paged']) &amp;&amp; !empty($_GET['paged'])) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Blog Archives&lt;/h2&gt;
+
+		&lt;?php } ?&gt;
+
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt; 
+
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/archives.php
===================================================================
--- trunk/wp-content/themes/Steam/archives.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/archives.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,25 @@
+&lt;?php
+/*
+Template Name: Archives
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+&lt;h2&gt;Archives by Month:&lt;/h2&gt;
+  &lt;ul&gt;
+    &lt;?php wp_get_archives('type=monthly'); ?&gt;
+  &lt;/ul&gt;
+
+&lt;h2&gt;Archives by Subject:&lt;/h2&gt;
+  &lt;ul&gt;
+     &lt;?php wp_list_cats(); ?&gt;
+  &lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Steam/comments-popup.php
===================================================================
--- trunk/wp-content/themes/Steam/comments-popup.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/comments-popup.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,113 @@
+&lt;?php 
+/* Don't remove these lines. */
+add_filter('comment_text', 'popuplinks');
+foreach ($posts as $post) { start_wp();
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+     &lt;title&gt;&lt;?php echo get_settings('blogname'); ?&gt; - Comments on &lt;?php the_title(); ?&gt;&lt;/title&gt;
+
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+	&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+		@import url( &lt;?php bloginfo('stylesheet_url'); ?&gt; );
+		body { margin: 3px; }
+	&lt;/style&gt;
+
+&lt;/head&gt;
+&lt;body id=&quot;commentspopup&quot;&gt;
+
+&lt;h1 id=&quot;header&quot;&gt;&lt;a href=&quot;&quot; title=&quot;&lt;?php echo get_settings('blogname'); ?&gt;&quot;&gt;&lt;?php echo get_settings('blogname'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+
+&lt;h2 id=&quot;comments&quot;&gt;Comments&lt;/h2&gt;
+
+&lt;p&gt;&lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-commentsrss2.php?p=&lt;?php echo $post-&gt;ID; ?&gt;&quot;&gt;&lt;abbr title=&quot;Really Simple Syndication&quot;&gt;RSS&lt;/abbr&gt; feed for comments on this post.&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php if ('open' == $post-&gt;ping_status) { ?&gt;
+&lt;p&gt;The &lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt; to TrackBack this entry is: &lt;em&gt;&lt;?php trackback_url() ?&gt;&lt;/em&gt;&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php
+// this line is WordPress' motor, do not delete it.
+$comment_author = (isset($_COOKIE['comment_author_' . COOKIEHASH])) ? trim($_COOKIE['comment_author_'. COOKIEHASH]) : '';
+$comment_author_email = (isset($_COOKIE['comment_author_email_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_email_'. COOKIEHASH]) : '';
+$comment_author_url = (isset($_COOKIE['comment_author_url_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_url_'. COOKIEHASH]) : '';
+$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = $id AND comment_approved = '1' ORDER BY comment_date&quot;);
+$commentstatus = $wpdb-&gt;get_row(&quot;SELECT comment_status, post_password FROM $wpdb-&gt;posts WHERE ID = $id&quot;);
+if (!empty($commentstatus-&gt;post_password) &amp;&amp; $_COOKIE['wp-postpass_'. COOKIEHASH] != $commentstatus-&gt;post_password) {  // and it doesn't match the cookie
+	echo(get_the_password_form());
+} else { ?&gt;
+
+&lt;?php if ($comments) { ?&gt;
+&lt;ol id=&quot;commentlist&quot;&gt;
+&lt;?php foreach ($comments as $comment) { ?&gt;
+	&lt;li id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+	&lt;?php comment_text() ?&gt;
+	&lt;p&gt;&lt;cite&gt;&lt;?php comment_type('Comment', 'Trackback', 'Pingback'); ?&gt; by &lt;?php comment_author_link() ?&gt; &#8212; &lt;?php comment_date() ?&gt; @ &lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot;&gt;&lt;?php comment_time() ?&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+	&lt;/li&gt;
+
+&lt;?php } // end for each comment ?&gt;
+&lt;/ol&gt;
+&lt;?php } else { // this is displayed if there are no comments so far ?&gt;
+	&lt;p&gt;No comments yet.&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php if ('open' == $commentstatus-&gt;comment_status) { ?&gt;
+&lt;h2&gt;Leave a comment&lt;/h2&gt;
+&lt;p&gt;Line and paragraph breaks automatic, e-mail address never displayed, &lt;acronym title=&quot;Hypertext Markup Language&quot;&gt;HTML&lt;/acronym&gt; allowed: &lt;code&gt;&lt;?php echo allowed_tags(); ?&gt;&lt;/code&gt;&lt;/p&gt;
+
+&lt;form action=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; class=&quot;textarea&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;1&quot; /&gt;
+	   &lt;label for=&quot;author&quot;&gt;Name&lt;/label&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;redirect_to&quot; value=&quot;&lt;?php echo wp_specialchars($_SERVER[&quot;REQUEST_URI&quot;]); ?&gt;&quot; /&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;2&quot; /&gt;
+	   &lt;label for=&quot;email&quot;&gt;E-mail&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;3&quot; /&gt;
+	   &lt;label for=&quot;url&quot;&gt;&lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt;&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;label for=&quot;comment&quot;&gt;Your Comment&lt;/label&gt;
+	&lt;br /&gt;
+	  &lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;70&quot; rows=&quot;4&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input name=&quot;submit&quot; type=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Say It!&quot; /&gt;
+	&lt;/p&gt;
+	&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+&lt;/form&gt;
+&lt;?php } else { // comments are closed ?&gt;
+&lt;p&gt;Sorry, the comment form is closed at this time.&lt;/p&gt;
+&lt;?php }
+} // end password check
+?&gt;
+
+&lt;div&gt;&lt;strong&gt;&lt;a href=&quot;javascript:window.close()&quot;&gt;Close this window.&lt;/a&gt;&lt;/strong&gt;&lt;/div&gt;
+
+&lt;?php // if you delete this the sky will fall on your head
+}
+?&gt;
+
+&lt;!-- // this is just the end of the motor - don't touch that line either :) --&gt;
+&lt;?php //} ?&gt; 
+&lt;p class=&quot;credit&quot;&gt;&lt;?php timer_stop(1); ?&gt; &lt;cite&gt;Powered by &lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot; title=&quot;Powered by WordPress, state-of-the-art semantic personal publishing platform&quot;&gt;&lt;strong&gt;Wordpress&lt;/strong&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+&lt;?php // Seen at <A HREF="http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18">http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18</A>) ?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+document.onkeypress = function esc(e) {	
+	if(typeof(e) == &quot;undefined&quot;) { e=event; }
+	if (e.keyCode == 27) { self.close(); }
+}
+// --&gt;
+&lt;/script&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-content/themes/Steam/comments.php
===================================================================
--- trunk/wp-content/themes/Steam/comments.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/comments.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,104 @@
+&lt;?php // Do not delete these lines
+	if ('comments.php' == basename($_SERVER['SCRIPT_FILENAME']))
+		die ('Please do not load this page directly. Thanks!');
+
+        if (!empty($post-&gt;post_password)) { // if there's a password
+            if ($_COOKIE['wp-postpass_' . COOKIEHASH] != $post-&gt;post_password) {  // and it doesn't match the cookie
+				?&gt;
+				
+				&lt;p class=&quot;nocomments&quot;&gt;This post is password protected. Enter the password to view comments.&lt;p&gt;
+				
+				&lt;?php
+				return;
+            }
+        }
+
+		/* This variable is for alternating comment background */
+		$oddcomment = 'alt';
+?&gt;
+
+&lt;!-- You can start editing here. --&gt;
+
+&lt;?php if ($comments) : ?&gt;
+	&lt;h3 id=&quot;comments&quot;&gt;&lt;?php comments_number('No Responses', 'One Response', '% Responses' );?&gt; to &#8220;&lt;?php the_title(); ?&gt;&#8221;&lt;/h3&gt; 
+
+	&lt;ol class=&quot;commentlist&quot;&gt;
+
+	&lt;?php foreach ($comments as $comment) : ?&gt;
+
+		&lt;li class=&quot;&lt;?php echo $oddcomment; ?&gt;&quot; id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+			&lt;cite&gt;&lt;?php comment_author_link() ?&gt;&lt;/cite&gt; Says:
+			&lt;?php if ($comment-&gt;comment_approved == '0') : ?&gt;
+			&lt;em&gt;Your comment is awaiting moderation.&lt;/em&gt;
+			&lt;?php endif; ?&gt;
+			&lt;br /&gt;
+
+			&lt;small class=&quot;commentmetadata&quot;&gt;&lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot; title=&quot;&quot;&gt;&lt;?php comment_date('F jS, Y') ?&gt; at &lt;?php comment_time() ?&gt;&lt;/a&gt; &lt;?php edit_comment_link('e','',''); ?&gt;&lt;/small&gt;
+
+			&lt;?php comment_text() ?&gt;
+
+		&lt;/li&gt;
+
+	&lt;?php /* Changes every other comment to a different class */	
+		if ('alt' == $oddcomment) $oddcomment = '';
+		else $oddcomment = 'alt';
+	?&gt;
+
+	&lt;?php endforeach; /* end for each comment */ ?&gt;
+
+	&lt;/ol&gt;
+
+ &lt;?php else : // this is displayed if there are no comments so far ?&gt;
+
+  &lt;?php if ('open' == $post-&gt;comment_status) : ?&gt; 
+		&lt;!-- If comments are open, but there are no comments. --&gt;
+		
+	 &lt;?php else : // comments are closed ?&gt;
+		&lt;!-- If comments are closed. --&gt;
+		&lt;p class=&quot;nocomments&quot;&gt;Comments are closed.&lt;/p&gt;
+		
+	&lt;?php endif; ?&gt;
+&lt;?php endif; ?&gt;
+
+
+&lt;?php if ('open' == $post-&gt;comment_status) : ?&gt;
+
+&lt;h3 id=&quot;respond&quot;&gt;Leave a Reply&lt;/h3&gt;
+
+&lt;?php if ( get_option('comment_registration') &amp;&amp; !$user_ID ) : ?&gt;
+&lt;p&gt;You must be &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?redirect_to=&lt;?php the_permalink(); ?&gt;&quot;&gt;logged in&lt;/a&gt; to post a comment.&lt;/p&gt;
+&lt;?php else : ?&gt;
+
+&lt;form action=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+
+&lt;?php if ( $user_ID ) : ?&gt;
+
+&lt;p&gt;Logged in as &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-admin/profile.php&quot;&gt;&lt;?php echo $user_identity; ?&gt;&lt;/a&gt;. &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?action=logout&quot; title=&quot;Log out of this account&quot;&gt;Logout &raquo;&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php else : ?&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;1&quot; /&gt;
+&lt;label for=&quot;author&quot;&gt;&lt;small&gt;Name &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;2&quot; /&gt;
+&lt;label for=&quot;email&quot;&gt;&lt;small&gt;Mail (will not be published) &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;3&quot; /&gt;
+&lt;label for=&quot;url&quot;&gt;&lt;small&gt;Website&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;?php endif; ?&gt;
+
+&lt;!--&lt;p&gt;&lt;small&gt;&lt;strong&gt;XHTML:&lt;/strong&gt; You can use these tags: &lt;?php echo allowed_tags(); ?&gt;&lt;/small&gt;&lt;/p&gt;--&gt;
+
+&lt;p&gt;&lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;100%&quot; rows=&quot;10&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input name=&quot;submit&quot; type=&quot;submit&quot; id=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Submit Comment&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+&lt;/p&gt;
+&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+
+&lt;/form&gt;
+
+&lt;?php endif; // If registration required and not logged in ?&gt;
+
+&lt;?php endif; // if you delete this the sky will fall on your head ?&gt;

Added: trunk/wp-content/themes/Steam/footer.php
===================================================================
--- trunk/wp-content/themes/Steam/footer.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/footer.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,20 @@
+
+&lt;hr /&gt;
+&lt;div id=&quot;footer&quot;&gt;
+	&lt;p&gt;
+		&lt;?php bloginfo('name'); ?&gt; is proudly powered by
+		&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;
+		&lt;br /&gt;&lt;a href=&quot;feed:&lt;?php bloginfo('rss2_url'); ?&gt;&quot;&gt;Entries (RSS)&lt;/a&gt;
+		and &lt;a href=&quot;feed:&lt;?php bloginfo('comments_rss2_url'); ?&gt;&quot;&gt;Comments (RSS)&lt;/a&gt;.
+		&lt;!-- &lt;?php echo $wpdb-&gt;num_queries; ?&gt; queries. &lt;?php timer_stop(1); ?&gt; seconds. --&gt;
+	&lt;/p&gt;
+&lt;/div&gt;
+&lt;/div&gt;
+
+&lt;!-- Gorgeous design by Michael Heilemann - <A HREF="http://binarybonsai.com/kubrick/">http://binarybonsai.com/kubrick/</A> --&gt;
+&lt;?php /* &quot;Just what do you think you're doing Dave?&quot; */ ?&gt;
+
+		&lt;?php wp_footer(); ?&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/header.php
===================================================================
--- trunk/wp-content/themes/Steam/header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,61 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+
+&lt;head profile=&quot;<A HREF="http://gmpg.org/xfn/11">http://gmpg.org/xfn/11</A>&quot;&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('charset'); ?&gt;&quot; /&gt;
+
+&lt;title&gt;&lt;?php bloginfo('name'); ?&gt; &lt;?php if ( is_single() ) { ?&gt; &raquo; Blog Archive &lt;?php } ?&gt; &lt;?php wp_title(); ?&gt;&lt;/title&gt;
+
+&lt;meta name=&quot;generator&quot; content=&quot;WordPress &lt;?php bloginfo('version'); ?&gt;&quot; /&gt; &lt;!-- leave this for stats --&gt;
+
+&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php bloginfo('stylesheet_url'); ?&gt;&quot; type=&quot;text/css&quot; media=&quot;screen&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;RSS 2.0&quot; href=&quot;&lt;?php bloginfo('rss2_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;text/xml&quot; title=&quot;RSS .92&quot; href=&quot;&lt;?php bloginfo('rss_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom 0.3&quot; href=&quot;&lt;?php bloginfo('atom_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;pingback&quot; href=&quot;&lt;?php bloginfo('pingback_url'); ?&gt;&quot; /&gt;
+
+&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+/*	To accomodate differing install paths of WordPress, images are referred only here,
+	and not in the wp-layout.css file. If you prefer to use only CSS for colors and what
+	not, then go right ahead and delete the following lines, and the image files. */
+
+	body { background-color: #fff; }
+&lt;?php /* Checks to see whether it needs a sidebar or not */ if ((! $withcomments) &amp;&amp; (! is_single())) { ?&gt;
+	#page { background-color: #fff; }
+&lt;?php } else { // No sidebar ?&gt;
+	#page { background-color: #fff; text-align: center; }
+&lt;?php } ?&gt;
+	#header { background-color: #73a0c5; }
+	#footer { background-color: #eee;}
+
+/*	Because the template is slightly different, size-wise, with images, this needs to be set here
+	If you don't want to use the template's images, you can also delete the following two lines. */
+
+/*	#header 	{ margin: 0 !important; margin: 0 0 0 1px; padding: 1px; height: 198px; width: 758px; }
+	#headerimg 	{ margin: 7px 9px 0; height: 192px; width: 740px; }*/
+
+/* 	To ease the insertion of a personal header image, I have done it in such a way,
+	that you simply drop in an image called 'personalheader.jpg' into your /images/
+	directory. Dimensions should be at least 760px x 200px. Anything above that will
+	get cropped off of the image. */
+	/*
+	#headerimg { background: url('&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/personalheader.jpg') no-repeat top;}
+	*/
+&lt;/style&gt;
+
+&lt;?php wp_get_archives('type=monthly&amp;format=link'); ?&gt;
+
+&lt;?php wp_head(); ?&gt;
+&lt;/head&gt;
+&lt;body&gt;
+
+&lt;div id=&quot;page&quot;&gt;
+
+
+&lt;div id=&quot;header&quot;&gt;
+	&lt;div id=&quot;headerimg&quot;&gt;
+		&lt;h1&gt;&lt;a href=&quot;&lt;?php echo get_settings('home'); ?&gt;&quot;&gt;&lt;?php bloginfo('name'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+		&lt;div class=&quot;description&quot;&gt;&lt;?php bloginfo('description'); ?&gt;&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/div&gt;
+&lt;hr /&gt;

Added: trunk/wp-content/themes/Steam/index.php
===================================================================
--- trunk/wp-content/themes/Steam/index.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/index.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,39 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+		
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+				&lt;h2&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+				&lt;small&gt;&lt;?php the_time('F jS, Y') ?&gt; &lt;!-- by &lt;?php the_author() ?&gt; --&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_content('Read the rest of this entry &raquo;'); ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;p class=&quot;center&quot;&gt;Sorry, but you are looking for something that isn't here.&lt;/p&gt;
+		&lt;?php include (TEMPLATEPATH . &quot;/searchform.php&quot;); ?&gt;
+
+	&lt;?php endif; ?&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Steam/links.php
===================================================================
--- trunk/wp-content/themes/Steam/links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,18 @@
+&lt;?php
+/*
+Template Name: Links
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;h2&gt;Links:&lt;/h2&gt;
+&lt;ul&gt;
+&lt;?php get_links_list(); ?&gt;
+&lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Steam/page.php
===================================================================
--- trunk/wp-content/themes/Steam/page.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/page.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,21 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+    &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+		&lt;h2&gt;&lt;?php the_title(); ?&gt;&lt;/h2&gt;
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this page &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+	  &lt;?php endwhile; endif; ?&gt;
+	&lt;?php edit_post_link('Edit this entry.', '&lt;p&gt;', '&lt;/p&gt;'); ?&gt;
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/search.php
===================================================================
--- trunk/wp-content/themes/Steam/search.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/search.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,46 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/searchform.php
===================================================================
--- trunk/wp-content/themes/Steam/searchform.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/searchform.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,5 @@
+&lt;form method=&quot;get&quot; id=&quot;searchform&quot; action=&quot;&lt;?php echo $_SERVER['PHP_SELF']; ?&gt;&quot;&gt;
+&lt;div&gt;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($s, 1); ?&gt;&quot; name=&quot;s&quot; id=&quot;s&quot; /&gt;
+&lt;input type=&quot;submit&quot; id=&quot;searchsubmit&quot; value=&quot;Search&quot; /&gt;
+&lt;/div&gt;
+&lt;/form&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Steam/sidebar.php
===================================================================
--- trunk/wp-content/themes/Steam/sidebar.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/sidebar.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,72 @@
+	&lt;div id=&quot;sidebar&quot;&gt;
+		&lt;ul&gt;
+			
+			&lt;li&gt;
+				&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+			&lt;/li&gt;
+
+			&lt;!-- Author information is disabled per default. Uncomment and fill in your details if you want to use it.
+			&lt;li&gt;&lt;h2&gt;Author&lt;/h2&gt;
+			&lt;p&gt;A little something about you, the author. Nothing lengthy, just an overview.&lt;/p&gt;
+			&lt;/li&gt;
+			--&gt;
+
+			&lt;li&gt;
+			&lt;?php /* If this is a 404 page */ if (is_404()) { ?&gt;
+			&lt;?php /* If this is a category archive */ } elseif (is_category()) { ?&gt;
+			&lt;p&gt;You are currently browsing the archives for the &lt;?php single_cat_title(''); ?&gt; category.&lt;/p&gt;
+			
+			&lt;?php /* If this is a yearly archive */ } elseif (is_day()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for the day &lt;?php the_time('l, F jS, Y'); ?&gt;.&lt;/p&gt;
+			
+			&lt;?php /* If this is a monthly archive */ } elseif (is_month()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for &lt;?php the_time('F, Y'); ?&gt;.&lt;/p&gt;
+
+      &lt;?php /* If this is a yearly archive */ } elseif (is_year()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for the year &lt;?php the_time('Y'); ?&gt;.&lt;/p&gt;
+			
+		 &lt;?php /* If this is a monthly archive */ } elseif (is_search()) { ?&gt;
+			&lt;p&gt;You have searched the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for &lt;strong&gt;'&lt;?php echo wp_specialchars($s); ?&gt;'&lt;/strong&gt;. If you are unable to find anything in these search results, you can try one of these links.&lt;/p&gt;
+
+			&lt;?php /* If this is a monthly archive */ } elseif (isset($_GET['paged']) &amp;&amp; !empty($_GET['paged'])) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives.&lt;/p&gt;
+
+			&lt;?php } ?&gt;
+			&lt;/li&gt;
+
+			&lt;?php wp_list_pages('title_li=&lt;h2&gt;Pages&lt;/h2&gt;' ); ?&gt;
+
+			&lt;li&gt;&lt;h2&gt;Archives&lt;/h2&gt;
+				&lt;ul&gt;
+				&lt;?php wp_get_archives('type=monthly'); ?&gt;
+				&lt;/ul&gt;
+			&lt;/li&gt;
+
+			&lt;li&gt;&lt;h2&gt;Categories&lt;/h2&gt;
+				&lt;ul&gt;
+				&lt;?php wp_list_cats('sort_column=name&amp;optioncount=1&amp;hierarchical=0'); ?&gt;
+				&lt;/ul&gt;
+			&lt;/li&gt;
+
+			&lt;?php /* If this is the frontpage */ if ( is_home() || is_page() ) { ?&gt;				
+				&lt;?php get_links_list(); ?&gt;
+				
+				&lt;li&gt;&lt;h2&gt;Meta&lt;/h2&gt;
+				&lt;ul&gt;
+					&lt;?php wp_register(); ?&gt;
+					&lt;li&gt;&lt;?php wp_loginout(); ?&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://validator.w3.org/check/referer">http://validator.w3.org/check/referer</A>&quot; title=&quot;This page validates as XHTML 1.0 Transitional&quot;&gt;Valid &lt;abbr title=&quot;eXtensible HyperText Markup Language&quot;&gt;XHTML&lt;/abbr&gt;&lt;/a&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://gmpg.org/xfn/">http://gmpg.org/xfn/</A>&quot;&gt;&lt;abbr title=&quot;XHTML Friends Network&quot;&gt;XFN&lt;/abbr&gt;&lt;/a&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot; title=&quot;Powered by WordPress, state-of-the-art semantic personal publishing platform.&quot;&gt;WordPress&lt;/a&gt;&lt;/li&gt;
+					&lt;?php wp_meta(); ?&gt;
+				&lt;/ul&gt;
+				&lt;/li&gt;
+			&lt;?php } ?&gt;
+			
+		&lt;/ul&gt;
+	&lt;/div&gt;
+

Added: trunk/wp-content/themes/Steam/single.php
===================================================================
--- trunk/wp-content/themes/Steam/single.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/single.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,65 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+				
+  &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+	
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php previous_post_link('&laquo; %link') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php next_post_link('%link &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+			&lt;h2&gt;&lt;a href=&quot;&lt;?php echo get_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link: &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+	
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this entry &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+				&lt;p class=&quot;postmetadata alt&quot;&gt;
+					&lt;small&gt;
+						This entry was posted
+						&lt;?php /* This is commented, because it requires a little adjusting sometimes.
+							You'll need to download this plugin, and follow the instructions:
+							<A HREF="http://binarybonsai.com/archives/2004/08/17/time-since-plugin/">http://binarybonsai.com/archives/2004/08/17/time-since-plugin/</A> */
+							/* $entry_datetime = abs(strtotime($post-&gt;post_date) - (60*120)); echo time_since($entry_datetime); echo ' ago'; */ ?&gt; 
+						on &lt;?php the_time('l, F jS, Y') ?&gt; at &lt;?php the_time() ?&gt;
+						and is filed under &lt;?php the_category(', ') ?&gt;.
+						You can follow any responses to this entry through the &lt;?php comments_rss_link('RSS 2.0'); ?&gt; feed. 
+						
+						&lt;?php if (('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Both Comments and Pings are open ?&gt;
+							You can &lt;a href=&quot;#respond&quot;&gt;leave a response&lt;/a&gt;, or &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt;&quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Only Pings are Open ?&gt;
+							Responses are currently closed, but you can &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt; &quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Comments are open, Pings are not ?&gt;
+							You can skip to the end and leave a response. Pinging is currently not allowed.
+			
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Neither Comments, nor Pings are open ?&gt;
+							Both comments and pings are currently closed.			
+						
+						&lt;?php } edit_post_link('Edit this entry.','',''); ?&gt;
+						
+					&lt;/small&gt;
+				&lt;/p&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php comments_template(); ?&gt;
+	
+	&lt;?php endwhile; else: ?&gt;
+	
+		&lt;p&gt;Sorry, no posts matched your criteria.&lt;/p&gt;
+	
+&lt;?php endif; ?&gt;
+	
+	&lt;/div&gt;
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Steam/style.css
===================================================================
--- trunk/wp-content/themes/Steam/style.css	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Steam/style.css	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,598 @@
+/*
+Theme Name: Steam
+Theme URI: <A HREF="http://steamedpenguin.com/design/Steam/">http://steamedpenguin.com/design/Steam/</A>
+Description: 'Steam' is a simple, extensible theme for WordPress 1.5.2 and SteamPress
+Version: 3.0
+Author: Samir M. Nassar
+Author URI: <A HREF="http://steamedpenguin.com/">http://steamedpenguin.com/</A>
+
+	Steam
+
+	The CSS, XHTML and design is released under GPL:
+	<A HREF="http://www.opensource.org/licenses/gpl-license.php">http://www.opensource.org/licenses/gpl-license.php</A>
+
+*/
+
+
+/* Begin Typography &amp; Colors */
+body {
+	font-size: 62.5%; /* Resets 1em to 10px */
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	background-color: #d5d6d7;
+	color: #333;
+	text-align: center;
+	}
+
+#page {
+	background-color: white;
+	border: 1px solid #959596;
+	text-align: left;
+	}
+
+#header {
+	background-color: #73a0c5;
+	}
+
+#content {
+	font-size: 1.2em;
+	background-color: #f2f2f2;
+	}
+
+.widecolumn .entry p {
+	font-size: 1.05em;
+	}
+
+.narrowcolumn .entry, .widecolumn .entry {
+	line-height: 1.4em;
+	}
+
+.widecolumn {
+	line-height: 1.6em;
+	}
+
+.narrowcolumn .postmetadata {
+	text-align: center;
+	}
+
+.alt {
+	background-color: #f8f8f8;
+	border-top: 1px solid #ddd;
+	border-bottom: 1px solid #ddd;
+	}
+
+#footer {
+	background-color: #eee;
+	}
+
+small {
+	font-family: Arial, Helvetica, Sans-Serif;
+	font-size: 0.9em;
+	line-height: 1.5em;
+	}
+
+h1, h2, h3 {
+	font-family: 'Trebuchet MS', 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	font-weight: bold;
+	}
+
+h1 {
+	font-size: 4em;
+	text-align: center;
+	}
+
+.description {
+	font-size: 1.2em;
+	text-align: center;
+	}
+
+h2 {
+	font-size: 1.6em;
+	}
+
+h2.pagetitle {
+	font-size: 1.6em;
+	}
+
+#sidebar h2 {
+	font-family: 'Lucida Grande', Verdana, Sans-Serif;
+	font-size: 1.2em;
+	}
+
+h3 {
+	font-size: 1.3em;
+	}
+
+h1, h1 a, h1 a:hover, h1 a:visited, .description {
+	text-decoration: none;
+	color: white;
+	}
+
+h2, h2 a, h2 a:visited, h3, h3 a, h3 a:visited {
+	color: #333;
+	}
+
+h2, h2 a, h2 a:hover, h2 a:visited, h3, h3 a, h3 a:hover, h3 a:visited, #sidebar h2, #wp-calendar caption, cite {
+	text-decoration: none;
+	}
+
+.entry p a:visited {
+	color: #b85b5a;
+	}
+
+.commentlist li, #commentform input, #commentform textarea {
+	font: 0.9em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+.commentlist li {
+	font-weight: bold;
+	}
+
+.commentlist cite, .commentlist cite a {
+	font-weight: bold;
+	font-style: normal;
+	font-size: 1.1em;
+	}
+
+.commentlist p {
+	font-weight: normal;
+	line-height: 1.5em;
+	text-transform: none;
+	}
+
+#commentform p {
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+.commentmetadata {
+	font-weight: normal;
+	}
+
+#sidebar {
+	font: 1em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+small, #sidebar ul ul li, #sidebar ul ol li, .nocomments, .postmetadata, blockquote, strike {
+	color: #777;
+	}
+
+code {
+	font: 1.1em 'Courier New', Courier, Fixed;
+	}
+
+acronym, abbr, span.caps
+{
+	font-size: 0.9em;
+	letter-spacing: .07em;
+	}
+
+a, h2 a:hover, h3 a:hover {
+	color: #06c;
+	text-decoration: none;
+	}
+
+a:hover {
+	color: #147;
+	text-decoration: underline;
+	}
+
+#wp-calendar #prev a {
+	font-size: 9pt;
+	}
+
+#wp-calendar a {
+	text-decoration: none;
+	}
+
+#wp-calendar caption {
+	font: bold 1.3em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	text-align: center;
+	}
+
+#wp-calendar th {
+	font-style: normal;
+	text-transform: capitalize;
+	}
+/* End Typography &amp; Colors */
+
+
+
+/* Begin Structure */
+body {
+	margin: 0;
+	padding: 0;
+	}
+
+#page {
+	background-color: white;
+	margin: 20px auto;
+	padding: 0;
+	width: 80%;
+	border: 1px solid #959596;
+	}
+
+#header {
+	padding: 0;
+	margin: 0 auto;
+	height: 120px;
+	width: 100%;
+	background-color: #73a0c5;
+	}
+
+#headerdata {
+	margin: 0;
+	height: 100px;
+	width: 100%;
+	}
+
+.narrowcolumn {
+	float: left;
+	padding: 0 20px 0 20px;
+	margin: 0 0 20px 0;
+	width: 58%;
+	}
+
+.widecolumn {
+	padding: 0 20px 0 20px;
+	width: 75%;
+	}
+
+.post {
+	margin: 0 0 40px 0;
+	text-align: justify;
+	}
+
+.widecolumn .post {
+	margin: 0;
+	}
+
+.narrowcolumn .postmetadata {
+	padding-top: 5px;
+	}
+
+.widecolumn .postmetadata {
+	margin: 30px 0;
+	}
+
+#footer {
+	padding: 0 0 0 0;
+	margin: 0 auto;
+	width: 100%;
+	clear: both;
+	}
+
+#footer p {
+	margin: 0;
+	padding: 20px 0;
+	text-align: center;
+	}
+
+#content {
+	margin: 15px 0 20px 15px;
+	border: 1px solid #ccc;
+	}
+/* End Structure */
+
+
+
+/*	Begin Headers */
+h1 {
+	padding-top: 20px;
+	margin: 0;
+	}
+
+.description {
+	text-align: center;
+	}
+
+h2 {
+	margin: 30px 0 0;
+	}
+
+h2.pagetitle {
+	margin-top: 30px;
+	text-align: center;
+}
+
+#sidebar h2 {
+	margin: 5px 0 0;
+	padding: 0;
+	}
+
+h3 {
+	padding: 0;
+	margin: 30px 0 0;
+	}
+
+h3.comments {
+	padding: 0;
+	margin: 40px auto 20px ;
+	}
+/* End Headers */
+
+
+
+/* Begin Images */
+p img {
+	padding: 0;
+	max-width: 100%;
+	}
+
+/*	Using 'class=&quot;alignright&quot;' on an image will (who would've
+	thought?!) align the image to the right. And using 'class=&quot;centered',
+	will of course center the image. This is much better than using
+	align=&quot;center&quot;, being much more futureproof (and valid) */
+
+img.centered {
+	display: block;
+	margin-left: auto;
+	margin-right: auto;
+	}
+
+img.alignright {
+	padding: 4px;
+	margin: 0 0 2px 7px;
+	display: inline;
+	}
+
+img.alignleft {
+	padding: 4px;
+	margin: 0 7px 2px 0;
+	display: inline;
+	}
+
+.alignright {
+	float: right;
+	}
+
+.alignleft {
+	float: left
+	}
+/* End Images */
+
+
+
+/* Begin Lists
+
+	Special stylized non-IE bullets
+	Do not work in Internet Explorer, which merely default to normal bullets. */
+
+html&gt;body .entry ul {
+	margin-left: 0px;
+	padding: 0 0 0 30px;
+	list-style: none;
+	padding-left: 10px;
+	text-indent: -10px;
+	}
+
+html&gt;body .entry li {
+	margin: 7px 0 8px 10px;
+	}
+
+.entry ul li:before, #sidebar ul ul li:before {
+	content: &quot;\00BB \0020&quot;;
+	}
+
+.entry ol {
+	padding: 0 0 0 35px;
+	margin: 0;
+	}
+
+.entry ol li {
+	margin: 0;
+	padding: 0;
+	}
+
+.postmetadata ul, .postmetadata li {
+	display: inline;
+	list-style-type: none;
+	list-style-image: none;
+	}
+
+#sidebar ul, #sidebar ul ol {
+	margin: 0;
+	padding: 0;
+	}
+
+#sidebar ul li {
+	list-style-type: none;
+	list-style-image: none;
+	margin-bottom: 15px;
+	}
+
+#sidebar ul p, #sidebar ul select {
+	margin: 5px 0 8px;
+	}
+
+#sidebar ul ul, #sidebar ul ol {
+	margin: 5px 0 0 10px;
+	}
+
+#sidebar ul ul ul, #sidebar ul ol {
+	margin: 0 0 0 10px;
+	}
+
+ol li, #sidebar ul ol li {
+	list-style: decimal outside;
+	}
+
+#sidebar ul ul li, #sidebar ul ol li {
+	margin: 3px 0 0;
+	padding: 0;
+	}
+/* End Entry Lists */
+
+
+
+/* Begin Form Elements */
+#searchform {
+	margin: 10px auto;
+	padding: 5px 3px;
+	text-align: center;
+	}
+
+#sidebar #searchform #s {
+	width: 115px;
+	padding: 2px;
+	}
+
+#sidebar #searchsubmit {
+	padding: 1px;
+	}
+
+.entry form { /* This is mainly for password protected posts, makes them look better. */
+	text-align:center;
+	}
+
+select {
+	width: 130px;
+	}
+
+#commentform input {
+	width: 170px;
+	padding: 2px;
+	margin: 5px 5px 1px 0;
+	}
+
+#commentform textarea {
+	width: 100%;
+	padding: 2px;
+	}
+
+#commentform #submit {
+	margin: 0;
+	float: right;
+	}
+/* End Form Elements */
+
+
+
+/* Begin Comments*/
+.alt {
+	margin: 0;
+	padding: 10px;
+	}
+
+.commentlist {
+	padding: 0;
+	text-align: justify;
+	}
+
+.commentlist li {
+	margin: 15px 0 3px;
+	padding: 5px 10px 3px;
+	list-style: none;
+	}
+
+.commentlist p {
+	margin: 10px 5px 10px 0;
+	}
+
+#commentform p {
+	margin: 5px 0;
+	}
+
+.nocomments {
+	text-align: center;
+	margin: 0;
+	padding: 0;
+	}
+
+.commentmetadata {
+	margin: 0;
+	display: block;
+	}
+/* End Comments */
+
+
+
+/* Begin Sidebar */
+#sidebar
+{
+	padding: 20px 0 10px 0;
+	margin-left: 71%;
+	width: 22%;
+	}
+
+#sidebar form {
+	margin: 0;
+	}
+/* End Sidebar */
+
+
+
+/* Begin Calendar */
+#wp-calendar {
+	empty-cells: show;
+	margin: 10px auto 0;
+	width: 155px;
+	}
+
+#wp-calendar #next a {
+	padding-right: 10px;
+	text-align: right;
+	}
+
+#wp-calendar #prev a {
+	padding-left: 10px;
+	text-align: left;
+	}
+
+#wp-calendar a {
+	display: block;
+	}
+
+#wp-calendar caption {
+	text-align: center;
+	width: 100%;
+	}
+
+#wp-calendar td {
+	padding: 3px 0;
+	text-align: center;
+	}
+
+#wp-calendar td.pad:hover { /* Doesn't work in IE */
+	background-color: #fff; }
+/* End Calendar */
+
+
+
+/* Begin Various Tags &amp; Classes */
+acronym, abbr, span.caps {
+	cursor: help;
+	}
+
+acronym, abbr {
+	border-bottom: 1px dashed #999;
+	}
+
+blockquote {
+	margin: 15px 30px 0 10px;
+	padding-left: 20px;
+	border-left: 5px solid #ddd;
+	}
+
+blockquote cite {
+	margin: 5px 0 0;
+	display: block;
+	}
+
+.center {
+	text-align: center;
+	}
+
+hr {
+	display: none;
+	}
+
+a img {
+	border: none;
+	}
+
+.navigation {
+	display: block;
+	text-align: center;
+	margin-top: 10px;
+	margin-bottom: 60px;
+	}
+/* End Various Tags &amp; Classes*/
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/404.php
===================================================================
--- trunk/wp-content/themes/Tagra/404.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/404.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,11 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Error 404 - Not Found&lt;/h2&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/archive.php
===================================================================
--- trunk/wp-content/themes/Tagra/archive.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/archive.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,68 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;?php if (have_posts()) : ?&gt;
+
+		 &lt;?php $post = $posts[0]; // Hack. Set $post so that the_date() works. ?&gt;
+&lt;?php /* If this is a category archive */ if (is_category()) { ?&gt;				
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for the '&lt;?php echo single_cat_title(); ?&gt;' Category&lt;/h2&gt;
+		
+ 	  &lt;?php /* If this is a daily archive */ } elseif (is_day()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F jS, Y'); ?&gt;&lt;/h2&gt;
+		
+	 &lt;?php /* If this is a monthly archive */ } elseif (is_month()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F, Y'); ?&gt;&lt;/h2&gt;
+
+		&lt;?php /* If this is a yearly archive */ } elseif (is_year()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('Y'); ?&gt;&lt;/h2&gt;
+		
+	  &lt;?php /* If this is a search */ } elseif (is_search()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+	  &lt;?php /* If this is an author archive */ } elseif (is_author()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Author Archive&lt;/h2&gt;
+
+		&lt;?php /* If this is a paged archive */ } elseif (isset($_GET['paged']) &amp;&amp; !empty($_GET['paged'])) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Blog Archives&lt;/h2&gt;
+
+		&lt;?php } ?&gt;
+
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt; 
+
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/archives.php
===================================================================
--- trunk/wp-content/themes/Tagra/archives.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/archives.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,25 @@
+&lt;?php
+/*
+Template Name: Archives
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+&lt;h2&gt;Archives by Month:&lt;/h2&gt;
+  &lt;ul&gt;
+    &lt;?php wp_get_archives('type=monthly'); ?&gt;
+  &lt;/ul&gt;
+
+&lt;h2&gt;Archives by Subject:&lt;/h2&gt;
+  &lt;ul&gt;
+     &lt;?php wp_list_cats(); ?&gt;
+  &lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Tagra/comments-popup.php
===================================================================
--- trunk/wp-content/themes/Tagra/comments-popup.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/comments-popup.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,113 @@
+&lt;?php 
+/* Don't remove these lines. */
+add_filter('comment_text', 'popuplinks');
+foreach ($posts as $post) { start_wp();
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+     &lt;title&gt;&lt;?php echo get_settings('blogname'); ?&gt; - Comments on &lt;?php the_title(); ?&gt;&lt;/title&gt;
+
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+	&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+		@import url( &lt;?php bloginfo('stylesheet_url'); ?&gt; );
+		body { margin: 3px; }
+	&lt;/style&gt;
+
+&lt;/head&gt;
+&lt;body id=&quot;commentspopup&quot;&gt;
+
+&lt;h1 id=&quot;header&quot;&gt;&lt;a href=&quot;&quot; title=&quot;&lt;?php echo get_settings('blogname'); ?&gt;&quot;&gt;&lt;?php echo get_settings('blogname'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+
+&lt;h2 id=&quot;comments&quot;&gt;Comments&lt;/h2&gt;
+
+&lt;p&gt;&lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-commentsrss2.php?p=&lt;?php echo $post-&gt;ID; ?&gt;&quot;&gt;&lt;abbr title=&quot;Really Simple Syndication&quot;&gt;RSS&lt;/abbr&gt; feed for comments on this post.&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php if ('open' == $post-&gt;ping_status) { ?&gt;
+&lt;p&gt;The &lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt; to TrackBack this entry is: &lt;em&gt;&lt;?php trackback_url() ?&gt;&lt;/em&gt;&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php
+// this line is WordPress' motor, do not delete it.
+$comment_author = (isset($_COOKIE['comment_author_' . COOKIEHASH])) ? trim($_COOKIE['comment_author_'. COOKIEHASH]) : '';
+$comment_author_email = (isset($_COOKIE['comment_author_email_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_email_'. COOKIEHASH]) : '';
+$comment_author_url = (isset($_COOKIE['comment_author_url_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_url_'. COOKIEHASH]) : '';
+$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = $id AND comment_approved = '1' ORDER BY comment_date&quot;);
+$commentstatus = $wpdb-&gt;get_row(&quot;SELECT comment_status, post_password FROM $wpdb-&gt;posts WHERE ID = $id&quot;);
+if (!empty($commentstatus-&gt;post_password) &amp;&amp; $_COOKIE['wp-postpass_'. COOKIEHASH] != $commentstatus-&gt;post_password) {  // and it doesn't match the cookie
+	echo(get_the_password_form());
+} else { ?&gt;
+
+&lt;?php if ($comments) { ?&gt;
+&lt;ol id=&quot;commentlist&quot;&gt;
+&lt;?php foreach ($comments as $comment) { ?&gt;
+	&lt;li id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+	&lt;?php comment_text() ?&gt;
+	&lt;p&gt;&lt;cite&gt;&lt;?php comment_type('Comment', 'Trackback', 'Pingback'); ?&gt; by &lt;?php comment_author_link() ?&gt; &#8212; &lt;?php comment_date() ?&gt; @ &lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot;&gt;&lt;?php comment_time() ?&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+	&lt;/li&gt;
+
+&lt;?php } // end for each comment ?&gt;
+&lt;/ol&gt;
+&lt;?php } else { // this is displayed if there are no comments so far ?&gt;
+	&lt;p&gt;No comments yet.&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php if ('open' == $commentstatus-&gt;comment_status) { ?&gt;
+&lt;h2&gt;Leave a comment&lt;/h2&gt;
+&lt;p&gt;Line and paragraph breaks automatic, e-mail address never displayed, &lt;acronym title=&quot;Hypertext Markup Language&quot;&gt;HTML&lt;/acronym&gt; allowed: &lt;code&gt;&lt;?php echo allowed_tags(); ?&gt;&lt;/code&gt;&lt;/p&gt;
+
+&lt;form action=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; class=&quot;textarea&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;1&quot; /&gt;
+	   &lt;label for=&quot;author&quot;&gt;Name&lt;/label&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;redirect_to&quot; value=&quot;&lt;?php echo wp_specialchars($_SERVER[&quot;REQUEST_URI&quot;]); ?&gt;&quot; /&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;2&quot; /&gt;
+	   &lt;label for=&quot;email&quot;&gt;E-mail&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;3&quot; /&gt;
+	   &lt;label for=&quot;url&quot;&gt;&lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt;&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;label for=&quot;comment&quot;&gt;Your Comment&lt;/label&gt;
+	&lt;br /&gt;
+	  &lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;70&quot; rows=&quot;4&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input name=&quot;submit&quot; type=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Say It!&quot; /&gt;
+	&lt;/p&gt;
+	&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+&lt;/form&gt;
+&lt;?php } else { // comments are closed ?&gt;
+&lt;p&gt;Sorry, the comment form is closed at this time.&lt;/p&gt;
+&lt;?php }
+} // end password check
+?&gt;
+
+&lt;div&gt;&lt;strong&gt;&lt;a href=&quot;javascript:window.close()&quot;&gt;Close this window.&lt;/a&gt;&lt;/strong&gt;&lt;/div&gt;
+
+&lt;?php // if you delete this the sky will fall on your head
+}
+?&gt;
+
+&lt;!-- // this is just the end of the motor - don't touch that line either :) --&gt;
+&lt;?php //} ?&gt; 
+&lt;p class=&quot;credit&quot;&gt;&lt;?php timer_stop(1); ?&gt; &lt;cite&gt;Powered by &lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot; title=&quot;Powered by WordPress, state-of-the-art semantic personal publishing platform&quot;&gt;&lt;strong&gt;Wordpress&lt;/strong&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+&lt;?php // Seen at <A HREF="http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18">http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18</A>) ?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+document.onkeypress = function esc(e) {	
+	if(typeof(e) == &quot;undefined&quot;) { e=event; }
+	if (e.keyCode == 27) { self.close(); }
+}
+// --&gt;
+&lt;/script&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-content/themes/Tagra/comments.php
===================================================================
--- trunk/wp-content/themes/Tagra/comments.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/comments.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,104 @@
+&lt;?php // Do not delete these lines
+	if ('comments.php' == basename($_SERVER['SCRIPT_FILENAME']))
+		die ('Please do not load this page directly. Thanks!');
+
+        if (!empty($post-&gt;post_password)) { // if there's a password
+            if ($_COOKIE['wp-postpass_' . COOKIEHASH] != $post-&gt;post_password) {  // and it doesn't match the cookie
+				?&gt;
+				
+				&lt;p class=&quot;nocomments&quot;&gt;This post is password protected. Enter the password to view comments.&lt;p&gt;
+				
+				&lt;?php
+				return;
+            }
+        }
+
+		/* This variable is for alternating comment background */
+		$oddcomment = 'alt';
+?&gt;
+
+&lt;!-- You can start editing here. --&gt;
+
+&lt;?php if ($comments) : ?&gt;
+	&lt;h3 id=&quot;comments&quot;&gt;&lt;?php comments_number('No Responses', 'One Response', '% Responses' );?&gt; to &#8220;&lt;?php the_title(); ?&gt;&#8221;&lt;/h3&gt; 
+
+	&lt;ol class=&quot;commentlist&quot;&gt;
+
+	&lt;?php foreach ($comments as $comment) : ?&gt;
+
+		&lt;li class=&quot;&lt;?php echo $oddcomment; ?&gt;&quot; id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+			&lt;cite&gt;&lt;?php comment_author_link() ?&gt;&lt;/cite&gt; Says:
+			&lt;?php if ($comment-&gt;comment_approved == '0') : ?&gt;
+			&lt;em&gt;Your comment is awaiting moderation.&lt;/em&gt;
+			&lt;?php endif; ?&gt;
+			&lt;br /&gt;
+
+			&lt;small class=&quot;commentmetadata&quot;&gt;&lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot; title=&quot;&quot;&gt;&lt;?php comment_date('F jS, Y') ?&gt; at &lt;?php comment_time() ?&gt;&lt;/a&gt; &lt;?php edit_comment_link('e','',''); ?&gt;&lt;/small&gt;
+
+			&lt;?php comment_text() ?&gt;
+
+		&lt;/li&gt;
+
+	&lt;?php /* Changes every other comment to a different class */	
+		if ('alt' == $oddcomment) $oddcomment = '';
+		else $oddcomment = 'alt';
+	?&gt;
+
+	&lt;?php endforeach; /* end for each comment */ ?&gt;
+
+	&lt;/ol&gt;
+
+ &lt;?php else : // this is displayed if there are no comments so far ?&gt;
+
+  &lt;?php if ('open' == $post-&gt;comment_status) : ?&gt; 
+		&lt;!-- If comments are open, but there are no comments. --&gt;
+		
+	 &lt;?php else : // comments are closed ?&gt;
+		&lt;!-- If comments are closed. --&gt;
+		&lt;p class=&quot;nocomments&quot;&gt;Comments are closed.&lt;/p&gt;
+		
+	&lt;?php endif; ?&gt;
+&lt;?php endif; ?&gt;
+
+
+&lt;?php if ('open' == $post-&gt;comment_status) : ?&gt;
+
+&lt;h3 id=&quot;respond&quot;&gt;Leave a Reply&lt;/h3&gt;
+
+&lt;?php if ( get_option('comment_registration') &amp;&amp; !$user_ID ) : ?&gt;
+&lt;p&gt;You must be &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?redirect_to=&lt;?php the_permalink(); ?&gt;&quot;&gt;logged in&lt;/a&gt; to post a comment.&lt;/p&gt;
+&lt;?php else : ?&gt;
+
+&lt;form action=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+
+&lt;?php if ( $user_ID ) : ?&gt;
+
+&lt;p&gt;Logged in as &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-admin/profile.php&quot;&gt;&lt;?php echo $user_identity; ?&gt;&lt;/a&gt;. &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?action=logout&quot; title=&quot;Log out of this account&quot;&gt;Logout &raquo;&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php else : ?&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;1&quot; /&gt;
+&lt;label for=&quot;author&quot;&gt;&lt;small&gt;Name &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;2&quot; /&gt;
+&lt;label for=&quot;email&quot;&gt;&lt;small&gt;Mail (will not be published) &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;3&quot; /&gt;
+&lt;label for=&quot;url&quot;&gt;&lt;small&gt;Website&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;?php endif; ?&gt;
+
+&lt;!--&lt;p&gt;&lt;small&gt;&lt;strong&gt;XHTML:&lt;/strong&gt; You can use these tags: &lt;?php echo allowed_tags(); ?&gt;&lt;/small&gt;&lt;/p&gt;--&gt;
+
+&lt;p&gt;&lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;100%&quot; rows=&quot;10&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input name=&quot;submit&quot; type=&quot;submit&quot; id=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Submit Comment&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+&lt;/p&gt;
+&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+
+&lt;/form&gt;
+
+&lt;?php endif; // If registration required and not logged in ?&gt;
+
+&lt;?php endif; // if you delete this the sky will fall on your head ?&gt;

Added: trunk/wp-content/themes/Tagra/footer.php
===================================================================
--- trunk/wp-content/themes/Tagra/footer.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/footer.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,13 @@
+
+&lt;hr /&gt;
+&lt;div id=&quot;footer&quot;&gt;
+	&lt;p&gt;Lay me under the Oranges of Yafa; to be first to see their sadness turn to joy.&lt;/p&gt;
+&lt;/div&gt;
+&lt;/div&gt;
+
+&lt;?php /* &quot;Just what do you think you're doing Dave?&quot; */ ?&gt;
+
+		&lt;?php wp_footer(); ?&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/header.php
===================================================================
--- trunk/wp-content/themes/Tagra/header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,61 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+
+&lt;head profile=&quot;<A HREF="http://gmpg.org/xfn/11">http://gmpg.org/xfn/11</A>&quot;&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('charset'); ?&gt;&quot; /&gt;
+
+&lt;title&gt;&lt;?php bloginfo('name'); ?&gt; &lt;?php if ( is_single() ) { ?&gt; &raquo; Blog Archive &lt;?php } ?&gt; &lt;?php wp_title(); ?&gt;&lt;/title&gt;
+
+&lt;meta name=&quot;generator&quot; content=&quot;WordPress &lt;?php bloginfo('version'); ?&gt;&quot; /&gt; &lt;!-- leave this for stats --&gt;
+
+&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php bloginfo('stylesheet_url'); ?&gt;&quot; type=&quot;text/css&quot; media=&quot;screen&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;RSS 2.0&quot; href=&quot;&lt;?php bloginfo('rss2_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;text/xml&quot; title=&quot;RSS .92&quot; href=&quot;&lt;?php bloginfo('rss_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom 0.3&quot; href=&quot;&lt;?php bloginfo('atom_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;pingback&quot; href=&quot;&lt;?php bloginfo('pingback_url'); ?&gt;&quot; /&gt;
+
+&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+/*	To accomodate differing install paths of WordPress, images are referred only here,
+	and not in the wp-layout.css file. If you prefer to use only CSS for colors and what
+	not, then go right ahead and delete the following lines, and the image files. */
+		
+	body { background-color: #fed; }	
+&lt;?php /* Checks to see whether it needs a sidebar or not */ if ((! $withcomments) &amp;&amp; (! is_single())) { ?&gt;
+	#page { background-color: #d9c9b9; }
+&lt;?php } else { // No sidebar ?&gt;
+	#page { background-color: #d9c9b9; text-align: center; } 
+&lt;?php } ?&gt;
+	#header { background-color: #432313; }
+	#footer { background-color: #b1a191;}
+
+/*	Because the template is slightly different, size-wise, with images, this needs to be set here
+	If you don't want to use the template's images, you can also delete the following two lines. */
+		
+/*	#header 	{ margin: 0 !important; margin: 0 0 0 1px; padding: 1px; height: 198px; width: 758px; }
+	#headerimg 	{ margin: 7px 9px 0; height: 192px; width: 740px; } */
+
+/* 	To ease the insertion of a personal header image, I have done it in such a way,
+	that you simply drop in an image called 'personalheader.jpg' into your /images/
+	directory. Dimensions should be at least 760px x 200px. Anything above that will
+	get cropped off of the image. */
+	/*
+	#headerimg { background: url('&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/personalheader.jpg') no-repeat top;}
+	*/
+&lt;/style&gt;
+
+&lt;?php wp_get_archives('type=monthly&amp;format=link'); ?&gt;
+
+&lt;?php wp_head(); ?&gt;
+&lt;/head&gt;
+&lt;body&gt;
+
+&lt;div id=&quot;page&quot;&gt;
+
+
+&lt;div id=&quot;header&quot;&gt;
+	&lt;div id=&quot;headerdata&quot;&gt;
+		&lt;h1&gt;&lt;a href=&quot;&lt;?php echo get_settings('home'); ?&gt;&quot;&gt;&lt;?php bloginfo('name'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+		&lt;div class=&quot;description&quot;&gt;&lt;?php bloginfo('description'); ?&gt;&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/div&gt;
+&lt;hr /&gt;

Added: trunk/wp-content/themes/Tagra/index.php
===================================================================
--- trunk/wp-content/themes/Tagra/index.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/index.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,37 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+		
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+				&lt;h2&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+&lt;!--				&lt;small&gt;&lt;?php the_time('F jS, Y') ?&gt; by &lt;?php the_author() ?&gt; &lt;/small&gt;--&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_content('Read the rest of this entry &raquo;'); ?&gt;
+				&lt;/div&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;p class=&quot;center&quot;&gt;Sorry, but you are looking for something that isn't here.&lt;/p&gt;
+		&lt;?php include (TEMPLATEPATH . &quot;/searchform.php&quot;); ?&gt;
+
+	&lt;?php endif; ?&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Tagra/links.php
===================================================================
--- trunk/wp-content/themes/Tagra/links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,18 @@
+&lt;?php
+/*
+Template Name: Links
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;h2&gt;Links:&lt;/h2&gt;
+&lt;ul&gt;
+&lt;?php get_links_list(); ?&gt;
+&lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Tagra/page.php
===================================================================
--- trunk/wp-content/themes/Tagra/page.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/page.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,21 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+    &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+		&lt;h2&gt;&lt;?php the_title(); ?&gt;&lt;/h2&gt;
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this page &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+	  &lt;?php endwhile; endif; ?&gt;
+	&lt;?php edit_post_link('Edit this entry.', '&lt;p&gt;', '&lt;/p&gt;'); ?&gt;
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/search.php
===================================================================
--- trunk/wp-content/themes/Tagra/search.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/search.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,46 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/searchform.php
===================================================================
--- trunk/wp-content/themes/Tagra/searchform.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/searchform.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,5 @@
+&lt;form method=&quot;get&quot; id=&quot;searchform&quot; action=&quot;&lt;?php echo $_SERVER['PHP_SELF']; ?&gt;&quot;&gt;
+&lt;div&gt;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($s, 1); ?&gt;&quot; name=&quot;s&quot; id=&quot;s&quot; /&gt;
+&lt;input type=&quot;submit&quot; id=&quot;searchsubmit&quot; value=&quot;Search&quot; /&gt;
+&lt;/div&gt;
+&lt;/form&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/Tagra/sidebar.php
===================================================================
--- trunk/wp-content/themes/Tagra/sidebar.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/sidebar.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,20 @@
+	&lt;div id=&quot;sidebar&quot;&gt;
+		&lt;ul&gt;
+
+			&lt;?php wp_list_pages('title_li=&lt;h2&gt;Menu&lt;/h2&gt;' ); ?&gt;
+
+			&lt;?php /* If this is the frontpage */ if ( is_home() || is_page() ) { ?&gt;				
+				&lt;?php get_links_list(); ?&gt;
+				
+				&lt;li&gt;&lt;h2&gt;Meta&lt;/h2&gt;
+				&lt;ul&gt;
+					&lt;?php wp_register(); ?&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://validator.w3.org/check/referer">http://validator.w3.org/check/referer</A>&quot; title=&quot;This page validates as XHTML 1.0 Transitional&quot;&gt;Valid &lt;abbr title=&quot;eXtensible HyperText Markup Language&quot;&gt;XHTML&lt;/abbr&gt;&lt;/a&gt;&lt;/li&gt;
+					&lt;?php wp_meta(); ?&gt;
+				&lt;/ul&gt;
+				&lt;/li&gt;
+			&lt;?php } ?&gt;
+			
+		&lt;/ul&gt;
+	&lt;/div&gt;
+

Added: trunk/wp-content/themes/Tagra/single.php
===================================================================
--- trunk/wp-content/themes/Tagra/single.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/single.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,63 @@
+&lt;?php get_header(); ?&gt;
+	&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot; style=&quot;text-align: left; margin: 10px auto;&quot;&gt;
+				
+  &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+	
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php previous_post_link('&laquo; %link') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php next_post_link('%link &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+			&lt;h2&gt;&lt;a href=&quot;&lt;?php echo get_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link: &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+	
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this entry &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+				&lt;p class=&quot;postmetadata alt&quot;&gt;
+					&lt;small&gt;
+						This entry was posted
+						&lt;?php /* This is commented, because it requires a little adjusting sometimes.
+							You'll need to download this plugin, and follow the instructions:
+							<A HREF="http://binarybonsai.com/archives/2004/08/17/time-since-plugin/">http://binarybonsai.com/archives/2004/08/17/time-since-plugin/</A> */
+							/* $entry_datetime = abs(strtotime($post-&gt;post_date) - (60*120)); echo time_since($entry_datetime); echo ' ago'; */ ?&gt; 
+						on &lt;?php the_time('l, F jS, Y') ?&gt; at &lt;?php the_time() ?&gt;
+						and is filed under &lt;?php the_category(', ') ?&gt;.
+						You can follow any responses to this entry through the &lt;?php comments_rss_link('RSS 2.0'); ?&gt; feed. 
+						
+						&lt;?php if (('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Both Comments and Pings are open ?&gt;
+							You can &lt;a href=&quot;#respond&quot;&gt;leave a response&lt;/a&gt;, or &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt;&quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Only Pings are Open ?&gt;
+							Responses are currently closed, but you can &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt; &quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Comments are open, Pings are not ?&gt;
+							You can skip to the end and leave a response. Pinging is currently not allowed.
+			
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Neither Comments, nor Pings are open ?&gt;
+							Both comments and pings are currently closed.			
+						
+						&lt;?php } edit_post_link('Edit this entry.','',''); ?&gt;
+						
+					&lt;/small&gt;
+				&lt;/p&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php comments_template(); ?&gt;
+	
+	&lt;?php endwhile; else: ?&gt;
+	
+		&lt;p&gt;Sorry, no posts matched your criteria.&lt;/p&gt;
+	
+&lt;?php endif; ?&gt;
+	
+	&lt;/div&gt;
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/Tagra/style.css
===================================================================
--- trunk/wp-content/themes/Tagra/style.css	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/Tagra/style.css	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,608 @@
+/*  
+Theme Name: Tagra
+Theme URI: <A HREF="http://steamedpenguin.com/design/Tagra/">http://steamedpenguin.com/design/Tagra/</A>
+Description: 'Tagra' is set to evoke the color as well as tenor of the era described in Guy Gavriel Kay's 'The Lions of Al-Rassan'
+Version: 1.0
+Author: Samir M. Nassar
+Author URI: <A HREF="http://steamedpenguin.com/">http://steamedpenguin.com/</A>
+
+	Tagra
+
+	The CSS, XHTML and design is released under GPL:
+	<A HREF="http://www.opensource.org/licenses/gpl-license.php">http://www.opensource.org/licenses/gpl-license.php</A>
+
+&quot;The wells and the fountains weep for sorrow,
+ As lover does when dawn comes
+ To take him away from his desire.
+ They mourn for the passing of lions,
+ For the ending of Al-Rassan the beloved,
+ Which is gone.&quot;
+
+                                          'ibn Khairans' Lament'
+                                          &quot;The Lions of Al-Rassan&quot;
+
+*/
+
+
+/* Begin Typography &amp; Colors */
+body {
+	font-size: 62.5%; /* Resets 1em to 10px */
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	background-color: #0ff;
+	color: #333;
+	text-align: center;
+	}
+
+#page {
+	background-color: white;
+	border: 1px solid #959596;
+	text-align: left;
+	}
+
+#header {
+	background-color: #73a0c5;
+	}
+
+#content {
+	font-size: 1.2em;
+	background-color: #ffeedd;
+	}
+
+.widecolumn .entry p {
+	font-size: 1.05em;
+	}
+
+.narrowcolumn .entry, .widecolumn .entry {
+	line-height: 1.4em;
+	}
+
+.widecolumn {
+	line-height: 1.6em;
+	}
+	
+.narrowcolumn .postmetadata {
+	text-align: center;
+	}
+
+.alt {
+	background-color: #f8f8f8;
+	border-top: 1px solid #ddd;
+	border-bottom: 1px solid #ddd;
+	}
+
+#footer {
+	background-color: #eee;
+	}
+
+small {
+	font-family: Arial, Helvetica, Sans-Serif;
+	font-size: 0.9em;
+	line-height: 1.5em;
+	}
+
+h1, h2, h3 {
+	font-family: 'Trebuchet MS', 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	font-weight: bold;
+	}
+
+h1 {
+	font-size: 4em;
+	text-align: center;
+	}
+
+.description {
+	font-size: 1.2em;
+	text-align: center;
+	}
+
+h2 {
+	font-size: 1.6em;
+	}
+
+h2.pagetitle {
+	font-size: 1.6em;
+	}
+
+#sidebar h2 {
+	font-family: 'Lucida Grande', Verdana, Sans-Serif;
+	font-size: 1.2em;
+	}
+
+h3 {
+	font-size: 1.3em;
+	}
+
+h1, h1 a, h1 a:hover, h1 a:visited, .description {
+	text-decoration: none;
+	color: white;
+	}
+
+h2, h2 a, h2 a:visited, h3, h3 a, h3 a:visited {
+	color: #333;
+	}
+
+h2, h2 a, h2 a:hover, h2 a:visited, h3, h3 a, h3 a:hover, h3 a:visited, #sidebar h2, #wp-calendar caption, cite {
+	text-decoration: none;
+	}
+
+.entry p a:visited {
+	color: #b85b5a;
+	}
+
+.commentlist li, #commentform input, #commentform textarea {
+	font: 0.9em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+	
+.commentlist li {
+	font-weight: bold;
+	}
+
+.commentlist cite, .commentlist cite a {
+	font-weight: bold;
+	font-style: normal;
+	font-size: 1.1em;
+	}
+
+.commentlist p {
+	font-weight: normal;
+	line-height: 1.5em;
+	text-transform: none;
+	}
+
+#commentform p {
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+.commentmetadata {
+	font-weight: normal;
+	}
+
+#sidebar {
+	font: 1em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+small, #sidebar ul ul li, #sidebar ul ol li, .nocomments, .postmetadata, blockquote, strike {
+	color: #777;
+	}
+	
+code {
+	font: 1.1em 'Courier New', Courier, Fixed;
+	}
+
+acronym, abbr, span.caps
+{
+	font-size: 0.9em;
+	letter-spacing: .07em;
+	}
+
+a, h2 a:hover, h3 a:hover {
+	color: #644424;
+	text-decoration: none;
+	}
+
+a:hover {
+	color: #9a5a1a;
+	text-decoration: underline;
+	}
+	
+#wp-calendar #prev a {
+	font-size: 9pt;
+	}
+
+#wp-calendar a {
+	text-decoration: none;
+	}
+
+#wp-calendar caption {
+	font: bold 1.3em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	text-align: center;
+	}
+
+#wp-calendar th {
+	font-style: normal;
+	text-transform: capitalize;
+	}
+/* End Typography &amp; Colors */
+
+
+
+/* Begin Structure */
+body {
+	margin: 0;
+	padding: 0; 
+	}
+
+#page {
+	background-color: white;
+	margin: 20px auto;
+	padding: 0;
+	width: 80%;
+	border: 1px solid #432313;
+	}
+	
+#header {
+	padding: 0;
+	margin: 0 auto;
+	height: 120px;
+	width: 100%;
+	background-color: #432313;
+	}
+
+#headerdata {
+	margin: 0;
+	height: 100px;
+	width: 100%;
+	}
+
+.narrowcolumn {
+	float: left;
+	padding: 0 20px 0 20px;
+	margin: 0 0 20px 0;
+	width: 58%;
+	}
+
+.widecolumn {
+	padding: 0 20px 0 20px;
+	width: 75%;
+	}
+	
+.post {
+	margin: 0 0 40px 0;
+	text-align: justify;
+	}
+
+.widecolumn .post {
+	margin: 0;
+	}
+
+.narrowcolumn .postmetadata {
+	padding-top: 5px;
+	}
+
+.widecolumn .postmetadata {
+	margin: 30px 0;
+	}
+	
+#footer {
+	padding: 0 0 0 0;
+	margin: 0 auto;
+	width: 100%;
+	clear: both;
+	}
+
+#footer p {
+	margin: 0;
+	padding: 20px 0;
+	text-align: center;
+	}
+
+#content {
+	margin: 15px 0 20px 15px;
+	border: 1px solid #ccc;
+	}
+/* End Structure */
+
+
+
+/*	Begin Headers */
+h1 {
+	padding-top: 20px;
+	margin: 0;
+	}
+
+.description {
+	text-align: center;
+	}
+
+h2 {
+	margin: 30px 0 0;
+	}
+
+h2.pagetitle {
+	margin-top: 30px;
+	text-align: center;
+}
+
+#sidebar h2 {
+	margin: 5px 0 0;
+	padding: 0;
+	}
+
+h3 {
+	padding: 0;
+	margin: 30px 0 0;
+	}
+
+h3.comments {
+	padding: 0;
+	margin: 40px auto 20px ;
+	}
+/* End Headers */
+
+
+
+/* Begin Images */
+p img {
+	padding: 0;
+	max-width: 100%;
+	}
+
+/*	Using 'class=&quot;alignright&quot;' on an image will (who would've
+	thought?!) align the image to the right. And using 'class=&quot;centered',
+	will of course center the image. This is much better than using
+	align=&quot;center&quot;, being much more futureproof (and valid) */
+	
+img.centered {
+	display: block;
+	margin-left: auto;
+	margin-right: auto;
+	}
+	
+img.alignright {
+	padding: 4px;
+	margin: 0 0 2px 7px;
+	display: inline;
+	}
+
+img.alignleft {
+	padding: 4px;
+	margin: 0 7px 2px 0;
+	display: inline;
+	}
+
+.alignright {
+	float: right;
+	}
+	
+.alignleft {
+	float: left
+	}
+/* End Images */
+
+
+
+/* Begin Lists
+
+	Special stylized non-IE bullets
+	Do not work in Internet Explorer, which merely default to normal bullets. */
+
+html&gt;body .entry ul {
+	margin-left: 0px;
+	padding: 0 0 0 30px;
+	list-style: none;
+	padding-left: 10px;
+	text-indent: -10px;
+	} 
+
+html&gt;body .entry li {
+	margin: 7px 0 8px 10px;
+	}
+
+.entry ul li:before, #sidebar ul ul li:before {
+	content: &quot;\00BB \0020&quot;;
+	}
+
+.entry ol {
+	padding: 0 0 0 35px;
+	margin: 0;
+	}
+
+.entry ol li {
+	margin: 0;
+	padding: 0;
+	}
+
+.postmetadata ul, .postmetadata li {
+	display: inline;
+	list-style-type: none;
+	list-style-image: none;
+	}
+	
+#sidebar ul, #sidebar ul ol {
+	margin: 0;
+	padding: 0;
+	}
+
+#sidebar ul li {
+	list-style-type: none;
+	list-style-image: none;
+	margin-bottom: 15px;
+	}
+
+#sidebar ul p, #sidebar ul select {
+	margin: 5px 0 8px;
+	}
+
+#sidebar ul ul, #sidebar ul ol {
+	margin: 5px 0 0 10px;
+	}
+
+#sidebar ul ul ul, #sidebar ul ol {
+	margin: 0 0 0 10px;
+	}
+
+ol li, #sidebar ul ol li {
+	list-style: decimal outside;
+	}
+
+#sidebar ul ul li, #sidebar ul ol li {
+	margin: 3px 0 0;
+	padding: 0;
+	}
+/* End Entry Lists */
+
+
+
+/* Begin Form Elements */
+#searchform {
+	margin: 10px auto;
+	padding: 5px 3px; 
+	text-align: center;
+	}
+
+#sidebar #searchform #s {
+	width: 115px;
+	padding: 2px;
+	}
+
+#sidebar #searchsubmit {
+	padding: 1px;
+	}
+
+.entry form { /* This is mainly for password protected posts, makes them look better. */
+	text-align:center;
+	}
+
+select {
+	width: 130px;
+	}
+
+#commentform input {
+	width: 170px;
+	padding: 2px;
+	margin: 5px 5px 1px 0;
+	}
+
+#commentform textarea {
+	width: 100%;
+	padding: 2px;
+	}
+
+#commentform #submit {
+	margin: 0;
+	float: right;
+	}
+/* End Form Elements */
+
+
+
+/* Begin Comments*/
+.alt {
+	margin: 0;
+	padding: 10px;
+	}
+
+.commentlist {
+	padding: 0;
+	text-align: justify;
+	}
+
+.commentlist li {
+	margin: 15px 0 3px;
+	padding: 5px 10px 3px;
+	list-style: none;
+	}
+
+.commentlist p {
+	margin: 10px 5px 10px 0;
+	}
+
+#commentform p {
+	margin: 5px 0;
+	}
+
+.nocomments {
+	text-align: center;
+	margin: 0;
+	padding: 0;
+	}
+
+.commentmetadata {
+	margin: 0;
+	display: block;
+	}
+/* End Comments */
+
+
+
+/* Begin Sidebar */
+#sidebar
+{
+	padding: 20px 0 10px 0;
+	margin-left: 71%;
+	width: 22%;
+	}
+
+#sidebar form {
+	margin: 0;
+	}
+/* End Sidebar */
+
+
+
+/* Begin Calendar */
+#wp-calendar {
+	empty-cells: show;
+	margin: 10px auto 0;
+	width: 155px;
+	}
+
+#wp-calendar #next a {
+	padding-right: 10px;
+	text-align: right;
+	}
+
+#wp-calendar #prev a {
+	padding-left: 10px;
+	text-align: left;
+	}
+
+#wp-calendar a {
+	display: block;
+	}
+
+#wp-calendar caption {
+	text-align: center;
+	width: 100%;
+	}
+
+#wp-calendar td {
+	padding: 3px 0;
+	text-align: center;
+	}
+
+#wp-calendar td.pad:hover { /* Doesn't work in IE */
+	background-color: #fff; }
+/* End Calendar */
+
+
+
+/* Begin Various Tags &amp; Classes */
+acronym, abbr, span.caps {
+	cursor: help;
+	}
+
+acronym, abbr {
+	border-bottom: 1px dashed #999;
+	}
+
+blockquote {
+	margin: 15px 30px 0 10px;
+	padding-left: 20px;
+	border-left: 5px solid #ddd;
+	}
+
+blockquote cite {
+	margin: 5px 0 0;
+	display: block;
+	}
+
+.center {
+	text-align: center;
+	}
+
+hr {
+	display: none;
+	}
+
+a img {
+	border: none;
+	}
+
+.navigation {
+	display: block;
+	text-align: center;
+	margin-top: 10px;
+	margin-bottom: 60px;
+	}
+/* End Various Tags &amp; Classes*/
\ No newline at end of file

Added: trunk/wp-content/themes/default/404.php
===================================================================
--- trunk/wp-content/themes/default/404.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/404.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,11 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Error 404 - Not Found&lt;/h2&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/archive.php
===================================================================
--- trunk/wp-content/themes/default/archive.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/archive.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,68 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+		&lt;?php if (have_posts()) : ?&gt;
+
+		 &lt;?php $post = $posts[0]; // Hack. Set $post so that the_date() works. ?&gt;
+&lt;?php /* If this is a category archive */ if (is_category()) { ?&gt;				
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for the '&lt;?php echo single_cat_title(); ?&gt;' Category&lt;/h2&gt;
+		
+ 	  &lt;?php /* If this is a daily archive */ } elseif (is_day()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F jS, Y'); ?&gt;&lt;/h2&gt;
+		
+	 &lt;?php /* If this is a monthly archive */ } elseif (is_month()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('F, Y'); ?&gt;&lt;/h2&gt;
+
+		&lt;?php /* If this is a yearly archive */ } elseif (is_year()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Archive for &lt;?php the_time('Y'); ?&gt;&lt;/h2&gt;
+		
+	  &lt;?php /* If this is a search */ } elseif (is_search()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+	  &lt;?php /* If this is an author archive */ } elseif (is_author()) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Author Archive&lt;/h2&gt;
+
+		&lt;?php /* If this is a paged archive */ } elseif (isset($_GET['paged']) &amp;&amp; !empty($_GET['paged'])) { ?&gt;
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Blog Archives&lt;/h2&gt;
+
+		&lt;?php } ?&gt;
+
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt; 
+
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/archives.php
===================================================================
--- trunk/wp-content/themes/default/archives.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/archives.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,25 @@
+&lt;?php
+/*
+Template Name: Archives
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+&lt;h2&gt;Archives by Month:&lt;/h2&gt;
+  &lt;ul&gt;
+    &lt;?php wp_get_archives('type=monthly'); ?&gt;
+  &lt;/ul&gt;
+
+&lt;h2&gt;Archives by Subject:&lt;/h2&gt;
+  &lt;ul&gt;
+     &lt;?php wp_list_cats(); ?&gt;
+  &lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/default/comments-popup.php
===================================================================
--- trunk/wp-content/themes/default/comments-popup.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/comments-popup.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,113 @@
+&lt;?php 
+/* Don't remove these lines. */
+add_filter('comment_text', 'popuplinks');
+foreach ($posts as $post) { start_wp();
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+     &lt;title&gt;&lt;?php echo get_settings('blogname'); ?&gt; - Comments on &lt;?php the_title(); ?&gt;&lt;/title&gt;
+
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+	&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+		@import url( &lt;?php bloginfo('stylesheet_url'); ?&gt; );
+		body { margin: 3px; }
+	&lt;/style&gt;
+
+&lt;/head&gt;
+&lt;body id=&quot;commentspopup&quot;&gt;
+
+&lt;h1 id=&quot;header&quot;&gt;&lt;a href=&quot;&quot; title=&quot;&lt;?php echo get_settings('blogname'); ?&gt;&quot;&gt;&lt;?php echo get_settings('blogname'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+
+&lt;h2 id=&quot;comments&quot;&gt;Comments&lt;/h2&gt;
+
+&lt;p&gt;&lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-commentsrss2.php?p=&lt;?php echo $post-&gt;ID; ?&gt;&quot;&gt;&lt;abbr title=&quot;Really Simple Syndication&quot;&gt;RSS&lt;/abbr&gt; feed for comments on this post.&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php if ('open' == $post-&gt;ping_status) { ?&gt;
+&lt;p&gt;The &lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt; to TrackBack this entry is: &lt;em&gt;&lt;?php trackback_url() ?&gt;&lt;/em&gt;&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php
+// this line is WordPress' motor, do not delete it.
+$comment_author = (isset($_COOKIE['comment_author_' . COOKIEHASH])) ? trim($_COOKIE['comment_author_'. COOKIEHASH]) : '';
+$comment_author_email = (isset($_COOKIE['comment_author_email_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_email_'. COOKIEHASH]) : '';
+$comment_author_url = (isset($_COOKIE['comment_author_url_'. COOKIEHASH])) ? trim($_COOKIE['comment_author_url_'. COOKIEHASH]) : '';
+$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = $id AND comment_approved = '1' ORDER BY comment_date&quot;);
+$commentstatus = $wpdb-&gt;get_row(&quot;SELECT comment_status, post_password FROM $wpdb-&gt;posts WHERE ID = $id&quot;);
+if (!empty($commentstatus-&gt;post_password) &amp;&amp; $_COOKIE['wp-postpass_'. COOKIEHASH] != $commentstatus-&gt;post_password) {  // and it doesn't match the cookie
+	echo(get_the_password_form());
+} else { ?&gt;
+
+&lt;?php if ($comments) { ?&gt;
+&lt;ol id=&quot;commentlist&quot;&gt;
+&lt;?php foreach ($comments as $comment) { ?&gt;
+	&lt;li id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+	&lt;?php comment_text() ?&gt;
+	&lt;p&gt;&lt;cite&gt;&lt;?php comment_type('Comment', 'Trackback', 'Pingback'); ?&gt; by &lt;?php comment_author_link() ?&gt; &#8212; &lt;?php comment_date() ?&gt; @ &lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot;&gt;&lt;?php comment_time() ?&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+	&lt;/li&gt;
+
+&lt;?php } // end for each comment ?&gt;
+&lt;/ol&gt;
+&lt;?php } else { // this is displayed if there are no comments so far ?&gt;
+	&lt;p&gt;No comments yet.&lt;/p&gt;
+&lt;?php } ?&gt;
+
+&lt;?php if ('open' == $commentstatus-&gt;comment_status) { ?&gt;
+&lt;h2&gt;Leave a comment&lt;/h2&gt;
+&lt;p&gt;Line and paragraph breaks automatic, e-mail address never displayed, &lt;acronym title=&quot;Hypertext Markup Language&quot;&gt;HTML&lt;/acronym&gt; allowed: &lt;code&gt;&lt;?php echo allowed_tags(); ?&gt;&lt;/code&gt;&lt;/p&gt;
+
+&lt;form action=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; class=&quot;textarea&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;1&quot; /&gt;
+	   &lt;label for=&quot;author&quot;&gt;Name&lt;/label&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+	&lt;input type=&quot;hidden&quot; name=&quot;redirect_to&quot; value=&quot;&lt;?php echo wp_specialchars($_SERVER[&quot;REQUEST_URI&quot;]); ?&gt;&quot; /&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;2&quot; /&gt;
+	   &lt;label for=&quot;email&quot;&gt;E-mail&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;28&quot; tabindex=&quot;3&quot; /&gt;
+	   &lt;label for=&quot;url&quot;&gt;&lt;acronym title=&quot;Uniform Resource Identifier&quot;&gt;URI&lt;/acronym&gt;&lt;/label&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;label for=&quot;comment&quot;&gt;Your Comment&lt;/label&gt;
+	&lt;br /&gt;
+	  &lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;70&quot; rows=&quot;4&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;
+	&lt;/p&gt;
+
+	&lt;p&gt;
+	  &lt;input name=&quot;submit&quot; type=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Say It!&quot; /&gt;
+	&lt;/p&gt;
+	&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+&lt;/form&gt;
+&lt;?php } else { // comments are closed ?&gt;
+&lt;p&gt;Sorry, the comment form is closed at this time.&lt;/p&gt;
+&lt;?php }
+} // end password check
+?&gt;
+
+&lt;div&gt;&lt;strong&gt;&lt;a href=&quot;javascript:window.close()&quot;&gt;Close this window.&lt;/a&gt;&lt;/strong&gt;&lt;/div&gt;
+
+&lt;?php // if you delete this the sky will fall on your head
+}
+?&gt;
+
+&lt;!-- // this is just the end of the motor - don't touch that line either :) --&gt;
+&lt;?php //} ?&gt; 
+&lt;p class=&quot;credit&quot;&gt;&lt;?php timer_stop(1); ?&gt; &lt;cite&gt;Powered by &lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot; title=&quot;Powered by WordPress, state-of-the-art semantic personal publishing platform&quot;&gt;&lt;strong&gt;Wordpress&lt;/strong&gt;&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
+&lt;?php // Seen at <A HREF="http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18">http://www.mijnkopthee.nl/log2/archive/2003/05/28/esc(18</A>) ?&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+&lt;!--
+document.onkeypress = function esc(e) {	
+	if(typeof(e) == &quot;undefined&quot;) { e=event; }
+	if (e.keyCode == 27) { self.close(); }
+}
+// --&gt;
+&lt;/script&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Added: trunk/wp-content/themes/default/comments.php
===================================================================
--- trunk/wp-content/themes/default/comments.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/comments.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,104 @@
+&lt;?php // Do not delete these lines
+	if ('comments.php' == basename($_SERVER['SCRIPT_FILENAME']))
+		die ('Please do not load this page directly. Thanks!');
+
+        if (!empty($post-&gt;post_password)) { // if there's a password
+            if ($_COOKIE['wp-postpass_' . COOKIEHASH] != $post-&gt;post_password) {  // and it doesn't match the cookie
+				?&gt;
+				
+				&lt;p class=&quot;nocomments&quot;&gt;This post is password protected. Enter the password to view comments.&lt;p&gt;
+				
+				&lt;?php
+				return;
+            }
+        }
+
+		/* This variable is for alternating comment background */
+		$oddcomment = 'alt';
+?&gt;
+
+&lt;!-- You can start editing here. --&gt;
+
+&lt;?php if ($comments) : ?&gt;
+	&lt;h3 id=&quot;comments&quot;&gt;&lt;?php comments_number('No Responses', 'One Response', '% Responses' );?&gt; to &#8220;&lt;?php the_title(); ?&gt;&#8221;&lt;/h3&gt; 
+
+	&lt;ol class=&quot;commentlist&quot;&gt;
+
+	&lt;?php foreach ($comments as $comment) : ?&gt;
+
+		&lt;li class=&quot;&lt;?php echo $oddcomment; ?&gt;&quot; id=&quot;comment-&lt;?php comment_ID() ?&gt;&quot;&gt;
+			&lt;cite&gt;&lt;?php comment_author_link() ?&gt;&lt;/cite&gt; Says:
+			&lt;?php if ($comment-&gt;comment_approved == '0') : ?&gt;
+			&lt;em&gt;Your comment is awaiting moderation.&lt;/em&gt;
+			&lt;?php endif; ?&gt;
+			&lt;br /&gt;
+
+			&lt;small class=&quot;commentmetadata&quot;&gt;&lt;a href=&quot;#comment-&lt;?php comment_ID() ?&gt;&quot; title=&quot;&quot;&gt;&lt;?php comment_date('F jS, Y') ?&gt; at &lt;?php comment_time() ?&gt;&lt;/a&gt; &lt;?php edit_comment_link('e','',''); ?&gt;&lt;/small&gt;
+
+			&lt;?php comment_text() ?&gt;
+
+		&lt;/li&gt;
+
+	&lt;?php /* Changes every other comment to a different class */	
+		if ('alt' == $oddcomment) $oddcomment = '';
+		else $oddcomment = 'alt';
+	?&gt;
+
+	&lt;?php endforeach; /* end for each comment */ ?&gt;
+
+	&lt;/ol&gt;
+
+ &lt;?php else : // this is displayed if there are no comments so far ?&gt;
+
+  &lt;?php if ('open' == $post-&gt;comment_status) : ?&gt; 
+		&lt;!-- If comments are open, but there are no comments. --&gt;
+		
+	 &lt;?php else : // comments are closed ?&gt;
+		&lt;!-- If comments are closed. --&gt;
+		&lt;p class=&quot;nocomments&quot;&gt;Comments are closed.&lt;/p&gt;
+		
+	&lt;?php endif; ?&gt;
+&lt;?php endif; ?&gt;
+
+
+&lt;?php if ('open' == $post-&gt;comment_status) : ?&gt;
+
+&lt;h3 id=&quot;respond&quot;&gt;Leave a Reply&lt;/h3&gt;
+
+&lt;?php if ( get_option('comment_registration') &amp;&amp; !$user_ID ) : ?&gt;
+&lt;p&gt;You must be &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?redirect_to=&lt;?php the_permalink(); ?&gt;&quot;&gt;logged in&lt;/a&gt; to post a comment.&lt;/p&gt;
+&lt;?php else : ?&gt;
+
+&lt;form action=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-comments-post.php&quot; method=&quot;post&quot; id=&quot;commentform&quot;&gt;
+
+&lt;?php if ( $user_ID ) : ?&gt;
+
+&lt;p&gt;Logged in as &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-admin/profile.php&quot;&gt;&lt;?php echo $user_identity; ?&gt;&lt;/a&gt;. &lt;a href=&quot;&lt;?php echo get_option('siteurl'); ?&gt;/wp-login.php?action=logout&quot; title=&quot;Log out of this account&quot;&gt;Logout &raquo;&lt;/a&gt;&lt;/p&gt;
+
+&lt;?php else : ?&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;author&quot; id=&quot;author&quot; value=&quot;&lt;?php echo $comment_author; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;1&quot; /&gt;
+&lt;label for=&quot;author&quot;&gt;&lt;small&gt;Name &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&lt;?php echo $comment_author_email; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;2&quot; /&gt;
+&lt;label for=&quot;email&quot;&gt;&lt;small&gt;Mail (will not be published) &lt;?php if ($req) echo &quot;(required)&quot;; ?&gt;&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;url&quot; id=&quot;url&quot; value=&quot;&lt;?php echo $comment_author_url; ?&gt;&quot; size=&quot;22&quot; tabindex=&quot;3&quot; /&gt;
+&lt;label for=&quot;url&quot;&gt;&lt;small&gt;Website&lt;/small&gt;&lt;/label&gt;&lt;/p&gt;
+
+&lt;?php endif; ?&gt;
+
+&lt;!--&lt;p&gt;&lt;small&gt;&lt;strong&gt;XHTML:&lt;/strong&gt; You can use these tags: &lt;?php echo allowed_tags(); ?&gt;&lt;/small&gt;&lt;/p&gt;--&gt;
+
+&lt;p&gt;&lt;textarea name=&quot;comment&quot; id=&quot;comment&quot; cols=&quot;100%&quot; rows=&quot;10&quot; tabindex=&quot;4&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;
+
+&lt;p&gt;&lt;input name=&quot;submit&quot; type=&quot;submit&quot; id=&quot;submit&quot; tabindex=&quot;5&quot; value=&quot;Submit Comment&quot; /&gt;
+&lt;input type=&quot;hidden&quot; name=&quot;comment_post_ID&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;
+&lt;/p&gt;
+&lt;?php do_action('comment_form', $post-&gt;ID); ?&gt;
+
+&lt;/form&gt;
+
+&lt;?php endif; // If registration required and not logged in ?&gt;
+
+&lt;?php endif; // if you delete this the sky will fall on your head ?&gt;

Added: trunk/wp-content/themes/default/footer.php
===================================================================
--- trunk/wp-content/themes/default/footer.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/footer.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,19 @@
+
+&lt;hr /&gt;
+&lt;div id=&quot;footer&quot;&gt;
+	&lt;p&gt;
+		&lt;?php bloginfo('name'); ?&gt; is proudly powered by
+		&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;
+		&lt;br /&gt;&lt;a href=&quot;feed:&lt;?php bloginfo('rss2_url'); ?&gt;&quot;&gt;Entries (RSS)&lt;/a&gt;
+		and &lt;a href=&quot;feed:&lt;?php bloginfo('comments_rss2_url'); ?&gt;&quot;&gt;Comments (RSS)&lt;/a&gt;.
+		&lt;!-- &lt;?php echo $wpdb-&gt;num_queries; ?&gt; queries. &lt;?php timer_stop(1); ?&gt; seconds. --&gt;
+	&lt;/p&gt;
+&lt;/div&gt;
+&lt;/div&gt;
+
+&lt;?php /* &quot;Just what do you think you're doing Dave?&quot; */ ?&gt;
+
+		&lt;?php wp_footer(); ?&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/header.php
===================================================================
--- trunk/wp-content/themes/default/header.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/header.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,61 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+
+&lt;head profile=&quot;<A HREF="http://gmpg.org/xfn/11">http://gmpg.org/xfn/11</A>&quot;&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('charset'); ?&gt;&quot; /&gt;
+
+&lt;title&gt;&lt;?php bloginfo('name'); ?&gt; &lt;?php if ( is_single() ) { ?&gt; &raquo; Blog Archive &lt;?php } ?&gt; &lt;?php wp_title(); ?&gt;&lt;/title&gt;
+
+&lt;meta name=&quot;generator&quot; content=&quot;WordPress &lt;?php bloginfo('version'); ?&gt;&quot; /&gt; &lt;!-- leave this for stats --&gt;
+
+&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php bloginfo('stylesheet_url'); ?&gt;&quot; type=&quot;text/css&quot; media=&quot;screen&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;RSS 2.0&quot; href=&quot;&lt;?php bloginfo('rss2_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;text/xml&quot; title=&quot;RSS .92&quot; href=&quot;&lt;?php bloginfo('rss_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom 0.3&quot; href=&quot;&lt;?php bloginfo('atom_url'); ?&gt;&quot; /&gt;
+&lt;link rel=&quot;pingback&quot; href=&quot;&lt;?php bloginfo('pingback_url'); ?&gt;&quot; /&gt;
+
+&lt;style type=&quot;text/css&quot; media=&quot;screen&quot;&gt;
+/*	To accomodate differing install paths of WordPress, images are referred only here,
+	and not in the wp-layout.css file. If you prefer to use only CSS for colors and what
+	not, then go right ahead and delete the following lines, and the image files. */
+		
+	body { background: url(&quot;&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/kubrickbgcolor.jpg&quot;); }	
+&lt;?php /* Checks to see whether it needs a sidebar or not */ if ((! $withcomments) &amp;&amp; (! is_single())) { ?&gt;
+	#page { background: url(&quot;&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/kubrickbg.jpg&quot;) repeat-y top; border: none; }
+&lt;?php } else { // No sidebar ?&gt;
+	#page { background: url(&quot;&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/kubrickbgwide.jpg&quot;) repeat-y top; border: none; } 
+&lt;?php } ?&gt;
+	#header { background: url(&quot;&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/kubrickheader.jpg&quot;) no-repeat bottom center; }
+	#footer { background: url(&quot;&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/kubrickfooter.jpg&quot;) no-repeat bottom; border: none;}
+
+/*	Because the template is slightly different, size-wise, with images, this needs to be set here
+	If you don't want to use the template's images, you can also delete the following two lines. */
+		
+	#header 	{ margin: 0 !important; margin: 0 0 0 1px; padding: 1px; height: 198px; width: 758px; }
+	#headerimg 	{ margin: 7px 9px 0; height: 192px; width: 740px; } 
+
+/* 	To ease the insertion of a personal header image, I have done it in such a way,
+	that you simply drop in an image called 'personalheader.jpg' into your /images/
+	directory. Dimensions should be at least 760px x 200px. Anything above that will
+	get cropped off of the image. */
+	/*
+	#headerimg { background: url('&lt;?php bloginfo('stylesheet_directory'); ?&gt;/images/personalheader.jpg') no-repeat top;}
+	*/
+&lt;/style&gt;
+
+&lt;?php wp_get_archives('type=monthly&amp;format=link'); ?&gt;
+
+&lt;?php wp_head(); ?&gt;
+&lt;/head&gt;
+&lt;body&gt;
+
+&lt;div id=&quot;page&quot;&gt;
+
+
+&lt;div id=&quot;header&quot;&gt;
+	&lt;div id=&quot;headerimg&quot;&gt;
+		&lt;h1&gt;&lt;a href=&quot;&lt;?php echo get_settings('home'); ?&gt;&quot;&gt;&lt;?php bloginfo('name'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+		&lt;div class=&quot;description&quot;&gt;&lt;?php bloginfo('description'); ?&gt;&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/div&gt;
+&lt;hr /&gt;

Added: trunk/wp-content/themes/default/images/kubrickbg.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/wp-content/themes/default/images/kubrickbg.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-content/themes/default/images/kubrickbgcolor.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/wp-content/themes/default/images/kubrickbgcolor.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-content/themes/default/images/kubrickbgwide.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/wp-content/themes/default/images/kubrickbgwide.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-content/themes/default/images/kubrickfooter.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/wp-content/themes/default/images/kubrickfooter.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-content/themes/default/images/kubrickheader.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/wp-content/themes/default/images/kubrickheader.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-content/themes/default/index.php
===================================================================
--- trunk/wp-content/themes/default/index.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/index.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,39 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+		
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+				&lt;h2&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+				&lt;small&gt;&lt;?php the_time('F jS, Y') ?&gt; &lt;!-- by &lt;?php the_author() ?&gt; --&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_content('Read the rest of this entry &raquo;'); ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;p class=&quot;center&quot;&gt;Sorry, but you are looking for something that isn't here.&lt;/p&gt;
+		&lt;?php include (TEMPLATEPATH . &quot;/searchform.php&quot;); ?&gt;
+
+	&lt;?php endif; ?&gt;
+
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/default/links.php
===================================================================
--- trunk/wp-content/themes/default/links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,18 @@
+&lt;?php
+/*
+Template Name: Links
+*/
+?&gt;
+
+&lt;?php get_header(); ?&gt;
+
+&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+
+&lt;h2&gt;Links:&lt;/h2&gt;
+&lt;ul&gt;
+&lt;?php get_links_list(); ?&gt;
+&lt;/ul&gt;
+
+&lt;/div&gt;	
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/default/page.php
===================================================================
--- trunk/wp-content/themes/default/page.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/page.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,21 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+    &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+		&lt;h2&gt;&lt;?php the_title(); ?&gt;&lt;/h2&gt;
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this page &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+	  &lt;?php endwhile; endif; ?&gt;
+	&lt;?php edit_post_link('Edit this entry.', '&lt;p&gt;', '&lt;/p&gt;'); ?&gt;
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/search.php
===================================================================
--- trunk/wp-content/themes/default/search.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/search.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,46 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;narrowcolumn&quot;&gt;
+
+	&lt;?php if (have_posts()) : ?&gt;
+
+		&lt;h2 class=&quot;pagetitle&quot;&gt;Search Results&lt;/h2&gt;
+		
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+
+
+		&lt;?php while (have_posts()) : the_post(); ?&gt;
+				
+			&lt;div class=&quot;post&quot;&gt;
+				&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link to &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+				&lt;small&gt;&lt;?php the_time('l, F jS, Y') ?&gt;&lt;/small&gt;
+				
+				&lt;div class=&quot;entry&quot;&gt;
+					&lt;?php the_excerpt() ?&gt;
+				&lt;/div&gt;
+		
+				&lt;p class=&quot;postmetadata&quot;&gt;Posted in &lt;?php the_category(', ') ?&gt; &lt;strong&gt;|&lt;/strong&gt; &lt;?php edit_post_link('Edit','','&lt;strong&gt;|&lt;/strong&gt;'); ?&gt;  &lt;?php comments_popup_link('No Comments &#187;', '1 Comment &#187;', '% Comments &#187;'); ?&gt;&lt;/p&gt;
+			&lt;/div&gt;
+	
+		&lt;?php endwhile; ?&gt;
+
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php next_posts_link('&laquo; Previous Entries') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php previous_posts_link('Next Entries &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+	&lt;?php else : ?&gt;
+
+		&lt;h2 class=&quot;center&quot;&gt;Not Found&lt;/h2&gt;
+		&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+
+	&lt;?php endif; ?&gt;
+		
+	&lt;/div&gt;
+
+&lt;?php get_sidebar(); ?&gt;
+
+&lt;?php get_footer(); ?&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/searchform.php
===================================================================
--- trunk/wp-content/themes/default/searchform.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/searchform.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,5 @@
+&lt;form method=&quot;get&quot; id=&quot;searchform&quot; action=&quot;&lt;?php echo $_SERVER['PHP_SELF']; ?&gt;&quot;&gt;
+&lt;div&gt;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo wp_specialchars($s, 1); ?&gt;&quot; name=&quot;s&quot; id=&quot;s&quot; /&gt;
+&lt;input type=&quot;submit&quot; id=&quot;searchsubmit&quot; value=&quot;Search&quot; /&gt;
+&lt;/div&gt;
+&lt;/form&gt;
\ No newline at end of file

Added: trunk/wp-content/themes/default/sidebar.php
===================================================================
--- trunk/wp-content/themes/default/sidebar.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/sidebar.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,72 @@
+	&lt;div id=&quot;sidebar&quot;&gt;
+		&lt;ul&gt;
+			
+			&lt;li&gt;
+				&lt;?php include (TEMPLATEPATH . '/searchform.php'); ?&gt;
+			&lt;/li&gt;
+
+			&lt;!-- Author information is disabled per default. Uncomment and fill in your details if you want to use it.
+			&lt;li&gt;&lt;h2&gt;Author&lt;/h2&gt;
+			&lt;p&gt;A little something about you, the author. Nothing lengthy, just an overview.&lt;/p&gt;
+			&lt;/li&gt;
+			--&gt;
+
+			&lt;li&gt;
+			&lt;?php /* If this is a 404 page */ if (is_404()) { ?&gt;
+			&lt;?php /* If this is a category archive */ } elseif (is_category()) { ?&gt;
+			&lt;p&gt;You are currently browsing the archives for the &lt;?php single_cat_title(''); ?&gt; category.&lt;/p&gt;
+			
+			&lt;?php /* If this is a yearly archive */ } elseif (is_day()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for the day &lt;?php the_time('l, F jS, Y'); ?&gt;.&lt;/p&gt;
+			
+			&lt;?php /* If this is a monthly archive */ } elseif (is_month()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for &lt;?php the_time('F, Y'); ?&gt;.&lt;/p&gt;
+
+      &lt;?php /* If this is a yearly archive */ } elseif (is_year()) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for the year &lt;?php the_time('Y'); ?&gt;.&lt;/p&gt;
+			
+		 &lt;?php /* If this is a monthly archive */ } elseif (is_search()) { ?&gt;
+			&lt;p&gt;You have searched the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives
+			for &lt;strong&gt;'&lt;?php echo wp_specialchars($s); ?&gt;'&lt;/strong&gt;. If you are unable to find anything in these search results, you can try one of these links.&lt;/p&gt;
+
+			&lt;?php /* If this is a monthly archive */ } elseif (isset($_GET['paged']) &amp;&amp; !empty($_GET['paged'])) { ?&gt;
+			&lt;p&gt;You are currently browsing the &lt;a href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;&quot;&gt;&lt;?php echo bloginfo('name'); ?&gt;&lt;/a&gt; weblog archives.&lt;/p&gt;
+
+			&lt;?php } ?&gt;
+			&lt;/li&gt;
+
+			&lt;?php wp_list_pages('title_li=&lt;h2&gt;Pages&lt;/h2&gt;' ); ?&gt;
+
+			&lt;li&gt;&lt;h2&gt;Archives&lt;/h2&gt;
+				&lt;ul&gt;
+				&lt;?php wp_get_archives('type=monthly'); ?&gt;
+				&lt;/ul&gt;
+			&lt;/li&gt;
+
+			&lt;li&gt;&lt;h2&gt;Categories&lt;/h2&gt;
+				&lt;ul&gt;
+				&lt;?php wp_list_cats('sort_column=name&amp;optioncount=1&amp;hierarchical=0'); ?&gt;
+				&lt;/ul&gt;
+			&lt;/li&gt;
+
+			&lt;?php /* If this is the frontpage */ if ( is_home() || is_page() ) { ?&gt;				
+				&lt;?php get_links_list(); ?&gt;
+				
+				&lt;li&gt;&lt;h2&gt;Meta&lt;/h2&gt;
+				&lt;ul&gt;
+					&lt;?php wp_register(); ?&gt;
+					&lt;li&gt;&lt;?php wp_loginout(); ?&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://validator.w3.org/check/referer">http://validator.w3.org/check/referer</A>&quot; title=&quot;This page validates as XHTML 1.0 Transitional&quot;&gt;Valid &lt;abbr title=&quot;eXtensible HyperText Markup Language&quot;&gt;XHTML&lt;/abbr&gt;&lt;/a&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://gmpg.org/xfn/">http://gmpg.org/xfn/</A>&quot;&gt;&lt;abbr title=&quot;XHTML Friends Network&quot;&gt;XFN&lt;/abbr&gt;&lt;/a&gt;&lt;/li&gt;
+					&lt;li&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot; title=&quot;Powered by WordPress, state-of-the-art semantic personal publishing platform.&quot;&gt;WordPress&lt;/a&gt;&lt;/li&gt;
+					&lt;?php wp_meta(); ?&gt;
+				&lt;/ul&gt;
+				&lt;/li&gt;
+			&lt;?php } ?&gt;
+			
+		&lt;/ul&gt;
+	&lt;/div&gt;
+

Added: trunk/wp-content/themes/default/single.php
===================================================================
--- trunk/wp-content/themes/default/single.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/single.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,65 @@
+&lt;?php get_header(); ?&gt;
+
+	&lt;div id=&quot;content&quot; class=&quot;widecolumn&quot;&gt;
+				
+  &lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+	
+		&lt;div class=&quot;navigation&quot;&gt;
+			&lt;div class=&quot;alignleft&quot;&gt;&lt;?php previous_post_link('&laquo; %link') ?&gt;&lt;/div&gt;
+			&lt;div class=&quot;alignright&quot;&gt;&lt;?php next_post_link('%link &raquo;') ?&gt;&lt;/div&gt;
+		&lt;/div&gt;
+	
+		&lt;div class=&quot;post&quot; id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;
+			&lt;h2&gt;&lt;a href=&quot;&lt;?php echo get_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link: &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h2&gt;
+	
+			&lt;div class=&quot;entrytext&quot;&gt;
+				&lt;?php the_content('&lt;p class=&quot;serif&quot;&gt;Read the rest of this entry &raquo;&lt;/p&gt;'); ?&gt;
+	
+				&lt;?php link_pages('&lt;p&gt;&lt;strong&gt;Pages:&lt;/strong&gt; ', '&lt;/p&gt;', 'number'); ?&gt;
+	
+				&lt;p class=&quot;postmetadata alt&quot;&gt;
+					&lt;small&gt;
+						This entry was posted
+						&lt;?php /* This is commented, because it requires a little adjusting sometimes.
+							You'll need to download this plugin, and follow the instructions:
+							<A HREF="http://binarybonsai.com/archives/2004/08/17/time-since-plugin/">http://binarybonsai.com/archives/2004/08/17/time-since-plugin/</A> */
+							/* $entry_datetime = abs(strtotime($post-&gt;post_date) - (60*120)); echo time_since($entry_datetime); echo ' ago'; */ ?&gt; 
+						on &lt;?php the_time('l, F jS, Y') ?&gt; at &lt;?php the_time() ?&gt;
+						and is filed under &lt;?php the_category(', ') ?&gt;.
+						You can follow any responses to this entry through the &lt;?php comments_rss_link('RSS 2.0'); ?&gt; feed. 
+						
+						&lt;?php if (('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Both Comments and Pings are open ?&gt;
+							You can &lt;a href=&quot;#respond&quot;&gt;leave a response&lt;/a&gt;, or &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt;&quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; ('open' == $post-&gt;ping_status)) {
+							// Only Pings are Open ?&gt;
+							Responses are currently closed, but you can &lt;a href=&quot;&lt;?php trackback_url(true); ?&gt; &quot; rel=&quot;trackback&quot;&gt;trackback&lt;/a&gt; from your own site.
+						
+						&lt;?php } elseif (('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Comments are open, Pings are not ?&gt;
+							You can skip to the end and leave a response. Pinging is currently not allowed.
+			
+						&lt;?php } elseif (!('open' == $post-&gt; comment_status) &amp;&amp; !('open' == $post-&gt;ping_status)) {
+							// Neither Comments, nor Pings are open ?&gt;
+							Both comments and pings are currently closed.			
+						
+						&lt;?php } edit_post_link('Edit this entry.','',''); ?&gt;
+						
+					&lt;/small&gt;
+				&lt;/p&gt;
+	
+			&lt;/div&gt;
+		&lt;/div&gt;
+		
+	&lt;?php comments_template(); ?&gt;
+	
+	&lt;?php endwhile; else: ?&gt;
+	
+		&lt;p&gt;Sorry, no posts matched your criteria.&lt;/p&gt;
+	
+&lt;?php endif; ?&gt;
+	
+	&lt;/div&gt;
+
+&lt;?php get_footer(); ?&gt;

Added: trunk/wp-content/themes/default/style.css
===================================================================
--- trunk/wp-content/themes/default/style.css	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-content/themes/default/style.css	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,610 @@
+/*  
+Theme Name: WordPress Default
+Theme URI: <A HREF="http://wordpress.org/">http://wordpress.org/</A>
+Description: The default WordPress theme based on the famous &lt;a href=&quot;<A HREF="http://binarybonsai.com/kubrick/">http://binarybonsai.com/kubrick/</A>&quot;&gt;Kubrick&lt;/a&gt;.
+Version: 1.5
+Author: Michael Heilemann
+Author URI: <A HREF="http://binarybonsai.com/">http://binarybonsai.com/</A>
+
+	Kubrick v1.5
+	 <A HREF="http://binarybonsai.com/kubrick/">http://binarybonsai.com/kubrick/</A>
+
+	This theme was designed and built by Michael Heilemann,
+	whose blog you will find at <A HREF="http://binarybonsai.com/">http://binarybonsai.com/</A>
+
+	The CSS, XHTML and design is released under GPL:
+	<A HREF="http://www.opensource.org/licenses/gpl-license.php">http://www.opensource.org/licenses/gpl-license.php</A>
+	
+
+	*** REGARDING IMAGES ***
+	All CSS that involves the use of images, can be found in the 'index.php' file.
+	This is to ease installation inside subdirectories of a server.
+
+	Have fun, and don't be afraid to contact me if you have questions.
+*/
+
+
+
+/* Begin Typography &amp; Colors */
+body {
+	font-size: 62.5%; /* Resets 1em to 10px */
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	background-color: #d5d6d7;
+	color: #333;
+	text-align: center;
+	}
+
+#page {
+	background-color: white;
+	border: 1px solid #959596;
+	text-align: left;
+	}
+
+#header {
+	background-color: #73a0c5;
+	}
+
+#content {
+	font-size: 1.2em
+	}
+
+.widecolumn .entry p {
+	font-size: 1.05em;
+	}
+
+.narrowcolumn .entry, .widecolumn .entry {
+	line-height: 1.4em;
+	}
+
+.widecolumn {
+	line-height: 1.6em;
+	}
+	
+.narrowcolumn .postmetadata {
+	text-align: center;
+	}
+
+.alt {
+	background-color: #f8f8f8;
+	border-top: 1px solid #ddd;
+	border-bottom: 1px solid #ddd;
+	}
+
+#footer {
+	background-color: #eee;
+	}
+
+small {
+	font-family: Arial, Helvetica, Sans-Serif;
+	font-size: 0.9em;
+	line-height: 1.5em;
+	}
+
+h1, h2, h3 {
+	font-family: 'Trebuchet MS', 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	font-weight: bold;
+	}
+
+h1 {
+	font-size: 4em;
+	text-align: center;
+	}
+
+.description {
+	font-size: 1.2em;
+	text-align: center;
+	}
+
+h2 {
+	font-size: 1.6em;
+	}
+
+h2.pagetitle {
+	font-size: 1.6em;
+	}
+
+#sidebar h2 {
+	font-family: 'Lucida Grande', Verdana, Sans-Serif;
+	font-size: 1.2em;
+	}
+
+h3 {
+	font-size: 1.3em;
+	}
+
+h1, h1 a, h1 a:hover, h1 a:visited, .description {
+	text-decoration: none;
+	color: white;
+	}
+
+h2, h2 a, h2 a:visited, h3, h3 a, h3 a:visited {
+	color: #333;
+	}
+
+h2, h2 a, h2 a:hover, h2 a:visited, h3, h3 a, h3 a:hover, h3 a:visited, #sidebar h2, #wp-calendar caption, cite {
+	text-decoration: none;
+	}
+
+.entry p a:visited {
+	color: #b85b5a;
+	}
+
+.commentlist li, #commentform input, #commentform textarea {
+	font: 0.9em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+	
+.commentlist li {
+	font-weight: bold;
+	}
+
+.commentlist cite, .commentlist cite a {
+	font-weight: bold;
+	font-style: normal;
+	font-size: 1.1em;
+	}
+
+.commentlist p {
+	font-weight: normal;
+	line-height: 1.5em;
+	text-transform: none;
+	}
+
+#commentform p {
+	font-family: 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+.commentmetadata {
+	font-weight: normal;
+	}
+
+#sidebar {
+	font: 1em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	}
+
+small, #sidebar ul ul li, #sidebar ul ol li, .nocomments, .postmetadata, blockquote, strike {
+	color: #777;
+	}
+	
+code {
+	font: 1.1em 'Courier New', Courier, Fixed;
+	}
+
+acronym, abbr, span.caps
+{
+	font-size: 0.9em;
+	letter-spacing: .07em;
+	}
+
+a, h2 a:hover, h3 a:hover {
+	color: #06c;
+	text-decoration: none;
+	}
+
+a:hover {
+	color: #147;
+	text-decoration: underline;
+	}
+	
+#wp-calendar #prev a {
+	font-size: 9pt;
+	}
+
+#wp-calendar a {
+	text-decoration: none;
+	}
+
+#wp-calendar caption {
+	font: bold 1.3em 'Lucida Grande', Verdana, Arial, Sans-Serif;
+	text-align: center;
+	}
+
+#wp-calendar th {
+	font-style: normal;
+	text-transform: capitalize;
+	}
+/* End Typography &amp; Colors */
+
+
+
+/* Begin Structure */
+body {
+	margin: 0;
+	padding: 0; 
+	}
+
+#page {
+	background-color: white;
+	margin: 20px auto;
+	padding: 0;
+	width: 760px;
+	border: 1px solid #959596;
+	}
+	
+#header {
+	padding: 0;
+	margin: 0 auto;
+	height: 200px;
+	width: 100%;
+	background-color: #73a0c5;
+	}
+
+#headerimg {
+	margin: 0;
+	height: 200px;
+	width: 100%;
+	}
+
+.narrowcolumn {
+	float: left;
+	padding: 0 0 20px 45px;
+	margin: 0px 0 0;
+	width: 450px;
+	}
+
+.widecolumn {
+	padding: 10px 0 20px 0;
+	margin: 5px 0 0 150px;
+	width: 450px;
+	}
+	
+.post {
+	margin: 0 0 40px;
+	text-align: justify;
+	}
+
+.widecolumn .post {
+	margin: 0;
+	}
+
+.narrowcolumn .postmetadata {
+	padding-top: 5px;
+	}
+
+.widecolumn .postmetadata {
+	margin: 30px 0;
+	}
+	
+#footer {
+	padding: 0 0 0 1px;
+	margin: 0 auto;
+	width: 760px;
+	clear: both;
+	}
+
+#footer p {
+	margin: 0;
+	padding: 20px 0;
+	text-align: center;
+	}
+/* End Structure */
+
+
+
+/*	Begin Headers */
+h1 {
+	padding-top: 70px;
+	margin: 0;
+	}
+
+.description {
+	text-align: center;
+	}
+
+h2 {
+	margin: 30px 0 0;
+	}
+
+h2.pagetitle {
+	margin-top: 30px;
+	text-align: center;
+}
+
+#sidebar h2 {
+	margin: 5px 0 0;
+	padding: 0;
+	}
+
+h3 {
+	padding: 0;
+	margin: 30px 0 0;
+	}
+
+h3.comments {
+	padding: 0;
+	margin: 40px auto 20px ;
+	}
+/* End Headers */
+
+
+
+/* Begin Images */
+p img {
+	padding: 0;
+	max-width: 100%;
+	}
+
+/*	Using 'class=&quot;alignright&quot;' on an image will (who would've
+	thought?!) align the image to the right. And using 'class=&quot;centered',
+	will of course center the image. This is much better than using
+	align=&quot;center&quot;, being much more futureproof (and valid) */
+	
+img.centered {
+	display: block;
+	margin-left: auto;
+	margin-right: auto;
+	}
+	
+img.alignright {
+	padding: 4px;
+	margin: 0 0 2px 7px;
+	display: inline;
+	}
+
+img.alignleft {
+	padding: 4px;
+	margin: 0 7px 2px 0;
+	display: inline;
+	}
+
+.alignright {
+	float: right;
+	}
+	
+.alignleft {
+	float: left
+	}
+/* End Images */
+
+
+
+/* Begin Lists
+
+	Special stylized non-IE bullets
+	Do not work in Internet Explorer, which merely default to normal bullets. */
+
+html&gt;body .entry ul {
+	margin-left: 0px;
+	padding: 0 0 0 30px;
+	list-style: none;
+	padding-left: 10px;
+	text-indent: -10px;
+	} 
+
+html&gt;body .entry li {
+	margin: 7px 0 8px 10px;
+	}
+
+.entry ul li:before, #sidebar ul ul li:before {
+	content: &quot;\00BB \0020&quot;;
+	}
+
+.entry ol {
+	padding: 0 0 0 35px;
+	margin: 0;
+	}
+
+.entry ol li {
+	margin: 0;
+	padding: 0;
+	}
+
+.postmetadata ul, .postmetadata li {
+	display: inline;
+	list-style-type: none;
+	list-style-image: none;
+	}
+	
+#sidebar ul, #sidebar ul ol {
+	margin: 0;
+	padding: 0;
+	}
+
+#sidebar ul li {
+	list-style-type: none;
+	list-style-image: none;
+	margin-bottom: 15px;
+	}
+
+#sidebar ul p, #sidebar ul select {
+	margin: 5px 0 8px;
+	}
+
+#sidebar ul ul, #sidebar ul ol {
+	margin: 5px 0 0 10px;
+	}
+
+#sidebar ul ul ul, #sidebar ul ol {
+	margin: 0 0 0 10px;
+	}
+
+ol li, #sidebar ul ol li {
+	list-style: decimal outside;
+	}
+
+#sidebar ul ul li, #sidebar ul ol li {
+	margin: 3px 0 0;
+	padding: 0;
+	}
+/* End Entry Lists */
+
+
+
+/* Begin Form Elements */
+#searchform {
+	margin: 10px auto;
+	padding: 5px 3px; 
+	text-align: center;
+	}
+
+#sidebar #searchform #s {
+	width: 115px;
+	padding: 2px;
+	}
+
+#sidebar #searchsubmit {
+	padding: 1px;
+	}
+
+.entry form { /* This is mainly for password protected posts, makes them look better. */
+	text-align:center;
+	}
+
+select {
+	width: 130px;
+	}
+
+#commentform input {
+	width: 170px;
+	padding: 2px;
+	margin: 5px 5px 1px 0;
+	}
+
+#commentform textarea {
+	width: 100%;
+	padding: 2px;
+	}
+
+#commentform #submit {
+	margin: 0;
+	float: right;
+	}
+/* End Form Elements */
+
+
+
+/* Begin Comments*/
+.alt {
+	margin: 0;
+	padding: 10px;
+	}
+
+.commentlist {
+	padding: 0;
+	text-align: justify;
+	}
+
+.commentlist li {
+	margin: 15px 0 3px;
+	padding: 5px 10px 3px;
+	list-style: none;
+	}
+
+.commentlist p {
+	margin: 10px 5px 10px 0;
+	}
+
+#commentform p {
+	margin: 5px 0;
+	}
+
+.nocomments {
+	text-align: center;
+	margin: 0;
+	padding: 0;
+	}
+
+.commentmetadata {
+	margin: 0;
+	display: block;
+	}
+/* End Comments */
+
+
+
+/* Begin Sidebar */
+#sidebar
+{
+	padding: 20px 0 10px 0;
+	margin-left: 545px;
+	width: 190px;
+	}
+
+#sidebar form {
+	margin: 0;
+	}
+/* End Sidebar */
+
+
+
+/* Begin Calendar */
+#wp-calendar {
+	empty-cells: show;
+	margin: 10px auto 0;
+	width: 155px;
+	}
+
+#wp-calendar #next a {
+	padding-right: 10px;
+	text-align: right;
+	}
+
+#wp-calendar #prev a {
+	padding-left: 10px;
+	text-align: left;
+	}
+
+#wp-calendar a {
+	display: block;
+	}
+
+#wp-calendar caption {
+	text-align: center;
+	width: 100%;
+	}
+
+#wp-calendar td {
+	padding: 3px 0;
+	text-align: center;
+	}
+
+#wp-calendar td.pad:hover { /* Doesn't work in IE */
+	background-color: #fff; }
+/* End Calendar */
+
+
+
+/* Begin Various Tags &amp; Classes */
+acronym, abbr, span.caps {
+	cursor: help;
+	}
+
+acronym, abbr {
+	border-bottom: 1px dashed #999;
+	}
+
+blockquote {
+	margin: 15px 30px 0 10px;
+	padding-left: 20px;
+	border-left: 5px solid #ddd;
+	}
+
+blockquote cite {
+	margin: 5px 0 0;
+	display: block;
+	}
+
+.center {
+	text-align: center;
+	}
+
+hr {
+	display: none;
+	}
+
+a img {
+	border: none;
+	}
+
+.navigation {
+	display: block;
+	text-align: center;
+	margin-top: 10px;
+	margin-bottom: 60px;
+	}
+/* End Various Tags &amp; Classes*/
+
+
+
+/* &quot;Daisy, Daisy, give me your answer do. I'm half crazy all for the love of you.
+	It won't be a stylish marriage, I can't afford a carriage.
+	But you'll look sweet upon the seat of a bicycle built for two.&quot; */

Added: trunk/wp-feed.php
===================================================================
--- trunk/wp-feed.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-feed.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,37 @@
+&lt;?php
+
+if (empty($doing_rss)) {
+    $doing_rss = 1;
+    require(dirname(__FILE__) . '/wp-blog-header.php');
+}
+
+// Remove the pad, if present.
+$feed = preg_replace('/^_+/', '', $feed);
+
+if ($feed == '' || $feed == 'feed') {
+    $feed = 'rss2';
+}
+
+if ( is_single() || ($withcomments == 1) ) {
+    require(ABSPATH . 'wp-commentsrss2.php');
+} else {
+    switch ($feed) {
+    case 'atom':
+        require(ABSPATH . 'wp-atom.php');
+        break;
+    case 'rdf':
+        require(ABSPATH . 'wp-rdf.php');
+        break;
+    case 'rss':
+        require(ABSPATH . 'wp-rss.php');
+        break;
+    case 'rss2':
+        require(ABSPATH . 'wp-rss2.php');
+        break;
+    case 'comments-rss2':
+        require(ABSPATH . 'wp-commentsrss2.php');
+        break;
+    }
+}
+
+?&gt;

Added: trunk/wp-images/smilies/icon_arrow.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_arrow.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_biggrin.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_biggrin.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_confused.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_confused.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_cool.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_cool.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_cry.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_cry.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_eek.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_eek.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_evil.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_evil.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_exclaim.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_exclaim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_idea.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_idea.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_lol.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_lol.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_mad.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_mad.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_mrgreen.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_mrgreen.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_neutral.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_neutral.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_question.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_question.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_razz.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_razz.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_redface.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_redface.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_rolleyes.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_rolleyes.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_sad.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_sad.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_smile.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_smile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_surprised.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_surprised.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_twisted.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_twisted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/smilies/icon_wink.gif
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/smilies/icon_wink.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/wp-small.png
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/wp-small.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-images/wpminilogo.png
===================================================================
(Binary files differ)


Property changes on: trunk/wp-images/wpminilogo.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/wp-includes/class-IXR.php
===================================================================
--- trunk/wp-includes/class-IXR.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/class-IXR.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,828 @@
+&lt;?php
+
+/* 
+   IXR - The Inutio XML-RPC Library - (c) Incutio Ltd 2002
+   Version 1.62WP - Simon Willison, 11th July 2003 (htmlentities -&gt; htmlspecialchars)
+           ^^^^^^ (We've made some changes)
+   Site:   <A HREF="http://scripts.incutio.com/xmlrpc/">http://scripts.incutio.com/xmlrpc/</A>
+   Manual: <A HREF="http://scripts.incutio.com/xmlrpc/manual.php">http://scripts.incutio.com/xmlrpc/manual.php</A>
+   Made available under the BSD License: <A HREF="http://www.opensource.org/licenses/bsd-license.php">http://www.opensource.org/licenses/bsd-license.php</A>
+*/
+
+
+class IXR_Value {
+    var $data;
+    var $type;
+    function IXR_Value ($data, $type = false) {
+        $this-&gt;data = $data;
+        if (!$type) {
+            $type = $this-&gt;calculateType();
+        }
+        $this-&gt;type = $type;
+        if ($type == 'struct') {
+            /* Turn all the values in the array in to new IXR_Value objects */
+            foreach ($this-&gt;data as $key =&gt; $value) {
+                $this-&gt;data[$key] = new IXR_Value($value);
+            }
+        }
+        if ($type == 'array') {
+            for ($i = 0, $j = count($this-&gt;data); $i &lt; $j; $i++) {
+                $this-&gt;data[$i] = new IXR_Value($this-&gt;data[$i]);
+            }
+        }
+    }
+    function calculateType() {
+        if ($this-&gt;data === true || $this-&gt;data === false) {
+            return 'boolean';
+        }
+        if (is_integer($this-&gt;data)) {
+            return 'int';
+        }
+        if (is_double($this-&gt;data)) {
+            return 'double';
+        }
+        // Deal with IXR object types base64 and date
+        if (is_object($this-&gt;data) &amp;&amp; is_a($this-&gt;data, 'IXR_Date')) {
+            return 'date';
+        }
+        if (is_object($this-&gt;data) &amp;&amp; is_a($this-&gt;data, 'IXR_Base64')) {
+            return 'base64';
+        }
+        // If it is a normal PHP object convert it in to a struct
+        if (is_object($this-&gt;data)) {
+            
+            $this-&gt;data = get_object_vars($this-&gt;data);
+            return 'struct';
+        }
+        if (!is_array($this-&gt;data)) {
+            return 'string';
+        }
+        /* We have an array - is it an array or a struct ? */
+        if ($this-&gt;isStruct($this-&gt;data)) {
+            return 'struct';
+        } else {
+            return 'array';
+        }
+    }
+    function getXml() {
+        /* Return XML for this value */
+        switch ($this-&gt;type) {
+            case 'boolean':
+                return '&lt;boolean&gt;'.(($this-&gt;data) ? '1' : '0').'&lt;/boolean&gt;';
+                break;
+            case 'int':
+                return '&lt;int&gt;'.$this-&gt;data.'&lt;/int&gt;';
+                break;
+            case 'double':
+                return '&lt;double&gt;'.$this-&gt;data.'&lt;/double&gt;';
+                break;
+            case 'string':
+                return '&lt;string&gt;'.htmlspecialchars($this-&gt;data).'&lt;/string&gt;';
+                break;
+            case 'array':
+                $return = '&lt;array&gt;&lt;data&gt;'.&quot;\n&quot;;
+                foreach ($this-&gt;data as $item) {
+                    $return .= '  &lt;value&gt;'.$item-&gt;getXml().&quot;&lt;/value&gt;\n&quot;;
+                }
+                $return .= '&lt;/data&gt;&lt;/array&gt;';
+                return $return;
+                break;
+            case 'struct':
+                $return = '&lt;struct&gt;'.&quot;\n&quot;;
+                foreach ($this-&gt;data as $name =&gt; $value) {
+                    $return .= &quot;  &lt;member&gt;&lt;name&gt;$name&lt;/name&gt;&lt;value&gt;&quot;;
+                    $return .= $value-&gt;getXml().&quot;&lt;/value&gt;&lt;/member&gt;\n&quot;;
+                }
+                $return .= '&lt;/struct&gt;';
+                return $return;
+                break;
+            case 'date':
+            case 'base64':
+                return $this-&gt;data-&gt;getXml();
+                break;
+        }
+        return false;
+    }
+    function isStruct($array) {
+        /* Nasty function to check if an array is a struct or not */
+        $expected = 0;
+        foreach ($array as $key =&gt; $value) {
+            if ((string)$key != (string)$expected) {
+                return true;
+            }
+            $expected++;
+        }
+        return false;
+    }
+}
+
+
+class IXR_Message {
+    var $message;
+    var $messageType;  // methodCall / methodResponse / fault
+    var $faultCode;
+    var $faultString;
+    var $methodName;
+    var $params;
+    // Current variable stacks
+    var $_arraystructs = array();   // The stack used to keep track of the current array/struct
+    var $_arraystructstypes = array(); // Stack keeping track of if things are structs or array
+    var $_currentStructName = array();  // A stack as well
+    var $_param;
+    var $_value;
+    var $_currentTag;
+    var $_currentTagContents;
+    // The XML parser
+    var $_parser;
+    function IXR_Message ($message) {
+        $this-&gt;message = $message;
+    }
+    function parse() {
+        // first remove the XML declaration
+        $this-&gt;message = preg_replace('/&lt;\?xml(.*)?\?'.'&gt;/', '', $this-&gt;message);
+        if (trim($this-&gt;message) == '') {
+            return false;
+        }
+        $this-&gt;_parser = xml_parser_create();
+        // Set XML parser to take the case of tags in to account
+        xml_parser_set_option($this-&gt;_parser, XML_OPTION_CASE_FOLDING, false);
+        // Set XML parser callback functions
+        xml_set_object($this-&gt;_parser, $this);
+        xml_set_element_handler($this-&gt;_parser, 'tag_open', 'tag_close');
+        xml_set_character_data_handler($this-&gt;_parser, 'cdata');
+        if (!xml_parse($this-&gt;_parser, $this-&gt;message)) {
+            /* die(sprintf('XML error: %s at line %d',
+                xml_error_string(xml_get_error_code($this-&gt;_parser)),
+                xml_get_current_line_number($this-&gt;_parser))); */
+            return false;
+        }
+        xml_parser_free($this-&gt;_parser);
+        // Grab the error messages, if any
+        if ($this-&gt;messageType == 'fault') {
+            $this-&gt;faultCode = $this-&gt;params[0]['faultCode'];
+            $this-&gt;faultString = $this-&gt;params[0]['faultString'];
+        }
+        return true;
+    }
+    function tag_open($parser, $tag, $attr) {
+        $this-&gt;currentTag = $tag;
+        switch($tag) {
+            case 'methodCall':
+            case 'methodResponse':
+            case 'fault':
+                $this-&gt;messageType = $tag;
+                break;
+            /* Deal with stacks of arrays and structs */
+            case 'data':    // data is to all intents and puposes more interesting than array
+                $this-&gt;_arraystructstypes[] = 'array';
+                $this-&gt;_arraystructs[] = array();
+                break;
+            case 'struct':
+                $this-&gt;_arraystructstypes[] = 'struct';
+                $this-&gt;_arraystructs[] = array();
+                break;
+        }
+    }
+    function cdata($parser, $cdata) {
+        $this-&gt;_currentTagContents .= $cdata;
+    }
+    function tag_close($parser, $tag) {
+        $valueFlag = false;
+        switch($tag) {
+            case 'int':
+            case 'i4':
+                $value = (int)trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            case 'double':
+                $value = (double)trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            case 'string':
+                $value = (string)trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            case 'dateTime.iso8601':
+                $value = new IXR_Date(trim($this-&gt;_currentTagContents));
+                // $value = $iso-&gt;getTimestamp();
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            case 'value':
+                // &quot;If no type is indicated, the type is string.&quot;
+                if (trim($this-&gt;_currentTagContents) != '') {
+                    $value = (string)$this-&gt;_currentTagContents;
+                    $this-&gt;_currentTagContents = '';
+                    $valueFlag = true;
+                }
+                break;
+            case 'boolean':
+                $value = (boolean)trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            case 'base64':
+                $value = base64_decode( trim($this-&gt;_currentTagContents) );
+                $this-&gt;_currentTagContents = '';
+                $valueFlag = true;
+                break;
+            /* Deal with stacks of arrays and structs */
+            case 'data':
+            case 'struct':
+                $value = array_pop($this-&gt;_arraystructs);
+                array_pop($this-&gt;_arraystructstypes);
+                $valueFlag = true;
+                break;
+            case 'member':
+                array_pop($this-&gt;_currentStructName);
+                break;
+            case 'name':
+                $this-&gt;_currentStructName[] = trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                break;
+            case 'methodName':
+                $this-&gt;methodName = trim($this-&gt;_currentTagContents);
+                $this-&gt;_currentTagContents = '';
+                break;
+        }
+        if ($valueFlag) {
+            /*
+            if (!is_array($value) &amp;&amp; !is_object($value)) {
+                $value = trim($value);
+            }
+            */
+            if (count($this-&gt;_arraystructs) &gt; 0) {
+                // Add value to struct or array
+                if ($this-&gt;_arraystructstypes[count($this-&gt;_arraystructstypes)-1] == 'struct') {
+                    // Add to struct
+                    $this-&gt;_arraystructs[count($this-&gt;_arraystructs)-1][$this-&gt;_currentStructName[count($this-&gt;_currentStructName)-1]] = $value;
+                } else {
+                    // Add to array
+                    $this-&gt;_arraystructs[count($this-&gt;_arraystructs)-1][] = $value;
+                }
+            } else {
+                // Just add as a paramater
+                $this-&gt;params[] = $value;
+            }
+        }
+    }       
+}
+
+
+class IXR_Server {
+    var $data;
+    var $callbacks = array();
+    var $message;
+    var $capabilities;
+    function IXR_Server($callbacks = false, $data = false) {
+        $this-&gt;setCapabilities();
+        if ($callbacks) {
+            $this-&gt;callbacks = $callbacks;
+        }
+        $this-&gt;setCallbacks();
+        $this-&gt;serve($data);
+    }
+    function serve($data = false) {
+        if (!$data) {
+            global $HTTP_RAW_POST_DATA;
+            if (!$HTTP_RAW_POST_DATA) {
+               die('XML-RPC server accepts POST requests only.');
+            }
+            $data = $HTTP_RAW_POST_DATA;
+        }
+        $this-&gt;message = new IXR_Message($data);
+        if (!$this-&gt;message-&gt;parse()) {
+            $this-&gt;error(-32700, 'parse error. not well formed');
+        }
+        if ($this-&gt;message-&gt;messageType != 'methodCall') {
+            $this-&gt;error(-32600, 'server error. invalid xml-rpc. not conforming to spec. Request must be a methodCall');
+        }
+        $result = $this-&gt;call($this-&gt;message-&gt;methodName, $this-&gt;message-&gt;params);
+        // Is the result an error?
+        if (is_a($result, 'IXR_Error')) {
+            $this-&gt;error($result);
+        }
+        // Encode the result
+        $r = new IXR_Value($result);
+        $resultxml = $r-&gt;getXml();
+        // Create the XML
+        $xml = &lt;&lt;&lt;EOD
+&lt;methodResponse&gt;
+  &lt;params&gt;
+    &lt;param&gt;
+      &lt;value&gt;
+        $resultxml
+      &lt;/value&gt;
+    &lt;/param&gt;
+  &lt;/params&gt;
+&lt;/methodResponse&gt;
+
+EOD;
+        // Send it
+        $this-&gt;output($xml);
+    }
+    function call($methodname, $args) {
+        if (!$this-&gt;hasMethod($methodname)) {
+            return new IXR_Error(-32601, 'server error. requested method '.$methodname.' does not exist.');
+        }
+        $method = $this-&gt;callbacks[$methodname];
+        // Perform the callback and send the response
+        if (count($args) == 1) {
+            // If only one paramater just send that instead of the whole array
+            $args = $args[0];
+        }
+        // Are we dealing with a function or a method?
+        if (substr($method, 0, 5) == 'this:') {
+            // It's a class method - check it exists
+            $method = substr($method, 5);
+            if (!method_exists($this, $method)) {
+                return new IXR_Error(-32601, 'server error. requested class method &quot;'.$method.'&quot; does not exist.');
+            }
+            // Call the method
+            $result = $this-&gt;$method($args);
+        } else {
+            // It's a function - does it exist?
+            if (is_array($method)) {
+            	if (!method_exists($method[0], $method[1])) {
+                return new IXR_Error(-32601, 'server error. requested object method &quot;'.$method[1].'&quot; does not exist.');
+            	}
+            } else if (!function_exists($method)) {
+                return new IXR_Error(-32601, 'server error. requested function &quot;'.$method.'&quot; does not exist.');
+            }
+            // Call the function
+            $result = call_user_func($method, $args);
+        }
+        return $result;
+    }
+
+    function error($error, $message = false) {
+        // Accepts either an error object or an error code and message
+        if ($message &amp;&amp; !is_object($error)) {
+            $error = new IXR_Error($error, $message);
+        }
+        $this-&gt;output($error-&gt;getXml());
+    }
+    function output($xml) {
+        $xml = '&lt;?xml version=&quot;1.0&quot;?&gt;'.&quot;\n&quot;.$xml;
+        $length = strlen($xml);
+        header('Connection: close');
+        header('Content-Length: '.$length);
+        header('Content-Type: text/xml');
+        header('Date: '.date('r'));
+        echo $xml;
+        exit;
+    }
+    function hasMethod($method) {
+        return in_array($method, array_keys($this-&gt;callbacks));
+    }
+    function setCapabilities() {
+        // Initialises capabilities array
+        $this-&gt;capabilities = array(
+            'xmlrpc' =&gt; array(
+                'specUrl' =&gt; '<A HREF="http://www.xmlrpc.com/spec">http://www.xmlrpc.com/spec</A>',
+                'specVersion' =&gt; 1
+            ),
+            'faults_interop' =&gt; array(
+                'specUrl' =&gt; '<A HREF="http://xmlrpc-epi.sourceforge.net/specs/rfc.fault_codes.php">http://xmlrpc-epi.sourceforge.net/specs/rfc.fault_codes.php</A>',
+                'specVersion' =&gt; 20010516
+            ),
+            'system.multicall' =&gt; array(
+                'specUrl' =&gt; '<A HREF="http://www.xmlrpc.com/discuss/msgReader$1208">http://www.xmlrpc.com/discuss/msgReader$1208</A>',
+                'specVersion' =&gt; 1
+            ),
+        );   
+    }
+    function getCapabilities($args) {
+        return $this-&gt;capabilities;
+    }
+    function setCallbacks() {
+        $this-&gt;callbacks['system.getCapabilities'] = 'this:getCapabilities';
+        $this-&gt;callbacks['system.listMethods'] = 'this:listMethods';
+        $this-&gt;callbacks['system.multicall'] = 'this:multiCall';
+    }
+    function listMethods($args) {
+        // Returns a list of methods - uses array_reverse to ensure user defined
+        // methods are listed before server defined methods
+        return array_reverse(array_keys($this-&gt;callbacks));
+    }
+    function multiCall($methodcalls) {
+        // See <A HREF="http://www.xmlrpc.com/discuss/msgReader$1208">http://www.xmlrpc.com/discuss/msgReader$1208</A>
+        $return = array();
+        foreach ($methodcalls as $call) {
+            $method = $call['methodName'];
+            $params = $call['params'];
+            if ($method == 'system.multicall') {
+                $result = new IXR_Error(-32600, 'Recursive calls to system.multicall are forbidden');
+            } else {
+                $result = $this-&gt;call($method, $params);
+            }
+            if (is_a($result, 'IXR_Error')) {
+                $return[] = array(
+                    'faultCode' =&gt; $result-&gt;code,
+                    'faultString' =&gt; $result-&gt;message
+                );
+            } else {
+                $return[] = array($result);
+            }
+        }
+        return $return;
+    }
+}
+
+class IXR_Request {
+    var $method;
+    var $args;
+    var $xml;
+    function IXR_Request($method, $args) {
+        $this-&gt;method = $method;
+        $this-&gt;args = $args;
+        $this-&gt;xml = &lt;&lt;&lt;EOD
+&lt;?xml version=&quot;1.0&quot;?&gt;
+&lt;methodCall&gt;
+&lt;methodName&gt;{$this-&gt;method}&lt;/methodName&gt;
+&lt;params&gt;
+
+EOD;
+        foreach ($this-&gt;args as $arg) {
+            $this-&gt;xml .= '&lt;param&gt;&lt;value&gt;';
+            $v = new IXR_Value($arg);
+            $this-&gt;xml .= $v-&gt;getXml();
+            $this-&gt;xml .= &quot;&lt;/value&gt;&lt;/param&gt;\n&quot;;
+        }
+        $this-&gt;xml .= '&lt;/params&gt;&lt;/methodCall&gt;';
+    }
+    function getLength() {
+        return strlen($this-&gt;xml);
+    }
+    function getXml() {
+        return $this-&gt;xml;
+    }
+}
+
+
+class IXR_Client {
+    var $server;
+    var $port;
+    var $path;
+    var $useragent;
+    var $response;
+    var $timeout;
+    var $vendor = '';
+    var $message = false;
+    var $debug = false;
+    // Storage place for an error message
+    var $error = false;
+    function IXR_Client($server, $path = false, $port = 80, $timeout = 30, $vendor = '') {
+        if (!$path) {
+            // Assume we have been given a URL instead
+            $bits = parse_url($server);
+            $this-&gt;server = $bits['host'];
+            $this-&gt;port = isset($bits['port']) ? $bits['port'] : 80;
+            $this-&gt;path = isset($bits['path']) ? $bits['path'] : '/';
+            // Make absolutely sure we have a path
+            if (!$this-&gt;path) {
+                $this-&gt;path = '/';
+            }
+        } else {
+            $this-&gt;server = $server;
+            $this-&gt;path = $path;
+            $this-&gt;port = $port;
+            $this-&gt;timeout = $timeout;
+        }
+        $this-&gt;useragent = 'The Incutio XML-RPC PHP Library';
+    }
+    function query() {
+        $args = func_get_args();
+        $method = array_shift($args);
+        $request = new IXR_Request($method, $args);
+        $length = $request-&gt;getLength();
+        $xml = $request-&gt;getXml();
+        $r = &quot;\r\n&quot;;
+        $request  = &quot;POST {$this-&gt;path} HTTP/1.0$r&quot;;
+        $request .= &quot;Host: {$this-&gt;server}$r&quot;;
+        $request .= &quot;Content-Type: text/xml$r&quot;;
+        $request .= &quot;User-Agent: {$this-&gt;useragent}$r&quot;;
+        $request .= &quot;Content-length: {$length}$r$r&quot;;
+        $request .= $xml;
+        // Now send the request
+        if ($this-&gt;debug) {
+            echo '&lt;pre&gt;'.htmlspecialchars($request).&quot;\n&lt;/pre&gt;\n\n&quot;;
+        }
+        $fp = @fsockopen($this-&gt;server, $this-&gt;port, $errno, $errstr, $this-&gt;timeout);
+        if (!$fp) {
+            $this-&gt;error = new IXR_Error(-32300, 'transport error - could not open socket');
+            return false;
+        }
+        fputs($fp, $request);
+        $contents = '';
+        $gotFirstLine = false;
+        $gettingHeaders = true;
+        while (!feof($fp)) {
+            $line = fgets($fp, 4096);
+            if (!$gotFirstLine) {
+                // Check line for '200'
+                if (strstr($line, '200') === false) {
+                    $this-&gt;error = new IXR_Error(-32300, 'transport error - HTTP status code was not 200');
+                    return false;
+                }
+                $gotFirstLine = true;
+            }
+            if (trim($line) == '') {
+                $gettingHeaders = false;
+            }
+            if (!$gettingHeaders) {
+                $contents .= trim($line).&quot;\n&quot;;
+            }
+        }
+        if ($this-&gt;debug) {
+            echo '&lt;pre&gt;'.htmlspecialchars($contents).&quot;\n&lt;/pre&gt;\n\n&quot;;
+        }
+        // Now parse what we've got back
+        $this-&gt;message = new IXR_Message($contents);
+        if (!$this-&gt;message-&gt;parse()) {
+            // XML error
+            $this-&gt;error = new IXR_Error(-32700, 'parse error. not well formed');
+            return false;
+        }
+        // Is the message a fault?
+        if ($this-&gt;message-&gt;messageType == 'fault') {
+            $this-&gt;error = new IXR_Error($this-&gt;message-&gt;faultCode, $this-&gt;message-&gt;faultString);
+            return false;
+        }
+        // Message must be OK
+        return true;
+    }
+    function getResponse() {
+        // methodResponses can only have one param - return that
+        return $this-&gt;message-&gt;params[0];
+    }
+    function isError() {
+        return (is_object($this-&gt;error));
+    }
+    function getErrorCode() {
+        return $this-&gt;error-&gt;code;
+    }
+    function getErrorMessage() {
+        return $this-&gt;error-&gt;message;
+    }
+}
+
+
+class IXR_Error {
+    var $code;
+    var $message;
+    function IXR_Error($code, $message) {
+        $this-&gt;code = $code;
+        $this-&gt;message = $message;
+    }
+    function getXml() {
+        $xml = &lt;&lt;&lt;EOD
+&lt;methodResponse&gt;
+  &lt;fault&gt;
+    &lt;value&gt;
+      &lt;struct&gt;
+        &lt;member&gt;
+          &lt;name&gt;faultCode&lt;/name&gt;
+          &lt;value&gt;&lt;int&gt;{$this-&gt;code}&lt;/int&gt;&lt;/value&gt;
+        &lt;/member&gt;
+        &lt;member&gt;
+          &lt;name&gt;faultString&lt;/name&gt;
+          &lt;value&gt;&lt;string&gt;{$this-&gt;message}&lt;/string&gt;&lt;/value&gt;
+        &lt;/member&gt;
+      &lt;/struct&gt;
+    &lt;/value&gt;
+  &lt;/fault&gt;
+&lt;/methodResponse&gt; 
+
+EOD;
+        return $xml;
+    }
+}
+
+
+class IXR_Date {
+    var $year;
+    var $month;
+    var $day;
+    var $hour;
+    var $minute;
+    var $second;
+    var $timezone;
+    function IXR_Date($time) {
+        // $time can be a PHP timestamp or an ISO one
+        if (is_numeric($time)) {
+            $this-&gt;parseTimestamp($time);
+        } else {
+            $this-&gt;parseIso($time);
+        }
+    }
+    function parseTimestamp($timestamp) {
+        $this-&gt;year = date('Y', $timestamp);
+        $this-&gt;month = date('Y', $timestamp);
+        $this-&gt;day = date('Y', $timestamp);
+        $this-&gt;hour = date('H', $timestamp);
+        $this-&gt;minute = date('i', $timestamp);
+        $this-&gt;second = date('s', $timestamp);
+    }
+    function parseIso($iso) {
+        $this-&gt;year = substr($iso, 0, 4);
+        $this-&gt;month = substr($iso, 4, 2);
+        $this-&gt;day = substr($iso, 6, 2);
+        $this-&gt;hour = substr($iso, 9, 2);
+        $this-&gt;minute = substr($iso, 12, 2);
+        $this-&gt;second = substr($iso, 15, 2);
+        $this-&gt;timezone = substr($iso, 17);
+    }
+    function getIso() {
+        return $this-&gt;year.$this-&gt;month.$this-&gt;day.'T'.$this-&gt;hour.':'.$this-&gt;minute.':'.$this-&gt;second.$this-&gt;timezone;
+    }
+    function getXml() {
+        return '&lt;dateTime.iso8601&gt;'.$this-&gt;getIso().'&lt;/dateTime.iso8601&gt;';
+    }
+    function getTimestamp() {
+        return mktime($this-&gt;hour, $this-&gt;minute, $this-&gt;second, $this-&gt;month, $this-&gt;day, $this-&gt;year);
+    }
+}
+
+
+class IXR_Base64 {
+    var $data;
+    function IXR_Base64($data) {
+        $this-&gt;data = $data;
+    }
+    function getXml() {
+        return '&lt;base64&gt;'.base64_encode($this-&gt;data).'&lt;/base64&gt;';
+    }
+}
+
+
+class IXR_IntrospectionServer extends IXR_Server {
+    var $signatures;
+    var $help;
+    function IXR_IntrospectionServer() {
+        $this-&gt;setCallbacks();
+        $this-&gt;setCapabilities();
+        $this-&gt;capabilities['introspection'] = array(
+            'specUrl' =&gt; '<A HREF="http://xmlrpc.usefulinc.com/doc/reserved.html">http://xmlrpc.usefulinc.com/doc/reserved.html</A>',
+            'specVersion' =&gt; 1
+        );
+        $this-&gt;addCallback(
+            'system.methodSignature', 
+            'this:methodSignature', 
+            array('array', 'string'), 
+            'Returns an array describing the return type and required parameters of a method'
+        );
+        $this-&gt;addCallback(
+            'system.getCapabilities', 
+            'this:getCapabilities', 
+            array('struct'), 
+            'Returns a struct describing the XML-RPC specifications supported by this server'
+        );
+        $this-&gt;addCallback(
+            'system.listMethods', 
+            'this:listMethods', 
+            array('array'), 
+            'Returns an array of available methods on this server'
+        );
+        $this-&gt;addCallback(
+            'system.methodHelp', 
+            'this:methodHelp', 
+            array('string', 'string'), 
+            'Returns a documentation string for the specified method'
+        );
+    }
+    function addCallback($method, $callback, $args, $help) {
+        $this-&gt;callbacks[$method] = $callback;
+        $this-&gt;signatures[$method] = $args;
+        $this-&gt;help[$method] = $help;
+    }
+    function call($methodname, $args) {
+        // Make sure it's in an array
+        if ($args &amp;&amp; !is_array($args)) {
+            $args = array($args);
+        }
+        // Over-rides default call method, adds signature check
+        if (!$this-&gt;hasMethod($methodname)) {
+            return new IXR_Error(-32601, 'server error. requested method &quot;'.$this-&gt;message-&gt;methodName.'&quot; not specified.');
+        }
+        $method = $this-&gt;callbacks[$methodname];
+        $signature = $this-&gt;signatures[$methodname];
+        $returnType = array_shift($signature);
+        // Check the number of arguments
+        if (count($args) != count($signature)) {
+            // print 'Num of args: '.count($args).' Num in signature: '.count($signature);
+            return new IXR_Error(-32602, 'server error. wrong number of method parameters');
+        }
+        // Check the argument types
+        $ok = true;
+        $argsbackup = $args;
+        for ($i = 0, $j = count($args); $i &lt; $j; $i++) {
+            $arg = array_shift($args);
+            $type = array_shift($signature);
+            switch ($type) {
+                case 'int':
+                case 'i4':
+                    if (is_array($arg) || !is_int($arg)) {
+                        $ok = false;
+                    }
+                    break;
+                case 'base64':
+                case 'string':
+                    if (!is_string($arg)) {
+                        $ok = false;
+                    }
+                    break;
+                case 'boolean':
+                    if ($arg !== false &amp;&amp; $arg !== true) {
+                        $ok = false;
+                    }
+                    break;
+                case 'float':
+                case 'double':
+                    if (!is_float($arg)) {
+                        $ok = false;
+                    }
+                    break;
+                case 'date':
+                case 'dateTime.iso8601':
+                    if (!is_a($arg, 'IXR_Date')) {
+                        $ok = false;
+                    }
+                    break;
+            }
+            if (!$ok) {
+                return new IXR_Error(-32602, 'server error. invalid method parameters');
+            }
+        }
+        // It passed the test - run the &quot;real&quot; method call
+        return parent::call($methodname, $argsbackup);
+    }
+    function methodSignature($method) {
+        if (!$this-&gt;hasMethod($method)) {
+            return new IXR_Error(-32601, 'server error. requested method &quot;'.$method.'&quot; not specified.');
+        }
+        // We should be returning an array of types
+        $types = $this-&gt;signatures[$method];
+        $return = array();
+        foreach ($types as $type) {
+            switch ($type) {
+                case 'string':
+                    $return[] = 'string';
+                    break;
+                case 'int':
+                case 'i4':
+                    $return[] = 42;
+                    break;
+                case 'double':
+                    $return[] = 3.1415;
+                    break;
+                case 'dateTime.iso8601':
+                    $return[] = new IXR_Date(time());
+                    break;
+                case 'boolean':
+                    $return[] = true;
+                    break;
+                case 'base64':
+                    $return[] = new IXR_Base64('base64');
+                    break;
+                case 'array':
+                    $return[] = array('array');
+                    break;
+                case 'struct':
+                    $return[] = array('struct' =&gt; 'struct');
+                    break;
+            }
+        }
+        return $return;
+    }
+    function methodHelp($method) {
+        return $this-&gt;help[$method];
+    }
+}
+
+
+class IXR_ClientMulticall extends IXR_Client {
+    var $calls = array();
+    function IXR_ClientMulticall($server, $path = false, $port = 80) {
+        parent::IXR_Client($server, $path, $port);
+        $this-&gt;useragent = 'The Incutio XML-RPC PHP Library (multicall client)';
+    }
+    function addCall() {
+        $args = func_get_args();
+        $methodName = array_shift($args);
+        $struct = array(
+            'methodName' =&gt; $methodName,
+            'params' =&gt; $args
+        );
+        $this-&gt;calls[] = $struct;
+    }
+    function query() {
+        // Prepare multicall, then call the parent::query() method
+        return parent::query('system.multicall', $this-&gt;calls);
+    }
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/class-pop3.php
===================================================================
--- trunk/wp-includes/class-pop3.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/class-pop3.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,680 @@
+&lt;?php 
+
+   /**
+    * mail_fetch/setup.php
+    *
+    * Copyright (c) 1999-2002 The SquirrelMail Project Team
+    *
+    * Copyright (c) 1999 CDI (<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">cdi at thewebmasters.net</A>) All Rights Reserved
+    * Modified by Philippe Mingo 2001 <A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">mingo at rotedic.com</A>
+    * An RFC 1939 compliant wrapper class for the POP3 protocol.
+    *
+    * Licensed under the GNU GPL. For full terms see the file COPYING.
+    *
+    * pop3 class
+    *
+    * $Id: class-pop3.php 2066 2005-01-07 01:29:49Z saxmatt $
+    */
+
+class POP3 {
+    var $ERROR      = '';       //  Error string.
+
+    var $TIMEOUT    = 60;       //  Default timeout before giving up on a
+                                //  network operation.
+
+    var $COUNT      = -1;       //  Mailbox msg count
+
+    var $BUFFER     = 512;      //  Socket buffer for socket fgets() calls.
+                                //  Per RFC 1939 the returned line a POP3
+                                //  server can send is 512 bytes.
+
+    var $FP         = '';       //  The connection to the server's
+                                //  file descriptor
+
+    var $MAILSERVER = '';       // Set this to hard code the server name
+
+    var $DEBUG      = FALSE;    // set to true to echo pop3
+                                // commands and responses to error_log
+                                // this WILL log passwords!
+
+    var $BANNER     = '';       //  Holds the banner returned by the
+                                //  pop server - used for apop()
+
+    var $RFC1939    = TRUE;     //  Set by noop(). See rfc1939.txt
+                                //
+
+    var $ALLOWAPOP  = FALSE;    //  Allow or disallow apop()
+                                //  This must be set to true
+                                //  manually
+
+    function POP3 ( $server = '', $timeout = '' ) {
+        settype($this-&gt;BUFFER,&quot;integer&quot;);
+        if( !empty($server) ) {
+            // Do not allow programs to alter MAILSERVER
+            // if it is already specified. They can get around
+            // this if they -really- want to, so don't count on it.
+            if(empty($this-&gt;MAILSERVER))
+                $this-&gt;MAILSERVER = $server;
+        }
+        if(!empty($timeout)) {
+            settype($timeout,&quot;integer&quot;);
+            $this-&gt;TIMEOUT = $timeout;
+            set_time_limit($timeout);
+        }
+        return true;
+    }
+
+    function update_timer () {
+        set_time_limit($this-&gt;TIMEOUT);
+        return true;
+    }
+
+    function connect ($server, $port = 110)  {
+        //  Opens a socket to the specified server. Unless overridden,
+        //  port defaults to 110. Returns true on success, false on fail
+
+        // If MAILSERVER is set, override $server with it's value
+
+        if(!empty($this-&gt;MAILSERVER))
+            $server = $this-&gt;MAILSERVER;
+
+        if(empty($server)){
+            $this-&gt;ERROR = _(&quot;POP3 connect:&quot;) . ' ' . _(&quot;No server specified&quot;);
+            unset($this-&gt;FP);
+            return false;
+        }
+
+        $fp = fsockopen(&quot;$server&quot;, $port, $errno, $errstr);
+
+        if(!$fp) {
+            $this-&gt;ERROR = _(&quot;POP3 connect:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$errno] [$errstr]&quot;;
+            unset($this-&gt;FP);
+            return false;
+        }
+
+        socket_set_blocking($fp,-1);
+        $this-&gt;update_timer();
+        $reply = fgets($fp,$this-&gt;BUFFER);
+        $reply = $this-&gt;strip_clf($reply);
+        if($this-&gt;DEBUG)
+            error_log(&quot;POP3 SEND [connect: $server] GOT [$reply]&quot;,0);
+        if(!$this-&gt;is_ok($reply)) {
+            $this-&gt;ERROR = _(&quot;POP3 connect:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+            unset($this-&gt;FP);
+            return false;
+        }
+        $this-&gt;FP = $fp;
+        $this-&gt;BANNER = $this-&gt;parse_banner($reply);
+        $this-&gt;RFC1939 = $this-&gt;noop();
+        if($this-&gt;RFC1939) {
+            $this-&gt;ERROR = _(&quot;POP3: premature NOOP OK, NOT an RFC 1939 Compliant server&quot;);
+            $this-&gt;quit();
+            return false;
+        } else
+            return true;
+    }
+
+    function noop () {
+    
+        if(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 noop:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        } else {
+            $cmd = &quot;NOOP&quot;;
+            $reply = $this-&gt;send_cmd( $cmd );
+            return( $this-&gt;is_ok( $reply ) );
+        }
+    }
+
+    function user ($user = &quot;&quot;) {
+        // Sends the USER command, returns true or false
+
+        if( empty($user) ) {
+            $this-&gt;ERROR = _(&quot;POP3 user:&quot;) . ' ' . _(&quot;no login ID submitted&quot;);
+            return false;
+        } elseif(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 user:&quot;) . ' ' . _(&quot;connection not established&quot;);
+            return false;
+        } else {
+            $reply = $this-&gt;send_cmd(&quot;USER $user&quot;);
+            if(!$this-&gt;is_ok($reply)) {
+                $this-&gt;ERROR = _(&quot;POP3 user:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+                return false;
+            } else
+                return true;
+        }
+    }
+
+    function pass ($pass = &quot;&quot;)     {
+        // Sends the PASS command, returns # of msgs in mailbox,
+        // returns false (undef) on Auth failure
+
+        if(empty($pass)) {
+            $this-&gt;ERROR = _(&quot;POP3 pass:&quot;) . ' ' . _(&quot;No password submitted&quot;);
+            return false;
+        } elseif(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 pass:&quot;) . ' ' . _(&quot;connection not established&quot;);
+            return false;
+        } else {
+            $reply = $this-&gt;send_cmd(&quot;PASS $pass&quot;);
+            if(!$this-&gt;is_ok($reply)) {
+                $this-&gt;ERROR = _(&quot;POP3 pass:&quot;) . ' ' . _(&quot;authentication failed &quot;) . &quot;[$reply]&quot;;
+                $this-&gt;quit();
+                return false;
+            } else {
+                //  Auth successful.
+                $count = $this-&gt;last(&quot;count&quot;);
+                $this-&gt;COUNT = $count;
+                $this-&gt;RFC1939 = $this-&gt;noop();
+                if(!$this-&gt;RFC1939) {
+                    $this-&gt;ERROR = _(&quot;POP3 pass:&quot;) . ' ' . _(&quot;NOOP failed. Server not RFC 1939 compliant&quot;);
+                    $this-&gt;quit();
+                    return false;
+                } else
+                    return $count;
+            }
+        }
+    }
+
+    function apop ($login,$pass) {
+        //  Attempts an APOP login. If this fails, it'll
+        //  try a standard login. YOUR SERVER MUST SUPPORT
+        //  THE USE OF THE APOP COMMAND!
+        //  (apop is optional per rfc1939)
+
+        if(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        } elseif(!$this-&gt;ALLOWAPOP) {
+            $retVal = $this-&gt;login($login,$pass);
+            return $retVal;
+        } elseif(empty($login)) {
+            $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;No login ID submitted&quot;);
+            return false;
+        } elseif(empty($pass)) {
+            $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;No password submitted&quot;);
+            return false;
+        } else {
+            $banner = $this-&gt;BANNER;
+            if( (!$banner) or (empty($banner)) ) {
+                $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;No server banner&quot;) . ' - ' . _(&quot;abort&quot;);
+                $retVal = $this-&gt;login($login,$pass);
+                return $retVal;
+            } else {
+                $AuthString = $banner;
+                $AuthString .= $pass;
+                $APOPString = md5($AuthString);
+                $cmd = &quot;APOP $login $APOPString&quot;;
+                $reply = $this-&gt;send_cmd($cmd);
+                if(!$this-&gt;is_ok($reply)) {
+                    $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;apop authentication failed&quot;) . ' - ' . _(&quot;abort&quot;);
+                    $retVal = $this-&gt;login($login,$pass);
+                    return $retVal;
+                } else {
+                    //  Auth successful.
+                    $count = $this-&gt;last(&quot;count&quot;);
+                    $this-&gt;COUNT = $count;
+                    $this-&gt;RFC1939 = $this-&gt;noop();
+                    if(!$this-&gt;RFC1939) {
+                        $this-&gt;ERROR = _(&quot;POP3 apop:&quot;) . ' ' . _(&quot;NOOP failed. Server not RFC 1939 compliant&quot;);
+                        $this-&gt;quit();
+                        return false;
+                    } else
+                        return $count;
+                }
+            }
+        }
+    }
+
+    function login ($login = &quot;&quot;, $pass = &quot;&quot;) {
+        // Sends both user and pass. Returns # of msgs in mailbox or
+        // false on failure (or -1, if the error occurs while getting
+        // the number of messages.)
+
+        if( !isset($this-&gt;FP) ) {
+            $this-&gt;ERROR = _(&quot;POP3 login:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        } else {
+            $fp = $this-&gt;FP;
+            if( !$this-&gt;user( $login ) ) {
+                //  Preserve the error generated by user()
+                return false;
+            } else {
+                $count = $this-&gt;pass($pass);
+                if( (!$count) || ($count == -1) ) {
+                    //  Preserve the error generated by last() and pass()
+                    return false;
+                } else
+                    return $count;
+            }
+        }
+    }
+
+    function top ($msgNum, $numLines = &quot;0&quot;) {
+        //  Gets the header and first $numLines of the msg body
+        //  returns data in an array with each returned line being
+        //  an array element. If $numLines is empty, returns
+        //  only the header information, and none of the body.
+
+        if(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 top:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+        $this-&gt;update_timer();
+
+        $fp = $this-&gt;FP;
+        $buffer = $this-&gt;BUFFER;
+        $cmd = &quot;TOP $msgNum $numLines&quot;;
+        fwrite($fp, &quot;TOP $msgNum $numLines\r\n&quot;);
+        $reply = fgets($fp, $buffer);
+        $reply = $this-&gt;strip_clf($reply);
+        if($this-&gt;DEBUG) {
+            @error_log(&quot;POP3 SEND [$cmd] GOT [$reply]&quot;,0);
+        }
+        if(!$this-&gt;is_ok($reply))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 top:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+            return false;
+        }
+
+        $count = 0;
+        $MsgArray = array();
+
+        $line = fgets($fp,$buffer);
+        while ( !ereg(&quot;^\.\r\n&quot;,$line))
+        {
+            $MsgArray[$count] = $line;
+            $count++;
+            $line = fgets($fp,$buffer);
+            if(empty($line))    { break; }
+        }
+
+        return $MsgArray;
+    }
+
+    function pop_list ($msgNum = &quot;&quot;) {
+        //  If called with an argument, returns that msgs' size in octets
+        //  No argument returns an associative array of undeleted
+        //  msg numbers and their sizes in octets
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 pop_list:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+        $fp = $this-&gt;FP;
+        $Total = $this-&gt;COUNT;
+        if( (!$Total) or ($Total == -1) )
+        {
+            return false;
+        }
+        if($Total == 0)
+        {
+            return array(&quot;0&quot;,&quot;0&quot;);
+            // return -1;   // mailbox empty
+        }
+
+        $this-&gt;update_timer();
+
+        if(!empty($msgNum))
+        {
+            $cmd = &quot;LIST $msgNum&quot;;
+            fwrite($fp,&quot;$cmd\r\n&quot;);
+            $reply = fgets($fp,$this-&gt;BUFFER);
+            $reply = $this-&gt;strip_clf($reply);
+            if($this-&gt;DEBUG) {
+                @error_log(&quot;POP3 SEND [$cmd] GOT [$reply]&quot;,0);
+            }
+            if(!$this-&gt;is_ok($reply))
+            {
+                $this-&gt;ERROR = _(&quot;POP3 pop_list:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+                return false;
+            }
+            list($junk,$num,$size) = explode(&quot; &quot;,$reply);
+            return $size;
+        }
+        $cmd = &quot;LIST&quot;;
+        $reply = $this-&gt;send_cmd($cmd);
+        if(!$this-&gt;is_ok($reply))
+        {
+            $reply = $this-&gt;strip_clf($reply);
+            $this-&gt;ERROR = _(&quot;POP3 pop_list:&quot;) . ' ' . _(&quot;Error &quot;) .  &quot;[$reply]&quot;;
+            return false;
+        }
+        $MsgArray = array();
+        $MsgArray[0] = $Total;
+        for($msgC=1;$msgC &lt;= $Total; $msgC++)
+        {
+            if($msgC &gt; $Total) { break; }
+            $line = fgets($fp,$this-&gt;BUFFER);
+            $line = $this-&gt;strip_clf($line);
+            if(ereg(&quot;^\.&quot;,$line))
+            {
+                $this-&gt;ERROR = _(&quot;POP3 pop_list:&quot;) . ' ' . _(&quot;Premature end of list&quot;);
+                return false;
+            }
+            list($thisMsg,$msgSize) = explode(&quot; &quot;,$line);
+            settype($thisMsg,&quot;integer&quot;);
+            if($thisMsg != $msgC)
+            {
+                $MsgArray[$msgC] = &quot;deleted&quot;;
+            }
+            else
+            {
+                $MsgArray[$msgC] = $msgSize;
+            }
+        }
+        return $MsgArray;
+    }
+
+    function get ($msgNum) {
+        //  Retrieve the specified msg number. Returns an array
+        //  where each line of the msg is an array element.
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 get:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+
+        $this-&gt;update_timer();
+
+        $fp = $this-&gt;FP;
+        $buffer = $this-&gt;BUFFER;
+        $cmd = &quot;RETR $msgNum&quot;;
+        $reply = $this-&gt;send_cmd($cmd);
+
+        if(!$this-&gt;is_ok($reply))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 get:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+            return false;
+        }
+
+        $count = 0;
+        $MsgArray = array();
+
+        $line = fgets($fp,$buffer);
+        while ( !ereg(&quot;^\.\r\n&quot;,$line))
+        {
+            $MsgArray[$count] = $line;
+            $count++;
+            $line = fgets($fp,$buffer);
+            if(empty($line))    { break; }
+        }
+        return $MsgArray;
+    }
+
+    function last ( $type = &quot;count&quot; ) {
+        //  Returns the highest msg number in the mailbox.
+        //  returns -1 on error, 0+ on success, if type != count
+        //  results in a popstat() call (2 element array returned)
+
+        $last = -1;
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 last:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return $last;
+        }
+
+        $reply = $this-&gt;send_cmd(&quot;STAT&quot;);
+        if(!$this-&gt;is_ok($reply))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 last:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+            return $last;
+        }
+
+        $Vars = explode(&quot; &quot;,$reply);
+        $count = $Vars[1];
+        $size = $Vars[2];
+        settype($count,&quot;integer&quot;);
+        settype($size,&quot;integer&quot;);
+        if($type != &quot;count&quot;)
+        {
+            return array($count,$size);
+        }
+        return $count;
+    }
+
+    function reset () {
+        //  Resets the status of the remote server. This includes
+        //  resetting the status of ALL msgs to not be deleted.
+        //  This method automatically closes the connection to the server.
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 reset:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+        $reply = $this-&gt;send_cmd(&quot;RSET&quot;);
+        if(!$this-&gt;is_ok($reply))
+        {
+            //  The POP3 RSET command -never- gives a -ERR
+            //  response - if it ever does, something truely
+            //  wild is going on.
+
+            $this-&gt;ERROR = _(&quot;POP3 reset:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+            @error_log(&quot;POP3 reset: ERROR [$reply]&quot;,0);
+        }
+        $this-&gt;quit();
+        return true;
+    }
+
+    function send_cmd ( $cmd = &quot;&quot; )
+    {
+        //  Sends a user defined command string to the
+        //  POP server and returns the results. Useful for
+        //  non-compliant or custom POP servers.
+        //  Do NOT includ the \r\n as part of your command
+        //  string - it will be appended automatically.
+
+        //  The return value is a standard fgets() call, which
+        //  will read up to $this-&gt;BUFFER bytes of data, until it
+        //  encounters a new line, or EOF, whichever happens first.
+
+        //  This method works best if $cmd responds with only
+        //  one line of data.
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 send_cmd:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+
+        if(empty($cmd))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 send_cmd:&quot;) . ' ' . _(&quot;Empty command string&quot;);
+            return &quot;&quot;;
+        }
+
+        $fp = $this-&gt;FP;
+        $buffer = $this-&gt;BUFFER;
+        $this-&gt;update_timer();
+        fwrite($fp,&quot;$cmd\r\n&quot;);
+        $reply = fgets($fp,$buffer);
+        $reply = $this-&gt;strip_clf($reply);
+        if($this-&gt;DEBUG) { @error_log(&quot;POP3 SEND [$cmd] GOT [$reply]&quot;,0); }
+        return $reply;
+    }
+
+    function quit() {
+        //  Closes the connection to the POP3 server, deleting
+        //  any msgs marked as deleted.
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 quit:&quot;) . ' ' . _(&quot;connection does not exist&quot;);
+            return false;
+        }
+        $fp = $this-&gt;FP;
+        $cmd = &quot;QUIT&quot;;
+        fwrite($fp,&quot;$cmd\r\n&quot;);
+        $reply = fgets($fp,$this-&gt;BUFFER);
+        $reply = $this-&gt;strip_clf($reply);
+        if($this-&gt;DEBUG) { @error_log(&quot;POP3 SEND [$cmd] GOT [$reply]&quot;,0); }
+        fclose($fp);
+        unset($this-&gt;FP);
+        return true;
+    }
+
+    function popstat () {
+        //  Returns an array of 2 elements. The number of undeleted
+        //  msgs in the mailbox, and the size of the mbox in octets.
+
+        $PopArray = $this-&gt;last(&quot;array&quot;);
+
+        if($PopArray == -1) { return false; }
+
+        if( (!$PopArray) or (empty($PopArray)) )
+        {
+            return false;
+        }
+        return $PopArray;
+    }
+
+    function uidl ($msgNum = &quot;&quot;)
+    {
+        //  Returns the UIDL of the msg specified. If called with
+        //  no arguments, returns an associative array where each
+        //  undeleted msg num is a key, and the msg's uidl is the element
+        //  Array element 0 will contain the total number of msgs
+
+        if(!isset($this-&gt;FP)) {
+            $this-&gt;ERROR = _(&quot;POP3 uidl:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+
+        $fp = $this-&gt;FP;
+        $buffer = $this-&gt;BUFFER;
+
+        if(!empty($msgNum)) {
+            $cmd = &quot;UIDL $msgNum&quot;;
+            $reply = $this-&gt;send_cmd($cmd);
+            if(!$this-&gt;is_ok($reply))
+            {
+                $this-&gt;ERROR = _(&quot;POP3 uidl:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+                return false;
+            }
+            list ($ok,$num,$myUidl) = explode(&quot; &quot;,$reply);
+            return $myUidl;
+        } else {
+            $this-&gt;update_timer();
+
+            $UIDLArray = array();
+            $Total = $this-&gt;COUNT;
+            $UIDLArray[0] = $Total;
+
+            if ($Total &lt; 1)
+            {
+                return $UIDLArray;
+            }
+            $cmd = &quot;UIDL&quot;;
+            fwrite($fp, &quot;UIDL\r\n&quot;);
+            $reply = fgets($fp, $buffer);
+            $reply = $this-&gt;strip_clf($reply);
+            if($this-&gt;DEBUG) { @error_log(&quot;POP3 SEND [$cmd] GOT [$reply]&quot;,0); }
+            if(!$this-&gt;is_ok($reply))
+            {
+                $this-&gt;ERROR = _(&quot;POP3 uidl:&quot;) . ' ' . _(&quot;Error &quot;) . &quot;[$reply]&quot;;
+                return false;
+            }
+
+            $line = &quot;&quot;;
+            $count = 1;
+            $line = fgets($fp,$buffer);
+            while ( !ereg(&quot;^\.\r\n&quot;,$line)) {
+                if(ereg(&quot;^\.\r\n&quot;,$line)) {
+                    break;
+                }
+                list ($msg,$msgUidl) = explode(&quot; &quot;,$line);
+                $msgUidl = $this-&gt;strip_clf($msgUidl);
+                if($count == $msg) {
+                    $UIDLArray[$msg] = $msgUidl;
+                }
+                else
+                {
+                    $UIDLArray[$count] = 'deleted';
+                }
+                $count++;
+                $line = fgets($fp,$buffer);
+            }
+        }
+        return $UIDLArray;
+    }
+
+    function delete ($msgNum = &quot;&quot;) {
+        //  Flags a specified msg as deleted. The msg will not
+        //  be deleted until a quit() method is called.
+
+        if(!isset($this-&gt;FP))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 delete:&quot;) . ' ' . _(&quot;No connection to server&quot;);
+            return false;
+        }
+        if(empty($msgNum))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 delete:&quot;) . ' ' . _(&quot;No msg number submitted&quot;);
+            return false;
+        }
+        $reply = $this-&gt;send_cmd(&quot;DELE $msgNum&quot;);
+        if(!$this-&gt;is_ok($reply))
+        {
+            $this-&gt;ERROR = _(&quot;POP3 delete:&quot;) . ' ' . _(&quot;Command failed &quot;) . &quot;[$reply]&quot;;
+            return false;
+        }
+        return true;
+    }
+
+    //  *********************************************************
+
+    //  The following methods are internal to the class.
+
+    function is_ok ($cmd = &quot;&quot;) {
+        //  Return true or false on +OK or -ERR
+
+        if( empty($cmd) )
+            return false;
+        else
+            return( ereg (&quot;^\+OK&quot;, $cmd ) );
+    }
+
+    function strip_clf ($text = &quot;&quot;) {
+        // Strips \r\n from server responses
+
+        if(empty($text))
+            return $text;
+        else {
+            $stripped = str_replace(&quot;\r&quot;,'',$text);
+            $stripped = str_replace(&quot;\n&quot;,'',$stripped);
+            return $stripped;
+        }
+    }
+
+    function parse_banner ( $server_text ) {
+        $outside = true;
+        $banner = &quot;&quot;;
+        $length = strlen($server_text);
+        for($count =0; $count &lt; $length; $count++)
+        {
+            $digit = substr($server_text, $count, 1);
+            if ( false !== $digit ) {
+                if( (!$outside) &amp;&amp; ($digit != '&lt;') &amp;&amp; ($digit != '&gt;') )
+                {
+                    $banner .= $digit;
+                }
+                if ($digit == '&lt;')
+                {
+                    $outside = false;
+                }
+                if($digit == '&gt;')
+                {
+                    $outside = true;
+                }
+            }
+        }
+        $banner = $this-&gt;strip_clf($banner);    // Just in case
+        return &quot;&lt;$banner&gt;&quot;;
+    }
+
+}   // End class
+
+?&gt;

Added: trunk/wp-includes/class-snoopy.php
===================================================================
--- trunk/wp-includes/class-snoopy.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/class-snoopy.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,901 @@
+&lt;?php
+
+/*************************************************
+
+Snoopy - the PHP net client
+Author: Monte Ohrt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">monte at ispi.net</A>&gt;
+Copyright (c): 1999-2000 ispi, all rights reserved
+Version: 1.0
+
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+You may contact the author of Snoopy by e-mail at:
<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">+monte at ispi.net</A>
+
+Or, write to:
+Monte Ohrt
+CTO, ispi
+237 S. 70th suite 220
+Lincoln, NE 68510
+
+The latest version of Snoopy can be obtained from:
+<A HREF="http://snoopy.sourceforge.net">http://snoopy.sourceforge.net</A>
+
+*************************************************/
+
+if ( !in_array('Snoopy', get_declared_classes() ) ) :
+class Snoopy
+{
+	/**** Public variables ****/
+	
+	/* user definable vars */
+
+	var $host			=	&quot;www.php.net&quot;;		// host name we are connecting to
+	var $port			=	80;					// port we are connecting to
+	var $proxy_host		=	&quot;&quot;;					// proxy host to use
+	var $proxy_port		=	&quot;&quot;;					// proxy port to use
+	var $agent			=	&quot;Snoopy v1.0&quot;;		// agent we masquerade as
+	var	$referer		=	&quot;&quot;;					// referer info to pass
+	var $cookies		=	array();			// array of cookies to pass
+												// $cookies[&quot;username&quot;]=&quot;joe&quot;;
+	var	$rawheaders		=	array();			// array of raw headers to send
+												// $rawheaders[&quot;Content-type&quot;]=&quot;text/html&quot;;
+
+	var $maxredirs		=	5;					// http redirection depth maximum. 0 = disallow
+	var $lastredirectaddr	=	&quot;&quot;;				// contains address of last redirected address
+	var	$offsiteok		=	true;				// allows redirection off-site
+	var $maxframes		=	0;					// frame content depth maximum. 0 = disallow
+	var $expandlinks	=	true;				// expand links to fully qualified URLs.
+												// this only applies to fetchlinks()
+												// or submitlinks()
+	var $passcookies	=	true;				// pass set cookies back through redirects
+												// NOTE: this currently does not respect
+												// dates, domains or paths.
+	
+	var	$user			=	&quot;&quot;;					// user for http authentication
+	var	$pass			=	&quot;&quot;;					// password for http authentication
+	
+	// http accept types
+	var $accept			=	&quot;image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*&quot;;
+	
+	var $results		=	&quot;&quot;;					// where the content is put
+		
+	var $error			=	&quot;&quot;;					// error messages sent here
+	var	$response_code	=	&quot;&quot;;					// response code returned from server
+	var	$headers		=	array();			// headers returned from server sent here
+	var	$maxlength		=	500000;				// max return data length (body)
+	var $read_timeout	=	0;					// timeout on read operations, in seconds
+												// supported only since PHP 4 Beta 4
+												// set to 0 to disallow timeouts
+	var $timed_out		=	false;				// if a read operation timed out
+	var	$status			=	0;					// http request status
+	
+	var	$curl_path		=	&quot;/usr/bin/curl&quot;;
+												// Snoopy will use cURL for fetching
+												// SSL content if a full system path to
+												// the cURL binary is supplied here.
+												// set to false if you do not have
+												// cURL installed. See <A HREF="http://curl.haxx.se">http://curl.haxx.se</A>
+												// for details on installing cURL.
+												// Snoopy does *not* use the cURL
+												// library functions built into php,
+												// as these functions are not stable
+												// as of this Snoopy release.
+	
+	// send Accept-encoding: gzip?
+	var $use_gzip		= true;	
+	
+	/**** Private variables ****/	
+	
+	var	$_maxlinelen	=	4096;				// max line length (headers)
+	
+	var $_httpmethod	=	&quot;GET&quot;;				// default http request method
+	var $_httpversion	=	&quot;HTTP/1.0&quot;;			// default http request version
+	var $_submit_method	=	&quot;POST&quot;;				// default submit method
+	var $_submit_type	=	&quot;application/x-www-form-urlencoded&quot;;	// default submit type
+	var $_mime_boundary	=   &quot;&quot;;					// MIME boundary for multipart/form-data submit type
+	var $_redirectaddr	=	false;				// will be set if page fetched is a redirect
+	var $_redirectdepth	=	0;					// increments on an http redirect
+	var $_frameurls		= 	array();			// frame src urls
+	var $_framedepth	=	0;					// increments on frame depth
+	
+	var $_isproxy		=	false;				// set if using a proxy server
+	var $_fp_timeout	=	30;					// timeout for socket connection
+
+/*======================================================================*\
+	Function:	fetch
+	Purpose:	fetch the contents of a web page
+				(and possibly other protocols in the
+				future like ftp, nntp, gopher, etc.)
+	Input:		$URI	the location of the page to fetch
+	Output:		$this-&gt;results	the output text from the fetch
+\*======================================================================*/
+
+	function fetch($URI)
+	{
+	
+		//preg_match(&quot;|^([^:]+)://([^:/]+)(:[\d]+)*(.*)|&quot;,$URI,$URI_PARTS);
+		$URI_PARTS = parse_url($URI);
+		if (!empty($URI_PARTS[&quot;user&quot;]))
+			$this-&gt;user = $URI_PARTS[&quot;user&quot;];
+		if (!empty($URI_PARTS[&quot;pass&quot;]))
+			$this-&gt;pass = $URI_PARTS[&quot;pass&quot;];
+				
+		switch($URI_PARTS[&quot;scheme&quot;])
+		{
+			case &quot;http&quot;:
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_connect($fp))
+				{
+					if($this-&gt;_isproxy)
+					{
+						// using proxy, send entire URI
+						$this-&gt;_httprequest($URI,$fp,$URI,$this-&gt;_httpmethod);
+					}
+					else
+					{
+						$path = $URI_PARTS[&quot;path&quot;].(isset($URI_PARTS[&quot;query&quot;]) ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+						// no proxy, send only the path
+						$this-&gt;_httprequest($path, $fp, $URI, $this-&gt;_httpmethod);
+					}
+					
+					$this-&gt;_disconnect($fp);
+
+					if($this-&gt;_redirectaddr)
+					{
+						/* url was redirected, check if we've hit the max depth */
+						if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+						{
+							// only follow redirect if it's on this site, or offsiteok is true
+							if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+							{
+								/* follow the redirect */
+								$this-&gt;_redirectdepth++;
+								$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+								$this-&gt;fetch($this-&gt;_redirectaddr);
+							}
+						}
+					}
+
+					if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+					{
+						$frameurls = $this-&gt;_frameurls;
+						$this-&gt;_frameurls = array();
+						
+						while(list(,$frameurl) = each($frameurls))
+						{
+							if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+							{
+								$this-&gt;fetch($frameurl);
+								$this-&gt;_framedepth++;
+							}
+							else
+								break;
+						}
+					}					
+				}
+				else
+				{
+					return false;
+				}
+				return true;					
+				break;
+			case &quot;https&quot;:
+				if(!$this-&gt;curl_path || (!is_executable($this-&gt;curl_path))) {
+					$this-&gt;error = &quot;Bad curl ($this-&gt;curl_path), can't fetch HTTPS \n&quot;;
+					return false;
+				}
+				$this-&gt;host = $URI_PARTS[&quot;host&quot;];
+				if(!empty($URI_PARTS[&quot;port&quot;]))
+					$this-&gt;port = $URI_PARTS[&quot;port&quot;];
+				if($this-&gt;_isproxy)
+				{
+					// using proxy, send entire URI
+					$this-&gt;_httpsrequest($URI,$URI,$this-&gt;_httpmethod);
+				}
+				else
+				{
+					$path = $URI_PARTS[&quot;path&quot;].($URI_PARTS[&quot;query&quot;] ? &quot;?&quot;.$URI_PARTS[&quot;query&quot;] : &quot;&quot;);
+					// no proxy, send only the path
+					$this-&gt;_httpsrequest($path, $URI, $this-&gt;_httpmethod);
+				}
+
+				if($this-&gt;_redirectaddr)
+				{
+					/* url was redirected, check if we've hit the max depth */
+					if($this-&gt;maxredirs &gt; $this-&gt;_redirectdepth)
+					{
+						// only follow redirect if it's on this site, or offsiteok is true
+						if(preg_match(&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,$this-&gt;_redirectaddr) || $this-&gt;offsiteok)
+						{
+							/* follow the redirect */
+							$this-&gt;_redirectdepth++;
+							$this-&gt;lastredirectaddr=$this-&gt;_redirectaddr;
+							$this-&gt;fetch($this-&gt;_redirectaddr);
+						}
+					}
+				}
+
+				if($this-&gt;_framedepth &lt; $this-&gt;maxframes &amp;&amp; count($this-&gt;_frameurls) &gt; 0)
+				{
+					$frameurls = $this-&gt;_frameurls;
+					$this-&gt;_frameurls = array();
+
+					while(list(,$frameurl) = each($frameurls))
+					{
+						if($this-&gt;_framedepth &lt; $this-&gt;maxframes)
+						{
+							$this-&gt;fetch($frameurl);
+							$this-&gt;_framedepth++;
+						}
+						else
+							break;
+					}
+				}					
+				return true;					
+				break;
+			default:
+				// not a valid protocol
+				$this-&gt;error	=	'Invalid protocol &quot;'.$URI_PARTS[&quot;scheme&quot;].'&quot;\n';
+				return false;
+				break;
+		}		
+		return true;
+	}
+
+
+
+/*======================================================================*\
+	Private functions
+\*======================================================================*/
+	
+	
+/*======================================================================*\
+	Function:	_striplinks
+	Purpose:	strip the hyperlinks from an html document
+	Input:		$document	document to strip.
+	Output:		$match		an array of the links
+\*======================================================================*/
+
+	function _striplinks($document)
+	{	
+		preg_match_all(&quot;'&lt;\s*a\s+.*href\s*=\s*			# find &lt;a href=
+						([\&quot;\'])?					# find single or double quote
+						(?(1) (.*?)\\1 | ([^\s\&gt;]+))		# if quote found, match up to next matching
+													# quote, otherwise match up to next space
+						'isx&quot;,$document,$links);
+						
+
+		// catenate the non-empty matches from the conditional subpattern
+
+		while(list($key,$val) = each($links[2]))
+		{
+			if(!empty($val))
+				$match[] = $val;
+		}				
+		
+		while(list($key,$val) = each($links[3]))
+		{
+			if(!empty($val))
+				$match[] = $val;
+		}		
+		
+		// return the links
+		return $match;
+	}
+
+/*======================================================================*\
+	Function:	_stripform
+	Purpose:	strip the form elements from an html document
+	Input:		$document	document to strip.
+	Output:		$match		an array of the links
+\*======================================================================*/
+
+	function _stripform($document)
+	{	
+		preg_match_all(&quot;'&lt;\/?(FORM|INPUT|SELECT|TEXTAREA|(OPTION))[^&lt;&gt;]*&gt;(?(2)(.*(?=&lt;\/?(option|select)[^&lt;&gt;]*&gt;[\r\n]*)|(?=[\r\n]*))|(?=[\r\n]*))'Usi&quot;,$document,$elements);
+		
+		// catenate the matches
+		$match = implode(&quot;\r\n&quot;,$elements[0]);
+				
+		// return the links
+		return $match;
+	}
+
+	
+	
+/*======================================================================*\
+	Function:	_striptext
+	Purpose:	strip the text from an html document
+	Input:		$document	document to strip.
+	Output:		$text		the resulting text
+\*======================================================================*/
+
+	function _striptext($document)
+	{
+		
+		// I didn't use preg eval (//e) since that is only available in PHP 4.0.
+		// so, list your entities one by one here. I included some of the
+		// more common ones.
+								
+		$search = array(&quot;'&lt;script[^&gt;]*?&gt;.*?&lt;/script&gt;'si&quot;,	// strip out javascript
+						&quot;'&lt;[\/\!]*?[^&lt;&gt;]*?&gt;'si&quot;,			// strip out html tags
+						&quot;'([\r\n])[\s]+'&quot;,					// strip out white space
+						&quot;'&amp;(quote|#34);'i&quot;,					// replace html entities
+						&quot;'&amp;(amp|#38);'i&quot;,
+						&quot;'&amp;(lt|#60);'i&quot;,
+						&quot;'&amp;(gt|#62);'i&quot;,
+						&quot;'&amp;(nbsp|#160);'i&quot;,
+						&quot;'&amp;(iexcl|#161);'i&quot;,
+						&quot;'&amp;(cent|#162);'i&quot;,
+						&quot;'&amp;(pound|#163);'i&quot;,
+						&quot;'&amp;(copy|#169);'i&quot;
+						);				
+		$replace = array(	&quot;&quot;,
+							&quot;&quot;,
+							&quot;\\1&quot;,
+							&quot;\&quot;&quot;,
+							&quot;&amp;&quot;,
+							&quot;&lt;&quot;,
+							&quot;&gt;&quot;,
+							&quot; &quot;,
+							chr(161),
+							chr(162),
+							chr(163),
+							chr(169));
+					
+		$text = preg_replace($search,$replace,$document);
+								
+		return $text;
+	}
+
+/*======================================================================*\
+	Function:	_expandlinks
+	Purpose:	expand each link into a fully qualified URL
+	Input:		$links			the links to qualify
+				$URI			the full URI to get the base from
+	Output:		$expandedLinks	the expanded links
+\*======================================================================*/
+
+	function _expandlinks($links,$URI)
+	{
+		
+		preg_match(&quot;/^[^\?]+/&quot;,$URI,$match);
+
+		$match = preg_replace(&quot;|/[^\/\.]+\.[^\/\.]+$|&quot;,&quot;&quot;,$match[0]);
+				
+		$search = array( 	&quot;|^<A HREF="http://">http://</A>&quot;.preg_quote($this-&gt;host).&quot;|i&quot;,
+							&quot;|^(?!<A HREF="http://">http://</A>)(\/)?(?!mailto:)|i&quot;,
+							&quot;|/\./|&quot;,
+							&quot;|/[^\/]+/\.\./|&quot;
+						);
+						
+		$replace = array(	&quot;&quot;,
+							$match.&quot;/&quot;,
+							&quot;/&quot;,
+							&quot;/&quot;
+						);			
+				
+		$expandedLinks = preg_replace($search,$replace,$links);
+
+		return $expandedLinks;
+	}
+
+/*======================================================================*\
+	Function:	_httprequest
+	Purpose:	go get the http data from the server
+	Input:		$url		the url to fetch
+				$fp			the current open file pointer
+				$URI		the full URI
+				$body		body contents to send if any (POST)
+	Output:		
+\*======================================================================*/
+	
+	function _httprequest($url,$fp,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
+	{
+		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
+			$this-&gt;setcookies();
+			
+		$URI_PARTS = parse_url($URI);
+		if(empty($url))
+			$url = &quot;/&quot;;
+		$headers = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion.&quot;\r\n&quot;;		
+		if(!empty($this-&gt;agent))
+			$headers .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
+		if(!empty($this-&gt;host) &amp;&amp; !isset($this-&gt;rawheaders['Host']))
+			$headers .= &quot;Host: &quot;.$this-&gt;host.&quot;\r\n&quot;;
+		if(!empty($this-&gt;accept))
+			$headers .= &quot;Accept: &quot;.$this-&gt;accept.&quot;\r\n&quot;;
+		
+		if($this-&gt;use_gzip) {
+			// make sure PHP was built with --with-zlib
+			// and we can handle gzipp'ed data
+			if ( function_exists(gzinflate) ) {
+			   $headers .= &quot;Accept-encoding: gzip\r\n&quot;;
+			}
+			else {
+			   trigger_error(
+			   	&quot;use_gzip is on, but PHP was built without zlib support.&quot;.
+				&quot;  Requesting file(s) without gzip encoding.&quot;, 
+				E_USER_NOTICE);
+			}
+		}
+		
+		if(!empty($this-&gt;referer))
+			$headers .= &quot;Referer: &quot;.$this-&gt;referer.&quot;\r\n&quot;;
+		if(!empty($this-&gt;cookies))
+		{			
+			if(!is_array($this-&gt;cookies))
+				$this-&gt;cookies = (array)$this-&gt;cookies;
+	
+			reset($this-&gt;cookies);
+			if ( count($this-&gt;cookies) &gt; 0 ) {
+				$cookie_headers .= 'Cookie: ';
+				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
+				$cookie_headers .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
+				}
+				$headers .= substr($cookie_headers,0,-2) . &quot;\r\n&quot;;
+			} 
+		}
+		if(!empty($this-&gt;rawheaders))
+		{
+			if(!is_array($this-&gt;rawheaders))
+				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
+			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
+				$headers .= $headerKey.&quot;: &quot;.$headerVal.&quot;\r\n&quot;;
+		}
+		if(!empty($content_type)) {
+			$headers .= &quot;Content-type: $content_type&quot;;
+			if ($content_type == &quot;multipart/form-data&quot;)
+				$headers .= &quot;; boundary=&quot;.$this-&gt;_mime_boundary;
+			$headers .= &quot;\r\n&quot;;
+		}
+		if(!empty($body))	
+			$headers .= &quot;Content-length: &quot;.strlen($body).&quot;\r\n&quot;;
+		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
+			$headers .= &quot;Authorization: BASIC &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass).&quot;\r\n&quot;;
+
+		$headers .= &quot;\r\n&quot;;
+		
+		// set the read timeout if needed
+		if ($this-&gt;read_timeout &gt; 0)
+			socket_set_timeout($fp, $this-&gt;read_timeout);
+		$this-&gt;timed_out = false;
+		
+		fwrite($fp,$headers.$body,strlen($headers.$body));
+		
+		$this-&gt;_redirectaddr = false;
+		unset($this-&gt;headers);
+		
+		// content was returned gzip encoded?
+		$is_gzipped = false;
+						
+		while($currentHeader = fgets($fp,$this-&gt;_maxlinelen))
+		{
+			if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
+			{
+				$this-&gt;status=-100;
+				return false;
+			}
+				
+		//	if($currentHeader == &quot;\r\n&quot;)
+			if(preg_match(&quot;/^\r?\n$/&quot;, $currentHeader) )
+			      break;
+						
+			// if a header begins with Location: or URI:, set the redirect
+			if(preg_match(&quot;/^(Location:|URI:)/i&quot;,$currentHeader))
+			{
+				// get URL portion of the redirect
+				preg_match(&quot;/^(Location:|URI:)\s+(.*)/&quot;,chop($currentHeader),$matches);
+				// look for :// in the Location header to see if hostname is included
+				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
+				{
+					// no host in the path, so prepend
+					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
+					// eliminate double slash
+					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
+							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
+					else
+							$this-&gt;_redirectaddr .= $matches[2];
+				}
+				else
+					$this-&gt;_redirectaddr = $matches[2];
+			}
+		
+			if(preg_match(&quot;|^HTTP/|&quot;,$currentHeader))
+			{
+                if(preg_match(&quot;|^HTTP/[^\s]*\s(.*?)\s|&quot;,$currentHeader, $status))
+				{
+					$this-&gt;status= $status[1];
+                }				
+				$this-&gt;response_code = $currentHeader;
+			}
+			
+			if (preg_match(&quot;/Content-Encoding: gzip/&quot;, $currentHeader) ) {
+				$is_gzipped = true;
+			}
+			
+			$this-&gt;headers[] = $currentHeader;
+		}
+
+		# $results = fread($fp, $this-&gt;maxlength);
+		$results = &quot;&quot;;
+		while ( $data = fread($fp, $this-&gt;maxlength) ) {
+		    $results .= $data;
+		    if (
+		        strlen($results) &gt; $this-&gt;maxlength ) {
+		        break;
+		    }
+		}
+		
+		// gunzip
+		if ( $is_gzipped ) {
+			// per <A HREF="http://www.php.net/manual/en/function.gzencode.php">http://www.php.net/manual/en/function.gzencode.php</A>
+			$results = substr($results, 10);
+			$results = gzinflate($results);
+		}
+		
+		if ($this-&gt;read_timeout &gt; 0 &amp;&amp; $this-&gt;_check_timeout($fp))
+		{
+			$this-&gt;status=-100;
+			return false;
+		}
+		
+		// check if there is a a redirect meta tag
+		
+		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]+URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
+		{
+			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
+		}
+
+		// have we hit our frame depth and is there frame src to fetch?
+		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
+		{
+			$this-&gt;results[] = $results;
+			for($x=0; $x&lt;count($match[1]); $x++)
+				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
+		}
+		// have we already fetched framed content?
+		elseif(is_array($this-&gt;results))
+			$this-&gt;results[] = $results;
+		// no framed content
+		else
+			$this-&gt;results = $results;
+		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	_httpsrequest
+	Purpose:	go get the https data from the server using curl
+	Input:		$url		the url to fetch
+				$URI		the full URI
+				$body		body contents to send if any (POST)
+	Output:		
+\*======================================================================*/
+	
+	function _httpsrequest($url,$URI,$http_method,$content_type=&quot;&quot;,$body=&quot;&quot;)
+	{
+		if($this-&gt;passcookies &amp;&amp; $this-&gt;_redirectaddr)
+			$this-&gt;setcookies();
+
+		$headers = array();		
+					
+		$URI_PARTS = parse_url($URI);
+		if(empty($url))
+			$url = &quot;/&quot;;
+		// GET ... header not needed for curl
+		//$headers[] = $http_method.&quot; &quot;.$url.&quot; &quot;.$this-&gt;_httpversion;		
+		if(!empty($this-&gt;agent))
+			$headers[] = &quot;User-Agent: &quot;.$this-&gt;agent;
+		if(!empty($this-&gt;host))
+			$headers[] = &quot;Host: &quot;.$this-&gt;host;
+		if(!empty($this-&gt;accept))
+			$headers[] = &quot;Accept: &quot;.$this-&gt;accept;
+		if(!empty($this-&gt;referer))
+			$headers[] = &quot;Referer: &quot;.$this-&gt;referer;
+		if(!empty($this-&gt;cookies))
+		{			
+			if(!is_array($this-&gt;cookies))
+				$this-&gt;cookies = (array)$this-&gt;cookies;
+	
+			reset($this-&gt;cookies);
+			if ( count($this-&gt;cookies) &gt; 0 ) {
+				$cookie_str = 'Cookie: ';
+				foreach ( $this-&gt;cookies as $cookieKey =&gt; $cookieVal ) {
+				$cookie_str .= $cookieKey.&quot;=&quot;.urlencode($cookieVal).&quot;; &quot;;
+				}
+				$headers[] = substr($cookie_str,0,-2);
+			}
+		}
+		if(!empty($this-&gt;rawheaders))
+		{
+			if(!is_array($this-&gt;rawheaders))
+				$this-&gt;rawheaders = (array)$this-&gt;rawheaders;
+			while(list($headerKey,$headerVal) = each($this-&gt;rawheaders))
+				$headers[] = $headerKey.&quot;: &quot;.$headerVal;
+		}
+		if(!empty($content_type)) {
+			if ($content_type == &quot;multipart/form-data&quot;)
+				$headers[] = &quot;Content-type: $content_type; boundary=&quot;.$this-&gt;_mime_boundary;
+			else
+				$headers[] = &quot;Content-type: $content_type&quot;;
+		}
+		if(!empty($body))	
+			$headers[] = &quot;Content-length: &quot;.strlen($body);
+		if(!empty($this-&gt;user) || !empty($this-&gt;pass))	
+			$headers[] = &quot;Authorization: BASIC &quot;.base64_encode($this-&gt;user.&quot;:&quot;.$this-&gt;pass);
+			
+		for($curr_header = 0; $curr_header &lt; count($headers); $curr_header++)
+			$cmdline_params .= &quot; -H \&quot;&quot;.$headers[$curr_header].&quot;\&quot;&quot;;
+		
+		if(!empty($body))
+			$cmdline_params .= &quot; -d \&quot;$body\&quot;&quot;;
+		
+		if($this-&gt;read_timeout &gt; 0)
+			$cmdline_params .= &quot; -m &quot;.$this-&gt;read_timeout;
+		
+		$headerfile = uniqid(time());
+		
+		# accept self-signed certs
+		$cmdline_params .= &quot; -k&quot;;
+		exec($this-&gt;curl_path.&quot; -D \&quot;/tmp/$headerfile\&quot;&quot;.$cmdline_params.&quot; &quot;.$URI,$results,$return);
+		
+		if($return)
+		{
+			$this-&gt;error = &quot;Error: cURL could not retrieve the document, error $return.&quot;;
+			return false;
+		}
+			
+			
+		$results = implode(&quot;\r\n&quot;,$results);
+		
+		$result_headers = file(&quot;/tmp/$headerfile&quot;);
+						
+		$this-&gt;_redirectaddr = false;
+		unset($this-&gt;headers);
+						
+		for($currentHeader = 0; $currentHeader &lt; count($result_headers); $currentHeader++)
+		{
+			
+			// if a header begins with Location: or URI:, set the redirect
+			if(preg_match(&quot;/^(Location: |URI: )/i&quot;,$result_headers[$currentHeader]))
+			{
+				// get URL portion of the redirect
+				preg_match(&quot;/^(Location: |URI:)(.*)/&quot;,chop($result_headers[$currentHeader]),$matches);
+				// look for :// in the Location header to see if hostname is included
+				if(!preg_match(&quot;|\:\/\/|&quot;,$matches[2]))
+				{
+					// no host in the path, so prepend
+					$this-&gt;_redirectaddr = $URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host.&quot;:&quot;.$this-&gt;port;
+					// eliminate double slash
+					if(!preg_match(&quot;|^/|&quot;,$matches[2]))
+							$this-&gt;_redirectaddr .= &quot;/&quot;.$matches[2];
+					else
+							$this-&gt;_redirectaddr .= $matches[2];
+				}
+				else
+					$this-&gt;_redirectaddr = $matches[2];
+			}
+		
+			if(preg_match(&quot;|^HTTP/|&quot;,$result_headers[$currentHeader]))
+			{
+			    $this-&gt;response_code = $result_headers[$currentHeader];
+			    if(preg_match(&quot;|^HTTP/[^\s]*\s(.*?)\s|&quot;,$this-&gt;response_code, $match))
+			    {
+				$this-&gt;status= $match[1];
+                	    }
+			}
+			$this-&gt;headers[] = $result_headers[$currentHeader];
+		}
+
+		// check if there is a a redirect meta tag
+		
+		if(preg_match(&quot;'&lt;meta[\s]*http-equiv[^&gt;]*?content[\s]*=[\s]*[\&quot;\']?\d+;[\s]+URL[\s]*=[\s]*([^\&quot;\']*?)[\&quot;\']?&gt;'i&quot;,$results,$match))
+		{
+			$this-&gt;_redirectaddr = $this-&gt;_expandlinks($match[1],$URI);	
+		}
+
+		// have we hit our frame depth and is there frame src to fetch?
+		if(($this-&gt;_framedepth &lt; $this-&gt;maxframes) &amp;&amp; preg_match_all(&quot;'&lt;frame\s+.*src[\s]*=[\'\&quot;]?([^\'\&quot;\&gt;]+)'i&quot;,$results,$match))
+		{
+			$this-&gt;results[] = $results;
+			for($x=0; $x&lt;count($match[1]); $x++)
+				$this-&gt;_frameurls[] = $this-&gt;_expandlinks($match[1][$x],$URI_PARTS[&quot;scheme&quot;].&quot;://&quot;.$this-&gt;host);
+		}
+		// have we already fetched framed content?
+		elseif(is_array($this-&gt;results))
+			$this-&gt;results[] = $results;
+		// no framed content
+		else
+			$this-&gt;results = $results;
+
+		unlink(&quot;/tmp/$headerfile&quot;);
+		
+		return true;
+	}
+
+/*======================================================================*\
+	Function:	setcookies()
+	Purpose:	set cookies for a redirection
+\*======================================================================*/
+	
+	function setcookies()
+	{
+		for($x=0; $x&lt;count($this-&gt;headers); $x++)
+		{
+		if(preg_match(&quot;/^set-cookie:[\s]+([^=]+)=([^;]+)/i&quot;, $this-&gt;headers[$x],$match))
+			$this-&gt;cookies[$match[1]] = $match[2];
+		}
+	}
+
+	
+/*======================================================================*\
+	Function:	_check_timeout
+	Purpose:	checks whether timeout has occurred
+	Input:		$fp	file pointer
+\*======================================================================*/
+
+	function _check_timeout($fp)
+	{
+		if ($this-&gt;read_timeout &gt; 0) {
+			$fp_status = socket_get_status($fp);
+			if ($fp_status[&quot;timed_out&quot;]) {
+				$this-&gt;timed_out = true;
+				return true;
+			}
+		}
+		return false;
+	}
+
+/*======================================================================*\
+	Function:	_connect
+	Purpose:	make a socket connection
+	Input:		$fp	file pointer
+\*======================================================================*/
+	
+	function _connect(&amp;$fp)
+	{
+		if(!empty($this-&gt;proxy_host) &amp;&amp; !empty($this-&gt;proxy_port))
+			{
+				$this-&gt;_isproxy = true;
+				$host = $this-&gt;proxy_host;
+				$port = $this-&gt;proxy_port;
+			}
+		else
+		{
+			$host = $this-&gt;host;
+			$port = $this-&gt;port;
+		}
+	
+		$this-&gt;status = 0;
+		
+		if($fp = fsockopen(
+					$host,
+					$port,
+					$errno,
+					$errstr,
+					$this-&gt;_fp_timeout
+					))
+		{
+			// socket connection succeeded
+
+			return true;
+		}
+		else
+		{
+			// socket connection failed
+			$this-&gt;status = $errno;
+			switch($errno)
+			{
+				case -3:
+					$this-&gt;error=&quot;socket creation failed (-3)&quot;;
+				case -4:
+					$this-&gt;error=&quot;dns lookup failure (-4)&quot;;
+				case -5:
+					$this-&gt;error=&quot;connection refused or timed out (-5)&quot;;
+				default:
+					$this-&gt;error=&quot;connection failed (&quot;.$errno.&quot;)&quot;;
+			}
+			return false;
+		}
+	}
+/*======================================================================*\
+	Function:	_disconnect
+	Purpose:	disconnect a socket connection
+	Input:		$fp	file pointer
+\*======================================================================*/
+	
+	function _disconnect($fp)
+	{
+		return(fclose($fp));
+	}
+
+	
+/*======================================================================*\
+	Function:	_prepare_post_body
+	Purpose:	Prepare post body according to encoding type
+	Input:		$formvars  - form variables
+				$formfiles - form upload files
+	Output:		post body
+\*======================================================================*/
+	
+	function _prepare_post_body($formvars, $formfiles)
+	{
+		settype($formvars, &quot;array&quot;);
+		settype($formfiles, &quot;array&quot;);
+
+		if (count($formvars) == 0 &amp;&amp; count($formfiles) == 0)
+			return;
+		
+		switch ($this-&gt;_submit_type) {
+			case &quot;application/x-www-form-urlencoded&quot;:
+				reset($formvars);
+				while(list($key,$val) = each($formvars)) {
+					if (is_array($val) || is_object($val)) {
+						while (list($cur_key, $cur_val) = each($val)) {
+							$postdata .= urlencode($key).&quot;[]=&quot;.urlencode($cur_val).&quot;&amp;&quot;;
+						}
+					} else
+						$postdata .= urlencode($key).&quot;=&quot;.urlencode($val).&quot;&amp;&quot;;
+				}
+				break;
+
+			case &quot;multipart/form-data&quot;:
+				$this-&gt;_mime_boundary = &quot;Snoopy&quot;.md5(uniqid(microtime()));
+				
+				reset($formvars);
+				while(list($key,$val) = each($formvars)) {
+					if (is_array($val) || is_object($val)) {
+						while (list($cur_key, $cur_val) = each($val)) {
+							$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+							$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\[\]\&quot;\r\n\r\n&quot;;
+							$postdata .= &quot;$cur_val\r\n&quot;;
+						}
+					} else {
+						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$key\&quot;\r\n\r\n&quot;;
+						$postdata .= &quot;$val\r\n&quot;;
+					}
+				}
+				
+				reset($formfiles);
+				while (list($field_name, $file_names) = each($formfiles)) {
+					settype($file_names, &quot;array&quot;);
+					while (list(, $file_name) = each($file_names)) {
+						if (!is_readable($file_name)) continue;
+
+						$fp = fopen($file_name, &quot;r&quot;);
+						$file_content = fread($fp, filesize($file_name));
+						fclose($fp);
+						$base_name = basename($file_name);
+
+						$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;\r\n&quot;;
+						$postdata .= &quot;Content-Disposition: form-data; name=\&quot;$field_name\&quot;; filename=\&quot;$base_name\&quot;\r\n\r\n&quot;;
+						$postdata .= &quot;$file_content\r\n&quot;;
+					}
+				}
+				$postdata .= &quot;--&quot;.$this-&gt;_mime_boundary.&quot;--\r\n&quot;;
+				break;
+		}
+
+		return $postdata;
+	}
+}
+endif;
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/classes.php
===================================================================
--- trunk/wp-includes/classes.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/classes.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,1299 @@
+&lt;?php
+
+class WP_Query {
+	var $query;
+	var $query_vars;
+	var $queried_object;
+	var $queried_object_id;
+
+	var $posts;
+	var $post_count = 0;
+	var $current_post = -1;
+	var $post;
+
+	var $is_single = false;
+	var $is_page = false;
+	var $is_archive = false;
+	var $is_date = false;
+	var $is_year = false;
+	var $is_month = false;
+	var $is_day = false;
+	var $is_time = false;
+	var $is_author = false;
+	var $is_category = false;
+	var $is_search = false;
+	var $is_feed = false;
+	var $is_trackback = false;
+	var $is_home = false;
+	var $is_404 = false;
+	var $is_comments_popup = false;
+	var $is_admin = false;
+
+	function init () {
+		$this-&gt;is_single = false;
+		$this-&gt;is_page = false;
+		$this-&gt;is_archive = false;
+		$this-&gt;is_date = false;
+		$this-&gt;is_year = false;
+		$this-&gt;is_month = false;
+		$this-&gt;is_day = false;
+		$this-&gt;is_time = false;
+		$this-&gt;is_author = false;
+		$this-&gt;is_category = false;
+		$this-&gt;is_search = false;
+		$this-&gt;is_feed = false;
+		$this-&gt;is_trackback = false;
+		$this-&gt;is_home = false;
+		$this-&gt;is_404 = false;
+		$this-&gt;is_paged = false;
+		$this-&gt;is_admin = false;
+
+		unset($this-&gt;posts);
+		unset($this-&gt;query);
+		unset($this-&gt;query_vars);
+		unset($this-&gt;queried_object);
+		unset($this-&gt;queried_object_id);
+		$this-&gt;post_count = 0;
+		$this-&gt;current_post = -1;
+	}
+
+	// Reparse the query vars.
+	function parse_query_vars() {
+		$this-&gt;parse_query('');
+	}
+
+	// Parse a query string and set query type booleans.
+	function parse_query ($query) {
+		if ( !empty($query) || !isset($this-&gt;query) ) {
+			$this-&gt;init();
+			parse_str($query, $qv);
+			$this-&gt;query = $query;
+			$this-&gt;query_vars = $qv;
+		}
+
+		$qv['m'] =  (int) $qv['m'];
+		$qv['p'] =  (int) $qv['p'];
+
+		if ('' != $qv['name']) {
+			$this-&gt;is_single = true;
+		} elseif ( $qv['p'] ) {
+			$this-&gt;is_single = true;
+		} elseif (('' != $qv['hour']) &amp;&amp; ('' != $qv['minute']) &amp;&amp;('' != $qv['second']) &amp;&amp; ('' != $qv['year']) &amp;&amp; ('' != $qv['monthnum']) &amp;&amp; ('' != $qv['day'])) {
+			// If year, month, day, hour, minute, and second are set, a single 
+		  // post is being queried.        
+			$this-&gt;is_single = true;
+		} elseif ('' != $qv['static'] || '' != $qv['pagename'] || '' != $qv['page_id']) {
+			$this-&gt;is_page = true;
+			$this-&gt;is_single = false;
+		} elseif (!empty($qv['s'])) {
+			$this-&gt;is_search = true;
+		} else {
+		// Look for archive queries.  Dates, categories, authors.
+
+			if ( (int) $qv['second']) {
+				$this-&gt;is_time = true;
+				$this-&gt;is_date = true;
+			}
+
+			if ( (int) $qv['minute']) {
+				$this-&gt;is_time = true;
+				$this-&gt;is_date = true;
+			}
+
+			if ( (int) $qv['hour']) {
+				$this-&gt;is_time = true;
+				$this-&gt;is_date = true;
+			}
+
+			if ( (int) $qv['day']) {
+				if (! $this-&gt;is_date) {
+					$this-&gt;is_day = true;
+					$this-&gt;is_date = true;
+				}
+			}
+
+			if ( (int)  $qv['monthnum']) {
+				if (! $this-&gt;is_date) {
+					$this-&gt;is_month = true;
+					$this-&gt;is_date = true;
+				}
+			}
+
+			if ( (int)  $qv['year']) {
+				if (! $this-&gt;is_date) {
+					$this-&gt;is_year = true;
+					$this-&gt;is_date = true;
+				}
+			}
+
+			if ( (int)  $qv['m']) {
+				$this-&gt;is_date = true;
+				if (strlen($qv['m']) &gt; 9) {
+					$this-&gt;is_time = true;
+				} else if (strlen($qv['m']) &gt; 7) {
+					$this-&gt;is_day = true;
+				} else if (strlen($qv['m']) &gt; 5) {
+					$this-&gt;is_month = true;
+				} else {
+					$this-&gt;is_year = true;
+				}
+			}
+
+			if ('' != $qv['w']) {
+				$this-&gt;is_date = true;
+			}
+
+			if (empty($qv['cat']) || ($qv['cat'] == '0')) {
+				$this-&gt;is_category = false;
+			} else {
+				if (stristr($qv['cat'],'-')) {
+					$this-&gt;is_category = false;
+				} else {
+					$this-&gt;is_category = true;
+				}
+			}
+
+			if ('' != $qv['category_name']) {
+				$this-&gt;is_category = true;
+			}
+            
+			if ((empty($qv['author'])) || ($qv['author'] == '0')) {
+				$this-&gt;is_author = false;
+			} else {
+				$this-&gt;is_author = true;
+			}
+
+			if ('' != $qv['author_name']) {
+				$this-&gt;is_author = true;
+			}
+
+			if ( ($this-&gt;is_date || $this-&gt;is_author || $this-&gt;is_category)) {
+				$this-&gt;is_archive = true;
+			}
+		}
+
+		if ('' != $qv['feed']) {
+			$this-&gt;is_feed = true;
+		}
+
+		if ('' != $qv['tb']) {
+			$this-&gt;is_trackback = true;
+		}
+
+		if ('404' == $qv['error']) {
+			$this-&gt;is_404 = true;
+		}
+
+		if ('' != $qv['paged']) {
+			$this-&gt;is_paged = true;
+		}
+
+		if ('' != $qv['comments_popup']) {
+			$this-&gt;is_comments_popup = true;
+		}
+
+		if (strstr($_SERVER['PHP_SELF'], 'wp-admin/')) {
+			$this-&gt;is_admin = true;
+		}
+
+		if ( ! ($this-&gt;is_archive || $this-&gt;is_single || $this-&gt;is_page || $this-&gt;is_search || $this-&gt;is_feed || $this-&gt;is_trackback || $this-&gt;is_404 || $this-&gt;is_admin || $this-&gt;is_comments_popup)) {
+			$this-&gt;is_home = true;
+		}
+
+		if ( !empty($query) ) {
+			do_action('parse_query', array(&amp;$this));
+		}
+	}
+
+	function get($query_var) {
+		if (isset($this-&gt;query_vars[$query_var])) {
+			return $this-&gt;query_vars[$query_var];
+		}
+
+		return '';
+	}
+
+	function set($query_var, $value) {
+		$this-&gt;query_vars[$query_var] = $value;
+	}
+
+	function &amp;get_posts() {
+		global $wpdb, $pagenow, $request, $user_ID;
+
+		// Shorthand.
+		$q = $this-&gt;query_vars;	
+
+		// First let's clear some variables
+		$whichcat = '';
+		$whichauthor = '';
+		$result = '';
+		$where = '';
+		$limits = '';
+		$distinct = '';
+		$join = '';
+
+		if ( !isset($q['posts_per_page']) || $q['posts_per_page'] == 0 )
+			$q['posts_per_page'] = get_settings('posts_per_page');
+		if ( !isset($q['what_to_show']) )
+			$q['what_to_show'] = get_settings('what_to_show');
+		if ( isset($q['showposts']) &amp;&amp; $q['showposts'] ) {
+			$q['showposts'] = (int) $q['showposts'];
+			$q['posts_per_page'] = $q['showposts'];
+		}
+		if ( (isset($q['posts_per_archive_page']) &amp;&amp; $q['posts_per_archive_page'] != 0) &amp;&amp; ($this-&gt;is_archive || $this-&gt;is_search) )
+			$q['posts_per_page'] = $q['posts_per_archive_page'];
+		if ( !isset($q['nopaging']) ) {
+			if ($q['posts_per_page'] == -1) {
+				$q['nopaging'] = true;
+			} else {
+				$q['nopaging'] = false;
+			}
+		}
+		if ( $this-&gt;is_feed ) {
+			$q['posts_per_page'] = get_settings('posts_per_rss');
+			$q['what_to_show'] = 'posts';
+		}
+
+		if (isset($q['page'])) {
+			$q['page'] = trim($q['page'], '/');
+			$q['page'] = (int) $q['page'];
+		}
+	
+		$add_hours = intval(get_settings('gmt_offset'));
+		$add_minutes = intval(60 * (get_settings('gmt_offset') - $add_hours));
+		$wp_posts_post_date_field = &quot;post_date&quot;; // &quot;DATE_ADD(post_date, INTERVAL '$add_hours:$add_minutes' HOUR_MINUTE)&quot;;
+
+		// If a month is specified in the querystring, load that month
+		if ( (int) $q['m'] ) {
+			$q['m'] = '' . preg_replace('|[^0-9]|', '', $q['m']);
+			$where .= ' AND YEAR(post_date)=' . substr($q['m'], 0, 4);
+			if (strlen($q['m'])&gt;5)
+				$where .= ' AND MONTH(post_date)=' . substr($q['m'], 4, 2);
+			if (strlen($q['m'])&gt;7)
+				$where .= ' AND DAYOFMONTH(post_date)=' . substr($q['m'], 6, 2);
+			if (strlen($q['m'])&gt;9)
+				$where .= ' AND HOUR(post_date)=' . substr($q['m'], 8, 2);
+			if (strlen($q['m'])&gt;11)
+				$where .= ' AND MINUTE(post_date)=' . substr($q['m'], 10, 2);
+			if (strlen($q['m'])&gt;13)
+				$where .= ' AND SECOND(post_date)=' . substr($q['m'], 12, 2);
+		}
+
+		if ( (int) $q['hour'] ) {
+			$q['hour'] = '' . intval($q['hour']);
+			$where .= &quot; AND HOUR(post_date)='&quot; . $q['hour'] . &quot;'&quot;;
+		}
+
+		if ( (int) $q['minute'] ) {
+			$q['minute'] = '' . intval($q['minute']);
+			$where .= &quot; AND MINUTE(post_date)='&quot; . $q['minute'] . &quot;'&quot;;
+		}
+
+		if ( (int) $q['second'] ) {
+			$q['second'] = '' . intval($q['second']);
+			$where .= &quot; AND SECOND(post_date)='&quot; . $q['second'] . &quot;'&quot;;
+		}
+
+		if ( (int) $q['year'] ) {
+			$q['year'] = '' . intval($q['year']);
+			$where .= &quot; AND YEAR(post_date)='&quot; . $q['year'] . &quot;'&quot;;
+		}
+
+		if ( (int) $q['monthnum'] ) {
+			$q['monthnum'] = '' . intval($q['monthnum']);
+			$where .= &quot; AND MONTH(post_date)='&quot; . $q['monthnum'] . &quot;'&quot;;
+		}
+
+		if ( (int) $q['day'] ) {
+			$q['day'] = '' . intval($q['day']);
+			$where .= &quot; AND DAYOFMONTH(post_date)='&quot; . $q['day'] . &quot;'&quot;;
+		}
+
+		if ('' != $q['name']) {
+			$q['name'] = sanitize_title($q['name']);
+			$where .= &quot; AND post_name = '&quot; . $q['name'] . &quot;'&quot;;
+		} else if ('' != $q['pagename']) {
+			$q['pagename'] = sanitize_title(basename(str_replace('%2F', '/', urlencode($q['pagename']))));
+			$q['name'] = $q['pagename'];
+			$where .= &quot; AND post_name = '&quot; . $q['pagename'] . &quot;'&quot;;
+		}
+
+
+		if ( (int) $q['w'] ) {
+			$q['w'] = ''.intval($q['w']);
+			$where .= &quot; AND WEEK(post_date, 1)='&quot; . $q['w'] . &quot;'&quot;;
+		}
+
+		if ( intval($q['comments_popup']) )
+			$q['p'] = intval($q['comments_popup']);
+
+		// If a post number is specified, load that post
+		if (($q['p'] != '') &amp;&amp; intval($q['p']) != 0) {
+			$q['p'] =  (int) $q['p'];
+			$where = ' AND ID = ' . $q['p'];
+		}
+
+		if (($q['page_id'] != '') &amp;&amp; (intval($q['page_id']) != 0)) {
+			$q['page_id'] = intval($q['page_id']);
+			$q['p'] = $q['page_id'];
+			$where = ' AND ID = '.$q['page_id'];
+		}
+
+		// If a search pattern is specified, load the posts that match
+		if (!empty($q['s'])) {
+			$q['s'] = addslashes_gpc($q['s']);
+			$search = ' AND (';
+			$q['s'] = preg_replace('/, +/', ' ', $q['s']);
+			$q['s'] = str_replace(',', ' ', $q['s']);
+			$q['s'] = str_replace('&quot;', ' ', $q['s']);
+			$q['s'] = trim($q['s']);
+			if ($q['exact']) {
+				$n = '';
+			} else {
+				$n = '%';
+			}
+			if (!$q['sentence']) {
+				$s_array = explode(' ',$q['s']);
+				$q['search_terms'] = $s_array;
+				$search .= '((post_title LIKE \''.$n.$s_array[0].$n.'\') OR (post_content LIKE \''.$n.$s_array[0].$n.'\'))';
+				for ( $i = 1; $i &lt; count($s_array); $i = $i + 1) {
+					$search .= ' AND ((post_title LIKE \''.$n.$s_array[$i].$n.'\') OR (post_content LIKE \''.$n.$s_array[$i].$n.'\'))';
+				}
+				$search .= ' OR (post_title LIKE \''.$n.$q['s'].$n.'\') OR (post_content LIKE \''.$n.$q['s'].$n.'\')';
+				$search .= ')';
+			} else {
+				$search = ' AND ((post_title LIKE \''.$n.$q['s'].$n.'\') OR (post_content LIKE \''.$n.$q['s'].$n.'\'))';
+			}
+		}
+
+		// Category stuff
+
+		if ((empty($q['cat'])) || ($q['cat'] == '0') || 
+				// Bypass cat checks if fetching specific posts
+				( $this-&gt;is_single || $this-&gt;is_page )) {
+			$whichcat='';
+		} else {
+			$q['cat'] = ''.urldecode($q['cat']).'';
+			$q['cat'] = addslashes_gpc($q['cat']);
+			if (stristr($q['cat'],'-')) {
+				// Note: if we have a negative, we ignore all the positives. It must
+				// always mean 'everything /except/ this one'. We should be able to do
+				// multiple negatives but we don't :-(
+				$eq = '!=';
+				$andor = 'AND';
+				$q['cat'] = explode('-',$q['cat']);
+				$q['cat'] = intval($q['cat'][1]);
+			} else {
+				$eq = '=';
+				$andor = 'OR';
+			}
+			$join = &quot; LEFT JOIN $wpdb-&gt;post2cat ON ($wpdb-&gt;posts.ID = $wpdb-&gt;post2cat.post_id) &quot;;
+			$cat_array = preg_split('/[,\s]+/', $q['cat']);
+			$whichcat .= ' AND (category_id '.$eq.' '.intval($cat_array[0]);
+			$whichcat .= get_category_children($cat_array[0], ' '.$andor.' category_id '.$eq.' ');
+			for ($i = 1; $i &lt; (count($cat_array)); $i = $i + 1) {
+				$whichcat .= ' '.$andor.' category_id '.$eq.' '.intval($cat_array[$i]);
+				$whichcat .= get_category_children($cat_array[$i], ' '.$andor.' category_id '.$eq.' ');
+			}
+			$whichcat .= ')';
+			if ($eq == '!=') {
+				$q['cat'] = '-'.$q['cat']; // Put back the knowledge that we are excluding a category.
+			}
+		}
+
+		// Category stuff for nice URIs
+
+		if ('' != $q['category_name']) {
+			if (stristr($q['category_name'],'/')) {
+				$q['category_name'] = explode('/',$q['category_name']);
+				if ($q['category_name'][count($q['category_name'])-1]) {
+					$q['category_name'] = $q['category_name'][count($q['category_name'])-1]; // no trailing slash
+				} else {
+					$q['category_name'] = $q['category_name'][count($q['category_name'])-2]; // there was a trailling slash
+				}
+			}
+			$q['category_name'] = sanitize_title($q['category_name']);
+			$tables = &quot;, $wpdb-&gt;post2cat, $wpdb-&gt;categories&quot;;
+			$join = &quot; LEFT JOIN $wpdb-&gt;post2cat ON ($wpdb-&gt;posts.ID = $wpdb-&gt;post2cat.post_id) LEFT JOIN $wpdb-&gt;categories ON ($wpdb-&gt;post2cat.category_id = $wpdb-&gt;categories.cat_ID) &quot;;
+			$whichcat = &quot; AND (category_nicename = '&quot; . $q['category_name'] . &quot;'&quot;;
+			$q['cat'] = $wpdb-&gt;get_var(&quot;SELECT cat_ID FROM $wpdb-&gt;categories WHERE category_nicename = '&quot; . $q['category_name'] . &quot;'&quot;);
+			$whichcat .= get_category_children($q['cat'], &quot; OR category_id = &quot;);
+			$whichcat .= &quot;)&quot;;
+		}
+
+		// Author/user stuff
+
+		if ((empty($q['author'])) || ($q['author'] == '0')) {
+			$whichauthor='';
+		} else {
+			$q['author'] = ''.urldecode($q['author']).'';
+			$q['author'] = addslashes_gpc($q['author']);
+			if (stristr($q['author'], '-')) {
+				$eq = '!=';
+				$andor = 'AND';
+				$q['author'] = explode('-', $q['author']);
+				$q['author'] = ''.intval($q['author'][1]);
+			} else {
+				$eq = '=';
+				$andor = 'OR';
+			}
+			$author_array = preg_split('/[,\s]+/', $q['author']);
+			$whichauthor .= ' AND (post_author '.$eq.' '.intval($author_array[0]);
+			for ($i = 1; $i &lt; (count($author_array)); $i = $i + 1) {
+				$whichauthor .= ' '.$andor.' post_author '.$eq.' '.intval($author_array[$i]);
+			}
+			$whichauthor .= ')';
+		}
+
+		// Author stuff for nice URIs
+
+		if ('' != $q['author_name']) {
+			if (stristr($q['author_name'],'/')) {
+				$q['author_name'] = explode('/',$q['author_name']);
+				if ($q['author_name'][count($q['author_name'])-1]) {
+					$q['author_name'] = $q['author_name'][count($q['author_name'])-1];#no trailing slash
+				} else {
+					$q['author_name'] = $q['author_name'][count($q['author_name'])-2];#there was a trailling slash
+				}
+			}
+			$q['author_name'] = sanitize_title($q['author_name']);
+			$q['author'] = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;users WHERE user_nicename='&quot;.$q['author_name'].&quot;'&quot;);
+			$whichauthor .= ' AND (post_author = '.intval($q['author']).')';
+		}
+
+		$where .= $search.$whichcat.$whichauthor;
+
+		if ((empty($q['order'])) || ((strtoupper($q['order']) != 'ASC') &amp;&amp; (strtoupper($q['order']) != 'DESC'))) {
+			$q['order']='DESC';
+		}
+
+		// Order by
+		if (empty($q['orderby'])) {
+			$q['orderby']='date '.$q['order'];
+		} else {
+			// Used to filter values
+			$allowed_keys = array('author','date','category','title');
+			$q['orderby'] = urldecode($q['orderby']);
+			$q['orderby'] = addslashes_gpc($q['orderby']);
+			$orderby_array = explode(' ',$q['orderby']);
+			if (!in_array($orderby_array[0],$allowed_keys)) {
+				$orderby_array[0] = 'date';
+			}
+			$q['orderby'] = $orderby_array[0].' '.$q['order'];
+			if (count($orderby_array)&gt;1) {
+				for ($i = 1; $i &lt; (count($orderby_array)); $i = $i + 1) {
+					// Only allow certain values for safety
+					if (in_array($orderby_array[$i],$allowed_keys)) {
+						$q['orderby'] .= ',post_'.$orderby_array[$i].' '.$q['order'];
+					}
+				}
+			}
+		}
+
+		$now = gmdate('Y-m-d H:i:59');
+
+		if ($pagenow != 'post.php' &amp;&amp; $pagenow != 'edit.php') {
+			$where .= &quot; AND post_date_gmt &lt;= '$now'&quot;;
+			$distinct = 'DISTINCT';
+		}
+
+		if ($this-&gt;is_page) {
+			$where .= ' AND (post_status = &quot;static&quot;)';
+		} elseif ($this-&gt;is_single) {
+			$where .= ' AND (post_status != &quot;static&quot;)';
+		} else {
+			$where .= ' AND (post_status = &quot;publish&quot;';
+
+			if (isset($user_ID) &amp;&amp; ('' != intval($user_ID)))
+				$where .= &quot; OR post_author = $user_ID AND post_status != 'draft' AND post_status != 'static')&quot;;
+			else
+				$where .= ')';				
+		}
+
+		// Apply filters on where and join prior to paging so that any
+		// manipulations to them are reflected in the paging by day queries.
+		$where = apply_filters('posts_where', $where);
+		$join = apply_filters('posts_join', $join);
+
+		// Paging
+		if (empty($q['nopaging']) &amp;&amp; ! $this-&gt;is_single) {
+			$page = $q['paged'];
+			if (empty($page)) {
+				$page = 1;
+			}
+
+			if (($q['what_to_show'] == 'posts')) {
+				$pgstrt = '';
+				$pgstrt = (intval($page) -1) * $q['posts_per_page'] . ', ';
+				$limits = 'LIMIT '.$pgstrt.$q['posts_per_page'];
+			} elseif ($q['what_to_show'] == 'days') {
+				$startrow = $q['posts_per_page'] * (intval($page)-1);
+				$start_date = $wpdb-&gt;get_var(&quot;SELECT max(post_date) FROM $wpdb-&gt;posts $join WHERE (1=1) $where GROUP BY year(post_date), month(post_date), dayofmonth(post_date) ORDER BY post_date DESC LIMIT $startrow,1&quot;);
+				$endrow = $startrow + $q['posts_per_page'] - 1;
+				$end_date = $wpdb-&gt;get_var(&quot;SELECT min(post_date) FROM $wpdb-&gt;posts $join WHERE (1=1) $where GROUP BY year(post_date), month(post_date), dayofmonth(post_date) ORDER BY post_date DESC LIMIT $endrow,1&quot;);
+
+				if ($page &gt; 1) {
+					$where .= &quot; AND post_date &gt;= '$end_date' AND post_date &lt;= '$start_date'&quot;;
+				} else {
+					$where .= &quot; AND post_date &gt;= '$end_date'&quot;;
+				}
+			}
+		}
+
+		// Apply post-paging filters on where and join.  Only plugins that
+		// manipulate paging queries should use these hooks.
+		$where = apply_filters('posts_where_paged', $where);
+		$where .= &quot; GROUP BY $wpdb-&gt;posts.ID&quot;;
+		$join = apply_filters('posts_join_paged', $join);
+		$orderby = &quot;post_&quot; . $q['orderby'];
+		$orderby = apply_filters('posts_orderby', $orderby); 
+		$request = &quot; SELECT $distinct * FROM $wpdb-&gt;posts $join WHERE 1=1&quot;.$where.&quot; ORDER BY &quot; . $orderby . &quot; $limits&quot;;
+
+		$this-&gt;posts = $wpdb-&gt;get_results($request);
+
+		// Check post status to determine if post should be displayed.
+		if ($this-&gt;is_single) {
+			if ('publish' != $this-&gt;posts[0]-&gt;post_status) {
+				if ( ! (isset($user_ID) &amp;&amp; ('' != intval($user_ID))) ) {
+					// User must be logged in to view unpublished posts.
+					$this-&gt;posts = array();
+				} else {
+					if ('draft' == $this-&gt;posts[0]-&gt;post_status) {
+						// User must have edit permissions on the draft to preview.
+						if (! user_can_edit_post($user_ID, $this-&gt;posts[0]-&gt;ID))
+							$this-&gt;posts = array();
+					} elseif ('private' == $this-&gt;posts[0]-&gt;post_status) {
+						if ($this-&gt;posts[0]-&gt;post_author != $user_ID)
+							$this-&gt;posts = array();
+					}
+				}
+			}
+		}
+
+		$this-&gt;posts = apply_filters('the_posts', $this-&gt;posts);
+		$this-&gt;post_count = count($this-&gt;posts);
+		if ($this-&gt;post_count &gt; 0) {
+			$this-&gt;post = $this-&gt;posts[0];
+		}
+
+		update_post_caches($this-&gt;posts);
+		
+		// Save any changes made to the query vars.
+		$this-&gt;query_vars = $q;
+		return $this-&gt;posts;
+	}
+
+	function next_post() {
+        
+		$this-&gt;current_post++;
+
+		$this-&gt;post = $this-&gt;posts[$this-&gt;current_post];
+		return $this-&gt;post;
+	}
+
+	function the_post() {
+		global $post;
+		$post = $this-&gt;next_post();
+		setup_postdata($post);
+	}
+
+	function have_posts() {
+		if ($this-&gt;current_post + 1 &lt; $this-&gt;post_count) {
+			return true;
+		}
+
+		return false;
+	}
+
+	function rewind_posts() {
+		$this-&gt;current_post = -1;
+		if ($this-&gt;post_count &gt; 0) {
+			$this-&gt;post = $this-&gt;posts[0];
+		}
+	}
+    
+	function &amp;query($query) {
+		$this-&gt;parse_query($query);
+		return $this-&gt;get_posts();
+	}
+
+	function get_queried_object() {
+		if (isset($this-&gt;queried_object)) {
+			return $this-&gt;queried_object;
+		}
+
+		$this-&gt;queried_object = NULL;
+		$this-&gt;queried_object_id = 0;
+
+		if ($this-&gt;is_category) {
+			$category = &amp;get_category($this-&gt;get('cat'));
+			$this-&gt;queried_object = &amp;$category;
+			$this-&gt;queried_object_id = $this-&gt;get('cat');
+		} else if ($this-&gt;is_single) {
+			$this-&gt;queried_object = $this-&gt;post;
+			$this-&gt;queried_object_id = $this-&gt;post-&gt;ID;
+		} else if ($this-&gt;is_page) {
+			$this-&gt;queried_object = $this-&gt;post;
+			$this-&gt;queried_object_id = $this-&gt;post-&gt;ID;
+		} else if ($this-&gt;is_author) {
+			global $cache_userdata;
+			if (isset($cache_userdata[$this-&gt;get('author')])) {
+				$this-&gt;queried_object = $cache_userdata[$this-&gt;get('author')];
+				$this-&gt;queried_object_id = $this-&gt;get('author');
+			}
+		}
+
+		return $this-&gt;queried_object;
+	}
+
+	function get_queried_object_id() {
+		$this-&gt;get_queried_object();
+
+		if (isset($this-&gt;queried_object_id)) {
+			return $this-&gt;queried_object_id;
+		}
+
+		return 0;
+	}
+
+	function WP_Query ($query = '') {
+		if (! empty($query)) {
+			$this-&gt;query($query);
+		}
+	}
+}
+
+// Make a global instance.
+if (! isset($wp_query)) {
+    $wp_query = new WP_Query();
+}
+
+class retrospam_mgr {
+	var $spam_words;
+	var $comments_list;
+	var $found_comments;
+
+	function retrospam_mgr() {
+		global $wpdb;
+
+		$list = explode(&quot;\n&quot;, get_settings('moderation_keys') );
+		$list = array_unique( $list );
+		$this-&gt;spam_words = $list;
+
+		$this-&gt;comment_list = $wpdb-&gt;get_results(&quot;SELECT comment_ID AS ID, comment_content AS text, comment_approved AS approved, comment_author_url AS url, comment_author_ip AS ip, comment_author_email AS email FROM $wpdb-&gt;comments ORDER BY comment_ID ASC&quot;);
+	}	// End of class constructor
+
+	function move_spam( $id_list ) {
+		global $wpdb;
+		$cnt = 0;
+		$id_list = explode( ',', $id_list );
+
+		foreach ( $id_list as $comment ) {
+			if ( $wpdb-&gt;query(&quot;update $wpdb-&gt;comments set comment_approved = '0' where comment_ID = '$comment'&quot;) ) {
+				$cnt++;
+			}
+		}
+		echo &quot;&lt;div class='updated'&gt;&lt;p&gt;$cnt comment&quot;;
+		if ($cnt != 1 ) echo &quot;s&quot;;
+		echo &quot; moved to the moderation queue.&lt;/p&gt;&lt;/div&gt;\n&quot;;
+	}	// End function move_spam
+
+	function find_spam() {
+		$in_queue = 0;
+
+		foreach( $this-&gt;comment_list as $comment ) {
+			if( $comment-&gt;approved == 1 ) {
+				foreach( $this-&gt;spam_words as $word ) {
+					if ( empty( $word ) )
+						continue;
+					$fulltext = strtolower($comment-&gt;email.' '.$comment-&gt;url.' '.$comment-&gt;ip.' '.$comment-&gt;text);
+					if( strpos( $fulltext, strtolower(trim($word)) ) != FALSE ) {
+						$this-&gt;found_comments[] = $comment-&gt;ID;
+						break;
+					}
+				}
+			} else {
+				$in_queue++;
+			}
+		}
+		return array( 'found' =&gt; $this-&gt;found_comments, 'in_queue' =&gt; $in_queue );
+	}	// End function find_spam
+
+	function display_edit_form( $counters ) {
+		$numfound = count($counters[found]);
+		$numqueue = $counters[in_queue];
+
+		$body = '&lt;p&gt;' . sprintf(__('Suspected spam comments: &lt;strong&gt;%s&lt;/strong&gt;'), $numfound) . '&lt;/p&gt;';
+
+		if ( count($counters[found]) &gt; 0 ) {
+			$id_list = implode( ',', $counters[found] );
+			$body .= '&lt;p&gt;&lt;a href=&quot;options-discussion.php?action=retrospam&amp;move=true&amp;ids='.$id_list.'&quot;&gt;'. __('Move suspect comments to moderation queue &raquo;') . '&lt;/a&gt;&lt;/p&gt;';
+
+		}
+		$head = '&lt;div class=&quot;wrap&quot;&gt;&lt;h2&gt;' . __('Check Comments Results:') . '&lt;/h2&gt;';
+
+		$foot .= '&lt;p&gt;&lt;a href=&quot;options-discussion.php&quot;&gt;' . __('&laquo; Return to Discussion Options page.') . '&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;';
+		
+		return $head . $body . $foot;
+	} 	// End function display_edit_form
+
+}
+
+class WP_Rewrite {
+	var $permalink_structure;
+	var $category_base;
+	var $category_structure;
+	var $author_base = 'author';
+	var $author_structure;
+	var $date_structure;
+	var $page_structure;
+	var $search_base = 'search';
+	var $search_structure;
+	var $comments_base = 'comments';
+	var $feed_base = 'feed';
+	var $comments_feed_structure;
+	var $feed_structure;
+	var $front;
+	var $root = '';
+	var $index = 'index.php';
+	var $matches = '';
+	var $rules;
+	var $rewritecode = 
+		array(
+					'%year%',
+					'%monthnum%',
+					'%day%',
+					'%hour%',
+					'%minute%',
+					'%second%',
+					'%postname%',
+					'%post_id%',
+					'%category%',
+					'%author%',
+					'%pagename%',
+					'%search%'
+					);
+
+	var $rewritereplace = 
+		array(
+					'([0-9]{4})',
+					'([0-9]{1,2})',
+					'([0-9]{1,2})',
+					'([0-9]{1,2})',
+					'([0-9]{1,2})',
+					'([0-9]{1,2})',
+					'([^/]+)',
+					'([0-9]+)',
+					'(.+?)',
+					'([^/]+)',
+					'([^/]+)',
+					'(.+)'
+					);
+
+	var $queryreplace = 
+		array (
+					 'year=',
+					 'monthnum=',
+					 'day=',
+					 'hour=',
+					 'minute=',
+					 'second=',
+					 'name=',
+					 'p=',
+					 'category_name=',
+					 'author_name=',
+					 'pagename=',
+					 's='
+					 );
+
+	var $feeds = array ('feed', 'rdf', 'rss', 'rss2', 'atom');
+
+	function using_permalinks() {
+		if (empty($this-&gt;permalink_structure))
+			return false;
+		else
+			return true;
+	}					
+
+	function using_index_permalinks() {
+    if (empty($this-&gt;permalink_structure)) {
+			return false;
+    }
+
+    // If the index is not in the permalink, we're using mod_rewrite.
+    if (preg_match('#^/*' . $this-&gt;index . '#', $this-&gt;permalink_structure)) {
+      return true;
+    }
+    
+    return false;
+	}
+
+	function using_mod_rewrite_permalinks() {
+		if ( $this-&gt;using_permalinks() &amp;&amp; ! $this-&gt;using_index_permalinks())
+			return true;
+		else
+			return false;
+	}					
+
+	function preg_index($number) {
+    $match_prefix = '$';
+    $match_suffix = '';
+    
+    if (! empty($this-&gt;matches)) {
+			$match_prefix = '$' . $this-&gt;matches . '['; 
+			$match_suffix = ']';
+    }        
+    
+    return &quot;$match_prefix$number$match_suffix&quot;;        
+	}
+
+	function page_rewrite_rules() {
+		$uris = get_settings('page_uris');
+
+		$rewrite_rules = array();
+		$page_structure = $this-&gt;get_page_permastruct();
+		if( is_array( $uris ) )
+			{
+				foreach ($uris as $uri =&gt; $pagename) {
+					$this-&gt;add_rewrite_tag('%pagename%', &quot;($uri)&quot;, 'pagename=');
+					$rewrite_rules += $this-&gt;generate_rewrite_rules($page_structure);
+				}
+			}
+
+		return $rewrite_rules;
+	}
+
+	function get_date_permastruct() {
+		if (isset($this-&gt;date_structure)) {
+			return $this-&gt;date_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;date_structure = '';
+			return false;
+		}
+		
+		// The date permalink must have year, month, and day separated by slashes.
+		$endians = array('%year%/%monthnum%/%day%', '%day%/%monthnum%/%year%', '%monthnum%/%day%/%year%');
+
+		$this-&gt;date_structure = '';
+		$date_endian = '';
+
+		foreach ($endians as $endian) {
+			if (false !== strpos($this-&gt;permalink_structure, $endian)) {
+				$date_endian= $endian;
+				break;
+			}
+		} 
+
+		if ( empty($date_endian) )
+			$date_endian = '%year%/%monthnum%/%day%';
+
+		// Do not allow the date tags and %post_id% to overlap in the permalink
+		// structure. If they do, move the date tags to $front/date/.  
+		$front = $this-&gt;front;
+		preg_match_all('/%.+?%/', $this-&gt;permalink_structure, $tokens);
+		$tok_index = 1;
+		foreach ($tokens[0] as $token) {
+			if ( ($token == '%post_id%') &amp;&amp; ($tok_index &lt;= 3) ) {
+				$front = $front . 'date/';
+				break;
+			}
+		}
+
+		$this-&gt;date_structure = $front . $date_endian;
+
+		return $this-&gt;date_structure;
+	}
+
+	function get_year_permastruct() {
+		$structure = $this-&gt;get_date_permastruct($permalink_structure);
+
+		if (empty($structure)) {
+			return false;
+		}
+
+		$structure = str_replace('%monthnum%', '', $structure);
+		$structure = str_replace('%day%', '', $structure);
+
+		$structure = preg_replace('#/+#', '/', $structure);
+
+		return $structure;
+	}
+
+	function get_month_permastruct() {
+		$structure = $this-&gt;get_date_permastruct($permalink_structure);
+
+		if (empty($structure)) {
+			return false;
+		}
+
+		$structure = str_replace('%day%', '', $structure);
+
+		$structure = preg_replace('#/+#', '/', $structure);
+
+		return $structure;
+	}
+
+	function get_day_permastruct() {
+		return $this-&gt;get_date_permastruct($permalink_structure);
+	}
+
+	function get_category_permastruct() {
+		if (isset($this-&gt;category_structure)) {
+			return $this-&gt;category_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;category_structure = '';
+			return false;
+		}
+
+		if (empty($this-&gt;category_base))
+			$this-&gt;category_structure = $this-&gt;front . 'category/';
+		else
+			$this-&gt;category_structure = $this-&gt;category_base . '/';
+
+		$this-&gt;category_structure .= '%category%';
+		
+		return $this-&gt;category_structure;
+	}
+
+	function get_author_permastruct() {
+		if (isset($this-&gt;author_structure)) {
+			return $this-&gt;author_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;author_structure = '';
+			return false;
+		}
+
+		$this-&gt;author_structure = $this-&gt;front . $this-&gt;author_base . '/%author%';
+
+		return $this-&gt;author_structure;
+	}
+
+	function get_search_permastruct() {
+		if (isset($this-&gt;search_structure)) {
+			return $this-&gt;search_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;search_structure = '';
+			return false;
+		}
+
+		$this-&gt;search_structure = $this-&gt;root . $this-&gt;search_base . '/%search%';
+
+		return $this-&gt;search_structure;
+	}
+
+	function get_page_permastruct() {
+		if (isset($this-&gt;page_structure)) {
+			return $this-&gt;page_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;page_structure = '';
+			return false;
+		}
+
+		$this-&gt;page_structure = $this-&gt;root . '%pagename%';
+
+		return $this-&gt;page_structure;
+	}
+
+	function get_feed_permastruct() {
+		if (isset($this-&gt;feed_structure)) {
+			return $this-&gt;feed_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;feed_structure = '';
+			return false;
+		}
+
+		$this-&gt;feed_structure = $this-&gt;root . $this-&gt;feed_base . '/%feed%';
+
+		return $this-&gt;feed_structure;
+	}
+
+	function get_comment_feed_permastruct() {
+		if (isset($this-&gt;comment_feed_structure)) {
+			return $this-&gt;comment_feed_structure;
+		}
+
+    if (empty($this-&gt;permalink_structure)) {
+			$this-&gt;comment_feed_structure = '';
+			return false;
+		}
+
+		$this-&gt;comment_feed_structure = $this-&gt;root . $this-&gt;comments_base . '/' . $this-&gt;feed_base . '/%feed%';
+
+		return $this-&gt;comment_feed_structure;
+	}
+
+	function add_rewrite_tag($tag, $pattern, $query) {
+		// If the tag already exists, replace the existing pattern and query for
+		// that tag, otherwise add the new tag, pattern, and query to the end of
+		// the arrays.
+		$position = array_search($tag, $this-&gt;rewritecode);		
+		if (FALSE !== $position &amp;&amp; NULL !== $position) {
+			$this-&gt;rewritereplace[$position] = $pattern;
+			$this-&gt;queryreplace[$position] = $query;			
+		} else {
+			$this-&gt;rewritecode[] = $tag;
+			$this-&gt;rewritereplace[] = $pattern;
+			$this-&gt;queryreplace[] = $query;
+		}
+	}
+
+	function generate_rewrite_rules($permalink_structure, $page = true, $feed = true, $forcomments = false, $walk_dirs = true) {
+		$feedregex2 = '';
+		foreach ($this-&gt;feeds as $feed_name) {
+			$feedregex2 .= $feed_name . '|';
+		}
+		$feedregex2 = '(' . trim($feedregex2, '|') .  ')/?$';
+		$feedregex = $this-&gt;feed_base  . '/' . $feedregex2;
+
+		$trackbackregex = 'trackback/?$';
+		$pageregex = 'page/?([0-9]{1,})/?$';
+		
+		$front = substr($permalink_structure, 0, strpos($permalink_structure, '%'));
+		preg_match_all('/%.+?%/', $permalink_structure, $tokens);
+
+		$num_tokens = count($tokens[0]);
+
+		$index = $this-&gt;index;
+		$feedindex = $index;
+		$trackbackindex = $index;
+		for ($i = 0; $i &lt; $num_tokens; ++$i) {
+			if (0 &lt; $i) {
+				$queries[$i] = $queries[$i - 1] . '&amp;';
+			}
+             
+			$query_token = str_replace($this-&gt;rewritecode, $this-&gt;queryreplace, $tokens[0][$i]) . $this-&gt;preg_index($i+1);
+			$queries[$i] .= $query_token;
+		}
+
+		$structure = $permalink_structure;
+		if ($front != '/') {
+			$structure = str_replace($front, '', $structure);
+		}
+		$structure = trim($structure, '/');
+		if ($walk_dirs) {
+			$dirs = explode('/', $structure);
+		} else {
+			$dirs[] = $structure;
+		}
+		$num_dirs = count($dirs);
+
+		$front = preg_replace('|^/+|', '', $front);
+
+		$post_rewrite = array();
+		$struct = $front;
+		for ($j = 0; $j &lt; $num_dirs; ++$j) {
+			$struct .= $dirs[$j] . '/';
+			$struct = ltrim($struct, '/');
+			$match = str_replace($this-&gt;rewritecode, $this-&gt;rewritereplace, $struct);
+			$num_toks = preg_match_all('/%.+?%/', $struct, $toks);
+			$query = $queries[$num_toks - 1];
+
+			$pagematch = $match . $pageregex;
+			$pagequery = $index . '?' . $query . '&amp;paged=' . $this-&gt;preg_index($num_toks + 1);
+
+			$feedmatch = $match . $feedregex;
+			$feedquery = $feedindex . '?' . $query . '&amp;feed=' . $this-&gt;preg_index($num_toks + 1);
+
+			$feedmatch2 = $match . $feedregex2;
+			$feedquery2 = $feedindex . '?' . $query . '&amp;feed=' . $this-&gt;preg_index($num_toks + 1);
+
+			if ($forcomments) {
+				$feedquery .= '&amp;withcomments=1';
+				$feedquery2 .= '&amp;withcomments=1';
+			}
+
+			$rewrite = array();
+			if ($feed) 
+				$rewrite = array($feedmatch =&gt; $feedquery, $feedmatch2 =&gt; $feedquery2);
+			if ($page)
+				$rewrite = $rewrite + array($pagematch =&gt; $pagequery);
+
+			if ($num_toks) {
+				$post = 0;
+				if (strstr($struct, '%postname%') || strstr($struct, '%post_id%')
+						|| strstr($struct, '%pagename%')
+						|| (strstr($struct, '%year%') &amp;&amp;  strstr($struct, '%monthnum%') &amp;&amp; strstr($struct, '%day%') &amp;&amp; strstr($struct, '%hour%') &amp;&amp; strstr($struct, '%minute') &amp;&amp; strstr($struct, '%second%'))) {
+					$post = 1;
+					$trackbackmatch = $match . $trackbackregex;
+					$trackbackquery = $trackbackindex . '?' . $query . '&amp;tb=1';
+					$match = rtrim($match, '/');
+					$match = $match . '(/[0-9]+)?/?$';
+					$query = $index . '?' . $query . '&amp;page=' . $this-&gt;preg_index($num_toks + 1);
+				} else {
+					$match .= '?$';
+					$query = $index . '?' . $query;
+				}
+				        
+				$rewrite = $rewrite + array($match =&gt; $query);
+
+				if ($post) {
+					$rewrite = array($trackbackmatch =&gt; $trackbackquery) + $rewrite;
+				}
+			}
+
+			$post_rewrite = $rewrite + $post_rewrite;
+		}
+
+		return $post_rewrite;
+	}
+
+	function generate_rewrite_rule($permalink_structure, $walk_dirs = false) {
+		return $this-&gt;generate_rewrite_rules($permalink_structure, false, false, false, $walk_dirs);
+	}
+
+	/* rewrite_rules
+	 * Construct rewrite matches and queries from permalink structure.
+	 * Returns an associate array of matches and queries.
+	 */
+	function rewrite_rules() {
+		$rewrite = array();
+
+		if (empty($this-&gt;permalink_structure)) {
+			return $rewrite;
+		}
+
+		// Post
+		$post_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;permalink_structure);
+		$post_rewrite = apply_filters('post_rewrite_rules', $post_rewrite);
+
+		// Date
+		$date_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;get_date_permastruct());
+		$date_rewrite = apply_filters('date_rewrite_rules', $date_rewrite);
+		
+		// Root
+		$root_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;root . '/');
+		$root_rewrite = apply_filters('root_rewrite_rules', $root_rewrite);
+
+		// Comments
+		$comments_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;root . $this-&gt;comments_base, true, true, true);
+		$comments_rewrite = apply_filters('comments_rewrite_rules', $comments_rewrite);
+
+		// Search
+		$search_structure = $this-&gt;get_search_permastruct();
+		$search_rewrite = $this-&gt;generate_rewrite_rules($search_structure);
+		$search_rewrite = apply_filters('search_rewrite_rules', $search_rewrite);
+
+		// Categories
+		$category_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;get_category_permastruct());
+		$category_rewrite = apply_filters('category_rewrite_rules', $category_rewrite);
+
+		// Authors
+		$author_rewrite = $this-&gt;generate_rewrite_rules($this-&gt;get_author_permastruct());
+		$author_rewrite = apply_filters('author_rewrite_rules', $author_rewrite);
+
+		// Pages
+		$page_rewrite = $this-&gt;page_rewrite_rules();
+		$page_rewrite = apply_filters('page_rewrite_rules', $page_rewrite);
+
+		// Put them together.
+		$this-&gt;rules = $page_rewrite + $root_rewrite + $comments_rewrite + $search_rewrite + $category_rewrite + $author_rewrite + $date_rewrite + $post_rewrite;
+
+		do_action('generate_rewrite_rules', array(&amp;$this));
+		$this-&gt;rules = apply_filters('rewrite_rules_array', $this-&gt;rules);
+		return $this-&gt;rules;
+	}
+
+	function wp_rewrite_rules() {
+		$this-&gt;matches = 'matches';
+		return $this-&gt;rewrite_rules();
+	}
+
+	function mod_rewrite_rules() {
+		if ( ! $this-&gt;using_permalinks()) {
+			return '';
+		}
+
+		$site_root = parse_url(get_settings('siteurl'));
+		$site_root = trailingslashit($site_root['path']);
+
+		$home_root = parse_url(get_settings('home'));
+		$home_root = trailingslashit($home_root['path']);
+    
+		$rules = &quot;&lt;IfModule mod_rewrite.c&gt;\n&quot;;
+		$rules .= &quot;RewriteEngine On\n&quot;;
+		$rules .= &quot;RewriteBase $home_root\n&quot;;
+		$this-&gt;matches = '';
+		$rewrite = $this-&gt;rewrite_rules();
+		$num_rules = count($rewrite);
+		$rules .= &quot;RewriteCond %{REQUEST_FILENAME} -f [OR]\n&quot; .
+			&quot;RewriteCond %{REQUEST_FILENAME} -d\n&quot; .
+			&quot;RewriteRule ^.*$ - [S=$num_rules]\n&quot;;
+
+		foreach ($rewrite as $match =&gt; $query) {
+			// Apache 1.3 does not support the reluctant (non-greedy) modifier.
+			$match = str_replace('.+?', '.+', $match);
+
+			// If the match is unanchored and greedy, prepend rewrite conditions
+			// to avoid infinite redirects and eclipsing of real files.
+			if ($match == '(.+)/?$' || $match == '([^/]+)/?$' ) {
+				//nada.
+			}
+
+			if (strstr($query, $this-&gt;index)) {
+				$rules .= 'RewriteRule ^' . $match . ' ' . $home_root . $query . &quot; [QSA,L]\n&quot;;
+			} else {
+				$rules .= 'RewriteRule ^' . $match . ' ' . $site_root . $query . &quot; [QSA,L]\n&quot;;
+			}
+		}
+		$rules .= &quot;&lt;/IfModule&gt;\n&quot;;
+
+		$rules = apply_filters('mod_rewrite_rules', $rules);
+		$rules = apply_filters('rewrite_rules', $rules);  // Deprecated
+
+		return $rules;
+	}
+
+	function init() {
+		$this-&gt;permalink_structure = get_settings('permalink_structure');
+		$this-&gt;front = substr($this-&gt;permalink_structure, 0, strpos($this-&gt;permalink_structure, '%'));		
+		$this-&gt;root = '';
+		if ($this-&gt;using_index_permalinks()) {
+			$this-&gt;root = $this-&gt;index . '/';
+		}
+		$this-&gt;category_base = get_settings('category_base');
+		unset($this-&gt;category_structure);
+		unset($this-&gt;author_structure);
+		unset($this-&gt;date_structure);
+		unset($this-&gt;page_structure);
+		unset($this-&gt;search_structure);
+		unset($this-&gt;feed_structure);
+		unset($this-&gt;comment_feed_structure);
+	}
+
+	function set_permalink_structure($permalink_structure) {
+		if ($permalink_structure != $this-&gt;permalink_structure) {
+			update_option('permalink_structure', $permalink_structure);
+			$this-&gt;init();
+		}
+	}
+
+	function set_category_base($category_base) {
+		if ($category_base != $this-&gt;category_base) {
+			update_option('category_base', $category_base);
+			$this-&gt;init();
+		}
+	}
+
+	function WP_Rewrite() {
+		$this-&gt;init();
+	}
+}
+
+// Make a global instance.
+if (! isset($wp_rewrite)) {
+    $wp_rewrite = new WP_Rewrite();
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/comment-functions.php
===================================================================
--- trunk/wp-includes/comment-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/comment-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,676 @@
+&lt;?php
+
+// Template functions
+
+function comments_template( $file = '/comments.php' ) {
+	global $wp_query, $withcomments, $post, $wpdb, $id, $comment, $user_login, $user_ID, $user_identity;
+
+	if ( is_single() || is_page() || $withcomments ) :
+		$req = get_settings('require_name_email');
+		$comment_author = isset($_COOKIE['comment_author_'.COOKIEHASH]) ? trim(stripslashes($_COOKIE['comment_author_'.COOKIEHASH])) : '';
+		$comment_author_email = isset($_COOKIE['comment_author_email_'.COOKIEHASH]) ? trim(stripslashes($_COOKIE['comment_author_email_'.COOKIEHASH])) : '';
+		$comment_author_url = isset($_COOKIE['comment_author_url_'.COOKIEHASH]) ? trim(stripslashes($_COOKIE['comment_author_url_'.COOKIEHASH])) : '';
+	if ( empty($comment_author) ) {
+		$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = '$post-&gt;ID' AND comment_approved = '1' ORDER BY comment_date&quot;);
+	} else {
+		$author_db = addslashes($comment_author);
+		$email_db  = addslashes($comment_author_email);
+		$comments = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = '$post-&gt;ID' AND ( comment_approved = '1' OR ( comment_author = '$author_db' AND comment_author_email = '$email_db' AND comment_approved = '0' ) ) ORDER BY comment_date&quot;);
+	}
+
+	get_currentuserinfo();
+
+	define('COMMENTS_TEMPLATE', true);
+	$include = apply_filters('comments_template', TEMPLATEPATH . $file );
+	if ( file_exists( $include ) )
+		require( $include );
+	else
+		require( ABSPATH . 'wp-content/themes/default/comments.php');
+
+	endif;
+}
+
+function clean_url( $url ) {
+	if ('' == $url) return $url;
+	$url = preg_replace('|[^a-z0-9-~+_.?#=&amp;;,/:]|i', '', $url);
+	$url = str_replace(';//', '://', $url);
+	$url = (!strstr($url, '://')) ? '<A HREF="http://">http://</A>'.$url : $url;
+	$url = preg_replace('/&amp;([^#])(?![a-z]{2,8};)/', '&#038;$1', $url);
+	return $url;
+}
+
+function get_comments_number( $comment_id ) {
+	global $wpdb, $comment_count_cache;
+	$comment_id = (int) $comment_id;
+	if (!isset($comment_count_cache[$comment_id]))
+		$comment_count_cache[$comment_id] =  $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_id' AND comment_approved = '1'&quot;);
+	
+	return apply_filters('get_comments_number', $comment_count_cache[$comment_id]);
+}
+
+function comments_number( $zero = 'No Comments', $one = '1 Comment', $more = '% Comments', $number = '' ) {
+	global $id, $comment;
+	$number = get_comments_number( $id );
+	if ($number == 0) {
+		$blah = $zero;
+	} elseif ($number == 1) {
+		$blah = $one;
+	} elseif ($number  &gt; 1) {
+		$blah = str_replace('%', $number, $more);
+	}
+	echo apply_filters('comments_number', $blah);
+}
+
+function get_comments_link() {
+	return get_permalink() . '#comments';
+}
+
+function get_comment_link() {
+	global $comment;
+	return get_permalink( $comment-&gt;comment_post_ID ) . '#comment-' . $comment-&gt;comment_ID;
+}
+
+function comments_link( $file = '', $echo = true ) {
+    echo get_comments_link();
+}
+
+function comments_popup_script($width=400, $height=400, $file='') {
+    global $wpcommentspopupfile, $wptrackbackpopupfile, $wppingbackpopupfile, $wpcommentsjavascript;
+
+		if (empty ($file)) {
+			$wpcommentspopupfile = '';  // Use the index.
+		} else {
+			$wpcommentspopupfile = $file;
+		}
+
+    $wpcommentsjavascript = 1;
+    $javascript = &quot;&lt;script type='text/javascript'&gt;\nfunction wpopen (macagna) {\n    window.open(macagna, '_blank', 'width=$width,height=$height,scrollbars=yes,status=yes');\n}\n&lt;/script&gt;\n&quot;;
+    echo $javascript;
+}
+
+function comments_popup_link($zero='No Comments', $one='1 Comment', $more='% Comments', $CSSclass='', $none='Comments Off') {
+    global $id, $wpcommentspopupfile, $wpcommentsjavascript, $post, $wpdb;
+    global $comment_count_cache;
+
+	if (! is_single() &amp;&amp; ! is_page()) {
+    if ( !isset($comment_count_cache[$id]))
+			$comment_count_cache[$id] = $wpdb-&gt;get_var(&quot;SELECT COUNT(comment_ID) FROM $wpdb-&gt;comments WHERE comment_post_ID = $id AND comment_approved = '1';&quot;);
+
+		$number = $comment_count_cache[$id];
+
+    if (0 == $number &amp;&amp; 'closed' == $post-&gt;comment_status &amp;&amp; 'closed' == $post-&gt;ping_status) {
+        echo $none;
+        return;
+    } else {
+        if (!empty($post-&gt;post_password)) { // if there's a password
+            if ($_COOKIE['wp-postpass_'.COOKIEHASH] != $post-&gt;post_password) {  // and it doesn't match the cookie
+                echo('Enter your password to view comments');
+                return;
+            }
+        }
+        echo '&lt;a href=&quot;';
+        if ($wpcommentsjavascript) {
+					if ( empty($wpcommentspopupfile) )
+						$home = get_settings('home');
+					else
+						$home = get_settings('siteurl');
+					echo $home . '/' . $wpcommentspopupfile.'?comments_popup='.$id;
+					echo '&quot; onclick=&quot;wpopen(this.href); return false&quot;';
+        } else {
+            // if comments_popup_script() is not in the template, display simple comment link
+            comments_link();
+            echo '&quot;';
+        }
+        if (!empty($CSSclass)) {
+            echo ' class=&quot;'.$CSSclass.'&quot;';
+        }
+        echo '&gt;';
+        comments_number($zero, $one, $more, $number);
+        echo '&lt;/a&gt;';
+    }
+	}
+}
+
+function get_comment_ID() {
+	global $comment;
+	return apply_filters('get_comment_ID', $comment-&gt;comment_ID);
+}
+
+function comment_ID() {
+	echo get_comment_ID();
+}
+
+function get_comment_author() {
+	global $comment;
+	if ( empty($comment-&gt;comment_author) )
+		$author = 'Anonymous';
+	else
+		$author = $comment-&gt;comment_author;
+	return apply_filters('get_comment_author', $author);
+}
+
+function comment_author() {
+	$author = apply_filters('comment_author', get_comment_author() );
+	echo $author;
+}
+
+function get_comment_author_email() {
+	global $comment;
+	return apply_filters('get_comment_author_email', $comment-&gt;comment_author_email);	
+}
+
+function comment_author_email() {
+	echo apply_filters('author_email', get_comment_author_email() );
+}
+
+function get_comment_author_link() {
+	global $comment;
+	$url    = get_comment_author_url();
+	$author = get_comment_author();
+
+	if ( empty( $url ) )
+		$return = $author;
+	else
+		$return = &quot;&lt;a href='$url' rel='external nofollow'&gt;$author&lt;/a&gt;&quot;;
+	return apply_filters('get_comment_author_link', $return);
+}
+
+function comment_author_link() {
+	echo get_comment_author_link();
+}
+
+function get_comment_type() {
+	global $comment;
+
+	if ( '' == $comment-&gt;comment_type )
+		$comment-&gt;comment_type = 'comment';
+
+	return apply_filters('get_comment_type', $comment-&gt;comment_type);
+}
+
+function comment_type($commenttxt = 'Comment', $trackbacktxt = 'Trackback', $pingbacktxt = 'Pingback') {
+	$type = get_comment_type();
+	switch( $type ) {
+		case 'trackback' :
+			echo $trackbacktxt;
+			break;
+		case 'pingback' :
+			echo $pingbacktxt;
+			break;
+		default :
+			echo $commenttxt;
+	}
+}
+
+function get_comment_author_url() {
+	global $comment;
+	return apply_filters('get_comment_author_url', $comment-&gt;comment_author_url);
+}
+
+function comment_author_url() {
+	echo apply_filters('comment_url', get_comment_author_url());
+}
+
+function comment_author_email_link($linktext='', $before='', $after='') {
+	global $comment;
+	$email = apply_filters('comment_email', $comment-&gt;comment_author_email);
+	if ((!empty($email)) &amp;&amp; ($email != '@')) {
+	$display = ($linktext != '') ? $linktext : $email;
+		echo $before;
+		echo &quot;&lt;a href='mailto:$email'&gt;$display&lt;/a&gt;&quot;;
+		echo $after;
+	}
+}
+
+function get_comment_author_url_link( $linktext = '', $before = '', $after = '' ) {
+	global $comment;
+	$url = get_comment_author_url();
+	$display = ($linktext != '') ? $linktext : $url;
+	$return = &quot;$before&lt;a href='$url' rel='external'&gt;$display&lt;/a&gt;$after&quot;;
+	return apply_filters('get_comment_author_url_link', $return);
+}
+
+function comment_author_url_link( $linktext = '', $before = '', $after = '' ) {
+	echo get_comment_author_url_link( $linktext, $before, $after );
+}
+
+function get_comment_author_IP() {
+	global $comment;
+	return apply_filters('get_comment_author_IP', $comment-&gt;comment_author_IP);
+}
+
+function comment_author_IP() {
+	echo get_comment_author_IP();
+}
+
+function get_comment_text() {
+	global $comment;
+	return apply_filters('get_comment_text', $comment-&gt;comment_content);
+}
+
+function comment_text() {
+	echo apply_filters('comment_text', get_comment_text() );
+}
+
+function get_comment_excerpt() {
+	global $comment;
+	$comment_text = strip_tags($comment-&gt;comment_content);
+	$blah = explode(' ', $comment_text);
+	if (count($blah) &gt; 20) {
+		$k = 20;
+		$use_dotdotdot = 1;
+	} else {
+		$k = count($blah);
+		$use_dotdotdot = 0;
+	}
+	$excerpt = '';
+	for ($i=0; $i&lt;$k; $i++) {
+		$excerpt .= $blah[$i] . ' ';
+	}
+	$excerpt .= ($use_dotdotdot) ? '...' : '';
+	return apply_filters('get_comment_excerpt', $excerpt);
+}
+
+function comment_excerpt() {
+	echo apply_filters('comment_excerpt', get_comment_excerpt() );
+}
+
+function get_comment_date( $d = '' ) {
+	global $comment;
+	if ( '' == $d )
+		$date = mysql2date( get_settings('date_format'), $comment-&gt;comment_date);
+	else
+		$date = mysql2date($d, $comment-&gt;comment_date);
+	return apply_filters('get_comment_date', $date);
+}
+
+function comment_date( $d = '' ) {
+	echo get_comment_date( $d );
+}
+
+function get_comment_time( $d = '', $gmt = false ) {
+	global $comment;
+	$comment_date = $gmt? $comment-&gt;comment_date_gmt : $comment-&gt;comment_date;
+	if ( '' == $d )
+		$date = mysql2date(get_settings('time_format'), $comment_date);
+	else
+		$date = mysql2date($d, $comment_date);
+	return apply_filters('get_comment_time', $date);
+}
+
+function comment_time( $d = '' ) {
+	echo get_comment_time($d);
+}
+
+function get_trackback_url() {
+	global $id;
+	$tb_url = get_settings('siteurl') . '/wp-trackback.php?p=' . $id;
+
+	if ( '' != get_settings('permalink_structure') )
+		$tb_url = trailingslashit(get_permalink()) . 'trackback/';
+
+	return $tb_url;
+}
+function trackback_url( $display = true ) {
+	if ( $display)
+		echo get_trackback_url();
+	else
+		return get_trackback_url();
+}
+
+function trackback_rdf($timezone = 0) {
+	global $id;
+	if (!stristr($_SERVER['HTTP_USER_AGENT'], 'W3C_Validator')) {
+	echo '&lt;rdf:RDF xmlns:rdf=&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#">http://www.w3.org/1999/02/22-rdf-syntax-ns#</A>&quot; 
+	    xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+	    xmlns:trackback=&quot;<A HREF="http://madskills.com/public/xml/rss/module/trackback/">http://madskills.com/public/xml/rss/module/trackback/</A>&quot;&gt;
+		&lt;rdf:Description rdf:about=&quot;';
+	the_permalink();
+	echo '&quot;'.&quot;\n&quot;;
+	echo '    dc:identifier=&quot;';
+	the_permalink();
+	echo '&quot;'.&quot;\n&quot;;
+	echo '    dc:title=&quot;'.str_replace('--', '&amp;#x2d;&amp;#x2d;', wptexturize(strip_tags(get_the_title()))).'&quot;'.&quot;\n&quot;;
+	echo '    trackback:ping=&quot;'.trackback_url(0).'&quot;'.&quot; /&gt;\n&quot;;
+	echo '&lt;/rdf:RDF&gt;';
+	}
+}
+
+function comments_open() {
+	global $post;
+	if ( 'open' == $post-&gt;comment_status )
+		return true;
+	else
+		return false;
+}
+
+function pings_open() {
+	global $post;
+	if ( 'open' == $post-&gt;ping_status ) 
+		return true;
+	else
+		return false;
+}
+
+// Non-template functions
+
+function get_lastcommentmodified($timezone = 'server') {
+	global $cache_lastcommentmodified, $pagenow, $wpdb;
+	$add_seconds_blog = get_settings('gmt_offset') * 3600;
+	$add_seconds_server = date('Z');
+	$now = current_time('mysql', 1);
+	if ( !isset($cache_lastcommentmodified[$timezone]) ) {
+		switch(strtolower($timezone)) {
+			case 'gmt':
+				$lastcommentmodified = $wpdb-&gt;get_var(&quot;SELECT comment_date_gmt FROM $wpdb-&gt;comments WHERE comment_date_gmt &lt;= '$now' ORDER BY comment_date_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'blog':
+				$lastcommentmodified = $wpdb-&gt;get_var(&quot;SELECT comment_date FROM $wpdb-&gt;comments WHERE comment_date_gmt &lt;= '$now' ORDER BY comment_date_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'server':
+				$lastcommentmodified = $wpdb-&gt;get_var(&quot;SELECT DATE_ADD(comment_date_gmt, INTERVAL '$add_seconds_server' SECOND) FROM $wpdb-&gt;comments WHERE comment_date_gmt &lt;= '$now' ORDER BY comment_date_gmt DESC LIMIT 1&quot;);
+				break;
+		}
+		$cache_lastcommentmodified[$timezone] = $lastcommentmodified;
+	} else {
+		$lastcommentmodified = $cache_lastcommentmodified[$timezone];
+	}
+	return $lastcommentmodified;
+}
+
+function get_commentdata( $comment_ID, $no_cache = 0, $include_unapproved = false ) { // less flexible, but saves DB queries
+	global $postc, $id, $commentdata, $wpdb;
+	if ($no_cache) {
+		$query = &quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_ID = '$comment_ID'&quot;;
+		if (false == $include_unapproved) {
+		    $query .= &quot; AND comment_approved = '1'&quot;;
+		}
+    		$myrow = $wpdb-&gt;get_row($query, ARRAY_A);
+	} else {
+		$myrow['comment_ID'] = $postc-&gt;comment_ID;
+		$myrow['comment_post_ID'] = $postc-&gt;comment_post_ID;
+		$myrow['comment_author'] = $postc-&gt;comment_author;
+		$myrow['comment_author_email'] = $postc-&gt;comment_author_email;
+		$myrow['comment_author_url'] = $postc-&gt;comment_author_url;
+		$myrow['comment_author_IP'] = $postc-&gt;comment_author_IP;
+		$myrow['comment_date'] = $postc-&gt;comment_date;
+		$myrow['comment_content'] = $postc-&gt;comment_content;
+		$myrow['comment_karma'] = $postc-&gt;comment_karma;
+		$myrow['comment_approved'] = $postc-&gt;comment_approved;
+		$myrow['comment_type'] = $postc-&gt;comment_type;
+	}
+	return $myrow;
+}
+
+function pingback($content, $post_ID) {
+	global $wp_version, $wpdb;
+	include_once (ABSPATH . WPINC . '/class-IXR.php');
+
+	// original code by Mort (<A HREF="http://mort.mine.nu:8080">http://mort.mine.nu:8080</A>)
+	$log = debug_fopen(ABSPATH . '/pingback.log', 'a');
+	$post_links = array();
+	debug_fwrite($log, 'BEGIN '.date('YmdHis', time()).&quot;\n&quot;);
+
+	$pung = get_pung($post_ID);
+
+	// Variables
+	$ltrs = '\w';
+	$gunk = '/#~:.?+=&amp;%@!\-';
+	$punc = '.:?\-';
+	$any = $ltrs . $gunk . $punc;
+
+	// Step 1
+	// Parsing the post, external links (if any) are stored in the $post_links array
+	// This regexp comes straight from phpfreaks.com
+	// <A HREF="http://www.phpfreaks.com/quickcode/Extract_All_URLs_on_a_Page/15.php">http://www.phpfreaks.com/quickcode/Extract_All_URLs_on_a_Page/15.php</A>
+	preg_match_all(&quot;{\b http : [$any] +? (?= [$punc] * [^$any] | $)}x&quot;, $content, $post_links_temp);
+
+	// Debug
+	debug_fwrite($log, 'Post contents:');
+	debug_fwrite($log, $content.&quot;\n&quot;);
+	
+	// Step 2.
+	// Walking thru the links array
+	// first we get rid of links pointing to sites, not to specific files
+	// Example:
+	// <A HREF="http://dummy-weblog.org">http://dummy-weblog.org</A>
+	// <A HREF="http://dummy-weblog.org/">http://dummy-weblog.org/</A>
+	// <A HREF="http://dummy-weblog.org/post.php">http://dummy-weblog.org/post.php</A>
+	// We don't wanna ping first and second types, even if they have a valid &lt;link/&gt;
+
+	foreach($post_links_temp[0] as $link_test) :
+		if ( !in_array($link_test, $pung) ) : // If we haven't pung it already
+			$test = parse_url($link_test);
+			if (isset($test['query']))
+				$post_links[] = $link_test;
+			elseif(($test['path'] != '/') &amp;&amp; ($test['path'] != ''))
+				$post_links[] = $link_test;
+		endif;
+	endforeach;
+
+	foreach ($post_links as $pagelinkedto){
+		debug_fwrite($log, &quot;Processing -- $pagelinkedto\n&quot;);
+		$pingback_server_url = discover_pingback_server_uri($pagelinkedto, 2048);
+
+		if ($pingback_server_url) {
+                        set_time_limit( 60 ); 
+			 // Now, the RPC call
+			debug_fwrite($log, &quot;Page Linked To: $pagelinkedto \n&quot;);
+			debug_fwrite($log, 'Page Linked From: ');
+			$pagelinkedfrom = get_permalink($post_ID);
+			debug_fwrite($log, $pagelinkedfrom.&quot;\n&quot;);
+
+			// using a timeout of 3 seconds should be enough to cover slow servers
+			$client = new IXR_Client($pingback_server_url);
+			$client-&gt;timeout = 3;
+			$client-&gt;useragent .= ' -- WordPress/' . $wp_version;
+
+			// when set to true, this outputs debug messages by itself
+			$client-&gt;debug = false;
+			
+			if ( $client-&gt;query('pingback.ping', array($pagelinkedfrom, $pagelinkedto) ) )
+				add_ping( $post_ID, $pagelinkedto );
+			else
+				debug_fwrite($log, &quot;Error.\n Fault code: &quot;.$client-&gt;getErrorCode().&quot; : &quot;.$client-&gt;getErrorMessage().&quot;\n&quot;);
+		}
+	}
+
+	debug_fwrite($log, &quot;\nEND: &quot;.time().&quot;\n****************************\n&quot;);
+	debug_fclose($log);
+}
+
+function discover_pingback_server_uri($url, $timeout_bytes = 2048) {
+	global $wp_version;
+
+	$byte_count = 0;
+	$contents = '';
+	$headers = '';
+	$pingback_str_dquote = 'rel=&quot;pingback&quot;';
+	$pingback_str_squote = 'rel=\'pingback\'';
+	$x_pingback_str = 'x-pingback: ';
+	$pingback_href_original_pos = 27;
+
+	extract(parse_url($url));
+
+	if (!isset($host)) {
+		// Not an URL. This should never happen.
+		return false;
+	}
+
+	$path  = (!isset($path)) ? '/'        : $path;
+	$path .= (isset($query)) ? '?'.$query : '';
+	$port  = (isset($port))  ? $port      : 80;
+
+	// Try to connect to the server at $host
+	$fp = @fsockopen($host, $port, $errno, $errstr, 2);
+	if (!$fp) {
+		// Couldn't open a connection to $host;
+		return false;
+	}
+
+	// Send the GET request
+	$request = &quot;GET $path HTTP/1.1\r\nHost: $host\r\nUser-Agent: WordPress/$wp_version PHP/&quot; . phpversion() . &quot;\r\n\r\n&quot;;
+	ob_end_flush();
+	fputs($fp, $request);
+
+	// Let's check for an X-Pingback header first
+	while (!feof($fp)) {
+		$line = fgets($fp, 512);
+		if (trim($line) == '') {
+			break;
+		}
+		$headers .= trim($line).&quot;\n&quot;;
+		$x_pingback_header_offset = strpos(strtolower($headers), $x_pingback_str);
+		if ($x_pingback_header_offset) {
+			// We got it!
+			preg_match('#x-pingback: (.+)#is', $headers, $matches);
+			$pingback_server_url = trim($matches[1]);
+			return $pingback_server_url;
+		}
+		if(strpos(strtolower($headers), 'content-type: ')) {
+			preg_match('#content-type: (.+)#is', $headers, $matches);
+			$content_type = trim($matches[1]);
+		}
+	}
+
+	if (preg_match('#(image|audio|video|model)/#is', $content_type)) {
+		// Not an (x)html, sgml, or xml page, no use going further
+		return false;
+	}
+
+	while (!feof($fp)) {
+		$line = fgets($fp, 1024);
+		$contents .= trim($line);
+		$pingback_link_offset_dquote = strpos($contents, $pingback_str_dquote);
+		$pingback_link_offset_squote = strpos($contents, $pingback_str_squote);
+		if ($pingback_link_offset_dquote || $pingback_link_offset_squote) {
+			$quote = ($pingback_link_offset_dquote) ? '&quot;' : '\'';
+			$pingback_link_offset = ($quote=='&quot;') ? $pingback_link_offset_dquote : $pingback_link_offset_squote;
+			$pingback_href_pos = @strpos($contents, 'href=', $pingback_link_offset);
+			$pingback_href_start = $pingback_href_pos+6;
+			$pingback_href_end = @strpos($contents, $quote, $pingback_href_start);
+			$pingback_server_url_len = $pingback_href_end - $pingback_href_start;
+			$pingback_server_url = substr($contents, $pingback_href_start, $pingback_server_url_len);
+			// We may find rel=&quot;pingback&quot; but an incomplete pingback URI
+			if ($pingback_server_url_len &gt; 0) {
+				// We got it!
+				return $pingback_server_url;
+			}
+		}
+		$byte_count += strlen($line);
+		if ($byte_count &gt; $timeout_bytes) {
+			// It's no use going further, there probably isn't any pingback
+			// server to find in this file. (Prevents loading large files.)
+			return false;
+		}
+	}
+
+	// We didn't find anything.
+	return false;
+}
+
+
+function wp_set_comment_status($comment_id, $comment_status) {
+    global $wpdb;
+
+    switch($comment_status) {
+		case 'hold':
+			$query = &quot;UPDATE $wpdb-&gt;comments SET comment_approved='0' WHERE comment_ID='$comment_id' LIMIT 1&quot;;
+		break;
+		case 'approve':
+			$query = &quot;UPDATE $wpdb-&gt;comments SET comment_approved='1' WHERE comment_ID='$comment_id' LIMIT 1&quot;;
+		break;
+ 		case 'spam':
+ 			$query = &quot;UPDATE $wpdb-&gt;comments SET comment_approved='spam' WHERE comment_ID='$comment_id' LIMIT 1&quot;;
+ 		break;
+		case 'delete':
+			$query = &quot;DELETE FROM $wpdb-&gt;comments WHERE comment_ID='$comment_id' LIMIT 1&quot;;
+		break;
+		default:
+			return false;
+    }
+    
+    if ($wpdb-&gt;query($query)) {
+		do_action('wp_set_comment_status', $comment_id, $comment_status);
+		return true;
+    } else {
+		return false;
+    }
+}
+
+
+function wp_get_comment_status($comment_id) {
+	global $wpdb;
+	
+	$result = $wpdb-&gt;get_var(&quot;SELECT comment_approved FROM $wpdb-&gt;comments WHERE comment_ID='$comment_id' LIMIT 1&quot;);
+	if ($result == NULL) {
+		return 'deleted';
+	} else if ($result == '1') {
+		return 'approved';
+	} else if ($result == '0') {
+		return 'unapproved';
+	} else if ($result == 'spam') {
+		return 'spam';
+	} else {
+		return false;
+	}
+}
+
+function check_comment($author, $email, $url, $comment, $user_ip, $user_agent, $comment_type) {
+	global $wpdb;
+
+	if (1 == get_settings('comment_moderation')) return false; // If moderation is set to manual
+
+	if ( (count(explode('http:', $comment)) - 1) &gt;= get_settings('comment_max_links') )
+		return false; // Check # of external links
+
+	$mod_keys = trim( get_settings('moderation_keys') );
+	if ( !empty($mod_keys) ) {
+		$words = explode(&quot;\n&quot;, $mod_keys );
+
+		foreach ($words as $word) {
+			$word = trim($word);
+
+			// Skip empty lines
+			if (empty($word)) { continue; }
+
+			// Do some escaping magic so that '#' chars in the 
+			// spam words don't break things:
+			$word = preg_quote($word, '#');
+		
+			$pattern = &quot;#$word#i&quot;; 
+			if ( preg_match($pattern, $author) ) return false;
+			if ( preg_match($pattern, $email) ) return false;
+			if ( preg_match($pattern, $url) ) return false;
+			if ( preg_match($pattern, $comment) ) return false;
+			if ( preg_match($pattern, $user_ip) ) return false;
+			if ( preg_match($pattern, $user_agent) ) return false;
+		}
+	}
+
+	// Comment whitelisting:
+	if ( 1 == get_settings('comment_whitelist')) {
+		if ( 'trackback' == $comment_type || 'pingback' == $comment_type ) { // check if domain is in blogroll
+			$uri = parse_url($url);
+			$domain = $uri['host'];
+			$uri = parse_url( get_option('home') );
+			$home_domain = $uri['host'];
+			if ( $wpdb-&gt;get_var(&quot;SELECT link_id FROM $wpdb-&gt;links WHERE link_url LIKE ('%$domain%') LIMIT 1&quot;) || $domain == $home_domain )
+				return true;
+			else
+				return false;
+		} elseif( $author != '' &amp;&amp; $email != '' ) {
+			$ok_to_comment = $wpdb-&gt;get_var(&quot;SELECT comment_approved FROM $wpdb-&gt;comments WHERE comment_author = '$author' AND comment_author_email = '$email' and comment_approved = '1' LIMIT 1&quot;);
+			if ( 1 == $ok_to_comment &amp;&amp; false === strpos( $email, get_settings('moderation_keys')) )
+				return true;
+			else
+				return false;
+		} else {
+			return false;
+		}
+	}
+
+	return true;
+}
+
+?&gt;

Added: trunk/wp-includes/default-filters.php
===================================================================
--- trunk/wp-includes/default-filters.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/default-filters.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,88 @@
+&lt;?php
+
+// Some default filters
+add_filter('bloginfo','wp_specialchars');
+add_filter('category_description', 'wptexturize');
+add_filter('list_cats', 'wptexturize');
+add_filter('comment_author', 'wptexturize');
+add_filter('comment_text', 'wptexturize');
+add_filter('single_post_title', 'wptexturize');
+add_filter('the_title', 'wptexturize');
+add_filter('the_content', 'wptexturize');
+add_filter('the_excerpt', 'wptexturize');
+add_filter('bloginfo', 'wptexturize');
+
+// Comments, trackbacks, pingbacks
+add_filter('pre_comment_author_name', 'strip_tags');
+add_filter('pre_comment_author_name', 'trim');
+add_filter('pre_comment_author_name', 'wp_specialchars', 30);
+
+add_filter('pre_comment_author_email', 'trim');
+add_filter('pre_comment_author_email', 'sanitize_email');
+
+add_filter('pre_comment_author_url', 'strip_tags');
+add_filter('pre_comment_author_url', 'trim');
+add_filter('pre_comment_author_url', 'clean_url');
+
+add_filter('pre_comment_content', 'stripslashes', 1);
+add_filter('pre_comment_content', 'wp_filter_kses');
+add_filter('pre_comment_content', 'wp_rel_nofollow', 15);
+add_filter('pre_comment_content', 'balanceTags', 30);
+add_filter('pre_comment_content', 'addslashes', 50);
+
+add_filter('pre_comment_author_name', 'wp_filter_kses');
+add_filter('pre_comment_author_email', 'wp_filter_kses');
+add_filter('pre_comment_author_url', 'wp_filter_kses');
+
+// Default filters for these functions
+add_filter('comment_author', 'wptexturize');
+add_filter('comment_author', 'convert_chars');
+add_filter('comment_author', 'wp_specialchars');
+
+add_filter('comment_email', 'antispambot');
+
+add_filter('comment_url', 'clean_url');
+
+add_filter('comment_text', 'convert_chars');
+add_filter('comment_text', 'make_clickable');
+add_filter('comment_text', 'wpautop', 30);
+add_filter('comment_text', 'convert_smilies', 20);
+
+add_filter('comment_excerpt', 'convert_chars');
+
+// Places to balance tags on input
+add_filter('content_save_pre', 'balanceTags', 50);
+add_filter('excerpt_save_pre', 'balanceTags', 50);
+add_filter('comment_save_pre', 'balanceTags', 50);
+
+// Misc. title, content, and excerpt filters
+add_filter('the_title', 'convert_chars');
+add_filter('the_title', 'trim');
+
+add_filter('the_content', 'convert_smilies');
+add_filter('the_content', 'convert_chars');
+add_filter('the_content', 'wpautop');
+
+add_filter('the_excerpt', 'convert_smilies');
+add_filter('the_excerpt', 'convert_chars');
+add_filter('the_excerpt', 'wpautop');
+add_filter('get_the_excerpt', 'wp_trim_excerpt');
+
+add_filter('sanitize_title', 'sanitize_title_with_dashes');
+
+// RSS filters
+add_filter('the_title_rss', 'strip_tags');
+add_filter('the_title_rss', 'ent2ncr', 8);
+add_filter('the_content_rss', 'ent2ncr', 8);
+add_filter('the_excerpt_rss', 'convert_chars');
+add_filter('the_excerpt_rss', 'ent2ncr', 8);
+add_filter('comment_author_rss', 'ent2ncr', 8);
+add_filter('comment_text_rss', 'htmlspecialchars');
+add_filter('comment_text_rss', 'ent2ncr', 8);
+add_filter('bloginfo_rss', 'ent2ncr', 8);
+add_filter('the_author', 'ent2ncr', 8);
+
+// Actions
+add_action('publish_post', 'generic_ping');
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/feed-functions.php
===================================================================
--- trunk/wp-includes/feed-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/feed-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,158 @@
+&lt;?php
+
+function get_bloginfo_rss($show = '') {
+	$info = strip_tags(get_bloginfo($show));
+	return convert_chars($info);
+}
+
+function bloginfo_rss($show = '') {
+	echo get_bloginfo_rss($show);
+}
+
+function the_title_rss() {
+	$title = get_the_title();
+	$title = apply_filters('the_title', $title);
+	$title = apply_filters('the_title_rss', $title);
+	echo $title;
+}
+
+function the_content_rss($more_link_text='(more...)', $stripteaser=0, $more_file='', $cut = 0, $encode_html = 0) {
+	$content = get_the_content($more_link_text, $stripteaser, $more_file);
+	$content = apply_filters('the_content', $content);
+	if ($cut &amp;&amp; !$encode_html) {
+		$encode_html = 2;
+	}
+	if ($encode_html == 1) {
+		$content = wp_specialchars($content);
+		$cut = 0;
+	} elseif ($encode_html == 0) {
+		$content = make_url_footnote($content);
+	} elseif ($encode_html == 2) {
+		$content = strip_tags($content);
+	}
+	if ($cut) {
+		$blah = explode(' ', $content);
+		if (count($blah) &gt; $cut) {
+			$k = $cut;
+			$use_dotdotdot = 1;
+		} else {
+			$k = count($blah);
+			$use_dotdotdot = 0;
+		}
+		for ($i=0; $i&lt;$k; $i++) {
+			$excerpt .= $blah[$i].' ';
+		}
+		$excerpt .= ($use_dotdotdot) ? '...' : '';
+		$content = $excerpt;
+	}
+	$content = str_replace(']]&gt;', ']]&gt;', $content);
+	echo $content;
+}
+
+function the_excerpt_rss() {
+	$output = get_the_excerpt(true);
+	echo apply_filters('the_excerpt_rss', $output);
+}
+
+function permalink_single_rss($file = '') {
+    echo get_permalink();
+}
+
+function comment_link() {
+	echo get_comment_link();
+}
+
+function comment_author_rss() {
+	$author = apply_filters('comment_author_rss', get_comment_author() );
+	echo $author;
+}
+
+function comment_text_rss() {
+	$comment_text = get_comment_text();
+	$comment_text = apply_filters('comment_text_rss', $comment_text);
+	echo $comment_text;
+}
+
+function comments_rss_link($link_text = 'Comments RSS', $commentsrssfilename = '') {
+	$url = comments_rss($commentsrssfilename);
+	echo &quot;&lt;a href='$url'&gt;$link_text&lt;/a&gt;&quot;;
+}
+
+function comments_rss($commentsrssfilename = '') {
+	global $id;
+
+	if ('' != get_settings('permalink_structure'))
+		$url = trailingslashit( get_permalink() ) . 'feed/';
+	else
+		$url = get_settings('home') . &quot;/$commentsrssfilename?feed=rss2&amp;p=$id&quot;;
+
+	return apply_filters('post_comments_feed_link', $url);
+}
+
+function get_author_rss_link($echo = false, $author_id, $author_nicename) {
+       $auth_ID = $author_id;
+       $permalink_structure = get_settings('permalink_structure');
+
+       if ('' == $permalink_structure) {
+				 $link = get_settings('home') . '?feed=rss2&amp;author=' . $author_id;
+       } else {
+				 $link = get_author_link(0, $author_id, $author_nicename);
+				 $link = $link . &quot;feed/&quot;;
+       }
+			 
+			 $link = apply_filters('author_feed_link', $link);
+
+       if ($echo) echo $link;
+       return $link;
+}
+
+function get_category_rss_link($echo = false, $cat_ID, $category_nicename) {
+       $permalink_structure = get_settings('permalink_structure');
+
+       if ('' == $permalink_structure) {
+				 $link = get_settings('home') . '?feed=rss2&amp;cat=' . $cat_ID;
+       } else {
+				 $link = get_category_link($cat_ID);
+				 $link = $link . &quot;feed/&quot;;
+       }
+
+			 $link = apply_filters('category_feed_link', $link);
+
+       if ($echo) echo $link;
+       return $link;
+}
+
+function the_category_rss($type = 'rss') {
+    $categories = get_the_category();
+    $the_list = '';
+    foreach ($categories as $category) {
+        $category-&gt;cat_name = convert_chars($category-&gt;cat_name);
+        if ('rdf' == $type) {
+            $the_list .= &quot;\n\t&lt;dc:subject&gt;$category-&gt;cat_name&lt;/dc:subject&gt;&quot;;
+        } else {
+            $the_list .= &quot;\n\t&lt;category&gt;$category-&gt;cat_name&lt;/category&gt;&quot;;
+        }
+    }
+    echo apply_filters('the_category_rss', $the_list, $type);
+}
+
+function rss_enclosure() {
+	global $id, $post;
+	if (!empty($post-&gt;post_password) &amp;&amp; ($_COOKIE['wp-postpass_'.COOKIEHASH] != $post-&gt;post_password)) return;
+
+	$custom_fields = get_post_custom();
+	if( is_array( $custom_fields ) ) {
+		while( list( $key, $val ) = each( $custom_fields ) ) { 
+			if( $key == 'enclosure' ) {
+				if (is_array($val)) {
+					foreach($val as $enc) {
+						$enclosure = split( &quot;\n&quot;, $enc );
+						print &quot;&lt;enclosure url='&quot;.trim( htmlspecialchars($enclosure[ 0 ]) ).&quot;' length='&quot;.trim( $enclosure[ 1 ] ).&quot;' type='&quot;.trim( $enclosure[ 2 ] ).&quot;'/&gt;\n&quot;;
+					}
+				}
+			}
+		}
+	}
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/functions-compat.php
===================================================================
--- trunk/wp-includes/functions-compat.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/functions-compat.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,92 @@
+&lt;?php
+
+/* Functions missing from older PHP versions */
+
+
+/* Added in PHP 4.2.0 */
+
+if (!function_exists('floatval')) {
+	function floatval($string) {
+		return ((float) $string);
+	}
+}
+
+if (!function_exists('is_a')) {
+	function is_a($object, $class) {
+		// by Aidan Lister &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">aidan at php.net</A>&gt;
+		if (get_class($object) == strtolower($class)) {
+			return true;
+		} else {
+			return is_subclass_of($object, $class);
+		}
+	}
+}
+
+if (!function_exists('ob_clean')) {
+	function ob_clean() {
+		// by Aidan Lister &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">aidan at php.net</A>&gt;
+		if (@ob_end_clean()) {
+			return ob_start();
+		}
+		return false;
+	}
+}
+
+
+/* Added in PHP 4.3.0 */
+
+function printr($var, $do_not_echo = false) {
+	// from php.net/print_r user contributed notes 
+	ob_start();
+	print_r($var);
+	$code =  htmlentities(ob_get_contents());
+	ob_clean();
+	if (!$do_not_echo) {
+	  echo &quot;&lt;pre&gt;$code&lt;/pre&gt;&quot;;
+	}
+	return $code;
+}
+
+if (!defined('CASE_LOWER')) {
+    define('CASE_LOWER', 0);
+}
+
+if (!defined('CASE_UPPER')) {
+    define('CASE_UPPER', 1);
+}
+
+
+/**
+ * Replace array_change_key_case()
+ *
+ * @category    PHP
+ * @package     PHP_Compat
+ * @link        <A HREF="http://php.net/function.array_change_key_case">http://php.net/function.array_change_key_case</A>
+ * @author      Stephan Schmidt &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">schst at php.net</A>&gt;
+ * @author      Aidan Lister &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">aidan at php.net</A>&gt;
+ * @version     $Revision: 2247 $
+ * @since       PHP 4.2.0
+ * @require     PHP 4.0.0 (user_error)
+ */
+if (!function_exists('array_change_key_case')) {
+    function array_change_key_case($input, $case = CASE_LOWER)
+    {
+        if (!is_array($input)) {
+            user_error('array_change_key_case(): The argument should be an array',
+                E_USER_WARNING);
+            return false;
+        }
+
+        $output   = array ();
+        $keys     = array_keys($input);
+        $casefunc = ($case == CASE_LOWER) ? 'strtolower' : 'strtoupper';
+
+        foreach ($keys as $key) {
+            $output[$casefunc($key)] = $input[$key];
+        }
+
+        return $output;
+    }
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/functions-formatting.php
===================================================================
--- trunk/wp-includes/functions-formatting.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/functions-formatting.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,993 @@
+&lt;?php
+
+function wptexturize($text) {
+	$output = '';
+	// Capture tags and everything inside them
+	$textarr = preg_split(&quot;/(&lt;.*&gt;)/Us&quot;, $text, -1, PREG_SPLIT_DELIM_CAPTURE);
+	$stop = count($textarr); $next = true; // loop stuff
+	for ($i = 0; $i &lt; $stop; $i++) {
+		$curl = $textarr[$i];
+
+		if (isset($curl{0}) &amp;&amp; '&lt;' != $curl{0} &amp;&amp; $next) { // If it's not a tag
+			$curl = str_replace('---', '&#8212;', $curl);
+			$curl = str_replace(' -- ', ' &#8212; ', $curl);
+			$curl = str_replace('--', '&#8211;', $curl);
+			$curl = str_replace('xn&#8211;', 'xn--', $curl);
+			$curl = str_replace('...', '&#8230;', $curl);
+			$curl = str_replace('``', '&#8220;', $curl);
+
+			// This is a hack, look at this more later. It works pretty well though.
+			$cockney = array(&quot;'tain't&quot;,&quot;'twere&quot;,&quot;'twas&quot;,&quot;'tis&quot;,&quot;'twill&quot;,&quot;'til&quot;,&quot;'bout&quot;,&quot;'nuff&quot;,&quot;'round&quot;,&quot;'cause&quot;);
+			$cockneyreplace = array(&quot;&#8217;tain&#8217;t&quot;,&quot;&#8217;twere&quot;,&quot;&#8217;twas&quot;,&quot;&#8217;tis&quot;,&quot;&#8217;twill&quot;,&quot;&#8217;til&quot;,&quot;&#8217;bout&quot;,&quot;&#8217;nuff&quot;,&quot;&#8217;round&quot;,&quot;&#8217;cause&quot;);
+			$curl = str_replace($cockney, $cockneyreplace, $curl);
+
+			$curl = preg_replace(&quot;/'s/&quot;, '&#8217;s', $curl);
+			$curl = preg_replace(&quot;/'(\d\d(?:&#8217;|')?s)/&quot;, &quot;&#8217;$1&quot;, $curl);
+			$curl = preg_replace('/(\s|\A|&quot;)\'/', '$1&#8216;', $curl);
+			$curl = preg_replace('/(\d+)&quot;/', '$1&#8243;', $curl);
+			$curl = preg_replace(&quot;/(\d+)'/&quot;, '$1&#8242;', $curl);
+			$curl = preg_replace(&quot;/(\S)'([^'\s])/&quot;, &quot;$1&#8217;$2&quot;, $curl);
+			$curl = preg_replace('/(\s|\A)&quot;(?!\s)/', '$1&#8220;$2', $curl);
+			$curl = preg_replace('/&quot;(\s|\S|\Z)/', '&#8221;$1', $curl);
+			$curl = preg_replace(&quot;/'([\s.]|\Z)/&quot;, '&#8217;$1', $curl);
+			$curl = preg_replace(&quot;/ \(tm\)/i&quot;, ' &#8482;', $curl);
+			$curl = str_replace(&quot;''&quot;, '&#8221;', $curl);
+			
+			$curl = preg_replace('/(\d+)x(\d+)/', &quot;$1&#215;$2&quot;, $curl);
+
+		} elseif (strstr($curl, '&lt;code') || strstr($curl, '&lt;pre') || strstr($curl, '&lt;kbd' || strstr($curl, '&lt;style') || strstr($curl, '&lt;script'))) {
+			// strstr is fast
+			$next = false;
+		} else {
+			$next = true;
+		}
+		$curl = preg_replace('/&amp;([^#])(?![a-z12]{1,8};)/', '&#038;$1', $curl);
+		$output .= $curl;
+	}
+	return $output;
+}
+
+function clean_pre($text) {
+	$text = str_replace('&lt;br /&gt;', '', $text);
+	$text = str_replace('&lt;p&gt;', &quot;\n&quot;, $text);
+	$text = str_replace('&lt;/p&gt;', '', $text);
+	return $text;
+}
+
+function wpautop($pee, $br = 1) {
+	$pee = $pee . &quot;\n&quot;; // just to make things a little easier, pad the end
+	$pee = preg_replace('|&lt;br /&gt;\s*&lt;br /&gt;|', &quot;\n\n&quot;, $pee);
+	// Space things out a little
+	$pee = preg_replace('!(&lt;(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|p|h[1-6])[^&gt;]*&gt;)!', &quot;\n$1&quot;, $pee); 
+	$pee = preg_replace('!(&lt;/(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|p|h[1-6])&gt;)!', &quot;$1\n&quot;, $pee);
+	$pee = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $pee); // cross-platform newlines 
+	$pee = preg_replace(&quot;/\n\n+/&quot;, &quot;\n\n&quot;, $pee); // take care of duplicates
+	$pee = preg_replace('/\n?(.+?)(?:\n\s*\n|\z)/s', &quot;\t&lt;p&gt;$1&lt;/p&gt;\n&quot;, $pee); // make paragraphs, including one at the end 
+	$pee = preg_replace('|&lt;p&gt;\s*?&lt;/p&gt;|', '', $pee); // under certain strange conditions it could create a P of entirely whitespace 
+    $pee = preg_replace('!&lt;p&gt;\s*(&lt;/?(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|hr|pre|select|form|blockquote|address|math|p|h[1-6])[^&gt;]*&gt;)\s*&lt;/p&gt;!', &quot;$1&quot;, $pee); // don't pee all over a tag
+	$pee = preg_replace(&quot;|&lt;p&gt;(&lt;li.+?)&lt;/p&gt;|&quot;, &quot;$1&quot;, $pee); // problem with nested lists
+	$pee = preg_replace('|&lt;p&gt;&lt;blockquote([^&gt;]*)&gt;|i', &quot;&lt;blockquote$1&gt;&lt;p&gt;&quot;, $pee);
+	$pee = str_replace('&lt;/blockquote&gt;&lt;/p&gt;', '&lt;/p&gt;&lt;/blockquote&gt;', $pee);
+	$pee = preg_replace('!&lt;p&gt;\s*(&lt;/?(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|hr|pre|select|form|blockquote|address|math|p|h[1-6])[^&gt;]*&gt;)!', &quot;$1&quot;, $pee);
+	$pee = preg_replace('!(&lt;/?(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|p|h[1-6])[^&gt;]*&gt;)\s*&lt;/p&gt;!', &quot;$1&quot;, $pee); 
+	if ($br) $pee = preg_replace('|(?&lt;!&lt;br /&gt;)\s*\n|', &quot;&lt;br /&gt;\n&quot;, $pee); // optionally make line breaks
+	$pee = preg_replace('!(&lt;/?(?:table|thead|tfoot|caption|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|p|h[1-6])[^&gt;]*&gt;)\s*&lt;br /&gt;!', &quot;$1&quot;, $pee);
+	$pee = preg_replace('!&lt;br /&gt;(\s*&lt;/?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)&gt;)!', '$1', $pee);
+	$pee = preg_replace('!(&lt;pre.*?&gt;)(.*?)&lt;/pre&gt;!ise', &quot; stripslashes('$1') .  clean_pre('$2')  . '&lt;/pre&gt;' &quot;, $pee);
+	
+	return $pee; 
+}
+
+
+function seems_utf8($Str) { # by bmorel at ssi dot fr
+	for ($i=0; $i&lt;strlen($Str); $i++) {
+		if (ord($Str[$i]) &lt; 0x80) continue; # 0bbbbbbb
+		elseif ((ord($Str[$i]) &amp; 0xE0) == 0xC0) $n=1; # 110bbbbb
+		elseif ((ord($Str[$i]) &amp; 0xF0) == 0xE0) $n=2; # 1110bbbb
+		elseif ((ord($Str[$i]) &amp; 0xF8) == 0xF0) $n=3; # 11110bbb
+		elseif ((ord($Str[$i]) &amp; 0xFC) == 0xF8) $n=4; # 111110bb
+		elseif ((ord($Str[$i]) &amp; 0xFE) == 0xFC) $n=5; # 1111110b
+		else return false; # Does not match any model
+		for ($j=0; $j&lt;$n; $j++) { # n bytes matching 10bbbbbb follow ?
+			if ((++$i == strlen($Str)) || ((ord($Str[$i]) &amp; 0xC0) != 0x80))
+			return false;
+		}
+	}
+	return true;
+}
+
+function wp_specialchars( $text, $quotes = 0 ) {
+	// Like htmlspecialchars except don't double-encode HTML entities
+	$text = preg_replace('/&amp;([^#])(?![a-z12]{1,8};)/', '&#038;$1', $text);-
+	$text = str_replace('&lt;', '&lt;', $text);
+	$text = str_replace('&gt;', '&gt;', $text);
+	if ( $quotes ) {
+		$text = str_replace('&quot;', '&quot;', $text);
+		$text = str_replace(&quot;'&quot;, '&#039;', $text);
+	}
+	return $text;
+}
+
+function utf8_uri_encode( $utf8_string ) {
+  $unicode = '';        
+  $values = array();
+  $num_octets = 1;
+        
+  for ($i = 0; $i &lt; strlen( $utf8_string ); $i++ ) {
+
+    $value = ord( $utf8_string[ $i ] );
+            
+    if ( $value &lt; 128 ) {
+      $unicode .= chr($value);
+    } else {
+      if ( count( $values ) == 0 ) $num_octets = ( $value &lt; 224 ) ? 2 : 3;
+                
+      $values[] = $value;
+      
+      if ( count( $values ) == $num_octets ) {
+	if ($num_octets == 3) {
+	  $unicode .= '%' . dechex($values[0]) . '%' . dechex($values[1]) . '%' . dechex($values[2]);
+	} else {
+	  $unicode .= '%' . dechex($values[0]) . '%' . dechex($values[1]);
+	}
+
+	$values = array();
+	$num_octets = 1;
+      }
+    }
+  }
+
+  return $unicode;    
+}
+
+function remove_accents($string) {
+	if (seems_utf8($string)) {
+		$chars = array(
+		// Decompositions for Latin-1 Supplement
+		chr(195).chr(128) =&gt; 'A', chr(195).chr(129) =&gt; 'A',
+		chr(195).chr(130) =&gt; 'A', chr(195).chr(131) =&gt; 'A',
+		chr(195).chr(132) =&gt; 'A', chr(195).chr(133) =&gt; 'A',
+		chr(195).chr(135) =&gt; 'C', chr(195).chr(136) =&gt; 'E',
+		chr(195).chr(137) =&gt; 'E', chr(195).chr(138) =&gt; 'E',
+		chr(195).chr(139) =&gt; 'E', chr(195).chr(140) =&gt; 'I',
+		chr(195).chr(141) =&gt; 'I', chr(195).chr(142) =&gt; 'I',
+		chr(195).chr(143) =&gt; 'I', chr(195).chr(145) =&gt; 'N',
+		chr(195).chr(146) =&gt; 'O', chr(195).chr(147) =&gt; 'O',
+		chr(195).chr(148) =&gt; 'O', chr(195).chr(149) =&gt; 'O',
+		chr(195).chr(150) =&gt; 'O', chr(195).chr(153) =&gt; 'U',
+		chr(195).chr(154) =&gt; 'U', chr(195).chr(155) =&gt; 'U',
+		chr(195).chr(156) =&gt; 'U', chr(195).chr(157) =&gt; 'Y',
+		chr(195).chr(159) =&gt; 's', chr(195).chr(160) =&gt; 'a',
+		chr(195).chr(161) =&gt; 'a', chr(195).chr(162) =&gt; 'a',
+		chr(195).chr(163) =&gt; 'a', chr(195).chr(164) =&gt; 'a',
+		chr(195).chr(165) =&gt; 'a', chr(195).chr(167) =&gt; 'c',
+		chr(195).chr(168) =&gt; 'e', chr(195).chr(169) =&gt; 'e',
+		chr(195).chr(170) =&gt; 'e', chr(195).chr(171) =&gt; 'e',
+		chr(195).chr(172) =&gt; 'i', chr(195).chr(173) =&gt; 'i',
+		chr(195).chr(174) =&gt; 'i', chr(195).chr(175) =&gt; 'i',
+		chr(195).chr(177) =&gt; 'n', chr(195).chr(178) =&gt; 'o',
+		chr(195).chr(179) =&gt; 'o', chr(195).chr(180) =&gt; 'o',
+		chr(195).chr(181) =&gt; 'o', chr(195).chr(182) =&gt; 'o',
+		chr(195).chr(182) =&gt; 'o', chr(195).chr(185) =&gt; 'u',
+		chr(195).chr(186) =&gt; 'u', chr(195).chr(187) =&gt; 'u',
+		chr(195).chr(188) =&gt; 'u', chr(195).chr(189) =&gt; 'y',
+		chr(195).chr(191) =&gt; 'y',
+		// Decompositions for Latin Extended-A
+		chr(196).chr(128) =&gt; 'A', chr(196).chr(129) =&gt; 'a',
+		chr(196).chr(130) =&gt; 'A', chr(196).chr(131) =&gt; 'a',
+		chr(196).chr(132) =&gt; 'A', chr(196).chr(133) =&gt; 'a',
+		chr(196).chr(134) =&gt; 'C', chr(196).chr(134) =&gt; 'c',
+		chr(196).chr(136) =&gt; 'C', chr(196).chr(137) =&gt; 'c',
+		chr(196).chr(138) =&gt; 'C', chr(196).chr(139) =&gt; 'c',
+		chr(196).chr(140) =&gt; 'C', chr(196).chr(141) =&gt; 'c',
+		chr(196).chr(142) =&gt; 'D', chr(196).chr(143) =&gt; 'd',
+		chr(196).chr(144) =&gt; 'D', chr(196).chr(145) =&gt; 'd',
+		chr(196).chr(146) =&gt; 'E', chr(196).chr(147) =&gt; 'e',
+		chr(196).chr(148) =&gt; 'E', chr(196).chr(149) =&gt; 'e',
+		chr(196).chr(150) =&gt; 'E', chr(196).chr(151) =&gt; 'e',
+		chr(196).chr(152) =&gt; 'E', chr(196).chr(153) =&gt; 'e',
+		chr(196).chr(154) =&gt; 'E', chr(196).chr(155) =&gt; 'e',
+		chr(196).chr(156) =&gt; 'G', chr(196).chr(157) =&gt; 'g',
+		chr(196).chr(158) =&gt; 'G', chr(196).chr(159) =&gt; 'g',
+		chr(196).chr(160) =&gt; 'G', chr(196).chr(161) =&gt; 'g',
+		chr(196).chr(162) =&gt; 'G', chr(196).chr(163) =&gt; 'g',
+		chr(196).chr(164) =&gt; 'H', chr(196).chr(165) =&gt; 'h',
+		chr(196).chr(166) =&gt; 'H', chr(196).chr(167) =&gt; 'h',
+		chr(196).chr(168) =&gt; 'I', chr(196).chr(169) =&gt; 'i',
+		chr(196).chr(170) =&gt; 'I', chr(196).chr(171) =&gt; 'i',
+		chr(196).chr(172) =&gt; 'I', chr(196).chr(173) =&gt; 'i',
+		chr(196).chr(174) =&gt; 'I', chr(196).chr(175) =&gt; 'i',
+		chr(196).chr(176) =&gt; 'I', chr(196).chr(177) =&gt; 'i',
+		chr(196).chr(178) =&gt; 'IJ',chr(196).chr(179) =&gt; 'ij',
+		chr(196).chr(180) =&gt; 'J', chr(196).chr(181) =&gt; 'j',
+		chr(196).chr(182) =&gt; 'K', chr(196).chr(183) =&gt; 'k',
+		chr(196).chr(184) =&gt; 'k', chr(196).chr(185) =&gt; 'L',
+		chr(196).chr(186) =&gt; 'l', chr(196).chr(187) =&gt; 'L',
+		chr(196).chr(188) =&gt; 'l', chr(196).chr(189) =&gt; 'L',
+		chr(196).chr(190) =&gt; 'l', chr(196).chr(191) =&gt; 'L',
+		chr(197).chr(128) =&gt; 'l', chr(196).chr(129) =&gt; 'L',
+		chr(197).chr(130) =&gt; 'l', chr(196).chr(131) =&gt; 'N',
+		chr(197).chr(132) =&gt; 'n', chr(196).chr(133) =&gt; 'N',
+		chr(197).chr(134) =&gt; 'n', chr(196).chr(135) =&gt; 'N',
+		chr(197).chr(136) =&gt; 'n', chr(196).chr(137) =&gt; 'N',
+		chr(197).chr(138) =&gt; 'n', chr(196).chr(139) =&gt; 'N',
+		chr(197).chr(140) =&gt; 'O', chr(196).chr(141) =&gt; 'o',
+		chr(197).chr(142) =&gt; 'O', chr(196).chr(143) =&gt; 'o',
+		chr(197).chr(144) =&gt; 'O', chr(196).chr(145) =&gt; 'o',
+		chr(197).chr(146) =&gt; 'OE',chr(197).chr(147) =&gt; 'oe',
+		chr(197).chr(148) =&gt; 'R',chr(197).chr(149) =&gt; 'r',
+		chr(197).chr(150) =&gt; 'R',chr(197).chr(151) =&gt; 'r',
+		chr(197).chr(152) =&gt; 'R',chr(197).chr(153) =&gt; 'r',
+		chr(197).chr(154) =&gt; 'S',chr(197).chr(155) =&gt; 's',
+		chr(197).chr(156) =&gt; 'S',chr(197).chr(157) =&gt; 's',
+		chr(197).chr(158) =&gt; 'S',chr(197).chr(159) =&gt; 's',
+		chr(197).chr(160) =&gt; 'S', chr(197).chr(161) =&gt; 's',
+		chr(197).chr(162) =&gt; 'T', chr(197).chr(163) =&gt; 't',
+		chr(197).chr(164) =&gt; 'T', chr(197).chr(165) =&gt; 't',
+		chr(197).chr(166) =&gt; 'T', chr(197).chr(167) =&gt; 't',
+		chr(197).chr(168) =&gt; 'U', chr(197).chr(169) =&gt; 'u',
+		chr(197).chr(170) =&gt; 'U', chr(197).chr(171) =&gt; 'u',
+		chr(197).chr(172) =&gt; 'U', chr(197).chr(173) =&gt; 'u',
+		chr(197).chr(174) =&gt; 'U', chr(197).chr(175) =&gt; 'u',
+		chr(197).chr(176) =&gt; 'U', chr(197).chr(177) =&gt; 'u',
+		chr(197).chr(178) =&gt; 'U', chr(197).chr(179) =&gt; 'u',
+		chr(197).chr(180) =&gt; 'W', chr(197).chr(181) =&gt; 'w',
+		chr(197).chr(182) =&gt; 'Y', chr(197).chr(183) =&gt; 'y',
+		chr(197).chr(184) =&gt; 'Y', chr(197).chr(185) =&gt; 'Z',
+		chr(197).chr(186) =&gt; 'z', chr(197).chr(187) =&gt; 'Z',
+		chr(197).chr(188) =&gt; 'z', chr(197).chr(189) =&gt; 'Z',
+		chr(197).chr(190) =&gt; 'z', chr(197).chr(191) =&gt; 's',
+		// Euro Sign
+		chr(226).chr(130).chr(172) =&gt; 'E');
+		
+		$string = strtr($string, $chars);
+	} else {
+		// Assume ISO-8859-1 if not UTF-8
+		$chars['in'] = chr(128).chr(131).chr(138).chr(142).chr(154).chr(158)
+			.chr(159).chr(162).chr(165).chr(181).chr(192).chr(193).chr(194)
+			.chr(195).chr(196).chr(197).chr(199).chr(200).chr(201).chr(202)
+			.chr(203).chr(204).chr(205).chr(206).chr(207).chr(209).chr(210)
+			.chr(211).chr(212).chr(213).chr(214).chr(216).chr(217).chr(218)
+			.chr(219).chr(220).chr(221).chr(224).chr(225).chr(226).chr(227)
+			.chr(228).chr(229).chr(231).chr(232).chr(233).chr(234).chr(235)
+			.chr(236).chr(237).chr(238).chr(239).chr(241).chr(242).chr(243)
+			.chr(244).chr(245).chr(246).chr(248).chr(249).chr(250).chr(251)
+			.chr(252).chr(253).chr(255);
+
+		$chars['out'] = &quot;EfSZszYcYuAAAAAACEEEEIIIINOOOOOOUUUUYaaaaaaceeeeiiiinoooooouuuuyy&quot;;
+
+		$string = strtr($string, $chars['in'], $chars['out']);
+		$double_chars['in'] = array(chr(140), chr(156), chr(198), chr(208), chr(222), chr(223), chr(230), chr(240), chr(254));
+		$double_chars['out'] = array('OE', 'oe', 'AE', 'DH', 'TH', 'ss', 'ae', 'dh', 'th');
+		$string = str_replace($double_chars['in'], $double_chars['out'], $string);
+	}
+
+	return $string;
+}
+
+function sanitize_title($title, $fallback_title = '') {
+	$title = strip_tags($title);
+	$title = apply_filters('sanitize_title', $title);
+
+	if (empty($title)) {
+		$title = $fallback_title;
+	}
+
+	return $title;
+}
+
+function sanitize_title_with_dashes($title) {
+	$title = strip_tags($title);
+	// Preserve escaped octets.
+	$title = preg_replace('|%([a-fA-F0-9][a-fA-F0-9])|', '---$1---', $title);
+	// Remove percent signs that are not part of an octet.
+	$title = str_replace('%', '', $title);
+	// Restore octets.
+	$title = preg_replace('|---([a-fA-F0-9][a-fA-F0-9])---|', '%$1', $title);
+
+	$title = remove_accents($title);
+	if (seems_utf8($title)) {
+		if (function_exists('mb_strtolower')) {
+			$title = mb_strtolower($title, 'UTF-8');
+		}
+		$title = utf8_uri_encode($title);
+	}
+
+	$title = strtolower($title);
+	$title = preg_replace('/&amp;.+?;/', '', $title); // kill entities
+	$title = preg_replace('/[^%a-z0-9 _-]/', '', $title);
+	$title = preg_replace('/\s+/', '-', $title);
+	$title = preg_replace('|-+|', '-', $title);
+	$title = trim($title, '-');
+
+	return $title;
+}
+
+function convert_chars($content, $flag = 'obsolete') { 
+	// Translation of invalid Unicode references range to valid range
+	$wp_htmltranswinuni = array(
+	'&#128;' =&gt; '&#8364;', // the Euro sign
+	'&#129;' =&gt; '',
+	'&#130;' =&gt; '&#8218;', // these are Windows CP1252 specific characters
+	'&#131;' =&gt; '&#402;',  // they would look weird on non-Windows browsers
+	'&#132;' =&gt; '&#8222;',
+	'&#133;' =&gt; '&#8230;',
+	'&#134;' =&gt; '&#8224;',
+	'&#135;' =&gt; '&#8225;',
+	'&#136;' =&gt; '&#710;',
+	'&#137;' =&gt; '&#8240;',
+	'&#138;' =&gt; '&#352;',
+	'&#139;' =&gt; '&#8249;',
+	'&#140;' =&gt; '&#338;',
+	'&#141;' =&gt; '',
+	'&#142;' =&gt; '&#382;',
+	'&#143;' =&gt; '',
+	'&#144;' =&gt; '',
+	'&#145;' =&gt; '&#8216;',
+	'&#146;' =&gt; '&#8217;',
+	'&#147;' =&gt; '&#8220;',
+	'&#148;' =&gt; '&#8221;',
+	'&#149;' =&gt; '&#8226;',
+	'&#150;' =&gt; '&#8211;',
+	'&#151;' =&gt; '&#8212;',
+	'&#152;' =&gt; '&#732;',
+	'&#153;' =&gt; '&#8482;',
+	'&#154;' =&gt; '&#353;',
+	'&#155;' =&gt; '&#8250;',
+	'&#156;' =&gt; '&#339;',
+	'&#157;' =&gt; '',
+	'&#158;' =&gt; '',
+	'&#159;' =&gt; '&#376;'
+	);
+
+	// Remove metadata tags
+	$content = preg_replace('/&lt;title&gt;(.+?)&lt;\/title&gt;/','',$content);
+	$content = preg_replace('/&lt;category&gt;(.+?)&lt;\/category&gt;/','',$content);
+
+	// Converts lone &amp; characters into &#38; (a.k.a. &amp;)
+	$content = preg_replace('/&amp;([^#])(?![a-z]{1,8};)/i', '&#038;$1', $content);
+
+	// Fix Word pasting
+	$content = strtr($content, $wp_htmltranswinuni);
+
+	// Just a little XHTML help
+	$content = str_replace('&lt;br&gt;', '&lt;br /&gt;', $content);
+	$content = str_replace('&lt;hr&gt;', '&lt;hr /&gt;', $content);
+
+	return $content;
+}
+
+function funky_javascript_fix($text) {
+	// Fixes for browsers' javascript bugs
+	global $is_macIE, $is_winIE;
+	
+	if ( $is_winIE || $is_macIE )
+		$text =  preg_replace(&quot;/\%u([0-9A-F]{4,4})/e&quot;,  &quot;'&amp;#'.base_convert('\\1',16,10).';'&quot;, $text);
+	
+	return $text;
+}
+
+/*
+ balanceTags
+ 
+ Balances Tags of string using a modified stack.
+ 
+ @param text      Text to be balanced
+ @return          Returns balanced text
+ @author          Leonard Lin (<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">leonard at acm.org</A>)
+ @version         v1.1
+ @date            November 4, 2001
+ @license         GPL v2.0
+ @notes           
+ @changelog       
+ ---  Modified by Scott Reilly (coffee2code) 02 Aug 2004
+             1.2  ***TODO*** Make better - change loop condition to $text
+             1.1  Fixed handling of append/stack pop order of end text
+                  Added Cleaning Hooks
+             1.0  First Version
+*/
+function balanceTags($text, $is_comment = 0) {
+	
+	if (get_settings('use_balanceTags') == 0) {
+		return $text;
+	}
+
+	$tagstack = array(); $stacksize = 0; $tagqueue = ''; $newtext = '';
+
+	# WP bug fix for comments - in case you REALLY meant to type '&lt; !--'
+	$text = str_replace('&lt; !--', '&lt;    !--', $text);
+	# WP bug fix for LOVE &lt;3 (and other situations with '&lt;' before a number)
+	$text = preg_replace('#&lt;([0-9]{1})#', '&lt;$1', $text);
+
+	while (preg_match(&quot;/&lt;(\/?\w*)\s*([^&gt;]*)&gt;/&quot;,$text,$regex)) {
+		$newtext .= $tagqueue;
+
+		$i = strpos($text,$regex[0]);
+		$l = strlen($regex[0]);
+
+		// clear the shifter
+		$tagqueue = '';
+		// Pop or Push
+		if ($regex[1][0] == &quot;/&quot;) { // End Tag
+			$tag = strtolower(substr($regex[1],1));
+			// if too many closing tags
+			if($stacksize &lt;= 0) { 
+				$tag = '';
+				//or close to be safe $tag = '/' . $tag;
+			}
+			// if stacktop value = tag close value then pop
+			else if ($tagstack[$stacksize - 1] == $tag) { // found closing tag
+				$tag = '&lt;/' . $tag . '&gt;'; // Close Tag
+				// Pop
+				array_pop ($tagstack);
+				$stacksize--;
+			} else { // closing tag not at top, search for it
+				for ($j=$stacksize-1;$j&gt;=0;$j--) {
+					if ($tagstack[$j] == $tag) {
+					// add tag to tagqueue
+						for ($k=$stacksize-1;$k&gt;=$j;$k--){
+							$tagqueue .= '&lt;/' . array_pop ($tagstack) . '&gt;';
+							$stacksize--;
+						}
+						break;
+					}
+				}
+				$tag = '';
+			}
+		} else { // Begin Tag
+			$tag = strtolower($regex[1]);
+
+			// Tag Cleaning
+
+			// If self-closing or '', don't do anything.
+			if((substr($regex[2],-1) == '/') || ($tag == '')) {
+			}
+			// ElseIf it's a known single-entity tag but it doesn't close itself, do so
+			elseif ($tag == 'br' || $tag == 'img' || $tag == 'hr' || $tag == 'input') {
+				$regex[2] .= '/';
+			} else {	// Push the tag onto the stack
+				// If the top of the stack is the same as the tag we want to push, close previous tag
+				if (($stacksize &gt; 0) &amp;&amp; ($tag != 'div') &amp;&amp; ($tagstack[$stacksize - 1] == $tag)) {
+					$tagqueue = '&lt;/' . array_pop ($tagstack) . '&gt;';
+					$stacksize--;
+				}
+				$stacksize = array_push ($tagstack, $tag);
+			}
+
+			// Attributes
+			$attributes = $regex[2];
+			if($attributes) {
+				$attributes = ' '.$attributes;
+			}
+			$tag = '&lt;'.$tag.$attributes.'&gt;';
+			//If already queuing a close tag, then put this tag on, too
+			if ($tagqueue) {
+				$tagqueue .= $tag;
+				$tag = '';
+			}
+		}
+		$newtext .= substr($text,0,$i) . $tag;
+		$text = substr($text,$i+$l);
+	}  
+
+	// Clear Tag Queue
+	$newtext .= $tagqueue;
+
+	// Add Remaining text
+	$newtext .= $text;
+
+	// Empty Stack
+	while($x = array_pop($tagstack)) {
+		$newtext .= '&lt;/' . $x . '&gt;'; // Add remaining tags to close
+	}
+
+	// WP fix for the bug with HTML comments
+	$newtext = str_replace(&quot;&lt; !--&quot;,&quot;&lt;!--&quot;,$newtext);
+	$newtext = str_replace(&quot;&lt;    !--&quot;,&quot;&lt; !--&quot;,$newtext);
+
+	return $newtext;
+}
+
+
+function format_to_edit($content) {
+	$content = apply_filters('format_to_edit', $content);
+	$content = htmlspecialchars($content);
+	return $content;
+}
+
+function format_to_post($content) {
+	global $wpdb;
+	$content = apply_filters('format_to_post', $content);
+	return $content;
+}
+
+function zeroise($number,$threshold) { // function to add leading zeros when necessary
+	return sprintf('%0'.$threshold.'s', $number);
+	}
+
+
+function backslashit($string) {
+	$string = preg_replace('/([a-z])/i', '\\\\\1', $string);
+	return $string;
+}
+
+function trailingslashit($string) {
+    if ( '/' != substr($string, -1)) {
+        $string .= '/';
+    }
+    return $string;
+}
+
+function addslashes_gpc($gpc) {
+	if (!get_magic_quotes_gpc()) {
+		$gpc = addslashes($gpc);
+	}
+	return $gpc;
+}
+
+function antispambot($emailaddy, $mailto=0) {
+	$emailNOSPAMaddy = '';
+	srand ((float) microtime() * 1000000);
+	for ($i = 0; $i &lt; strlen($emailaddy); $i = $i + 1) {
+		$j = floor(rand(0, 1+$mailto));
+		if ($j==0) {
+			$emailNOSPAMaddy .= '&amp;#'.ord(substr($emailaddy,$i,1)).';';
+		} elseif ($j==1) {
+			$emailNOSPAMaddy .= substr($emailaddy,$i,1);
+		} elseif ($j==2) {
+			$emailNOSPAMaddy .= '%'.zeroise(dechex(ord(substr($emailaddy, $i, 1))), 2);
+		}
+	}
+	$emailNOSPAMaddy = str_replace('@','&#64;',$emailNOSPAMaddy);
+	return $emailNOSPAMaddy;
+}
+
+function make_clickable($ret) {
+	$ret = ' ' . $ret . ' ';
+	$ret = preg_replace(&quot;#([\s&gt;])(https?)://([^\s&lt;&gt;{}()]+[^\s.,&lt;&gt;{}()])#i&quot;, &quot;$1&lt;a href='$2://$3' rel='nofollow'&gt;$2://$3&lt;/a&gt;&quot;, $ret);
+	$ret = preg_replace(&quot;#(\s)www\.([a-z0-9\-]+)\.([a-z0-9\-.\~]+)((?:/[^ &lt;&gt;{}()\n\r]*[^., &lt;&gt;{}()\n\r]?)?)#i&quot;, &quot;$1&lt;a href='<A HREF="http://www.$2.$3$4">http://www.$2.$3$4</A>' rel='nofollow'&gt;www.$2.$3$4&lt;/a&gt;&quot;, $ret);
+	$ret = preg_replace(&quot;#(\s)([a-z0-9\-_.]+)@([^,&lt; \n\r]+)#i&quot;, &quot;$1&lt;a href=\&quot;mailto:$2@$3\&quot;&gt;$2@$3&lt;/a&gt;&quot;, $ret);
+	$ret = trim($ret);
+	return $ret;
+}
+
+function wp_rel_nofollow( $text ) {
+	$text = preg_replace('|&lt;a (.+?)&gt;|i', '&lt;a $1 rel=&quot;nofollow&quot;&gt;', $text);
+	return $text;
+}
+
+function convert_smilies($text) {
+	global $wp_smiliessearch, $wp_smiliesreplace;
+    $output = '';
+	if (get_settings('use_smilies')) {
+		// HTML loop taken from texturize function, could possible be consolidated
+		$textarr = preg_split(&quot;/(&lt;.*&gt;)/U&quot;, $text, -1, PREG_SPLIT_DELIM_CAPTURE); // capture the tags as well as in between
+		$stop = count($textarr);// loop stuff
+		for ($i = 0; $i &lt; $stop; $i++) {
+			$content = $textarr[$i];
+			if ((strlen($content) &gt; 0) &amp;&amp; ('&lt;' != $content{0})) { // If it's not a tag
+				$content = str_replace($wp_smiliessearch, $wp_smiliesreplace, $content);
+			}
+			$output .= $content;
+		}
+	} else {
+		// return default text.
+		$output = $text;
+	}
+	return $output;
+}
+
+
+function is_email($user_email) {
+	$chars = &quot;/^([a-z0-9+_]|\\-|\\.)+@(([a-z0-9_]|\\-)+\\.)+[a-z]{2,6}\$/i&quot;;
+	if(strstr($user_email, '@') &amp;&amp; strstr($user_email, '.')) {
+		if (preg_match($chars, $user_email)) {
+			return true;
+		} else {
+			return false;
+		}
+	} else {
+		return false;
+	}
+}
+
+
+function strip_all_but_one_link($text, $mylink) {
+	$match_link = '#(&lt;a.+?href.+?'.'&gt;)(.+?)(&lt;/a&gt;)#';
+	preg_match_all($match_link, $text, $matches);
+	$count = count($matches[0]);
+	for ($i=0; $i&lt;$count; $i++) {
+		if (!strstr($matches[0][$i], $mylink)) {
+			$text = str_replace($matches[0][$i], $matches[2][$i], $text);
+		}
+	}
+	return $text;
+}
+
+
+// used by wp-mail to handle charsets in email subjects
+function wp_iso_descrambler($string) {
+  /* this may only work with iso-8859-1, I'm afraid */
+  if (!preg_match('#\=\?(.+)\?Q\?(.+)\?\=#i', $string, $matches)) {
+    return $string;
+  } else {
+    $subject = str_replace('_', ' ', $matches[2]);
+    $subject = preg_replace('#\=([0-9a-f]{2})#ei', &quot;chr(hexdec(strtolower('$1')))&quot;, $subject);
+    return $subject;
+  }
+}
+
+
+// give it a date, it will give you the same date as GMT
+function get_gmt_from_date($string) {
+  // note: this only substracts $time_difference from the given date
+  preg_match('#([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2}) ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})#', $string, $matches);
+  $string_time = gmmktime($matches[4], $matches[5], $matches[6], $matches[2], $matches[3], $matches[1]);
+  $string_gmt = gmdate('Y-m-d H:i:s', $string_time - get_settings('gmt_offset') * 3600);
+  return $string_gmt;
+}
+
+// give it a GMT date, it will give you the same date with $time_difference added
+function get_date_from_gmt($string) {
+  // note: this only adds $time_difference to the given date
+  preg_match('#([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2}) ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})#', $string, $matches);
+  $string_time = gmmktime($matches[4], $matches[5], $matches[6], $matches[2], $matches[3], $matches[1]);
+  $string_localtime = gmdate('Y-m-d H:i:s', $string_time + get_settings('gmt_offset')*3600);
+  return $string_localtime;
+}
+
+// computes an offset in seconds from an iso8601 timezone
+function iso8601_timezone_to_offset($timezone) {
+  // $timezone is either 'Z' or '[+|-]hhmm'
+  if ($timezone == 'Z') {
+    $offset = 0;
+  } else {
+    $sign    = (substr($timezone, 0, 1) == '+') ? 1 : -1;
+    $hours   = intval(substr($timezone, 1, 2));
+    $minutes = intval(substr($timezone, 3, 4)) / 60;
+    $offset  = $sign * 3600 * ($hours + $minutes);
+  }
+  return $offset;
+}
+
+// converts an iso8601 date to MySQL DateTime format used by post_date[_gmt]
+function iso8601_to_datetime($date_string, $timezone = USER) {
+  if ($timezone == GMT) {
+    preg_match('#([0-9]{4})([0-9]{2})([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(Z|[\+|\-][0-9]{2,4}){0,1}#', $date_string, $date_bits);
+    if (!empty($date_bits[7])) { // we have a timezone, so let's compute an offset
+      $offset = iso8601_timezone_to_offset($date_bits[7]);
+    } else { // we don't have a timezone, so we assume user local timezone (not server's!)
+      $offset = 3600 * get_settings('gmt_offset');
+    }
+    $timestamp = gmmktime($date_bits[4], $date_bits[5], $date_bits[6], $date_bits[2], $date_bits[3], $date_bits[1]);
+    $timestamp -= $offset;
+    return gmdate('Y-m-d H:i:s', $timestamp);
+  } elseif ($timezone == USER) {
+    return preg_replace('#([0-9]{4})([0-9]{2})([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(Z|[\+|\-][0-9]{2,4}){0,1}#', '$1-$2-$3 $4:$5:$6', $date_string);
+  }
+}
+
+function popuplinks($text) {
+	// Comment text in popup windows should be filtered through this.
+	// Right now it's a moderately dumb function, ideally it would detect whether
+	// a target or rel attribute was already there and adjust its actions accordingly.
+	$text = preg_replace('/&lt;a (.+?)&gt;/i', &quot;&lt;a $1 target='_blank' rel='external'&gt;&quot;, $text);
+	return $text;
+}
+
+function sanitize_email($email) {
+	return preg_replace('/[^<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">a-z0-9+_. at -</A>]/i', '', $email);
+}
+
+function human_time_diff( $from, $to = '' ) {     
+	if ( empty($to) )
+		$to = time();
+	$diff = (int) abs($to - $from);
+	if ($diff &lt;= 3600) {
+		$mins = round($diff / 60);
+		if ($mins &lt;= 1)
+			$since = __('1 min');
+		else
+			$since = sprintf( __('%s mins'), $mins);
+	} else if (($diff &lt;= 86400) &amp;&amp; ($diff &gt; 3600)) {
+		$hours = round($diff / 3600);
+		if ($hours &lt;= 1)
+			$since = __('1 hour');
+		else 
+			$since = sprintf( __('%s hours'), $hours );
+	} elseif ($diff &gt;= 86400) {
+		$days = round($diff / 86400);
+		if ($days &lt;= 1)
+			$since = __('1 day');
+		else
+			$since = sprintf( __('%s days'), $days );
+	}
+	return $since;
+}
+
+function wp_trim_excerpt($text) { // Fakes an excerpt if needed
+	global $post;
+	if ( '' == $text ) {
+		$text = $post-&gt;post_content;
+		$text = apply_filters('the_content', $text);
+		$text = str_replace(']]&gt;', ']]&gt;', $text);
+		$text = strip_tags($text);
+		$excerpt_length = 55;
+		$words = explode(' ', $text, $excerpt_length + 1);
+		if (count($words) &gt; $excerpt_length) {
+			array_pop($words);
+			array_push($words, '[...]');
+			$text = implode(' ', $words);
+		}
+	}
+	return $text;
+}
+
+function ent2ncr($text) {
+	$to_ncr = array(
+			'&quot;' =&gt; '&#34;',
+			'&amp;' =&gt; '&#38;',
+			'&frasl;' =&gt; '&#47;',
+			'&lt;' =&gt; '&#60;',
+			'&gt;' =&gt; '&#62;',
+			'&nbsp;' =&gt; '&#160;',
+			'&iexcl;' =&gt; '&#161;',
+			'&cent;' =&gt; '&#162;',
+			'&pound;' =&gt; '&#163;',
+			'&curren;' =&gt; '&#164;',
+			'&yen;' =&gt; '&#165;',
+			'|' =&gt; '&#166;',
+			'&brvbar;' =&gt; '&#166;',
+			'&brkbar;' =&gt; '&#166;',
+			'&sect;' =&gt; '&#167;',
+			'&uml;' =&gt; '&#168;',
+			'&die;' =&gt; '&#168;',
+			'&copy;' =&gt; '&#169;',
+			'&ordf;' =&gt; '&#170;',
+			'&laquo;' =&gt; '&#171;',
+			'&not;' =&gt; '&#172;',
+			'&shy;' =&gt; '&#173;',
+			'&reg;' =&gt; '&#174;',
+			'&macr;' =&gt; '&#175;',
+			'&hibar;' =&gt; '&#175;',
+			'&deg;' =&gt; '&#176;',
+			'&plusmn;' =&gt; '&#177;',
+			'&amp;sup2;' =&gt; '&#178;',
+			'&amp;sup3;' =&gt; '&#179;',
+			'&acute;' =&gt; '&#180;',
+			'&micro;' =&gt; '&#181;',
+			'&para;' =&gt; '&#182;',
+			'&middot;' =&gt; '&#183;',
+			'&cedil;' =&gt; '&#184;',
+			'&amp;sup1;' =&gt; '&#185;',
+			'&ordm;' =&gt; '&#186;',
+			'&raquo;' =&gt; '&#187;',
+			'&amp;frac14;' =&gt; '&#188;',
+			'&amp;frac12;' =&gt; '&#189;',
+			'&amp;frac34;' =&gt; '&#190;',
+			'&iquest;' =&gt; '&#191;',
+			'&Agrave;' =&gt; '&#192;',
+			'&Aacute;' =&gt; '&#193;',
+			'&Acirc;' =&gt; '&#194;',
+			'&Atilde;' =&gt; '&#195;',
+			'&Auml;' =&gt; '&#196;',
+			'&Aring;' =&gt; '&#197;',
+			'&AElig;' =&gt; '&#198;',
+			'&Ccedil;' =&gt; '&#199;',
+			'&Egrave;' =&gt; '&#200;',
+			'&Eacute;' =&gt; '&#201;',
+			'&Ecirc;' =&gt; '&#202;',
+			'&Euml;' =&gt; '&#203;',
+			'&Igrave;' =&gt; '&#204;',
+			'&Iacute;' =&gt; '&#205;',
+			'&Icirc;' =&gt; '&#206;',
+			'&Iuml;' =&gt; '&#207;',
+			'&ETH;' =&gt; '&#208;',
+			'&Ntilde;' =&gt; '&#209;',
+			'&Ograve;' =&gt; '&#210;',
+			'&Oacute;' =&gt; '&#211;',
+			'&Ocirc;' =&gt; '&#212;',
+			'&Otilde;' =&gt; '&#213;',
+			'&Ouml;' =&gt; '&#214;',
+			'&times;' =&gt; '&#215;',
+			'&Oslash;' =&gt; '&#216;',
+			'&Ugrave;' =&gt; '&#217;',
+			'&Uacute;' =&gt; '&#218;',
+			'&Ucirc;' =&gt; '&#219;',
+			'&Uuml;' =&gt; '&#220;',
+			'&Yacute;' =&gt; '&#221;',
+			'&THORN;' =&gt; '&#222;',
+			'&szlig;' =&gt; '&#223;',
+			'&agrave;' =&gt; '&#224;',
+			'&aacute;' =&gt; '&#225;',
+			'&acirc;' =&gt; '&#226;',
+			'&atilde;' =&gt; '&#227;',
+			'&auml;' =&gt; '&#228;',
+			'&aring;' =&gt; '&#229;',
+			'&aelig;' =&gt; '&#230;',
+			'&ccedil;' =&gt; '&#231;',
+			'&egrave;' =&gt; '&#232;',
+			'&eacute;' =&gt; '&#233;',
+			'&ecirc;' =&gt; '&#234;',
+			'&euml;' =&gt; '&#235;',
+			'&igrave;' =&gt; '&#236;',
+			'&iacute;' =&gt; '&#237;',
+			'&icirc;' =&gt; '&#238;',
+			'&iuml;' =&gt; '&#239;',
+			'&eth;' =&gt; '&#240;',
+			'&ntilde;' =&gt; '&#241;',
+			'&ograve;' =&gt; '&#242;',
+			'&oacute;' =&gt; '&#243;',
+			'&ocirc;' =&gt; '&#244;',
+			'&otilde;' =&gt; '&#245;',
+			'&ouml;' =&gt; '&#246;',
+			'&divide;' =&gt; '&#247;',
+			'&oslash;' =&gt; '&#248;',
+			'&ugrave;' =&gt; '&#249;',
+			'&uacute;' =&gt; '&#250;',
+			'&ucirc;' =&gt; '&#251;',
+			'&uuml;' =&gt; '&#252;',
+			'&yacute;' =&gt; '&#253;',
+			'&thorn;' =&gt; '&#254;',
+			'&yuml;' =&gt; '&#255;',
+			'&OElig;' =&gt; '&#338;',
+			'&oelig;' =&gt; '&#339;',
+			'&Scaron;' =&gt; '&#352;',
+			'&scaron;' =&gt; '&#353;',
+			'&Yuml;' =&gt; '&#376;',
+			'&fnof;' =&gt; '&#402;',
+			'&circ;' =&gt; '&#710;',
+			'&tilde;' =&gt; '&#732;',
+			'&Alpha;' =&gt; '&#913;',
+			'&Beta;' =&gt; '&#914;',
+			'&Gamma;' =&gt; '&#915;',
+			'&Delta;' =&gt; '&#916;',
+			'&Epsilon;' =&gt; '&#917;',
+			'&Zeta;' =&gt; '&#918;',
+			'&Eta;' =&gt; '&#919;',
+			'&Theta;' =&gt; '&#920;',
+			'&Iota;' =&gt; '&#921;',
+			'&Kappa;' =&gt; '&#922;',
+			'&Lambda;' =&gt; '&#923;',
+			'&Mu;' =&gt; '&#924;',
+			'&Nu;' =&gt; '&#925;',
+			'&Xi;' =&gt; '&#926;',
+			'&Omicron;' =&gt; '&#927;',
+			'&Pi;' =&gt; '&#928;',
+			'&Rho;' =&gt; '&#929;',
+			'&Sigma;' =&gt; '&#931;',
+			'&Tau;' =&gt; '&#932;',
+			'&Upsilon;' =&gt; '&#933;',
+			'&Phi;' =&gt; '&#934;',
+			'&Chi;' =&gt; '&#935;',
+			'&Psi;' =&gt; '&#936;',
+			'&Omega;' =&gt; '&#937;',
+			'&alpha;' =&gt; '&#945;',
+			'&beta;' =&gt; '&#946;',
+			'&gamma;' =&gt; '&#947;',
+			'&delta;' =&gt; '&#948;',
+			'&epsilon;' =&gt; '&#949;',
+			'&zeta;' =&gt; '&#950;',
+			'&eta;' =&gt; '&#951;',
+			'&theta;' =&gt; '&#952;',
+			'&iota;' =&gt; '&#953;',
+			'&kappa;' =&gt; '&#954;',
+			'&lambda;' =&gt; '&#955;',
+			'&mu;' =&gt; '&#956;',
+			'&nu;' =&gt; '&#957;',
+			'&xi;' =&gt; '&#958;',
+			'&omicron;' =&gt; '&#959;',
+			'&pi;' =&gt; '&#960;',
+			'&rho;' =&gt; '&#961;',
+			'&sigmaf;' =&gt; '&#962;',
+			'&sigma;' =&gt; '&#963;',
+			'&tau;' =&gt; '&#964;',
+			'&upsilon;' =&gt; '&#965;',
+			'&phi;' =&gt; '&#966;',
+			'&chi;' =&gt; '&#967;',
+			'&psi;' =&gt; '&#968;',
+			'&omega;' =&gt; '&#969;',
+			'&thetasym;' =&gt; '&#977;',
+			'&upsih;' =&gt; '&#978;',
+			'&piv;' =&gt; '&#982;',
+			'&ensp;' =&gt; '&#8194;',
+			'&emsp;' =&gt; '&#8195;',
+			'&thinsp;' =&gt; '&#8201;',
+			'&zwnj;' =&gt; '&#8204;',
+			'&zwj;' =&gt; '&#8205;',
+			'&lrm;' =&gt; '&#8206;',
+			'&rlm;' =&gt; '&#8207;',
+			'&ndash;' =&gt; '&#8211;',
+			'&mdash;' =&gt; '&#8212;',
+			'&lsquo;' =&gt; '&#8216;',
+			'&rsquo;' =&gt; '&#8217;',
+			'&sbquo;' =&gt; '&#8218;',
+			'&ldquo;' =&gt; '&#8220;',
+			'&rdquo;' =&gt; '&#8221;',
+			'&bdquo;' =&gt; '&#8222;',
+			'&dagger;' =&gt; '&#8224;',
+			'&Dagger;' =&gt; '&#8225;',
+			'&bull;' =&gt; '&#8226;',
+			'&hellip;' =&gt; '&#8230;',
+			'&permil;' =&gt; '&#8240;',
+			'&prime;' =&gt; '&#8242;',
+			'&Prime;' =&gt; '&#8243;',
+			'&lsaquo;' =&gt; '&#8249;',
+			'&rsaquo;' =&gt; '&#8250;',
+			'&oline;' =&gt; '&#8254;',
+			'&frasl;' =&gt; '&#8260;',
+			'&euro;' =&gt; '&#8364;',
+			'&image;' =&gt; '&#8465;',
+			'&weierp;' =&gt; '&#8472;',
+			'&real;' =&gt; '&#8476;',
+			'&trade;' =&gt; '&#8482;',
+			'&alefsym;' =&gt; '&#8501;',
+			'&crarr;' =&gt; '&#8629;',
+			'&lArr;' =&gt; '&#8656;',
+			'&uArr;' =&gt; '&#8657;',
+			'&rArr;' =&gt; '&#8658;',
+			'&dArr;' =&gt; '&#8659;',
+			'&hArr;' =&gt; '&#8660;',
+			'&forall;' =&gt; '&#8704;',
+			'&part;' =&gt; '&#8706;',
+			'&exist;' =&gt; '&#8707;',
+			'&empty;' =&gt; '&#8709;',
+			'&nabla;' =&gt; '&#8711;',
+			'&isin;' =&gt; '&#8712;',
+			'&notin;' =&gt; '&#8713;',
+			'&ni;' =&gt; '&#8715;',
+			'&prod;' =&gt; '&#8719;',
+			'&sum;' =&gt; '&#8721;',
+			'&minus;' =&gt; '&#8722;',
+			'&lowast;' =&gt; '&#8727;',
+			'&radic;' =&gt; '&#8730;',
+			'&prop;' =&gt; '&#8733;',
+			'&infin;' =&gt; '&#8734;',
+			'&ang;' =&gt; '&#8736;',
+			'&and;' =&gt; '&#8743;',
+			'&or;' =&gt; '&#8744;',
+			'&cap;' =&gt; '&#8745;',
+			'&cup;' =&gt; '&#8746;',
+			'&int;' =&gt; '&#8747;',
+			'&amp;there4;' =&gt; '&#8756;',
+			'&sim;' =&gt; '&#8764;',
+			'&cong;' =&gt; '&#8773;',
+			'&asymp;' =&gt; '&#8776;',
+			'&ne;' =&gt; '&#8800;',
+			'&equiv;' =&gt; '&#8801;',
+			'&le;' =&gt; '&#8804;',
+			'&ge;' =&gt; '&#8805;',
+			'&sub;' =&gt; '&#8834;',
+			'&sup;' =&gt; '&#8835;',
+			'&nsub;' =&gt; '&#8836;',
+			'&sube;' =&gt; '&#8838;',
+			'&supe;' =&gt; '&#8839;',
+			'&oplus;' =&gt; '&#8853;',
+			'&otimes;' =&gt; '&#8855;',
+			'&perp;' =&gt; '&#8869;',
+			'&sdot;' =&gt; '&#8901;',
+			'&lceil;' =&gt; '&#8968;',
+			'&rceil;' =&gt; '&#8969;',
+			'&lfloor;' =&gt; '&#8970;',
+			'&rfloor;' =&gt; '&#8971;',
+			'&lang;' =&gt; '&#9001;',
+			'&rang;' =&gt; '&#9002;',
+			'&larr;' =&gt; '&#8592;',
+			'&uarr;' =&gt; '&#8593;',
+			'&rarr;' =&gt; '&#8594;',
+			'&darr;' =&gt; '&#8595;',
+			'&harr;' =&gt; '&#8596;',
+			'&loz;' =&gt; '&#9674;',
+			'&spades;' =&gt; '&#9824;',
+			'&clubs;' =&gt; '&#9827;',
+			'&hearts;' =&gt; '&#9829;',
+			'&diams;' =&gt; '&#9830;'
+	);
+
+	foreach ($to_ncr as $entity =&gt; $ncr) {
+		$text = str_replace($entity, $ncr, $text);
+	}
+	return $text;
+}
+
+?&gt;

Added: trunk/wp-includes/functions-post.php
===================================================================
--- trunk/wp-includes/functions-post.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/functions-post.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,604 @@
+&lt;?php
+
+/**** DB Functions ****/
+
+/*
+ * generic function for inserting data into the posts table.
+ */
+function wp_insert_post($postarr = array()) {
+	global $wpdb, $allowedtags;
+	
+	// export array as variables
+	extract($postarr);
+	
+	$post_name = sanitize_title($post_title);
+	$post_author = (int) $post_author;
+
+	// Make sure we set a valid category
+	if (0 == count($post_category) || !is_array($post_category)) {
+		$post_category = array(get_option('default_category'));
+	}
+
+	$post_cat = $post_category[0];
+	
+	if (empty($post_date))
+		$post_date = current_time('mysql');
+	// Make sure we have a good gmt date:
+	if (empty($post_date_gmt)) 
+		$post_date_gmt = get_gmt_from_date($post_date);
+	if (empty($comment_status))
+		$comment_status = get_settings('default_comment_status');
+	if (empty($ping_status))
+		$ping_status = get_settings('default_ping_status');
+	if ( empty($post_parent) )
+		$post_parent = 0;
+
+	if ('publish' == $post_status) {
+		$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+		if ($post_name_check) {
+			$suffix = 2;
+			while ($post_name_check) {
+				$alt_post_name = $post_name . &quot;-$suffix&quot;;
+				$post_name_check = $wpdb-&gt;get_var(&quot;SELECT post_name FROM $wpdb-&gt;posts WHERE post_name = '$alt_post_name' AND post_status = 'publish' AND ID != '$post_ID' LIMIT 1&quot;);
+				$suffix++;
+			}
+			$post_name = $alt_post_name;
+		}
+	}
+
+	$sql = &quot;INSERT INTO $wpdb-&gt;posts 
+		(post_author, post_date, post_date_gmt, post_modified, post_modified_gmt, post_content, post_title, post_excerpt, post_category, post_status, post_name, comment_status, ping_status, post_parent) 
+		VALUES ('$post_author', '$post_date', '$post_date_gmt', '$post_date', '$post_date_gmt', '$post_content', '$post_title', '$post_excerpt', '$post_cat', '$post_status', '$post_name', '$comment_status', '$ping_status', '$post_parent')&quot;;
+	
+	$result = $wpdb-&gt;query($sql);
+	$post_ID = $wpdb-&gt;insert_id;
+
+	// Set GUID
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET guid = '&quot; . get_permalink($post_ID) . &quot;' WHERE ID = '$post_ID'&quot;);
+	
+	wp_set_post_cats('', $post_ID, $post_category);
+	
+	if ($post_status == 'publish') {
+		do_action('publish_post', $post_ID);
+	}
+
+	pingback($content, $post_ID);
+
+	// Return insert_id if we got a good result, otherwise return zero.
+	return $result ? $post_ID : 0;
+}
+
+function wp_get_single_post($postid = 0, $mode = OBJECT) {
+	global $wpdb;
+
+	$sql = &quot;SELECT * FROM $wpdb-&gt;posts WHERE ID=$postid&quot;;
+	$result = $wpdb-&gt;get_row($sql, $mode);
+	
+	// Set categories
+	if($mode == OBJECT) {
+		$result-&gt;post_category = wp_get_post_cats('',$postid);
+	} 
+	else {
+		$result['post_category'] = wp_get_post_cats('',$postid);
+	}
+
+	return $result;
+}
+
+function wp_get_recent_posts($num = 10) {
+	global $wpdb;
+
+	// Set the limit clause, if we got a limit
+	if ($num) {
+		$limit = &quot;LIMIT $num&quot;;
+	}
+
+	$sql = &quot;SELECT * FROM $wpdb-&gt;posts WHERE post_status IN ('publish', 'draft', 'private') ORDER BY post_date DESC $limit&quot;;
+	$result = $wpdb-&gt;get_results($sql,ARRAY_A);
+
+	return $result?$result:array();
+}
+
+function wp_update_post($postarr = array()) {
+	global $wpdb;
+
+	// First get all of the original fields
+	$post = wp_get_single_post($postarr['ID'], ARRAY_A);
+
+	// Escape data pulled from DB.
+	$post = add_magic_quotes($post);
+	extract($post);
+
+	// Now overwrite any changed values being passed in. These are 
+	// already escaped.
+	extract($postarr);
+
+	// If no categories were passed along, use the current cats.
+	if ( 0 == count($post_category) || !is_array($post_category) )
+		$post_category = $post['post_category'];
+
+	$post_modified = current_time('mysql');
+	$post_modified_gmt = current_time('mysql', 1);
+
+	$sql = &quot;UPDATE $wpdb-&gt;posts 
+		SET post_content = '$post_content',
+		post_title = '$post_title',
+		post_category = $post_category[0],
+		post_status = '$post_status',
+		post_date = '$post_date',
+		post_date_gmt = '$post_date_gmt',
+		post_modified = '$post_modified',
+		post_modified_gmt = '$post_modified_gmt',
+		post_excerpt = '$post_excerpt',
+		ping_status = '$ping_status',
+		comment_status = '$comment_status'
+		WHERE ID = $ID&quot;;
+		
+	$result = $wpdb-&gt;query($sql);
+	$rows_affected = $wpdb-&gt;rows_affected;
+
+	wp_set_post_cats('', $ID, $post_category);
+
+	do_action('edit_post', $ID);
+
+	return $rows_affected;
+}
+
+function wp_get_post_cats($blogid = '1', $post_ID = 0) {
+	global $wpdb;
+	
+	$sql = &quot;SELECT category_id 
+		FROM $wpdb-&gt;post2cat 
+		WHERE post_id = $post_ID 
+		ORDER BY category_id&quot;;
+
+	$result = $wpdb-&gt;get_col($sql);
+
+	if ( !$result )
+		$result = array();
+
+	return array_unique($result);
+}
+
+function wp_set_post_cats($blogid = '1', $post_ID = 0, $post_categories = array()) {
+	global $wpdb;
+	// If $post_categories isn't already an array, make it one:
+	if (!is_array($post_categories) || 0 == count($post_categories))
+		$post_categories = array(get_option('default_category'));
+
+	$post_categories = array_unique($post_categories);
+
+	// First the old categories
+	$old_categories = $wpdb-&gt;get_col(&quot;
+		SELECT category_id 
+		FROM $wpdb-&gt;post2cat 
+		WHERE post_id = $post_ID&quot;);
+	
+	if (!$old_categories) {
+		$old_categories = array();
+	} else {
+		$old_categories = array_unique($old_categories);
+	}
+
+
+	$oldies = printr($old_categories,1);
+	$newbies = printr($post_categories,1);
+
+	// Delete any?
+	$delete_cats = array_diff($old_categories,$post_categories);
+
+	if ($delete_cats) {
+		foreach ($delete_cats as $del) {
+			$wpdb-&gt;query(&quot;
+				DELETE FROM $wpdb-&gt;post2cat 
+				WHERE category_id = $del 
+					AND post_id = $post_ID 
+				&quot;);
+		}
+	}
+
+	// Add any?
+	$add_cats = array_diff($post_categories, $old_categories);
+
+	if ($add_cats) {
+		foreach ($add_cats as $new_cat) {
+			$wpdb-&gt;query(&quot;
+				INSERT INTO $wpdb-&gt;post2cat (post_id, category_id) 
+				VALUES ($post_ID, $new_cat)&quot;);
+		}
+	}
+}	// wp_set_post_cats()
+
+function wp_delete_post($postid = 0) {
+	global $wpdb;
+	$postid = (int) $postid;
+
+	if ( !$post = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;posts WHERE ID = $postid&quot;) )
+		return $post;
+
+	if ( 'static' == $post-&gt;post_status )
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET post_parent = $post-&gt;post_parent WHERE post_parent = $postid AND post_status = 'static'&quot;);
+
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;posts WHERE ID = $postid&quot;);
+	
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;comments WHERE comment_post_ID = $postid&quot;);
+
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;post2cat WHERE post_id = $postid&quot;);
+
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;postmeta WHERE post_id = $postid&quot;);
+	
+	return $post;
+}
+
+/**** /DB Functions ****/
+
+/**** Misc ****/
+
+// get permalink from post ID
+function post_permalink($post_id = 0, $mode = '') { // $mode legacy
+	return get_permalink($post_id);
+}
+
+// Get the name of a category from its ID
+function get_cat_name($cat_id) {
+	global $wpdb;
+	
+	$cat_id -= 0; 	// force numeric
+	$name = $wpdb-&gt;get_var(&quot;SELECT cat_name FROM $wpdb-&gt;categories WHERE cat_ID=$cat_id&quot;);
+	
+	return $name;
+}
+
+// Get the ID of a category from its name
+function get_cat_ID($cat_name='General') {
+	global $wpdb;
+	
+	$cid = $wpdb-&gt;get_var(&quot;SELECT cat_ID FROM $wpdb-&gt;categories WHERE cat_name='$cat_name'&quot;);
+
+	return $cid?$cid:1;	// default to cat 1
+}
+
+// Get author's preferred display name
+function get_author_name( $auth_id ) {
+	$authordata = get_userdata( $auth_id );
+
+	switch( $authordata['user_idmode'] ) {
+		case 'nickname':
+			$authorname = $authordata['user_nickname'];
+			break;
+		case 'login':
+			$authorname = $authordata['user_login'];
+			break;
+		case 'firstname':
+			$authorname = $authordata['user_firstname'];
+			break;
+		case 'lastname':
+			$authorname = $authordata['user_lastname'];
+			break;
+		case 'namefl':
+			$authorname = $authordata['user_firstname'].' '.$authordata['user_lastname'];
+			break;
+		case 'namelf':
+			$authorname = $authordata['user_lastname'].' '.$authordata['user_firstname'];
+			break;
+		default:
+			$authorname = $authordata['user_nickname'];
+			break;
+	}
+
+	return $authorname;
+}
+
+// get extended entry info (&lt;!--more--&gt;)
+function get_extended($post) {
+	list($main,$extended) = explode('&lt;!--more--&gt;', $post, 2);
+
+	// Strip leading and trailing whitespace
+	$main = preg_replace('/^[\s]*(.*)[\s]*$/','\\1',$main);
+	$extended = preg_replace('/^[\s]*(.*)[\s]*$/','\\1',$extended);
+
+	return array('main' =&gt; $main, 'extended' =&gt; $extended);
+}
+
+// do trackbacks for a list of urls
+// borrowed from edit.php
+// accepts a comma-separated list of trackback urls and a post id
+function trackback_url_list($tb_list, $post_id) {
+	if (!empty($tb_list)) {
+		// get post data
+		$postdata = wp_get_single_post($post_id, ARRAY_A);
+
+		// import postdata as variables
+		extract($postdata);
+		
+		// form an excerpt
+		$excerpt = strip_tags($post_excerpt?$post_excerpt:$post_content);
+		
+		if (strlen($excerpt) &gt; 255) {
+			$excerpt = substr($excerpt,0,252) . '...';
+		}
+		
+		$trackback_urls = explode(',', $tb_list);
+		foreach($trackback_urls as $tb_url) {
+		    $tb_url = trim($tb_url);
+		    trackback($tb_url, stripslashes($post_title), $excerpt, $post_id);
+		}
+    }
+}
+
+
+// query user capabilities
+// rather simplistic. shall evolve with future permission system overhaul
+// $blog_id and $category_id are there for future usage
+
+/* returns true if $user_id can create a new post */
+function user_can_create_post($user_id, $blog_id = 1, $category_id = 'None') {
+	$author_data = get_userdata($user_id);
+	return ($author_data-&gt;user_level &gt; 1);
+}
+
+/* returns true if $user_id can create a new post */
+function user_can_create_draft($user_id, $blog_id = 1, $category_id = 'None') {
+	$author_data = get_userdata($user_id);
+	return ($author_data-&gt;user_level &gt;= 1);
+}
+
+/* returns true if $user_id can edit $post_id */
+function user_can_edit_post($user_id, $post_id, $blog_id = 1) {
+	$author_data = get_userdata($user_id);
+	$post = get_post($post_id);
+	$post_author_data = get_userdata($post-&gt;post_author);
+
+	if ( (($user_id == $post_author_data-&gt;ID) &amp;&amp; !($post-&gt;post_status == 'publish' &amp;&amp;  $author_data-&gt;user_level &lt; 2))
+	     || ($author_data-&gt;user_level &gt; $post_author_data-&gt;user_level)
+	     || ($author_data-&gt;user_level &gt;= 10) ) {
+		return true;
+	} else {
+		return false;
+	}
+}
+
+/* returns true if $user_id can delete $post_id */
+function user_can_delete_post($user_id, $post_id, $blog_id = 1) {
+	// right now if one can edit, one can delete
+	return user_can_edit_post($user_id, $post_id, $blog_id);
+}
+
+/* returns true if $user_id can set new posts' dates on $blog_id */
+function user_can_set_post_date($user_id, $blog_id = 1, $category_id = 'None') {
+	$author_data = get_userdata($user_id);
+	return (($author_data-&gt;user_level &gt; 4) &amp;&amp; user_can_create_post($user_id, $blog_id, $category_id));
+}
+
+/* returns true if $user_id can edit $post_id's date */
+function user_can_edit_post_date($user_id, $post_id, $blog_id = 1) {
+	$author_data = get_userdata($user_id);
+	return (($author_data-&gt;user_level &gt; 4) &amp;&amp; user_can_edit_post($user_id, $post_id, $blog_id));
+}
+
+/* returns true if $user_id can edit $post_id's comments */
+function user_can_edit_post_comments($user_id, $post_id, $blog_id = 1) {
+	// right now if one can edit a post, one can edit comments made on it
+	return user_can_edit_post($user_id, $post_id, $blog_id);
+}
+
+/* returns true if $user_id can delete $post_id's comments */
+function user_can_delete_post_comments($user_id, $post_id, $blog_id = 1) {
+	// right now if one can edit comments, one can delete comments
+	return user_can_edit_post_comments($user_id, $post_id, $blog_id);
+}
+
+function user_can_edit_user($user_id, $other_user) {
+	$user  = get_userdata($user_id);
+	$other = get_userdata($other_user);
+	if ( $user-&gt;user_level &gt; $other-&gt;user_level || $user-&gt;user_level &gt; 8 || $user-&gt;ID == $other-&gt;ID )
+		return true;
+	else
+		return false;
+}
+
+function wp_blacklist_check($author, $email, $url, $comment, $user_ip, $user_agent) {
+	global $wpdb;
+
+	do_action('wp_blacklist_check', $author, $email, $url, $comment, $user_ip, $user_agent);
+
+	if ( preg_match_all('/&amp;#(\d+);/', $comment . $author . $url, $chars) ) {
+		foreach ($chars[1] as $char) {
+			// If it's an encoded char in the normal ASCII set, reject
+			if ($char &lt; 128)
+				return true;
+		}
+	}
+
+	$mod_keys = trim( get_settings('blacklist_keys') );
+	if ('' == $mod_keys )
+		return false; // If moderation keys are empty
+	$words = explode(&quot;\n&quot;, $mod_keys );
+
+	foreach ($words as $word) {
+		$word = trim($word);
+
+		// Skip empty lines
+		if ( empty($word) ) { continue; }
+
+		// Do some escaping magic so that '#' chars in the 
+		// spam words don't break things:
+		$word = preg_quote($word, '#');
+		
+		$pattern = &quot;#$word#i&quot;; 
+		if ( preg_match($pattern, $author    ) ) return true;
+		if ( preg_match($pattern, $email     ) ) return true;
+		if ( preg_match($pattern, $url       ) ) return true;
+		if ( preg_match($pattern, $comment   ) ) return true;
+		if ( preg_match($pattern, $user_ip   ) ) return true;
+		if ( preg_match($pattern, $user_agent) ) return true;
+	}
+	
+	if ( isset($_SERVER['REMOTE_ADDR']) ) {
+		if ( wp_proxy_check($_SERVER['REMOTE_ADDR']) ) return true;
+	}
+
+	return false;
+}
+
+function wp_proxy_check($ipnum) {
+	if ( get_option('open_proxy_check') &amp;&amp; isset($ipnum) ) {
+		$rev_ip = implode( '.', array_reverse( explode( '.', $ipnum ) ) );
+		$lookup = $rev_ip . '.opm.blitzed.org';
+		if ( $lookup != gethostbyname( $lookup ) )
+			return true;
+	}
+
+	return false;
+}
+
+function wp_new_comment( $commentdata, $spam = false ) {
+	global $wpdb;
+
+	$commentdata = apply_filters('preprocess_comment', $commentdata);
+	extract($commentdata);
+
+	$comment_post_ID = (int) $comment_post_ID;
+
+	$user_id = apply_filters('pre_user_id', $user_ID);
+	$author  = apply_filters('pre_comment_author_name', $comment_author);
+	$email   = apply_filters('pre_comment_author_email', $comment_author_email);
+	$url     = apply_filters('pre_comment_author_url', $comment_author_url);
+	$comment = apply_filters('pre_comment_content', $comment_content);
+	$comment = apply_filters('post_comment_text', $comment); // Deprecated
+	$comment = apply_filters('comment_content_presave', $comment); // Deprecated
+
+	$user_ip     = apply_filters('pre_comment_user_ip', $_SERVER['REMOTE_ADDR']);
+	$user_domain = apply_filters('pre_comment_user_domain', gethostbyaddr($user_ip) );
+	$user_agent  = apply_filters('pre_comment_user_agent', $_SERVER['HTTP_USER_AGENT']);
+
+	$now     = current_time('mysql');
+	$now_gmt = current_time('mysql', 1);
+
+	if ( $user_id ) {
+		$userdata = get_userdata($user_id);
+		$post_author = $wpdb-&gt;get_var(&quot;SELECT post_author FROM $wpdb-&gt;posts WHERE ID = '$comment_post_ID' LIMIT 1&quot;);
+	}
+
+	// Simple duplicate check
+	$dupe = &quot;SELECT comment_ID FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_post_ID' AND ( comment_author = '$author' &quot;;
+	if ( $email ) $dupe .= &quot;OR comment_author_email = '$email' &quot;;
+	$dupe .= &quot;) AND comment_content = '$comment' LIMIT 1&quot;;
+	if ( $wpdb-&gt;get_var($dupe) )
+		die( __('Duplicate comment detected; it looks as though you\'ve already said that!') );
+
+	// Simple flood-protection
+	if ( $lasttime = $wpdb-&gt;get_var(&quot;SELECT comment_date_gmt FROM $wpdb-&gt;comments WHERE comment_author_IP = '$user_ip' OR comment_author_email = '$email' ORDER BY comment_date DESC LIMIT 1&quot;) ) {
+		$time_lastcomment = mysql2date('U', $lasttime);
+		$time_newcomment  = mysql2date('U', $now_gmt);
+		if ( ($time_newcomment - $time_lastcomment) &lt; 15 ) {
+			do_action('comment_flood_trigger', $time_lastcomment, $time_newcomment);
+			die( __('Sorry, you can only post a new comment once every 15 seconds. Slow down cowboy.') );
+		}
+	}
+
+	if ( $userdata &amp;&amp; ( $user_id == $post_author || $userdata-&gt;user_level &gt;= 9 ) ) {
+		$approved = 1;
+	} else {
+		if ( check_comment($author, $email, $url, $comment, $user_ip, $user_agent, $comment_type) )
+			$approved = 1;
+		else
+			$approved = 0;
+		if ( wp_blacklist_check($author, $email, $url, $comment, $user_ip, $user_agent) )
+			$approved = 'spam';
+	}
+
+	$approved = apply_filters('pre_comment_approved', $approved);
+
+	$result = $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;comments 
+	(comment_post_ID, comment_author, comment_author_email, comment_author_url, comment_author_IP, comment_date, comment_date_gmt, comment_content, comment_approved, comment_agent, comment_type, user_id)
+	VALUES 
+	('$comment_post_ID', '$author', '$email', '$url', '$user_ip', '$now', '$now_gmt', '$comment', '$approved', '$user_agent', '$comment_type', '$user_id')
+	&quot;);
+
+	$comment_id = $wpdb-&gt;insert_id;
+	do_action('comment_post', $comment_id, $approved);
+
+	if ( 'spam' !== $approved ) { // If it's spam save it silently for later crunching
+		if ( '0' == $approved )
+			wp_notify_moderator($comment_id);
+	
+		if ( get_settings('comments_notify') &amp;&amp; $approved )
+			wp_notify_postauthor($comment_id, $comment_type);
+	}
+
+	return $result;
+}
+
+function do_trackbacks($post_id) {
+	global $wpdb;
+
+	$post = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;posts WHERE ID = $post_id&quot;);
+	$to_ping = get_to_ping($post_id);
+	$pinged  = get_pung($post_id);
+	if ( empty($to_ping) )
+		return;
+	if (empty($post-&gt;post_excerpt))
+		$excerpt = apply_filters('the_content', $post-&gt;post_content);
+	else
+		$excerpt = apply_filters('the_excerpt', $post-&gt;post_excerpt);
+	$excerpt = str_replace(']]&gt;', ']]&gt;', $excerpt);
+	$excerpt = strip_tags($excerpt);
+	$excerpt = substr($excerpt, 0, 252) . '...';
+
+	$post_title = apply_filters('the_title', $post-&gt;post_title);
+	$post_title = strip_tags($post_title);
+
+	if ($to_ping) : foreach ($to_ping as $tb_ping) :
+		$tb_ping = trim($tb_ping);
+		if ( !in_array($tb_ping, $pinged) )
+		 trackback($tb_ping, $post_title, $excerpt, $post_id);
+	endforeach; endif;
+}
+
+function get_pung($post_id) { // Get URIs already pung for a post
+	global $wpdb;
+	$pung = $wpdb-&gt;get_var(&quot;SELECT pinged FROM $wpdb-&gt;posts WHERE ID = $post_id&quot;);
+	$pung = trim($pung);
+	$pung = preg_split('/\s/', $pung);
+	return $pung;
+}
+
+function get_enclosed($post_id) { // Get enclosures already enclosed for a post
+	global $wpdb;
+	$custom_fields = get_post_custom( $post_id );
+	$pung = array();
+	if( is_array( $custom_fields ) ) {
+		while( list( $key, $val ) = each( $custom_fields ) ) { 
+			if( $key == 'enclosure' ) {
+				if (is_array($val)) {
+					foreach($val as $enc) {
+						$enclosure = split( &quot;\n&quot;, $enc );
+						$pung[] = trim( $enclosure[ 0 ] );
+					}
+				}
+			}
+		}
+	}
+	return $pung;
+}
+
+function get_to_ping($post_id) { // Get any URIs in the todo list
+	global $wpdb;
+	$to_ping = $wpdb-&gt;get_var(&quot;SELECT to_ping FROM $wpdb-&gt;posts WHERE ID = $post_id&quot;);
+	$to_ping = trim($to_ping);
+	$to_ping = preg_split('/\s/', $to_ping, -1, PREG_SPLIT_NO_EMPTY);
+	return $to_ping;
+}
+
+function add_ping($post_id, $uri) { // Add a URI to those already pung
+	global $wpdb;
+	$pung = $wpdb-&gt;get_var(&quot;SELECT pinged FROM $wpdb-&gt;posts WHERE ID = $post_id&quot;);
+	$pung = trim($pung);
+	$pung = preg_split('/\s/', $pung);
+	$pung[] = $uri;
+	$new = implode(&quot;\n&quot;, $pung);
+	return $wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET pinged = '$new' WHERE ID = $post_id&quot;);
+}
+
+?&gt;

Added: trunk/wp-includes/functions.php
===================================================================
--- trunk/wp-includes/functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,1852 @@
+&lt;?php
+
+require_once(dirname(__FILE__).'/functions-compat.php');
+
+if (!function_exists('_')) {
+	function _($string) {
+		return $string;
+	}
+}
+
+function get_profile($field, $user = false) {
+	global $wpdb;
+	if (!$user)
+		$user = $wpdb-&gt;escape($_COOKIE['wordpressuser_' . COOKIEHASH]);
+	return $wpdb-&gt;get_var(&quot;SELECT $field FROM $wpdb-&gt;users WHERE user_login = '$user'&quot;);
+}
+
+function mysql2date($dateformatstring, $mysqlstring, $translate = true) {
+	global $month, $weekday, $month_abbrev, $weekday_abbrev;
+	$m = $mysqlstring;
+	if (empty($m)) {
+		return false;
+	}
+	$i = mktime(substr($m,11,2),substr($m,14,2),substr($m,17,2),substr($m,5,2),substr($m,8,2),substr($m,0,4)); 
+	if (!empty($month) &amp;&amp; !empty($weekday) &amp;&amp; $translate) {
+		$datemonth = $month[date('m', $i)];
+		$datemonth_abbrev = $month_abbrev[$datemonth];
+		$dateweekday = $weekday[date('w', $i)];
+		$dateweekday_abbrev = $weekday_abbrev[$dateweekday]; 		
+		$dateformatstring = ' '.$dateformatstring;
+		$dateformatstring = preg_replace(&quot;/([^\\\])D/&quot;, &quot;\\1&quot;.backslashit($dateweekday_abbrev), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])F/&quot;, &quot;\\1&quot;.backslashit($datemonth), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])l/&quot;, &quot;\\1&quot;.backslashit($dateweekday), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])M/&quot;, &quot;\\1&quot;.backslashit($datemonth_abbrev), $dateformatstring);
+	
+		$dateformatstring = substr($dateformatstring, 1, strlen($dateformatstring)-1);
+	}
+	$j = @date($dateformatstring, $i);
+	if (!$j) {
+	// for debug purposes
+	//	echo $i.&quot; &quot;.$mysqlstring;
+	}
+	return $j;
+}
+
+function current_time($type, $gmt = 0) {
+	switch ($type) {
+		case 'mysql':
+			if ($gmt) $d = gmdate('Y-m-d H:i:s');
+			else $d = gmdate('Y-m-d H:i:s', (time() + (get_settings('gmt_offset') * 3600)));
+			return $d;
+			break;
+		case 'timestamp':
+			if ($gmt) $d = time();
+			else $d = time() + (get_settings('gmt_offset') * 3600);
+			return $d;
+			break;
+	}
+}
+
+function date_i18n($dateformatstring, $unixtimestamp) {
+	global $month, $weekday, $month_abbrev, $weekday_abbrev;
+	$i = $unixtimestamp; 
+	if ((!empty($month)) &amp;&amp; (!empty($weekday))) {
+		$datemonth = $month[date('m', $i)];
+		$datemonth_abbrev = $month_abbrev[$datemonth];
+		$dateweekday = $weekday[date('w', $i)];
+		$dateweekday_abbrev = $weekday_abbrev[$dateweekday]; 		
+		$dateformatstring = ' '.$dateformatstring;
+		$dateformatstring = preg_replace(&quot;/([^\\\])D/&quot;, &quot;\\1&quot;.backslashit($dateweekday_abbrev), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])F/&quot;, &quot;\\1&quot;.backslashit($datemonth), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])l/&quot;, &quot;\\1&quot;.backslashit($dateweekday), $dateformatstring);
+		$dateformatstring = preg_replace(&quot;/([^\\\])M/&quot;, &quot;\\1&quot;.backslashit($datemonth_abbrev), $dateformatstring);
+		$dateformatstring = substr($dateformatstring, 1, strlen($dateformatstring)-1);
+	}
+	$j = @date($dateformatstring, $i);
+	return $j;
+	}
+
+function get_weekstartend($mysqlstring, $start_of_week) {
+	$my = substr($mysqlstring,0,4);
+	$mm = substr($mysqlstring,8,2);
+	$md = substr($mysqlstring,5,2);
+	$day = mktime(0,0,0, $md, $mm, $my);
+	$weekday = date('w',$day);
+	$i = 86400;
+
+	if ($weekday &lt; get_settings('start_of_week'))
+		$weekday = 7 - (get_settings('start_of_week') - $weekday);
+
+	while ($weekday &gt; get_settings('start_of_week')) {
+		$weekday = date('w',$day);
+		if ($weekday &lt; get_settings('start_of_week'))
+			$weekday = 7 - (get_settings('start_of_week') - $weekday);
+
+		$day = $day - 86400;
+		$i = 0;
+	}
+	$week['start'] = $day + 86400 - $i;
+	//$week['end']   = $day - $i + 691199;
+	$week['end'] = $week['start'] + 604799;
+	return $week;
+}
+
+function get_lastpostdate($timezone = 'server') {
+	global $cache_lastpostdate, $pagenow, $wpdb;
+	$add_seconds_blog = get_settings('gmt_offset') * 3600;
+	$add_seconds_server = date('Z');
+	$now = current_time('mysql', 1);
+	if ( !isset($cache_lastpostdate[$timezone]) ) {
+		switch(strtolower($timezone)) {
+			case 'gmt':
+				$lastpostdate = $wpdb-&gt;get_var(&quot;SELECT post_date_gmt FROM $wpdb-&gt;posts WHERE post_date_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_date_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'blog':
+				$lastpostdate = $wpdb-&gt;get_var(&quot;SELECT post_date FROM $wpdb-&gt;posts WHERE post_date_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_date_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'server':
+				$lastpostdate = $wpdb-&gt;get_var(&quot;SELECT DATE_ADD(post_date_gmt, INTERVAL '$add_seconds_server' SECOND) FROM $wpdb-&gt;posts WHERE post_date_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_date_gmt DESC LIMIT 1&quot;);
+				break;
+		}
+		$cache_lastpostdate[$timezone] = $lastpostdate;
+	} else {
+		$lastpostdate = $cache_lastpostdate[$timezone];
+	}
+	return $lastpostdate;
+}
+
+function get_lastpostmodified($timezone = 'server') {
+	global $cache_lastpostmodified, $pagenow, $wpdb;
+	$add_seconds_blog = get_settings('gmt_offset') * 3600;
+	$add_seconds_server = date('Z');
+	$now = current_time('mysql', 1);
+	if ( !isset($cache_lastpostmodified[$timezone]) ) {
+		switch(strtolower($timezone)) {
+			case 'gmt':
+				$lastpostmodified = $wpdb-&gt;get_var(&quot;SELECT post_modified_gmt FROM $wpdb-&gt;posts WHERE post_modified_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_modified_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'blog':
+				$lastpostmodified = $wpdb-&gt;get_var(&quot;SELECT post_modified FROM $wpdb-&gt;posts WHERE post_modified_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_modified_gmt DESC LIMIT 1&quot;);
+				break;
+			case 'server':
+				$lastpostmodified = $wpdb-&gt;get_var(&quot;SELECT DATE_ADD(post_modified_gmt, INTERVAL '$add_seconds_server' SECOND) FROM $wpdb-&gt;posts WHERE post_modified_gmt &lt;= '$now' AND post_status = 'publish' ORDER BY post_modified_gmt DESC LIMIT 1&quot;);
+				break;
+		}
+		$lastpostdate = get_lastpostdate($timezone);
+		if ($lastpostdate &gt; $lastpostmodified) {
+			$lastpostmodified = $lastpostdate;
+		}
+		$cache_lastpostmodified[$timezone] = $lastpostmodified;
+	} else {
+		$lastpostmodified = $cache_lastpostmodified[$timezone];
+	}
+	return $lastpostmodified;
+}
+
+function user_pass_ok($user_login,$user_pass) {
+	global $cache_userdata;
+	if ( empty($cache_userdata[$user_login]) ) {
+		$userdata = get_userdatabylogin($user_login);
+	} else {
+		$userdata = $cache_userdata[$user_login];
+	}
+	return (md5($user_pass) == $userdata-&gt;user_pass);
+}
+
+
+function get_usernumposts($userid) {
+	global $wpdb;
+	return $wpdb-&gt;get_var(&quot;SELECT COUNT(*) FROM $wpdb-&gt;posts WHERE post_author = '$userid' AND post_status = 'publish'&quot;);
+}
+
+// examine a url (supposedly from this blog) and try to
+// determine the post ID it represents.
+function url_to_postid($url) {
+	global $wp_rewrite;
+
+	// First, check to see if there is a 'p=N' or 'page_id=N' to match against:
+	preg_match('#[?&amp;](p|page_id)=(\d+)#', $url, $values);
+	$id = intval($values[2]);
+	if ($id) return $id;
+
+	// URI is probably a permalink.
+	$rewrite = $wp_rewrite-&gt;wp_rewrite_rules();
+
+	if ( empty($rewrite) )
+		return 0;
+
+	$req_uri = $url;
+
+	if ( false !== strpos($req_uri, get_settings('home')) ) {
+		$req_uri = str_replace(get_settings('home'), '', $req_uri);
+	} else {
+		$home_path = parse_url(get_settings('home'));
+		$home_path = $home_path['path'];
+		$req_uri = str_replace($home_path, '', $req_uri);
+	}
+
+	$req_uri = trim($req_uri, '/');
+	$request = $req_uri;
+	
+	// Look for matches.
+	$request_match = $request;
+	foreach ($rewrite as $match =&gt; $query) {
+		// If the requesting file is the anchor of the match, prepend it
+		// to the path info.
+		if ((! empty($req_uri)) &amp;&amp; (strpos($match, $req_uri) === 0)) {
+			$request_match = $req_uri . '/' . $request;
+		}
+
+		if (preg_match(&quot;!^$match!&quot;, $request_match, $matches)) {
+			// Got a match.
+			// Trim the query of everything up to the '?'.
+			$query = preg_replace(&quot;!^.+\?!&quot;, '', $query);
+			
+			// Substitute the substring matches into the query.
+			eval(&quot;\$query = \&quot;$query\&quot;;&quot;);
+			$query = new WP_Query($query);
+			if ( !empty($query-&gt;post) )
+				return $query-&gt;post-&gt;ID;
+			else
+				return 0;
+		}
+	}
+
+	return 0;
+}
+
+
+/* Options functions */
+
+function get_settings($setting) {
+  global $wpdb, $cache_settings, $cache_nonexistantoptions;
+	if ( strstr($_SERVER['REQUEST_URI'], 'wp-admin/install.php') || defined('WP_INSTALLING') )
+		return false;
+
+	if ( empty($cache_settings) )
+		$cache_settings = get_alloptions();
+
+	if ( empty($cache_nonexistantoptions) )
+		$cache_nonexistantoptions = array();
+
+	if ('home' == $setting &amp;&amp; '' == $cache_settings-&gt;home)
+		return apply_filters('option_' . $setting, $cache_settings-&gt;siteurl);
+
+	if ( isset($cache_settings-&gt;$setting) ) :
+		return apply_filters('option_' . $setting, $cache_settings-&gt;$setting);
+	else :
+		// for these cases when we're asking for an unknown option
+		if ( isset($cache_nonexistantoptions[$setting]) )
+			return false;
+
+		$option = $wpdb-&gt;get_var(&quot;SELECT option_value FROM $wpdb-&gt;options WHERE option_name = '$setting'&quot;);
+
+		if (!$option) :
+			$cache_nonexistantoptions[$setting] = true;
+			return false;
+		endif;
+
+		@ $kellogs = unserialize($option);
+		if ($kellogs !== FALSE)
+			return apply_filters('option_' . $setting, $kellogs);
+		else return apply_filters('option_' . $setting, $option);
+	endif;
+}
+
+function get_option($option) {
+	return get_settings($option);
+}
+
+function form_option($option) {
+	echo htmlspecialchars( get_option($option), ENT_QUOTES );
+}
+
+function get_alloptions() {
+	global $wpdb, $wp_queries;
+	$wpdb-&gt;hide_errors();
+	if (!$options = $wpdb-&gt;get_results(&quot;SELECT option_name, option_value FROM $wpdb-&gt;options WHERE autoload = 'yes'&quot;)) {
+		$options = $wpdb-&gt;get_results(&quot;SELECT option_name, option_value FROM $wpdb-&gt;options&quot;);
+	}
+	$wpdb-&gt;show_errors();
+
+	foreach ($options as $option) {
+		// &quot;When trying to design a foolproof system, 
+		//  never underestimate the ingenuity of the fools :)&quot; -- Dougal
+		if ('siteurl' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+		if ('home' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+		if ('category_base' == $option-&gt;option_name) $option-&gt;option_value = preg_replace('|/+$|', '', $option-&gt;option_value);
+		@ $value = unserialize($option-&gt;option_value);
+		if ($value === FALSE)
+			$value = $option-&gt;option_value;
+		$all_options-&gt;{$option-&gt;option_name} = apply_filters('pre_option_' . $option-&gt;option_name, $value);
+	}
+	return apply_filters('all_options', $all_options);
+}
+
+function update_option($option_name, $newvalue) {
+	global $wpdb, $cache_settings;
+	if ( is_array($newvalue) || is_object($newvalue) )
+		$newvalue = serialize($newvalue);
+
+	$newvalue = trim($newvalue); // I can't think of any situation we wouldn't want to trim
+
+    // If the new and old values are the same, no need to update.
+    if ($newvalue == get_option($option_name)) {
+        return true;
+    }
+
+	// If it's not there add it
+	if ( !$wpdb-&gt;get_var(&quot;SELECT option_name FROM $wpdb-&gt;options WHERE option_name = '$option_name'&quot;) )
+		add_option($option_name);
+
+	$newvalue = $wpdb-&gt;escape($newvalue);
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;options SET option_value = '$newvalue' WHERE option_name = '$option_name'&quot;);
+	$cache_settings = get_alloptions(); // Re cache settings
+	return true;
+}
+
+
+// thx Alex Stapleton, <A HREF="http://alex.vort-x.net/blog/">http://alex.vort-x.net/blog/</A>
+function add_option($name, $value = '', $description = '', $autoload = 'yes') {
+	global $wpdb;
+	$original = $value;
+	if ( is_array($value) || is_object($value) )
+		$value = serialize($value);
+
+	if( !$wpdb-&gt;get_var(&quot;SELECT option_name FROM $wpdb-&gt;options WHERE option_name = '$name'&quot;) ) {
+		$name = $wpdb-&gt;escape($name);
+		$value = $wpdb-&gt;escape($value);
+		$description = $wpdb-&gt;escape($description);
+		$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;options (option_name, option_value, option_description, autoload) VALUES ('$name', '$value', '$description', '$autoload')&quot;);
+
+		if($wpdb-&gt;insert_id) {
+			global $cache_settings;
+			$cache_settings-&gt;{$name} = $original;
+		}
+	}
+	return;
+}
+
+function delete_option($name) {
+	global $wpdb;
+	// Get the ID, if no ID then return
+	$option_id = $wpdb-&gt;get_var(&quot;SELECT option_id FROM $wpdb-&gt;options WHERE option_name = '$name'&quot;);
+	if (!$option_id) return false;
+	$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;options WHERE option_name = '$name'&quot;);
+	return true;
+}
+
+function add_post_meta($post_id, $key, $value, $unique = false) {
+	global $wpdb;
+	
+	if ($unique) {
+		if( $wpdb-&gt;get_var(&quot;SELECT meta_key FROM $wpdb-&gt;postmeta WHERE meta_key
+= '$key' AND post_id = '$post_id'&quot;) ) {
+			return false;
+		}
+	}
+
+	$wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;postmeta
+                                (post_id,meta_key,meta_value) 
+                                VALUES ('$post_id','$key','$value')
+                        &quot;);
+	
+	return true;
+}
+
+function delete_post_meta($post_id, $key, $value = '') {
+	global $wpdb;
+
+	if (empty($value)) {
+		$meta_id = $wpdb-&gt;get_var(&quot;SELECT meta_id FROM $wpdb-&gt;postmeta WHERE
+post_id = '$post_id' AND meta_key = '$key'&quot;);
+	} else {
+		$meta_id = $wpdb-&gt;get_var(&quot;SELECT meta_id FROM $wpdb-&gt;postmeta WHERE
+post_id = '$post_id' AND meta_key = '$key' AND meta_value = '$value'&quot;);
+	}
+
+	if (!$meta_id) return false;
+
+	if (empty($value)) {
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;postmeta WHERE post_id = '$post_id'
+AND meta_key = '$key'&quot;);
+	} else {
+		$wpdb-&gt;query(&quot;DELETE FROM $wpdb-&gt;postmeta WHERE post_id = '$post_id'
+AND meta_key = '$key' AND meta_value = '$value'&quot;);
+	}
+        
+	return true;
+}
+
+function get_post_meta($post_id, $key, $single = false) {
+	global $wpdb, $post_meta_cache;
+
+	if (isset($post_meta_cache[$post_id][$key])) {
+		if ($single) {
+			return $post_meta_cache[$post_id][$key][0];
+		} else {
+			return $post_meta_cache[$post_id][$key];
+		}
+	}
+
+	$metalist = $wpdb-&gt;get_results(&quot;SELECT meta_value FROM $wpdb-&gt;postmeta WHERE post_id = '$post_id' AND meta_key = '$key'&quot;, ARRAY_N);
+
+	$values = array();
+	if ($metalist) {
+		foreach ($metalist as $metarow) {
+			$values[] = $metarow[0];
+		}
+	}
+
+	if ($single) {
+		if (count($values)) {
+			return $values[0];
+		} else {
+			return '';
+		}
+	} else {
+		return $values;
+	}
+}
+
+function update_post_meta($post_id, $key, $value, $prev_value = '') {
+	global $wpdb, $post_meta_cache;
+
+		if(! $wpdb-&gt;get_var(&quot;SELECT meta_key FROM $wpdb-&gt;postmeta WHERE meta_key
+= '$key' AND post_id = '$post_id'&quot;) ) {
+			return false;
+		}
+
+	if (empty($prev_value)) {
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;postmeta SET meta_value = '$value' WHERE
+meta_key = '$key' AND post_id = '$post_id'&quot;);
+	} else {
+		$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;postmeta SET meta_value = '$value' WHERE
+meta_key = '$key' AND post_id = '$post_id' AND meta_value = '$prev_value'&quot;);
+	}
+
+	return true;
+}
+
+// Deprecated.  Use get_post().
+function get_postdata($postid) {
+	$post = &amp;get_post($postid);
+	
+	$postdata = array (
+		'ID' =&gt; $post-&gt;ID, 
+		'Author_ID' =&gt; $post-&gt;post_author, 
+		'Date' =&gt; $post-&gt;post_date, 
+		'Content' =&gt; $post-&gt;post_content, 
+		'Excerpt' =&gt; $post-&gt;post_excerpt, 
+		'Title' =&gt; $post-&gt;post_title, 
+		'Category' =&gt; $post-&gt;post_category,
+		'post_status' =&gt; $post-&gt;post_status,
+		'comment_status' =&gt; $post-&gt;comment_status,
+		'ping_status' =&gt; $post-&gt;ping_status,
+		'post_password' =&gt; $post-&gt;post_password,
+		'to_ping' =&gt; $post-&gt;to_ping,
+		'pinged' =&gt; $post-&gt;pinged,
+		'post_name' =&gt; $post-&gt;post_name
+	);
+
+	return $postdata;
+}
+
+// Retrieves post data given a post ID or post object. 
+// Handles post caching.
+function &amp;get_post(&amp;$post, $output = OBJECT) {
+	global $post_cache, $wpdb;
+
+	if ( empty($post) ) {
+		if ( isset($GLOBALS['post']) )
+			$post = &amp; $GLOBALS['post'];
+		else
+			$post = null;
+	} elseif (is_object($post) ) {
+		if (! isset($post_cache[$post-&gt;ID]))
+			$post_cache[$post-&gt;ID] = &amp;$post;
+		$post = &amp; $post_cache[$post-&gt;ID];
+	} else {
+		if (isset($post_cache[$post]))
+			$post = &amp; $post_cache[$post];
+		else {
+			$query = &quot;SELECT * FROM $wpdb-&gt;posts WHERE ID=$post&quot;;
+			$post_cache[$post] = &amp; $wpdb-&gt;get_row($query);
+			$post = &amp; $post_cache[$post];
+		}
+	}
+
+	if ( $output == OBJECT ) {
+		return $post;
+	} elseif ( $output == ARRAY_A ) {
+		return get_object_vars($post);
+	} elseif ( $output == ARRAY_N ) {
+		return array_values(get_object_vars($post));
+	} else {
+		return $post;
+	}
+}
+
+// Retrieves page data given a page ID or page object. 
+// Handles page caching.
+function &amp;get_page(&amp;$page, $output = OBJECT) {
+	global $page_cache, $wpdb;
+
+	if ( empty($page) ) {
+		if ( isset($GLOBALS['page']) )
+			$page = &amp; $GLOBALS['page'];
+		else
+			$page = null;
+	} elseif (is_object($page) ) {
+		if (! isset($page_cache[$page-&gt;ID]))
+			$page_cache[$page-&gt;ID] = &amp;$page;
+		$page = &amp; $page_cache[$page-&gt;ID];
+	} else {
+		if ( isset($GLOBALS['page']) &amp;&amp; ($page == $GLOBALS['page']-&gt;ID) )
+			$page = &amp; $GLOBALS['page'];
+		elseif (isset($page_cache[$page]))
+			$page = &amp; $page_cache[$page];
+		else {
+			$query = &quot;SELECT * FROM $wpdb-&gt;posts WHERE ID=$page&quot;;
+			$page_cache[$page] = &amp; $wpdb-&gt;get_row($query);
+			$page = &amp; $page_cache[$page];
+		}
+	}
+
+	if ( $output == OBJECT ) {
+		return $page;
+	} elseif ( $output == ARRAY_A ) {
+		return get_object_vars($page);
+	} elseif ( $output == ARRAY_N ) {
+		return array_values(get_object_vars($page));
+	} else {
+		return $page;
+	}
+}
+
+// Retrieves category data given a category ID or category object. 
+// Handles category caching.
+function &amp;get_category(&amp;$category, $output = OBJECT) {
+	global $cache_categories, $wpdb;
+
+	if ( empty($category) )
+		return null;
+
+	$category = (int) $category;
+
+	if ( ! isset($cache_categories))
+		update_category_cache();
+
+	if (is_object($category)) {
+		if ( ! isset($cache_categories[$category-&gt;cat_ID]))
+			$cache_categories[$category-&gt;cat_ID] = &amp;$category;
+		$category = &amp; $cache_categories[$category-&gt;cat_ID];
+	} else {
+		if ( !isset($cache_categories[$category]) ) {
+			$category = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;categories WHERE cat_ID = $category&quot;);
+			$cache_categories[$category-&gt;cat_ID] = &amp; $category;
+		} else {
+			$category = &amp; $cache_categories[$category];
+		}
+	}
+
+	if ( $output == OBJECT ) {
+		return $category;
+	} elseif ( $output == ARRAY_A ) {
+		return get_object_vars($category);
+	} elseif ( $output == ARRAY_N ) {
+		return array_values(get_object_vars($category));
+	} else {
+		return $category;
+	}
+}
+
+function get_catname($cat_ID) {
+	$category = &amp;get_category($cat_ID);
+	return $category-&gt;cat_name;
+}
+
+function gzip_compression() {
+	if ( strstr($_SERVER['PHP_SELF'], 'wp-admin') ) return false;
+	if ( !get_settings('gzipcompression') ) return false;
+
+	if( extension_loaded('zlib') ) {
+		ob_start('ob_gzhandler');
+	}
+}
+
+
+// functions to count the page generation time (from phpBB2)
+// ( or just any time between timer_start() and timer_stop() )
+
+function timer_stop($display = 0, $precision = 3) { //if called like timer_stop(1), will echo $timetotal
+	global $timestart, $timeend;
+	$mtime = microtime();
+	$mtime = explode(' ',$mtime);
+	$mtime = $mtime[1] + $mtime[0];
+	$timeend = $mtime;
+	$timetotal = $timeend-$timestart;
+	if ($display)
+		echo number_format($timetotal,$precision);
+	return $timetotal;
+}
+
+function weblog_ping($server = '', $path = '') {
+	global $wp_version;
+	include_once (ABSPATH . WPINC . '/class-IXR.php');
+
+	// using a timeout of 3 seconds should be enough to cover slow servers
+	$client = new IXR_Client($server, ((!strlen(trim($path)) || ('/' == $path)) ? false : $path));
+	$client-&gt;timeout = 3;
+	$client-&gt;useragent .= ' -- WordPress/'.$wp_version;
+
+	// when set to true, this outputs debug messages by itself
+	$client-&gt;debug = false;
+	$home = trailingslashit( get_option('home') );
+	if ( !$client-&gt;query('weblogUpdates.extendedPing', get_settings('blogname'), $home, get_bloginfo('rss2_url') ) ) // then try a normal ping
+		$client-&gt;query('weblogUpdates.ping', get_settings('blogname'), $home);
+}
+
+function generic_ping($post_id = 0) {
+	$services = get_settings('ping_sites');
+	$services = preg_replace(&quot;|(\s)+|&quot;, '$1', $services); // Kill dupe lines
+	$services = trim($services);
+	if ('' != $services) {
+		$services = explode(&quot;\n&quot;, $services);
+		foreach ($services as $service) {
+			weblog_ping($service);
+		}
+	}
+
+	return $post_id;
+}
+
+// Send a Trackback
+function trackback($trackback_url, $title, $excerpt, $ID) {
+	global $wpdb, $wp_version;
+
+	if (empty($trackback_url))
+		return;
+
+	$title = urlencode($title);
+	$excerpt = urlencode($excerpt);
+	$blog_name = urlencode(get_settings('blogname'));
+	$tb_url = $trackback_url;
+	$url = urlencode(get_permalink($ID));
+	$query_string = &quot;title=$title&amp;url=$url&amp;blog_name=$blog_name&amp;excerpt=$excerpt&quot;;
+	$trackback_url = parse_url($trackback_url);
+	$http_request  = 'POST ' . $trackback_url['path'] . ($trackback_url['query'] ? '?'.$trackback_url['query'] : '') . &quot; HTTP/1.0\r\n&quot;;
+	$http_request .= 'Host: '.$trackback_url['host'].&quot;\r\n&quot;;
+	$http_request .= 'Content-Type: application/x-www-form-urlencoded; charset='.get_settings('blog_charset').&quot;\r\n&quot;;
+	$http_request .= 'Content-Length: '.strlen($query_string).&quot;\r\n&quot;;
+	$http_request .= &quot;User-Agent: WordPress/&quot; . $wp_version;
+	$http_request .= &quot;\r\n\r\n&quot;;
+	$http_request .= $query_string;
+	if ( '' == $trackback_url['port'] )
+		$trackback_url['port'] = 80;
+	$fs = @fsockopen($trackback_url['host'], $trackback_url['port'], $errno, $errstr, 4);
+	@fputs($fs, $http_request);
+/*
+	$debug_file = 'trackback.log';
+	$fp = fopen($debug_file, 'a');
+	fwrite($fp, &quot;\n*****\nRequest:\n\n$http_request\n\nResponse:\n\n&quot;);
+	while(!@feof($fs)) {
+		fwrite($fp, @fgets($fs, 4096));
+	}
+	fwrite($fp, &quot;\n\n&quot;);
+	fclose($fp);
+*/
+	@fclose($fs);
+
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET pinged = CONCAT(pinged, '\n', '$tb_url') WHERE ID = '$ID'&quot;);
+	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;posts SET to_ping = REPLACE(to_ping, '$tb_url', '') WHERE ID = '$ID'&quot;);
+	return $result;
+}
+
+function make_url_footnote($content) {
+	preg_match_all('/&lt;a(.+?)href=\&quot;(.+?)\&quot;(.*?)&gt;(.+?)&lt;\/a&gt;/', $content, $matches);
+	$j = 0;
+	for ($i=0; $i&lt;count($matches[0]); $i++) {
+		$links_summary = (!$j) ? &quot;\n&quot; : $links_summary;
+		$j++;
+		$link_match = $matches[0][$i];
+		$link_number = '['.($i+1).']';
+		$link_url = $matches[2][$i];
+		$link_text = $matches[4][$i];
+		$content = str_replace($link_match, $link_text.' '.$link_number, $content);
+		$link_url = (strtolower(substr($link_url,0,7)) != '<A HREF="http://">http://</A>') ? get_settings('home') . $link_url : $link_url;
+		$links_summary .= &quot;\n&quot;.$link_number.' '.$link_url;
+	}
+	$content = strip_tags($content);
+	$content .= $links_summary;
+	return $content;
+}
+
+
+function xmlrpc_getposttitle($content) {
+	global $post_default_title;
+	if (preg_match('/&lt;title&gt;(.+?)&lt;\/title&gt;/is', $content, $matchtitle)) {
+		$post_title = $matchtitle[0];
+		$post_title = preg_replace('/&lt;title&gt;/si', '', $post_title);
+		$post_title = preg_replace('/&lt;\/title&gt;/si', '', $post_title);
+	} else {
+		$post_title = $post_default_title;
+	}
+	return $post_title;
+}
+	
+function xmlrpc_getpostcategory($content) {
+	global $post_default_category;
+	if (preg_match('/&lt;category&gt;(.+?)&lt;\/category&gt;/is', $content, $matchcat)) {
+		$post_category = trim($matchcat[1], ',');
+		$post_category = explode(',', $post_category);
+	} else {
+		$post_category = $post_default_category;
+	}
+	return $post_category;
+}
+
+function xmlrpc_removepostdata($content) {
+	$content = preg_replace('/&lt;title&gt;(.+?)&lt;\/title&gt;/si', '', $content);
+	$content = preg_replace('/&lt;category&gt;(.+?)&lt;\/category&gt;/si', '', $content);
+	$content = trim($content);
+	return $content;
+}
+
+function debug_fopen($filename, $mode) {
+	global $debug;
+	if ($debug == 1) {
+		$fp = fopen($filename, $mode);
+		return $fp;
+	} else {
+		return false;
+	}
+}
+
+function debug_fwrite($fp, $string) {
+	global $debug;
+	if ($debug == 1) {
+		fwrite($fp, $string);
+	}
+}
+
+function debug_fclose($fp) {
+	global $debug;
+	if ($debug == 1) {
+		fclose($fp);
+	}
+}
+
+function do_enclose( $content, $post_ID ) {
+	global $wp_version, $wpdb;
+	include_once (ABSPATH . WPINC . '/class-IXR.php');
+
+	$log = debug_fopen(ABSPATH . '/enclosures.log', 'a');
+	$post_links = array();
+	debug_fwrite($log, 'BEGIN '.date('YmdHis', time()).&quot;\n&quot;);
+
+	$pung = get_enclosed( $post_ID );
+
+	$ltrs = '\w';
+	$gunk = '/#~:.?+=&amp;%@!\-';
+	$punc = '.:?\-';
+	$any = $ltrs . $gunk . $punc;
+
+	preg_match_all(&quot;{\b http : [$any] +? (?= [$punc] * [^$any] | $)}x&quot;, $content, $post_links_temp);
+
+	debug_fwrite($log, 'Post contents:');
+	debug_fwrite($log, $content.&quot;\n&quot;);
+
+	foreach($post_links_temp[0] as $link_test) :
+		if ( !in_array($link_test, $pung) ) : // If we haven't pung it already
+			$test = parse_url($link_test);
+			if (isset($test['query']))
+				$post_links[] = $link_test;
+			elseif(($test['path'] != '/') &amp;&amp; ($test['path'] != ''))
+				$post_links[] = $link_test;
+		endif;
+	endforeach;
+
+	foreach ($post_links as $url) :
+		if ( $url != '' &amp;&amp; !$wpdb-&gt;get_var(&quot;SELECT post_id FROM $wpdb-&gt;postmeta WHERE post_id = '$post_ID' AND meta_key = 'enclosure' AND meta_value LIKE ('$url%')&quot;) ) {
+			if ( $headers = wp_get_http_headers( $url) ) {
+				$len  = (int) $headers['content-length'];
+				$type = addslashes( $headers['content-type'] );
+				$allowed_types = array( 'video', 'audio' );
+				if( in_array( substr( $type, 0, strpos( $type, &quot;/&quot; ) ), $allowed_types ) ) {
+					$meta_value = &quot;$url\n$len\n$type\n&quot;;
+					$wpdb-&gt;query( &quot;INSERT INTO `$wpdb-&gt;postmeta` ( `post_id` , `meta_key` , `meta_value` )
+					VALUES ( '$post_ID', 'enclosure' , '$meta_value')&quot; );
+				}
+			}
+		}
+	endforeach;
+}
+
+function wp_get_http_headers( $url ) {
+	set_time_limit( 60 ); 
+	$parts = parse_url( $url );
+	$file  = $parts['path'] . ($parts['query'] ? '?'.$parts['query'] : '');
+	$host  = $parts['host'];
+	if ( !isset( $parts['port'] ) )
+		$parts['port'] = 80;
+
+	$head = &quot;HEAD $file HTTP/1.1\r\nHOST: $host\r\n\r\n&quot;;
+
+	$fp = @fsockopen($host, $parts['port'], $err_num, $err_msg, 3);
+	if ( !$fp )
+		return false;
+
+	$response = '';
+	fputs( $fp, $head );
+	while ( !feof( $fp ) &amp;&amp; strpos( $response, &quot;\r\n\r\n&quot; ) == false )
+		$response .= fgets( $fp, 2048 );
+	fclose( $fp );
+	preg_match_all('/(.*?): (.*)\r/', $response, $matches);
+	$count = count($matches[1]);
+	for ( $i = 0; $i &lt; $count; $i++) {
+		$key = strtolower($matches[1][$i]);
+		$headers[&quot;$key&quot;] = $matches[2][$i];
+	}
+
+	preg_match('/.*([0-9]{3}).*/', $response, $return);
+	$headers['response'] = $return[1]; // HTTP response code eg 204, 200, 404
+	return $headers;
+}
+
+// Deprecated.  Use the new post loop.
+function start_wp() {
+	global $wp_query, $post;
+
+	// Since the old style loop is being used, advance the query iterator here.
+	$wp_query-&gt;next_post();
+
+	setup_postdata($post);
+}
+
+// Setup global post data.
+function setup_postdata($post) {
+  global $id, $postdata, $authordata, $day, $page, $pages, $multipage, $more, $numpages, $wp_query;
+	global $pagenow;
+
+	$id = $post-&gt;ID;
+
+	$authordata = get_userdata($post-&gt;post_author);
+
+	$day = mysql2date('d.m.y', $post-&gt;post_date);
+	$currentmonth = mysql2date('m', $post-&gt;post_date);
+	$numpages = 1;
+	$page = get_query_var('page');
+	if (!$page)
+		$page = 1;
+	if (is_single() || is_page())
+		$more = 1;
+	$content = $post-&gt;post_content;
+	if (preg_match('/&lt;!--nextpage--&gt;/', $content)) {
+		if ($page &gt; 1)
+			$more = 1;
+		$multipage = 1;
+		$content = str_replace(&quot;\n&lt;!--nextpage--&gt;\n&quot;, '&lt;!--nextpage--&gt;', $content);
+		$content = str_replace(&quot;\n&lt;!--nextpage--&gt;&quot;, '&lt;!--nextpage--&gt;', $content);
+		$content = str_replace(&quot;&lt;!--nextpage--&gt;\n&quot;, '&lt;!--nextpage--&gt;', $content);
+		$pages = explode('&lt;!--nextpage--&gt;', $content);
+		$numpages = count($pages);
+	} else {
+		$pages[0] = $post-&gt;post_content;
+		$multipage = 0;
+	}
+	return true;
+}
+
+function is_new_day() {
+	global $day, $previousday;
+	if ($day != $previousday) {
+		return(1);
+	} else {
+		return(0);
+	}
+}
+
+// Filters: these are the core of WP's plugin architecture
+
+function merge_filters($tag) {
+	global $wp_filter;
+	if (isset($wp_filter['all'])) {
+		foreach ($wp_filter['all'] as $priority =&gt; $functions) {
+			if (isset($wp_filter[$tag][$priority]))
+				$wp_filter[$tag][$priority] = array_merge($wp_filter['all'][$priority], $wp_filter[$tag][$priority]);
+			else
+				$wp_filter[$tag][$priority] = array_merge($wp_filter['all'][$priority], array());
+			$wp_filter[$tag][$priority] = array_unique($wp_filter[$tag][$priority]);
+		}
+	}
+
+	if ( isset($wp_filter[$tag]) )
+		ksort( $wp_filter[$tag] );
+}
+
+function apply_filters($tag, $string) {
+	global $wp_filter;
+	
+	$args = array_slice(func_get_args(), 2);
+
+	merge_filters($tag);
+	
+	if (!isset($wp_filter[$tag])) {
+		return $string;
+	}
+	foreach ($wp_filter[$tag] as $priority =&gt; $functions) {
+		if (!is_null($functions)) {
+			foreach($functions as $function) {
+
+				$all_args = array_merge(array($string), $args);
+				$function_name = $function['function'];
+				$accepted_args = $function['accepted_args'];
+
+				if($accepted_args == 1) {
+					$the_args = array($string);
+				} elseif ($accepted_args &gt; 1) {
+					$the_args = array_slice($all_args, 0, $accepted_args);
+				} elseif($accepted_args == 0) {
+					$the_args = NULL;
+				} else {
+					$the_args = $all_args;
+				}
+
+				$string = call_user_func_array($function_name, $the_args);
+			}
+		}
+	}
+	return $string;
+}
+
+function add_filter($tag, $function_to_add, $priority = 10, $accepted_args = 1) {
+	global $wp_filter;
+
+	// check that we don't already have the same filter at the same priority
+	if (isset($wp_filter[$tag][&quot;$priority&quot;])) {
+		foreach($wp_filter[$tag][&quot;$priority&quot;] as $filter) {
+			// uncomment if we want to match function AND accepted_args
+			//if ($filter == array($function, $accepted_args)) {
+			if ($filter['function'] == $function_to_add) {
+				return true;
+			}
+		}
+	}
+
+	// So the format is wp_filter['tag']['array of priorities']['array of ['array (functions, accepted_args)]']
+	$wp_filter[$tag][&quot;$priority&quot;][] = array('function'=&gt;$function_to_add, 'accepted_args'=&gt;$accepted_args);
+	return true;
+}
+
+function remove_filter($tag, $function_to_remove, $priority = 10, $accepted_args = 1) {
+	global $wp_filter;
+
+	// rebuild the list of filters
+	if (isset($wp_filter[$tag][&quot;$priority&quot;])) {
+		foreach($wp_filter[$tag][&quot;$priority&quot;] as $filter) {
+			if ($filter['function'] != $function_to_remove) {
+				$new_function_list[] = $filter;
+			}
+		}
+		$wp_filter[$tag][&quot;$priority&quot;] = $new_function_list;
+	}
+	return true;
+}
+
+// The *_action functions are just aliases for the *_filter functions, they take special strings instead of generic content
+
+function do_action($tag, $arg = '') {
+	global $wp_filter;
+	$extra_args = array_slice(func_get_args(), 2);
+ 	if ( is_array($arg) )
+ 		$args = array_merge($arg, $extra_args);
+	else
+		$args = array_merge(array($arg), $extra_args);
+	
+	merge_filters($tag);
+	
+	if (!isset($wp_filter[$tag])) {
+		return;
+	}
+	foreach ($wp_filter[$tag] as $priority =&gt; $functions) {
+		if (!is_null($functions)) {
+			foreach($functions as $function) {
+
+				$function_name = $function['function'];
+				$accepted_args = $function['accepted_args'];
+
+				if($accepted_args == 1) {
+					if ( is_array($arg) )
+						$the_args = $arg;
+					else
+						$the_args = array($arg);
+				} elseif ($accepted_args &gt; 1) {
+					$the_args = array_slice($args, 0, $accepted_args);
+				} elseif($accepted_args == 0) {
+					$the_args = NULL;
+				} else {
+					$the_args = $args;
+				}
+
+				$string = call_user_func_array($function_name, $the_args);
+			}
+		}
+	}
+}
+
+function add_action($tag, $function_to_add, $priority = 10, $accepted_args = 1) {
+	add_filter($tag, $function_to_add, $priority, $accepted_args);
+}
+
+function remove_action($tag, $function_to_remove, $priority = 10, $accepted_args = 1) {
+	remove_filter($tag, $function_to_remove, $priority, $accepted_args);
+}
+
+function get_page_uri($page_id) {
+	$page = get_page($page_id);
+	$uri = urldecode($page-&gt;post_name);
+
+	// A page cannot be it's own parent.
+	if ($page-&gt;post_parent == $page-&gt;ID) {
+		return $uri;
+	}
+	
+	while ($page-&gt;post_parent != 0) {
+		$page = get_page($page-&gt;post_parent);
+		$uri = urldecode($page-&gt;post_name) . &quot;/&quot; . $uri;
+	}
+
+	return $uri;
+}
+
+function get_posts($args) {
+	global $wpdb;
+	parse_str($args, $r);
+	if (!isset($r['numberposts'])) $r['numberposts'] = 5;
+	if (!isset($r['offset'])) $r['offset'] = 0;
+	if (!isset($r['category'])) $r['category'] = '';
+	if (!isset($r['orderby'])) $r['orderby'] = 'post_date';
+	if (!isset($r['order'])) $r['order'] = 'DESC';
+
+	$now = current_time('mysql');
+
+	$posts = $wpdb-&gt;get_results(
+		&quot;SELECT DISTINCT * FROM $wpdb-&gt;posts &quot; .
+		( empty( $r['category'] ) ? &quot;&quot; : &quot;, $wpdb-&gt;post2cat &quot; ) .
+		&quot; WHERE post_date &lt;= '$now' AND (post_status = 'publish') &quot;.
+		( empty( $r['category'] ) ? &quot;&quot; : &quot;AND $wpdb-&gt;posts.ID = $wpdb-&gt;post2cat.post_id AND $wpdb-&gt;post2cat.category_id = &quot; . $r['category']. &quot; &quot; ) .
+		&quot; GROUP BY $wpdb-&gt;posts.ID ORDER BY &quot; . $r['orderby'] . &quot; &quot; . $r['order'] . &quot;  LIMIT &quot; . $r['offset'] . ',' . $r['numberposts'] );
+	
+    update_post_caches($posts);
+	
+	return $posts;
+}
+
+function &amp;query_posts($query) {
+	global $wp_query;
+	return $wp_query-&gt;query($query);
+}
+
+function update_post_cache(&amp;$posts) {
+	global $post_cache;
+
+	if ( !$posts )
+		return;
+
+	for ($i = 0; $i &lt; count($posts); $i++) {
+		$post_cache[$posts[$i]-&gt;ID] = &amp;$posts[$i];
+	}
+}
+
+function update_page_cache(&amp;$pages) {
+	global $page_cache;
+
+	if ( !$pages )
+		return;
+
+	for ($i = 0; $i &lt; count($pages); $i++) {
+		$page_cache[$pages[$i]-&gt;ID] = &amp;$pages[$i];
+	}
+}
+
+function update_post_category_cache($post_ids) {
+	global $wpdb, $category_cache, $cache_categories;
+
+	if (empty($post_ids))
+		return;
+
+	if (is_array($post_ids))
+		$post_ids = implode(',', $post_ids);
+
+	$dogs = $wpdb-&gt;get_results(&quot;SELECT DISTINCT
+	post_id, cat_ID FROM $wpdb-&gt;categories, $wpdb-&gt;post2cat
+	WHERE category_id = cat_ID AND post_id IN ($post_ids)&quot;);
+
+	if (! isset($cache_categories))
+		update_category_cache();
+		
+	if ( !empty($dogs) ) {
+		foreach ($dogs as $catt) {
+			$category_cache[$catt-&gt;post_id][$catt-&gt;cat_ID] = &amp;$cache_categories[$catt-&gt;cat_ID];
+		}
+	}
+}
+
+function update_post_caches(&amp;$posts) {
+	global $post_cache, $category_cache, $comment_count_cache, $post_meta_cache;
+	global $wpdb;
+	
+	// No point in doing all this work if we didn't match any posts.
+	if ( !$posts )
+		return;
+
+	// Get the categories for all the posts
+	for ($i = 0; $i &lt; count($posts); $i++) {
+		$post_id_list[] = $posts[$i]-&gt;ID;
+		$post_cache[$posts[$i]-&gt;ID] = &amp;$posts[$i];
+	}
+
+	$post_id_list = implode(',', $post_id_list);
+	
+	update_post_category_cache($post_id_list);
+
+	// Do the same for comment numbers
+	$comment_counts = $wpdb-&gt;get_results(&quot;SELECT ID, COUNT( comment_ID ) AS ccount
+	FROM $wpdb-&gt;posts
+	LEFT JOIN $wpdb-&gt;comments ON ( comment_post_ID = ID  AND comment_approved =  '1')
+	WHERE ID IN ($post_id_list)
+	GROUP BY ID&quot;);
+	
+	if ($comment_counts) {
+		foreach ($comment_counts as $comment_count)
+			$comment_count_cache[&quot;$comment_count-&gt;ID&quot;] = $comment_count-&gt;ccount;
+	}
+
+    // Get post-meta info
+	if ( $meta_list = $wpdb-&gt;get_results(&quot;SELECT post_id, meta_key, meta_value FROM $wpdb-&gt;postmeta  WHERE post_id IN($post_id_list) ORDER BY post_id, meta_key&quot;, ARRAY_A) ) {
+		// Change from flat structure to hierarchical:
+		$post_meta_cache = array();
+		foreach ($meta_list as $metarow) {
+			$mpid = $metarow['post_id'];
+			$mkey = $metarow['meta_key'];
+			$mval = $metarow['meta_value'];
+
+			// Force subkeys to be array type:
+			if (!isset($post_meta_cache[$mpid]) || !is_array($post_meta_cache[$mpid]))
+				$post_meta_cache[$mpid] = array();
+			if (!isset($post_meta_cache[$mpid][&quot;$mkey&quot;]) || !is_array($post_meta_cache[$mpid][&quot;$mkey&quot;]))
+				$post_meta_cache[$mpid][&quot;$mkey&quot;] = array();
+
+			// Add a value to the current pid/key:
+			$post_meta_cache[$mpid][$mkey][] = $mval;
+		}
+	}
+}
+
+function update_category_cache() {
+	global $cache_categories, $wpdb;
+	$dogs = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;categories&quot;);
+	foreach ($dogs as $catt)
+		$cache_categories[$catt-&gt;cat_ID] = $catt;
+}
+
+function update_user_cache() {
+	global $cache_userdata, $wpdb;
+	
+	if ( $users = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;users WHERE user_level &gt; 0&quot;) ) :
+		foreach ($users as $user) :
+			$cache_userdata[$user-&gt;ID] = $user;
+			$cache_userdata[$user-&gt;user_login] =&amp; $cache_userdata[$user-&gt;ID];
+		endforeach;
+		return true;
+	else : 
+		return false;
+	endif;
+}
+
+function wp_head() {
+	do_action('wp_head');
+}
+
+function wp_footer() {
+	do_action('wp_footer');
+}
+
+function is_single ($post = '') {
+	global $wp_query;
+
+	if ( !$wp_query-&gt;is_single )
+		return false;
+
+	if ( empty( $post) )
+		return true;
+
+	$post_obj = $wp_query-&gt;get_queried_object();
+
+	if ( $post == $post_obj-&gt;ID ) 
+		return true;
+	elseif ( $post == $post_obj-&gt;post_title ) 
+		return true;
+	elseif ( $post == $post_obj-&gt;post_name )
+		return true;
+
+	return false;
+}
+
+function is_page ($page = '') {
+	global $wp_query;
+
+	if (! $wp_query-&gt;is_page) {
+		return false;
+	}
+
+	if (empty($page)) {
+		return true;
+	}
+
+	$page_obj = $wp_query-&gt;get_queried_object();
+		
+	if ($page == $page_obj-&gt;ID) {
+		return true;
+	} else if ($page == $page_obj-&gt;post_title) {
+		return true;
+	} else if ($page == $page_obj-&gt;post_name) {
+		return true;
+	}
+
+	return false;
+}
+
+function is_archive () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_archive;
+}
+
+function is_date () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_date;
+}
+
+function is_year () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_year;
+}
+
+function is_month () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_month;
+}
+
+function is_day () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_day;
+}
+
+function is_time () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_time;
+}
+
+function is_author ($author = '') {
+	global $wp_query;
+
+	if (! $wp_query-&gt;is_author) {
+		return false;
+	}
+
+	if (empty($author)) {
+		return true;
+	}
+
+	$author_obj = $wp_query-&gt;get_queried_object();
+		
+	if ($author == $author_obj-&gt;ID) {
+		return true;
+	} else if ($author == $author_obj-&gt;user_nickname) {
+		return true;
+	} else if ($author == $author_obj-&gt;user_nicename) {
+		return true;
+	}
+
+	return false;
+}
+
+function is_category ($category = '') {
+	global $wp_query;
+
+	if (! $wp_query-&gt;is_category) {
+		return false;
+	}
+
+	if (empty($category)) {
+		return true;
+	}
+
+	$cat_obj = $wp_query-&gt;get_queried_object();
+		
+	if ($category == $cat_obj-&gt;cat_ID) {
+		return true;
+	} else if ($category == $cat_obj-&gt;cat_name) {
+		return true;
+	} else if ($category == $cat_obj-&gt;category_nicename) {
+		return true;
+	}
+
+	return false;
+}
+
+function is_search () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_search;
+}
+
+function is_feed () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_feed;
+}
+
+function is_trackback () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_trackback;
+}
+
+function is_admin () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_admin;
+}
+
+function is_home () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_home;
+}
+
+function is_404 () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_404;
+}
+
+function is_comments_popup () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_comments_popup;
+}
+
+function is_paged () {
+    global $wp_query;
+
+    return $wp_query-&gt;is_paged;
+}
+
+function get_query_var($var) {
+  global $wp_query;
+
+  return $wp_query-&gt;get($var);
+}
+
+function have_posts() {
+    global $wp_query;
+
+    return $wp_query-&gt;have_posts();
+}
+
+function rewind_posts() {
+    global $wp_query;
+
+    return $wp_query-&gt;rewind_posts();
+}
+
+function the_post() {
+    global $wp_query;
+    $wp_query-&gt;the_post();
+}
+
+function get_theme_root() {
+	return apply_filters('theme_root', ABSPATH . &quot;wp-content/themes&quot;);
+}
+
+function get_theme_root_uri() {
+	return apply_filters('theme_root_uri', get_settings('siteurl') . &quot;/wp-content/themes&quot;, get_settings('siteurl'));
+}
+
+function get_stylesheet() {
+	return apply_filters('stylesheet', get_settings('stylesheet'));
+}
+
+function get_stylesheet_directory() {
+	$stylesheet = get_stylesheet();
+	$stylesheet_dir = get_theme_root() . &quot;/$stylesheet&quot;;
+	return apply_filters('stylesheet_directory', $stylesheet_dir, $stylesheet);
+}
+
+function get_stylesheet_directory_uri() {
+	$stylesheet = get_stylesheet();
+	$stylesheet_dir_uri = get_theme_root_uri() . &quot;/$stylesheet&quot;;
+	return apply_filters('stylesheet_directory_uri', $stylesheet_dir_uri, $stylesheet);
+}
+
+function get_stylesheet_uri() {
+	$stylesheet_dir_uri = get_stylesheet_directory_uri();
+	$stylesheet_uri = $stylesheet_dir_uri . &quot;/style.css&quot;;
+	return apply_filters('stylesheet_uri', $stylesheet_uri, $stylesheet_dir_uri);
+}
+
+function get_template() {
+	return apply_filters('template', get_settings('template'));
+}
+
+function get_template_directory() {
+	$template = get_template();
+	$template_dir = get_theme_root() . &quot;/$template&quot;;
+	return apply_filters('template_directory', $template_dir, $template);
+}
+
+function get_template_directory_uri() {
+	$template = get_template();
+	$template_dir_uri = get_theme_root_uri() . &quot;/$template&quot;;
+	return apply_filters('template_directory_uri', $template_dir_uri, $template);
+}
+
+function get_theme_data($theme_file) {
+	$theme_data = implode('', file($theme_file));
+	preg_match(&quot;|Theme Name:(.*)|i&quot;, $theme_data, $theme_name);
+	preg_match(&quot;|Theme URI:(.*)|i&quot;, $theme_data, $theme_uri);
+	preg_match(&quot;|Description:(.*)|i&quot;, $theme_data, $description);
+	preg_match(&quot;|Author:(.*)|i&quot;, $theme_data, $author_name);
+	preg_match(&quot;|Author URI:(.*)|i&quot;, $theme_data, $author_uri);
+	preg_match(&quot;|Template:(.*)|i&quot;, $theme_data, $template);
+	if ( preg_match(&quot;|Version:(.*)|i&quot;, $theme_data, $version) )
+		$version = $version[1];
+	else
+		$version ='';
+	if ( preg_match(&quot;|Status:(.*)|i&quot;, $theme_data, $status) )
+		$status = $status[1];
+	else
+		$status ='publish';
+
+	$description = wptexturize($description[1]);
+
+	$name = $theme_name[1];
+	$name = trim($name);
+	$theme = $name;
+	if ('' != $theme_uri[1] &amp;&amp; '' != $name) {
+		$theme = '&lt;a href=&quot;' . $theme_uri[1] . '&quot; title=&quot;' . __('Visit theme homepage') . '&quot;&gt;' . $theme . '&lt;/a&gt;';
+	}
+
+	if ('' == $author_uri[1]) {
+		$author = $author_name[1];
+	} else {
+		$author = '&lt;a href=&quot;' . $author_uri[1] . '&quot; title=&quot;' . __('Visit author homepage') . '&quot;&gt;' . $author_name[1] . '&lt;/a&gt;';
+	}
+
+	return array('Name' =&gt; $name, 'Title' =&gt; $theme, 'Description' =&gt; $description, 'Author' =&gt; $author, 'Version' =&gt; $version, 'Template' =&gt; $template[1], 'Status' =&gt; $status);
+}
+
+function get_themes() {
+	global $wp_themes;
+	global $wp_broken_themes;
+
+	if (isset($wp_themes)) {
+		return $wp_themes;
+	}
+
+	$themes = array();
+	$wp_broken_themes = array();
+	$theme_root = get_theme_root();
+	$theme_loc = str_replace(ABSPATH, '', $theme_root);
+
+	// Files in wp-content/themes directory
+	$themes_dir = @ dir($theme_root);
+	if ($themes_dir) {
+		while(($theme_dir = $themes_dir-&gt;read()) !== false) {
+			if (is_dir($theme_root . '/' . $theme_dir)) {
+				if ($theme_dir{0} == '.' || $theme_dir == '..' || $theme_dir == 'CVS') {
+					continue;
+				}
+				$stylish_dir = @ dir($theme_root . '/' . $theme_dir);
+				$found_stylesheet = false;
+				while(($theme_file = $stylish_dir-&gt;read()) !== false) {
+					if ( $theme_file == 'style.css' ) {
+						$theme_files[] = $theme_dir . '/' . $theme_file;
+						$found_stylesheet = true;
+						break;
+					}
+				}
+				if (!$found_stylesheet) {
+					$wp_broken_themes[$theme_dir] = array('Name' =&gt; $theme_dir, 'Title' =&gt; $theme_dir, 'Description' =&gt; __('Stylesheet is missing.'));
+				}
+			}
+		}
+	}
+
+	if (!$themes_dir || !$theme_files) {
+		return $themes;
+	}
+
+	sort($theme_files);
+
+	foreach($theme_files as $theme_file) {
+		$theme_data = get_theme_data(&quot;$theme_root/$theme_file&quot;);
+	  
+		$name = $theme_data['Name']; 
+		$title = $theme_data['Title'];
+		$description = wptexturize($theme_data['Description']);
+		$version = $theme_data['Version'];
+		$author = $theme_data['Author'];
+		$template = $theme_data['Template'];
+		$stylesheet = dirname($theme_file);
+
+		if (empty($name)) {
+			$name = dirname($theme_file);
+			$title = $name;
+		}
+
+		if (empty($template)) {
+			if (file_exists(dirname(&quot;$theme_root/$theme_file/index.php&quot;))) {
+				$template = dirname($theme_file);
+			} else {
+				continue;
+			}
+		}
+
+		$template = trim($template);
+
+		if (! file_exists(&quot;$theme_root/$template/index.php&quot;)) {
+			$wp_broken_themes[$name] = array('Name' =&gt; $name, 'Title' =&gt; $title, 'Description' =&gt; __('Template is missing.'));
+			continue;
+		}
+		
+		$stylesheet_files = array();
+		$stylesheet_dir = @ dir(&quot;$theme_root/$stylesheet&quot;);
+		if ($stylesheet_dir) {
+			while(($file = $stylesheet_dir-&gt;read()) !== false) {
+				if ( !preg_match('|^\.+$|', $file) &amp;&amp; preg_match('|\.css$|', $file) ) 
+					$stylesheet_files[] = &quot;$theme_loc/$stylesheet/$file&quot;;
+			}
+		}
+
+		$template_files = array();		
+		$template_dir = @ dir(&quot;$theme_root/$template&quot;);
+		if ($template_dir) {
+			while(($file = $template_dir-&gt;read()) !== false) {
+				if ( !preg_match('|^\.+$|', $file) &amp;&amp; preg_match('|\.php$|', $file) ) 
+					$template_files[] = &quot;$theme_loc/$template/$file&quot;;
+			}
+		}
+
+		$template_dir = dirname($template_files[0]);
+		$stylesheet_dir = dirname($stylesheet_files[0]);
+
+		if (empty($template_dir)) $template_dir = '/';
+		if (empty($stylesheet_dir)) $stylesheet_dir = '/';
+
+		// Check for theme name collision.  This occurs if a theme is copied to
+		// a new theme directory and the theme header is not updated.  Whichever
+		// theme is first keeps the name.  Subsequent themes get a suffix applied.
+		// The Default and Classic themes always trump their pretenders.
+		if ( isset($themes[$name]) ) {
+			if ( ('WordPress Default' == $name || 'WordPress Classic' == $name) &amp;&amp;
+					 ('default' == $stylesheet || 'classic' == $stylesheet) ) {
+				// If another theme has claimed to be one of our default themes, move
+				// them aside.
+				$suffix = $themes[$name]['Stylesheet'];
+				$new_name = &quot;$name/$suffix&quot;;
+				$themes[$new_name] = $themes[$name];
+				$themes[$new_name]['Name'] = $new_name;
+			} else {
+				$name = &quot;$name/$stylesheet&quot;;
+			}
+		}
+		
+		$themes[$name] = array('Name' =&gt; $name, 'Title' =&gt; $title, 'Description' =&gt; $description, 'Author' =&gt; $author, 'Version' =&gt; $version, 'Template' =&gt; $template, 'Stylesheet' =&gt; $stylesheet, 'Template Files' =&gt; $template_files, 'Stylesheet Files' =&gt; $stylesheet_files, 'Template Dir' =&gt; $template_dir, 'Stylesheet Dir' =&gt; $stylesheet_dir, 'Status' =&gt; $theme_data['Status']);
+	}
+
+	// Resolve theme dependencies.
+	$theme_names = array_keys($themes);
+
+	foreach ($theme_names as $theme_name) {
+		$themes[$theme_name]['Parent Theme'] = '';
+		if ($themes[$theme_name]['Stylesheet'] != $themes[$theme_name]['Template']) {
+			foreach ($theme_names as $parent_theme_name) {
+				if (($themes[$parent_theme_name]['Stylesheet'] == $themes[$parent_theme_name]['Template']) &amp;&amp; ($themes[$parent_theme_name]['Template'] == $themes[$theme_name]['Template'])) {
+					$themes[$theme_name]['Parent Theme'] = $themes[$parent_theme_name]['Name'];
+					break;
+				}
+			}
+		}
+	}
+
+	$wp_themes = $themes;
+
+	return $themes;
+}
+
+function get_theme($theme) {
+	$themes = get_themes();
+
+	if (array_key_exists($theme, $themes)) {
+		return $themes[$theme];
+	}
+
+	return NULL;
+}
+
+function get_current_theme() {
+	$themes = get_themes();
+	$theme_names = array_keys($themes);
+	$current_template = get_settings('template');
+	$current_stylesheet = get_settings('stylesheet');
+	$current_theme = 'WordPress Default';
+
+	if ($themes) {
+		foreach ($theme_names as $theme_name) {
+			if ($themes[$theme_name]['Stylesheet'] == $current_stylesheet &amp;&amp;
+					$themes[$theme_name]['Template'] == $current_template) {
+				$current_theme = $themes[$theme_name]['Name'];
+				break;
+			}
+		}
+	}
+
+	return $current_theme;
+}
+
+function get_query_template($type) {
+	$template = '';
+	if ( file_exists(TEMPLATEPATH . &quot;/{$type}.php&quot;) )
+		$template = TEMPLATEPATH . &quot;/{$type}.php&quot;;
+
+	return apply_filters(&quot;{$type}_template&quot;, $template);
+}
+
+function get_404_template() {
+	return get_query_template('404');
+}
+
+function get_archive_template() {
+	return get_query_template('archive');
+}
+
+function get_author_template() {
+	return get_query_template('author');
+}
+
+function get_category_template() {
+	$template = '';
+	if ( file_exists(TEMPLATEPATH . &quot;/category-&quot; . get_query_var('cat') . '.php') )
+		$template = TEMPLATEPATH . &quot;/category-&quot; . get_query_var('cat') . '.php';
+	else if ( file_exists(TEMPLATEPATH . &quot;/category.php&quot;) )
+		$template = TEMPLATEPATH . &quot;/category.php&quot;;
+
+	return apply_filters('category_template', $template);
+}
+
+function get_date_template() {
+	return get_query_template('date');
+}
+
+function get_home_template() {
+	$template = '';
+
+	if ( file_exists(TEMPLATEPATH . &quot;/home.php&quot;) )
+		$template = TEMPLATEPATH . &quot;/home.php&quot;;
+	else if ( file_exists(TEMPLATEPATH . &quot;/index.php&quot;) )
+		$template = TEMPLATEPATH . &quot;/index.php&quot;;
+
+	return apply_filters('home_template', $template);
+}
+
+function get_page_template() {
+	global $wp_query;
+
+	$id = $wp_query-&gt;post-&gt;ID;	
+	$template = get_post_meta($id, '_wp_page_template', true);
+
+	if ( 'default' == $template )
+		$template = '';
+
+	if ( ! empty($template) &amp;&amp; file_exists(TEMPLATEPATH . &quot;/$template&quot;) )
+		$template = TEMPLATEPATH . &quot;/$template&quot;;
+	else if ( file_exists(TEMPLATEPATH .  &quot;/page.php&quot;) )
+		$template = TEMPLATEPATH .  &quot;/page.php&quot;;
+	else
+		$template = '';
+
+	return apply_filters('page_template', $template);
+}
+
+function get_paged_template() {
+	return get_query_template('paged');
+}
+
+function get_search_template() {
+	return get_query_template('search');
+}
+
+function get_single_template() {
+	return get_query_template('single');
+}
+
+function get_comments_popup_template() {
+	if ( file_exists( TEMPLATEPATH . '/comments-popup.php') )
+		$template = TEMPLATEPATH . '/comments-popup.php';
+	else
+		$template = get_theme_root() . '/default/comments-popup.php';
+
+	return apply_filters('comments_popup_template', $template);
+}
+
+// Borrowed from the PHP Manual user notes. Convert entities, while
+// preserving already-encoded entities:
+function htmlentities2($myHTML) {
+	$translation_table=get_html_translation_table (HTML_ENTITIES,ENT_QUOTES);
+	$translation_table[chr(38)] = '&amp;';
+	return preg_replace(&quot;/&amp;(?![A-Za-z]{0,4}\w{2,3};|#[0-9]{2,3};)/&quot;,&quot;&amp;&quot; , strtr($myHTML, $translation_table));
+}
+
+
+function is_plugin_page() {
+	global $plugin_page;
+
+	if (isset($plugin_page)) {
+		return true;
+	}
+
+	return false;
+}
+
+/*
+add_query_arg: Returns a modified querystring by adding
+a single key &amp; value or an associative array.
+Setting a key value to emptystring removes the key.
+Omitting oldquery_or_uri uses the $_SERVER value.
+
+Parameters:
+add_query_arg(newkey, newvalue, oldquery_or_uri) or
+add_query_arg(associative_array, oldquery_or_uri)
+*/
+function add_query_arg() {
+	$ret = '';
+	if(is_array(func_get_arg(0))) {
+		$uri = @func_get_arg(1);
+	}
+	else {
+		if (@func_num_args() &lt; 3) {
+			$uri = $_SERVER['REQUEST_URI'];
+		} else {
+			$uri = @func_get_arg(2);
+		}
+	}
+
+	if (strstr($uri, '?')) {
+		$parts = explode('?', $uri, 2);
+		if (1 == count($parts)) {
+			$base = '?';
+			$query = $parts[0];
+		}
+		else {
+			$base = $parts[0] . '?';
+			$query = $parts[1];
+		}
+	}
+	else if (strstr($uri, '/')) {
+		$base = $uri . '?';
+		$query = '';
+	} else {
+		$base = '';
+		$query = $uri;
+	}
+
+	parse_str($query, $qs);
+	if (is_array(func_get_arg(0))) {
+		$kayvees = func_get_arg(0);
+		$qs = array_merge($qs, $kayvees);
+	}
+	else
+    {
+			$qs[func_get_arg(0)] = func_get_arg(1);
+    }
+
+	foreach($qs as $k =&gt; $v)
+    {
+			if($v != '')
+        {
+					if($ret != '') $ret .= '&amp;';
+					$ret .= &quot;$k=$v&quot;;
+        }
+    }
+	$ret = $base . $ret;   
+	return trim($ret, '?');
+}
+
+function remove_query_arg($key, $query) {
+	add_query_arg($key, '', $query);
+}
+
+function load_template($file) {
+	global $posts, $post, $wp_did_header, $wp_did_template_redirect, $wp_query,
+		$wp_rewrite, $wpdb;
+
+	extract($wp_query-&gt;query_vars);
+
+	require_once($file);
+}
+
+function add_magic_quotes($array) {
+	foreach ($array as $k =&gt; $v) {
+		if (is_array($v)) {
+			$array[$k] = add_magic_quotes($v);
+		} else {
+			$array[$k] = addslashes($v);
+		}
+	}
+	return $array;
+}
+
+function wp_remote_fopen( $uri ) {
+	if ( ini_get('allow_url_fopen') ) {
+		$fp = fopen( $uri, 'r' );
+		if ( !$fp )
+			return false;
+		$linea = '';
+		while( $remote_read = fread($fp, 4096) )
+			$linea .= $remote_read;
+		fclose($fp);
+		return $linea;		
+	} else if ( function_exists('curl_init') ) {
+		$handle = curl_init();
+		curl_setopt ($handle, CURLOPT_URL, $uri);
+		curl_setopt ($handle, CURLOPT_CONNECTTIMEOUT, 1);
+		curl_setopt ($handle, CURLOPT_RETURNTRANSFER, 1);
+		$buffer = curl_exec($handle);
+		curl_close($handle);
+		return $buffer;
+	} else {
+		return false;
+	}	
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/gettext.php
===================================================================
--- trunk/wp-includes/gettext.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/gettext.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,358 @@
+&lt;?php
+/*
+   Copyright (c) 2003 Danilo Segan &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">danilo at kvota.net</A>&gt;.
+   Copyright (c) 2005 Nico Kaiser &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">nico at siriux.net</A>&gt;
+   
+   This file is part of PHP-gettext.
+
+   PHP-gettext is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   PHP-gettext is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with PHP-gettext; if not, write to the Free Software
+   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+*/
+ 
+/**
+ * Provides a simple gettext replacement that works independently from
+ * the system's gettext abilities.
+ * It can read MO files and use them for translating strings.
+ * The files are passed to gettext_reader as a Stream (see streams.php)
+ * 
+ * This version has the ability to cache all strings and translations to
+ * speed up the string lookup.
+ * While the cache is enabled by default, it can be switched off with the
+ * second parameter in the constructor (e.g. whenusing very large MO files
+ * that you don't want to keep in memory)
+ */
+class gettext_reader {
+  //public:
+   var $error = 0; // public variable that holds error code (0 if no error)
+   
+   //private:
+  var $BYTEORDER = 0;        // 0: low endian, 1: big endian
+  var $STREAM = NULL;
+  var $short_circuit = false;
+  var $enable_cache = false;
+  var $originals = NULL;      // offset of original table
+  var $translations = NULL;    // offset of translation table
+  var $pluralheader = NULL;    // cache header field for plural forms
+  var $total = 0;          // total string count
+  var $table_originals = NULL;  // table for original strings (offsets)
+  var $table_translations = NULL;  // table for translated strings (offsets)
+  var $cache_translations = NULL;  // original -&gt; translation mapping
+
+
+  /* Methods */
+  
+    
+  /**
+   * Reads a 32bit Integer from the Stream
+   * 
+   * @access private
+   * @return Integer from the Stream
+   */
+  function readint() {
+      if ($this-&gt;BYTEORDER == 0) {
+        // low endian
+        return array_shift(unpack('V', $this-&gt;STREAM-&gt;read(4)));
+      } else {
+        // big endian
+        return array_shift(unpack('N', $this-&gt;STREAM-&gt;read(4)));
+      }
+    }
+
+  /**
+   * Reads an array of Integers from the Stream
+   * 
+   * @param int count How many elements should be read
+   * @return Array of Integers
+   */
+  function readintarray($count) {
+    if ($this-&gt;BYTEORDER == 0) {
+        // low endian
+        return unpack('V'.$count, $this-&gt;STREAM-&gt;read(4 * $count));
+      } else {
+        // big endian
+        return unpack('N'.$count, $this-&gt;STREAM-&gt;read(4 * $count));
+      }
+  }
+  
+  /**
+   * Constructor
+   * 
+   * @param object Reader the StreamReader object
+   * @param boolean enable_cache Enable or disable caching of strings (default on)
+   */
+  function gettext_reader($Reader, $enable_cache = true) {
+    // If there isn't a StreamReader, turn on short circuit mode.
+    if (! $Reader) {
+      $this-&gt;short_circuit = true;
+      return;
+    }
+    
+    // Caching can be turned off
+    $this-&gt;enable_cache = $enable_cache;
+
+    // $MAGIC1 = (int)0x950412de; //bug in PHP 5
+    $MAGIC1 = (int) - 1794895138;
+    // $MAGIC2 = (int)0xde120495; //bug
+    $MAGIC2 = (int) - 569244523;
+
+    $this-&gt;STREAM = $Reader;
+    $magic = $this-&gt;readint();
+    if ($magic == $MAGIC1) {
+      $this-&gt;BYTEORDER = 0;
+    } elseif ($magic == $MAGIC2) {
+      $this-&gt;BYTEORDER = 1;
+    } else {
+      $this-&gt;error = 1; // not MO file
+      return false;
+    }
+    
+    // FIXME: Do we care about revision? We should.
+    $revision = $this-&gt;readint();
+    
+    $this-&gt;total = $this-&gt;readint();
+    $this-&gt;originals = $this-&gt;readint();
+    $this-&gt;translations = $this-&gt;readint();
+  }
+  
+  /**
+   * Loads the translation tables from the MO file into the cache
+   * If caching is enabled, also loads all strings into a cache
+   * to speed up translation lookups
+   * 
+   * @access private
+   */
+  function load_tables() {
+    if (is_array($this-&gt;cache_translations) &amp;&amp;
+      is_array($this-&gt;table_originals) &amp;&amp;
+      is_array($this-&gt;table_translations))
+      return;
+    
+    /* get original and translations tables */
+    $this-&gt;STREAM-&gt;seekto($this-&gt;originals);
+    $this-&gt;table_originals = $this-&gt;readintarray($this-&gt;total * 2);
+    $this-&gt;STREAM-&gt;seekto($this-&gt;translations);
+    $this-&gt;table_translations = $this-&gt;readintarray($this-&gt;total * 2);
+    
+    if ($this-&gt;enable_cache) {
+      $this-&gt;cache_translations = array ();
+      /* read all strings in the cache */
+      for ($i = 0; $i &lt; $this-&gt;total; $i++) {
+        $this-&gt;STREAM-&gt;seekto($this-&gt;table_originals[$i * 2 + 2]);
+        $original = $this-&gt;STREAM-&gt;read($this-&gt;table_originals[$i * 2 + 1]);
+        $this-&gt;STREAM-&gt;seekto($this-&gt;table_translations[$i * 2 + 2]);
+        $translation = $this-&gt;STREAM-&gt;read($this-&gt;table_translations[$i * 2 + 1]);
+        $this-&gt;cache_translations[$original] = $translation;
+      }
+    }
+  }
+  
+  /**
+   * Returns a string from the &quot;originals&quot; table
+   * 
+   * @access private
+   * @param int num Offset number of original string
+   * @return string Requested string if found, otherwise ''
+   */
+  function get_original_string($num) {
+    $length = $this-&gt;table_originals[$num * 2 + 1];
+    $offset = $this-&gt;table_originals[$num * 2 + 2];
+    if (! $length)
+      return '';
+    $this-&gt;STREAM-&gt;seekto($offset);
+    $data = $this-&gt;STREAM-&gt;read($length);
+    return (string)$data;
+  }
+  
+  /**
+   * Returns a string from the &quot;translations&quot; table
+   * 
+   * @access private
+   * @param int num Offset number of original string
+   * @return string Requested string if found, otherwise ''
+   */
+  function get_translation_string($num) {
+    $length = $this-&gt;table_translations[$num * 2 + 1];
+    $offset = $this-&gt;table_translations[$num * 2 + 2];
+    if (! $length)
+      return '';
+    $this-&gt;STREAM-&gt;seekto($offset);
+    $data = $this-&gt;STREAM-&gt;read($length);
+    return (string)$data;
+  }
+  
+  /**
+   * Binary search for string
+   * 
+   * @access private
+   * @param string string
+   * @param int start (internally used in recursive function)
+   * @param int end (internally used in recursive function)
+   * @return int string number (offset in originals table)
+   */
+  function find_string($string, $start = -1, $end = -1) {
+    if (($start == -1) or ($end == -1)) {
+      // find_string is called with only one parameter, set start end end
+      $start = 0;
+      $end = $this-&gt;total;
+    }
+    if (abs($start - $end) &lt;= 1) {
+      // We're done, now we either found the string, or it doesn't exist
+      $txt = $this-&gt;get_original_string($start);
+      if ($string == $txt)
+        return $start;
+      else
+        return -1;
+    } else if ($start &gt; $end) {
+      // start &gt; end -&gt; turn around and start over
+      return $this-&gt;find_string($string, $end, $start);
+    } else {
+      // Divide table in two parts
+      $half = (int)(($start + $end) / 2);
+      $cmp = strcmp($string, $this-&gt;get_original_string($half));
+      if ($cmp == 0)
+        // string is exactly in the middle =&gt; return it
+        return $half;
+      else if ($cmp &lt; 0)
+        // The string is in the upper half
+        return $this-&gt;find_string($string, $start, $half);
+      else
+        // The string is in the lower half
+        return $this-&gt;find_string($string, $half, $end);
+    }
+  }
+  
+  /**
+   * Translates a string
+   * 
+   * @access public
+   * @param string string to be translated
+   * @return string translated string (or original, if not found)
+   */
+  function translate($string) {
+    if ($this-&gt;short_circuit)
+      return $string;
+    $this-&gt;load_tables();     
+    
+    if ($this-&gt;enable_cache) {
+      // Caching enabled, get translated string from cache
+      if (array_key_exists($string, $this-&gt;cache_translations))
+        return $this-&gt;cache_translations[$string];
+      else
+        return $string;
+    } else {
+      // Caching not enabled, try to find string
+      $num = $this-&gt;find_string($string);
+      if ($num == -1)
+        return $string;
+      else
+        return $this-&gt;get_translation_string($num);
+    }
+  }
+
+  /**
+   * Get possible plural forms from MO header
+   * 
+   * @access private
+   * @return string plural form header
+   */
+  function get_plural_forms() {
+    // lets assume message number 0 is header  
+    // this is true, right?
+    $this-&gt;load_tables();
+    
+    // cache header field for plural forms
+    if (! is_string($this-&gt;pluralheader)) {
+      if ($this-&gt;enable_cache) {
+        $header = $this-&gt;cache_translations[&quot;&quot;];
+      } else {
+        $header = $this-&gt;get_translation_string(0);
+      }
+      if (eregi(&quot;plural-forms: (.*)\n&quot;, $header, $regs))
+        $expr = $regs[1];
+      else
+        $expr = &quot;nplurals=2; plural=n == 1 ? 0 : 1;&quot;;
+      $this-&gt;pluralheader = $expr;
+    }
+    return $this-&gt;pluralheader;
+  }
+
+  /**
+   * Detects which plural form to take
+   * 
+   * @access private
+   * @param n count
+   * @return int array index of the right plural form
+   */
+  function select_string($n) {
+    $string = $this-&gt;get_plural_forms();
+    $string = str_replace('nplurals',&quot;\$total&quot;,$string);
+    $string = str_replace(&quot;n&quot;,$n,$string);
+    $string = str_replace('plural',&quot;\$plural&quot;,$string);
+    
+    $total = 0;
+    $plural = 0;
+
+    eval(&quot;$string&quot;);
+    if ($plural &gt;= $total) $plural = 0;
+    return $plural;
+  }
+
+  /**
+   * Plural version of gettext
+   * 
+   * @access public
+   * @param string single
+   * @param string plural
+   * @param string number
+   * @return translated plural form
+   */
+  function ngettext($single, $plural, $number) {
+    if ($this-&gt;short_circuit) {
+      if ($number != 1)
+        return $plural;
+      else
+        return $single;
+    }
+
+    // find out the appropriate form
+    $select = $this-&gt;select_string($number); 
+    
+    // this should contains all strings separated by NULLs
+    $key = $single.chr(0).$plural;
+    
+    
+    if ($this-&gt;enable_cache) {
+      if (! array_key_exists($key, $this-&gt;cache_translations)) {
+        return ($number != 1) ? $plural : $single;
+      } else {
+        $result = $this-&gt;cache_translations[$key];
+        $list = explode(chr(0), $result);
+        return $list[$select];
+      }
+    } else {
+      $num = $this-&gt;find_string($key);
+      if ($num == -1) {
+        return ($number != 1) ? $plural : $single;
+      } else {
+        $result = $this-&gt;get_translation_string($num);
+        $list = explode(chr(0), $result);
+        return $list[$select];
+      }
+    }
+  }
+
+}
+
+?&gt;

Added: trunk/wp-includes/kses.php
===================================================================
--- trunk/wp-includes/kses.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/kses.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,563 @@
+&lt;?php
+// Added wp_ prefix to avoid conflicts with existing kses users
+# kses 0.2.1 - HTML/XHTML filter that only allows some elements and attributes
+# Copyright (C) 2002, 2003  Ulf Harnhammar
+# *** CONTACT INFORMATION ***
+#
+# E-mail:      metaur at users dot sourceforge dot net
+# Web page:    <A HREF="http://sourceforge.net/projects/kses">http://sourceforge.net/projects/kses</A>
+# Paper mail:  (not at the moment)
+#
+# [kses strips evil scripts!]
+if (!defined('CUSTOM_TAGS'))
+	define('CUSTOM_TAGS', false);
+	
+// You can override this in your my-hacks.php file
+if (!CUSTOM_TAGS) {
+$allowedtags = array(
+	'a' =&gt; array(
+		'href' =&gt; array(),
+		'title' =&gt; array()
+		),
+	'abbr' =&gt; array('title' =&gt; array()),
+	'acronym' =&gt; array('title' =&gt; array()),
+	'b' =&gt; array(),
+	'blockquote' =&gt; array('cite' =&gt; array()),
+//	'br' =&gt; array(),
+	'code' =&gt; array(),
+//	'del' =&gt; array('datetime' =&gt; array()),
+//	'dd' =&gt; array(),
+//	'dl' =&gt; array(),
+//	'dt' =&gt; array(),
+	'em' =&gt; array(),
+	'i' =&gt; array(),
+//	'ins' =&gt; array('datetime' =&gt; array(), 'cite' =&gt; array()),
+//	'li' =&gt; array(),
+//	'ol' =&gt; array(),
+//	'p' =&gt; array(),
+//	'q' =&gt; array(),
+	'strike' =&gt; array(),
+	'strong' =&gt; array(),
+//	'sub' =&gt; array(),
+//	'sup' =&gt; array(),
+//	'u' =&gt; array(),
+//	'ul' =&gt; array(),
+	);
+}
+function wp_kses($string, $allowed_html, $allowed_protocols =
+               array('http', 'https', 'ftp', 'news', 'nntp', 'feed', 'gopher', 'mailto'))
+###############################################################################
+# This function makes sure that only the allowed HTML element names, attribute
+# names and attribute values plus only sane HTML entities will occur in
+# $string. You have to remove any slashes from PHP's magic quotes before you
+# call this function.
+###############################################################################
+{
+  $string = wp_kses_no_null($string);
+  $string = wp_kses_js_entities($string);
+  $string = wp_kses_normalize_entities($string);
+  $string = wp_kses_hook($string);
+  $allowed_html_fixed = wp_kses_array_lc($allowed_html);
+  return wp_kses_split($string, $allowed_html_fixed, $allowed_protocols);
+} # function wp_kses
+
+
+function wp_kses_hook($string)
+###############################################################################
+# You add any kses hooks here.
+###############################################################################
+{
+  return $string;
+} # function wp_kses_hook
+
+
+function wp_kses_version()
+###############################################################################
+# This function returns kses' version number.
+###############################################################################
+{
+  return '0.2.1';
+} # function wp_kses_version
+
+
+function wp_kses_split($string, $allowed_html, $allowed_protocols)
+###############################################################################
+# This function searches for HTML tags, no matter how malformed. It also
+# matches stray &quot;&gt;&quot; characters.
+###############################################################################
+{
+  return preg_replace('%(&lt;'.   # EITHER: &lt;
+                      '[^&gt;]*'. # things that aren't &gt;
+                      '(&gt;|$)'. # &gt; or end of string
+                      '|&gt;)%e', # OR: just a &gt;
+                      &quot;wp_kses_split2('\\1', \$allowed_html, &quot;.
+                      '$allowed_protocols)',
+                      $string);
+} # function wp_kses_split
+
+
+function wp_kses_split2($string, $allowed_html, $allowed_protocols)
+###############################################################################
+# This function does a lot of work. It rejects some very malformed things
+# like &lt;:::&gt;. It returns an empty string, if the element isn't allowed (look
+# ma, no strip_tags()!). Otherwise it splits the tag into an element and an
+# attribute list.
+###############################################################################
+{
+  $string = wp_kses_stripslashes($string);
+
+  if (substr($string, 0, 1) != '&lt;')
+    return '&gt;';
+    # It matched a &quot;&gt;&quot; character
+
+  if (!preg_match('%^&lt;\s*(/\s*)?([a-zA-Z0-9]+)([^&gt;]*)&gt;?$%', $string, $matches))
+    return '';
+    # It's seriously malformed
+
+  $slash = trim($matches[1]);
+  $elem = $matches[2];
+  $attrlist = $matches[3];
+
+  if (!is_array($allowed_html[strtolower($elem)]))
+    return '';
+    # They are using a not allowed HTML element
+
+  return wp_kses_attr(&quot;$slash$elem&quot;, $attrlist, $allowed_html,
+                   $allowed_protocols);
+} # function wp_kses_split2
+
+
+function wp_kses_attr($element, $attr, $allowed_html, $allowed_protocols)
+###############################################################################
+# This function removes all attributes, if none are allowed for this element.
+# If some are allowed it calls wp_kses_hair() to split them further, and then it
+# builds up new HTML code from the data that kses_hair() returns. It also
+# removes &quot;&lt;&quot; and &quot;&gt;&quot; characters, if there are any left. One more thing it
+# does is to check if the tag has a closing XHTML slash, and if it does,
+# it puts one in the returned code as well.
+###############################################################################
+{
+# Is there a closing XHTML slash at the end of the attributes?
+
+  $xhtml_slash = '';
+  if (preg_match('%\s/\s*$%', $attr))
+    $xhtml_slash = ' /';
+
+# Are any attributes allowed at all for this element?
+
+  if (count($allowed_html[strtolower($element)]) == 0)
+    return &quot;&lt;$element$xhtml_slash&gt;&quot;;
+
+# Split it
+
+  $attrarr = wp_kses_hair($attr, $allowed_protocols);
+
+# Go through $attrarr, and save the allowed attributes for this element
+# in $attr2
+
+  $attr2 = '';
+
+  foreach ($attrarr as $arreach)
+  {
+    $current = $allowed_html[strtolower($element)]
+                            [strtolower($arreach['name'])];
+    if ($current == '')
+      continue; # the attribute is not allowed
+
+    if (!is_array($current))
+      $attr2 .= ' '.$arreach['whole'];
+    # there are no checks
+
+    else
+    {
+    # there are some checks
+      $ok = true;
+      foreach ($current as $currkey =&gt; $currval)
+        if (!wp_kses_check_attr_val($arreach['value'], $arreach['vless'],
+                                 $currkey, $currval))
+        { $ok = false; break; }
+
+      if ($ok)
+        $attr2 .= ' '.$arreach['whole']; # it passed them
+    } # if !is_array($current)
+  } # foreach
+
+# Remove any &quot;&lt;&quot; or &quot;&gt;&quot; characters
+
+  $attr2 = preg_replace('/[&lt;&gt;]/', '', $attr2);
+
+  return &quot;&lt;$element$attr2$xhtml_slash&gt;&quot;;
+} # function wp_kses_attr
+
+
+function wp_kses_hair($attr, $allowed_protocols)
+###############################################################################
+# This function does a lot of work. It parses an attribute list into an array
+# with attribute data, and tries to do the right thing even if it gets weird
+# input. It will add quotes around attribute values that don't have any quotes
+# or apostrophes around them, to make it easier to produce HTML code that will
+# conform to W3C's HTML specification. It will also remove bad URL protocols
+# from attribute values.
+###############################################################################
+{
+  $attrarr = array();
+  $mode = 0;
+  $attrname = '';
+
+# Loop through the whole attribute list
+
+  while (strlen($attr) != 0)
+  {
+    $working = 0; # Was the last operation successful?
+
+    switch ($mode)
+    {
+      case 0: # attribute name, href for instance
+
+        if (preg_match('/^([-a-zA-Z]+)/', $attr, $match))
+        {
+          $attrname = $match[1];
+          $working = $mode = 1;
+          $attr = preg_replace('/^[-a-zA-Z]+/', '', $attr);
+        }
+
+        break;
+
+      case 1: # equals sign or valueless (&quot;selected&quot;)
+
+        if (preg_match('/^\s*=\s*/', $attr)) # equals sign
+        {
+          $working = 1; $mode = 2;
+          $attr = preg_replace('/^\s*=\s*/', '', $attr);
+          break;
+        }
+
+        if (preg_match('/^\s+/', $attr)) # valueless
+        {
+          $working = 1; $mode = 0;
+          $attrarr[] = array
+                        ('name'  =&gt; $attrname,
+                         'value' =&gt; '',
+                         'whole' =&gt; $attrname,
+                         'vless' =&gt; 'y');
+          $attr = preg_replace('/^\s+/', '', $attr);
+        }
+
+        break;
+
+      case 2: # attribute value, a URL after href= for instance
+
+        if (preg_match('/^&quot;([^&quot;]*)&quot;(\s+|$)/', $attr, $match))
+         # &quot;value&quot;
+        {
+          $thisval = wp_kses_bad_protocol($match[1], $allowed_protocols);
+
+          $attrarr[] = array
+                        ('name'  =&gt; $attrname,
+                         'value' =&gt; $thisval,
+                         'whole' =&gt; &quot;$attrname=\&quot;$thisval\&quot;&quot;,
+                         'vless' =&gt; 'n');
+          $working = 1; $mode = 0;
+          $attr = preg_replace('/^&quot;[^&quot;]*&quot;(\s+|$)/', '', $attr);
+          break;
+        }
+
+        if (preg_match(&quot;/^'([^']*)'(\s+|$)/&quot;, $attr, $match))
+         # 'value'
+        {
+          $thisval = wp_kses_bad_protocol($match[1], $allowed_protocols);
+
+          $attrarr[] = array
+                        ('name'  =&gt; $attrname,
+                         'value' =&gt; $thisval,
+                         'whole' =&gt; &quot;$attrname='$thisval'&quot;,
+                         'vless' =&gt; 'n');
+          $working = 1; $mode = 0;
+          $attr = preg_replace(&quot;/^'[^']*'(\s+|$)/&quot;, '', $attr);
+          break;
+        }
+
+        if (preg_match(&quot;%^([^\s\&quot;']+)(\s+|$)%&quot;, $attr, $match))
+         # value
+        {
+          $thisval = wp_kses_bad_protocol($match[1], $allowed_protocols);
+
+          $attrarr[] = array
+                        ('name'  =&gt; $attrname,
+                         'value' =&gt; $thisval,
+                         'whole' =&gt; &quot;$attrname=\&quot;$thisval\&quot;&quot;,
+                         'vless' =&gt; 'n');
+                         # We add quotes to conform to W3C's HTML spec.
+          $working = 1; $mode = 0;
+          $attr = preg_replace(&quot;%^[^\s\&quot;']+(\s+|$)%&quot;, '', $attr);
+        }
+
+        break;
+    } # switch
+
+    if ($working == 0) # not well formed, remove and try again
+    {
+      $attr = wp_kses_html_error($attr);
+      $mode = 0;
+    }
+  } # while
+
+  if ($mode == 1)
+  # special case, for when the attribute list ends with a valueless
+  # attribute like &quot;selected&quot;
+    $attrarr[] = array
+                  ('name'  =&gt; $attrname,
+                   'value' =&gt; '',
+                   'whole' =&gt; $attrname,
+                   'vless' =&gt; 'y');
+
+  return $attrarr;
+} # function wp_kses_hair
+
+
+function wp_kses_check_attr_val($value, $vless, $checkname, $checkvalue)
+###############################################################################
+# This function performs different checks for attribute values. The currently
+# implemented checks are &quot;maxlen&quot;, &quot;minlen&quot;, &quot;maxval&quot;, &quot;minval&quot; and &quot;valueless&quot;
+# with even more checks to come soon.
+###############################################################################
+{
+  $ok = true;
+
+  switch (strtolower($checkname))
+  {
+    case 'maxlen':
+    # The maxlen check makes sure that the attribute value has a length not
+    # greater than the given value. This can be used to avoid Buffer Overflows
+    # in WWW clients and various Internet servers.
+
+      if (strlen($value) &gt; $checkvalue)
+        $ok = false;
+      break;
+
+    case 'minlen':
+    # The minlen check makes sure that the attribute value has a length not
+    # smaller than the given value.
+
+      if (strlen($value) &lt; $checkvalue)
+        $ok = false;
+      break;
+
+    case 'maxval':
+    # The maxval check does two things: it checks that the attribute value is
+    # an integer from 0 and up, without an excessive amount of zeroes or
+    # whitespace (to avoid Buffer Overflows). It also checks that the attribute
+    # value is not greater than the given value.
+    # This check can be used to avoid Denial of Service attacks.
+
+      if (!preg_match('/^\s{0,6}[0-9]{1,6}\s{0,6}$/', $value))
+        $ok = false;
+      if ($value &gt; $checkvalue)
+        $ok = false;
+      break;
+
+    case 'minval':
+    # The minval check checks that the attribute value is a positive integer,
+    # and that it is not smaller than the given value.
+
+      if (!preg_match('/^\s{0,6}[0-9]{1,6}\s{0,6}$/', $value))
+        $ok = false;
+      if ($value &lt; $checkvalue)
+        $ok = false;
+      break;
+
+    case 'valueless':
+    # The valueless check checks if the attribute has a value
+    # (like &lt;a href=&quot;blah&quot;&gt;) or not (&lt;option selected&gt;). If the given value
+    # is a &quot;y&quot; or a &quot;Y&quot;, the attribute must not have a value.
+    # If the given value is an &quot;n&quot; or an &quot;N&quot;, the attribute must have one.
+
+      if (strtolower($checkvalue) != $vless)
+        $ok = false;
+      break;
+  } # switch
+
+  return $ok;
+} # function wp_kses_check_attr_val
+
+
+function wp_kses_bad_protocol($string, $allowed_protocols)
+###############################################################################
+# This function removes all non-allowed protocols from the beginning of
+# $string. It ignores whitespace and the case of the letters, and it does
+# understand HTML entities. It does its work in a while loop, so it won't be
+# fooled by a string like &quot;javascript:javascript:alert(57)&quot;.
+###############################################################################
+{
+  $string = wp_kses_no_null($string);
+  $string2 = $string.'a';
+
+  while ($string != $string2)
+  {
+    $string2 = $string;
+    $string = wp_kses_bad_protocol_once($string, $allowed_protocols);
+  } # while
+
+  return $string;
+} # function wp_kses_bad_protocol
+
+
+function wp_kses_no_null($string)
+###############################################################################
+# This function removes any NULL or chr(173) characters in $string.
+###############################################################################
+{
+  $string = preg_replace('/\0+/', '', $string);
+  $string = preg_replace('/(\\\\0)+/', '', $string);
+
+  return $string;
+} # function wp_kses_no_null
+
+
+function wp_kses_stripslashes($string)
+###############################################################################
+# This function changes the character sequence  \&quot;  to just  &quot;
+# It leaves all other slashes alone. It's really weird, but the quoting from
+# preg_replace(//e) seems to require this.
+###############################################################################
+{
+  return preg_replace('%\\\\&quot;%', '&quot;', $string);
+} # function wp_kses_stripslashes
+
+
+function wp_kses_array_lc($inarray)
+###############################################################################
+# This function goes through an array, and changes the keys to all lower case.
+###############################################################################
+{
+  $outarray = array();
+
+  foreach ($inarray as $inkey =&gt; $inval)
+  {
+    $outkey = strtolower($inkey);
+    $outarray[$outkey] = array();
+
+    foreach ($inval as $inkey2 =&gt; $inval2)
+    {
+      $outkey2 = strtolower($inkey2);
+      $outarray[$outkey][$outkey2] = $inval2;
+    } # foreach $inval
+  } # foreach $inarray
+
+  return $outarray;
+} # function wp_kses_array_lc
+
+
+function wp_kses_js_entities($string)
+###############################################################################
+# This function removes the HTML JavaScript entities found in early versions of
+# Netscape 4.
+###############################################################################
+{
+  return preg_replace('%&amp;\s*\{[^}]*(\}\s*;?|$)%', '', $string);
+} # function wp_kses_js_entities
+
+
+function wp_kses_html_error($string)
+###############################################################################
+# This function deals with parsing errors in wp_kses_hair(). The general plan is
+# to remove everything to and including some whitespace, but it deals with
+# quotes and apostrophes as well.
+###############################################################################
+{
+  return preg_replace('/^(&quot;[^&quot;]*(&quot;|$)|\'[^\']*(\'|$)|\S)*\s*/', '', $string);
+} # function wp_kses_html_error
+
+
+function wp_kses_bad_protocol_once($string, $allowed_protocols)
+###############################################################################
+# This function searches for URL protocols at the beginning of $string, while
+# handling whitespace and HTML entities.
+###############################################################################
+{
+  return preg_replace('/^((&amp;[^;]*;|[\sA-Za-z0-9])*)'.
+                      '(:|&#58;|&amp;#[Xx]3[Aa];)\s*/e',
+                      'wp_kses_bad_protocol_once2(&quot;\\1&quot;, $allowed_protocols)',
+                      $string);
+} # function wp_kses_bad_protocol_once
+
+
+function wp_kses_bad_protocol_once2($string, $allowed_protocols)
+###############################################################################
+# This function processes URL protocols, checks to see if they're in the white-
+# list or not, and returns different data depending on the answer.
+###############################################################################
+{
+  $string2 = wp_kses_decode_entities($string);
+  $string2 = preg_replace('/\s/', '', $string2);
+  $string2 = wp_kses_no_null($string2);
+  $string2 = strtolower($string2);
+
+  $allowed = false;
+  foreach ($allowed_protocols as $one_protocol)
+    if (strtolower($one_protocol) == $string2)
+    {
+      $allowed = true;
+      break;
+    }
+
+  if ($allowed)
+    return &quot;$string2:&quot;;
+  else
+    return '';
+} # function wp_kses_bad_protocol_once2
+
+
+function wp_kses_normalize_entities($string)
+###############################################################################
+# This function normalizes HTML entities. It will convert &quot;AT&amp;T&quot; to the correct
+# &quot;AT&amp;T&quot;, &quot;&#00058;&quot; to &quot;&#58;&quot;, &quot;&amp;#XYZZY;&quot; to &quot;&amp;#XYZZY;&quot; and so on.
+###############################################################################
+{
+# Disarm all entities by converting &amp; to &amp;
+
+  $string = str_replace('&amp;', '&amp;', $string);
+
+# Change back the allowed entities in our entity whitelist
+
+  $string = preg_replace('/&amp;([A-Za-z][A-Za-z0-9]{0,19});/',
+                         '&amp;\\1;', $string);
+  $string = preg_replace('/&amp;#0*([0-9]{1,5});/e',
+                         'wp_kses_normalize_entities2(&quot;\\1&quot;)', $string);
+  $string = preg_replace('/&amp;#([Xx])0*(([0-9A-Fa-f]{2}){1,2});/',
+                         '&amp;#\\1\\2;', $string);
+
+  return $string;
+} # function wp_kses_normalize_entities
+
+
+function wp_kses_normalize_entities2($i)
+###############################################################################
+# This function helps wp_kses_normalize_entities() to only accept 16 bit values
+# and nothing more for &amp;#number; entities.
+###############################################################################
+{
+  return (($i &gt; 65535) ? &quot;&amp;#$i;&quot; : &quot;&amp;#$i;&quot;);
+} # function wp_kses_normalize_entities2
+
+
+function wp_kses_decode_entities($string)
+###############################################################################
+# This function decodes numeric HTML entities (&#65; and &amp;#x41;). It doesn't
+# do anything with other entities like &auml;, but we don't need them in the
+# URL protocol whitelisting system anyway.
+###############################################################################
+{
+  $string = preg_replace('/&amp;#([0-9]+);/e', 'chr(&quot;\\1&quot;)', $string);
+  $string = preg_replace('/&amp;#[Xx]([0-9A-Fa-f]+);/e', 'chr(hexdec(&quot;\\1&quot;))',
+                         $string);
+
+  return $string;
+} # function wp_kses_decode_entities
+
+function wp_filter_kses( $string ) {
+	global $allowedtags;
+	return wp_kses($string, $allowedtags);
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/links.php
===================================================================
--- trunk/wp-includes/links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,568 @@
+&lt;?php
+
+/** function get_linksbyname()
+ ** Gets the links associated with category 'cat_name'.
+ ** Parameters:
+ **   cat_name (default 'noname')  - The category name to use. If no
+ **     match is found uses all
+ **   before (default '')  - the html to output before the link
+ **   after (default '&lt;br /&gt;')  - the html to output after the link
+ **   between (default ' ')  - the html to output between the link/image
+ **     and it's description. Not used if no image or show_images == true
+ **   show_images (default true) - whether to show images (if defined).
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url', 'description' or 'rating'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   show_description (default true) - whether to show the description if
+ **     show_images=false/not defined
+ **   show_rating (default false) - show rating stars/chars
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **   show_updated (default 0) - whether to show last updated timestamp
+ */
+function get_linksbyname($cat_name = &quot;noname&quot;, $before = '', $after = '&lt;br /&gt;',
+                         $between = &quot; &quot;, $show_images = true, $orderby = 'id',
+                         $show_description = true, $show_rating = false,
+                         $limit = -1, $show_updated = 0) {
+    global $wpdb;
+    $cat_id = -1;
+    $results = $wpdb-&gt;get_results(&quot;SELECT cat_id FROM $wpdb-&gt;linkcategories WHERE cat_name='$cat_name'&quot;);
+    if ($results) {
+        foreach ($results as $result) {
+            $cat_id = $result-&gt;cat_id;
+        }
+    }
+    get_links($cat_id, $before, $after, $between, $show_images, $orderby,
+              $show_description, $show_rating, $limit, $show_updated);
+}
+
+function bool_from_yn($yn) {
+    if ($yn == 'Y') return 1;
+    return 0;
+}
+
+/** function wp_get_linksbyname()
+ ** Gets the links associated with the named category.
+ ** Parameters:
+ **   category (no default)  - The category to use.
+ **/
+function wp_get_linksbyname($category, $args = '') {
+	global $wpdb;
+
+	$cat = $wpdb-&gt;get_row(&quot;SELECT cat_id, cat_name, auto_toggle, show_images, show_description, &quot;
+												. &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, &quot;
+												. &quot; text_after_all, list_limit FROM $wpdb-&gt;linkcategories WHERE cat_name='$category'&quot;);
+
+	if (! $cat) {
+		return;
+	}
+
+	if (empty($args)) {
+		if ($cat-&gt;sort_desc == 'Y') {
+			$cat-&gt;sort_order = '_'.$cat-&gt;sort_order;
+		}
+		get_links($cat-&gt;cat_id, $cat-&gt;text_before_link, $cat-&gt;text_after_all,
+							$cat-&gt;text_after_link, bool_from_yn($cat-&gt;show_images), $cat-&gt;sort_order,
+							bool_from_yn($cat-&gt;show_description), bool_from_yn($cat-&gt;show_rating),
+							$cat-&gt;list_limit, bool_from_yn($cat-&gt;show_updated));
+	} else {
+		$args = add_query_arg('category', $cat-&gt;cat_id, $args);
+		wp_get_links($args);
+	}
+} // end wp_get_linksbyname
+
+/** function wp_get_links()
+ ** Gets the links associated with category n.
+ ** Parameters:
+ **   category (no default)  - The category to use.
+ ** or:
+ **   a query string
+ **/
+function wp_get_links($args = '') {
+	global $wpdb;
+
+	if (!empty($args) &amp;&amp; false === strpos($args, '=')) {
+		// If args is not a query string, it's a category id.
+		$category = $args;
+		$cat = $wpdb-&gt;get_row(&quot;SELECT cat_id, cat_name, auto_toggle, show_images, show_description, &quot;
+													. &quot; show_rating, show_updated, sort_order, sort_desc, text_before_link, text_after_link, &quot;
+													. &quot; text_after_all, list_limit FROM $wpdb-&gt;linkcategories WHERE cat_id=$category&quot;);
+		if ($cat) {
+			if ($cat-&gt;sort_desc == 'Y') {
+				$cat-&gt;sort_order = '_'.$cat-&gt;sort_order;
+			}
+			get_links($cat-&gt;cat_id, $cat-&gt;text_before_link, $cat-&gt;text_after_all,
+								$cat-&gt;text_after_link, bool_from_yn($cat-&gt;show_images), $cat-&gt;sort_order,
+								bool_from_yn($cat-&gt;show_description), bool_from_yn($cat-&gt;show_rating),
+								$cat-&gt;list_limit, bool_from_yn($cat-&gt;show_updated));
+		}
+	} else {
+		parse_str($args);
+
+		if (! isset($category))	$category = -1;
+		if (! isset($before)) $before = '';
+		if (! isset($after)) $after = '&lt;br /&gt;';
+		if (! isset($between))	$between = ' ';
+		if (! isset($show_images)) $show_images = true;
+		if (! isset($orderby)) $orderby = 'name';
+		if (! isset($show_description)) $show_description = true;
+		if (! isset($show_rating)) $show_rating = false;
+		if (! isset($limit)) $limit = -1;
+		if (! isset($show_updated)) $show_updated = 1;
+		if (! isset($echo)) $echo = true;
+
+		get_links($category, $before, $after, $between, $show_images, $orderby, $show_description, $show_rating, $limit, $show_updated, $echo);
+	}
+} // end wp_get_links
+
+/** function get_links()
+ ** Gets the links associated with category n.
+ ** Parameters:
+ **   category (default -1)  - The category to use. If no category supplied
+ **      uses all
+ **   before (default '')  - the html to output before the link
+ **   after (default '&lt;br /&gt;')  - the html to output after the link
+ **   between (default ' ')  - the html to output between the link/image
+ **     and it's description. Not used if no image or show_images == true
+ **   show_images (default true) - whether to show images (if defined).
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url', 'description', or 'rating'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   show_description (default true) - whether to show the description if
+ **    show_images=false/not defined .
+ **   show_rating (default false) - show rating stars/chars
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **   show_updated (default 0) - whether to show last updated timestamp
+ */
+function get_links($category = -1, $before = '', $after = '&lt;br /&gt;',
+                   $between = ' ', $show_images = true, $orderby = 'name',
+                   $show_description = true, $show_rating = false,
+                   $limit = -1, $show_updated = 1, $echo = true) {
+
+    global $wpdb;
+
+    $direction = ' ASC';
+    $category_query = &quot;&quot;;
+    if ($category != -1) {
+        $category_query = &quot; AND link_category = $category &quot;;
+    }
+    if (get_settings('links_recently_updated_time')) {
+        $recently_updated_test = &quot;, IF (DATE_ADD(link_updated, INTERVAL &quot;.get_settings('links_recently_updated_time').&quot; MINUTE) &gt;= NOW(), 1,0) as recently_updated &quot;;
+    } else {
+		$recently_updated_test = '';
+	}
+    if ($show_updated) {
+        $get_updated = &quot;, UNIX_TIMESTAMP(link_updated) AS link_updated_f &quot;;
+    }
+
+    $orderby=strtolower($orderby);
+    if ($orderby == '')
+        $orderby = 'id';
+    if (substr($orderby,0,1) == '_') {
+        $direction = ' DESC';
+        $orderby = substr($orderby,1);
+    }
+
+    switch($orderby) {
+        case 'length':
+        $length = &quot;,CHAR_LENGTH(link_name) AS length&quot;;
+        break;
+        case 'rand':
+            $orderby = 'rand()';
+            break;
+        default:
+            $orderby = &quot; link_&quot; . $orderby;
+    }
+
+    if (!isset($length)) {
+		$length = &quot;&quot;;
+	}
+
+    $sql = &quot;SELECT link_url, link_name, link_image, link_target,
+            link_description, link_rating, link_rel $length $recently_updated_test $get_updated
+            FROM $wpdb-&gt;links
+            WHERE link_visible = 'Y' &quot; .
+           $category_query;
+    $sql .= ' ORDER BY ' . $orderby;
+    $sql .= $direction;
+    /* The next 2 lines implement LIMIT TO processing */
+    if ($limit != -1)
+        $sql .= &quot; LIMIT $limit&quot;;
+    //echo $sql;
+    $results = $wpdb-&gt;get_results($sql);
+    if (!$results) {
+        return;
+    }
+    
+    $output = &quot;&quot;;
+    
+    foreach ($results as $row) {
+		if (!isset($row-&gt;recently_updated)) $row-&gt;recently_updated = false;
+        $output .= ($before);
+        
+        if ($show_updated &amp;&amp; $row-&gt;recently_updated) {
+            $output .= get_settings('links_recently_updated_prepend');
+        }
+        
+        $the_link = '#';
+        
+        if ( !empty($row-&gt;link_url) )
+            $the_link = wp_specialchars($row-&gt;link_url);
+        $rel = $row-&gt;link_rel;
+        
+        if ($rel != '') {
+            $rel = &quot; rel='$rel'&quot;;
+        }
+        
+        $desc = wp_specialchars($row-&gt;link_description, ENT_QUOTES);
+        $name = wp_specialchars($row-&gt;link_name, ENT_QUOTES);
+
+        $title = $desc;
+
+        if ($show_updated) {
+           if (substr($row-&gt;link_updated_f,0,2) != '00') {
+                $title .= ' (Last updated ' . date(get_settings('links_updated_date_format'), $row-&gt;link_updated_f + (get_settings('gmt_offset') * 3600)) .')';
+            }
+        }
+
+        if ('' != $title) {
+            $title = &quot; title='$title'&quot;;
+        }
+
+        $alt = &quot; alt='$name'&quot;;
+            
+        $target = $row-&gt;link_target;
+        if ('' != $target) {
+            $target = &quot; target='$target'&quot;;
+        }
+        
+        $output.= &quot;&lt;a href='$the_link'&quot;;
+        $output.= $rel . $title . $target;
+        $output.= '&gt;';
+        
+        if (($row-&gt;link_image != null) &amp;&amp; $show_images) {
+			if (strstr($row-&gt;link_image, 'http'))
+				$output.= &quot;&lt;img src='$row-&gt;link_image' $alt $title /&gt;&quot;;
+			else // If it's a relative path
+            	$output.= &quot;&lt;img src='&quot; . get_settings('siteurl') . &quot;$row-&gt;link_image' $alt $title /&gt;&quot;;
+        } else {
+            $output.= $name;
+        }
+        
+        $output.= '&lt;/a&gt;';
+        
+        if ($show_updated &amp;&amp; $row-&gt;recently_updated) {
+            $output.= get_settings('links_recently_updated_append');
+        }
+
+        if ($show_description &amp;&amp; ($desc != '')) {
+            $output.= $between.$desc;
+        }
+        $output.= &quot;$after\n&quot;;
+    } // end while
+    
+    if($echo) {
+	    echo $output;
+	} else {
+		return $output;
+	}
+}
+
+
+/** function get_linkobjectsbyname()
+ ** Gets an array of link objects associated with category 'cat_name'.
+ ** Parameters:
+ **   cat_name (default 'noname')  - The category name to use. If no
+ **     match is found uses all
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url', 'description', or 'rating'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **
+ ** Use this like:
+ ** $links = get_linkobjectsbyname('fred');
+ ** foreach ($links as $link) {
+ **   echo '&lt;li&gt;'.$link-&gt;link_name.'&lt;/li&gt;';
+ ** }
+ **/
+function get_linkobjectsbyname($cat_name = &quot;noname&quot; , $orderby = 'name', $limit = -1) {
+    global $wpdb;
+    $cat_id = -1;
+    $results = $wpdb-&gt;get_results(&quot;SELECT cat_id FROM $wpdb-&gt;linkcategories WHERE cat_name='$cat_name'&quot;);
+    if ($results) {
+        foreach ($results as $result) {
+            $cat_id = $result-&gt;cat_id;
+        }
+    }
+    return get_linkobjects($cat_id, $orderby, $limit);
+}
+
+/** function get_linkobjects()
+ ** Gets an array of link objects associated with category n.
+ ** Parameters:
+ **   category (default -1)  - The category to use. If no category supplied
+ **      uses all
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url', 'description', or 'rating'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **
+ ** Use this like:
+ ** $links = get_linkobjects(1);
+ ** if ($links) {
+ **   foreach ($links as $link) {
+ **     echo '&lt;li&gt;'.$link-&gt;link_name.'&lt;br /&gt;'.$link-&gt;link_description.'&lt;/li&gt;';
+ **   }
+ ** }
+ ** Fields are:
+ ** link_id
+ ** link_url
+ ** link_name
+ ** link_image
+ ** link_target
+ ** link_category
+ ** link_description
+ ** link_visible
+ ** link_owner
+ ** link_rating
+ ** link_updated
+ ** link_rel
+ ** link_notes
+ **/
+function get_linkobjects($category = -1, $orderby = 'name', $limit = -1) {
+    global $wpdb;
+
+    $sql = &quot;SELECT * FROM $wpdb-&gt;links WHERE link_visible = 'Y'&quot;;
+    if ($category != -1) {
+        $sql .= &quot; AND link_category = $category &quot;;
+    }
+    if ($orderby == '')
+        $orderby = 'id';
+    if (substr($orderby,0,1) == '_') {
+        $direction = ' DESC';
+        $orderby = substr($orderby,1);
+    }
+    if (strcasecmp('rand',$orderby) == 0) {
+        $orderby = 'rand()';
+    } else {
+        $orderby = &quot; link_&quot; . $orderby;
+    }
+    $sql .= ' ORDER BY ' . $orderby;
+    $sql .= $direction;
+    /* The next 2 lines implement LIMIT TO processing */
+    if ($limit != -1)
+        $sql .= &quot; LIMIT $limit&quot;;
+
+    $results = $wpdb-&gt;get_results($sql);
+    if ($results) {
+        foreach ($results as $result) {
+            $result-&gt;link_url         = $result-&gt;link_url;
+            $result-&gt;link_name        = $result-&gt;link_name;
+            $result-&gt;link_description = $result-&gt;link_description;
+            $result-&gt;link_notes       = $result-&gt;link_notes;
+            $newresults[] = $result;
+        }
+    }
+    return $newresults;
+}
+
+function get_linkrating($link) {
+    return apply_filters('link_rating', $link-&gt;link_rating);
+}
+
+
+/** function get_linksbyname_withrating()
+ ** Gets the links associated with category 'cat_name' and display rating stars/chars.
+ ** Parameters:
+ **   cat_name (default 'noname')  - The category name to use. If no
+ **     match is found uses all
+ **   before (default '')  - the html to output before the link
+ **   after (default '&lt;br /&gt;')  - the html to output after the link
+ **   between (default ' ')  - the html to output between the link/image
+ **     and it's description. Not used if no image or show_images == true
+ **   show_images (default true) - whether to show images (if defined).
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url' or 'description'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   show_description (default true) - whether to show the description if
+ **     show_images=false/not defined
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **   show_updated (default 0) - whether to show last updated timestamp
+ */
+function get_linksbyname_withrating($cat_name = &quot;noname&quot;, $before = '',
+                                    $after = '&lt;br /&gt;', $between = &quot; &quot;,
+                                    $show_images = true, $orderby = 'id',
+                                    $show_description = true, $limit = -1, $show_updated = 0) {
+
+    get_linksbyname($cat_name, $before, $after, $between, $show_images,
+                    $orderby, $show_description, true, $limit, $show_updated);
+}
+
+/** function get_links_withrating()
+ ** Gets the links associated with category n and display rating stars/chars.
+ ** Parameters:
+ **   category (default -1)  - The category to use. If no category supplied
+ **      uses all
+ **   before (default '')  - the html to output before the link
+ **   after (default '&lt;br /&gt;')  - the html to output after the link
+ **   between (default ' ')  - the html to output between the link/image
+ **     and it's description. Not used if no image or show_images == true
+ **   show_images (default true) - whether to show images (if defined).
+ **   orderby (default 'id') - the order to output the links. E.g. 'id', 'name',
+ **     'url' or 'description'. Or maybe owner. If you start the
+ **     name with an underscore the order will be reversed.
+ **     You can also specify 'rand' as the order which will return links in a
+ **     random order.
+ **   show_description (default true) - whether to show the description if
+ **    show_images=false/not defined .
+ **   limit (default -1) - Limit to X entries. If not specified, all entries
+ **     are shown.
+ **   show_updated (default 0) - whether to show last updated timestamp
+ */
+function get_links_withrating($category = -1, $before = '', $after = '&lt;br /&gt;',
+                              $between = &quot; &quot;, $show_images = true,
+                              $orderby = 'id', $show_description = true,
+                              $limit = -1, $show_updated = 0) {
+
+    get_links($category, $before, $after, $between, $show_images, $orderby,
+              $show_description, true, $limit, $show_updated);
+}
+
+/** function get_linkcatname()
+ ** Gets the name of category n.
+ ** Parameters: id (default 0)  - The category to get. If no category supplied
+ **                uses 0
+ */
+function get_linkcatname($id = 0) {
+    global $wpdb;
+    $cat_name = '';
+    if ('' != $id) {
+        $cat_name = $wpdb-&gt;get_var(&quot;SELECT cat_name FROM $wpdb-&gt;linkcategories WHERE cat_id=$id&quot;);
+    }
+    return $cat_name;
+}
+
+/** function get_get_autotoggle()
+ ** Gets the auto_toggle setting of category n.
+ ** Parameters: id (default 0)  - The category to get. If no category supplied
+ **                uses 0
+ */
+function get_autotoggle($id = 0) {
+    global $wpdb;
+    $auto_toggle = $wpdb-&gt;get_var(&quot;SELECT auto_toggle FROM $wpdb-&gt;linkcategories WHERE cat_id=$id&quot;);
+    if ('' == $auto_toggle)
+        $auto_toggle = 'N';
+    return $auto_toggle;
+}
+
+/** function links_popup_script()
+ ** This function contributed by Fullo -- <A HREF="http://sprite.csr.unibo.it/fullo/">http://sprite.csr.unibo.it/fullo/</A>
+ ** Show the link to the links popup and the number of links
+ ** Parameters:
+ **   text (default Links)  - the text of the link
+ **   width (default 400)  - the width of the popup window
+ **   height (default 400)  - the height of the popup window
+ **   file (default linkspopup.php) - the page to open in the popup window
+ **   count (default true) - the number of links in the db
+ */
+function links_popup_script($text = 'Links', $width=400, $height=400,
+                            $file='links.all.php', $count = true) {
+   if ($count == true) {
+      $counts = $wpdb-&gt;get_var(&quot;SELECT count(*) FROM $wpdb-&gt;links&quot;);
+   }
+
+   $javascript = &quot;&lt;a href=\&quot;#\&quot; &quot; .
+                 &quot; onclick=\&quot;javascript:window.open('$file?popup=1', '_blank', &quot; .
+                 &quot;'width=$width,height=$height,scrollbars=yes,status=no'); &quot; .
+                 &quot; return false\&quot;&gt;&quot;;
+   $javascript .= $text;
+
+   if ($count == true) {
+      $javascript .= &quot; ($counts)&quot;;
+   }
+
+   $javascript .=&quot;&lt;/a&gt;\n\n&quot;;
+   echo $javascript;
+}
+
+
+/*
+ * function get_links_list()
+ *
+ * added by Dougal
+ *
+ * Output a list of all links, listed by category, using the
+ * settings in $wpdb-&gt;linkcategories and output it as a nested
+ * HTML unordered list.
+ *
+ * Parameters:
+ *   order (default 'name')  - Sort link categories by 'name' or 'id'
+ *   hide_if_empty (default true)  - Supress listing empty link categories
+ */
+function get_links_list($order = 'name', $hide_if_empty = 'obsolete') {
+	global $wpdb;
+
+	$order = strtolower($order);
+
+	// Handle link category sorting
+	if (substr($order,0,1) == '_') {
+		$direction = ' DESC';
+		$order = substr($order,1);
+	}
+
+	// if 'name' wasn't specified, assume 'id':
+	$cat_order = ('name' == $order) ? 'cat_name' : 'cat_id';
+
+	if (!isset($direction)) $direction = '';
+	// Fetch the link category data as an array of hashesa
+	$cats = $wpdb-&gt;get_results(&quot;
+		SELECT DISTINCT link_category, cat_name, show_images, 
+			show_description, show_rating, show_updated, sort_order, 
+			sort_desc, list_limit
+		FROM `$wpdb-&gt;links` 
+		LEFT JOIN `$wpdb-&gt;linkcategories` ON (link_category = cat_id)
+		WHERE link_visible =  'Y'
+			AND list_limit &lt;&gt; 0
+		ORDER BY $cat_order $direction &quot;, ARRAY_A);
+
+	// Display each category
+	if ($cats) {
+		foreach ($cats as $cat) {
+			// Handle each category.
+			// First, fix the sort_order info
+			$orderby = $cat['sort_order'];
+			$orderby = (bool_from_yn($cat['sort_desc'])?'_':'') . $orderby;
+
+			// Display the category name
+			echo '	&lt;li id=&quot;linkcat-' . $cat['link_category'] . '&quot;&gt;&lt;h2&gt;' . $cat['cat_name'] . &quot;&lt;/h2&gt;\n\t&lt;ul&gt;\n&quot;;
+			// Call get_links() with all the appropriate params
+			get_links($cat['link_category'],
+				'&lt;li&gt;',&quot;&lt;/li&gt;&quot;,&quot;\n&quot;,
+				bool_from_yn($cat['show_images']),
+				$orderby,
+				bool_from_yn($cat['show_description']),
+				bool_from_yn($cat['show_rating']),
+				$cat['list_limit'],
+				bool_from_yn($cat['show_updated']));
+
+			// Close the last category
+			echo &quot;\n\t&lt;/ul&gt;\n&lt;/li&gt;\n&quot;;
+		}
+	}
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/locale.php
===================================================================
--- trunk/wp-includes/locale.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/locale.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,70 @@
+&lt;?php
+// Date and Time
+
+// The Weekdays
+$weekday[0] = __('Sunday');
+$weekday[1] = __('Monday');
+$weekday[2] = __('Tuesday');
+$weekday[3] = __('Wednesday');
+$weekday[4] = __('Thursday');
+$weekday[5] = __('Friday');
+$weekday[6] = __('Saturday');
+
+// The first letter of each day.  The _%day%_initial suffix is a hack to make
+// sure the day initials are unique.  They should be translated to a one
+// letter initial.  
+$weekday_initial[__('Sunday')]    = __('S_Sunday_initial');
+$weekday_initial[__('Monday')]    = __('M_Monday_initial');
+$weekday_initial[__('Tuesday')]   = __('T_Tuesday_initial');
+$weekday_initial[__('Wednesday')] = __('W_Wednesday_initial');
+$weekday_initial[__('Thursday')]  = __('T_Thursday_initial');
+$weekday_initial[__('Friday')]    = __('F_Friday_initial');
+$weekday_initial[__('Saturday')]  = __('S_Saturday_initial');
+
+foreach ($weekday_initial as $weekday_ =&gt; $weekday_initial_) {
+  $weekday_initial[$weekday_] = preg_replace('/_.+_initial$/', '', $weekday_initial_);
+}
+
+// Abbreviations for each day.
+$weekday_abbrev[__('Sunday')]    = __('Sun');
+$weekday_abbrev[__('Monday')]    = __('Mon');
+$weekday_abbrev[__('Tuesday')]   = __('Tue');
+$weekday_abbrev[__('Wednesday')] = __('Wed');
+$weekday_abbrev[__('Thursday')]  = __('Thu');
+$weekday_abbrev[__('Friday')]    = __('Fri');
+$weekday_abbrev[__('Saturday')]  = __('Sat');
+
+// The Months
+$month['01'] = __('January');
+$month['02'] = __('February');
+$month['03'] = __('March');
+$month['04'] = __('April');
+$month['05'] = __('May');
+$month['06'] = __('June');
+$month['07'] = __('July');
+$month['08'] = __('August');
+$month['09'] = __('September');
+$month['10'] = __('October');
+$month['11'] = __('November');
+$month['12'] = __('December');
+
+// Abbreviations for each month. Uses the same hack as above to get around the
+// 'May' duplication.
+$month_abbrev[__('January')] = __('Jan_January_abbreviation');
+$month_abbrev[__('February')] = __('Feb_February_abbreviation');
+$month_abbrev[__('March')] = __('Mar_March_abbreviation');
+$month_abbrev[__('April')] = __('Apr_April_abbreviation');
+$month_abbrev[__('May')] = __('May_May_abbreviation');
+$month_abbrev[__('June')] = __('Jun_June_abbreviation');
+$month_abbrev[__('July')] = __('Jul_July_abbreviation');
+$month_abbrev[__('August')] = __('Aug_August_abbreviation');
+$month_abbrev[__('September')] = __('Sep_September_abbreviation');
+$month_abbrev[__('October')] = __('Oct_October_abbreviation');
+$month_abbrev[__('November')] = __('Nov_November_abbreviation');
+$month_abbrev[__('December')] = __('Dec_December_abbreviation');
+
+foreach ($month_abbrev as $month_ =&gt; $month_abbrev_) {
+  $month_abbrev[$month_] = preg_replace('/_.+_abbreviation$/', '', $month_abbrev_);
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/pluggable-functions.php
===================================================================
--- trunk/wp-includes/pluggable-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/pluggable-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,275 @@
+&lt;?php
+
+	/* These functions can be replaced via plugins.  They are loaded after
+	 plugins are loaded. */
+
+
+if ( !function_exists('get_currentuserinfo') ) :
+function get_currentuserinfo() {
+	global $user_login, $userdata, $user_level, $user_ID, $user_nickname, $user_email, $user_url, $user_pass_md5, $user_identity;
+	// *** retrieving user's data from cookies and db - no spoofing
+
+	if (isset($_COOKIE['wordpressuser_' . COOKIEHASH])) 
+		$user_login = $_COOKIE['wordpressuser_' . COOKIEHASH];
+	$userdata = get_userdatabylogin($user_login);
+	$user_level = $userdata-&gt;user_level;
+	$user_ID = $userdata-&gt;ID;
+	$user_nickname = $userdata-&gt;user_nickname;
+	$user_email = $userdata-&gt;user_email;
+	$user_url = $userdata-&gt;user_url;
+	$user_pass_md5 = md5($userdata-&gt;user_pass);
+
+	$idmode = $userdata-&gt;user_idmode;
+	if ($idmode == 'nickname')  $user_identity = $userdata-&gt;user_nickname;
+	if ($idmode == 'login')     $user_identity = $userdata-&gt;user_login;
+	if ($idmode == 'firstname') $user_identity = $userdata-&gt;user_firstname;
+	if ($idmode == 'lastname')  $user_identity = $userdata-&gt;user_lastname;
+	if ($idmode == 'namefl')    $user_identity = $userdata-&gt;user_firstname.' '.$userdata-&gt;user_lastname;
+	if ($idmode == 'namelf')    $user_identity = $userdata-&gt;user_lastname.' '.$userdata-&gt;user_firstname;
+	if (!$idmode) $user_identity = $userdata-&gt;user_nickname;
+}
+endif;
+
+if ( !function_exists('get_userdata') ) :
+function get_userdata($userid) {
+	global $wpdb, $cache_userdata;
+	$userid = (int) $userid;
+	if ( empty($cache_userdata[$userid]) &amp;&amp; $userid != 0) {
+		$cache_userdata[$userid] = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users WHERE ID = $userid&quot;);
+		$cache_userdata[$cache_userdata[$userid]-&gt;user_login] =&amp; $cache_userdata[$userid];
+	} 
+
+	return $cache_userdata[$userid];
+}
+endif;
+
+if ( !function_exists('get_userdatabylogin') ) :
+function get_userdatabylogin($user_login) {
+	global $cache_userdata, $wpdb;
+	if ( !empty($user_login) &amp;&amp; empty($cache_userdata[$user_login]) ) {
+		$user = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users WHERE user_login = '$user_login'&quot;); /* todo: get rid of this intermediate var */
+		$cache_userdata[$user-&gt;ID] = $user;
+		$cache_userdata[$user_login] =&amp; $cache_userdata[$user-&gt;ID];
+	} else {
+		$user = $cache_userdata[$user_login];
+	}
+	return $user;
+}
+endif;
+
+if ( !function_exists('wp_mail') ) :
+function wp_mail($to, $subject, $message, $headers = '') {
+	if( $headers == '' ) {
+		$headers = &quot;MIME-Version: 1.0\n&quot; .
+			&quot;From: &quot; . get_settings('admin_email') . &quot;\n&quot; . 
+			&quot;Content-Type: text/plain; charset=\&quot;&quot; . get_settings('blog_charset') . &quot;\&quot;\n&quot;;
+	}
+
+	return @mail($to, $subject, $message, $headers);
+}
+endif;
+
+if ( !function_exists('wp_login') ) :
+function wp_login($username, $password, $already_md5 = false) {
+	global $wpdb, $error;
+
+	if ( !$username )
+		return false;
+
+	if ( !$password ) {
+		$error = __('&lt;strong&gt;Error&lt;/strong&gt;: The password field is empty.');
+		return false;
+	}
+
+	$login = $wpdb-&gt;get_row(&quot;SELECT ID, user_login, user_pass FROM $wpdb-&gt;users WHERE user_login = '$username'&quot;);
+
+	if (!$login) {
+		$error = __('&lt;strong&gt;Error&lt;/strong&gt;: Wrong username.');
+		return false;
+	} else {
+		// If the password is already_md5, it has been double hashed.
+		// Otherwise, it is plain text.
+		if ( ($already_md5 &amp;&amp; $login-&gt;user_login == $username &amp;&amp; md5($login-&gt;user_pass) == $password) || ($login-&gt;user_login == $username &amp;&amp; $login-&gt;user_pass == md5($password)) ) {
+			return true;
+		} else {
+			$error = __('&lt;strong&gt;Error&lt;/strong&gt;: Incorrect password.');
+			$pwd = '';
+			return false;
+		}
+	}
+}
+endif;
+
+if ( !function_exists('auth_redirect') ) :
+function auth_redirect() {
+	// Checks if a user is logged in, if not redirects them to the login page
+	if ( (!empty($_COOKIE['wordpressuser_' . COOKIEHASH]) &amp;&amp; 
+				!wp_login($_COOKIE['wordpressuser_' . COOKIEHASH], $_COOKIE['wordpresspass_' . COOKIEHASH], true)) ||
+			 (empty($_COOKIE['wordpressuser_' . COOKIEHASH])) ) {
+		header('Expires: Wed, 11 Jan 1984 05:00:00 GMT');
+		header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
+		header('Cache-Control: no-cache, must-revalidate, max-age=0');
+		header('Pragma: no-cache');
+	
+		header('Location: ' . get_settings('siteurl') . '/wp-login.php?redirect_to=' . urlencode($_SERVER['REQUEST_URI']));
+		exit();
+	}
+}
+endif;
+
+// Cookie safe redirect.  Works around IIS Set-Cookie bug.
+// <A HREF="http://support.microsoft.com/kb/q176113/">http://support.microsoft.com/kb/q176113/</A>
+if ( !function_exists('wp_redirect') ) :
+function wp_redirect($location) {
+	global $is_IIS;
+
+	if ($is_IIS)
+		header(&quot;Refresh: 0;url=$location&quot;);
+	else
+		header(&quot;Location: $location&quot;);
+}
+endif;
+
+if ( !function_exists('wp_setcookie') ) :
+function wp_setcookie($username, $password, $already_md5 = false, $home = '', $siteurl = '') {
+	if ( !$already_md5 )
+		$password = md5( md5($password) ); // Double hash the password in the cookie.
+
+	if ( empty($home) )
+		$cookiepath = COOKIEPATH;
+	else
+		$cookiepath = preg_replace('|https?://[^/]+|i', '', $home . '/' );
+
+	if ( empty($siteurl) ) {
+		$sitecookiepath = SITECOOKIEPATH;
+		$cookiehash = COOKIEHASH;
+	} else {
+		$sitecookiepath = preg_replace('|https?://[^/]+|i', '', $siteurl . '/' );
+		$cookiehash = md5($siteurl);
+	}
+
+	setcookie('wordpressuser_'. $cookiehash, $username, time() + 31536000, $cookiepath);
+	setcookie('wordpresspass_'. $cookiehash, $password, time() + 31536000, $cookiepath);
+
+	if ( $cookiepath != $sitecookiepath ) {
+		setcookie('wordpressuser_'. $cookiehash, $username, time() + 31536000, $sitecookiepath);
+		setcookie('wordpresspass_'. $cookiehash, $password, time() + 31536000, $sitecookiepath);
+	}
+}
+endif;
+
+if ( !function_exists('wp_clearcookie') ) :
+function wp_clearcookie() {
+	setcookie('wordpressuser_' . COOKIEHASH, ' ', time() - 31536000, COOKIEPATH);
+	setcookie('wordpresspass_' . COOKIEHASH, ' ', time() - 31536000, COOKIEPATH);
+	setcookie('wordpressuser_' . COOKIEHASH, ' ', time() - 31536000, SITECOOKIEPATH);
+	setcookie('wordpresspass_' . COOKIEHASH, ' ', time() - 31536000, SITECOOKIEPATH);
+}
+endif;
+
+if ( ! function_exists('wp_notify_postauthor') ) :
+function wp_notify_postauthor($comment_id, $comment_type='') {
+	global $wpdb;
+    
+	$comment = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_ID='$comment_id' LIMIT 1&quot;);
+	$post = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;posts WHERE ID='$comment-&gt;comment_post_ID' LIMIT 1&quot;);
+	$user = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users WHERE ID='$post-&gt;post_author' LIMIT 1&quot;);
+
+	if ('' == $user-&gt;user_email) return false; // If there's no email to send the comment to
+
+	$comment_author_domain = gethostbyaddr($comment-&gt;comment_author_IP);
+
+	$blogname = get_settings('blogname');
+	
+	if ( empty( $comment_type ) ) $comment_type = 'comment';
+	
+	if ('comment' == $comment_type) {
+		$notify_message  = sprintf( __('New comment on your post #%1$s &quot;%2$s&quot;'), $comment-&gt;comment_post_ID, $post-&gt;post_title ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('Author : %1$s (IP: %2$s , %3$s)'), $comment-&gt;comment_author, $comment-&gt;comment_author_IP, $comment_author_domain ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('E-mail : %s'), $comment-&gt;comment_author_email ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('URI    : %s'), $comment-&gt;comment_author_url ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('Whois  : <A HREF="http://ws.arin.net/cgi-bin/whois.pl?queryinput=%s">http://ws.arin.net/cgi-bin/whois.pl?queryinput=%s</A>'), $comment-&gt;comment_author_IP ) . &quot;\r\n&quot;;
+		$notify_message .= __('Comment: ') . &quot;\r\n&quot; . $comment-&gt;comment_content . &quot;\r\n\r\n&quot;;
+		$notify_message .= __('You can see all comments on this post here: ') . &quot;\r\n&quot;;
+		$subject = sprintf( __('[%1$s] Comment: &quot;%2$s&quot;'), $blogname, $post-&gt;post_title );
+	} elseif ('trackback' == $comment_type) {
+		$notify_message  = sprintf( __('New trackback on your post #%1$s &quot;%2$s&quot;'), $comment-&gt;comment_post_ID, $post-&gt;post_title ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('Website: %1$s (IP: %2$s , %3$s)'), $comment-&gt;comment_author, $comment-&gt;comment_author_IP, $comment_author_domain ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('URI    : %s'), $comment-&gt;comment_author_url ) . &quot;\r\n&quot;;
+		$notify_message .= __('Excerpt: ') . &quot;\r\n&quot; . $comment-&gt;comment_content . &quot;\r\n\r\n&quot;;
+		$notify_message .= __('You can see all trackbacks on this post here: ') . &quot;\r\n&quot;;
+		$subject = sprintf( __('[%1$s] Trackback: &quot;%2$s&quot;'), $blogname, $post-&gt;post_title );
+	} elseif ('pingback' == $comment_type) {
+		$notify_message  = sprintf( __('New pingback on your post #%1$s &quot;%2$s&quot;'), $comment-&gt;comment_post_ID, $post-&gt;post_title ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('Website: %1$s (IP: %2$s , %3$s)'), $comment-&gt;comment_author, $comment-&gt;comment_author_IP, $comment_author_domain ) . &quot;\r\n&quot;;
+		$notify_message .= sprintf( __('URI    : %s'), $comment-&gt;comment_author_url ) . &quot;\r\n&quot;;
+		$notify_message .= __('Excerpt: ') . &quot;\r\n&quot; . sprintf( __('[...] %s [...]'), $comment-&gt;comment_content ) . &quot;\r\n\r\n&quot;;
+		$notify_message .= __('You can see all pingbacks on this post here: ') . &quot;\r\n&quot;;
+		$subject = sprintf( __('[%1$s] Pingback: &quot;%2$s&quot;'), $blogname, $post-&gt;post_title );
+	}
+	$notify_message .= get_permalink($comment-&gt;comment_post_ID) . &quot;#comments\r\n\r\n&quot;;
+	$notify_message .= sprintf( __('To delete this comment, visit: %s'), get_settings('siteurl').'/wp-admin/post.php?action=confirmdeletecomment&amp;p='.$comment-&gt;comment_post_ID.&quot;&amp;comment=$comment_id&quot; ) . &quot;\r\n&quot;;
+
+	if ('' == $comment-&gt;comment_author_email || '' == $comment-&gt;comment_author) {
+		$from = &quot;From: \&quot;$blogname\&quot; &lt;wordpress@&quot; . $_SERVER['SERVER_NAME'] . '&gt;';
+	} else {
+		$from = 'From: &quot;' . $comment-&gt;comment_author . &quot;\&quot; &lt;$comment-&gt;comment_author_email&gt;&quot;;
+	}
+
+	$notify_message = apply_filters('comment_notification_text', $notify_message);
+	$subject = apply_filters('comment_notification_subject', $subject);
+	$message_headers = apply_filters('comment_notification_headers', $message_headers);
+
+	$message_headers = &quot;MIME-Version: 1.0\n&quot;
+		. &quot;$from\n&quot;
+		. &quot;Content-Type: text/plain; charset=\&quot;&quot; . get_settings('blog_charset') . &quot;\&quot;\n&quot;;
+
+	@wp_mail($user-&gt;user_email, $subject, $notify_message, $message_headers);
+   
+	return true;
+}
+endif;
+
+/* wp_notify_moderator
+   notifies the moderator of the blog (usually the admin)
+   about a new comment that waits for approval
+   always returns true
+ */
+if ( !function_exists('wp_notify_moderator') ) :
+function wp_notify_moderator($comment_id) {
+	global $wpdb;
+
+	if( get_settings( &quot;moderation_notify&quot; ) == 0 )
+		return true; 
+    
+	$comment = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_ID='$comment_id' LIMIT 1&quot;);
+	$post = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;posts WHERE ID='$comment-&gt;comment_post_ID' LIMIT 1&quot;);
+
+	$comment_author_domain = gethostbyaddr($comment-&gt;comment_author_IP);
+	$comments_waiting = $wpdb-&gt;get_var(&quot;SELECT count(comment_ID) FROM $wpdb-&gt;comments WHERE comment_approved = '0'&quot;);
+
+	$notify_message  = sprintf( __('A new comment on the post #%1$s &quot;%2$s&quot; is waiting for your approval'), $post-&gt;ID, $post-&gt;post_title ) . &quot;\r\n&quot;;
+	$notify_message .= get_permalink($comment-&gt;comment_post_ID) . &quot;\r\n\r\n&quot;;
+	$notify_message .= sprintf( __('Author : %1$s (IP: %2$s , %3$s)'), $comment-&gt;comment_author, $comment-&gt;comment_author_IP, $comment_author_domain ) . &quot;\r\n&quot;;
+	$notify_message .= sprintf( __('E-mail : %s'), $comment-&gt;comment_author_email ) . &quot;\r\n&quot;;
+	$notify_message .= sprintf( __('URI    : %s'), $comment-&gt;comment_author_url ) . &quot;\r\n&quot;;
+	$notify_message .= sprintf( __('Whois  : <A HREF="http://ws.arin.net/cgi-bin/whois.pl?queryinput=%s">http://ws.arin.net/cgi-bin/whois.pl?queryinput=%s</A>'), $comment-&gt;comment_author_IP ) . &quot;\r\n&quot;;
+	$notify_message .= __('Comment: ') . &quot;\r\n&quot; . $comment-&gt;comment_content . &quot;\r\n\r\n&quot;;
+	$notify_message .= sprintf( __('To approve this comment, visit: %s'),  get_settings('siteurl').'/wp-admin/post.php?action=mailapprovecomment&amp;p='.$comment-&gt;comment_post_ID.&quot;&amp;comment=$comment_id&quot; ) . &quot;\r\n&quot;;
+	$notify_message .= sprintf( __('To delete this comment, visit: %s'), get_settings('siteurl').'/wp-admin/post.php?action=confirmdeletecomment&amp;p='.$comment-&gt;comment_post_ID.&quot;&amp;comment=$comment_id&quot; ) . &quot;\r\n&quot;;
+	$notify_message .= sprintf( __('Currently %s comments are waiting for approval. Please visit the moderation panel:'), $comments_waiting ) . &quot;\r\n&quot;;
+	$notify_message .= get_settings('siteurl') . &quot;/wp-admin/moderation.php\r\n&quot;;
+
+	$subject = sprintf( __('[%1$s] Please moderate: &quot;%2$s&quot;'), get_settings('blogname'), $post-&gt;post_title );
+	$admin_email = get_settings(&quot;admin_email&quot;);
+
+	$notify_message = apply_filters('comment_moderation_text', $notify_message);
+	$subject = apply_filters('comment_moderation_subject', $subject);
+
+	@wp_mail($admin_email, $subject, $notify_message);
+    
+	return true;
+}
+endif;
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/rss-functions.php
===================================================================
--- trunk/wp-includes/rss-functions.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/rss-functions.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,850 @@
+&lt;?php
+/*
+ * Project:     MagpieRSS: a simple RSS integration tool
+ * File:        A compiled file for RSS syndication
+ * Author:      Kellan Elliott-McCrea &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">kellan at protest.net</A>&gt;
+ * Version:		0.51
+ * License:		GPL
+ */
+
+define('RSS', 'RSS');
+define('ATOM', 'Atom');
+define('MAGPIE_USER_AGENT', 'WordPress/' . $wp_version);
+
+class MagpieRSS { 
+	var $parser;
+	var $current_item	= array();	// item currently being parsed
+	var $items			= array();	// collection of parsed items
+	var $channel		= array();	// hash of channel fields
+	var $textinput		= array();
+	var $image			= array();
+	var $feed_type;
+	var $feed_version;
+
+	// parser variables
+	var $stack				= array(); // parser stack
+	var $inchannel			= false;
+	var $initem 			= false;
+	var $incontent			= false; // if in Atom &lt;content mode=&quot;xml&quot;&gt; field 
+	var $intextinput		= false;
+	var $inimage 			= false;
+	var $current_field		= '';
+	var $current_namespace	= false;
+	
+	//var $ERROR = &quot;&quot;;
+	
+	var $_CONTENT_CONSTRUCTS = array('content', 'summary', 'info', 'title', 'tagline', 'copyright');
+
+	function MagpieRSS ($source) {
+		
+		# if PHP xml isn't compiled in, die
+		#
+		if (!function_exists('xml_parser_create')) {
+			$this-&gt;error( &quot;Failed to load PHP's XML Extension. &quot; . 
+						  &quot;<A HREF="http://www.php.net/manual/en/ref.xml.php">http://www.php.net/manual/en/ref.xml.php</A>&quot;,
+						   E_USER_ERROR );
+		}
+		
+		$parser = @xml_parser_create();
+		
+		if (!is_resource($parser))
+		{
+			$this-&gt;error( &quot;Failed to create an instance of PHP's XML parser. &quot; .
+						  &quot;<A HREF="http://www.php.net/manual/en/ref.xml.php">http://www.php.net/manual/en/ref.xml.php</A>&quot;,
+						  E_USER_ERROR );
+		}
+
+		
+		$this-&gt;parser = $parser;
+		
+		# pass in parser, and a reference to this object
+		# setup handlers
+		#
+		xml_set_object( $this-&gt;parser, $this );
+		xml_set_element_handler($this-&gt;parser, 
+				'feed_start_element', 'feed_end_element' );
+						
+		xml_set_character_data_handler( $this-&gt;parser, 'feed_cdata' ); 
+	
+		$status = xml_parse( $this-&gt;parser, $source );
+		
+		if (! $status ) {
+			$errorcode = xml_get_error_code( $this-&gt;parser );
+			if ( $errorcode != XML_ERROR_NONE ) {
+				$xml_error = xml_error_string( $errorcode );
+				$error_line = xml_get_current_line_number($this-&gt;parser);
+				$error_col = xml_get_current_column_number($this-&gt;parser);
+				$errormsg = &quot;$xml_error at line $error_line, column $error_col&quot;;
+
+				$this-&gt;error( $errormsg );
+			}
+		}
+		
+		xml_parser_free( $this-&gt;parser );
+
+		$this-&gt;normalize();
+	}
+	
+	function feed_start_element($p, $element, &amp;$attrs) {
+		$el = $element = strtolower($element);
+		$attrs = array_change_key_case($attrs, CASE_LOWER);
+		
+		// check for a namespace, and split if found
+		$ns	= false;
+		if ( strpos( $element, ':' ) ) {
+			list($ns, $el) = split( ':', $element, 2); 
+		}
+		if ( $ns and $ns != 'rdf' ) {
+			$this-&gt;current_namespace = $ns;
+		}
+			
+		# if feed type isn't set, then this is first element of feed
+		# identify feed from root element
+		#
+		if (!isset($this-&gt;feed_type) ) {
+			if ( $el == 'rdf' ) {
+				$this-&gt;feed_type = RSS;
+				$this-&gt;feed_version = '1.0';
+			}
+			elseif ( $el == 'rss' ) {
+				$this-&gt;feed_type = RSS;
+				$this-&gt;feed_version = $attrs['version'];
+			}
+			elseif ( $el == 'feed' ) {
+				$this-&gt;feed_type = ATOM;
+				$this-&gt;feed_version = $attrs['version'];
+				$this-&gt;inchannel = true;
+			}
+			return;
+		}
+	
+		if ( $el == 'channel' ) 
+		{
+			$this-&gt;inchannel = true;
+		}
+		elseif ($el == 'item' or $el == 'entry' ) 
+		{
+			$this-&gt;initem = true;
+			if ( isset($attrs['rdf:about']) ) {
+				$this-&gt;current_item['about'] = $attrs['rdf:about'];	
+			}
+		}
+		
+		// if we're in the default namespace of an RSS feed,
+		//  record textinput or image fields
+		elseif ( 
+			$this-&gt;feed_type == RSS and 
+			$this-&gt;current_namespace == '' and 
+			$el == 'textinput' ) 
+		{
+			$this-&gt;intextinput = true;
+		}
+		
+		elseif (
+			$this-&gt;feed_type == RSS and 
+			$this-&gt;current_namespace == '' and 
+			$el == 'image' ) 
+		{
+			$this-&gt;inimage = true;
+		}
+		
+		# handle atom content constructs
+		elseif ( $this-&gt;feed_type == ATOM and in_array($el, $this-&gt;_CONTENT_CONSTRUCTS) )
+		{
+			// avoid clashing w/ RSS mod_content
+			if ($el == 'content' ) {
+				$el = 'atom_content';
+			}
+			
+			$this-&gt;incontent = $el;
+			
+			
+		}
+		
+		// if inside an Atom content construct (e.g. content or summary) field treat tags as text
+		elseif ($this-&gt;feed_type == ATOM and $this-&gt;incontent ) 
+		{
+			// if tags are inlined, then flatten
+			$attrs_str = join(' ', 
+					array_map('map_attrs', 
+					array_keys($attrs), 
+					array_values($attrs) ) );
+			
+			$this-&gt;append_content( &quot;&lt;$element $attrs_str&gt;&quot;  );
+					
+			array_unshift( $this-&gt;stack, $el );
+		}
+		
+		// Atom support many links per containging element.
+		// Magpie treats link elements of type rel='alternate'
+		// as being equivalent to RSS's simple link element.
+		//
+		elseif ($this-&gt;feed_type == ATOM and $el == 'link' ) 
+		{
+			if ( isset($attrs['rel']) and $attrs['rel'] == 'alternate' ) 
+			{
+				$link_el = 'link';
+			}
+			else {
+				$link_el = 'link_' . $attrs['rel'];
+			}
+			
+			$this-&gt;append($link_el, $attrs['href']);
+		}
+		// set stack[0] to current element
+		else {
+			array_unshift($this-&gt;stack, $el);
+		}
+	}
+	
+
+	
+	function feed_cdata ($p, $text) {
+		
+		if ($this-&gt;feed_type == ATOM and $this-&gt;incontent) 
+		{
+			$this-&gt;append_content( $text );
+		}
+		else {
+			$current_el = join('_', array_reverse($this-&gt;stack));
+			$this-&gt;append($current_el, $text);
+		}
+	}
+	
+	function feed_end_element ($p, $el) {
+		$el = strtolower($el);
+		
+		if ( $el == 'item' or $el == 'entry' ) 
+		{
+			$this-&gt;items[] = $this-&gt;current_item;
+			$this-&gt;current_item = array();
+			$this-&gt;initem = false;
+		}
+		elseif ($this-&gt;feed_type == RSS and $this-&gt;current_namespace == '' and $el == 'textinput' ) 
+		{
+			$this-&gt;intextinput = false;
+		}
+		elseif ($this-&gt;feed_type == RSS and $this-&gt;current_namespace == '' and $el == 'image' ) 
+		{
+			$this-&gt;inimage = false;
+		}
+		elseif ($this-&gt;feed_type == ATOM and in_array($el, $this-&gt;_CONTENT_CONSTRUCTS) )
+		{	
+			$this-&gt;incontent = false;
+		}
+		elseif ($el == 'channel' or $el == 'feed' ) 
+		{
+			$this-&gt;inchannel = false;
+		}
+		elseif ($this-&gt;feed_type == ATOM and $this-&gt;incontent  ) {
+			// balance tags properly
+			// note:  i don't think this is actually neccessary
+			if ( $this-&gt;stack[0] == $el ) 
+			{
+				$this-&gt;append_content(&quot;&lt;/$el&gt;&quot;);
+			}
+			else {
+				$this-&gt;append_content(&quot;&lt;$el /&gt;&quot;);
+			}
+
+			array_shift( $this-&gt;stack );
+		}
+		else {
+			array_shift( $this-&gt;stack );
+		}
+		
+		$this-&gt;current_namespace = false;
+	}
+	
+	function concat (&amp;$str1, $str2=&quot;&quot;) {
+		if (!isset($str1) ) {
+			$str1=&quot;&quot;;
+		}
+		$str1 .= $str2;
+	}
+	
+	function append_content($text) {
+		if ( $this-&gt;initem ) {
+			$this-&gt;concat( $this-&gt;current_item[ $this-&gt;incontent ], $text );
+		}
+		elseif ( $this-&gt;inchannel ) {
+			$this-&gt;concat( $this-&gt;channel[ $this-&gt;incontent ], $text );
+		}
+	}
+	
+	// smart append - field and namespace aware
+	function append($el, $text) {
+		if (!$el) {
+			return;
+		}
+		if ( $this-&gt;current_namespace ) 
+		{
+			if ( $this-&gt;initem ) {
+				$this-&gt;concat(
+					$this-&gt;current_item[ $this-&gt;current_namespace ][ $el ], $text);
+			}
+			elseif ($this-&gt;inchannel) {
+				$this-&gt;concat(
+					$this-&gt;channel[ $this-&gt;current_namespace][ $el ], $text );
+			}
+			elseif ($this-&gt;intextinput) {
+				$this-&gt;concat(
+					$this-&gt;textinput[ $this-&gt;current_namespace][ $el ], $text );
+			}
+			elseif ($this-&gt;inimage) {
+				$this-&gt;concat(
+					$this-&gt;image[ $this-&gt;current_namespace ][ $el ], $text );
+			}
+		}
+		else {
+			if ( $this-&gt;initem ) {
+				$this-&gt;concat(
+					$this-&gt;current_item[ $el ], $text);
+			}
+			elseif ($this-&gt;intextinput) {
+				$this-&gt;concat(
+					$this-&gt;textinput[ $el ], $text );
+			}
+			elseif ($this-&gt;inimage) {
+				$this-&gt;concat(
+					$this-&gt;image[ $el ], $text );
+			}
+			elseif ($this-&gt;inchannel) {
+				$this-&gt;concat(
+					$this-&gt;channel[ $el ], $text );
+			}
+			
+		}
+	}
+	
+	function normalize () {
+		// if atom populate rss fields
+		if ( $this-&gt;is_atom() ) {
+			$this-&gt;channel['descripton'] = $this-&gt;channel['tagline'];
+			for ( $i = 0; $i &lt; count($this-&gt;items); $i++) {
+				$item = $this-&gt;items[$i];
+				if ( isset($item['summary']) )
+					$item['description'] = $item['summary'];
+				if ( isset($item['atom_content']))
+					$item['content']['encoded'] = $item['atom_content'];
+				
+				$this-&gt;items[$i] = $item;
+			}		
+		}
+		elseif ( $this-&gt;is_rss() ) {
+			$this-&gt;channel['tagline'] = $this-&gt;channel['description'];
+			for ( $i = 0; $i &lt; count($this-&gt;items); $i++) {
+				$item = $this-&gt;items[$i];
+				if ( isset($item['description']))
+					$item['summary'] = $item['description'];
+				if ( isset($item['content']['encoded'] ) )
+					$item['atom_content'] = $item['content']['encoded'];
+			
+				$this-&gt;items[$i] = $item;
+			}
+		}
+	}
+	
+	function is_rss () {
+		if ( $this-&gt;feed_type == RSS ) {
+			return $this-&gt;feed_version;	
+		}
+		else {
+			return false;
+		}
+	}
+	
+	function is_atom() {
+		if ( $this-&gt;feed_type == ATOM ) {
+			return $this-&gt;feed_version;
+		}
+		else {
+			return false;
+		}
+	}
+
+function map_attrs($k, $v) {
+	return &quot;$k=\&quot;$v\&quot;&quot;;
+	}
+}
+require_once( dirname(__FILE__) . '/class-snoopy.php');
+
+function fetch_rss ($url) {
+	// initialize constants
+	init();
+	
+	if ( !isset($url) ) {
+		error(&quot;fetch_rss called without a url&quot;);
+		return false;
+	}
+	
+	// if cache is disabled
+	if ( !MAGPIE_CACHE_ON ) {
+		// fetch file, and parse it
+		$resp = _fetch_remote_file( $url );
+		if ( is_success( $resp-&gt;status ) ) {
+			return _response_to_rss( $resp );
+		}
+		else {
+			error(&quot;Failed to fetch $url and cache is off&quot;);
+			return false;
+		}
+	} 
+	// else cache is ON
+	else {
+		// Flow
+		// 1. check cache
+		// 2. if there is a hit, make sure its fresh
+		// 3. if cached obj fails freshness check, fetch remote
+		// 4. if remote fails, return stale object, or error
+		
+		$cache = new RSSCache( MAGPIE_CACHE_DIR, MAGPIE_CACHE_AGE );
+		
+		if (MAGPIE_DEBUG and $cache-&gt;ERROR) {
+			debug($cache-&gt;ERROR, E_USER_WARNING);
+		}
+		
+		
+		$cache_status 	 = 0;		// response of check_cache
+		$request_headers = array(); // HTTP headers to send with fetch
+		$rss 			 = 0;		// parsed RSS object
+		$errormsg		 = 0;		// errors, if any
+		
+		if (!$cache-&gt;ERROR) {
+			// return cache HIT, MISS, or STALE
+			$cache_status = $cache-&gt;check_cache( $url );
+		}
+
+		// if object cached, and cache is fresh, return cached obj
+		if ( $cache_status == 'HIT' ) {
+			$rss = $cache-&gt;get( $url );
+			if ( isset($rss) and $rss ) {
+				$rss-&gt;from_cache = 1;
+				if ( MAGPIE_DEBUG &gt; 1) {
+				debug(&quot;MagpieRSS: Cache HIT&quot;, E_USER_NOTICE);
+			}
+				return $rss;
+			}
+		}
+		
+		// else attempt a conditional get
+		
+		// setup headers
+		if ( $cache_status == 'STALE' ) {
+			$rss = $cache-&gt;get( $url );
+			if ( $rss-&gt;etag and $rss-&gt;last_modified ) {
+				$request_headers['If-None-Match'] = $rss-&gt;etag;
+				$request_headers['If-Last-Modified'] = $rss-&gt;last_modified;
+			}
+		}
+		
+		$resp = _fetch_remote_file( $url, $request_headers );
+		
+		if (isset($resp) and $resp) {
+			if ($resp-&gt;status == '304' ) {
+				// we have the most current copy
+				if ( MAGPIE_DEBUG &gt; 1) {
+					debug(&quot;Got 304 for $url&quot;);
+				}
+				// reset cache on 304 (at minutillo insistent prodding)
+				$cache-&gt;set($url, $rss);
+				return $rss;
+			}
+			elseif ( is_success( $resp-&gt;status ) ) {
+				$rss = _response_to_rss( $resp );
+				if ( $rss ) {
+					if (MAGPIE_DEBUG &gt; 1) {
+						debug(&quot;Fetch successful&quot;);
+					}
+					// add object to cache
+					$cache-&gt;set( $url, $rss );
+					return $rss;
+				}
+			}
+			else {
+				$errormsg = &quot;Failed to fetch $url. &quot;;
+				if ( $resp-&gt;error ) {
+					# compensate for Snoopy's annoying habbit to tacking
+					# on '\n'
+					$http_error = substr($resp-&gt;error, 0, -2); 
+					$errormsg .= &quot;(HTTP Error: $http_error)&quot;;
+				}
+				else {
+					$errormsg .=  &quot;(HTTP Response: &quot; . $resp-&gt;response_code .')';
+				}
+			}
+		}
+		else {
+			$errormsg = &quot;Unable to retrieve RSS file for unknown reasons.&quot;;
+		}
+		
+		// else fetch failed
+		
+		// attempt to return cached object
+		if ($rss) {
+			if ( MAGPIE_DEBUG ) {
+				debug(&quot;Returning STALE object for $url&quot;);
+			}
+			return $rss;
+		}
+		
+		// else we totally failed
+		error( $errormsg );	
+		
+		return false;
+		
+	} // end if ( !MAGPIE_CACHE_ON ) {
+} // end fetch_rss()
+
+function _fetch_remote_file ($url, $headers = &quot;&quot; ) {
+	// Snoopy is an HTTP client in PHP
+	$client = new Snoopy();
+	$client-&gt;agent = MAGPIE_USER_AGENT;
+	$client-&gt;read_timeout = MAGPIE_FETCH_TIME_OUT;
+	$client-&gt;use_gzip = MAGPIE_USE_GZIP;
+	if (is_array($headers) ) {
+		$client-&gt;rawheaders = $headers;
+	}
+	
+	@$client-&gt;fetch($url);
+	return $client;
+
+}
+
+function _response_to_rss ($resp) {
+	$rss = new MagpieRSS( $resp-&gt;results );
+	
+	// if RSS parsed successfully		
+	if ( $rss and !$rss-&gt;ERROR) {
+		
+		// find Etag, and Last-Modified
+		foreach($resp-&gt;headers as $h) {
+			// 2003-03-02 - Nicola Asuni (www.tecnick.com) - fixed bug &quot;Undefined offset: 1&quot;
+			if (strpos($h, &quot;: &quot;)) {
+				list($field, $val) = explode(&quot;: &quot;, $h, 2);
+			}
+			else {
+				$field = $h;
+				$val = &quot;&quot;;
+			}
+			
+			if ( $field == 'ETag' ) {
+				$rss-&gt;etag = $val;
+			}
+			
+			if ( $field == 'Last-Modified' ) {
+				$rss-&gt;last_modified = $val;
+			}
+		}
+		
+		return $rss;	
+	} // else construct error message
+	else {
+		$errormsg = &quot;Failed to parse RSS file.&quot;;
+		
+		if ($rss) {
+			$errormsg .= &quot; (&quot; . $rss-&gt;ERROR . &quot;)&quot;;
+		}
+		error($errormsg);
+		
+		return false;
+	} // end if ($rss and !$rss-&gt;error)
+}
+
+/*=======================================================================*\
+	Function:	init
+	Purpose:	setup constants with default values
+				check for user overrides
+\*=======================================================================*/
+function init () {
+	if ( defined('MAGPIE_INITALIZED') ) {
+		return;
+	}
+	else {
+		define('MAGPIE_INITALIZED', 1);
+	}
+	
+	if ( !defined('MAGPIE_CACHE_ON') ) {
+		define('MAGPIE_CACHE_ON', 1);
+	}
+
+	if ( !defined('MAGPIE_CACHE_DIR') ) {
+		define('MAGPIE_CACHE_DIR', './cache');
+	}
+
+	if ( !defined('MAGPIE_CACHE_AGE') ) {
+		define('MAGPIE_CACHE_AGE', 60*60); // one hour
+	}
+
+	if ( !defined('MAGPIE_CACHE_FRESH_ONLY') ) {
+		define('MAGPIE_CACHE_FRESH_ONLY', 0);
+	}
+	
+		if ( !defined('MAGPIE_DEBUG') ) {
+		define('MAGPIE_DEBUG', 0);
+	}
+
+	if ( !defined('MAGPIE_USER_AGENT') ) {
+		$ua = 'WordPress/' . $wp_version;
+		
+		if ( MAGPIE_CACHE_ON ) {
+			$ua = $ua . ')';
+		}
+		else {
+			$ua = $ua . '; No cache)';
+		}
+		
+		define('MAGPIE_USER_AGENT', $ua);
+	}
+	
+	if ( !defined('MAGPIE_FETCH_TIME_OUT') ) {
+		define('MAGPIE_FETCH_TIME_OUT', 2);	// 2 second timeout
+	}
+	
+	// use gzip encoding to fetch rss files if supported?
+	if ( !defined('MAGPIE_USE_GZIP') ) {
+		define('MAGPIE_USE_GZIP', true);	
+	}
+}
+
+function is_info ($sc) { 
+	return $sc &gt;= 100 &amp;&amp; $sc &lt; 200; 
+}
+
+function is_success ($sc) { 
+	return $sc &gt;= 200 &amp;&amp; $sc &lt; 300; 
+}
+
+function is_redirect ($sc) { 
+	return $sc &gt;= 300 &amp;&amp; $sc &lt; 400; 
+}
+
+function is_error ($sc) { 
+	return $sc &gt;= 400 &amp;&amp; $sc &lt; 600; 
+}
+
+function is_client_error ($sc) { 
+	return $sc &gt;= 400 &amp;&amp; $sc &lt; 500; 
+}
+
+function is_server_error ($sc) { 
+	return $sc &gt;= 500 &amp;&amp; $sc &lt; 600; 
+}
+
+class RSSCache {
+	var $BASE_CACHE = 'wp-content/cache';	// where the cache files are stored
+	var $MAX_AGE	= 43200;  		// when are files stale, default twelve hours
+	var $ERROR 		= '';			// accumulate error messages
+	
+	function RSSCache ($base='', $age='') {
+		if ( $base ) {
+			$this-&gt;BASE_CACHE = $base;
+		}
+		if ( $age ) {
+			$this-&gt;MAX_AGE = $age;
+		}
+	
+	}
+	
+/*=======================================================================*\
+	Function:	set
+	Purpose:	add an item to the cache, keyed on url
+	Input:		url from wich the rss file was fetched
+	Output:		true on sucess	
+\*=======================================================================*/
+	function set ($url, $rss) {
+		global $wpdb;
+		$cache_option = 'rss_' . $this-&gt;file_name( $url );
+		$cache_timestamp = 'rss_' . $this-&gt;file_name( $url ) . '_ts';
+		
+		if ( !$wpdb-&gt;get_var(&quot;SELECT option_name FROM $wpdb-&gt;options WHERE option_name = '$cache_option'&quot;) )
+			add_option($cache_option, '', '', 'no');
+		if ( !$wpdb-&gt;get_var(&quot;SELECT option_name FROM $wpdb-&gt;options WHERE option_name = '$cache_timestamp'&quot;) )
+			add_option($cache_timestamp, '', '', 'no');
+		
+		update_option($cache_option, $rss);
+		update_option($cache_timestamp, time() );
+		
+		return $cache_option;
+	}
+	
+/*=======================================================================*\
+	Function:	get
+	Purpose:	fetch an item from the cache
+	Input:		url from wich the rss file was fetched
+	Output:		cached object on HIT, false on MISS	
+\*=======================================================================*/	
+	function get ($url) {
+		$this-&gt;ERROR = &quot;&quot;;
+		$cache_option = 'rss_' . $this-&gt;file_name( $url );
+		
+		if ( ! get_option( $cache_option ) ) {
+			$this-&gt;debug( 
+				&quot;Cache doesn't contain: $url (cache option: $cache_option)&quot;
+			);
+			return 0;
+		}
+		
+		$rss = get_option( $cache_option );
+		
+		return $rss;
+	}
+
+/*=======================================================================*\
+	Function:	check_cache
+	Purpose:	check a url for membership in the cache
+				and whether the object is older then MAX_AGE (ie. STALE)
+	Input:		url from wich the rss file was fetched
+	Output:		cached object on HIT, false on MISS	
+\*=======================================================================*/		
+	function check_cache ( $url ) {
+		$this-&gt;ERROR = &quot;&quot;;
+		$cache_option = $this-&gt;file_name( $url );
+		$cache_timestamp = 'rss_' . $this-&gt;file_name( $url ) . '_ts';
+
+		if ( $mtime = get_option($cache_timestamp) ) {
+			// find how long ago the file was added to the cache
+			// and whether that is longer then MAX_AGE
+			$age = time() - $mtime;
+			if ( $this-&gt;MAX_AGE &gt; $age ) {
+				// object exists and is current
+				return 'HIT';
+			}
+			else {
+				// object exists but is old
+				return 'STALE';
+			}
+		}
+		else {
+			// object does not exist
+			return 'MISS';
+		}
+	}
+
+/*=======================================================================*\
+	Function:	serialize
+\*=======================================================================*/		
+	function serialize ( $rss ) {
+		return serialize( $rss );
+	}
+
+/*=======================================================================*\
+	Function:	unserialize
+\*=======================================================================*/		
+	function unserialize ( $data ) {
+		return unserialize( $data );
+	}
+	
+/*=======================================================================*\
+	Function:	file_name
+	Purpose:	map url to location in cache
+	Input:		url from wich the rss file was fetched
+	Output:		a file name
+\*=======================================================================*/		
+	function file_name ($url) {
+		return md5( $url );
+	}
+	
+/*=======================================================================*\
+	Function:	error
+	Purpose:	register error
+\*=======================================================================*/			
+	function error ($errormsg, $lvl=E_USER_WARNING) {
+		// append PHP's error message if track_errors enabled
+		if ( isset($php_errormsg) ) { 
+			$errormsg .= &quot; ($php_errormsg)&quot;;
+		}
+		$this-&gt;ERROR = $errormsg;
+		if ( MAGPIE_DEBUG ) {
+			trigger_error( $errormsg, $lvl);
+		}
+		else {
+			error_log( $errormsg, 0);
+		}
+	}
+			function debug ($debugmsg, $lvl=E_USER_NOTICE) {
+		if ( MAGPIE_DEBUG ) {
+			$this-&gt;error(&quot;MagpieRSS [debug] $debugmsg&quot;, $lvl);
+		}
+	}
+}
+
+function parse_w3cdtf ( $date_str ) {
+	
+	# regex to match wc3dtf
+	$pat = &quot;/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(:(\d{2}))?(?:([-+])(\d{2}):?(\d{2})|(Z))?/&quot;;
+	
+	if ( preg_match( $pat, $date_str, $match ) ) {
+		list( $year, $month, $day, $hours, $minutes, $seconds) = 
+			array( $match[1], $match[2], $match[3], $match[4], $match[5], $match[6]);
+		
+		# calc epoch for current date assuming GMT
+		$epoch = gmmktime( $hours, $minutes, $seconds, $month, $day, $year);
+		
+		$offset = 0;
+		if ( $match[10] == 'Z' ) {
+			# zulu time, aka GMT
+		}
+		else {
+			list( $tz_mod, $tz_hour, $tz_min ) =
+				array( $match[8], $match[9], $match[10]);
+			
+			# zero out the variables
+			if ( ! $tz_hour ) { $tz_hour = 0; }
+			if ( ! $tz_min ) { $tz_min = 0; }
+		
+			$offset_secs = (($tz_hour*60)+$tz_min)*60;
+			
+			# is timezone ahead of GMT?  then subtract offset
+			#
+			if ( $tz_mod == '+' ) {
+				$offset_secs = $offset_secs * -1;
+			}
+			
+			$offset = $offset_secs;	
+		}
+		$epoch = $epoch + $offset;
+		return $epoch;
+	}
+	else {
+		return -1;
+	}
+	}
+function wp_rss ($url, $num) {
+	//ini_set(&quot;display_errors&quot;, false); uncomment to suppress php errors thrown if the feed is not returned.
+	$num_items = $num;
+	$rss = fetch_rss($url);
+		if ( $rss ) {
+			echo &quot;&lt;ul&gt;&quot;;
+			$rss-&gt;items = array_slice($rss-&gt;items, 0, $num_items);
+				foreach ($rss-&gt;items as $item ) {
+					echo &quot;&lt;li&gt;\n&quot;;
+					echo &quot;&lt;a href='$item[link]' title='$item[description]'&gt;&quot;;
+					echo htmlentities($item['title']);
+					echo &quot;&lt;/a&gt;&lt;br /&gt;\n&quot;;
+					echo &quot;&lt;/li&gt;\n&quot;;
+				}		
+			echo &quot;&lt;/ul&gt;&quot;;
+	}
+		else {
+			echo &quot;an error has occured the feed is probably down, try again later.&quot;;
+	}
+}
+
+function get_rss ($uri, $num = 5) { // Like get posts, but for RSS
+	$rss = fetch_rss($url);
+	if ( $rss ) {
+		$rss-&gt;items = array_slice($rss-&gt;items, 0, $num_items);
+		foreach ($rss-&gt;items as $item ) {
+			echo &quot;&lt;li&gt;\n&quot;;
+			echo &quot;&lt;a href='$item[link]' title='$item[description]'&gt;&quot;;
+			echo htmlentities($item['title']);
+			echo &quot;&lt;/a&gt;&lt;br /&gt;\n&quot;;
+			echo &quot;&lt;/li&gt;\n&quot;;
+		}
+		return $posts;
+	} else {
+		return false;
+	}
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/streams.php
===================================================================
--- trunk/wp-includes/streams.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/streams.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,159 @@
+&lt;?php
+/*
+   Copyright (c) 2003, 2005 Danilo Segan &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">danilo at kvota.net</A>&gt;.
+
+   This file is part of PHP-gettext.
+
+   PHP-gettext is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   PHP-gettext is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with PHP-gettext; if not, write to the Free Software
+   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+*/
+
+
+// Simple class to wrap file streams, string streams, etc.
+// seek is essential, and it should be byte stream
+class StreamReader {
+  // should return a string [FIXME: perhaps return array of bytes?]
+  function read($bytes) {
+    return false;
+  }
+  
+  // should return new position
+  function seekto($position) {
+    return false;
+  }
+  
+  // returns current position
+  function currentpos() {
+    return false;
+  }
+  
+  // returns length of entire stream (limit for seekto()s)
+  function length() {
+    return false;
+  }
+}
+
+class StringReader {
+  var $_pos;
+  var $_str;
+
+  function StringReader($str='') {
+    $this-&gt;_str = $str;
+    $this-&gt;_pos = 0;
+  }
+
+  function read($bytes) {
+    $data = substr($this-&gt;_str, $this-&gt;_pos, $bytes);
+    $this-&gt;_pos += $bytes;
+    if (strlen($this-&gt;_str)&lt;$this-&gt;_pos)
+      $this-&gt;_pos = strlen($this-&gt;_str);
+
+    return $data;
+  }
+
+  function seekto($pos) {
+    $this-&gt;_pos = $pos;
+    if (strlen($this-&gt;_str)&lt;$this-&gt;_pos)
+      $this-&gt;_pos = strlen($this-&gt;_str);
+    return $this-&gt;_pos;
+  }
+
+  function currentpos() {
+    return $this-&gt;_pos;
+  }
+
+  function length() {
+    return strlen($this-&gt;_str);
+  }
+
+}
+
+
+class FileReader {
+  var $_pos;
+  var $_fd;
+  var $_length;
+
+  function FileReader($filename) {
+    if (file_exists($filename)) {
+
+      $this-&gt;_length=filesize($filename);
+      $this-&gt;_pos = 0;
+      $this-&gt;_fd = fopen($filename,'rb');
+      if (!$this-&gt;_fd) {
+	$this-&gt;error = 3; // Cannot read file, probably permissions
+	return false;
+      }
+    } else {
+      $this-&gt;error = 2; // File doesn't exist
+      return false;
+    }
+  }
+
+  function read($bytes) {
+    if ($bytes) {
+      fseek($this-&gt;_fd, $this-&gt;_pos);
+      $data = fread($this-&gt;_fd, $bytes);
+      $this-&gt;_pos = ftell($this-&gt;_fd);
+      
+      return $data;
+    } else return '';
+  }
+
+  function seekto($pos) {
+    fseek($this-&gt;_fd, $pos);
+    $this-&gt;_pos = ftell($this-&gt;_fd);
+    return $this-&gt;_pos;
+  }
+
+  function currentpos() {
+    return $this-&gt;_pos;
+  }
+
+  function length() {
+    return $this-&gt;_length;
+  }
+
+  function close() {
+    fclose($this-&gt;_fd);
+  }
+
+}
+
+// Preloads entire file in memory first, then creates a StringReader 
+// over it (it assumes knowledge of StringReader internals)
+class CachedFileReader extends StringReader {
+  function CachedFileReader($filename) {
+    if (file_exists($filename)) {
+
+      $length=filesize($filename);
+      $fd = fopen($filename,'rb');
+
+      if (!$fd) {
+	$this-&gt;error = 3; // Cannot read file, probably permissions
+	return false;
+      }
+      $this-&gt;_str = fread($fd, $length);
+      fclose($fd);
+
+    } else {
+      $this-&gt;error = 2; // File doesn't exist
+      return false;
+    }
+  }
+}
+
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/template-functions-author.php
===================================================================
--- trunk/wp-includes/template-functions-author.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/template-functions-author.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,218 @@
+&lt;?php
+function get_the_author($idmode = '') {
+    global $authordata;
+    if (empty($idmode)) {
+        $idmode = $authordata-&gt;user_idmode;
+    }
+
+    if ($idmode == 'nickname')    $id = $authordata-&gt;user_nickname;
+    if ($idmode == 'login')    $id = $authordata-&gt;user_login;
+    if ($idmode == 'firstname')    $id = $authordata-&gt;user_firstname;
+    if ($idmode == 'lastname')    $id = $authordata-&gt;user_lastname;
+    if ($idmode == 'namefl')    $id = $authordata-&gt;user_firstname.' '.$authordata-&gt;user_lastname;
+    if ($idmode == 'namelf')    $id = $authordata-&gt;user_lastname.' '.$authordata-&gt;user_firstname;
+    if (!$idmode) $id = $authordata-&gt;user_nickname;
+    
+    return $id;
+}
+function the_author($idmode = '', $echo = true) {
+	if ($echo) echo get_the_author($idmode);
+	return get_the_author($idmode);
+}
+
+function get_the_author_description() {
+    global $authordata;
+    return $authordata-&gt;user_description;
+}
+function the_author_description() {
+    echo get_the_author_description();
+}
+
+function get_the_author_login() {
+    global $id,$authordata;    return $authordata-&gt;user_login;
+}
+function the_author_login() {
+    echo get_the_author_login();
+}
+
+function get_the_author_firstname() {
+    global $id,$authordata;    return $authordata-&gt;user_firstname;
+}
+function the_author_firstname() {
+    echo get_the_author_firstname();
+}
+
+function get_the_author_lastname() {
+    global $id,$authordata;    return $authordata-&gt;user_lastname;
+}
+function the_author_lastname() {
+    echo get_the_author_lastname();
+}
+
+function get_the_author_nickname() {
+    global $id,$authordata;    return $authordata-&gt;user_nickname;
+}
+function the_author_nickname() {
+    echo get_the_author_nickname();
+}
+
+function get_the_author_ID() {
+    global $id,$authordata;    return $authordata-&gt;ID;
+}
+function the_author_ID() {
+    echo get_the_author_id();
+}
+
+function get_the_author_email() {
+	global $authordata;
+	return $authordata-&gt;user_email;
+}
+
+function the_author_email() {
+	echo apply_filters('the_author_email', get_the_author_email() );
+}
+
+function get_the_author_url() {
+    global $id,$authordata;    return $authordata-&gt;user_url;
+}
+function the_author_url() {
+    echo get_the_author_url();
+}
+
+function get_the_author_icq() {
+    global $id,$authordata;    return $authordata-&gt;user_icq;
+}
+function the_author_icq() {
+    echo get_the_author_icq();
+}
+
+function get_the_author_aim() {
+    global $id,$authordata;    return str_replace(' ', '+', $authordata-&gt;user_aim);
+}
+function the_author_aim() {
+    echo get_the_author_aim();
+}
+
+function get_the_author_yim() {
+    global $id,$authordata;    return $authordata-&gt;user_yim;
+}
+function the_author_yim() {
+    echo get_the_author_yim();
+}
+
+function get_the_author_msn() {
+    global $id,$authordata;    return $authordata-&gt;user_msn;
+}
+function the_author_msn() {
+    echo get_the_author_msn();
+}
+
+function get_the_author_posts() {
+    global $id,$post;    $posts=get_usernumposts($post-&gt;post_author);    return $posts;
+}
+function the_author_posts() {
+    echo get_the_author_posts();
+}
+
+/* the_author_posts_link() requires no get_, use get_author_link() */
+function the_author_posts_link($idmode='') {
+    global $id, $authordata;
+
+    echo '&lt;a href=&quot;' . get_author_link(0, $authordata-&gt;ID, $authordata-&gt;user_nicename) . '&quot; title=&quot;' . sprintf(__(&quot;Posts by %s&quot;), wp_specialchars(the_author($idmode, false))) . '&quot;&gt;' . the_author($idmode, false) . '&lt;/a&gt;';
+}
+
+
+function get_author_link($echo = false, $author_id, $author_nicename) {
+	global $wpdb, $wp_rewrite, $post, $cache_userdata;
+    $auth_ID = $author_id;
+    $link = $wp_rewrite-&gt;get_author_permastruct();
+    
+    if (empty($link)) {
+        $file = get_settings('home') . '/';
+        $link = $file . '?author=' . $auth_ID;
+    } else {
+        if ('' == $author_nicename) $author_nicename = $cache_userdata[$author_id]-&gt;author_nicename;
+				$link = str_replace('%author%', $author_nicename, $link);
+				$link = get_settings('home') . trailingslashit($link);
+    }
+
+		$link = apply_filters('author_link', $link, $author_id, $author_nicename);
+    if ($echo) echo $link;
+    return $link;
+}
+
+function wp_list_authors($args = '') {
+	parse_str($args, $r);
+	if (!isset($r['optioncount'])) $r['optioncount'] = false;
+    if (!isset($r['exclude_admin'])) $r['exclude_admin'] = true;
+    if (!isset($r['show_fullname'])) $r['show_fullname'] = false;
+	if (!isset($r['hide_empty'])) $r['hide_empty'] = true;
+    if (!isset($r['feed'])) $r['feed'] = '';
+    if (!isset($r['feed_image'])) $r['feed_image'] = '';
+
+	list_authors($r['optioncount'], $r['exclude_admin'], $r['show_fullname'], $r['hide_empty'], $r['feed'], $r['feed_image']);
+}
+
+function list_authors($optioncount = false, $exclude_admin = true, $show_fullname = false, $hide_empty = true, $feed = '', $feed_image = '') {
+    global $wpdb;
+
+    $query = &quot;SELECT ID, user_nickname, user_firstname, user_lastname, user_nicename from $wpdb-&gt;users &quot; . ($exclude_admin ? &quot;WHERE user_login &lt;&gt; 'admin' &quot; : '') . &quot;ORDER BY user_nickname&quot;;
+    $authors = $wpdb-&gt;get_results($query);
+
+    foreach($authors as $author) {
+        $posts = get_usernumposts($author-&gt;ID);
+        $name = $author-&gt;user_nickname;
+
+        if ($show_fullname &amp;&amp; ($author-&gt;user_firstname != '' &amp;&amp; $author-&gt;user_lastname != '')) {
+            $name = &quot;$author-&gt;user_firstname $author-&gt;user_lastname&quot;;
+        }
+        
+        if (! ($posts == 0 &amp;&amp; $hide_empty)) echo &quot;&lt;li&gt;&quot;;
+        if ($posts == 0) {
+            if ( !$hide_empty )
+				$link = $name;
+        } else {
+            $link = '&lt;a href=&quot;' . get_author_link(0, $author-&gt;ID, $author-&gt;user_nicename) . '&quot; title=&quot;' . sprintf(__(&quot;Posts by %s&quot;), wp_specialchars($author-&gt;user_nickname)) . '&quot;&gt;' . $name . '&lt;/a&gt;';
+
+            if ( (! empty($feed_image)) || (! empty($feed)) ) {
+                
+                $link .= ' ';
+
+                if (empty($feed_image)) {
+                    $link .= '(';
+                }
+
+                $link .= '&lt;a href=&quot;' . get_author_rss_link(0, $author-&gt;ID, $author-&gt;user_nicename)  . '&quot;';
+
+                if (! empty($feed)) {
+                    $title =  ' title=&quot;' . $feed . '&quot;';
+                    $alt = ' alt=&quot;' . $feed . '&quot;';
+                    $name = $feed;
+                    $link .= $title;
+                }
+
+                $link .= '&gt;';
+
+                if (! empty($feed_image)) {
+                    $link .= &quot;&lt;img src=\&quot;$feed_image\&quot; border=\&quot;0\&quot;$alt$title&quot; . ' /&gt;';
+                } else {
+                    $link .= $name;
+                }
+                
+                $link .= '&lt;/a&gt;';
+
+                if (empty($feed_image)) {
+                    $link .= ')';
+                }
+            }
+
+            if ($optioncount) {
+                $link .= ' ('. $posts . ')';
+            }
+        }
+
+        if (! ($posts == 0 &amp;&amp; $hide_empty)) echo &quot;$link&lt;/li&gt;&quot;;
+    }
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/template-functions-category.php
===================================================================
--- trunk/wp-includes/template-functions-category.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/template-functions-category.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,404 @@
+&lt;?php
+
+function get_the_category($id = false) {
+    global $post, $category_cache;
+
+	if ( !$id )
+		$id = $post-&gt;ID;
+
+	if ( ! isset($category_cache[$id]) )
+		update_post_category_cache($id);
+
+	$categories = $category_cache[$id];
+
+	if (!empty($categories))
+		sort($categories);
+	else
+		$categories = array();
+
+	return $categories;
+}
+
+function get_category_link($category_id) {
+	global $wp_rewrite;
+	$catlink = $wp_rewrite-&gt;get_category_permastruct();
+
+	if ( empty($catlink) ) {
+		$file = get_settings('home') . '/' . get_settings('blogfilename');
+		$catlink = $file . '?cat=' . $category_id;
+	} else {
+		$category = &amp;get_category($category_id);
+		$category_nicename = $category-&gt;category_nicename;
+
+		if ($parent = $category-&gt;category_parent) 
+			$category_nicename = get_category_parents($parent, false, '/', true) . $category_nicename . '/';
+
+		$catlink = str_replace('%category%', $category_nicename, $catlink);
+		$catlink = get_settings('home') . trailingslashit($catlink);
+	}
+	return apply_filters('category_link', $catlink, $category_id);
+}
+
+function get_the_category_list($separator = '', $parents='') {
+    $categories = get_the_category();
+    if (empty($categories)) {
+			return apply_filters('the_category', __('Uncategorized'), $separator, $parents);
+    }
+
+    $thelist = '';
+    if ('' == $separator) {
+        $thelist .= '&lt;ul class=&quot;post-categories&quot;&gt;';
+        foreach ($categories as $category) {
+            $category-&gt;cat_name = $category-&gt;cat_name;
+            $thelist .= &quot;\n\t&lt;li&gt;&quot;;
+            switch(strtolower($parents)) {
+                case 'multiple':
+                    if ($category-&gt;category_parent) {
+                        $thelist .= get_category_parents($category-&gt;category_parent, TRUE);
+                    }
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . '&quot; rel=&quot;category tag&quot;&gt;'.$category-&gt;cat_name.'&lt;/a&gt;&lt;/li&gt;';
+                    break;
+                case 'single':
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . ' rel=&quot;category tag&quot;&gt;';
+                    if ($category-&gt;category_parent) {
+                        $thelist .= get_category_parents($category-&gt;category_parent, FALSE);
+                    }
+                    $thelist .= $category-&gt;cat_name.'&lt;/a&gt;&lt;/li&gt;';
+                    break;
+                case '':
+                default:
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . '&quot; rel=&quot;category tag&quot;&gt;'.$category-&gt;cat_name.'&lt;/a&gt;&lt;/li&gt;';
+            }
+        }
+        $thelist .= '&lt;/ul&gt;';
+    } else {
+        $i = 0;
+        foreach ($categories as $category) {
+            $category-&gt;cat_name = $category-&gt;cat_name;
+            if (0 &lt; $i) $thelist .= $separator . ' ';
+            switch(strtolower($parents)) {
+                case 'multiple':
+                    if ($category-&gt;category_parent)    $thelist .= get_category_parents($category-&gt;category_parent, TRUE);
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . '&quot; rel=&quot;category tag&quot;&gt;'.$category-&gt;cat_name.'&lt;/a&gt;';
+                    break;
+                case 'single':
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . '&quot; rel=&quot;category tag&quot;&gt;';
+                    if ($category-&gt;category_parent)    $thelist .= get_category_parents($category-&gt;category_parent, FALSE);
+                    $thelist .= &quot;$category-&gt;cat_name&lt;/a&gt;&quot;;
+                    break;
+                case '':
+                default:
+                    $thelist .= '&lt;a href=&quot;' . get_category_link($category-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $category-&gt;cat_name) . '&quot; rel=&quot;category tag&quot;&gt;'.$category-&gt;cat_name.'&lt;/a&gt;';
+            }
+            ++$i;
+        }
+    }
+    return apply_filters('the_category', $thelist, $separator, $parents);
+}
+
+function the_category($separator = '', $parents='') {
+	echo get_the_category_list($separator, $parents);
+}
+
+function get_the_category_by_ID($cat_ID) {
+	$cat_ID = (int) $cat_ID;
+	$category = &amp;get_category($cat_ID);
+	return $category-&gt;cat_name;
+}
+
+function get_category_parents($id, $link = FALSE, $separator = '/', $nicename = FALSE){
+    $chain = '';
+		$parent = &amp;get_category($id);
+    if ($nicename) {
+        $name = $parent-&gt;category_nicename;
+    } else {
+        $name = $parent-&gt;cat_name;
+    }
+    if ($parent-&gt;category_parent) $chain .= get_category_parents($parent-&gt;category_parent, $link, $separator, $nicename);
+    if ($link) {
+        $chain .= '&lt;a href=&quot;' . get_category_link($parent-&gt;cat_ID) . '&quot; title=&quot;' . sprintf(__(&quot;View all posts in %s&quot;), $parent-&gt;cat_name) . '&quot;&gt;'.$name.'&lt;/a&gt;' . $separator;
+    } else {
+        $chain .= $name.$separator;
+    }
+    return $chain;
+}
+
+function get_category_children($id, $before = '/', $after = '') {
+	global $cache_categories;
+
+	if ( ! isset($cache_categories))
+		update_category_cache();
+		
+	$c_cache = $cache_categories; // Can't do recursive foreach on a global, have to make a copy
+	$chain = '';
+	foreach ($c_cache as $category){
+		if ($category-&gt;category_parent == $id){
+			$chain .= $before.$category-&gt;cat_ID.$after;
+			$chain .= get_category_children($category-&gt;cat_ID, $before, $after);
+		}
+	}
+	return $chain;
+}
+
+// Deprecated.
+function the_category_ID($echo = true) {
+    // Grab the first cat in the list.
+    $categories = get_the_category();
+    $cat = $categories[0]-&gt;cat_ID;
+    
+    if ($echo) echo $cat;
+
+    return $cat;
+}
+
+// Deprecated.
+function the_category_head($before='', $after='') {
+    global $currentcat, $previouscat;
+    // Grab the first cat in the list.
+    $categories = get_the_category();
+    $currentcat = $categories[0]-&gt;category_id;
+    if ($currentcat != $previouscat) {
+        echo $before;
+        echo get_the_category_by_ID($currentcat);
+        echo $after;
+        $previouscat = $currentcat;
+    }
+}
+
+function category_description($category = 0) {
+    global $cat;
+    if (!$category) $category = $cat;
+		$category = &amp; get_category($category);
+    return apply_filters('category_description', $category-&gt;category_description, $category-&gt;cat_ID);
+}
+
+// out of the WordPress loop
+function dropdown_cats($optionall = 1, $all = 'All', $sort_column = 'ID', $sort_order = 'asc',
+        $optiondates = 0, $optioncount = 0, $hide_empty = 1, $optionnone=FALSE,
+        $selected=0, $hide=0) {
+    global $wpdb;
+    if (($file == 'blah') || ($file == '')) $file = get_settings('home') . '/';
+    if (!$selected) $selected=$cat;
+    $sort_column = 'cat_'.$sort_column;
+
+    $query = &quot;
+        SELECT cat_ID, cat_name, category_nicename,category_parent,
+        COUNT($wpdb-&gt;post2cat.post_id) AS cat_count,
+        DAYOFMONTH(MAX(post_date)) AS lastday, MONTH(MAX(post_date)) AS lastmonth
+        FROM $wpdb-&gt;categories LEFT JOIN $wpdb-&gt;post2cat ON (cat_ID = category_id)
+        LEFT JOIN $wpdb-&gt;posts ON (ID = post_id)
+        WHERE cat_ID &gt; 0
+        &quot;;
+    if ($hide) {
+        $query .= &quot; AND cat_ID != $hide&quot;;
+        $query .= get_category_children($hide, &quot; AND cat_ID != &quot;);
+    }
+    $query .=&quot; GROUP BY cat_ID&quot;;
+    if (intval($hide_empty) == 1) $query .= &quot; HAVING cat_count &gt; 0&quot;;
+    $query .= &quot; ORDER BY $sort_column $sort_order, post_date DESC&quot;;
+
+    $categories = $wpdb-&gt;get_results($query);
+    echo &quot;&lt;select name='cat' class='postform'&gt;\n&quot;;
+    if (intval($optionall) == 1) {
+        $all = apply_filters('list_cats', $all);
+        echo &quot;\t&lt;option value='0'&gt;$all&lt;/option&gt;\n&quot;;
+    }
+    if (intval($optionnone) == 1) echo &quot;\t&lt;option value='-1'&gt;&quot;.__('None').&quot;&lt;/option&gt;\n&quot;;
+    if ($categories) {
+        foreach ($categories as $category) {
+            $cat_name = apply_filters('list_cats', $category-&gt;cat_name, $category);
+            echo &quot;\t&lt;option value=\&quot;&quot;.$category-&gt;cat_ID.&quot;\&quot;&quot;;
+            if ($category-&gt;cat_ID == $selected)
+                echo ' selected=&quot;selected&quot;';
+            echo '&gt;';
+            echo $cat_name;
+            if (intval($optioncount) == 1) echo '&nbsp;&nbsp;('.$category-&gt;cat_count.')';
+            if (intval($optiondates) == 1) echo '&nbsp;&nbsp;'.$category-&gt;lastday.'/'.$category-&gt;lastmonth;
+            echo &quot;&lt;/option&gt;\n&quot;;
+        }
+    }
+    echo &quot;&lt;/select&gt;\n&quot;;
+}
+
+// out of the WordPress loop
+function wp_list_cats($args = '') {
+	parse_str($args, $r);
+	if (!isset($r['optionall'])) $r['optionall'] = 0;
+    if (!isset($r['all'])) $r['all'] = 'All';
+	if (!isset($r['sort_column'])) $r['sort_column'] = 'ID';
+	if (!isset($r['sort_order'])) $r['sort_order'] = 'asc';
+	if (!isset($r['file'])) $r['file'] = '';
+	if (!isset($r['list'])) $r['list'] = true;
+	if (!isset($r['optiondates'])) $r['optiondates'] = 0;
+	if (!isset($r['optioncount'])) $r['optioncount'] = 0;
+	if (!isset($r['hide_empty'])) $r['hide_empty'] = 1;
+	if (!isset($r['use_desc_for_title'])) $r['use_desc_for_title'] = 1;
+	if (!isset($r['children'])) $r['children'] = true;
+	if (!isset($r['child_of'])) $r['child_of'] = 0;
+	if (!isset($r['categories'])) $r['categories'] = 0;
+	if (!isset($r['recurse'])) $r['recurse'] = 0;
+	if (!isset($r['feed'])) $r['feed'] = '';
+	if (!isset($r['feed_image'])) $r['feed_image'] = '';
+	if (!isset($r['exclude'])) $r['exclude'] = '';
+	if (!isset($r['hierarchical'])) $r['hierarchical'] = true;
+
+	list_cats($r['optionall'], $r['all'], $r['sort_column'], $r['sort_order'], $r['file'],	$r['list'], $r['optiondates'], $r['optioncount'], $r['hide_empty'], $r['use_desc_for_title'], $r['children'], $r['child_of'], $r['categories'], $r['recurse'], $r['feed'], $r['feed_image'], $r['exclude'], $r['hierarchical']);
+}
+
+function list_cats($optionall = 1, $all = 'All', $sort_column = 'ID', $sort_order = 'asc', $file = '', $list = true, $optiondates = 0, $optioncount = 0, $hide_empty = 1, $use_desc_for_title = 1, $children=FALSE, $child_of=0, $categories=0, $recurse=0, $feed = '', $feed_image = '', $exclude = '', $hierarchical=FALSE) {
+	global $wpdb, $category_posts;
+	// Optiondates now works
+	if ('' == $file) {
+		$file = get_settings('home') . '/';
+	}
+
+	$exclusions = '';
+	if (!empty($exclude)) {
+		$excats = preg_split('/[\s,]+/',$exclude);
+		if (count($excats)) {
+			foreach ($excats as $excat) {
+				$exclusions .= ' AND cat_ID &lt;&gt; ' . intval($excat) . ' ';
+			}
+		}
+	}
+
+	$exclusions = apply_filters('list_cats_exclusions', $exclusions);
+
+	if (intval($categories)==0){
+		$sort_column = 'cat_'.$sort_column;
+
+		$query  = &quot;
+			SELECT cat_ID, cat_name, category_nicename, category_description, category_parent
+			FROM $wpdb-&gt;categories
+			WHERE cat_ID &gt; 0 $exclusions
+			ORDER BY $sort_column $sort_order&quot;;
+
+		$categories = $wpdb-&gt;get_results($query);
+	}
+	if (!count($category_posts)) {
+		$now = current_time('mysql', 1);
+		$cat_counts = $wpdb-&gt;get_results(&quot;	SELECT cat_ID,
+		COUNT($wpdb-&gt;post2cat.post_id) AS cat_count
+		FROM $wpdb-&gt;categories 
+		INNER JOIN $wpdb-&gt;post2cat ON (cat_ID = category_id)
+		INNER JOIN $wpdb-&gt;posts ON (ID = post_id)
+		WHERE post_status = 'publish'
+		AND post_date_gmt &lt; '$now' $exclusions
+		GROUP BY category_id&quot;);
+        if (! empty($cat_counts)) {
+            foreach ($cat_counts as $cat_count) {
+                if (1 != intval($hide_empty) || $cat_count &gt; 0) {
+                    $category_posts[&quot;$cat_count-&gt;cat_ID&quot;] = $cat_count-&gt;cat_count;
+                }
+            }
+        }
+	}
+	
+	if ( $optiondates ) {
+		$cat_dates = $wpdb-&gt;get_results(&quot;	SELECT category_id,
+		UNIX_TIMESTAMP( MAX(post_date) ) AS ts
+		FROM $wpdb-&gt;posts, $wpdb-&gt;post2cat
+		WHERE post_status = 'publish' AND post_id = ID $exclusions
+		GROUP BY category_id&quot;);
+		foreach ($cat_dates as $cat_date) {
+			$category_timestamp[&quot;$cat_date-&gt;category_id&quot;] = $cat_date-&gt;ts;
+		}
+	}
+	
+	$num_found=0;
+	$thelist = &quot;&quot;;
+	
+	foreach ($categories as $category) {
+		if ((intval($hide_empty) == 0 || isset($category_posts[&quot;$category-&gt;cat_ID&quot;])) &amp;&amp; (!$hierarchical || $category-&gt;category_parent == $child_of) ) {
+			$num_found++;
+			$link = '&lt;a href=&quot;'.get_category_link($category-&gt;cat_ID).'&quot; ';
+			if ($use_desc_for_title == 0 || empty($category-&gt;category_description)) {
+				$link .= 'title=&quot;'. sprintf(__(&quot;View all posts filed under %s&quot;), wp_specialchars($category-&gt;cat_name)) . '&quot;';
+			} else {
+				$link .= 'title=&quot;' . wp_specialchars(apply_filters('category_description',$category-&gt;category_description,$category)) . '&quot;';
+			}
+			$link .= '&gt;';
+			$link .= apply_filters('list_cats', $category-&gt;cat_name, $category).'&lt;/a&gt;';
+
+			if ( (! empty($feed_image)) || (! empty($feed)) ) {
+				
+				$link .= ' ';
+
+				if (empty($feed_image)) {
+					$link .= '(';
+				}
+
+				$link .= '&lt;a href=&quot;' . get_category_rss_link(0, $category-&gt;cat_ID, $category-&gt;category_nicename)  . '&quot;';
+
+				if ( !empty($feed) ) {
+					$title =  ' title=&quot;' . $feed . '&quot;';
+					$alt = ' alt=&quot;' . $feed . '&quot;';
+					$name = $feed;
+					$link .= $title;
+				}
+
+				$link .= '&gt;';
+
+				if (! empty($feed_image)) {
+					$link .= &quot;&lt;img src='$feed_image' $alt$title&quot; . ' /&gt;';
+				} else {
+					$link .= $name;
+				}
+				
+				$link .= '&lt;/a&gt;';
+
+				if (empty($feed_image)) {
+					$link .= ')';
+				}
+			}
+
+			if (intval($optioncount) == 1) {
+				$link .= ' ('.intval($category_posts[&quot;$category-&gt;cat_ID&quot;]).')';
+			}
+			if ( $optiondates ) {
+				if ( $optiondates == 1 ) $optiondates = 'Y-m-d';
+				$link .= ' ' . gmdate($optiondates, $category_timestamp[&quot;$category-&gt;cat_ID&quot;]);
+			}
+			if ($list) {
+				$thelist .= &quot;\t&lt;li&gt;$link\n&quot;;
+			} else {
+				$thelist .= &quot;\t$link&lt;br /&gt;\n&quot;;
+			}
+			if ($hierarchical &amp;&amp; $children) $thelist .= list_cats($optionall, $all, $sort_column, $sort_order, $file, $list, $optiondates, $optioncount, $hide_empty, $use_desc_for_title, $hierarchical, $category-&gt;cat_ID, $categories, 1, $feed, $feed_image, $exclude, $hierarchical);
+			if ($list) $thelist .= &quot;&lt;/li&gt;\n&quot;;
+			}
+	}
+	if (!$num_found &amp;&amp; !$child_of){
+		if ($list) {
+			$before = '&lt;li&gt;';
+			$after = '&lt;/li&gt;';
+		}
+		echo $before . __(&quot;No categories&quot;) . $after . &quot;\n&quot;;
+		return;
+	}
+	if ($list &amp;&amp; $child_of &amp;&amp; $num_found &amp;&amp; $recurse) {
+		$pre = &quot;\t\t&lt;ul class='children'&gt;&quot;;
+		$post = &quot;\t\t&lt;/ul&gt;\n&quot;;
+	} else {
+		$pre = $post = '';
+	}
+	$thelist = $pre . $thelist . $post;
+	if ($recurse) {
+		return $thelist;
+	}
+	echo apply_filters('list_cats', $thelist);
+}
+
+function in_category($category) { // Check if the current post is in the given category
+	global $post, $category_cache;
+	$cats = '';
+	foreach ($category_cache[$post-&gt;ID] as $cat) :
+		$cats[] = $cat-&gt;cat_ID;
+	endforeach;
+
+	if ( in_array($category, $cats) )
+		return true;
+	else
+		return false;
+}
+?&gt;

Added: trunk/wp-includes/template-functions-general.php
===================================================================
--- trunk/wp-includes/template-functions-general.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/template-functions-general.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,644 @@
+&lt;?php
+
+/* Note: these tags go anywhere in the template */
+
+function get_header() {
+	if ( file_exists( TEMPLATEPATH . '/header.php') )
+		load_template( TEMPLATEPATH . '/header.php');
+	else
+		load_template( ABSPATH . 'wp-content/themes/default/header.php');
+}
+
+function get_footer() {
+	if ( file_exists( TEMPLATEPATH . '/footer.php') )
+		load_template( TEMPLATEPATH . '/footer.php');
+	else
+		load_template( ABSPATH . 'wp-content/themes/default/footer.php');
+}
+
+function get_sidebar() {
+	if ( file_exists( TEMPLATEPATH . '/sidebar.php') )
+		load_template( TEMPLATEPATH . '/sidebar.php');
+	else
+		load_template( ABSPATH . 'wp-content/themes/default/sidebar.php');
+}
+
+
+function wp_loginout() {
+	global $user_ID;
+	get_currentuserinfo();
+
+	if ('' == $user_ID) :
+		$link = '&lt;a href=&quot;' . get_settings('siteurl') . '/wp-login.php&quot;&gt;' . __('Login') . '&lt;/a&gt;';
+	else :
+		$link = '&lt;a href=&quot;' . get_settings('siteurl') . '/wp-login.php?action=logout&quot;&gt;' . __('Logout') . '&lt;/a&gt;';
+	endif;
+
+	echo apply_filters('loginout', $link);
+}
+
+function wp_register( $before = '&lt;li&gt;', $after = '&lt;/li&gt;' ) {
+	global $user_ID;
+
+	get_currentuserinfo();
+
+	if ('' == $user_ID &amp;&amp; get_settings('users_can_register') ) :
+		$link = $before . '&lt;a href=&quot;' . get_settings('siteurl') . '/wp-register.php&quot;&gt;' . __('Register') . '&lt;/a&gt;' . $after;
+	elseif ('' == $user_ID &amp;&amp; !get_settings('users_can_register') ) : 
+		$link = '';
+	else :
+		$link = $before . '&lt;a href=&quot;' . get_settings('siteurl') . '/wp-admin/&quot;&gt;' . __('Site Admin') . '&lt;/a&gt;' . $after;
+	endif;
+
+	echo apply_filters('register', $link);
+}
+
+function wp_meta() {
+	do_action('wp_meta');
+}
+
+function bloginfo($show='') {
+    $info = get_bloginfo($show);
+    $info = apply_filters('bloginfo', $info, $show);
+    echo convert_chars($info);
+}
+
+function get_bloginfo($show='') {
+
+	switch($show) {
+	case 'url' :
+	case 'home' : 
+	case 'siteurl' :
+		$output = get_settings('home');
+		break;
+	case 'wpurl' :
+		$output = get_settings('siteurl');
+		break;
+	case 'description':
+		$output = get_settings('blogdescription');
+		break;
+	case 'rdf_url':
+		$output = get_feed_link('rdf');
+		break;
+	case 'rss_url':
+		$output = get_feed_link('rss');
+		break;
+	case 'rss2_url':
+		$output = get_feed_link('rss2');
+		break;
+	case 'atom_url':
+		$output = get_feed_link('atom');
+		break;        
+	case 'comments_rss2_url':
+		$output = get_feed_link('comments_rss2');
+		break;
+	case 'pingback_url':
+		$output = get_settings('siteurl') .'/xmlrpc.php';
+		break;
+	case 'stylesheet_url':
+		$output = get_stylesheet_uri();
+		break;
+	case 'stylesheet_directory':
+		$output = get_stylesheet_directory_uri();
+		break;
+	case 'template_directory':
+	case 'template_url':
+		$output = get_template_directory_uri();
+		break;
+	case 'admin_email':
+		$output = get_settings('admin_email');
+		break;
+	case 'charset':
+		$output = get_settings('blog_charset');
+		if ('' == $output) $output = 'UTF-8';
+		break;
+	case 'html_type' :
+		$output = get_option('html_type');
+		break;
+	case 'version':
+		global $wp_version;
+		$output = $wp_version;
+		break;
+	case 'name':
+	default:
+		$output = get_settings('blogname');
+		break;
+	}
+	return $output;
+}
+
+function wp_title($sep = '&raquo;', $display = true) {
+    global $wpdb;
+    global $m, $year, $monthnum, $day, $category_name, $month, $posts;
+
+		$cat = get_query_var('cat');
+		$p = get_query_var('p');
+		$name = get_query_var('name');
+		$category_name = get_query_var('category_name');
+
+    // If there's a category
+    if(!empty($cat)) {
+        if (!stristr($cat,'-')) { // category excluded
+            $title = get_the_category_by_ID($cat);
+        }
+    }
+    if (!empty($category_name)) {
+        if (stristr($category_name,'/')) {
+            $category_name = explode('/',$category_name);
+            if ($category_name[count($category_name)-1]) {
+                $category_name = $category_name[count($category_name)-1]; // no trailing slash
+            } else {
+                $category_name = $category_name[count($category_name)-2]; // there was a trailling slash
+            }
+        }
+        $title = $wpdb-&gt;get_var(&quot;SELECT cat_name FROM $wpdb-&gt;categories WHERE category_nicename = '$category_name'&quot;);
+    }
+
+    // If there's a month
+    if(!empty($m)) {
+        $my_year = substr($m, 0, 4);
+        $my_month = $month[substr($m, 4, 2)];
+        $title = &quot;$my_year $sep $my_month&quot;;
+
+    }
+    if (!empty($year)) {
+        $title = $year;
+        if (!empty($monthnum)) {
+            $title .= &quot; $sep &quot;.$month[zeroise($monthnum, 2)];
+        }
+        if (!empty($day)) {
+            $title .= &quot; $sep &quot;.zeroise($day, 2);
+        }
+    }
+
+    // If there's a post
+    if (is_single() || is_page()) {
+        $title = strip_tags($posts[0]-&gt;post_title);
+        $title = apply_filters('single_post_title', $title);
+    }
+
+    // Send it out
+    if ($display &amp;&amp; isset($title)) {
+        echo &quot; $sep $title&quot;;
+    } elseif (!$display &amp;&amp; isset($title)) {
+        return &quot; $sep $title&quot;;
+    }
+}
+
+function single_post_title($prefix = '', $display = true) {
+    global $wpdb;
+		$p = get_query_var('p');
+		$name = get_query_var('name');
+    if (intval($p) || '' != $name) {
+        if (!$p) {
+            $p = $wpdb-&gt;get_var(&quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_name = '$name'&quot;);
+        }
+        $post = &amp; get_post($p);
+        $title = $post-&gt;post_title;
+        $title = apply_filters('single_post_title', $title);
+        if ($display) {
+            echo $prefix.strip_tags($title);
+        } else {
+            return strip_tags($title);
+        }
+    }
+}
+
+function single_cat_title($prefix = '', $display = true ) {
+	$cat = intval( get_query_var('cat') );
+	if( !empty($cat) &amp;&amp; !(strtoupper($cat) == 'ALL') ) {
+		$my_cat_name = get_the_category_by_ID($cat);
+		if( !empty($my_cat_name) ) {
+			if ($display)
+				echo $prefix.strip_tags($my_cat_name);
+			else
+				return strip_tags($my_cat_name);
+		}
+	}
+}
+
+function single_month_title($prefix = '', $display = true ) {
+	global $m, $monthnum, $month, $year;
+	if(!empty($monthnum) &amp;&amp; !empty($year)) {
+		$my_year = $year;
+		$my_month = $month[str_pad($monthnum, 2, '0', STR_PAD_LEFT)];
+	} elseif(!empty($m)) {
+		$my_year = substr($m, 0, 4);
+		$my_month = $month[substr($m, 4, 2)];
+	}
+
+	if (!empty($my_month) &amp;&amp; $display) {
+		echo $prefix . $my_month . $prefix . $my_year;
+	} else {
+		return $monthnum;
+	}
+}
+
+/* link navigation hack by Orien <A HREF="http://icecode.com/">http://icecode.com/</A> */
+function get_archives_link($url, $text, $format = 'html', $before = '', $after = '') {
+	$text = wptexturize($text);
+    $title_text = wp_specialchars($text, 1);
+
+	if ('link' == $format) {
+		return &quot;\t&lt;link rel='archives' title='$title_text' href='$url' /&gt;\n&quot;;
+	} elseif ('option' == $format) {
+		return &quot;\t&lt;option value='$url'&gt;$before $text $after&lt;/option&gt;\n&quot;;
+	} elseif ('html' == $format) {
+		return &quot;\t&lt;li&gt;$before&lt;a href='$url' title='$title_text'&gt;$text&lt;/a&gt;$after&lt;/li&gt;\n&quot;;
+	} else { // custom
+		return &quot;\t$before&lt;a href='$url' title='$title_text'&gt;$text&lt;/a&gt;$after\n&quot;;
+	}
+}
+
+function wp_get_archives($args = '') {
+	parse_str($args, $r);
+	if (!isset($r['type'])) $r['type'] = '';
+	if (!isset($r['limit'])) $r['limit'] = '';
+	if (!isset($r['format'])) $r['format'] = 'html';
+	if (!isset($r['before'])) $r['before'] = '';
+	if (!isset($r['after'])) $r['after'] = '';
+	if (!isset($r['show_post_count'])) $r['show_post_count'] = false;
+	get_archives($r['type'], $r['limit'], $r['format'], $r['before'], $r['after'], $r['show_post_count']);
+}
+
+function get_archives($type='', $limit='', $format='html', $before = '', $after = '', $show_post_count = false) {
+    global $month, $wpdb;
+
+    if ('' == $type) {
+        $type = 'monthly';
+    }
+
+    if ('' != $limit) {
+        $limit = (int) $limit;
+        $limit = ' LIMIT '.$limit;
+    }
+    // this is what will separate dates on weekly archive links
+    $archive_week_separator = '&#8211;';
+
+    // over-ride general date format ? 0 = no: use the date format set in Options, 1 = yes: over-ride
+    $archive_date_format_over_ride = 0;
+
+    // options for daily archive (only if you over-ride the general date format)
+    $archive_day_date_format = 'Y/m/d';
+
+    // options for weekly archive (only if you over-ride the general date format)
+    $archive_week_start_date_format = 'Y/m/d';
+    $archive_week_end_date_format   = 'Y/m/d';
+
+    if (!$archive_date_format_over_ride) {
+        $archive_day_date_format = get_settings('date_format');
+        $archive_week_start_date_format = get_settings('date_format');
+        $archive_week_end_date_format = get_settings('date_format');
+    }
+
+    $add_hours = intval(get_settings('gmt_offset'));
+    $add_minutes = intval(60 * (get_settings('gmt_offset') - $add_hours));
+
+    $now = current_time('mysql');
+
+    if ('monthly' == $type) {
+        $arcresults = $wpdb-&gt;get_results(&quot;SELECT DISTINCT YEAR(post_date) AS `year`, MONTH(post_date) AS `month`, count(ID) as posts FROM $wpdb-&gt;posts WHERE post_date &lt; '$now' AND post_status = 'publish' GROUP BY YEAR(post_date), MONTH(post_date) ORDER BY post_date DESC&quot; . $limit);
+        if ($arcresults) {
+            $afterafter = $after;
+            foreach ($arcresults as $arcresult) {
+                $url  = get_month_link($arcresult-&gt;year,   $arcresult-&gt;month);
+                if ($show_post_count) {
+                    $text = sprintf('%s %d', $month[zeroise($arcresult-&gt;month,2)], $arcresult-&gt;year);
+                    $after = '&nbsp;('.$arcresult-&gt;posts.')' . $afterafter;
+                } else {
+                    $text = sprintf('%s %d', $month[zeroise($arcresult-&gt;month,2)], $arcresult-&gt;year);
+                }
+                echo get_archives_link($url, $text, $format, $before, $after);
+            }
+        }
+    } elseif ('daily' == $type) {
+        $arcresults = $wpdb-&gt;get_results(&quot;SELECT DISTINCT YEAR(post_date) AS `year`, MONTH(post_date) AS `month`, DAYOFMONTH(post_date) AS `dayofmonth` FROM $wpdb-&gt;posts WHERE post_date &lt; '$now' AND post_status = 'publish' ORDER BY post_date DESC&quot; . $limit);
+        if ($arcresults) {
+            foreach ($arcresults as $arcresult) {
+                $url  = get_day_link($arcresult-&gt;year, $arcresult-&gt;month, $arcresult-&gt;dayofmonth);
+                $date = sprintf(&quot;%d-%02d-%02d 00:00:00&quot;, $arcresult-&gt;year, $arcresult-&gt;month, $arcresult-&gt;dayofmonth);
+                $text = mysql2date($archive_day_date_format, $date);
+                echo get_archives_link($url, $text, $format, $before, $after);
+            }
+        }
+    } elseif ('weekly' == $type) {
+	$start_of_week = get_settings('start_of_week');
+        $arcresults = $wpdb-&gt;get_results(&quot;SELECT DISTINCT WEEK(post_date, $start_of_week) AS `week`, YEAR(post_date) AS yr, DATE_FORMAT(post_date, '%Y-%m-%d') AS yyyymmdd FROM $wpdb-&gt;posts WHERE post_date &lt; '$now' AND post_status = 'publish' ORDER BY post_date DESC&quot; . $limit);
+        $arc_w_last = '';
+        if ($arcresults) {
+            foreach ($arcresults as $arcresult) {
+                if ($arcresult-&gt;week != $arc_w_last) {
+                    $arc_year = $arcresult-&gt;yr;
+                    $arc_w_last = $arcresult-&gt;week;
+                    $arc_week = get_weekstartend($arcresult-&gt;yyyymmdd, get_settings('start_of_week'));
+                    $arc_week_start = date_i18n($archive_week_start_date_format, $arc_week['start']);
+                    $arc_week_end = date_i18n($archive_week_end_date_format, $arc_week['end']);
+                    $url  = sprintf('%s/%s%sm%s%s%sw%s%d', get_settings('home'), '', '?',
+                                    '=', $arc_year, '&amp;',
+                                    '=', $arcresult-&gt;week);
+                    $text = $arc_week_start . $archive_week_separator . $arc_week_end;
+                    echo get_archives_link($url, $text, $format, $before, $after);
+                }
+            }
+        }
+    } elseif ('postbypost' == $type) {
+        $arcresults = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;posts WHERE post_date &lt; '$now' AND post_status = 'publish' ORDER BY post_date DESC&quot; . $limit);
+        if ($arcresults) {
+            foreach ($arcresults as $arcresult) {
+                if ($arcresult-&gt;post_date != '0000-00-00 00:00:00') {
+                    $url  = get_permalink($arcresult);
+                    $arc_title = $arcresult-&gt;post_title;
+                    if ($arc_title) {
+                        $text = strip_tags($arc_title);
+                    } else {
+                        $text = $arcresult-&gt;ID;
+                    }
+                    echo get_archives_link($url, $text, $format, $before, $after);
+                }
+            }
+        }
+    }
+}
+
+// Used in get_calendar
+function calendar_week_mod($num) {
+	$base = 7;
+	return ($num - $base*floor($num/$base));
+}
+
+function get_calendar($daylength = 1) {
+    global $wpdb, $m, $monthnum, $year, $timedifference, $month, $month_abbrev, $weekday, $weekday_initial, $weekday_abbrev, $posts;
+
+    // Quick check. If we have no posts at all, abort!
+    if (!$posts) {
+        $gotsome = $wpdb-&gt;get_var(&quot;SELECT ID from $wpdb-&gt;posts WHERE post_status = 'publish' ORDER BY post_date DESC LIMIT 1&quot;);
+        if (!$gotsome)
+            return;
+    }
+
+    if (isset($_GET['w'])) {
+        $w = ''.intval($_GET['w']);
+    }
+
+    // week_begins = 0 stands for sunday
+    $week_begins = intval(get_settings('start_of_week'));
+    $add_hours = intval(get_settings('gmt_offset'));
+    $add_minutes = intval(60 * (get_settings('gmt_offset') - $add_hours));
+
+    // Let's figure out when we are
+    if (!empty($monthnum) &amp;&amp; !empty($year)) {
+        $thismonth = ''.zeroise(intval($monthnum), 2);
+        $thisyear = ''.intval($year);
+    } elseif (!empty($w)) {
+        // We need to get the month from MySQL
+        $thisyear = ''.intval(substr($m, 0, 4));
+        $d = (($w - 1) * 7) + 6; //it seems MySQL's weeks disagree with PHP's
+        $thismonth = $wpdb-&gt;get_var(&quot;SELECT DATE_FORMAT((DATE_ADD('${thisyear}0101', INTERVAL $d DAY) ), '%m')&quot;);
+    } elseif (!empty($m)) {
+        $calendar = substr($m, 0, 6);
+        $thisyear = ''.intval(substr($m, 0, 4));
+        if (strlen($m) &lt; 6) {
+            $thismonth = '01';
+        } else {
+            $thismonth = ''.zeroise(intval(substr($m, 4, 2)), 2);
+        }
+    } else {
+        $thisyear = gmdate('Y', current_time('timestamp') + get_settings('gmt_offset') * 3600);
+        $thismonth = gmdate('m', current_time('timestamp') + get_settings('gmt_offset') * 3600);
+    }
+
+    $unixmonth = mktime(0, 0 , 0, $thismonth, 1, $thisyear);
+
+    // Get the next and previous month and year with at least one post
+    $previous = $wpdb-&gt;get_row(&quot;SELECT DISTINCT MONTH(post_date) AS month, YEAR(post_date) AS year
+            FROM $wpdb-&gt;posts
+            WHERE post_date &lt; '$thisyear-$thismonth-01'
+            AND post_status = 'publish'
+                              ORDER BY post_date DESC
+                              LIMIT 1&quot;);
+    $next = $wpdb-&gt;get_row(&quot;SELECT  DISTINCT MONTH(post_date) AS month, YEAR(post_date) AS year
+            FROM $wpdb-&gt;posts
+            WHERE post_date &gt;  '$thisyear-$thismonth-01'
+            AND MONTH( post_date ) != MONTH( '$thisyear-$thismonth-01' )
+            AND post_status = 'publish'
+                              ORDER  BY post_date ASC
+                              LIMIT 1&quot;);
+
+    echo '&lt;table id=&quot;wp-calendar&quot;&gt;
+    &lt;caption&gt;' . $month[zeroise($thismonth, 2)] . ' ' . date('Y', $unixmonth) . '&lt;/caption&gt;
+    &lt;thead&gt;
+    &lt;tr&gt;';
+
+    $day_abbrev = $weekday_initial;
+    if ($daylength &gt; 1) {
+        $day_abbrev = $weekday_abbrev;
+    }
+
+    $myweek = array();
+	
+    for ($wdcount=0; $wdcount&lt;=6; $wdcount++) {
+        $myweek[]=$weekday[($wdcount+$week_begins)%7];
+    }
+	
+    foreach ($myweek as $wd) {
+        echo &quot;\n\t\t&lt;th abbr=\&quot;$wd\&quot; scope=\&quot;col\&quot; title=\&quot;$wd\&quot;&gt;&quot; . $day_abbrev[$wd] . '&lt;/th&gt;';
+    }
+
+    echo '
+    &lt;/tr&gt;
+    &lt;/thead&gt;
+
+    &lt;tfoot&gt;
+    &lt;tr&gt;';
+
+    if ($previous) {
+        echo &quot;\n\t\t&quot;.'&lt;td abbr=&quot;' . $month[zeroise($previous-&gt;month, 2)] . '&quot; colspan=&quot;3&quot; id=&quot;prev&quot;&gt;&lt;a href=&quot;' .
+            get_month_link($previous-&gt;year, $previous-&gt;month) . '&quot; title=&quot;' . sprintf(__('View posts for %1$s %2$s'), $month[zeroise($previous-&gt;month, 2)], date('Y', mktime(0, 0 , 0, $previous-&gt;month, 1, $previous-&gt;year))) . '&quot;&gt;&laquo; ' . $month_abbrev[$month[zeroise($previous-&gt;month, 2)]] . '&lt;/a&gt;&lt;/td&gt;';
+    } else {
+        echo &quot;\n\t\t&quot;.'&lt;td colspan=&quot;3&quot; id=&quot;prev&quot; class=&quot;pad&quot;&gt;&nbsp;&lt;/td&gt;';
+    }
+
+    echo &quot;\n\t\t&quot;.'&lt;td class=&quot;pad&quot;&gt;&nbsp;&lt;/td&gt;';
+
+    if ($next) {
+        echo &quot;\n\t\t&quot;.'&lt;td abbr=&quot;' . $month[zeroise($next-&gt;month, 2)] . '&quot; colspan=&quot;3&quot; id=&quot;next&quot;&gt;&lt;a href=&quot;' .
+                get_month_link($next-&gt;year, $next-&gt;month) . '&quot; title=&quot;View posts for ' . $month[zeroise($next-&gt;month, 2)] . ' ' .
+                date('Y', mktime(0, 0 , 0, $next-&gt;month, 1, $next-&gt;year)) . '&quot;&gt;' . $month_abbrev[$month[zeroise($next-&gt;month, 2)]] . ' &raquo;&lt;/a&gt;&lt;/td&gt;';
+    } else {
+        echo &quot;\n\t\t&quot;.'&lt;td colspan=&quot;3&quot; id=&quot;next&quot; class=&quot;pad&quot;&gt;&nbsp;&lt;/td&gt;';
+    }
+
+    echo '
+    &lt;/tr&gt;
+    &lt;/tfoot&gt;
+
+    &lt;tbody&gt;
+    &lt;tr&gt;';
+
+    // Get days with posts
+    $dayswithposts = $wpdb-&gt;get_results(&quot;SELECT DISTINCT DAYOFMONTH(post_date)
+            FROM $wpdb-&gt;posts WHERE MONTH(post_date) = $thismonth
+            AND YEAR(post_date) = $thisyear
+            AND post_status = 'publish'
+            AND post_date &lt; '&quot; . current_time('mysql') . '\'', ARRAY_N);
+    if ($dayswithposts) {
+        foreach ($dayswithposts as $daywith) {
+            $daywithpost[] = $daywith[0];
+        }
+    } else {
+        $daywithpost = array();
+    }
+
+
+
+    if (strstr($_SERVER['HTTP_USER_AGENT'], 'MSIE') ||
+          strstr(strtolower($_SERVER['HTTP_USER_AGENT']), 'camino') ||
+          strstr(strtolower($_SERVER['HTTP_USER_AGENT']), 'safari')) {
+        $ak_title_separator = &quot;\n&quot;;
+    } else {
+        $ak_title_separator = ', ';
+    }
+
+    $ak_titles_for_day = array();
+    $ak_post_titles = $wpdb-&gt;get_results(&quot;SELECT post_title, DAYOFMONTH(post_date) as dom &quot;
+                                         .&quot;FROM $wpdb-&gt;posts &quot;
+                                         .&quot;WHERE YEAR(post_date) = '$thisyear' &quot;
+                                         .&quot;AND MONTH(post_date) = '$thismonth' &quot;
+                                         .&quot;AND post_date &lt; '&quot;.current_time('mysql').&quot;' &quot;
+                                         .&quot;AND post_status = 'publish'&quot;
+                                        );
+    if ($ak_post_titles) {
+        foreach ($ak_post_titles as $ak_post_title) {
+            if (empty($ak_titles_for_day['day_'.$ak_post_title-&gt;dom])) {
+                $ak_titles_for_day['day_'.$ak_post_title-&gt;dom] = '';
+            }
+            if (empty($ak_titles_for_day[&quot;$ak_post_title-&gt;dom&quot;])) { // first one
+                $ak_titles_for_day[&quot;$ak_post_title-&gt;dom&quot;] = str_replace('&quot;', '&quot;', wptexturize($ak_post_title-&gt;post_title));
+            } else {
+                $ak_titles_for_day[&quot;$ak_post_title-&gt;dom&quot;] .= $ak_title_separator . str_replace('&quot;', '&quot;', wptexturize($ak_post_title-&gt;post_title));
+            }
+        }
+    }
+
+
+    // See how much we should pad in the beginning
+    $pad = calendar_week_mod(date('w', $unixmonth)-$week_begins);
+    if (0 != $pad) echo &quot;\n\t\t&quot;.'&lt;td colspan=&quot;'.$pad.'&quot; class=&quot;pad&quot;&gt;&nbsp;&lt;/td&gt;';
+
+    $daysinmonth = intval(date('t', $unixmonth));
+    for ($day = 1; $day &lt;= $daysinmonth; ++$day) {
+        if (isset($newrow) &amp;&amp; $newrow)
+            echo &quot;\n\t&lt;/tr&gt;\n\t&lt;tr&gt;\n\t\t&quot;;
+        $newrow = false;
+
+        if ($day == gmdate('j', (time() + (get_settings('gmt_offset') * 3600))) &amp;&amp; $thismonth == gmdate('m', time()+(get_settings('gmt_offset') * 3600)) &amp;&amp; $thisyear == gmdate('Y', time()+(get_settings('gmt_offset') * 3600)))
+            echo '&lt;td id=&quot;today&quot;&gt;';
+        else
+            echo '&lt;td&gt;';
+
+        if (in_array($day, $daywithpost)) { // any posts today?
+            echo '&lt;a href=&quot;' . get_day_link($thisyear, $thismonth, $day) . &quot;\&quot; title=\&quot;$ak_titles_for_day[$day]\&quot;&gt;$day&lt;/a&gt;&quot;;
+        } else {
+            echo $day;
+        }
+        echo '&lt;/td&gt;';
+
+	if (6 == calendar_week_mod(date('w', mktime(0, 0 , 0, $thismonth, $day, $thisyear))-$week_begins))
+            $newrow = true;
+    }
+
+    $pad = 7 - calendar_week_mod(date('w', mktime(0, 0 , 0, $thismonth, $day, $thisyear))-$week_begins);
+    if ($pad != 0 &amp;&amp; $pad != 7)
+        echo &quot;\n\t\t&quot;.'&lt;td class=&quot;pad&quot; colspan=&quot;'.$pad.'&quot;&gt;&nbsp;&lt;/td&gt;';
+
+    echo &quot;\n\t&lt;/tr&gt;\n\t&lt;/tbody&gt;\n\t&lt;/table&gt;&quot;;
+}
+
+function allowed_tags() {
+    global $allowedtags;
+	$allowed = '';
+    foreach($allowedtags as $tag =&gt; $attributes) {
+        $allowed .= '&lt;'.$tag;
+        if (0 &lt; count($attributes)) {
+            foreach ($attributes as $attribute =&gt; $limits) {
+                $allowed .= ' '.$attribute.'=&quot;&quot;';
+            }
+        }
+        $allowed .= '&gt; ';
+    }
+    return htmlentities($allowed);
+}
+
+/***** Date/Time tags *****/
+
+function the_date_xml() {
+    global $post;
+    echo mysql2date('Y-m-d', $post-&gt;post_date);
+    //echo &quot;&quot;+$post-&gt;post_date;
+}
+
+function the_date($d='', $before='', $after='', $echo = true) {
+    global $id, $post, $day, $previousday, $newday;
+    $the_date = '';
+    if ($day != $previousday) {
+        $the_date .= $before;
+        if ($d=='') {
+	    $the_date .= mysql2date(get_settings('date_format'), $post-&gt;post_date);
+        } else {
+	    $the_date .= mysql2date($d, $post-&gt;post_date);
+        }
+        $the_date .= $after;
+        $previousday = $day;
+    }
+    $the_date = apply_filters('the_date', $the_date, $d, $before, $after);
+    if ($echo) {
+        echo $the_date;
+    } else {
+        return $the_date;
+    }
+}
+
+function the_time( $d = '' ) {
+	echo apply_filters('the_time', get_the_time( $d ), $d);
+}
+
+function get_the_time( $d = '' ) {
+	if ( '' == $d )
+		$the_time = get_post_time(get_settings('time_format'));
+	else
+		$the_time = get_post_time($d);
+	return apply_filters('get_the_time', $the_time, $d);
+}
+
+function get_post_time( $d = 'U', $gmt = false ) { // returns timestamp
+	global $post;
+	if ( $gmt )
+		$time = $post-&gt;post_date_gmt;
+	else
+		$time = $post-&gt;post_date;
+
+	$time = mysql2date($d, $time);
+	return apply_filters('get_the_time', $time, $d, $gmt);
+}
+
+function the_weekday() {
+    global $weekday, $id, $post;
+    $the_weekday = $weekday[mysql2date('w', $post-&gt;post_date)];
+    $the_weekday = apply_filters('the_weekday', $the_weekday);
+    echo $the_weekday;
+}
+
+function the_weekday_date($before='',$after='') {
+    global $weekday, $id, $post, $day, $previousweekday;
+    $the_weekday_date = '';
+    if ($day != $previousweekday) {
+        $the_weekday_date .= $before;
+        $the_weekday_date .= $weekday[mysql2date('w', $post-&gt;post_date)];
+        $the_weekday_date .= $after;
+        $previousweekday = $day;
+    }
+    $the_weekday_date = apply_filters('the_weekday_date', $the_weekday_date, $before, $after);
+    echo $the_weekday_date;
+}
+
+?&gt;

Added: trunk/wp-includes/template-functions-links.php
===================================================================
--- trunk/wp-includes/template-functions-links.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/template-functions-links.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,492 @@
+&lt;?php
+
+function the_permalink() {
+	echo apply_filters('the_permalink', get_permalink());
+}
+
+function permalink_link() { // For backwards compatibility
+	echo apply_filters('the_permalink', get_permalink());
+}
+
+function permalink_anchor($mode = 'id') {
+    global $id, $post;
+    switch(strtolower($mode)) {
+        case 'title':
+            $title = sanitize_title($post-&gt;post_title) . '-' . $id;
+            echo '&lt;a id=&quot;'.$title.'&quot;&gt;&lt;/a&gt;';
+            break;
+        case 'id':
+        default:
+            echo '&lt;a id=&quot;post-'.$id.'&quot;&gt;&lt;/a&gt;';
+            break;
+    }
+}
+
+function get_permalink($id = 0) {
+	$rewritecode = array(
+		'%year%',
+		'%monthnum%',
+		'%day%',
+		'%hour%',
+		'%minute%',
+		'%second%',
+		'%postname%',
+		'%post_id%',
+		'%category%',
+		'%author%',
+		'%pagename%'
+	);
+
+	$post = &amp; get_post($id);
+	if ($post-&gt;post_status == 'static') {
+		return get_page_link($post-&gt;ID);
+	}
+
+	$permalink = get_settings('permalink_structure');
+
+	if ('' != $permalink &amp;&amp; 'draft' != $post-&gt;post_status) {
+		$unixtime = strtotime($post-&gt;post_date);
+
+		$category = '';
+		if (strstr($permalink, '%category%')) {
+			$cats = get_the_category($post-&gt;ID);
+			$category = $cats[0]-&gt;category_nicename;
+			if ($parent=$cats[0]-&gt;category_parent) $category = get_category_parents($parent, FALSE, '/', TRUE) . $category;
+		}
+
+		$authordata = get_userdata($post-&gt;post_author);
+		$author = $authordata-&gt;user_nicename;
+		$rewritereplace = 
+		array(
+			date('Y', $unixtime),
+			date('m', $unixtime),
+			date('d', $unixtime),
+			date('H', $unixtime),
+			date('i', $unixtime),
+			date('s', $unixtime),
+			$post-&gt;post_name,
+			$post-&gt;ID,
+			$category,
+			$author,
+			$post-&gt;post_name,
+		);
+		return apply_filters('post_link', get_settings('home') . str_replace($rewritecode, $rewritereplace, $permalink), $post);
+	} else { // if they're not using the fancy permalink option
+		$permalink = get_settings('home') . '/?p=' . $post-&gt;ID;
+		return apply_filters('post_link', $permalink, $post);
+	}
+}
+
+function get_page_link($id = false) {
+	global $post, $wp_rewrite;
+
+	if (! $id) {
+		$id = $post-&gt;ID;
+	}
+
+	$pagestruct = $wp_rewrite-&gt;get_page_permastruct();
+
+	if ('' != $pagestruct) {
+		$link = get_page_uri($id);
+		$link = str_replace('%pagename%', $link, $pagestruct);
+		$link = get_settings('home') . &quot;/$link/&quot;;
+	} else {
+		$link = get_settings('home') . &quot;/?page_id=$id&quot;;
+	}
+
+	return apply_filters('page_link', $link, $id);
+}
+
+function get_year_link($year) {
+	global $wp_rewrite;
+    if (!$year) $year = gmdate('Y', time()+(get_settings('gmt_offset') * 3600));
+		$yearlink = $wp_rewrite-&gt;get_year_permastruct();
+    if (!empty($yearlink)) {
+        $yearlink = str_replace('%year%', $year, $yearlink);
+        return apply_filters('year_link', get_settings('home') . trailingslashit($yearlink), $year);
+    } else {
+        return apply_filters('year_link', get_settings('home') . '/?m=' . $year, $year);
+    }
+}
+
+function get_month_link($year, $month) {
+    global $wp_rewrite;
+    if (!$year) $year = gmdate('Y', time()+(get_settings('gmt_offset') * 3600));
+    if (!$month) $month = gmdate('m', time()+(get_settings('gmt_offset') * 3600));
+		$monthlink = $wp_rewrite-&gt;get_month_permastruct();
+    if (!empty($monthlink)) {
+        $monthlink = str_replace('%year%', $year, $monthlink);
+        $monthlink = str_replace('%monthnum%', zeroise(intval($month), 2), $monthlink);
+        return apply_filters('month_link', get_settings('home') . trailingslashit($monthlink), $year, $month);
+    } else {
+        return apply_filters('month_link', get_settings('home') . '/?m=' . $year . zeroise($month, 2), $year, $month);
+    }
+}
+
+function get_day_link($year, $month, $day) {
+    global $wp_rewrite;
+    if (!$year) $year = gmdate('Y', time()+(get_settings('gmt_offset') * 3600));
+    if (!$month) $month = gmdate('m', time()+(get_settings('gmt_offset') * 3600));
+    if (!$day) $day = gmdate('j', time()+(get_settings('gmt_offset') * 3600));
+
+		$daylink = $wp_rewrite-&gt;get_day_permastruct();
+    if (!empty($daylink)) {
+        $daylink = str_replace('%year%', $year, $daylink);
+        $daylink = str_replace('%monthnum%', zeroise(intval($month), 2), $daylink);
+        $daylink = str_replace('%day%', zeroise(intval($day), 2), $daylink);
+        return apply_filters('day_link', get_settings('home') . trailingslashit($daylink), $year, $month, $day);
+    } else {
+        return apply_filters('day_link', get_settings('home') . '/?m=' . $year . zeroise($month, 2) . zeroise($day, 2), $year, $month, $day);
+    }
+}
+
+function get_feed_link($feed='rss2') {
+	global $wp_rewrite;
+	$do_perma = 0;
+	$feed_url = get_settings('siteurl');
+	$comment_feed_url = $feed_url;
+
+	$permalink = $wp_rewrite-&gt;get_feed_permastruct();
+	if ('' != $permalink) {
+		if ( false !== strpos($feed, 'comments_') ) {
+			$feed = str_replace('comments_', '', $feed);
+			$permalink = $wp_rewrite-&gt;get_comment_feed_permastruct();
+		}
+
+		if ( 'rss2' == $feed )
+			$feed = '';
+
+		$permalink = str_replace('%feed%', $feed, $permalink);
+		$permalink = preg_replace('#/+#', '/', &quot;/$permalink/&quot;);
+		$output =  get_settings('home') . $permalink;
+	} else {
+		if ( false !== strpos($feed, 'comments_') )
+			$feed = str_replace('comments_', 'comments-', $feed);
+
+		$output = get_settings('home') . &quot;/?feed={$feed}&quot;;
+	}
+
+	return apply_filters('feed_link', $output, $feed);
+}
+
+function edit_post_link($link = 'Edit This', $before = '', $after = '') {
+    global $user_ID, $post;
+
+    get_currentuserinfo();
+
+	if (!user_can_edit_post($user_ID, $post-&gt;ID)) {
+        return;
+    }
+
+    $location = get_settings('siteurl') . &quot;/wp-admin/post.php?action=edit&amp;post=$post-&gt;ID&quot;;
+    echo &quot;$before &lt;a href=\&quot;$location\&quot;&gt;$link&lt;/a&gt; $after&quot;;
+}
+
+function edit_comment_link($link = 'Edit This', $before = '', $after = '') {
+    global $user_ID, $post, $comment;
+
+    get_currentuserinfo();
+
+	if (!user_can_edit_post_comments($user_ID, $post-&gt;ID)) {
+        return;
+    }
+
+    $location = get_settings('siteurl') . &quot;/wp-admin/post.php?action=editcomment&amp;comment=$comment-&gt;comment_ID&quot;;
+    echo &quot;$before &lt;a href='$location'&gt;$link&lt;/a&gt; $after&quot;;
+}
+
+// Navigation links
+
+function get_previous_post($in_same_cat = false, $excluded_categories = '') {
+	global $post, $wpdb;
+
+	if(! is_single()) {
+		return null;
+	}
+    
+	$current_post_date = $post-&gt;post_date;
+    
+	$join = '';
+	if ($in_same_cat) {
+		$join = &quot; INNER JOIN $wpdb-&gt;post2cat ON $wpdb-&gt;posts.ID= $wpdb-&gt;post2cat.post_id &quot;;
+		$cat_array = get_the_category($post-&gt;ID);
+	 	$join .= ' AND (category_id = ' . intval($cat_array[0]-&gt;cat_ID);
+		for ($i = 1; $i &lt; (count($cat_array)); $i++) {
+			$join .= ' OR category_id = ' . intval($cat_array[$i]-&gt;cat_ID);
+		}
+		$join .= ')'; 
+	}
+
+	$sql_exclude_cats = '';
+	if (!empty($excluded_categories)) {
+		$blah = explode('and', $excluded_categories);
+		foreach($blah as $category) {
+			$category = intval($category);
+			$sql_exclude_cats .= &quot; AND post_category != $category&quot;;
+		}
+	}
+
+	return @$wpdb-&gt;get_row(&quot;SELECT ID, post_title FROM $wpdb-&gt;posts $join WHERE post_date &lt; '$current_post_date' AND post_status = 'publish' $sqlcat $sql_exclude_cats ORDER BY post_date DESC LIMIT 1&quot;);
+}
+
+function get_next_post($in_same_cat = false, $excluded_categories = '') {
+	global $post, $wpdb;
+
+	if(! is_single()) {
+		return null;
+	}
+
+	$current_post_date = $post-&gt;post_date;
+    
+	$join = '';
+	if ($in_same_cat) {
+		$join = &quot; INNER JOIN $wpdb-&gt;post2cat ON $wpdb-&gt;posts.ID= $wpdb-&gt;post2cat.post_id &quot;;
+		$cat_array = get_the_category($post-&gt;ID);
+	 	$join .= ' AND (category_id = ' . intval($cat_array[0]-&gt;cat_ID);
+		for ($i = 1; $i &lt; (count($cat_array)); $i++) {
+			$join .= ' OR category_id = ' . intval($cat_array[$i]-&gt;cat_ID);
+		}
+		$join .= ')'; 
+	}
+
+	$sql_exclude_cats = '';
+	if (!empty($excluded_categories)) {
+		$blah = explode('and', $excluded_categories);
+		foreach($blah as $category) {
+			$category = intval($category);
+			$sql_exclude_cats .= &quot; AND post_category != $category&quot;;
+		}
+	}
+
+	$now = current_time('mysql');
+    
+	return @$wpdb-&gt;get_row(&quot;SELECT ID,post_title FROM $wpdb-&gt;posts $join WHERE post_date &gt; '$current_post_date' AND post_date &lt; '$now' AND post_status = 'publish' $sqlcat $sql_exclude_cats AND ID != $post-&gt;ID ORDER BY post_date ASC LIMIT 1&quot;);
+}
+
+function previous_post_link($format='&laquo; %link', $link='%title', $in_same_cat = false, $excluded_categories = '') {
+  $post = get_previous_post($in_same_cat, $excluded_categories);
+
+  if(! $post) {
+    return;
+  }
+
+  $title = apply_filters('the_title', $post-&gt;post_title, $post);
+
+  $string = '&lt;a href=&quot;'.get_permalink($post-&gt;ID).'&quot;&gt;';
+
+  $link = str_replace('%title', $title, $link);
+
+  $link = $string . $link . '&lt;/a&gt;';
+
+  $format = str_replace('%link', $link, $format);
+
+  echo $format;	    
+}
+
+function next_post_link($format='%link &raquo;', $link='%title', $in_same_cat = false, $excluded_categories = '') {
+  $post = get_next_post($in_same_cat, $excluded_categories);
+
+  if(! $post) {
+    return;
+  }
+
+  $title = apply_filters('the_title', $post-&gt;post_title, $post);
+
+  $string = '&lt;a href=&quot;'.get_permalink($post-&gt;ID).'&quot;&gt;';
+
+  $link = str_replace('%title', $title, $link);
+
+  $link = $string . $link . '&lt;/a&gt;';
+
+  $format = str_replace('%link', $link, $format);
+
+  echo $format;	    
+}
+
+// Deprecated.  Use previous_post_link().
+function previous_post($format='%', $previous='previous post: ', $title='yes', $in_same_cat='no', $limitprev=1, $excluded_categories='') {
+
+	if ( empty($in_same_cat) || 'no' == $in_same_cat )
+		$in_same_cat = false;
+	else
+		$in_same_cat = true;
+
+  $post = get_previous_post($in_same_cat, $excluded_categories);
+
+  if(! $post) {
+    return;
+  }
+
+	$string = '&lt;a href=&quot;'.get_permalink($post-&gt;ID).'&quot;&gt;'.$previous;
+	if ($title == 'yes') {
+		$string .= apply_filters('the_title', $post-&gt;post_title, $post);
+	}
+	$string .= '&lt;/a&gt;';
+	$format = str_replace('%', $string, $format);
+	echo $format;
+}
+
+// Deprecated.  Use next_post_link().
+function next_post($format='%', $next='next post: ', $title='yes', $in_same_cat='no', $limitnext=1, $excluded_categories='') {
+	
+	if ( empty($in_same_cat) || 'no' == $in_same_cat )
+		$in_same_cat = false;
+	else
+		$in_same_cat = true;
+
+  $post = get_next_post($in_same_cat, $excluded_categories);
+
+  if(! $post) {
+    return;
+  }
+
+	$string = '&lt;a href=&quot;'.get_permalink($post-&gt;ID).'&quot;&gt;'.$next;
+	if ($title=='yes') {
+		$string .= apply_filters('the_title', $post-&gt;post_title, $nextpost);
+	}
+	$string .= '&lt;/a&gt;';
+	$format = str_replace('%', $string, $format);
+	echo $format;
+}
+
+function get_pagenum_link($pagenum = 1) {
+	global $wp_rewrite;
+
+	$qstr = $_SERVER['REQUEST_URI'];
+
+	$page_querystring = &quot;paged&quot;; 
+	$page_modstring = &quot;page/&quot;;
+	$page_modregex = &quot;page/?&quot;;
+	$permalink = 0;
+
+	$home_root = parse_url(get_settings('home'));
+	$home_root = $home_root['path'];
+	$home_root = trailingslashit($home_root);
+	$qstr = preg_replace('|^'. $home_root . '|', '', $qstr);
+	$qstr = preg_replace('|^/+|', '', $qstr);
+
+	$index = $_SERVER['PHP_SELF'];
+	$index = preg_replace('|^'. $home_root . '|', '', $index);
+	$index = preg_replace('|^/+|', '', $index);
+
+	// if we already have a QUERY style page string
+	if( stristr( $qstr, $page_querystring ) ) {
+		$replacement = &quot;$page_querystring=$pagenum&quot;;
+		$qstr = preg_replace(&quot;/&quot;.$page_querystring.&quot;[^\d]+\d+/&quot;, $replacement, $qstr);
+		// if we already have a mod_rewrite style page string
+	} elseif ( preg_match( '|'.$page_modregex.'\d+|', $qstr ) ){
+		$permalink = 1;
+		$qstr = preg_replace('|'.$page_modregex.'\d+|',&quot;$page_modstring$pagenum&quot;,$qstr);
+
+		// if we don't have a page string at all ...
+		// lets see what sort of URL we have...
+	} else {
+		// we need to know the way queries are being written
+		// if there's a querystring_start (a &quot;?&quot; usually), it's definitely not mod_rewritten
+		if ( stristr( $qstr, '?' ) ){
+			// so append the query string (using &amp;, since we already have ?)
+			$qstr .=  '&amp;' . $page_querystring . '=' . $pagenum;
+			// otherwise, it could be rewritten, OR just the default index ...
+		} elseif( '' != get_settings('permalink_structure') &amp;&amp; ! is_admin()) {
+			$permalink = 1;
+			$index = $wp_rewrite-&gt;index;
+			// If it's not a path info permalink structure, trim the index.
+			if (! $wp_rewrite-&gt;using_index_permalinks()) {
+				$qstr = preg_replace(&quot;#/*&quot; . $index . &quot;/*#&quot;, '/', $qstr);
+			} else {
+				// If using path info style permalinks, make sure the index is in
+				// the URI.
+				if (strpos($qstr, $index) === false) {
+					$qstr = '/' . $index . $qstr;
+				}
+			}
+
+			$qstr =  trailingslashit($qstr) . $page_modstring . $pagenum;
+		} else {
+			$qstr = $index . '?' . $page_querystring . '=' . $pagenum;
+		}
+	}
+
+	$qstr = preg_replace('|^/+|', '', $qstr);
+	if ($permalink) $qstr = trailingslashit($qstr);
+	return preg_replace('/&amp;([^#])(?![a-z]{1,8};)/', '&#038;$1', trailingslashit( get_settings('home') ) . $qstr );
+}
+
+function next_posts($max_page = 0) { // original by cfactor at cooltux.org
+    global $paged, $pagenow;
+
+     if (! is_single()) {
+         if (!$paged) $paged = 1;
+         $nextpage = intval($paged) + 1;
+         if (!$max_page || $max_page &gt;= $nextpage) {
+             echo get_pagenum_link($nextpage);
+         }         
+     }
+}
+
+function next_posts_link($label='Next Page &raquo;', $max_page=0) {
+	global $paged, $result, $request, $posts_per_page, $wpdb, $max_num_pages;
+    if (!$max_page) {
+			if ( isset($max_num_pages) ) {
+				$max_page = $max_num_pages;
+			} else {
+        preg_match('#FROM (.*) GROUP BY#', $request, $matches);
+        $fromwhere = $matches[1];
+        $numposts = $wpdb-&gt;get_var(&quot;SELECT COUNT(ID) FROM $fromwhere&quot;);
+        $max_page = $max_num_pages = ceil($numposts / $posts_per_page);
+			}
+    }
+    if (!$paged)
+        $paged = 1;
+    $nextpage = intval($paged) + 1;
+    if ((! is_single()) &amp;&amp; (empty($paged) || $nextpage &lt;= $max_page)) {
+        echo '&lt;a href=&quot;';
+        next_posts($max_page);
+        echo '&quot;&gt;'. preg_replace('/&amp;([^#])(?![a-z]{1,8};)/', '&#038;$1', $label) .'&lt;/a&gt;';
+    }
+}
+
+
+function previous_posts() { // original by cfactor at cooltux.org
+    global $_SERVER, $paged, $pagenow;
+
+     if (! is_single()) {
+         $nextpage = intval($paged) - 1;
+         if ($nextpage &lt; 1) $nextpage = 1;
+         echo get_pagenum_link($nextpage);
+     }
+}
+
+function previous_posts_link($label='&laquo; Previous Page') {
+    global $paged;
+    if ((! is_single())  &amp;&amp; ($paged &gt; 1) ) {
+        echo '&lt;a href=&quot;';
+        previous_posts();
+        echo '&quot;&gt;'. preg_replace('/&amp;([^#])(?![a-z]{1,8};)/', '&#038;$1', $label) .'&lt;/a&gt;';
+    }
+}
+
+function posts_nav_link($sep=' &#8212; ', $prelabel='&laquo; Previous Page', $nxtlabel='Next Page &raquo;') {
+	global $request, $posts_per_page, $wpdb, $max_num_pages;
+	if (! is_single()) {
+
+		if (get_query_var('what_to_show') == 'posts') {
+			if ( ! isset($max_num_pages) ) {
+				preg_match('#FROM (.*) GROUP BY#', $request, $matches);
+				$fromwhere = $matches[1];
+				$numposts = $wpdb-&gt;get_var(&quot;SELECT COUNT(ID) FROM $fromwhere&quot;);
+				$max_num_pages = ceil($numposts / $posts_per_page);
+			}
+		} else {
+			$max_num_pages = 999999;
+		}
+
+        if ($max_num_pages &gt; 1) {
+            previous_posts_link($prelabel);
+            echo preg_replace('/&amp;([^#])(?![a-z]{1,8};)/', '&#038;$1', $sep);
+            next_posts_link($nxtlabel, $max_page);
+        }
+    }
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/template-functions-post.php
===================================================================
--- trunk/wp-includes/template-functions-post.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/template-functions-post.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,414 @@
+&lt;?php
+
+function get_the_password_form() {
+    $output = '&lt;form action=&quot;' . get_settings('siteurl') . '/wp-pass.php&quot; method=&quot;post&quot;&gt;
+    &lt;p&gt;' . __(&quot;This post is password protected. To view it please enter your password below:&quot;) . '&lt;/p&gt;
+    &lt;p&gt;&lt;label&gt;' . __(&quot;Password:&quot;) . ' &lt;input name=&quot;post_password&quot; type=&quot;password&quot; size=&quot;20&quot; /&gt;&lt;/label&gt; &lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;Submit&quot; /&gt;&lt;/p&gt;
+    &lt;/form&gt;
+    ';
+	return $output;
+}
+
+function the_ID() {
+	global $id;
+	echo $id;
+}
+
+function the_title($before = '', $after = '', $echo = true) {
+	$title = get_the_title();
+	if ( strlen($title) &gt; 0 ) {
+		$title = apply_filters('the_title', $before . $title . $after, $before, $after);
+		if ($echo)
+			echo $title;
+		else
+			return $title;
+	}
+}
+
+function get_the_title($id = 0) {
+	$post = &amp;get_post($id);
+
+	$title = $post-&gt;post_title;
+	if (!empty($post-&gt;post_password))
+		$title = sprintf(__('Protected: %s'), $title);
+
+	return $title;
+}
+
+function get_the_guid( $id = 0 ) {
+	$post = &amp;get_post($id);
+	
+	return apply_filters('get_the_guid', $post-&gt;guid);
+}
+
+function the_guid( $id = 0 ) {
+	echo get_the_guid($id);
+}
+
+
+function the_content($more_link_text = '(more...)', $stripteaser = 0, $more_file = '') {
+    $content = get_the_content($more_link_text, $stripteaser, $more_file);
+    $content = apply_filters('the_content', $content);
+    $content = str_replace(']]&gt;', ']]&gt;', $content);
+    echo $content;
+}
+
+function get_the_content($more_link_text = '(more...)', $stripteaser = 0, $more_file = '') {
+    global $id, $post, $more, $single, $withcomments, $page, $pages, $multipage, $numpages;
+    global $preview;
+    global $pagenow;
+    $output = '';
+
+    if (!empty($post-&gt;post_password)) { // if there's a password
+        if (stripslashes($_COOKIE['wp-postpass_'.COOKIEHASH]) != $post-&gt;post_password) {  // and it doesn't match the cookie
+            $output = get_the_password_form();
+            return $output;
+        }
+    }
+
+    if ($more_file != '') {
+        $file = $more_file;
+    } else {
+        $file = $pagenow; //$_SERVER['PHP_SELF'];
+    }
+    $content = $pages[$page-1];
+    $content = explode('&lt;!--more--&gt;', $content, 2);
+    if ((preg_match('/&lt;!--noteaser--&gt;/', $post-&gt;post_content) &amp;&amp; ((!$multipage) || ($page==1))))
+        $stripteaser = 1;
+    $teaser = $content[0];
+    if (($more) &amp;&amp; ($stripteaser))
+        $teaser = '';
+    $output .= $teaser;
+    if (count($content)&gt;1) {
+        if ($more) {
+            $output .= '&lt;a id=&quot;more-'.$id.'&quot;&gt;&lt;/a&gt;'.$content[1];
+        } else {
+            $output .= ' &lt;a href=&quot;'. get_permalink() . &quot;#more-$id\&quot;&gt;$more_link_text&lt;/a&gt;&quot;;
+        }
+    }
+    if ($preview) { // preview fix for javascript bug with foreign languages
+        $output =  preg_replace('/\%u([0-9A-F]{4,4})/e',  &quot;'&amp;#'.base_convert('\\1',16,10).';'&quot;, $output);
+    }
+    return $output;
+}
+
+function the_excerpt() {
+	echo apply_filters('the_excerpt', get_the_excerpt());
+}
+
+function get_the_excerpt($fakeit = true) {
+	global $id, $post;
+	$output = '';
+	$output = $post-&gt;post_excerpt;
+	if (!empty($post-&gt;post_password)) { // if there's a password
+		if ($_COOKIE['wp-postpass_'.COOKIEHASH] != $post-&gt;post_password) {  // and it doesn't match the cookie
+			$output = __('There is no excerpt because this is a protected post.');
+			return $output;
+		}
+	}
+
+	return apply_filters('get_the_excerpt', $output);
+}
+
+function wp_link_pages($args = '') {
+	parse_str($args, $r);
+	if (!isset($r['before'])) $r['before'] = '&lt;p&gt;' . __('Pages:');
+	if (!isset($r['after'])) $r['after'] = '&lt;/p&gt;';
+	if (!isset($r['next_or_number'])) $r['next_or_number'] = 'number';
+	if (!isset($r['nextpagelink'])) $r['nextpagelink'] = 'Next page';
+	if (!isset($r['previouspagelink'])) $r['previouspagelink'] = 'Previous page';
+	if (!isset($r['pagelink'])) $r['pagelink'] = '%';
+	if (!isset($r['more_file'])) $r['more_file'] = '';
+	link_pages($r['before'], $r['after'], $r['next_or_number'], $r['nextpagelink'], $r['previouspagelink'], $r['pagelink'], $r['more_file']);
+}
+
+function link_pages($before='&lt;br /&gt;', $after='&lt;br /&gt;', $next_or_number='number', $nextpagelink='next page', $previouspagelink='previous page', $pagelink='%', $more_file='') {
+    global $id, $page, $numpages, $multipage, $more;
+    global $pagenow;
+    if ($more_file != '') {
+        $file = $more_file;
+    } else {
+        $file = $pagenow;
+    }
+    if (($multipage)) {
+        if ($next_or_number=='number') {
+            echo $before;
+            for ($i = 1; $i &lt; ($numpages+1); $i = $i + 1) {
+                $j=str_replace('%',&quot;$i&quot;,$pagelink);
+                echo ' ';
+                if (($i != $page) || ((!$more) &amp;&amp; ($page==1))) {
+                    if ('' == get_settings('permalink_structure')) {
+                        echo '&lt;a href=&quot;' . get_permalink() . '&amp;page=' . $i . '&quot;&gt;';
+                    } else {
+                        echo '&lt;a href=&quot;' . trailingslashit( get_permalink() ) . $i . '/&quot;&gt;';
+                    }
+                }
+                echo $j;
+                if (($i != $page) || ((!$more) &amp;&amp; ($page==1)))
+                    echo '&lt;/a&gt;';
+            }
+            echo $after;
+        } else {
+            if ($more) {
+                echo $before;
+                $i=$page-1;
+                if ($i &amp;&amp; $more) {
+                    if ('' == get_settings('permalink_structure')) {
+                        echo '&lt;a href=&quot;' . get_permalink() . '&amp;page=' . $i . '&quot;&gt;'.$previouspagelink.'&lt;/a&gt;';
+                    } else {
+                        echo '&lt;a href=&quot;' . get_permalink() . $i . '/&quot;&gt;'.$previouspagelink.'&lt;/a&gt;';
+                    }
+                }
+                $i=$page+1;
+                if ($i&lt;=$numpages &amp;&amp; $more) {
+                    if ('' == get_settings('permalink_structure')) {
+                        echo '&lt;a href=&quot;'.get_permalink() . '&amp;page=' . $i . '&quot;&gt;'.$nextpagelink.'&lt;/a&gt;';
+                    } else {
+                        echo '&lt;a href=&quot;'.get_permalink().$i.'/&quot;&gt;'.$nextpagelink.'&lt;/a&gt;';
+                    }
+                }
+                echo $after;
+            }
+        }
+    }
+}
+
+/*
+ * Post-meta: Custom per-post fields.
+ */
+ 
+function get_post_custom( $post_id = 0 ) {
+	global $id, $post_meta_cache, $wpdb;
+	if ( $post_id )
+		$id = $post_id;
+	if ( isset($post_meta_cache[$id]) ) {
+		return $post_meta_cache[$id];
+	} else {
+	if ( $meta_list = $wpdb-&gt;get_results(&quot;SELECT post_id, meta_key, meta_value FROM $wpdb-&gt;postmeta  WHERE post_id = '$id' ORDER BY post_id, meta_key&quot;, ARRAY_A) ) {
+		
+	// Change from flat structure to hierarchical:
+	$post_meta_cache = array();
+		foreach ($meta_list as $metarow) {
+			$mpid = $metarow['post_id'];
+			$mkey = $metarow['meta_key'];
+			$mval = $metarow['meta_value'];
+			
+			// Force subkeys to be array type:
+			if (!isset($post_meta_cache[$mpid]) || !is_array($post_meta_cache[$mpid]))
+			$post_meta_cache[$mpid] = array();
+			if (!isset($post_meta_cache[$mpid][&quot;$mkey&quot;]) || !is_array($post_meta_cache[$mpid][&quot;$mkey&quot;]))
+			$post_meta_cache[$mpid][&quot;$mkey&quot;] = array();
+			
+			// Add a value to the current pid/key:
+			$post_meta_cache[$mpid][$mkey][] = $mval;
+		}
+	return $post_meta_cache[$mpid];
+    }
+	}
+}
+
+function get_post_custom_keys() {
+	global $id, $post_meta_cache;
+	
+	if (!is_array($post_meta_cache[$id]))
+		return;
+	if ($keys = array_keys($post_meta_cache[$id]))
+		return $keys;
+}
+
+function get_post_custom_values($key='') {
+	global $id, $post_meta_cache;
+
+	return $post_meta_cache[$id][$key];
+}
+
+function post_custom( $key = '' ) {
+	global $id, $post_meta_cache;
+	
+	if ( 1 == count($post_meta_cache[$id][$key]) ) return $post_meta_cache[$id][$key][0];
+	else return $post_meta_cache[$id][$key];
+}
+
+// this will probably change at some point...
+function the_meta() {
+	global $id, $post_meta_cache;
+	
+	if ($keys = get_post_custom_keys()) {
+		echo &quot;&lt;ul class='post-meta'&gt;\n&quot;;
+		foreach ($keys as $key) {
+			$values = array_map('trim',$post_meta_cache[$id][$key]);
+			$value = implode($values,', ');
+			
+			echo &quot;&lt;li&gt;&lt;span class='post-meta-key'&gt;$key:&lt;/span&gt; $value&lt;/li&gt;\n&quot;;
+		}
+		echo &quot;&lt;/ul&gt;\n&quot;;
+	}
+}
+
+
+//
+// Pages
+//
+
+function &amp;get_page_children($page_id, $pages) {
+	global $page_cache;
+
+	if ( empty($pages) )
+		$pages = &amp;$page_cache;
+
+	$page_list = array();
+	foreach ($pages as $page) {
+		if ($page-&gt;post_parent == $page_id) {
+			$page_list[] = $page;
+			if ( $children = get_page_children($page-&gt;ID, $pages)) {
+				$page_list = array_merge($page_list, $children);
+			}
+		}
+	}
+
+	return $page_list;
+}
+
+function &amp;get_pages($args = '') {
+	global $wpdb;
+
+	parse_str($args, $r);
+
+	if (!isset($r['child_of'])) $r['child_of'] = 0;
+	if (!isset($r['sort_column'])) $r['sort_column'] = 'post_title';
+	if (!isset($r['sort_order'])) $r['sort_order'] = 'ASC';
+
+	$exclusions = '';
+	if (!empty($r['exclude'])) {
+		$expages = preg_split('/[\s,]+/',$r['exclude']);
+		if (count($expages)) {
+			foreach ($expages as $expage) {
+				$exclusions .= ' AND ID &lt;&gt; ' . intval($expage) . ' ';
+			}
+		}
+	}
+
+	$pages = $wpdb-&gt;get_results(&quot;SELECT * &quot; .
+															&quot;FROM $wpdb-&gt;posts &quot; .
+															&quot;WHERE post_status = 'static' &quot; .
+															&quot;$exclusions &quot; .
+															&quot;ORDER BY &quot; . $r['sort_column'] . &quot; &quot; . $r['sort_order']);
+
+	if ( empty($pages) )
+		return array();
+
+	// Update cache.
+	update_page_cache($pages);
+
+	if ($r['child_of'])
+		$pages = &amp; get_page_children($r['child_of'], $pages);
+
+	return $pages;
+}
+
+function wp_list_pages($args = '') {
+	parse_str($args, $r);
+	if ( !isset($r['depth']) ) $r['depth'] = 0;
+	if ( !isset($r['show_date']) ) $r['show_date'] = '';
+	if ( !isset($r['child_of']) ) $r['child_of'] = 0;
+	if ( !isset($r['title_li']) ) $r['title_li'] = __('Pages');
+	if ( !isset($r['echo']) ) $r['echo'] = 1;
+	
+	$output = '';
+
+	// Query pages.
+	$pages = &amp; get_pages($args);
+	if ( $pages ) :
+
+	if ( $r['title_li'] )
+		$output .= '&lt;li class=&quot;pagenav&quot;&gt;' . $r['title_li'] . '&lt;ul&gt;';
+	// Now loop over all pages that were selected
+	$page_tree = Array();
+	foreach($pages as $page) {
+		// set the title for the current page
+		$page_tree[$page-&gt;ID]['title'] = $page-&gt;post_title;
+		$page_tree[$page-&gt;ID]['name'] = $page-&gt;post_name;
+
+		// set the selected date for the current page
+		// depending on the query arguments this is either
+		// the createtion date or the modification date
+		// as a unix timestamp. It will also always be in the
+		// ts field.
+		if (! empty($r['show_date'])) {
+			if ('modified' == $r['show_date'])
+				$page_tree[$page-&gt;ID]['ts'] = $page-&gt;post_modified;
+			else
+				$page_tree[$page-&gt;ID]['ts'] = $page-&gt;post_date;
+		}
+
+		// The tricky bit!!
+		// Using the parent ID of the current page as the
+		// array index we set the curent page as a child of that page.
+		// We can now start looping over the $page_tree array
+		// with any ID which will output the page links from that ID downwards.
+		if ( $page-&gt;post_parent != $page-&gt;ID)
+			$page_tree[$page-&gt;post_parent]['children'][] = $page-&gt;ID;
+	}
+	// Output of the pages starting with child_of as the root ID.
+	// child_of defaults to 0 if not supplied in the query.
+	$output .= _page_level_out($r['child_of'],$page_tree, $r, 0, false);
+	if ( $r['title_li'] )
+		$output .= '&lt;/ul&gt;&lt;/li&gt;';
+	endif;
+	
+	$output = apply_filters('wp_list_pages', $output);
+	
+	if ( $r['echo'] )
+		echo $output;
+	else 
+		return $output;
+}
+
+function _page_level_out($parent, $page_tree, $args, $depth = 0, $echo = true) {
+	global $wp_query;
+
+	$queried_obj = $wp_query-&gt;get_queried_object();
+
+	$output = '';
+
+	if($depth)
+		$indent = str_repeat(&quot;\t&quot;, $depth);
+	//$indent = join('', array_fill(0,$depth,&quot;\t&quot;));
+
+	foreach($page_tree[$parent]['children'] as $page_id) {
+		$cur_page = $page_tree[$page_id];
+		$title = $cur_page['title'];
+
+		$css_class = 'page_item';
+		if( $page_id == $queried_obj-&gt;ID) {
+			$css_class .= ' current_page_item';
+		}
+
+		$output .= $indent . '&lt;li class=&quot;' . $css_class . '&quot;&gt;&lt;a href=&quot;' . get_page_link($page_id) . '&quot; title=&quot;' . wp_specialchars($title) . '&quot;&gt;' . $title . '&lt;/a&gt;';
+
+		if(isset($cur_page['ts'])) {
+			$format = get_settings('date_format');
+			if(isset($args['date_format']))
+				$format = $args['date_format'];
+			$output .= &quot; &quot; . mysql2date($format, $cur_page['ts']);
+		}
+		echo &quot;\n&quot;;
+
+		if(isset($cur_page['children']) &amp;&amp; is_array($cur_page['children'])) {
+			$new_depth = $depth + 1;
+
+			if(!$args['depth'] || $depth &lt; ($args['depth']-1)) {
+				$output .= &quot;$indent&lt;ul&gt;\n&quot;;
+				$output .= _page_level_out($page_id, $page_tree, $args, $new_depth, false);
+				$output .= &quot;$indent&lt;/ul&gt;\n&quot;;
+			}
+		}
+		$output .= &quot;$indent&lt;/li&gt;\n&quot;;
+	}
+	if ( $echo )
+		echo $output;
+	else
+		return $output;
+}
+
+?&gt;

Added: trunk/wp-includes/vars.php
===================================================================
--- trunk/wp-includes/vars.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/vars.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,113 @@
+&lt;?php
+
+// On which page are we ?
+$PHP_SELF = $_SERVER['PHP_SELF'];
+if (preg_match('#([^/]+.php)#', $PHP_SELF, $self_matches)) {
+	$pagenow = $self_matches[1];
+} else if (strstr($PHP_SELF, '?')) {
+	$pagenow = explode('/', $PHP_SELF);
+	$pagenow = trim($pagenow[(sizeof($pagenow)-1)]);
+	$pagenow = explode('?', $pagenow);
+	$pagenow = $pagenow[0];
+} else {
+	$pagenow = 'index.php';
+}
+
+// Simple browser detection
+$is_lynx = 0; $is_gecko = 0; $is_winIE = 0; $is_macIE = 0; $is_opera = 0; $is_NS4 = 0;
+if (!isset($HTTP_USER_AGENT)) {
+	$HTTP_USER_AGENT = $_SERVER['HTTP_USER_AGENT'];
+}
+if (preg_match('/Lynx/', $HTTP_USER_AGENT)) {
+	$is_lynx = 1;
+} elseif (preg_match('/Gecko/', $HTTP_USER_AGENT)) {
+	$is_gecko = 1;
+} elseif ((preg_match('/MSIE/', $HTTP_USER_AGENT)) &amp;&amp; (preg_match('/Win/', $HTTP_USER_AGENT))) {
+	$is_winIE = 1;
+} elseif ((preg_match('/MSIE/', $HTTP_USER_AGENT)) &amp;&amp; (preg_match('/Mac/', $HTTP_USER_AGENT))) {
+	$is_macIE = 1;
+} elseif (preg_match('/Opera/', $HTTP_USER_AGENT)) {
+	$is_opera = 1;
+} elseif ((preg_match('/Nav/', $HTTP_USER_AGENT) ) || (preg_match('/Mozilla\/4\./', $HTTP_USER_AGENT))) {
+	$is_NS4 = 1;
+}
+$is_IE    = (($is_macIE) || ($is_winIE));
+
+// Server detection
+$is_apache = strstr($_SERVER['SERVER_SOFTWARE'], 'Apache') ? 1 : 0;
+$is_IIS = strstr($_SERVER['SERVER_SOFTWARE'], 'Microsoft-IIS') ? 1 : 0;
+
+// if the config file does not provide the smilies array, let's define it here
+if (!isset($wpsmiliestrans)) {
+	$wpsmiliestrans = array(
+	' :)'        =&gt; 'icon_smile.gif',
+	' :D'        =&gt; 'icon_biggrin.gif',
+	' :-D'       =&gt; 'icon_biggrin.gif',
+	':grin:'    =&gt; 'icon_biggrin.gif',
+	' :)'        =&gt; 'icon_smile.gif',
+	' :-)'       =&gt; 'icon_smile.gif',
+	':smile:'   =&gt; 'icon_smile.gif',
+	' :('        =&gt; 'icon_sad.gif',
+	' :-('       =&gt; 'icon_sad.gif',
+	':sad:'     =&gt; 'icon_sad.gif',
+	' :o'        =&gt; 'icon_surprised.gif',
+	' :-o'       =&gt; 'icon_surprised.gif',
+	':eek:'     =&gt; 'icon_surprised.gif',
+	' 8O'        =&gt; 'icon_eek.gif',
+	' 8-O'       =&gt; 'icon_eek.gif',
+	':shock:'   =&gt; 'icon_eek.gif',
+	' :?'        =&gt; 'icon_confused.gif',
+	' :-?'       =&gt; 'icon_confused.gif',
+	' :???:'     =&gt; 'icon_confused.gif',
+	' 8)'        =&gt; 'icon_cool.gif',
+	' 8-)'       =&gt; 'icon_cool.gif',
+	':cool:'    =&gt; 'icon_cool.gif',
+	':lol:'     =&gt; 'icon_lol.gif',
+	' :x'        =&gt; 'icon_mad.gif',
+	' :-x'       =&gt; 'icon_mad.gif',
+	':mad:'     =&gt; 'icon_mad.gif',
+	' :P'        =&gt; 'icon_razz.gif',
+	' :-P'       =&gt; 'icon_razz.gif',
+	':razz:'    =&gt; 'icon_razz.gif',
+	':oops:'    =&gt; 'icon_redface.gif',
+	':cry:'     =&gt; 'icon_cry.gif',
+	':evil:'    =&gt; 'icon_evil.gif',
+	':twisted:' =&gt; 'icon_twisted.gif',
+	':roll:'    =&gt; 'icon_rolleyes.gif',
+	':wink:'    =&gt; 'icon_wink.gif',
+	' ;)'        =&gt; 'icon_wink.gif',
+	' ;-)'       =&gt; 'icon_wink.gif',
+	':!:'       =&gt; 'icon_exclaim.gif',
+	':?:'       =&gt; 'icon_question.gif',
+	':idea:'    =&gt; 'icon_idea.gif',
+	':arrow:'   =&gt; 'icon_arrow.gif',
+	' :|'        =&gt; 'icon_neutral.gif',
+	' :-|'       =&gt; 'icon_neutral.gif',
+	':neutral:' =&gt; 'icon_neutral.gif',
+	':mrgreen:' =&gt; 'icon_mrgreen.gif',
+	);
+}
+
+// sorts the smilies' array
+if (!function_exists('smiliescmp')) {
+function smiliescmp ($a, $b) {
+	if (strlen($a) == strlen($b)) {
+		return strcmp($a, $b);
+	}
+		return (strlen($a) &gt; strlen($b)) ? -1 : 1;
+	}
+}
+uksort($wpsmiliestrans, 'smiliescmp');
+
+// generates smilies' search &amp; replace arrays
+foreach($wpsmiliestrans as $smiley =&gt; $img) {
+	$wp_smiliessearch[] = $smiley;
+	$smiley_masked = htmlspecialchars( trim($smiley) , ENT_QUOTES);
+	$wp_smiliesreplace[] = &quot; &lt;img src='&quot; . get_settings('siteurl') . &quot;/wp-images/smilies/$img' alt='$smiley_masked' class='wp-smiley' /&gt; &quot;;
+}
+
+// Path for cookies
+define('COOKIEPATH', preg_replace('|https?://[^/]+|i', '', get_settings('home') . '/' ) );
+define('SITECOOKIEPATH', preg_replace('|https?://[^/]+|i', '', get_settings('siteurl') . '/' ) );
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/version.php
===================================================================
--- trunk/wp-includes/version.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/version.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,7 @@
+&lt;?php
+
+// This just holds the version number, in a separate file so we can bump it without cluttering the SVN
+
+$wp_version = '1.5.2';
+
+?&gt;

Added: trunk/wp-includes/wp-db.php
===================================================================
--- trunk/wp-includes/wp-db.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/wp-db.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,359 @@
+&lt;?php
+//  WordPress DB Class
+
+//  ORIGINAL CODE FROM:
+//  Justin Vincent (<A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">justin at visunet.ie</A>)
+//	<A HREF="http://php.justinvincent.com">http://php.justinvincent.com</A>
+
+define('EZSQL_VERSION', 'WP1.25');
+define('OBJECT', 'OBJECT', true);
+define('ARRAY_A', 'ARRAY_A', false);
+define('ARRAY_N', 'ARRAY_N', false);
+
+if (!defined('SAVEQUERIES'))
+	define('SAVEQUERIES', false);
+
+class wpdb {
+
+	var $show_errors = true;
+	var $num_queries = 0;	
+	var $last_query;
+	var $col_info;
+	var $queries;
+
+	// Our tables
+	var $posts;
+	var $users;
+	var $categories;
+	var $post2cat;
+	var $comments;
+	var $links;
+	var $linkcategories;
+	var $options;
+	var $optiontypes;
+	var $optionvalues;
+	var $optiongroups;
+	var $optiongroup_options;
+	var $postmeta;
+
+	// ==================================================================
+	//	DB Constructor - connects to the server and selects a database
+
+	function wpdb($dbuser, $dbpassword, $dbname, $dbhost) {
+		$this-&gt;dbh = @mysql_connect($dbhost, $dbuser, $dbpassword);
+		if (!$this-&gt;dbh) {
+			$this-&gt;bail(&quot;
+&lt;h1&gt;Error establishing a database connection&lt;/h1&gt;
+&lt;p&gt;This either means that the username and password information in your &lt;code&gt;wp-config.php&lt;/code&gt; file is incorrect or we can't contact the database server at &lt;code&gt;$dbhost&lt;/code&gt;. This could mean your host's database server is down.&lt;/p&gt;
+&lt;ul&gt;
+	&lt;li&gt;Are you sure you have the correct username and password?&lt;/li&gt;
+	&lt;li&gt;Are you sure that you have typed the correct hostname?&lt;/li&gt;
+	&lt;li&gt;Are you sure that the database server is running?&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;If you're unsure what these terms mean you should probably contact your host. If you still need help you can always visit the &lt;a href='<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>'&gt;WordPress Support Forums&lt;/a&gt;.&lt;/p&gt;
+&quot;);
+		}
+
+		$this-&gt;select($dbname);
+	}
+
+	// ==================================================================
+	//	Select a DB (if another one needs to be selected)
+
+	function select($db) {
+		if (!@mysql_select_db($db, $this-&gt;dbh)) {
+			$this-&gt;bail(&quot;
+&lt;h1&gt;Can&#8217;t select database&lt;/h1&gt;
+&lt;p&gt;We were able to connect to the database server (which means your username and password is okay) but not able to select the &lt;code&gt;$db&lt;/code&gt; database.&lt;/p&gt;
+&lt;ul&gt;
+&lt;li&gt;Are you sure it exists?&lt;/li&gt;
+&lt;li&gt;On some systems the name of your database is prefixed with your username, so it would be like username_wordpress. Could that be the problem?&lt;/li&gt;
+&lt;/ul&gt;
+&lt;p&gt;If you don't know how to setup a database you should &lt;strong&gt;contact your host&lt;/strong&gt;. If all else fails you may find help at the &lt;a href='<A HREF="http://wordpress.org/support/">http://wordpress.org/support/</A>'&gt;WordPress Support Forums&lt;/a&gt;.&lt;/p&gt;&quot;);
+		}
+	}
+
+	// ====================================================================
+	//	Format a string correctly for safe insert under all PHP conditions
+	
+	function escape($str) {
+		return addslashes($str);				
+	}
+
+	// ==================================================================
+	//	Print SQL/DB error.
+
+	function print_error($str = '') {
+		global $EZSQL_ERROR;
+		if (!$str) $str = mysql_error();
+		$EZSQL_ERROR[] = 
+		array ('query' =&gt; $this-&gt;last_query, 'error_str' =&gt; $str);
+
+		// Is error output turned on or not..
+		if ( $this-&gt;show_errors ) {
+			// If there is an error then take note of it
+			print &quot;&lt;div id='error'&gt;
+			&lt;p class='wpdberror'&gt;&lt;strong&gt;WordPress database error:&lt;/strong&gt; [$str]&lt;br /&gt;
+			&lt;code&gt;$this-&gt;last_query&lt;/code&gt;&lt;/p&gt;
+			&lt;/div&gt;&quot;;
+		} else {
+			return false;	
+		}
+	}
+
+	// ==================================================================
+	//	Turn error handling on or off..
+
+	function show_errors() {
+		$this-&gt;show_errors = true;
+	}
+	
+	function hide_errors() {
+		$this-&gt;show_errors = false;
+	}
+
+	// ==================================================================
+	//	Kill cached query results
+
+	function flush() {
+		$this-&gt;last_result = null;
+		$this-&gt;col_info = null;
+		$this-&gt;last_query = null;
+	}
+
+	// ==================================================================
+	//	Basic Query	- see docs for more detail
+
+	function query($query) {
+		// initialise return
+		$return_val = 0;
+		$this-&gt;flush();
+
+		// Log how the function was called
+		$this-&gt;func_call = &quot;\$db-&gt;query(\&quot;$query\&quot;)&quot;;
+
+		// Keep track of the last query for debug..
+		$this-&gt;last_query = $query;
+
+		// Perform the query via std mysql_query function..
+		if (SAVEQUERIES)
+			$this-&gt;timer_start();
+		
+		$this-&gt;result = @mysql_query($query, $this-&gt;dbh);
+		++$this-&gt;num_queries;
+
+		if (SAVEQUERIES)
+			$this-&gt;queries[] = array( $query, $this-&gt;timer_stop() );
+
+		// If there is an error then take note of it..
+		if ( mysql_error() ) {
+			$this-&gt;print_error();
+			return false;
+		}
+
+		if ( preg_match(&quot;/^\\s*(insert|delete|update|replace) /i&quot;,$query) ) {
+			$this-&gt;rows_affected = mysql_affected_rows();
+			// Take note of the insert_id
+			if ( preg_match(&quot;/^\\s*(insert|replace) /i&quot;,$query) ) {
+				$this-&gt;insert_id = mysql_insert_id($this-&gt;dbh);	
+			}
+			// Return number of rows affected
+			$return_val = $this-&gt;rows_affected;
+		} else {
+			$i = 0;
+			while ($i &lt; @mysql_num_fields($this-&gt;result)) {
+				$this-&gt;col_info[$i] = @mysql_fetch_field($this-&gt;result);
+				$i++;
+			}
+			$num_rows = 0;
+			while ( $row = @mysql_fetch_object($this-&gt;result) ) {
+				$this-&gt;last_result[$num_rows] = $row;
+				$num_rows++;
+			}
+
+			@mysql_free_result($this-&gt;result);
+
+			// Log number of rows the query returned
+			$this-&gt;num_rows = $num_rows;
+			
+			// Return number of rows selected
+			$return_val = $this-&gt;num_rows;
+		}
+
+		return $return_val;
+	}
+
+	// ==================================================================
+	//	Get one variable from the DB - see docs for more detail
+
+	function get_var($query=null, $x = 0, $y = 0) {
+		$this-&gt;func_call = &quot;\$db-&gt;get_var(\&quot;$query\&quot;,$x,$y)&quot;;
+		if ( $query )
+			$this-&gt;query($query);
+
+		// Extract var out of cached results based x,y vals
+		if ( $this-&gt;last_result[$y] ) {
+			$values = array_values(get_object_vars($this-&gt;last_result[$y]));
+		}
+
+		// If there is a value return it else return null
+		return (isset($values[$x]) &amp;&amp; $values[$x]!=='') ? $values[$x] : null;
+	}
+
+	// ==================================================================
+	//	Get one row from the DB - see docs for more detail
+
+	function get_row($query = null, $output = OBJECT, $y = 0) {
+		$this-&gt;func_call = &quot;\$db-&gt;get_row(\&quot;$query\&quot;,$output,$y)&quot;;
+		if ( $query )
+			$this-&gt;query($query);
+
+		if ( $output == OBJECT ) {
+			return $this-&gt;last_result[$y] ? $this-&gt;last_result[$y] : null;
+		} elseif ( $output == ARRAY_A ) {
+			return $this-&gt;last_result[$y] ? get_object_vars($this-&gt;last_result[$y]) : null;
+		} elseif ( $output == ARRAY_N ) {
+			return $this-&gt;last_result[$y] ? array_values(get_object_vars($this-&gt;last_result[$y])) : null;
+		} else {
+			$this-&gt;print_error(&quot; \$db-&gt;get_row(string query, output type, int offset) -- Output type must be one of: OBJECT, ARRAY_A, ARRAY_N&quot;);
+		}
+	}
+
+	// ==================================================================
+	//	Function to get 1 column from the cached result set based in X index
+	// se docs for usage and info
+
+	function get_col($query = null , $x = 0) {
+		if ( $query )
+			$this-&gt;query($query);
+
+		// Extract the column values
+		for ( $i=0; $i &lt; count($this-&gt;last_result); $i++ ) {
+			$new_array[$i] = $this-&gt;get_var(null, $x, $i);
+		}
+		return $new_array;
+	}
+
+	// ==================================================================
+	// Return the the query as a result set - see docs for more details
+
+	function get_results($query = null, $output = OBJECT) {
+		$this-&gt;func_call = &quot;\$db-&gt;get_results(\&quot;$query\&quot;, $output)&quot;;
+
+		if ( $query )
+			$this-&gt;query($query);
+
+		// Send back array of objects. Each row is an object
+		if ( $output == OBJECT ) {
+			return $this-&gt;last_result;
+		} elseif ( $output == ARRAY_A || $output == ARRAY_N ) {
+			if ( $this-&gt;last_result ) {
+				$i = 0;
+				foreach( $this-&gt;last_result as $row ) {
+					$new_array[$i] = (array) $row;
+					if ( $output == ARRAY_N ) {
+						$new_array[$i] = array_values($new_array[$i]);
+					}
+					$i++;
+				}
+				return $new_array;
+			} else {
+				return null;
+			}
+		}
+	}
+
+
+	// ==================================================================
+	// Function to get column meta data info pertaining to the last query
+	// see docs for more info and usage
+
+	function get_col_info($info_type = 'name', $col_offset = -1) {
+		if ( $this-&gt;col_info ) {
+			if ( $col_offset == -1 ) {
+				$i = 0;
+				foreach($this-&gt;col_info as $col ) {
+					$new_array[$i] = $col-&gt;{$info_type};
+					$i++;
+				}
+				return $new_array;
+			} else {
+				return $this-&gt;col_info[$col_offset]-&gt;{$info_type};
+			}
+		}
+	}
+
+	function timer_start() {
+		$mtime = microtime();
+		$mtime = explode(' ', $mtime);
+		$this-&gt;time_start = $mtime[1] + $mtime[0];
+		return true;
+	}
+	
+	function timer_stop($precision = 3) {
+		$mtime = microtime();
+		$mtime = explode(' ', $mtime);
+		$time_end = $mtime[1] + $mtime[0];
+		$time_total = $time_end - $this-&gt;time_start;
+		return $time_total;
+	}
+
+	function bail($message) { // Just wraps errors in a nice header and footer
+	if ( !$this-&gt;show_errors )
+		return false;
+	header( 'Content-Type: text/html; charset=utf-8');		
+	echo &lt;&lt;&lt;HEAD
+	&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+	&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+	&lt;head&gt;
+		&lt;title&gt;WordPress &rsaquo; Error&lt;/title&gt;
+		&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+		&lt;style media=&quot;screen&quot; type=&quot;text/css&quot;&gt;
+		&lt;!--
+		html {
+			background: #eee;
+		}
+		body {
+			background: #fff;
+			color: #000;
+			font-family: Georgia, &quot;Times New Roman&quot;, Times, serif;
+			margin-left: 25%;
+			margin-right: 25%;
+			padding: .2em 2em;
+		}
+		
+		h1 {
+			color: #006;
+			font-size: 18px;
+			font-weight: lighter;
+		}
+		
+		h2 {
+			font-size: 16px;
+		}
+		
+		p, li, dt {
+			line-height: 140%;
+			padding-bottom: 2px;
+		}
+	
+		ul, ol {
+			padding: 5px 5px 5px 20px;
+		}
+		#logo {
+			margin-bottom: 2em;
+		}
+		--&gt;
+		&lt;/style&gt;
+	&lt;/head&gt;
+	&lt;body&gt;
+	&lt;h1 id=&quot;logo&quot;&gt;&lt;img alt=&quot;WordPress&quot; src=&quot;<A HREF="http://static.wordpress.org/logo.png">http://static.wordpress.org/logo.png</A>&quot; /&gt;&lt;/h1&gt;
+HEAD;
+	echo $message;
+	echo &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
+	die();
+	}
+}
+
+$wpdb = new wpdb(DB_USER, DB_PASSWORD, DB_NAME, DB_HOST);
+?&gt;
\ No newline at end of file

Added: trunk/wp-includes/wp-l10n.php
===================================================================
--- trunk/wp-includes/wp-l10n.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-includes/wp-l10n.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,103 @@
+&lt;?php
+
+if ( defined('WPLANG') &amp;&amp; '' != constant('WPLANG') ) {
+	include_once(ABSPATH . 'wp-includes/streams.php');
+	include_once(ABSPATH . 'wp-includes/gettext.php');
+}
+
+function get_locale() {
+	global $locale;
+
+	if (isset($locale))
+		return $locale;
+
+	// WPLANG is defined in wp-config.
+	if (defined('WPLANG')) {
+    $locale = WPLANG;
+	}
+	
+	if (empty($locale)) {
+    $locale = 'en_US';
+	}
+
+	$locale = apply_filters('locale', $locale);
+
+	return $locale;
+}
+
+// Return a translated string.    
+function __($text, $domain = 'default') {
+	global $l10n;
+
+	if (isset($l10n[$domain])) {
+		return $l10n[$domain]-&gt;translate($text);
+	} else {
+		return $text;
+	}
+}
+
+// Echo a translated string.
+function _e($text, $domain = 'default') {
+	global $l10n;
+
+	if (isset($l10n[$domain])) {
+		echo $l10n[$domain]-&gt;translate($text);
+	} else {
+		echo $text;
+	}
+}
+
+// Return the plural form.
+function __ngettext($single, $plural, $number, $domain = 'default') {
+	global $l10n;
+
+	if (isset($l10n[$domain])) {
+		return $l10n[$domain]-&gt;ngettext($single, $plural, $number);
+	} else {
+		if ($number != 1)
+			return $plural;
+		else
+			return $single;
+	}
+}
+
+function load_textdomain($domain, $mofile) {
+	global $l10n;
+
+	if (isset($l10n[$domain])) {
+		return;
+	}
+
+	if ( is_readable($mofile)) {
+    $input = new CachedFileReader($mofile);
+	}	else {
+		return;
+	}
+
+	$l10n[$domain] = new gettext_reader($input);
+}
+
+function load_default_textdomain() {
+	global $l10n;
+
+	$locale = get_locale();
+	$mofile = ABSPATH . &quot;wp-includes/languages/$locale.mo&quot;;
+	
+	load_textdomain('default', $mofile);
+}
+
+function load_plugin_textdomain($domain) {
+	$locale = get_locale();
+	
+	$mofile = ABSPATH . &quot;wp-content/plugins/$domain-$locale.mo&quot;;
+	load_textdomain($domain, $mofile);
+}
+
+function load_theme_textdomain($domain) {
+	$locale = get_locale();
+	
+	$mofile = get_template_directory() . &quot;/$locale.mo&quot;;
+	load_textdomain($domain, $mofile);
+}
+
+?&gt;
\ No newline at end of file

Added: trunk/wp-links-opml.php
===================================================================
--- trunk/wp-links-opml.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-links-opml.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,58 @@
+&lt;?php 
+$doing_rss = 1;
+
+require('wp-blog-header.php');
+header('Content-type: text/xml; charset=' . get_settings('blog_charset'), true);
+$link_cat = $_GET['link_cat'];
+if ((empty($link_cat)) || ($link_cat == 'all') || ($link_cat == '0')) {
+    $sql_cat = '';
+} else { // be safe
+    $link_cat = ''.urldecode($link_cat).'';
+    $link_cat = addslashes_gpc($link_cat);
+    $link_cat = intval($link_cat);
+    if ($link_cat != 0) {
+        $sql_cat = &quot;AND $wpdb-&gt;links.link_category = $link_cat&quot;;
+        $cat_name = $wpdb-&gt;get_var(&quot;SELECT $wpdb-&gt;linkcategories.cat_name FROM $wpdb-&gt;linkcategories WHERE $wpdb-&gt;linkcategories.cat_id = $link_cat&quot;);
+        if (!empty($cat_name)) {
+            $cat_name = &quot;: category $cat_name&quot;;
+        }
+    }
+}
+?&gt;&lt;?php echo '&lt;?xml version=&quot;1.0&quot;?'.&quot;&gt;\n&quot;; ?&gt;
+&lt;!-- generator=&quot;wordpress/&lt;?php echo $wp_version ?&gt;&quot; --&gt;
+&lt;opml version=&quot;1.0&quot;&gt;
+    &lt;head&gt;
+        &lt;title&gt;Links for &lt;?php echo get_bloginfo('name').$cat_name ?&gt;&lt;/title&gt;
+        &lt;dateCreated&gt;&lt;?php echo gmdate(&quot;D, d M Y H:i:s&quot;); ?&gt; GMT&lt;/dateCreated&gt;
+    &lt;/head&gt;
+    &lt;body&gt;
+&lt;?php $sql = &quot;SELECT $wpdb-&gt;links.link_url, link_rss, $wpdb-&gt;links.link_name, $wpdb-&gt;links.link_category, $wpdb-&gt;linkcategories.cat_name, link_updated 
+FROM $wpdb-&gt;links 
+ JOIN $wpdb-&gt;linkcategories on $wpdb-&gt;links.link_category = $wpdb-&gt;linkcategories.cat_id
+ $sql_cat
+ ORDER BY $wpdb-&gt;linkcategories.cat_name, $wpdb-&gt;links.link_name \n&quot;;
+ //echo(&quot;&lt;!-- $sql --&gt;&quot;);
+ $prev_cat_id = 0;
+ $results = $wpdb-&gt;get_results($sql);
+ if ($results) {
+     foreach ($results as $result) {
+         if ($result-&gt;link_category != $prev_cat_id) { // new category
+             if ($prev_cat_id != 0)  { // not first time
+?&gt;
+        &lt;/outline&gt;
+&lt;?php
+             } // end if not first time
+?&gt;
+        &lt;outline type=&quot;category&quot; title=&quot;&lt;?php echo wp_specialchars($result-&gt;cat_name); ?&gt;&quot;&gt;
+&lt;?php
+             $prev_cat_id = $result-&gt;link_category;
+        } // end if new category
+?&gt;
+            &lt;outline title=&quot;&lt;?php echo wp_specialchars($result-&gt;link_name); ?&gt;&quot; type=&quot;link&quot; xmlUrl=&quot;&lt;?php echo wp_specialchars($result-&gt;link_rss); ?&gt;&quot; htmlUrl=&quot;&lt;?php echo wp_specialchars($result-&gt;link_url); ?&gt;&quot; updated=&quot;&lt;?php if ('0000-00-00 00:00:00' != $result-&gt;link_updated) echo $result-&gt;link_updated; ?&gt;&quot; /&gt;
+&lt;?php
+        } // end foreach
+    } // end if
+?&gt;
+        &lt;/outline&gt;
+    &lt;/body&gt;
+&lt;/opml&gt;
\ No newline at end of file

Added: trunk/wp-login.php
===================================================================
--- trunk/wp-login.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-login.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,256 @@
+&lt;?php
+require( dirname(__FILE__) . '/wp-config.php' );
+
+$action = $_REQUEST['action'];
+$error = '';
+
+header('Expires: Wed, 11 Jan 1984 05:00:00 GMT');
+header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
+header('Cache-Control: no-cache, must-revalidate');
+header('Pragma: no-cache');
+header('Content-Type: '.get_bloginfo('html_type').'; charset='.get_bloginfo('charset'));
+
+if ( defined('RELOCATE') ) { // Move flag is set
+	if ( isset( $_SERVER['PATH_INFO'] ) &amp;&amp; ($_SERVER['PATH_INFO'] != $_SERVER['PHP_SELF']) )
+		$_SERVER['PHP_SELF'] = str_replace( $_SERVER['PATH_INFO'], '', $_SERVER['PHP_SELF'] );
+
+	if ( dirname('<A HREF="http://">http://</A>' . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF']) != get_settings('siteurl') )
+		update_option('siteurl', dirname('<A HREF="http://">http://</A>' . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF']) );
+}
+
+switch($action) {
+
+case 'logout':
+
+	wp_clearcookie();
+	do_action('wp_logout');
+	header('Expires: Wed, 11 Jan 1984 05:00:00 GMT');
+	header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
+	header('Cache-Control: no-cache, must-revalidate, max-age=0');
+	header('Pragma: no-cache');
+	wp_redirect('wp-login.php');
+	exit();
+
+break;
+
+case 'lostpassword':
+do_action('lost_password');
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;SteamPress &raquo; &lt;?php _e('Lost Password') ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('charset'); ?&gt;&quot; /&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php echo get_settings('siteurl'); ?&gt;/wp-admin/wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+	&lt;script type=&quot;text/javascript&quot;&gt;
+	function focusit() {
+		// focus on first input field
+		document.getElementById('user_login').focus();
+	}
+	window.onload = focusit;
+	&lt;/script&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+	#user_login, #email, #submit {
+		font-size: 1.7em;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+	&lt;div id=&quot;login&quot;&gt;
+		&lt;h1&gt;&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;&lt;/h1&gt;
+		&lt;p&gt;&lt;?php _e('Please enter your information here. We will send you a new password.') ?&gt;&lt;/p&gt;
+&lt;?php
+if ($error)
+	echo &quot;&lt;div id='login_error'&gt;$error&lt;/div&gt;&quot;;
+?&gt;
+
+		&lt;form name=&quot;lostpass&quot; action=&quot;wp-login.php&quot; method=&quot;post&quot; id=&quot;lostpass&quot;&gt;
+			&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;retrievepassword&quot; /&gt;
+			&lt;dl&gt;
+				&lt;dt&gt;&lt;?php _e('Username:') ?&gt;&lt;/dt&gt;
+				&lt;dd&gt;&lt;input type=&quot;text&quot; name=&quot;user_login&quot; id=&quot;user_login&quot; value=&quot;&quot; size=&quot;20&quot; tabindex=&quot;1&quot; /&gt;&lt;/dd&gt;
+				&lt;dt&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/dt&gt;
+				&lt;dd&gt;&lt;input type=&quot;text&quot; name=&quot;email&quot; id=&quot;email&quot; value=&quot;&quot; size=&quot;25&quot; tabindex=&quot;2&quot; /&gt;&lt;/dd&gt;
+			&lt;/dl&gt;
+			&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; id=&quot;submit&quot; value=&quot;&lt;?php _e('Retrieve Password'); ?&gt; &raquo;&quot; tabindex=&quot;3&quot; /&gt;&lt;/p&gt;
+		&lt;/form&gt;
+		&lt;ul&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('home'); ?&gt;&quot; title=&quot;&lt;?php _e('Are you lost?') ?&gt;&quot;&gt;&laquo; &lt;?php _e('Back to blog') ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;?php if (get_settings('users_can_register')) : ?&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-register.php&quot;&gt;&lt;?php _e('Register') ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;?php endif; ?&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-login.php&quot;&gt;&lt;?php _e('Login') ?&gt;&lt;/a&gt;&lt;/li&gt;
+		&lt;/ul&gt;
+	&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+&lt;?php
+break;
+
+case 'retrievepassword':
+	$user_data = get_userdatabylogin($_POST['user_login']);
+	// redefining user_login ensures we return the right case in the email
+	$user_login = $user_data-&gt;user_login;
+	$user_email = $user_data-&gt;user_email;
+
+	if (!$user_email || $user_email != $_POST['email'])
+		die(sprintf(__('Sorry, that user does not seem to exist in our database. Perhaps you have the wrong username or e-mail address? &lt;a href=&quot;%s&quot;&gt;Try again&lt;/a&gt;.'), 'wp-login.php?action=lostpassword'));
+
+do_action('retreive_password', $user_login);  // Misspelled and deprecated.
+do_action('retrieve_password', $user_login);
+
+	// Generate something random for a password... md5'ing current time with a rand salt
+	$key = substr( md5( uniqid( microtime() ) ), 0, 50);
+	// now insert the new pass md5'd into the db
+ 	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_activation_key = '$key' WHERE user_login = '$user_login'&quot;);
+	$message = __('Someone has asked to reset the password for the following site and username.') . &quot;\r\n\r\n&quot;;
+	$message .= get_option('siteurl') . &quot;\r\n\r\n&quot;;
+	$message .= sprintf(__('Username: %s'), $user_login) . &quot;\r\n\r\n&quot;;
+	$message .= __('To reset your password visit the following address, otherwise just ignore this email and nothing will happen.') . &quot;\r\n\r\n&quot;;
+	$message .= get_settings('siteurl') . &quot;/wp-login.php?action=resetpass&amp;key=$key\r\n&quot;;
+
+	$m = wp_mail($user_email, sprintf(__('[%s] Password Reset'), get_settings('blogname')), $message);
+
+	if ($m == false) {
+		 echo '&lt;p&gt;' . __('The e-mail could not be sent.') . &quot;&lt;br /&gt;\n&quot;;
+         echo  __('Possible reason: your host may have disabled the mail() function...') . &quot;&lt;/p&gt;&quot;;
+		die();
+	} else {
+		echo '&lt;p&gt;' .  sprintf(__(&quot;The e-mail was sent successfully to %s's e-mail address.&quot;), $user_login) . '&lt;br /&gt;';
+		echo  &quot;&lt;a href='wp-login.php' title='&quot; . __('Check your e-mail first, of course') . &quot;'&gt;&quot; . __('Click here to login!') . '&lt;/a&gt;&lt;/p&gt;';
+		die();
+	}
+
+break;
+
+case 'resetpass' :
+
+	// Generate something random for a password... md5'ing current time with a rand salt
+	$key = $_GET['key'];
+	if ( empty($key) )
+		die( __('Sorry, that key does not appear to be valid.') );
+	$user = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users WHERE user_activation_key = '$key'&quot;);
+	if ( !$user )
+		die( __('Sorry, that key does not appear to be valid.') );
+
+	do_action('password_reset');
+
+	$new_pass = substr( md5( uniqid( microtime() ) ), 0, 7);
+ 	$wpdb-&gt;query(&quot;UPDATE $wpdb-&gt;users SET user_pass = MD5('$new_pass'), user_activation_key = '' WHERE user_login = '$user-&gt;user_login'&quot;);
+	$message  = sprintf(__('Username: %s'), $user-&gt;user_login) . &quot;\r\n&quot;;
+	$message .= sprintf(__('Password: %s'), $new_pass) . &quot;\r\n&quot;;
+	$message .= get_settings('siteurl') . &quot;/wp-login.php\r\n&quot;;
+
+	$m = wp_mail($user-&gt;user_email, sprintf(__('[%s] Your new password'), get_settings('blogname')), $message);
+
+	if ($m == false) {
+		echo '&lt;p&gt;' . __('The e-mail could not be sent.') . &quot;&lt;br /&gt;\n&quot;;
+		echo  __('Possible reason: your host may have disabled the mail() function...') . '&lt;/p&gt;';
+		die();
+	} else {
+		echo '&lt;p&gt;' .  sprintf(__('Your new password is in the mail.'), $user_login) . '&lt;br /&gt;';
+        echo  &quot;&lt;a href='wp-login.php' title='&quot; . __('Check your e-mail first, of course') . &quot;'&gt;&quot; . __('Click here to login!') . '&lt;/a&gt;&lt;/p&gt;';
+		// send a copy of password change notification to the admin
+		$message = sprintf(__('Password Lost and Changed for user: %s'), $user-&gt;user_login) . &quot;\r\n&quot;;
+		wp_mail(get_settings('admin_email'), sprintf(__('[%s] Password Lost/Change'), get_settings('blogname')), $message);
+		die();
+	}
+break;
+
+case 'login' :
+default:
+
+	$user_login = '';
+	$user_pass = '';
+	$redirect_to = 'wp-admin/';
+	$using_cookie = false;
+
+	if( !empty($_POST) ) {
+		$user_login = $_POST['log'];
+		$user_pass  = $_POST['pwd'];
+		$redirect_to = preg_replace('|[^a-z0-9-~+_.?#=&amp;;,/:]|i', '', $_POST['redirect_to']);
+	} elseif ( !empty($_COOKIE) ) {
+		if (! empty($_COOKIE['wordpressuser_' . COOKIEHASH]) )
+			$user_login = $_COOKIE['wordpressuser_' . COOKIEHASH];
+		if (! empty($_COOKIE['wordpresspass_' . COOKIEHASH]) ) {
+			$user_pass = $_COOKIE['wordpresspass_' . COOKIEHASH];
+			$using_cookie = true;
+		}
+	}
+
+	do_action('wp_authenticate', array(&amp;$user_login, &amp;$user_pass));
+
+	if ($user_login &amp;&amp; $user_pass) {
+		$user = get_userdatabylogin($user_login);
+		if ( 0 == $user-&gt;user_level )
+			$redirect_to = get_settings('siteurl') . '/wp-admin/profile.php';
+
+		if ( wp_login($user_login, $user_pass, $using_cookie) ) {
+			if (! $using_cookie) {
+				wp_setcookie($user_login, $user_pass);
+			}
+			do_action('wp_login', $user_login);
+			wp_redirect($redirect_to);
+			exit();
+		} else {
+			if ($using_cookie)
+				$error = __('Your session has expired.');
+		}
+	}
+	if ( isset($_REQUEST['redirect_to']) )
+		$redirect_to = preg_replace('|[^a-z0-9-~+_.?#=&amp;;,/:]|i', '', $_REQUEST['redirect_to']);
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;SteamPress &rsaquo; &lt;?php _e('Login') ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php bloginfo('charset'); ?&gt;&quot; /&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-admin/wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+	&lt;script type=&quot;text/javascript&quot;&gt;
+	function focusit()
+	{
+		document.getElementById('log').focus();
+	}
+	window.onload = focusit;
+	&lt;/script&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+	#log, #pwd, #submit {
+		font-size: 1.5em;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+	&lt;div id=&quot;login&quot;&gt;
+		&lt;h1&gt;&lt;a href=&quot;<A HREF="http://steamedpenguin.com/projects/steampress/">http://steamedpenguin.com/projects/steampress/</A>&quot;&gt;SteamPress&lt;/a&gt;&lt;/h1&gt;
+&lt;?php
+if ( $error )
+	echo &quot;&lt;div id='login_error'&gt;$error&lt;/div&gt;&quot;;
+?&gt;
+
+		&lt;form name=&quot;loginform&quot; id=&quot;loginform&quot; action=&quot;wp-login.php&quot; method=&quot;post&quot;&gt;
+			&lt;dl&gt;
+				&lt;dt&gt;&lt;?php _e('Username:') ?&gt;&lt;/dt&gt;
+				&lt;dd&gt;&lt;input type=&quot;text&quot; name=&quot;log&quot; id=&quot;log&quot; value=&quot;&quot; size=&quot;20&quot; tabindex=&quot;1&quot; /&gt;&lt;/dd&gt;
+				&lt;dt&gt;&lt;?php _e('Password:') ?&gt;&lt;/dt&gt;
+				&lt;dd&gt;&lt;input type=&quot;password&quot; name=&quot;pwd&quot; id=&quot;pwd&quot; value=&quot;&quot; size=&quot;20&quot; tabindex=&quot;2&quot; /&gt;&lt;/dd&gt;
+			&lt;/dl&gt;
+			&lt;p class=&quot;submit&quot;&gt;
+				&lt;input type=&quot;submit&quot; name=&quot;submit&quot; id=&quot;submit&quot; value=&quot;&lt;?php _e('Login'); ?&gt; &raquo;&quot; tabindex=&quot;3&quot; /&gt;
+				&lt;input type=&quot;hidden&quot; name=&quot;redirect_to&quot; value=&quot;&lt;?php echo $redirect_to; ?&gt;&quot; /&gt;
+			&lt;/p&gt;
+		&lt;/form&gt;
+		&lt;ul&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('home'); ?&gt;&quot; title=&quot;&lt;?php _e('Are you lost?') ?&gt;&quot;&gt;&laquo; &lt;?php _e('Back to blog') ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;?php if (get_settings('users_can_register')) : ?&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-register.php&quot;&gt;&lt;?php _e('Register') ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;?php endif; ?&gt;
+			&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-login.php?action=lostpassword&quot; title=&quot;&lt;?php _e('Password Lost and Found') ?&gt;&quot;&gt;&lt;?php _e('Lost your password?') ?&gt;&lt;/a&gt;&lt;/li&gt;
+		&lt;/ul&gt;
+	&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+&lt;?php
+
+break;
+} // end action switch
+?&gt;

Added: trunk/wp-pass.php
===================================================================
--- trunk/wp-pass.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-pass.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,11 @@
+&lt;?php
+require( dirname(__FILE__) . '/wp-config.php');
+
+if ( get_magic_quotes_gpc() )
+	$_POST['post_password'] = stripslashes($_POST['post_password']);
+
+// 10 days
+setcookie('wp-postpass_' . COOKIEHASH, $_POST['post_password'], time() + 864000, COOKIEPATH);
+
+wp_redirect($_SERVER['HTTP_REFERER']);
+?&gt;
\ No newline at end of file

Added: trunk/wp-rdf.php
===================================================================
--- trunk/wp-rdf.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-rdf.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,57 @@
+&lt;?php /* RDF 1.0 generator, original version by <A HREF="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">garym at teledyn.com</A> */
+
+if (empty($feed)) {
+    $blog = 1; // enter your blog's ID
+		$feed = 'rdf';
+    $doing_rss = 1;
+    require('wp-blog-header.php');
+}
+
+header('Content-type: application/rdf+xml; charset=' . get_settings('blog_charset'), true);
+$more = 1;
+
+?&gt;
+&lt;?php echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;'.get_settings('blog_charset').'&quot;?'.'&gt;'; ?&gt;
+&lt;!-- generator=&quot;wordpress/&lt;?php echo $wp_version ?&gt;&quot; --&gt;
+&lt;rdf:RDF
+	xmlns=&quot;<A HREF="http://purl.org/rss/1.0/">http://purl.org/rss/1.0/</A>&quot;
+	xmlns:rdf=&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#">http://www.w3.org/1999/02/22-rdf-syntax-ns#</A>&quot;
+	xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+	xmlns:sy=&quot;<A HREF="http://purl.org/rss/1.0/modules/syndication/">http://purl.org/rss/1.0/modules/syndication/</A>&quot;
+	xmlns:admin=&quot;<A HREF="http://webns.net/mvcb/">http://webns.net/mvcb/</A>&quot;
+	xmlns:content=&quot;<A HREF="http://purl.org/rss/1.0/modules/content/">http://purl.org/rss/1.0/modules/content/</A>&quot;
+&gt;
+&lt;channel rdf:about=&quot;&lt;?php bloginfo_rss(&quot;url&quot;) ?&gt;&quot;&gt;
+	&lt;title&gt;&lt;?php bloginfo_rss('name') ?&gt;&lt;/title&gt;
+	&lt;link&gt;&lt;?php bloginfo_rss('url') ?&gt;&lt;/link&gt;
+	&lt;description&gt;&lt;?php bloginfo_rss('description') ?&gt;&lt;/description&gt;
+	&lt;dc:date&gt;&lt;?php echo mysql2date('Y-m-d\TH:i:s\Z', get_lastpostmodified('GMT'), false); ?&gt;&lt;/dc:date&gt;
+	&lt;admin:generatorAgent rdf:resource=&quot;<A HREF="http://wordpress.org/?v=&lt;?php">http://wordpress.org/?v=&lt;?php</A> echo $wp_version ?&gt;&quot;/&gt;
+	&lt;sy:updatePeriod&gt;hourly&lt;/sy:updatePeriod&gt;
+	&lt;sy:updateFrequency&gt;1&lt;/sy:updateFrequency&gt;
+	&lt;sy:updateBase&gt;2000-01-01T12:00+00:00&lt;/sy:updateBase&gt;
+	&lt;items&gt;
+		&lt;rdf:Seq&gt;
+		&lt;?php $items_count = 0; if ($posts) { foreach ($posts as $post) { start_wp(); ?&gt;
+			&lt;rdf:li rdf:resource=&quot;&lt;?php permalink_single_rss() ?&gt;&quot;/&gt;
+		&lt;?php $wp_items[] = $row; $items_count++; if (($items_count == get_settings('posts_per_rss')) &amp;&amp; empty($m)) { break; } } } ?&gt;
+		&lt;/rdf:Seq&gt;
+	&lt;/items&gt;
+&lt;/channel&gt;
+&lt;?php if ($posts) { foreach ($posts as $post) { start_wp(); ?&gt;
+&lt;item rdf:about=&quot;&lt;?php permalink_single_rss() ?&gt;&quot;&gt;
+	&lt;title&gt;&lt;?php the_title_rss() ?&gt;&lt;/title&gt;
+	&lt;link&gt;&lt;?php permalink_single_rss() ?&gt;&lt;/link&gt;
+	 &lt;dc:date&gt;&lt;?php echo mysql2date('Y-m-d\TH:i:s\Z', $post-&gt;post_date_gmt, false); ?&gt;&lt;/dc:date&gt;
+	&lt;dc:creator&gt;&lt;?php the_author() ?&gt;&lt;/dc:creator&gt;
+	&lt;?php the_category_rss('rdf') ?&gt;
+&lt;?php if (get_settings('rss_use_excerpt')) : ?&gt;
+	&lt;description&gt;&lt;?php the_excerpt_rss() ?&gt;&lt;/description&gt;
+&lt;?php else : ?&gt;
+	&lt;description&gt;&lt;?php the_content_rss('', 0, '', get_settings('rss_excerpt_length'), 2) ?&gt;&lt;/description&gt;
+	&lt;content:encoded&gt;&lt;![CDATA[&lt;?php the_content('', 0, '') ?&gt;]]&gt;&lt;/content:encoded&gt;
+&lt;?php endif; ?&gt;
+	
+&lt;/item&gt;
+&lt;?php } }  ?&gt;
+&lt;/rdf:RDF&gt;
\ No newline at end of file

Added: trunk/wp-register.php
===================================================================
--- trunk/wp-register.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-register.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,184 @@
+&lt;?php
+require('./wp-config.php');
+
+$wpvarstoreset = array('action');
+for ($i=0; $i&lt;count($wpvarstoreset); $i += 1) {
+	$wpvar = $wpvarstoreset[$i];
+	if (!isset($$wpvar)) {
+		if (empty($_POST[&quot;$wpvar&quot;])) {
+			if (empty($_GET[&quot;$wpvar&quot;])) {
+				$$wpvar = '';
+			} else {
+				$$wpvar = $_GET[&quot;$wpvar&quot;];
+			}
+		} else {
+			$$wpvar = $_POST[&quot;$wpvar&quot;];
+		}
+	}
+}
+
+if ( !get_settings('users_can_register') )
+	$action = 'disabled';
+
+header( 'Content-Type: ' . get_bloginfo('html_type') . '; charset=' . get_bloginfo('charset') );
+
+switch($action) {
+
+case 'register':
+
+	$user_login = $_POST['user_login'];
+	$user_email = $_POST['user_email'];
+		
+	/* checking that username has been typed */
+	if ($user_login == '') {
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Please enter a username.'));
+	}
+
+	/* checking e-mail address */
+	if ($user_email == '') {
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: Please type your e-mail address.'));
+	} else if (!is_email($user_email)) {
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: The email address isn&#8217;t correct.'));
+	}
+
+	/* checking the username isn't already used by another user */
+	$result = $wpdb-&gt;get_results(&quot;SELECT user_login FROM $wpdb-&gt;users WHERE user_login = '$user_login'&quot;);
+    if (count($result) &gt;= 1) {
+		die (__('&lt;strong&gt;ERROR&lt;/strong&gt;: This username is already registered, please choose another one.'));
+	}
+
+	$user_ip = $_SERVER['REMOTE_ADDR'] ;
+
+	$user_browser = $wpdb-&gt;escape($_SERVER['HTTP_USER_AGENT']);
+
+	$user_login = $wpdb-&gt;escape( preg_replace('|a-z0-9 _.-|i', '', $user_login) );
+	$user_nickname = $user_login;
+   $user_nicename = sanitize_title($user_nickname);
+	$now = gmdate('Y-m-d H:i:s');
+	$user_level = get_settings('new_users_can_blog');
+	$password = substr( md5( uniqid( microtime() ) ), 0, 7);
+
+	$result = $wpdb-&gt;query(&quot;INSERT INTO $wpdb-&gt;users 
+		(user_login, user_pass, user_nickname, user_email, user_ip, user_browser, user_registered, user_level, user_idmode, user_nicename)
+	VALUES 
+		('$user_login', MD5('$password'), '$user_nickname', '$user_email', '$user_ip', '$user_browser', '$now', '$user_level', 'nickname', '$user_nicename')&quot;);
+
+	do_action('user_register', $wpdb-&gt;insert_id);
+
+	if ($result == false) {
+		die (sprintf(__('&lt;strong&gt;ERROR&lt;/strong&gt;: Couldn&#8217;t register you... please contact the &lt;a href=&quot;mailto:%s&quot;&gt;webmaster&lt;/a&gt; !'), get_settings('admin_email')));
+	}
+
+	$stars = '';
+	for ($i = 0; $i &lt; strlen($pass1); $i = $i + 1) {
+		$stars .= '*';
+	}
+	
+	$message  = sprintf(__('Username: %s'), $user_login) . &quot;\r\n&quot;;
+	$message .= sprintf(__('Password: %s'), $password) . &quot;\r\n&quot;;
+	$message .= get_settings('siteurl') . &quot;/wp-login.php\r\n&quot;;
+	
+	wp_mail($user_email, sprintf(__('[%s] Your username and password'), get_settings('blogname')), $message);
+
+	$message  = sprintf(__('New user registration on your blog %s:'), get_settings('blogname')) . &quot;\r\n\r\n&quot;;
+	$message .= sprintf(__('Username: %s'), $user_login) . &quot;\r\n\r\n&quot;;
+	$message .= sprintf(__('E-mail: %s'), $user_email) . &quot;\r\n&quot;;
+
+	@wp_mail(get_settings('admin_email'), sprintf(__('[%s] New User Registration'), get_settings('blogname')), $message);
+
+	?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;WordPress &raquo; &lt;?php _e('Registration Complete') ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;	
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin/wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+	.submit {
+		font-size: 1.7em;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+
+&lt;div id=&quot;login&quot;&gt; 
+	&lt;h2&gt;&lt;?php _e('Registration Complete') ?&gt;&lt;/h2&gt;
+	&lt;p&gt;&lt;?php printf(__('Username: %s'), &quot;&lt;strong&gt;$user_login&lt;/strong&gt;&quot;) ?&gt;&lt;br /&gt;
+	&lt;?php printf(__('Password: %s'), '&lt;strong&gt;' . __('emailed to you') . '&lt;/strong&gt;') ?&gt; &lt;br /&gt;
+	&lt;?php printf(__('E-mail: %s'), &quot;&lt;strong&gt;$user_email&lt;/strong&gt;&quot;) ?&gt;&lt;/p&gt;
+	&lt;p class=&quot;submit&quot;&gt;&lt;a href=&quot;wp-login.php&quot;&gt;&lt;?php _e('Login'); ?&gt; &raquo;&lt;/a&gt;&lt;/p&gt;
+&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+
+	&lt;?php
+break;
+
+case 'disabled':
+
+	?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;WordPress &raquo; &lt;?php _e('Registration Currently Disabled') ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot;&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin/wp-admin.css&quot; type=&quot;text/css&quot;&gt;
+&lt;/head&gt;
+
+&lt;body&gt;
+
+&lt;div id=&quot;login&quot;&gt;
+	&lt;h2&gt;&lt;?php _e('Registration Disabled') ?&gt;&lt;/h2&gt;
+	&lt;p&gt;&lt;?php _e('User registration is currently not allowed.') ?&gt;&lt;br /&gt;
+	&lt;a href=&quot;&lt;?php echo get_settings('home') . '/'; ?&gt;&quot; title=&quot;&lt;?php _e('Go back to the blog') ?&gt;&quot;&gt;&lt;?php _e('Home') ?&gt;&lt;/a&gt;
+	&lt;/p&gt;
+&lt;/div&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
+
+	&lt;?php
+break;
+
+default:
+
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;WordPress &raquo; &lt;?php _e('Registration Form') ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+	&lt;link rel=&quot;stylesheet&quot; href=&quot;wp-admin/wp-admin.css&quot; type=&quot;text/css&quot; /&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+	#user_email, #user_login, #submit {
+		font-size: 1.7em;
+	}
+	&lt;/style&gt;
+&lt;/head&gt;
+
+&lt;body&gt;
+&lt;div id=&quot;login&quot;&gt;
+&lt;h1&gt;&lt;a href=&quot;<A HREF="http://wordpress.org/">http://wordpress.org/</A>&quot;&gt;WordPress&lt;/a&gt;&lt;/h1&gt;
+&lt;h2&gt;&lt;?php _e('Register for this blog') ?&gt;&lt;/h2&gt;
+
+&lt;form method=&quot;post&quot; action=&quot;wp-register.php&quot; id=&quot;registerform&quot;&gt;
+	&lt;p&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;register&quot; /&gt;
+	&lt;label for=&quot;user_login&quot;&gt;&lt;?php _e('Username:') ?&gt;&lt;/label&gt;&lt;br /&gt; &lt;input type=&quot;text&quot; name=&quot;user_login&quot; id=&quot;user_login&quot; size=&quot;20&quot; maxlength=&quot;20&quot; /&gt;&lt;br /&gt;&lt;/p&gt;
+	&lt;p&gt;&lt;label for=&quot;user_email&quot;&gt;&lt;?php _e('E-mail:') ?&gt;&lt;/label&gt;&lt;br /&gt; &lt;input type=&quot;text&quot; name=&quot;user_email&quot; id=&quot;user_email&quot; size=&quot;25&quot; maxlength=&quot;100&quot; /&gt;&lt;/p&gt;
+	&lt;p&gt;A password will be emailed to you.&lt;/p&gt;
+	&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;&lt;?php _e('Register') ?&gt; &raquo;&quot; id=&quot;submit&quot; name=&quot;submit&quot; /&gt;&lt;/p&gt;
+&lt;/form&gt;
+&lt;ul&gt;
+	&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('home'); ?&gt;&quot; title=&quot;&lt;?php _e('Are you lost?') ?&gt;&quot;&gt;&laquo; &lt;?php _e('Back to blog') ?&gt;&lt;/a&gt;&lt;/li&gt;
+	&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-login.php&quot;&gt;&lt;?php _e('Login') ?&gt;&lt;/a&gt;&lt;/li&gt;
+	&lt;li&gt;&lt;a href=&quot;&lt;?php bloginfo('wpurl'); ?&gt;/wp-login.php?action=lostpassword&quot; title=&quot;&lt;?php _e('Password Lost and Found') ?&gt;&quot;&gt;&lt;?php _e('Lost your password?') ?&gt;&lt;/a&gt;&lt;/li&gt;
+&lt;/ul&gt;
+&lt;/div&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;
+&lt;?php
+
+break;
+}
+?&gt;

Added: trunk/wp-rss.php
===================================================================
--- trunk/wp-rss.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-rss.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,37 @@
+&lt;?php
+
+if (empty($feed)) {
+    $blog = 1;
+		$feed = 'rss';
+    $doing_rss = 1;
+    require('wp-blog-header.php');
+}
+
+header('Content-type: text/xml; charset=' . get_settings('blog_charset'), true);
+$more = 1;
+
+?&gt;
+&lt;?php echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;'.get_settings('blog_charset').'&quot;?'.'&gt;'; ?&gt;
+&lt;!-- generator=&quot;wordpress/&lt;?php echo $wp_version ?&gt;&quot; --&gt;
+&lt;rss version=&quot;0.92&quot;&gt;
+&lt;channel&gt;
+	&lt;title&gt;&lt;?php bloginfo_rss('name') ?&gt;&lt;/title&gt;
+	&lt;link&gt;&lt;?php bloginfo_rss('url') ?&gt;&lt;/link&gt;
+	&lt;description&gt;&lt;?php bloginfo_rss('description') ?&gt;&lt;/description&gt;
+	&lt;lastBuildDate&gt;&lt;?php echo mysql2date('D, d M Y H:i:s +0000', get_lastpostmodified('GMT'), false); ?&gt;&lt;/lastBuildDate&gt;
+	&lt;docs&gt;<A HREF="http://backend.userland.com/rss092&lt;/docs">http://backend.userland.com/rss092&lt;/docs</A>&gt;
+	&lt;language&gt;&lt;?php echo get_option('rss_language'); ?&gt;&lt;/language&gt;
+
+&lt;?php $items_count = 0; if ($posts) { foreach ($posts as $post) { start_wp(); ?&gt;
+	&lt;item&gt;
+		&lt;title&gt;&lt;?php the_title_rss() ?&gt;&lt;/title&gt;
+&lt;?php if (get_settings('rss_use_excerpt')) { ?&gt;
+		&lt;description&gt;&lt;![CDATA[&lt;?php the_excerpt_rss() ?&gt;]]&gt;&lt;/description&gt;
+&lt;?php } else { // use content ?&gt;
+		&lt;description&gt;&lt;?php the_content_rss('', 0, '', get_settings('rss_excerpt_length')) ?&gt;&lt;/description&gt;
+&lt;?php } ?&gt;
+		&lt;link&gt;&lt;?php permalink_single_rss() ?&gt;&lt;/link&gt;
+	&lt;/item&gt;
+&lt;?php $items_count++; if (($items_count == get_settings('posts_per_rss')) &amp;&amp; empty($m)) { break; } } } ?&gt;
+&lt;/channel&gt;
+&lt;/rss&gt;

Added: trunk/wp-rss2.php
===================================================================
--- trunk/wp-rss2.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-rss2.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,56 @@
+&lt;?php
+
+if (empty($feed)) {
+	$blog = 1;
+	$feed = 'rss2';
+	$doing_rss = 1;
+	require('wp-blog-header.php');
+}
+
+header('Content-type: text/xml; charset=' . get_settings('blog_charset'), true);
+$more = 1;
+
+?&gt;
+&lt;?php echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;'.get_settings('blog_charset').'&quot;?'.'&gt;'; ?&gt;
+
+&lt;!-- generator=&quot;wordpress/&lt;?php bloginfo_rss('version') ?&gt;&quot; --&gt;
+&lt;rss version=&quot;2.0&quot; 
+	xmlns:content=&quot;<A HREF="http://purl.org/rss/1.0/modules/content/">http://purl.org/rss/1.0/modules/content/</A>&quot;
+	xmlns:wfw=&quot;<A HREF="http://wellformedweb.org/CommentAPI/">http://wellformedweb.org/CommentAPI/</A>&quot;
+	xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+&gt;
+
+&lt;channel&gt;
+	&lt;title&gt;&lt;?php bloginfo_rss('name'); ?&gt;&lt;/title&gt;
+	&lt;link&gt;&lt;?php bloginfo_rss('url') ?&gt;&lt;/link&gt;
+	&lt;description&gt;&lt;?php bloginfo_rss(&quot;description&quot;) ?&gt;&lt;/description&gt;
+	&lt;pubDate&gt;&lt;?php echo mysql2date('D, d M Y H:i:s +0000', get_lastpostmodified('GMT'), false); ?&gt;&lt;/pubDate&gt;
+	&lt;generator&gt;<A HREF="http://wordpress.org/?v=&lt;?php">http://wordpress.org/?v=&lt;?php</A> bloginfo_rss('version'); ?&gt;&lt;/generator&gt;
+	&lt;language&gt;&lt;?php echo get_option('rss_language'); ?&gt;&lt;/language&gt;
+
+	&lt;?php $items_count = 0; if ($posts) { foreach ($posts as $post) { start_wp(); ?&gt;
+	&lt;item&gt;
+		&lt;title&gt;&lt;?php the_title_rss() ?&gt;&lt;/title&gt;
+		&lt;link&gt;&lt;?php permalink_single_rss() ?&gt;&lt;/link&gt;
+		&lt;comments&gt;&lt;?php comments_link(); ?&gt;&lt;/comments&gt;
+		&lt;pubDate&gt;&lt;?php echo mysql2date('D, d M Y H:i:s +0000', get_post_time('Y-m-d H:i:s', true), false); ?&gt;&lt;/pubDate&gt;
+		&lt;dc:creator&gt;&lt;?php the_author() ?&gt;&lt;/dc:creator&gt;
+		&lt;?php the_category_rss() ?&gt;
+
+		&lt;guid&gt;&lt;?php the_permalink($id); ?&gt;&lt;/guid&gt;
+&lt;?php if (get_settings('rss_use_excerpt')) : ?&gt;
+		&lt;description&gt;&lt;![CDATA[&lt;?php the_excerpt_rss() ?&gt;]]&gt;&lt;/description&gt;
+&lt;?php else : ?&gt;
+		&lt;description&gt;&lt;![CDATA[&lt;?php the_excerpt_rss() ?&gt;]]&gt;&lt;/description&gt;
+	&lt;?php if ( strlen( $post-&gt;post_content ) &gt; 0 ) : ?&gt;
+		&lt;content:encoded&gt;&lt;![CDATA[&lt;?php the_content('', 0, '') ?&gt;]]&gt;&lt;/content:encoded&gt;
+	&lt;?php else : ?&gt;
+		&lt;content:encoded&gt;&lt;![CDATA[&lt;?php the_excerpt_rss() ?&gt;]]&gt;&lt;/content:encoded&gt;
+	&lt;?php endif; ?&gt;
+&lt;?php endif; ?&gt;
+		&lt;wfw:commentRSS&gt;&lt;?php echo comments_rss(); ?&gt;&lt;/wfw:commentRSS&gt;
+&lt;?php rss_enclosure(); ?&gt;
+	&lt;/item&gt;
+	&lt;?php $items_count++; if (($items_count == get_settings('posts_per_rss')) &amp;&amp; empty($m)) { break; } } } ?&gt;
+&lt;/channel&gt;
+&lt;/rss&gt;

Added: trunk/wp-settings.php
===================================================================
--- trunk/wp-settings.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-settings.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,170 @@
+&lt;?php
+// Turn register globals off
+function unregister_GLOBALS() {
+	if ( !ini_get('register_globals') )
+		return;
+
+	if ( isset($_REQUEST['GLOBALS']) )
+		die('GLOBALS overwrite attempt detected');
+
+	// Variables that shouldn't be unset
+	$noUnset = array('GLOBALS', '_GET', '_POST', '_COOKIE', '_REQUEST', '_SERVER', '_ENV', '_FILES', 'table_prefix');
+	
+	$input = array_merge($_GET, $_POST, $_COOKIE, $_SERVER, $_ENV, $_FILES, isset($_SESSION) &amp;&amp; is_array($_SESSION) ? $_SESSION : array());
+	foreach ( $input as $k =&gt; $v ) 
+		if ( !in_array($k, $noUnset) &amp;&amp; isset($GLOBALS[$k]) )
+			unset($GLOBALS[$k]);
+}
+
+unregister_GLOBALS(); 
+
+$HTTP_HOST = getenv('HTTP_HOST');  /* domain name */
+$REMOTE_ADDR = getenv('REMOTE_ADDR'); /* visitor's IP */
+$HTTP_USER_AGENT = getenv('HTTP_USER_AGENT'); /* visitor's browser */
+unset( $wp_filter, $cache_userdata, $cache_lastcommentmodified, $cache_lastpostdate, $cache_settings, $category_cache, $cache_categories );
+
+// Fix for IIS, which doesn't set REQUEST_URI
+if (! isset($_SERVER['REQUEST_URI'])) {
+	$_SERVER['REQUEST_URI'] = $_SERVER['SCRIPT_NAME'];
+	
+	// Append the query string if it exists and isn't null
+	if (isset($_SERVER['QUERY_STRING']) &amp;&amp; !empty($_SERVER['QUERY_STRING'])) {
+		$_SERVER['REQUEST_URI'] .= '?' . $_SERVER['QUERY_STRING'];
+	}
+}
+
+if ( !(phpversion() &gt;= '4.1') )
+	die( 'Your server is running PHP version ' . phpversion() . ' but WordPress requires at least 4.1' );
+
+if ( !extension_loaded('mysql') )
+	die( 'Your PHP installation appears to be missing the MySQL which is required for WordPress.' );
+
+function timer_start() {
+	global $timestart;
+	$mtime = explode(' ', microtime() );
+	$mtime = $mtime[1] + $mtime[0];
+	$timestart = $mtime;
+	return true;
+}
+timer_start();
+
+// Change to E_ALL for development/debugging
+error_reporting(E_ALL ^ E_NOTICE);
+
+// For an advanced caching plugin to use, static because you would only want one
+if ( defined('WP_CACHE') )
+	require (ABSPATH . 'wp-content/advanced-cache.php');
+
+define('WPINC', 'wp-includes');
+require_once (ABSPATH . WPINC . '/wp-db.php');
+
+// Table names
+$wpdb-&gt;posts            = $table_prefix . 'posts';
+$wpdb-&gt;users            = $table_prefix . 'users';
+$wpdb-&gt;categories       = $table_prefix . 'categories';
+$wpdb-&gt;post2cat         = $table_prefix . 'post2cat';
+$wpdb-&gt;comments         = $table_prefix . 'comments';
+$wpdb-&gt;links            = $table_prefix . 'links';
+$wpdb-&gt;linkcategories   = $table_prefix . 'linkcategories';
+$wpdb-&gt;options          = $table_prefix . 'options';
+$wpdb-&gt;postmeta         = $table_prefix . 'postmeta';
+
+if ( defined('CUSTOM_USER_TABLE') )
+	$wpdb-&gt;users = CUSTOM_USER_TABLE;
+
+// We're going to need to keep this around for a few months even though we're not using it internally
+
+$tableposts = $wpdb-&gt;posts;
+$tableusers = $wpdb-&gt;users;
+$tablecategories = $wpdb-&gt;categories;
+$tablepost2cat = $wpdb-&gt;post2cat;
+$tablecomments = $wpdb-&gt;comments;
+$tablelinks = $wpdb-&gt;links;
+$tablelinkcategories = $wpdb-&gt;linkcategories;
+$tableoptions = $wpdb-&gt;options;
+$tablepostmeta = $wpdb-&gt;postmeta;
+
+require (ABSPATH . WPINC . '/functions.php');
+require (ABSPATH . WPINC . '/default-filters.php');
+require_once (ABSPATH . WPINC . '/wp-l10n.php');
+
+$wpdb-&gt;hide_errors();
+if ( !update_user_cache() &amp;&amp; (!strstr($_SERVER['PHP_SELF'], 'install.php') &amp;&amp; !defined('WP_INSTALLING')) ) {
+	if ( strstr($_SERVER['PHP_SELF'], 'wp-admin') )
+		$link = 'install.php';
+	else
+		$link = 'wp-admin/install.php';
+	die(sprintf(__(&quot;It doesn't look like you've installed WP yet. Try running &lt;a href='%s'&gt;install.php&lt;/a&gt;.&quot;), $link));
+}
+$wpdb-&gt;show_errors();
+
+require (ABSPATH . WPINC . '/functions-formatting.php');
+require (ABSPATH . WPINC . '/functions-post.php');
+require (ABSPATH . WPINC . '/classes.php');
+require (ABSPATH . WPINC . '/template-functions-general.php');
+require (ABSPATH . WPINC . '/template-functions-links.php');
+require (ABSPATH . WPINC . '/template-functions-author.php');
+require (ABSPATH . WPINC . '/template-functions-post.php');
+require (ABSPATH . WPINC . '/template-functions-category.php');
+require (ABSPATH . WPINC . '/comment-functions.php');
+require (ABSPATH . WPINC . '/feed-functions.php');
+require (ABSPATH . WPINC . '/links.php');
+require (ABSPATH . WPINC . '/kses.php');
+require (ABSPATH . WPINC . '/version.php');
+
+if (!strstr($_SERVER['PHP_SELF'], 'install.php') &amp;&amp; !strstr($_SERVER['PHP_SELF'], 'wp-admin/import')) :
+    // Used to guarantee unique hash cookies
+    $cookiehash = md5(get_settings('siteurl')); // Remove in 1.4
+	define('COOKIEHASH', $cookiehash); 
+endif;
+
+require (ABSPATH . WPINC . '/vars.php');
+
+do_action('core_files_loaded');
+
+// Check for hacks file if the option is enabled
+if (get_settings('hack_file')) {
+	if (file_exists(ABSPATH . '/my-hacks.php'))
+		require(ABSPATH . '/my-hacks.php');
+}
+
+if ( get_settings('active_plugins') ) {
+	$current_plugins = get_settings('active_plugins');
+	if ( is_array($current_plugins) ) {
+		foreach ($current_plugins as $plugin) {
+			if ('' != $plugin &amp;&amp; file_exists(ABSPATH . 'wp-content/plugins/' . $plugin))
+				include_once(ABSPATH . 'wp-content/plugins/' . $plugin);
+		}
+	}
+}
+
+require (ABSPATH . WPINC . '/pluggable-functions.php');
+
+if ( defined('WP_CACHE') &amp;&amp; function_exists('wp_cache_postload') )
+	wp_cache_postload();
+
+do_action('plugins_loaded');
+
+define('TEMPLATEPATH', get_template_directory());
+
+// Load the default text localization domain.
+load_default_textdomain();
+
+// Pull in locale data after loading text domain.
+require_once(ABSPATH . WPINC . '/locale.php');
+
+if ( !get_magic_quotes_gpc() ) {
+	$_GET    = add_magic_quotes($_GET   );
+	$_POST   = add_magic_quotes($_POST  );
+	$_COOKIE = add_magic_quotes($_COOKIE);
+	$_SERVER = add_magic_quotes($_SERVER);
+}
+
+function shutdown_action_hook() {
+	do_action('shutdown');
+}
+register_shutdown_function('shutdown_action_hook');
+
+// Everything is loaded.
+do_action('init');
+?&gt;

Added: trunk/wp-trackback.php
===================================================================
--- trunk/wp-trackback.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp-trackback.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,95 @@
+&lt;?php
+require_once( dirname(__FILE__) . '/wp-config.php' );
+
+if ( empty($doing_trackback) ) {
+	$doing_trackback = true;
+	$tb = true;
+	require_once('wp-blog-header.php');
+}
+
+function trackback_response($error = 0, $error_message = '') {
+	header('Content-Type: text/xml; charset=' . get_option('blog_charset') );
+	if ($error) {
+		echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?'.&quot;&gt;\n&quot;;
+		echo &quot;&lt;response&gt;\n&quot;;
+		echo &quot;&lt;error&gt;1&lt;/error&gt;\n&quot;;
+		echo &quot;&lt;message&gt;$error_message&lt;/message&gt;\n&quot;;
+		echo &quot;&lt;/response&gt;&quot;;
+		die();
+	} else {
+		echo '&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?'.&quot;&gt;\n&quot;;
+		echo &quot;&lt;response&gt;\n&quot;;
+		echo &quot;&lt;error&gt;0&lt;/error&gt;\n&quot;;
+		echo &quot;&lt;/response&gt;&quot;;
+	}
+}
+
+// trackback is done by a POST
+$request_array = 'HTTP_POST_VARS';
+
+if ( !$_GET['tb_id'] ) {
+	$tb_id = explode('/', $_SERVER['REQUEST_URI']);
+	$tb_id = intval( $tb_id[ count($tb_id) - 1 ] );
+}
+
+$tb_url    = $_POST['url'];
+$title     = $_POST['title'];
+$excerpt   = $_POST['excerpt'];
+$blog_name = $_POST['blog_name'];
+$charset   = $_POST['charset'];
+
+if ($charset)
+	$charset = strtoupper( trim($charset) );
+else
+	$charset = 'ASCII, UTF-8, ISO-8859-1, JIS, EUC-JP, SJIS';
+
+if ( function_exists('mb_convert_encoding') ) { // For international trackbacks
+	$title     = mb_convert_encoding($title, get_settings('blog_charset'), $charset);
+	$excerpt   = mb_convert_encoding($excerpt, get_settings('blog_charset'), $charset);
+	$blog_name = mb_convert_encoding($blog_name, get_settings('blog_charset'), $charset);
+}
+
+if ( is_single() || is_page() ) 
+    $tb_id = $posts[0]-&gt;ID;
+
+if ( !intval( $tb_id ) )
+	trackback_response(1, 'I really need an ID for this to work.');
+
+if (empty($title) &amp;&amp; empty($tb_url) &amp;&amp; empty($blog_name)) {
+	// If it doesn't look like a trackback at all...
+	header('Location: ' . get_permalink($tb_id));
+	exit;
+}
+
+if ( !empty($tb_url) &amp;&amp; !empty($title) &amp;&amp; !empty($tb_url) ) {
+	header('Content-Type: text/xml; charset=' . get_option('blog_charset') );
+
+	$pingstatus = $wpdb-&gt;get_var(&quot;SELECT ping_status FROM $wpdb-&gt;posts WHERE ID = $tb_id&quot;);
+
+	if ( 'open' != $pingstatus )
+		trackback_response(1, 'Sorry, trackbacks are closed for this item.');
+
+	$title =  wp_specialchars( strip_tags( $title ) );
+	$title = (strlen($title) &gt; 250) ? substr($title, 0, 250) . '...' : $title;
+	$excerpt = strip_tags($excerpt);
+	$excerpt = (strlen($excerpt) &gt; 255) ? substr($excerpt, 0, 252) . '...' : $excerpt;
+
+	$comment_post_ID = $tb_id;
+	$comment_author = $blog_name;
+	$comment_author_email = '';
+	$comment_author_url = $tb_url;
+	$comment_content = &quot;&lt;strong&gt;$title&lt;/strong&gt;\n\n$excerpt&quot;;
+	$comment_type = 'trackback';
+
+	$dupe = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = '$comment_post_ID' AND comment_author_url = '$comment_author_url'&quot;);
+	if ( $dupe )
+		trackback_response(1, 'We already have a ping from that URI for this post.');
+
+	$commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_email', 'comment_author_url', 'comment_content', 'comment_type');
+
+	wp_new_comment($commentdata);
+
+	do_action('trackback_post', $wpdb-&gt;insert_id);
+	trackback_response(0);
+}
+?&gt;
\ No newline at end of file

Added: trunk/wp.php
===================================================================
--- trunk/wp.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/wp.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,48 @@
+&lt;?php
+// This is an example of a very simple template
+require_once('./wp-blog-header.php');
+?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
+&quot;<A HREF="http://www.w3.org/TR/xhtml/DTD/xhtml-transitional.dtd">http://www.w3.org/TR/xhtml/DTD/xhtml-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+	&lt;title&gt;&lt;?php bloginfo('name'); ?&gt;&lt;?php wp_title(); ?&gt;&lt;/title&gt;
+	&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;&lt;?php bloginfo('html_type'); ?&gt;; charset=&lt;?php echo get_settings('blog_charset'); ?&gt;&quot; /&gt;
+	&lt;meta name=&quot;generator&quot; content=&quot;WordPress &lt;?php $wp_version ?&gt;&quot; /&gt; &lt;!-- leave this for stats --&gt;
+	&lt;link rel=&quot;alternate&quot; type=&quot;text/xml&quot; title=&quot;RSS&quot; href=&quot;&lt;?php bloginfo('rss2_url'); ?&gt;&quot; /&gt;
+	&lt;link rel=&quot;pingback&quot; href=&quot;&lt;?php bloginfo('pingback_url'); ?&gt;&quot; /&gt;
+&lt;/head&gt;
+&lt;body&gt;
+&lt;h1 id=&quot;header&quot;&gt;&lt;a href=&quot;&lt;?php echo get_settings('home'); ?&gt;&quot; title=&quot;&lt;?php bloginfo('name'); ?&gt;&quot;&gt;&lt;?php bloginfo('name'); ?&gt;&lt;/a&gt;&lt;/h1&gt;
+
+&lt;!-- // loop start --&gt;
+&lt;?php if (have_posts()) : while (have_posts()) : the_post(); ?&gt;
+&lt;?php the_date('d.m.y', '&lt;h2&gt;','&lt;/h2&gt;'); ?&gt;
+&lt;h3 id=&quot;post-&lt;?php the_ID(); ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot; rel=&quot;bookmark&quot; title=&quot;Permanent Link: &lt;?php the_title(); ?&gt;&quot;&gt;&lt;?php the_title(); ?&gt;&lt;/a&gt;&lt;/h3&gt;
+
+&lt;?php the_content(); ?&gt;
+
+&lt;?php link_pages('&lt;br /&gt;Pages: ', '&lt;br /&gt;', 'number') ?&gt;
+
+&lt;p&gt;&lt;em&gt;Posted by &lt;strong&gt;&lt;?php the_author() ?&gt;&lt;/strong&gt; @ &lt;a href=&quot;&lt;?php the_permalink() ?&gt;&quot;&gt;&lt;?php the_time() ?&gt;&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
+&lt;p&gt;Filed under: &lt;?php the_category(',') ?&gt;&lt;/p&gt;
+
+&lt;?php comments_popup_link('comments ?', '1 comment', '% comments') ?&gt;
+
+&lt;?php comments_template(); ?&gt;
+
+
+&lt;!-- // this is just the end of the motor - don't touch that line either :) --&gt;
+&lt;?php endwhile; else: ?&gt;
+&lt;p&gt;&lt;?php _e('Sorry, no posts matched your criteria.'); ?&gt;&lt;/p&gt;
+&lt;?php endif; ?&gt;
+
+&lt;div align=&quot;right&quot;&gt;&lt;cite&gt;Powered by &lt;a href=&quot;<A HREF="http://wordpress.org">http://wordpress.org</A>&quot;&gt;&lt;strong&gt;Wordpress&lt;/strong&gt;&lt;/a&gt;&lt;/cite&gt;&lt;br /&gt;
+&lt;br /&gt;
+&lt;a href=&quot;wp-login.php&quot;&gt;login&lt;/a&gt;&lt;br /&gt;
+&lt;a href=&quot;wp-register.php&quot;&gt;register&lt;/a&gt;
+&lt;/div&gt;
+
+
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/xmlrpc.php
===================================================================
--- trunk/xmlrpc.php	2005-11-08 14:25:04 UTC (rev 71)
+++ trunk/xmlrpc.php	2005-11-08 14:33:01 UTC (rev 72)
@@ -0,0 +1,1336 @@
+&lt;?php
+
+# fix for mozBlog and other cases where '&lt;?xml' isn't on the very first line
+$HTTP_RAW_POST_DATA = trim($HTTP_RAW_POST_DATA);
+
+include('./wp-config.php');
+include_once(ABSPATH . WPINC . '/class-IXR.php');
+
+// Turn off all warnings and errors.
+// error_reporting(0);
+
+$post_default_title = &quot;&quot;; // posts submitted via the xmlrpc interface get that title
+
+$xmlrpc_logging = 0;
+
+function logIO($io,$msg) {
+	global $xmlrpc_logging;
+	if ($xmlrpc_logging) {
+		$fp = fopen(&quot;../xmlrpc.log&quot;,&quot;a+&quot;);
+		$date = gmdate(&quot;Y-m-d H:i:s &quot;);
+		$iot = ($io == &quot;I&quot;) ? &quot; Input: &quot; : &quot; Output: &quot;;
+		fwrite($fp, &quot;\n\n&quot;.$date.$iot.$msg);
+		fclose($fp);
+	}
+	return true;
+	}
+
+function starify($string) {
+	$i = strlen($string);
+	return str_repeat('*', $i);
+}
+
+logIO(&quot;I&quot;, $HTTP_RAW_POST_DATA);
+
+
+function mkdir_p($target) {
+	// from php.net/mkdir user contributed notes 
+	if (file_exists($target)) {
+	  if (!is_dir($target)) {
+	    return false;
+	  } else {
+	    return true;
+	  }
+	}
+
+	// Attempting to create the directory may clutter up our display.
+	if (@mkdir($target)) {
+	  return true;
+	}
+
+	// If the above failed, attempt to create the parent node, then try again.
+	if (mkdir_p(dirname($target))) {
+	  return mkdir_p($target);
+	}
+
+	return false;
+}
+
+
+class wp_xmlrpc_server extends IXR_Server {
+
+	function wp_xmlrpc_server() {
+		$this-&gt;methods = array(
+		  // Blogger API
+		  'blogger.getUsersBlogs' =&gt; 'this:blogger_getUsersBlogs',
+		  'blogger.getUserInfo' =&gt; 'this:blogger_getUserInfo',
+		  'blogger.getPost' =&gt; 'this:blogger_getPost',
+		  'blogger.getRecentPosts' =&gt; 'this:blogger_getRecentPosts',
+		  'blogger.getTemplate' =&gt; 'this:blogger_getTemplate',
+		  'blogger.setTemplate' =&gt; 'this:blogger_setTemplate',
+		  'blogger.newPost' =&gt; 'this:blogger_newPost',
+		  'blogger.editPost' =&gt; 'this:blogger_editPost',
+		  'blogger.deletePost' =&gt; 'this:blogger_deletePost',
+
+		  // MetaWeblog API (with MT extensions to structs)
+		  'metaWeblog.newPost' =&gt; 'this:mw_newPost',
+		  'metaWeblog.editPost' =&gt; 'this:mw_editPost',
+		  'metaWeblog.getPost' =&gt; 'this:mw_getPost',
+		  'metaWeblog.getRecentPosts' =&gt; 'this:mw_getRecentPosts',
+		  'metaWeblog.getCategories' =&gt; 'this:mw_getCategories',
+		  'metaWeblog.newMediaObject' =&gt; 'this:mw_newMediaObject',
+
+		  // MetaWeblog API aliases for Blogger API
+		  // see <A HREF="http://www.xmlrpc.com/stories/storyReader$2460">http://www.xmlrpc.com/stories/storyReader$2460</A>
+		  'metaWeblog.deletePost' =&gt; 'this:blogger_deletePost',
+		  'metaWeblog.getTemplate' =&gt; 'this:blogger_getTemplate',
+		  'metaWeblog.setTemplate' =&gt; 'this:blogger_setTemplate',
+		  'metaWeblog.getUsersBlogs' =&gt; 'this:blogger_getUsersBlogs',
+
+		  // MovableType API
+		  'mt.getCategoryList' =&gt; 'this:mt_getCategoryList',
+		  'mt.getRecentPostTitles' =&gt; 'this:mt_getRecentPostTitles',
+		  'mt.getPostCategories' =&gt; 'this:mt_getPostCategories',
+		  'mt.setPostCategories' =&gt; 'this:mt_setPostCategories',
+		  'mt.supportedMethods' =&gt; 'this:mt_supportedMethods',
+		  'mt.supportedTextFilters' =&gt; 'this:mt_supportedTextFilters',
+		  'mt.getTrackbackPings' =&gt; 'this:mt_getTrackbackPings',
+		  'mt.publishPost' =&gt; 'this:mt_publishPost',
+
+		  // PingBack
+		  'pingback.ping' =&gt; 'this:pingback_ping',
+		  'pingback.extensions.getPingbacks' =&gt; 'this:pingback_extensions_getPingbacks',
+
+		  'demo.sayHello' =&gt; 'this:sayHello',
+		  'demo.addTwoNumbers' =&gt; 'this:addTwoNumbers'
+		);
+		$this-&gt;methods = apply_filters('xmlrpc_methods', $this-&gt;methods);
+		$this-&gt;IXR_Server($this-&gt;methods);
+	}
+
+	function sayHello($args) {
+		return 'Hello!';
+	}
+
+	function addTwoNumbers($args) {
+		$number1 = $args[0];
+		$number2 = $args[1];
+		return $number1 + $number2;
+	}
+
+	function login_pass_ok($user_login, $user_pass) {
+	  if (!user_pass_ok($user_login, $user_pass)) {
+	    $this-&gt;error = new IXR_Error(403, 'Bad login/pass combination.');
+	    return false;
+	  }
+	  return true;
+	}
+
+	function escape(&amp;$array) {
+		global $wpdb;
+
+		foreach ($array as $k =&gt; $v) {
+			if (is_array($v)) {
+				$this-&gt;escape($array[$k]);
+			} else if (is_object($v)) {
+				//skip
+			} else {
+				$array[$k] = $wpdb-&gt;escape($v);
+			}
+		}
+	}
+
+	/* Blogger API functions
+	 * specs on <A HREF="http://plant.blogger.com/api">http://plant.blogger.com/api</A> and <A HREF="http://groups.yahoo.com/group/bloggerDev/">http://groups.yahoo.com/group/bloggerDev/</A>
+	 */
+
+
+	/* blogger.getUsersBlogs will make more sense once we support multiple blogs */
+	function blogger_getUsersBlogs($args) {
+
+		$this-&gt;escape($args);
+
+	  $user_login = $args[1];
+	  $user_pass  = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  $is_admin = $user_data-&gt;user_level &gt; 3;
+
+	  $struct = array(
+	    'isAdmin'  =&gt; $is_admin,
+	    'url'      =&gt; get_settings('home') . '/',
+	    'blogid'   =&gt; '1',
+	    'blogName' =&gt; get_settings('blogname')
+	  );
+
+	  return array($struct);
+	}
+
+
+	/* blogger.getUsersInfo gives your client some info about you, so you don't have to */
+	function blogger_getUserInfo($args) {
+
+		$this-&gt;escape($args);
+
+	  $user_login = $args[1];
+	  $user_pass  = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+
+	  $struct = array(
+	    'nickname'  =&gt; $user_data-&gt;user_nickname,
+	    'userid'    =&gt; $user_data-&gt;ID,
+	    'url'       =&gt; $user_data-&gt;user_url,
+	    'email'     =&gt; $user_data-&gt;user_email,
+	    'lastname'  =&gt; $user_data-&gt;user_lastname,
+	    'firstname' =&gt; $user_data-&gt;user_firstname
+	  );
+
+	  return $struct;
+	}
+
+
+	/* blogger.getPost ...gets a post */
+	function blogger_getPost($args) {
+
+		$this-&gt;escape($args);
+
+	  $post_ID    = $args[1];
+	  $user_login = $args[2];
+	  $user_pass  = $args[3];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  $post_data = wp_get_single_post($post_ID, ARRAY_A);
+
+	  $categories = implode(',', wp_get_post_cats(1, $post_ID));
+
+	  $content  = '&lt;title&gt;'.stripslashes($post_data['post_title']).'&lt;/title&gt;';
+	  $content .= '&lt;category&gt;'.$categories.'&lt;/category&gt;';
+	  $content .= stripslashes($post_data['post_content']);
+
+	  $struct = array(
+	    'userid'    =&gt; $post_data['post_author'],
+	    'dateCreated' =&gt; new IXR_Date(mysql2date('Ymd\TH:i:s', $post_data['post_date'])),
+	    'content'     =&gt; $content,
+	    'postid'  =&gt; $post_data['ID']
+	  );
+
+	  return $struct;
+	}
+
+
+	/* blogger.getRecentPosts ...gets recent posts */
+	function blogger_getRecentPosts($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $blog_ID    = $args[1]; /* though we don't use it yet */
+	  $user_login = $args[2];
+	  $user_pass  = $args[3];
+	  $num_posts  = $args[4];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $posts_list = wp_get_recent_posts($num_posts);
+
+	  if (!$posts_list) {
+	    $this-&gt;error = new IXR_Error(500, 'Either there are no posts, or something went wrong.');
+	    return $this-&gt;error;
+	  }
+
+	  foreach ($posts_list as $entry) {
+	  
+	    $post_date = mysql2date('Ymd\TH:i:s', $entry['post_date']);
+	    $categories = implode(',', wp_get_post_cats(1, $entry['ID']));
+
+	    $content  = '&lt;title&gt;'.stripslashes($entry['post_title']).'&lt;/title&gt;';
+	    $content .= '&lt;category&gt;'.$categories.'&lt;/category&gt;';
+	    $content .= stripslashes($entry['post_content']);
+
+	    $struct[] = array(
+	      'userid' =&gt; $entry['post_author'],
+	      'dateCreated' =&gt; new IXR_Date($post_date),
+	      'content' =&gt; $content,
+	      'postid' =&gt; $entry['ID'],
+	    );
+
+	  }
+
+	  $recent_posts = array();
+	  for ($j=0; $j&lt;count($struct); $j++) {
+	    array_push($recent_posts, $struct[$j]);
+	  }
+
+	  return $recent_posts;
+	}
+
+
+	/* blogger.getTemplate returns your blog_filename */
+	function blogger_getTemplate($args) {
+
+		$this-&gt;escape($args);
+
+	  $blog_ID    = $args[1];
+	  $user_login = $args[2];
+	  $user_pass  = $args[3];
+	  $template   = $args[4]; /* could be 'main' or 'archiveIndex', but we don't use it */
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+
+	  if ($user_data-&gt;user_level &lt; 3) {
+	    return new IXR_Error(401, 'Sorry, users whose level is less than 3, can not edit the template.');
+	  }
+
+	  /* warning: here we make the assumption that the weblog's URI is on the same server */
+	  $filename = get_settings('home') . '/';
+	  $filename = preg_replace('#<A HREF="http://.+?/#">http://.+?/#</A>', $_SERVER['DOCUMENT_ROOT'].'/', $filename);
+
+	  $f = fopen($filename, 'r');
+	  $content = fread($f, filesize($filename));
+	  fclose($f);
+
+	  /* so it is actually editable with a windows/mac client */
+	  // FIXME: (or delete me) do we really want to cater to bad clients at the expense of good ones by BEEPing up their line breaks? commented.     $content = str_replace(&quot;\n&quot;, &quot;\r\n&quot;, $content); 
+
+	  return $content;
+	}
+
+
+	/* blogger.setTemplate updates the content of blog_filename */
+	function blogger_setTemplate($args) {
+
+		$this-&gt;escape($args);
+
+	  $blog_ID    = $args[1];
+	  $user_login = $args[2];
+	  $user_pass  = $args[3];
+	  $content    = $args[4];
+	  $template   = $args[5]; /* could be 'main' or 'archiveIndex', but we don't use it */
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+
+	  if ($user_data-&gt;user_level &lt; 3) {
+	    return new IXR_Error(401, 'Sorry, users whose level is less than 3, can not edit the template.');
+	  }
+
+	  /* warning: here we make the assumption that the weblog's URI is on the same server */
+	  $filename = get_settings('home') . '/';
+	  $filename = preg_replace('#<A HREF="http://.+?/#">http://.+?/#</A>', $_SERVER['DOCUMENT_ROOT'].'/', $filename);
+
+	  if ($f = fopen($filename, 'w+')) {
+	    fwrite($f, $content);
+	    fclose($f);
+	  } else {
+	    return new IXR_Error(500, 'Either the file is not writable, or something wrong happened. The file has not been updated.');
+	  }
+
+	  return true;
+	}
+
+
+	/* blogger.newPost ...creates a new post */
+	function blogger_newPost($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $blog_ID    = $args[1]; /* though we don't use it yet */
+	  $user_login = $args[2];
+	  $user_pass  = $args[3];
+	  $content    = $args[4];
+	  $publish    = $args[5];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  if (!user_can_create_post($user_data-&gt;ID, $blog_ID)) {
+	    return new IXR_Error(401, 'Sorry, you can not post on this weblog or category.');
+	  }
+
+	  $post_status = ($publish) ? 'publish' : 'draft';
+
+	  $post_author = $user_data-&gt;ID;
+
+	  $post_title = xmlrpc_getposttitle($content);
+	  $post_category = xmlrpc_getpostcategory($content);
+
+	  $content = xmlrpc_removepostdata($content);
+	  $post_content = apply_filters( 'content_save_pre', $content );
+
+	  $post_date = current_time('mysql');
+	  $post_date_gmt = current_time('mysql', 1);
+
+	  $post_data = compact('blog_ID', 'post_author', 'post_date', 'post_date_gmt', 'post_content', 'post_title', 'post_category', 'post_status');
+
+	  $post_ID = wp_insert_post($post_data);
+
+	  if (!$post_ID) {
+	    return new IXR_Error(500, 'Sorry, your entry could not be posted. Something wrong happened.');
+	  }
+
+	  logIO('O', &quot;Posted ! ID: $post_ID&quot;);
+
+	  return $post_ID;
+	}
+
+
+	/* blogger.editPost ...edits a post */
+	function blogger_editPost($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[1];
+	  $user_login  = $args[2];
+	  $user_pass   = $args[3];
+	  $new_content = $args[4];
+	  $publish     = $args[5];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $actual_post = wp_get_single_post($post_ID,ARRAY_A);
+
+	  if (!$actual_post) {
+	  	return new IXR_Error(404, 'Sorry, no such post.');
+	  }
+
+		$this-&gt;escape($actual_post);
+
+	  $post_author_data = get_userdata($actual_post['post_author']);
+	  $user_data = get_userdatabylogin($user_login);
+
+	  if (!user_can_edit_post($user_data-&gt;ID, $post_ID)) {
+	    return new IXR_Error(401, 'Sorry, you do not have the right to edit this post.');
+	  }
+
+	  extract($actual_post);
+
+	  $content = $newcontent;
+
+	  $post_title = xmlrpc_getposttitle($content);
+	  $post_category = xmlrpc_getpostcategory($content);
+
+	  $content = xmlrpc_removepostdata($content);
+	  $post_content = apply_filters( 'content_save_pre', $content );
+
+	  $postdata = compact('ID', 'post_content', 'post_title', 'post_category', 'post_status', 'post_excerpt');
+
+	  $result = wp_update_post($postdata);
+
+	  if (!$result) {
+	  	return new IXR_Error(500, 'For some strange yet very annoying reason, this post could not be edited.');
+	  }
+
+	  return true;
+	}
+
+
+	/* blogger.deletePost ...deletes a post */
+	function blogger_deletePost($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[1];
+	  $user_login  = $args[2];
+	  $user_pass   = $args[3];
+	  $publish     = $args[4];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $actual_post = wp_get_single_post($post_ID,ARRAY_A);
+
+	  if (!$actual_post) {
+	  	return new IXR_Error(404, 'Sorry, no such post.');
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+
+	  if (!user_can_delete_post($user_data-&gt;ID, $post_ID)) {
+	    return new IXR_Error(401, 'Sorry, you do not have the right to delete this post.');
+	  }
+
+	  $result = wp_delete_post($post_ID);
+
+	  if (!$result) {
+	  	return new IXR_Error(500, 'For some strange yet very annoying reason, this post could not be deleted.');
+	  }
+
+	  return true;
+	}
+
+
+
+	/* MetaWeblog API functions
+	 * specs on wherever Dave Winer wants them to be
+	 */
+
+	/* metaweblog.newPost creates a post */
+	function mw_newPost($args) {
+
+	  global $wpdb, $post_default_category;
+
+		$this-&gt;escape($args);
+
+	  $blog_ID     = $args[0]; // we will support this in the near future
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+	  $content_struct = $args[3];
+	  $publish     = $args[4];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  if (!user_can_create_post($user_data-&gt;ID, $blog_ID)) {
+	    return new IXR_Error(401, 'Sorry, you can not post on this weblog or category.');
+	  }
+
+	  $post_author = $user_data-&gt;ID;
+
+	  $post_title = $content_struct['title'];
+	  $post_content = apply_filters( 'content_save_pre', $content_struct['description'] );
+	  $post_status = $publish ? 'publish' : 'draft';
+
+	  $post_excerpt = $content_struct['mt_excerpt'];
+	  $post_more = $content_struct['mt_text_more'];
+
+	  $comment_status = (empty($content_struct['mt_allow_comments'])) ?
+	    get_settings('default_comment_status')
+	    : $content_struct['mt_allow_comments'];
+
+	  $ping_status = (empty($content_struct['mt_allow_pings'])) ?
+	    get_settings('default_ping_status')
+	    : $content_struct['mt_allow_pings'];
+
+	  if ($post_more) {
+	    $post_content = $post_content . &quot;\n&lt;!--more--&gt;\n&quot; . $post_more;
+	  }
+
+		$to_ping = $content_struct['mt_tb_ping_urls'];
+
+	  // Do some timestamp voodoo
+	  $dateCreatedd = $content_struct['dateCreated'];
+	  if (!empty($dateCreatedd)) {
+	    $dateCreated = $dateCreatedd-&gt;getIso();
+	    $post_date     = get_date_from_gmt(iso8601_to_datetime($dateCreated));
+	    $post_date_gmt = iso8601_to_datetime($dateCreated, GMT);
+	  } else {
+	    $post_date     = current_time('mysql');
+	    $post_date_gmt = current_time('mysql', 1);
+	  }
+
+	  $catnames = $content_struct['categories'];
+	  logIO('O', 'Post cats: ' . printr($catnames,true));
+	  $post_category = array();
+
+	  if (is_array($catnames)) {
+	    foreach ($catnames as $cat) {
+	      $post_category[] = get_cat_ID($cat);
+	    }
+	  }
+		
+	  // We've got all the data -- post it:
+	  $postdata = compact('post_author', 'post_date', 'post_date_gmt', 'post_content', 'post_title', 'post_category', 'post_status', 'post_excerpt', 'comment_status', 'ping_status', 'to_ping');
+
+	  $post_ID = wp_insert_post($postdata);
+
+	  if (!$post_ID) {
+	    return new IXR_Error(500, 'Sorry, your entry could not be posted. Something wrong happened.');
+	  }
+
+	  logIO('O', &quot;Posted ! ID: $post_ID&quot;);
+
+	  // FIXME: do we pingback always? pingback($content, $post_ID);
+	  // trackback_url_list($content_struct['mt_tb_ping_urls'],$post_ID);
+
+		if ('publish' == $post_status) {
+			if ($post_pingback) pingback($content, $post_ID);
+			do_enclose( $content, $post_ID );
+			do_trackbacks($post_ID);
+			do_action('publish_post', $post_ID);
+		}  
+
+	  return strval($post_ID);
+	}
+
+
+	/* metaweblog.editPost ...edits a post */
+	function mw_editPost($args) {
+
+	  global $wpdb, $post_default_category;
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+	  $content_struct = $args[3];
+	  $publish     = $args[4];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  if (!user_can_edit_post($user_data-&gt;ID, $post_ID)) {
+	    return new IXR_Error(401, 'Sorry, you can not edit this post.');
+	  }
+
+	  $postdata = wp_get_single_post($post_ID, ARRAY_A);
+	  extract($postdata);
+		$this-&gt;escape($postdata);
+
+	  $post_title = $content_struct['title'];
+	  $post_content = apply_filters( 'content_save_pre', $content_struct['description'] );
+	  $catnames = $content_struct['categories'];
+
+	  $post_category = array();
+		
+	  if (is_array($catnames)) {
+	    foreach ($catnames as $cat) {
+	      $post_category[] = get_cat_ID($cat);
+	    }
+	  }
+
+	  $post_excerpt = $content_struct['mt_excerpt'];
+	  $post_more = $content_struct['mt_text_more'];
+	  $post_status = $publish ? 'publish' : 'draft';
+
+	  if ($post_more) {
+	    $post_content = $post_content . &quot;\n&lt;!--more--&gt;\n&quot; . $post_more;
+	  }
+
+		$to_ping = $content_struct['mt_tb_ping_urls'];
+
+	  $comment_status = (empty($content_struct['mt_allow_comments'])) ?
+	    get_settings('default_comment_status')
+	    : $content_struct['mt_allow_comments'];
+
+	  $ping_status = (empty($content_struct['mt_allow_pings'])) ?
+	    get_settings('default_ping_status')
+	    : $content_struct['mt_allow_pings'];
+
+	  // Do some timestamp voodoo
+	  $dateCreatedd = $content_struct['dateCreated'];
+	  if (!empty($dateCreatedd)) {
+	    $dateCreated = $dateCreatedd-&gt;getIso();
+	    $post_date     = get_date_from_gmt(iso8601_to_datetime($dateCreated));
+	    $post_date_gmt = iso8601_to_datetime($dateCreated, GMT);
+	  } else {
+	    $post_date     = $postdata['post_date'];
+	    $post_date_gmt = $postdata['post_date_gmt'];
+	  }
+
+	  // We've got all the data -- post it:
+	  $newpost = compact('ID', 'post_content', 'post_title', 'post_category', 'post_status', 'post_excerpt', 'comment_status', 'ping_status', 'post_date', 'post_date_gmt', 'to_ping');
+
+	  $result = wp_update_post($newpost);
+	  if (!$result) {
+	    return new IXR_Error(500, 'Sorry, your entry could not be edited. Something wrong happened.');
+	  }
+
+	  logIO('O',&quot;(MW) Edited ! ID: $post_ID&quot;);
+
+	  // FIXME: do we pingback always? pingback($content, $post_ID);
+	  // trackback_url_list($content_struct['mt_tb_ping_urls'], $post_ID);
+		if ('publish' == $post_status) {
+			if ($post_pingback) pingback($content, $post_ID);
+			do_enclose( $content, $post_ID );
+			do_trackbacks($post_ID);
+			do_action('publish_post', $post_ID);
+		}	
+		do_action('edit_post', $post_ID);
+
+	  return true;
+	}
+
+
+	/* metaweblog.getPost ...returns a post */
+	function mw_getPost($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $postdata = wp_get_single_post($post_ID, ARRAY_A);
+
+	  if ($postdata['post_date'] != '') {
+
+	    $post_date = mysql2date('Ymd\TH:i:s', $postdata['post_date']);
+
+	    $categories = array();
+	    $catids = wp_get_post_cats('', $post_ID);
+	    foreach($catids as $catid) {
+	      $categories[] = get_cat_name($catid);
+	    }
+
+	    $post = get_extended($postdata['post_content']);
+	    $link = post_permalink($postdata['ID']);
+
+	    $allow_comments = ('open' == $postdata['comment_status']) ? 1 : 0;
+	    $allow_pings = ('open' == $postdata['ping_status']) ? 1 : 0;
+
+	    $resp = array(
+	      'dateCreated' =&gt; new IXR_Date($post_date),
+	      'userid' =&gt; $postdata['post_author'],
+	      'postid' =&gt; $postdata['ID'],
+	      'description' =&gt; $post['main'],
+	      'title' =&gt; $postdata['post_title'],
+	      'link' =&gt; $link,
+	      'permaLink' =&gt; $link,
+// commented out because no other tool seems to use this
+//	      'content' =&gt; $entry['post_content'],
+	      'categories' =&gt; $categories,
+	      'mt_excerpt' =&gt; $postdata['post_excerpt'],
+	      'mt_text_more' =&gt; $post['extended'],
+	      'mt_allow_comments' =&gt; $allow_comments,
+	      'mt_allow_pings' =&gt; $allow_pings
+	    );
+
+	    return $resp;
+	  } else {
+	  	return new IXR_Error(404, 'Sorry, no such post.');
+	  }
+	}
+
+
+	/* metaweblog.getRecentPosts ...returns recent posts */
+	function mw_getRecentPosts($args) {
+
+		$this-&gt;escape($args);
+
+	  $blog_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+	  $num_posts   = $args[3];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $posts_list = wp_get_recent_posts($num_posts);
+
+	  if (!$posts_list) {
+	    $this-&gt;error = new IXR_Error(500, 'Either there are no posts, or something went wrong.');
+	    return $this-&gt;error;
+	  }
+
+	  foreach ($posts_list as $entry) {
+	  
+	    $post_date = mysql2date('Ymd\TH:i:s', $entry['post_date']);
+	    $categories = array();
+	    $catids = wp_get_post_cats('', $entry['ID']);
+	    foreach($catids as $catid) {
+	      $categories[] = get_cat_name($catid);
+	    }
+
+	    $post = get_extended($entry['post_content']);
+	    $link = post_permalink($entry['ID']);
+
+	    $allow_comments = ('open' == $entry['comment_status']) ? 1 : 0;
+	    $allow_pings = ('open' == $entry['ping_status']) ? 1 : 0;
+
+	    $struct[] = array(
+	      'dateCreated' =&gt; new IXR_Date($post_date),
+	      'userid' =&gt; $entry['post_author'],
+	      'postid' =&gt; $entry['ID'],
+	      'description' =&gt; $post['main'],
+	      'title' =&gt; $entry['post_title'],
+	      'link' =&gt; $link,
+	      'permaLink' =&gt; $link,
+// commented out because no other tool seems to use this
+//	      'content' =&gt; $entry['post_content'],
+	      'categories' =&gt; $categories,
+	      'mt_excerpt' =&gt; $entry['post_excerpt'],
+	      'mt_text_more' =&gt; $post['extended'],
+	      'mt_allow_comments' =&gt; $allow_comments,
+	      'mt_allow_pings' =&gt; $allow_pings
+	    );
+
+	  }
+
+	  $recent_posts = array();
+	  for ($j=0; $j&lt;count($struct); $j++) {
+	    array_push($recent_posts, $struct[$j]);
+	  }
+	  
+	  return $recent_posts;
+	}
+
+
+	/* metaweblog.getCategories ...returns the list of categories on a given weblog */
+	function mw_getCategories($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $blog_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $categories_struct = array();
+
+	  // FIXME: can we avoid using direct SQL there?
+	  if ($cats = $wpdb-&gt;get_results(&quot;SELECT cat_ID,cat_name FROM $wpdb-&gt;categories&quot;, ARRAY_A)) {
+	    foreach ($cats as $cat) {
+	      $struct['categoryId'] = $cat['cat_ID'];
+	      $struct['description'] = $cat['cat_name'];
+	      $struct['categoryName'] = $cat['cat_name'];
+	      $struct['htmlUrl'] = wp_specialchars(get_category_link($cat['cat_ID']));
+	      $struct['rssUrl'] = wp_specialchars(get_category_rss_link(false, $cat['cat_ID'], $cat['cat_name']));
+
+	      $categories_struct[] = $struct;
+	    }
+	  }
+
+	  return $categories_struct;
+	}
+
+
+	/* metaweblog.newMediaObject uploads a file, following your settings */
+	function mw_newMediaObject($args) {
+	  // adapted from a patch by Johann Richard
+	  // <A HREF="http://mycvs.org/archives/2004/06/30/file-upload-to-wordpress-in-ecto/">http://mycvs.org/archives/2004/06/30/file-upload-to-wordpress-in-ecto/</A>
+
+		global $wpdb;
+
+	  $blog_ID     = $wpdb-&gt;escape($args[0]);
+	  $user_login  = $wpdb-&gt;escape($args[1]);
+		$user_pass   = $wpdb-&gt;escape($args[2]);
+	  $data        = $args[3];
+
+	  $name = $data['name'];
+	  $type = $data['type'];
+	  $bits = $data['bits'];
+
+	  $file_realpath = get_settings('fileupload_realpath'); 
+	  $file_url = get_settings('fileupload_url');
+
+	  logIO('O', '(MW) Received '.strlen($bits).' bytes');
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+
+	  if(!get_settings('use_fileupload')) {
+	    // Uploads not allowed
+	    logIO('O', '(MW) Uploads not allowed');
+	    $this-&gt;error = new IXR_Error(405, 'No uploads allowed for this site.');
+	    return $this-&gt;error;
+	  } 
+
+	  if(get_settings('fileupload_minlevel') &gt; $user_data-&gt;user_level) {
+	    // User has not enough privileges
+	    logIO('O', '(MW) Not enough privilege: user level too low');
+	    $this-&gt;error = new IXR_Error(401, 'You are not allowed to upload files to this site.');
+	    return $this-&gt;error;
+	  }
+
+	  if(trim($file_realpath) == '' || trim($file_url) == '' ) {
+	    // WordPress is not correctly configured
+	    logIO('O', '(MW) Bad configuration. Real/URL path not defined');
+	    $this-&gt;error = new IXR_Error(500, 'Please configure WordPress with valid paths for file upload.');
+	    return $this-&gt;error;
+	  }
+
+	  $prefix = '/';
+
+	  if(!empty($name)) {
+	    // Create the path
+	    $localpath = $file_realpath.$prefix.$name;
+	    $url = $file_url.$prefix.$name;
+
+	    if (mkdir_p(dirname($localpath))) {
+
+	      /* encode &amp; write data (binary) */
+	      $ifp = fopen($localpath, 'wb');
+	      $success = fwrite($ifp, $bits);
+	      fclose($ifp);
+	      @chmod($localpath, 0666);
+
+	      if($success) {
+	        $resp = array('url' =&gt; $url);
+	        return $resp;
+	      } else {
+	        logIO('O', '(MW) Could not write file '.$name.' to '.$localpath);
+	        return new IXR_Error(500, 'Could not write file '.$name);
+	      }
+
+	    } else {
+	      return new IXR_Error(500, 'Could not create directories for '.$name);
+	    }
+	  }
+	}
+
+
+
+	/* MovableType API functions
+	 * specs on <A HREF="http://www.movabletype.org/docs/mtmanual_programmatic.html">http://www.movabletype.org/docs/mtmanual_programmatic.html</A>
+	 */
+
+	/* mt.getRecentPostTitles ...returns recent posts' titles */
+	function mt_getRecentPostTitles($args) {
+
+		$this-&gt;escape($args);
+
+	  $blog_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+	  $num_posts   = $args[3];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $posts_list = wp_get_recent_posts($num_posts);
+
+	  if (!$posts_list) {
+	    $this-&gt;error = new IXR_Error(500, 'Either there are no posts, or something went wrong.');
+	    return $this-&gt;error;
+	  }
+
+	  foreach ($posts_list as $entry) {
+	  
+	    $post_date = mysql2date('Ymd\TH:i:s', $entry['post_date']);
+
+	    $struct[] = array(
+	      'dateCreated' =&gt; new IXR_Date($post_date),
+	      'userid' =&gt; $entry['post_author'],
+	      'postid' =&gt; $entry['ID'],
+	      'title' =&gt; $entry['post_title'],
+	    );
+
+	  }
+
+	  $recent_posts = array();
+	  for ($j=0; $j&lt;count($struct); $j++) {
+	    array_push($recent_posts, $struct[$j]);
+	  }
+	  
+	  return $recent_posts;
+	}
+
+
+	/* mt.getCategoryList ...returns the list of categories on a given weblog */
+	function mt_getCategoryList($args) {
+
+	  global $wpdb;
+
+		$this-&gt;escape($args);
+
+	  $blog_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $categories_struct = array();
+
+	  // FIXME: can we avoid using direct SQL there?
+	  if ($cats = $wpdb-&gt;get_results(&quot;SELECT cat_ID, cat_name FROM $wpdb-&gt;categories&quot;, ARRAY_A)) {
+	    foreach ($cats as $cat) {
+	      $struct['categoryId'] = $cat['cat_ID'];
+	      $struct['categoryName'] = $cat['cat_name'];
+
+	      $categories_struct[] = $struct;
+	    }
+	  }
+
+	  return $categories_struct;
+	}
+
+
+	/* mt.getPostCategories ...returns a post's categories */
+	function mt_getPostCategories($args) {
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $categories = array();
+	  $catids = wp_get_post_cats('', intval($post_ID));
+	  // first listed category will be the primary category
+	  $isPrimary = true;
+	  foreach($catids as $catid) {
+	    $categories[] = array(
+	      'categoryName' =&gt; get_cat_name($catid),
+	      'categoryId' =&gt; $catid,
+	      'isPrimary' =&gt; $isPrimary
+	    );
+	    $isPrimary = false;
+	  }
+ 
+	  return $categories;
+	}
+
+
+	/* mt.setPostCategories ...sets a post's categories */
+	function mt_setPostCategories($args) {
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+	  $categories  = $args[3];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  if (!user_can_edit_post($user_data-&gt;ID, $post_ID)) {
+	    return new IXR_Error(401, 'Sorry, you can not edit this post.');
+	  }
+
+	  foreach($categories as $cat) {
+	    $catids[] = $cat['categoryId'];
+	  }
+	
+	  wp_set_post_cats('', $post_ID, $catids);
+
+	  return true;
+	}
+
+
+	/* mt.supportedMethods ...returns an array of methods supported by this server */
+	function mt_supportedMethods($args) {
+
+	  $supported_methods = array();
+	  foreach($this-&gt;methods as $key=&gt;$value) {
+	    $supported_methods[] = $key;
+	  }
+
+	  return $supported_methods;
+	}
+
+
+	/* mt.supportedTextFilters ...returns an empty array because we don't
+	   support per-post text filters yet */
+	function mt_supportedTextFilters($args) {
+	  return array();
+	}
+
+
+	/* mt.getTrackbackPings ...returns trackbacks sent to a given post */
+	function mt_getTrackbackPings($args) {
+
+	  global $wpdb;
+
+	  $post_ID = intval($args);
+
+	  $actual_post = wp_get_single_post($post_ID, ARRAY_A);
+
+	  if (!$actual_post) {
+	  	return new IXR_Error(404, 'Sorry, no such post.');
+	  }
+
+	  $comments = $wpdb-&gt;get_results(&quot;SELECT comment_author_url, comment_content, comment_author_IP, comment_type FROM $wpdb-&gt;comments WHERE comment_post_ID = $post_ID&quot;);
+
+	  if (!$comments) {
+	  	return array();
+	  }
+
+	  $trackback_pings = array();
+	  foreach($comments as $comment) {
+	    if ( 'trackback' == $comment-&gt;comment_type ) {
+	      $content = $comment-&gt;comment_content;
+	      $title = substr($content, 8, (strpos($content, '&lt;/strong&gt;') - 8));
+	      $trackback_pings[] = array(
+	        'pingTitle' =&gt; $title,
+	        'pingURL'   =&gt; $comment-&gt;comment_author_url,
+	        'pingIP'    =&gt; $comment-&gt;comment_author_IP
+	      );
+		}
+	  }
+
+	  return $trackback_pings;
+	}
+
+
+	/* mt.publishPost ...sets a post's publish status to 'publish' */
+	function mt_publishPost($args) {
+
+		$this-&gt;escape($args);
+
+	  $post_ID     = $args[0];
+	  $user_login  = $args[1];
+	  $user_pass   = $args[2];
+
+	  if (!$this-&gt;login_pass_ok($user_login, $user_pass)) {
+	    return $this-&gt;error;
+	  }
+
+	  $user_data = get_userdatabylogin($user_login);
+	  if (!user_can_edit_post($user_data-&gt;ID, $post_ID)) {
+	    return new IXR_Error(401, 'Sorry, you can not edit this post.');
+	  }
+
+	  $postdata = wp_get_single_post($post_ID,ARRAY_A);
+
+	  $postdata['post_status'] = 'publish';
+
+	  // retain old cats
+	  $cats = wp_get_post_cats('',$post_ID);
+	  $postdata['post_category'] = $cats;
+		$this-&gt;escape($postdata);
+
+	  $result = wp_update_post($postdata);
+
+	  return $result;
+	}
+
+
+
+	/* PingBack functions
+	 * specs on www.hixie.ch/specs/pingback/pingback
+	 */
+
+	/* pingback.ping gets a pingback and registers it */
+	function pingback_ping($args) {
+		global $wpdb, $wp_version; 
+
+		$this-&gt;escape($args);
+
+		$pagelinkedfrom = $args[0];
+		$pagelinkedto   = $args[1];
+
+		$title = '';
+
+		$pagelinkedfrom = str_replace('&amp;', '&amp;', $pagelinkedfrom);
+		$pagelinkedto   = preg_replace('#&amp;([^amp\;])#is', '&amp;$1', $pagelinkedto);
+
+		$error_code = -1;
+
+		// Check if the page linked to is in our site
+		$pos1 = strpos($pagelinkedto, str_replace('<A HREF="http://">http://</A>', '', str_replace('www.', '', get_settings('home'))));
+		if( !$pos1 )
+	  		return new IXR_Error(0, 'Is there no link to us?');
+
+		// let's find which post is linked to
+		// FIXME: does url_to_postid() cover all these cases already?
+		//        if so, then let's use it and drop the old code.
+		$urltest = parse_url($pagelinkedto);
+		if ($post_ID = url_to_postid($pagelinkedto)) {
+			$way = 'url_to_postid()';
+		} elseif (preg_match('#p/[0-9]{1,}#', $urltest['path'], $match)) {
+			// the path defines the post_ID (archives/p/XXXX)
+			$blah = explode('/', $match[0]);
+			$post_ID = $blah[1];
+			$way = 'from the path';
+		} elseif (preg_match('#p=[0-9]{1,}#', $urltest['query'], $match)) {
+			// the querystring defines the post_ID (?p=XXXX)
+			$blah = explode('=', $match[0]);
+			$post_ID = $blah[1];
+			$way = 'from the querystring';
+		} elseif (isset($urltest['fragment'])) {
+			// an #anchor is there, it's either...
+			if (intval($urltest['fragment'])) {
+				// ...an integer #XXXX (simpliest case)
+				$post_ID = $urltest['fragment'];
+				$way = 'from the fragment (numeric)';
+			} elseif (preg_match('/post-[0-9]+/',$urltest['fragment'])) {
+				// ...a post id in the form 'post-###'
+				$post_ID = preg_replace('/[^0-9]+/', '', $urltest['fragment']);
+				$way = 'from the fragment (post-###)';
+			} elseif (is_string($urltest['fragment'])) {
+				// ...or a string #title, a little more complicated
+				$title = preg_replace('/[^a-z0-9]/i', '.', $urltest['fragment']);
+				$sql = &quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_title RLIKE '$title'&quot;;
+				if (! ($post_ID = $wpdb-&gt;get_var($sql)) ) {
+					// returning unknown error '0' is better than die()ing
+			  		return new IXR_Error(0, '');
+				}
+				$way = 'from the fragment (title)';
+			}
+		} else {
+			// TODO: Attempt to extract a post ID from the given URL
+	  		return new IXR_Error(33, 'The specified target URI cannot be used as a target. It either doesn\'t exist, or it is not a pingback-enabled resource.');
+		}
+		$post_ID = (int) $post_ID;
+
+
+		logIO(&quot;O&quot;,&quot;(PB) URI='$pagelinkedto' ID='$post_ID' Found='$way'&quot;);
+
+		$post = get_post($post_ID);
+
+		if ( !$post ) // Post_ID not found
+	  		return new IXR_Error(33, 'The specified target URI cannot be used as a target. It either doesn\'t exist, or it is not a pingback-enabled resource.');
+
+		// Check if pings are on
+		if ( 'closed' == $post-&gt;ping_status )
+	  		return new IXR_Error(33, 'The specified target URI cannot be used as a target. It either doesn\'t exist, or it is not a pingback-enabled resource.');
+
+		// Let's check that the remote site didn't already pingback this entry
+		$result = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;comments WHERE comment_post_ID = '$post_ID' AND comment_author_url = '$pagelinkedfrom'&quot;);
+
+		if ( $wpdb-&gt;num_rows ) // We already have a Pingback from this URL
+	  		return new IXR_Error(48, 'The pingback has already been registered.');
+
+		// very stupid, but gives time to the 'from' server to publish !
+		sleep(1);
+
+		// Let's check the remote site
+		$linea = wp_remote_fopen( $pagelinkedfrom );
+		if ( !$linea )
+	  		return new IXR_Error(16, 'The source URI does not exist.');
+
+		// Work around bug in strip_tags():
+		$linea = str_replace('&lt;!DOC', '&lt;DOC', $linea);
+		$linea = preg_replace( '/[\s\r\n\t]+/', ' ', $linea ); // normalize spaces
+		$linea = preg_replace( &quot;/ &lt;(h1|h2|h3|h4|h5|h6|p|th|td|li|dt|dd|pre|caption|input|textarea|button|body)[^&gt;]*&gt;/&quot;, &quot;\n\n&quot;, $linea );
+
+		preg_match('|&lt;title&gt;([^&lt;]*?)&lt;/title&gt;|is', $linea, $matchtitle);
+		$title = $matchtitle[1];
+		if ( empty( $title ) )
+			return new IXR_Error(32, 'We cannot find a title on that page.');
+
+		$linea = strip_tags( $linea, '&lt;a&gt;' ); // just keep the tag we need
+
+		$p = explode( &quot;\n\n&quot;, $linea );
+		
+		$sem_regexp_pb = &quot;/(\\/|\\\|\*|\?|\+|\.|\^|\\$|\(|\)|\[|\]|\||\{|\})/&quot;;
+		$sem_regexp_fix = &quot;\\\\$1&quot;;
+		$link = preg_replace( $sem_regexp_pb, $sem_regexp_fix, $pagelinkedfrom );
+		
+		$finished = false;
+		foreach ( $p as $para ) {
+			if ( $finished )
+				continue;
+			if ( strstr( $para, $pagelinkedto ) ) {
+				$context = preg_replace( &quot;/.*&lt;a[^&gt;]+&quot;.$link.&quot;[^&gt;]*&gt;([^&gt;]+)&lt;\/a&gt;.*/&quot;, &quot;$1&quot;, $para );
+				$excerpt = strip_tags( $para );
+				$excerpt = trim( $excerpt );
+				$use     = preg_quote( $context );
+				$excerpt = preg_replace(&quot;|.*?\s(.{0,100}$use.{0,100})\s|s&quot;, &quot;$1&quot;, $excerpt);
+				$finished = true;
+			}
+		}
+
+		if ( empty($context) )  // URL pattern not found
+			return new IXR_Error(17, 'The source URI does not contain a link to the target URI, and so cannot be used as a source.');
+
+		$pagelinkedfrom = preg_replace('#&amp;([^amp\;])#is', '&amp;$1', $pagelinkedfrom);
+
+		$context = '[...] ' . wp_specialchars( $excerpt ) . ' [...]';
+		$original_pagelinkedfrom = $pagelinkedfrom;
+		$pagelinkedfrom = addslashes( $pagelinkedfrom );
+		$original_title = $title;
+
+		$comment_post_ID = $post_ID;
+		$comment_author = $title;
+		$comment_author_url = $pagelinkedfrom;
+		$comment_content = $context;
+		$comment_type = 'pingback';
+
+		$commentdata = compact('comment_post_ID', 'comment_author', 'comment_author_url', 'comment_content', 'comment_type');
+
+		wp_new_comment($commentdata);
+		do_action('pingback_post', $wpdb-&gt;insert_id);
+		
+		return &quot;Pingback from $pagelinkedfrom to $pagelinkedto registered. Keep the web talking! :-)&quot;;
+	}
+
+
+	/* pingback.extensions.getPingbacks returns an array of URLs
+	   that pingbacked the given URL
+	   specs on <A HREF="http://www.aquarionics.com/misc/archives/blogite/0198.html">http://www.aquarionics.com/misc/archives/blogite/0198.html</A> */
+	function pingback_extensions_getPingbacks($args) {
+
+		global $wpdb;
+
+		$this-&gt;escape($args);
+
+		$url = $args;
+
+		$post_ID = url_to_postid($url);
+		if (!$post_ID) {
+			// We aren't sure that the resource is available and/or pingback enabled
+	  		return new IXR_Error(33, 'The specified target URI cannot be used as a target. It either doesn\'t exist, or it is not a pingback-enabled resource.');
+		}
+
+		$actual_post = wp_get_single_post($post_ID, ARRAY_A);
+
+		if (!$actual_post) {
+			// No such post = resource not found
+	  		return new IXR_Error(32, 'The specified target URI does not exist.');
+		}
+
+		$comments = $wpdb-&gt;get_results(&quot;SELECT comment_author_url, comment_content, comment_author_IP, comment_type FROM $wpdb-&gt;comments WHERE comment_post_ID = $post_ID&quot;);
+
+		if (!$comments) {
+			return array();
+		}
+
+		$pingbacks = array();
+		foreach($comments as $comment) {
+			if ( 'pingback' == $comment-&gt;comment_type )
+				$pingbacks[] = $comment-&gt;comment_author_url;
+		}
+
+		return $pingbacks;
+	}
+}
+
+
+$wp_xmlrpc_server = new wp_xmlrpc_server();
+
+?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000027.html">[steampress-svn-tracker] r71 - /
</A></li>
	<LI>Next message: <A HREF="000029.html">[steampress-svn-tracker] r73 - trunk/wp-admin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28">[ date ]</a>
              <a href="thread.html#28">[ thread ]</a>
              <a href="subject.html#28">[ subject ]</a>
              <a href="author.html#28">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/steampress-svn-tracker">More information about the steampress-svn-tracker
mailing list</a><br>
</body></html>
